-- DDL Export
-- Server: 10.253.50.28
-- Database: MTFTRADE
-- Exported: 2026-01-30T12:57:56.975479

USE MTFTRADE;
GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_SL] CHECK (ltrim(rtrim([BOOKTYPE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_BLANK_DRCR_SL] CHECK (ltrim(rtrim([DRCR]))='D' OR ltrim(rtrim([DRCR]))='C')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_BLANK_VNO_SL] CHECK (ltrim(rtrim([VNO]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NOT_NULL_VNO_SL] CHECK ([VNO] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NOT_NULL_VTYP_SL] CHECK ([VTYP] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_BLANK_ACNAME_SL] CHECK (ltrim(rtrim([ACNAME]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_BLANK_CLTCODE_SL] CHECK (ltrim(rtrim([CLTCODE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_BLANK_EDT_SL] CHECK ([EDT]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_BLANK_VDT_SL] CHECK ([VDT]<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NON_ZERO_VTYP_SL] CHECK ([VTYP]<>(0))

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NOT_NULL_ACNAME_SL] CHECK ([ACNAME] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_SL] CHECK ([BOOKTYPE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NOT_NULL_CLTCODE_SL] CHECK ([CLTCODE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NOT_NULL_EDT_SL] CHECK ([EDT] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [NOT_NULL_VDT_SL] CHECK ([VDT] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER1
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER1] ADD CONSTRAINT [NON_BLANK_BOOKTYPE_L1] CHECK (ltrim(rtrim([BOOKTYPE]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER1
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER1] ADD CONSTRAINT [NON_BLANK_DRCR_L1] CHECK (ltrim(rtrim([DRCR]))='D' OR ltrim(rtrim([DRCR]))='C')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER1
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER1] ADD CONSTRAINT [NON_BLANK_VNO_L1] CHECK (ltrim(rtrim([VNO]))<>'')

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER1
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER1] ADD CONSTRAINT [NON_ZERO_VTYP_L1] CHECK ([VTYP]<>(0))

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER1
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER1] ADD CONSTRAINT [NOT_NULL_BOOKTYPE_L1] CHECK ([BOOKTYPE] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER1
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER1] ADD CONSTRAINT [NOT_NULL_VNO_L1] CHECK ([VNO] IS NOT NULL)

GO

-- --------------------------------------------------
-- CHECK dbo.LEDGER1
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER1] ADD CONSTRAINT [NOT_NULL_VTYP_L1] CHECK ([VTYP] IS NOT NULL)

GO

-- --------------------------------------------------
-- FUNCTION dbo.CBO_FN_GETCODELIST
-- --------------------------------------------------
  
CREATE   FUNCTION [DBO].[CBO_FN_GETCODELIST](  
                @STATUSID   VARCHAR(25),  
                @STATUSNAME VARCHAR(25),  
                @FROMCODE   VARCHAR(25),  
                @TOCODE     VARCHAR(25),  
                @SEARCHWHAT VARCHAR(20) = 'CLIENT')  
                RETURNS @CLIENTLOGIN TABLE (  
                        [ENT_CODE]    [VARCHAR](25) NOT NULL,  
                        [ENT_NAME]    [VARCHAR](100) NOT NULL,  
                        [PARTY_CODE]  [VARCHAR](10) NOT NULL,  
                        [PARENTCODE]  [VARCHAR](10) NOT NULL,  
                        [AREA]        [VARCHAR](20) NOT NULL,  
                        [REGION]      [VARCHAR](20) NOT NULL,  
                        [BRANCH_CD]   [VARCHAR](10) NOT NULL,  
                        [SUB_BROKER]  [VARCHAR](10) NOT NULL,  
                        [TRADER]      [VARCHAR](20) NOT NULL,  
                        [FAMILY]      [VARCHAR](10) NOT NULL,  
                        [CL_TYPE]     [VARCHAR](10) NOT NULL,  
                        [CL_STATUS]   [VARCHAR](10) NOT NULL,  
                        [RELMGR]      [VARCHAR](10) NOT NULL,  
                        [SBU]         [VARCHAR](10) NOT NULL,  
                        [GROUPCODE]   [VARCHAR](10) NOT NULL)  
  
AS  
BEGIN  
      INSERT INTO @CLIENTLOGIN  
      SELECT E.ENT_CODE,   
             E.ENT_NAME,   
             PARTY_CODE,   
             PARENTCODE = PARTY_CODE,   
             AREA,   
             REGION,   
             BRANCH_CD,   
             SUB_BROKER,   
             TRADER,   
             FAMILY,   
             CL_TYPE,   
             CL_STATUS,   
             ISNULL(REL_MGR,''),   
             ISNULL(SBU,''),   
             ISNULL(C_GROUP,'')  
      FROM   MSAJAG..CLIENT_DETAILS C,   
             CBO_TB_ENTITYMASTER E   
      WHERE  PARTY_CODE BETWEEN @FROMCODE AND @TOCODE  
             AND E.ENT_TYPE = @SEARCHWHAT   
             AND ENT_CODE = (CASE  
                               WHEN @SEARCHWHAT = 'BRANCH'     THEN C.BRANCH_CD  
                               WHEN @SEARCHWHAT = 'SUBBROKER'  THEN C.SUB_BROKER  
                               WHEN @SEARCHWHAT = 'TRADER'     THEN C.TRADER  
                               WHEN @SEARCHWHAT = 'FAMILY'     THEN C.FAMILY  
                               WHEN @SEARCHWHAT = 'AREA'       THEN C.AREA  
                               WHEN @SEARCHWHAT = 'REGION'     THEN C.REGION  
                               WHEN @SEARCHWHAT = 'CLIENT'     THEN C.PARTY_CODE  
                               WHEN @SEARCHWHAT = 'CLTYPE'     THEN C.CL_TYPE  
                               WHEN @SEARCHWHAT = 'CLSTATUS'   THEN C.CL_STATUS  
                               WHEN @SEARCHWHAT = 'RELMGR'     THEN C.REL_MGR  
                               WHEN @SEARCHWHAT = 'SBU'        THEN C.SBU  
                               WHEN @SEARCHWHAT = 'GROUPCODE'  THEN C.C_GROUP  
                               ELSE ''  
                             END)  
             AND @STATUSNAME = (CASE  
                                  WHEN @STATUSID = 'BRANCH'    THEN C.BRANCH_CD  
                                  WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER  
                                  WHEN @STATUSID = 'TRADER'    THEN C.TRADER  
                                  WHEN @STATUSID = 'FAMILY'    THEN C.FAMILY  
                                  WHEN @STATUSID = 'AREA'      THEN C.AREA  
                                  WHEN @STATUSID = 'REGION'    THEN C.REGION  
                                  WHEN @STATUSID = 'CLIENT'    THEN C.PARTY_CODE  
                                  ELSE 'BROKER'  
                                END)  
  
  
    RETURN  
  
    END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_PIECE
-- --------------------------------------------------




CREATE FUNCTION [dbo].[CLS_PIECE] ( @CharacterExpression VARCHAR(8000), @Delimiter CHAR(1), @Position INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	If @Position<1 return null
	if len(@Delimiter)<>1 return null
	declare @Start integer
	set @Start=1
	while @Position>1
		BEGIN
			Set @Start=ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
			IF @Start=0 return null
			set @position= @position-1
			set @Start=@Start+1
		END
	Declare @End INTEGER
	Set @End= ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
	If @End=0 Set @End=LEN(@CharacterExpression)+1
	RETURN SUBSTRING(@CharacterExpression, @Start, @End-@Start)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FnGetClientLedgerLiveLimited
-- --------------------------------------------------


CREATE FUNCTION [dbo].[FnGetClientLedgerLiveLimited] 
 (
 @Party_code AS Varchar(10)
 )
RETURNS TABLE
AS
RETURN
select  exchangesegment = 'NSECM',[Vtyp],[Vno],[Drcr],[Vamt],[Vdt],[Cltcode] ,[Narration] ,CDT from ledger with (nolock) 
Where  ( VTYP<>35 and ISNULL(enteredby,'')<>'MTF PROCESS' and ACTNODAYS <> 9) and vtyp in('8','18') 
and enteredby in('animesh','system')  and cltcode <> '46000062' and cltcode = @Party_code

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------
CREATE FUNCTION [dbo].[PIECE] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- INDEX dbo.AsianFileBatchNo
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_batch] ON [dbo].[AsianFileBatchNo] ([fldBatchNo], [fldFileDate])

GO

-- --------------------------------------------------
-- INDEX dbo.bse_grp1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [bsecode] ON [dbo].[bse_grp1] ([bsecode])

GO

-- --------------------------------------------------
-- INDEX dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_Session] ON [dbo].[FORMULA_CLIENT_MASTER] ([SESSION_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [CltCodeVdt] ON [dbo].[LEDGER] ([cltcode], [vdt], [vtyp], [EnteredBy]) INCLUDE ([vno], [edt], [lno], [acname], [drcr], [vamt], [vno1], [refno], [balamt], [NoDays], [cdt], [BookType], [pdt], [CheckedBy], [actnodays], [narration])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_edt] ON [dbo].[LEDGER] ([edt], [cltcode]) INCLUDE ([vtyp], [drcr], [vamt], [balamt])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_CLTCODE] ON [dbo].[LEDGER] ([cltcode], [vdt], [edt])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_LEDGER_cvdt] ON [dbo].[LEDGER] ([cltcode], [vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VDT] ON [dbo].[LEDGER] ([vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NC_Led_Cover] ON [dbo].[LEDGER] ([cltcode], [vtyp], [EnteredBy], [actnodays]) INCLUDE ([vno], [drcr], [vamt], [vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_ANGEL_Varmargin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ISIN] ON [dbo].[MTF_ANGEL_Varmargin] ([ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_CASH_COLL_LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_vtyp_edt_vdt_cltcode_ledger] ON [dbo].[MTF_CASH_COLL_LEDGER] ([vtyp], [edt], [vdt], [cltcode], [BookType])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_CASH_PAYIN_LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_vtyp_edt_vdt_cltcode_ledger] ON [dbo].[MTF_CASH_PAYIN_LEDGER] ([vtyp], [edt], [vdt], [cltcode], [BookType])

GO

-- --------------------------------------------------
-- INDEX dbo.mtf_ctd_auto_release
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_mtf_party_scrip] ON [dbo].[mtf_ctd_auto_release] ([Party_code], [scrip_cd])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_DELDATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDX_PARTY] ON [dbo].[MTF_DELDATA] ([PARTY_CODE], [ISIN], [HOLDFLAG])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_DELDATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [SNO] ON [dbo].[MTF_DELDATA] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_JVDATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [JVDATE] ON [dbo].[MTF_JVDATA] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_MTM_LEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_vtyp_edt_vdt_cltcode_ledger] ON [dbo].[MTF_MTM_LEDGER] ([vtyp], [edt], [vdt], [cltcode], [BookType])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_PURCHASE_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_SAUDA_DATE] ON [dbo].[MTF_PURCHASE_DATA] ([TRADEDATE], [SETT_NO], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.NCMS_PO
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Cltcode] ON [dbo].[NCMS_PO] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.NSE_DELIVERYCLT_MTF
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [delInx] ON [dbo].[NSE_DELIVERYCLT_MTF] ([SETT_NO], [SETT_TYPE], [PARTY_CODE], [SCRIP_CD], [SERIES], [INOUT])

GO

-- --------------------------------------------------
-- INDEX dbo.NSE_DELIVERYCLT_MTF
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [delparty] ON [dbo].[NSE_DELIVERYCLT_MTF] ([PARTY_CODE], [SETT_NO], [SETT_TYPE], [SCRIP_CD], [SERIES])

GO

-- --------------------------------------------------
-- INDEX dbo.NSE_DELIVERYCLT_MTF
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDX_SETT] ON [dbo].[NSE_DELIVERYCLT_MTF] ([SETT_NO], [SETT_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.NSE_DELIVERYCLT_MTF
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_out] ON [dbo].[NSE_DELIVERYCLT_MTF] ([INOUT]) INCLUDE ([SETT_NO], [SETT_TYPE], [SCRIP_CD], [SERIES], [PARTY_CODE], [QTY])

GO

-- --------------------------------------------------
-- INDEX dbo.SEBI_PO
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NonClusteredIndex_Cltcode] ON [dbo].[SEBI_PO] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_BSE_REPORTING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Sauda] ON [dbo].[TBL_BSE_REPORTING] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_LED_OTHER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_acltcode] ON [dbo].[TBL_LED_OTHER] ([CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [TPARTY] ON [dbo].[TBL_MTF_DATA] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_DATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Tsdate] ON [dbo].[TBL_MTF_DATA] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_DATA_BUY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDX_DT] ON [dbo].[TBL_MTF_DATA_BUY] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_DATA_BUY_ALLOC_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDX_DT] ON [dbo].[TBL_MTF_DATA_BUY_ALLOC_LOG] ([SAUDA_DATE], [PARTY_CODE], [SCRIP_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_DATA_BUY_TDAY_ALLOC
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDX_DT] ON [dbo].[TBL_MTF_DATA_BUY_TDAY_ALLOC] ([SAUDA_DATE], [PARTY_CODE], [SCRIP_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_DATA_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[TBL_MTF_DATA_LOG] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_MARKING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxdtparty] ON [dbo].[TBL_MTF_MARKING] ([SAUDA_DATE], [PARTY_CODE], [ISIN], [HOLDFLAG])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTF_RECO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDX_PARTY] ON [dbo].[TBL_MTF_RECO] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTFREJECTCODE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[TBL_MTFREJECTCODE] ([SAUDA_DATE], [CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTR_OPEN_BALANCE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDX_DT] ON [dbo].[TBL_MTR_OPEN_BALANCE] ([SAUDA_DATE], [PARTY_CODE], [SCRIP_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTR_OPEN_BALANCE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDX_SNO] ON [dbo].[TBL_MTR_OPEN_BALANCE] ([SRNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MTR_REPORTING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDX_DT] ON [dbo].[TBL_MTR_REPORTING] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_NSE_REPORTING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [SDATE] ON [dbo].[TBL_NSE_REPORTING] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ix_ISIN] ON [dbo].[TBL_PRODUCT_DATA] ([ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ix_scrip] ON [dbo].[TBL_PRODUCT_DATA] ([SCRIP_CD], [SERIES], [BSECODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ix_sdate] ON [dbo].[TBL_PRODUCT_DATA] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_DATA_BK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ix_ISIN] ON [dbo].[TBL_PRODUCT_DATA_BK] ([ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_DATA_BK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ix_scrip] ON [dbo].[TBL_PRODUCT_DATA_BK] ([SCRIP_CD], [SERIES], [BSECODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_DATA_BK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ix_sdate] ON [dbo].[TBL_PRODUCT_DATA_BK] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_DATA_BK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NonClusteredIndex-20211011-100557] ON [dbo].[TBL_PRODUCT_DATA_BK] ([SAUDA_DATE], [TRANSTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_HOLD_DATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [sdate] ON [dbo].[TBL_PRODUCT_HOLD_DATA] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_HOLD_DATA_HIST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [scrip] ON [dbo].[TBL_PRODUCT_HOLD_DATA_HIST] ([SCRIP_CD], [BSECODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_HOLD_DATA_HIST
-- --------------------------------------------------
CREATE CLUSTERED INDEX [sdate] ON [dbo].[TBL_PRODUCT_HOLD_DATA_HIST] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_LED_ADJUST
-- --------------------------------------------------
CREATE CLUSTERED INDEX [partyidx] ON [dbo].[TBL_PRODUCT_LED_ADJUST] ([SAUDA_DATE], [CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POS_ADJUST
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[TBL_PRODUCT_POS_ADJUST] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POS_ADJUST_LED
-- --------------------------------------------------
CREATE CLUSTERED INDEX [LEDDATE] ON [dbo].[TBL_PRODUCT_POS_ADJUST_LED] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ADJUST_DATE__Filtered] ON [dbo].[TBL_PRODUCT_POSITION] ([ADJUST_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MISSING_TBL_PRODUCT_POSITION_Restored_SAUDA_DATE ] ON [dbo].[TBL_PRODUCT_POSITION] ([SAUDA_DATE], [PARTY_CODE], [Sell_Buy], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [SDATE] ON [dbo].[TBL_PRODUCT_POSITION] ([PARTY_CODE], [Sell_Buy], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [SNO] ON [dbo].[TBL_PRODUCT_POSITION] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_BAK_04032020_OLD
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MISSING_TBL_PRODUCT_POSITION_SAUDA_DATE ] ON [dbo].[TBL_PRODUCT_POSITION_BAK_04032020_OLD] ([SAUDA_DATE], [PARTY_CODE], [Sell_Buy], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_BAK_04032020_OLD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [SDATE] ON [dbo].[TBL_PRODUCT_POSITION_BAK_04032020_OLD] ([PARTY_CODE], [Sell_Buy], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_BAK_04032020_OLD
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [SNO] ON [dbo].[TBL_PRODUCT_POSITION_BAK_04032020_OLD] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_CHECK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_party] ON [dbo].[TBL_PRODUCT_POSITION_CHECK] ([SAUDA_DATE], [ADJUST_DATE], [Sell_Buy], [PARTY_CODE], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_CHECK
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_sno] ON [dbo].[TBL_PRODUCT_POSITION_CHECK] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_CHECK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [missing_index] ON [dbo].[TBL_PRODUCT_POSITION_CHECK] ([SAUDA_DATE], [Sell_Buy], [Sett_No], [QTY], [ADJUST_DATE]) INCLUDE ([SNO], [PRODUCT_CODE], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_DoNotDelete_12042025
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ADJUST_DATE__Filtered] ON [dbo].[TBL_PRODUCT_POSITION_DoNotDelete_12042025] ([ADJUST_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_DoNotDelete_12042025
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MISSING_TBL_PRODUCT_POSITION_SAUDA_DATE ] ON [dbo].[TBL_PRODUCT_POSITION_DoNotDelete_12042025] ([SAUDA_DATE], [PARTY_CODE], [Sell_Buy], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_DoNotDelete_12042025
-- --------------------------------------------------
CREATE CLUSTERED INDEX [SDATE] ON [dbo].[TBL_PRODUCT_POSITION_DoNotDelete_12042025] ([PARTY_CODE], [Sell_Buy], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_DoNotDelete_12042025
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [SNO] ON [dbo].[TBL_PRODUCT_POSITION_DoNotDelete_12042025] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_TMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [SDATE] ON [dbo].[TBL_PRODUCT_POSITION_TMP] ([SAUDA_DATE], [Sell_Buy], [PARTY_CODE], [ISIN], [ADJUST_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_PRODUCT_POSITION_TMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [SNO] ON [dbo].[TBL_PRODUCT_POSITION_TMP] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.TblClientMargin
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_DATE] ON [dbo].[TblClientMargin] ([From_Date], [To_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.TblClientMargin
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PARTY] ON [dbo].[TblClientMargin] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLSCRIPMARGIN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idx_isin] ON [dbo].[TBLSCRIPMARGIN] ([from_date], [to_date], [ISIN])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLSCRIPMARGIN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [isin] ON [dbo].[TBLSCRIPMARGIN] ([Series])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.autoclosure_clients
-- --------------------------------------------------
ALTER TABLE [dbo].[autoclosure_clients] ADD CONSTRAINT [PK__autoclos__3213E83FB74D7AFB] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[FORMULA_CLIENT_MASTER] ADD CONSTRAINT [PK_FORMULA_CLIENT_MASTER] PRIMARY KEY ([CLTCODE], [SESSION_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FORMULA_CLIENT_MASTER_PARENT
-- --------------------------------------------------
ALTER TABLE [dbo].[FORMULA_CLIENT_MASTER_PARENT] ADD CONSTRAINT [PK_FORMULA_CLIENT_MASTER_PARENT] PRIMARY KEY ([CLTCODE], [SESSION_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.LEDGER
-- --------------------------------------------------
ALTER TABLE [dbo].[LEDGER] ADD CONSTRAINT [PK1_ledger] PRIMARY KEY ([vdt], [cltcode], [vtyp], [vno], [lno], [BookType], [drcr])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MarginLedger
-- --------------------------------------------------
ALTER TABLE [dbo].[MarginLedger] ADD CONSTRAINT [PK_MarginLedger_Nse] PRIMARY KEY ([vtyp], [vno], [drcr], [vdt], [Party_code], [BookType])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MTF_CLIENT_ACTIVATION_LOG
-- --------------------------------------------------
ALTER TABLE [dbo].[MTF_CLIENT_ACTIVATION_LOG] ADD CONSTRAINT [PK_MTF_CLIENT_ACTIVATION_LOG] PRIMARY KEY ([id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.mtf_ctd
-- --------------------------------------------------
ALTER TABLE [dbo].[mtf_ctd] ADD CONSTRAINT [mtf_ctd_PK] PRIMARY KEY ([party_code], [request_id], [request_date], [isin], [sauda_date])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TblClientMargin
-- --------------------------------------------------
ALTER TABLE [dbo].[TblClientMargin] ADD CONSTRAINT [PK__TblClien__E0B52346CB08E2EC] PRIMARY KEY ([Party_Code])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.acc_genvno
-- --------------------------------------------------
create PROC [dbo].[acc_genvno]
	@VDT      VARCHAR(11),
	@VTYP     SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@SDTCUR   VARCHAR(11),
	@LDTCUR   VARCHAR(11),
	@NOREC INT = 0

AS
/*
	EXEC ACC_GENVNO_NEW 'APR  1 2006', 8, '01', 'APR  1 2006', 'MAR 31 2007', 3
	EXEC Acc_GenVno_New  'APR  1 2005',8,'01','apr  1 2005','mar 31 2006',2
	SELECT * FROM LASTVNO WHERE VTYP = 8
*/
DECLARE
	@@VOUDT  AS DATETIME,
	@@MAXVNO AS NUMERIC(12,0),
	@@VNOFLAG AS TINYINT,
	@@VNO AS VARCHAR(12),
	@@RCNT AS INT

SET XACT_ABORT ON

BEGIN  TRANSACTION

IF @NOREC = 0
	BEGIN
		SELECT @NOREC = @NOREC + 1
	END


SELECT
	@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109),
	@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109),
	@@VNOFLAG = VNOFLAG,
	@@VOUDT = (SELECT CONVERT(DATETIME,@VDT))
FROM
	PARAMETER
WHERE
	@VDT BETWEEN SDTCUR AND LDTCUR

IF @@VNOFLAG = 0
	BEGIN
		SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0) FROM LASTVNO WITH (TABLOCKX,HOLDLOCK) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00'
		AND VDT <= @LDTCUR + ' 23:59'
		IF @@MAXVNO = 0
			BEGIN
				SELECT @@VNO = RIGHT(RTRIM(@SDTCUR),4)+'00000001'
			END
		ELSE
			BEGIN
				SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
			END
		SELECT @@RCNT = ( SELECT COUNT(*) FROM LASTVNO WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00' AND VDT <= @LDTCUR + ' 23:59')
	END
ELSE IF @@VNOFLAG = 1
	BEGIN
		SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0) FROM LASTVNO WITH (TABLOCKX,HOLDLOCK) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT LIKE @VDT+'%'
		IF @@MAXVNO = 0
			BEGIN
				SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@VOUDT))),2))+'0001'
			END
		ELSE
			BEGIN
				SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
			END
		SELECT @@RCNT = ( SELECT COUNT(*) FROM LASTVNO WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00' AND VDT LIKE @VDT+'%')
	END
ELSE IF @@VNOFLAG = 2
	BEGIN
		SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0) FROM LASTVNO WITH (TABLOCKX,HOLDLOCK) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND YEAR(VDT) = YEAR(@@VOUDT) AND MONTH(VDT) = MONTH(@@VOUDT)
		IF @@MAXVNO = 0
			BEGIN
				SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2))+'000001'
			END
		ELSE
			BEGIN
				SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
			END
		SELECT @@RCNT = ( SELECT COUNT(*) FROM LASTVNO WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND YEAR(VDT) = YEAR(@@VOUDT) AND MONTH(VDT) = MONTH(@@VOUDT))
	END
IF @@RCNT = 0
	BEGIN
		INSERT INTO LASTVNO VALUES(@VTYP,@BOOKTYPE,@VDT,CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1))
	END
ELSE
	BEGIN
		IF @@VNOFLAG = 0
			BEGIN
				UPDATE LASTVNO WITH (TABLOCKX, HOLDLOCK) SET LASTVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT >= @SDTCUR + ' 00:00:00' AND VDT <= @LDTCUR + ' 23:59'
			END
		ELSE IF @@VNOFLAG = 1
			BEGIN
				UPDATE LASTVNO WITH (TABLOCKX, HOLDLOCK) SET LASTVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VDT LIKE @VDT+'%'
			END
		ELSE IF @@VNOFLAG = 2
			BEGIN
				UPDATE LASTVNO WITH (TABLOCKX, HOLDLOCK) SET LASTVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC(12), @@VNO) + @NOREC - 1) WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND YEAR(VDT) = YEAR(@VDT) AND MONTH(VDT) = MONTH(@VDT)
			END
	END

IF @@ERROR <> 0
	BEGIN
		ROLLBACK TRANSACTION
		SELECT VNO = ''
	END
ELSE
	BEGIN
		COMMIT TRANSACTION
		SELECT VNO = @@VNO
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_GENVNO_NEW
-- --------------------------------------------------

CREATE PROC [dbo].[ACC_GENVNO_NEW] 
           @VDT      VARCHAR(11),
           @VTYP     SMALLINT,
           @BOOKTYPE VARCHAR(2),
           @SDTCUR   VARCHAR(11),
           @LDTCUR   VARCHAR(11),
           @NOREC    INT  = 0
                            
AS
  DECLARE  @@VOUDT    AS DATETIME,
           @@MAXVNO   AS NUMERIC(12,0),
           @@VNOFLAG  AS TINYINT,
           @@VNO      AS VARCHAR(12),
           @@RCNT     AS INT
                         
  SET XACT_ABORT ON
  
  BEGIN TRANSACTION
  
  IF @NOREC = 0
    BEGIN
      SELECT @NOREC = @NOREC + 1
    END
    
  SELECT @SDTCUR = CONVERT(VARCHAR(11),SDTCUR,109),
         @LDTCUR = CONVERT(VARCHAR(11),LDTCUR,109),
         @@VNOFLAG = VNOFLAG,
         @@VOUDT = (SELECT CONVERT(DATETIME,@VDT))
  FROM   PARAMETER
  WHERE  @VDT BETWEEN SDTCUR AND LDTCUR
                                 
  IF @@VNOFLAG = 0 -- YEARLY
    BEGIN
      SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)
      FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)
      WHERE  VTYP = @VTYP
             AND BOOKTYPE = @BOOKTYPE
             AND VDT >= @SDTCUR + ' 00:00:00'
             AND VDT <= @LDTCUR + ' 23:59'
      
      IF @@MAXVNO = 0
        BEGIN
          SELECT @@VNO = RIGHT(RTRIM(@SDTCUR),4) + '00000001'
        END
      ELSE
        BEGIN
          SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
        END
      
      SELECT @@RCNT = (SELECT COUNT(* )
                       FROM   LASTVNO
                       WHERE  VTYP = @VTYP
                              AND BOOKTYPE = @BOOKTYPE
                              AND VDT >= @SDTCUR + ' 00:00:00'
                              AND VDT <= @LDTCUR + ' 23:59')
    END
  ELSE
    IF @@VNOFLAG = 1 -- DAILY
      BEGIN
        SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)
        FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)
        WHERE  VTYP = @VTYP
               AND BOOKTYPE = @BOOKTYPE
               AND VDT LIKE @VDT + '%'
        
        IF @@MAXVNO = 0
          BEGIN
            SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),
                                                                          2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@VOUDT))),
                                                                                     2)) + '0001'
          END
        ELSE
		IF LEFT(@@maxvno,8) <> LEFT(@@maxvno + 1,8) AND LEFT(@@maxvno,4) = CONVERT(VARCHAR,YEAR(@@voudt)) 
          BEGIN
            SELECT @@vno = (SELECT LEFT(CONVERT(VARCHAR,YEAR(@@voudt)),1) + RIGHT(CONVERT(VARCHAR,YEAR(@@voudt)),2) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@voudt))),
                                                                          2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@voudt))),
                                                                                     2)) + '10000'
          END 
          ELSE 
          BEGIN 
			IF LEFT(@@maxvno,8) <> LEFT(@@maxvno + @NOREC,8) AND LEFT(@@maxvno,4) = CONVERT(VARCHAR,YEAR(@@voudt)) 
			  BEGIN
				SELECT @@vno = (SELECT LEFT(CONVERT(VARCHAR,YEAR(@@voudt)),1) + RIGHT(CONVERT(VARCHAR,YEAR(@@voudt)),2) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@voudt))),
																			  2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@voudt))),
																						 2)) + '0' + CONVERT(VARCHAR,CONVERT(INT,RIGHT(@@maxvno,4)) + 1)
			  END 
			  ELSE 
				BEGIN
				  SELECT @@vno = RTRIM(CONVERT(VARCHAR,@@maxvno + 1))
				END
            END 

        SELECT @@RCNT = (SELECT COUNT(* )
                         FROM   LASTVNO
                         WHERE  VTYP = @VTYP
                                AND BOOKTYPE = @BOOKTYPE
                                AND VDT >= @SDTCUR + ' 00:00:00'
                                AND VDT LIKE @VDT + '%')
      END
    ELSE
      IF @@VNOFLAG = 2 -- MONTHLY
        BEGIN
          SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)
          FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)
          WHERE  VTYP = @VTYP
                 AND BOOKTYPE = @BOOKTYPE
                 AND YEAR(VDT) = YEAR(@@VOUDT)
                 AND MONTH(VDT) = MONTH(@@VOUDT)
          
          IF @@MAXVNO = 0
            BEGIN
              SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),
                                                                            2)) + '000001'
            END
          ELSE
            BEGIN
              SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))
            END
          
          SELECT @@RCNT = (SELECT COUNT(* )
                           FROM   LASTVNO
                           WHERE  VTYP = @VTYP
                                  AND BOOKTYPE = @BOOKTYPE
                                  AND YEAR(VDT) = YEAR(@@VOUDT)
                                  AND MONTH(VDT) = MONTH(@@VOUDT))
        END
  
  IF @@RCNT = 0
    BEGIN
      INSERT INTO LASTVNO
      VALUES     (@VTYP,
                  @BOOKTYPE,
                  @VDT,
                  CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1))
    END
  ELSE
    BEGIN
      IF @@VNOFLAG = 0 -- YEARLY
        BEGIN
          UPDATE LASTVNO WITH (TABLOCKX ,HOLDLOCK)
          SET    LASTVNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1)
          WHERE  VTYP = @VTYP
                 AND BOOKTYPE = @BOOKTYPE
                 AND VDT >= @SDTCUR + ' 00:00:00'
                 AND VDT <= @LDTCUR + ' 23:59'
        END
      ELSE
        IF @@VNOFLAG = 1 -- DAILY
          BEGIN
            UPDATE LASTVNO WITH (TABLOCKX ,HOLDLOCK)
            SET    LASTVNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1)
            WHERE  VTYP = @VTYP
                   AND BOOKTYPE = @BOOKTYPE
                   AND VDT LIKE @VDT + '%'
          END
        ELSE
          IF @@VNOFLAG = 2 -- MONTHLY 
            BEGIN
              UPDATE LASTVNO WITH (TABLOCKX ,HOLDLOCK)
              SET    LASTVNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1)
              WHERE  VTYP = @VTYP
                     AND BOOKTYPE = @BOOKTYPE
                     AND YEAR(VDT) = YEAR(@VDT)
                     AND MONTH(VDT) = MONTH(@VDT)
            END
    END
    
  IF @@ERROR <> 0
    BEGIN
      ROLLBACK TRANSACTION
      
      SELECT VNO = ''
    END
  ELSE
    BEGIN
      COMMIT TRANSACTION
      
      SELECT VNO = @@VNO
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADDEDIT_PARTY_MAKER_CHECKER
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[ADDEDIT_PARTY_MAKER_CHECKER]    
(    
 @PARTYCODE VARCHAR(10),    
 @USERID VARCHAR(20),    
 @SRNO INT,    
 @STATUS VARCHAR(1),    
 @APPREMARK VARCHAR(100)    
)    
AS    
    
DECLARE @SANCTIONED_AMT  NUMERIC(18,4),    
  @MARGIN_INTEREST NUMERIC(18,4),   
  @FROM_DATE   DATETIME,    
  @TO_DATE   DATETIME,    
  @RECTYPE   VARCHAR(10),    
  @REMARKS   VARCHAR(100),    
  @RECCLOSE   VARCHAR(1),    
  @NEWSANCTIONED_AMT NUMERIC(18,4),
  @MIN_COVER     NUMERIC(18,4)
    
SELECT @SANCTIONED_AMT=SANCTIONED_AMT, @MARGIN_INTEREST=MARGIN_INTEREST ,   
       @FROM_DATE=FROM_DATE,@RECTYPE=RECTYPE,@REMARKS=REMARKS,    
       @TO_DATE=TO_DATE,@RECCLOSE=RECCLOSE,
       @MIN_COVER=MIN_COVER    
FROM TBLCLIENTMARGIN_MAKER_CHECKER     
WHERE PARTY_CODE = @PARTYCODE AND SRNO = @SRNO    
    
IF @STATUS = 'A'    
BEGIN    
 IF @RECTYPE = 'ADD'    
 BEGIN    
  INSERT INTO TBLCLIENTMARGIN_NEW     
  SELECT    
 PARTY_CODE,MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE,TO_DATE,ENTERED_BY=@USERID,ENTERED_DATE=GETDATE(),  
 AUTO_RMS,REMARKS,DOC_TYPE,FY_DOC  
  FROM TBLCLIENTMARGIN_MAKER_CHECKER WHERE PARTY_CODE = @PARTYCODE AND SRNO = @SRNO    
    
  DELETE FROM TBLCLIENTMARGIN    
  WHERE PARTY_CODE = @PARTYCODE    
      
  INSERT INTO TBLCLIENTMARGIN    
  SELECT  
    PARTY_CODE,MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE,TO_DATE,ENTERED_BY=@USERID,ENTERED_DATE=GETDATE(),  
 AUTO_RMS,REMARKS,DOC_TYPE,FY_DOC  
  FROM TBLCLIENTMARGIN_MAKER_CHECKER WHERE PARTY_CODE = @PARTYCODE AND SRNO = @SRNO    
 END    
    
 IF @RECTYPE = 'EDIT'    
 BEGIN    
  IF @RECCLOSE = 'Y'    
  BEGIN    
   UPDATE TBLCLIENTMARGIN_NEW SET TO_DATE = @FROM_DATE + ' 23:59:59',ENTERED_BY=@USERID,ENTERED_DATE=GETDATE()    
   WHERE PARTY_CODE = @PARTYCODE    
   AND LEFT(TO_DATE,11) > GETDATE()    
    
   UPDATE TBLCLIENTMARGIN SET TO_DATE = @FROM_DATE + ' 23:59:59',ENTERED_BY=@USERID,ENTERED_DATE=GETDATE()    
   WHERE PARTY_CODE = @PARTYCODE    
   AND LEFT(TO_DATE,11) > GETDATE()    
    
   UPDATE TBLCLIENTMARGIN_MAKER_CHECKER SET TO_DATE = @FROM_DATE + ' 23:59:59'     
   WHERE PARTY_CODE = @PARTYCODE AND SRNO = @SRNO    
  END    
  ELSE    
  BEGIN    
   IF CONVERT(DATETIME,@FROM_DATE) < LEFT(GETDATE(),11)    
   BEGIN    
    SELECT @NEWSANCTIONED_AMT = 0    
   END    
   ELSE    
   BEGIN    
    SELECT @NEWSANCTIONED_AMT = @SANCTIONED_AMT     
   END     
   INSERT INTO TBLCLIENTMARGIN_NEW     
   SELECT   
   PARTY_CODE,MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE,TO_DATE=LEFT(@FROM_DATE-1,11) + ' 23:59:59',  
   ENTERED_BY,ENTERED_DATE,AUTO_RMS,REMARKS,DOC_TYPE,FY_DOC   
   FROM TBLCLIENTMARGIN_NEW    
   WHERE PARTY_CODE = @PARTYCODE    
   AND @FROM_DATE BETWEEN FROM_DATE AND TO_DATE    
    
   UPDATE TBLCLIENTMARGIN_NEW SET FROM_DATE=@FROM_DATE    
   WHERE PARTY_CODE = @PARTYCODE    
   AND @FROM_DATE BETWEEN FROM_DATE AND TO_DATE    
    
   UPDATE TBLCLIENTMARGIN_NEW SET MARGIN_INTEREST=@MARGIN_INTEREST, MIN_COVER = @MIN_COVER,   
   SANCTIONED_AMT=(CASE WHEN @NEWSANCTIONED_AMT = 0 THEN SANCTIONED_AMT ELSE @SANCTIONED_AMT END),    
   ENTERED_BY=@USERID,ENTERED_DATE=GETDATE(),    
   REMARKS=@REMARKS    
   WHERE PARTY_CODE = @PARTYCODE    
   AND TO_DATE > @FROM_DATE     
    
   UPDATE TBLCLIENTMARGIN SET MARGIN_INTEREST=@MARGIN_INTEREST, MIN_COVER = @MIN_COVER,    
   SANCTIONED_AMT=(CASE WHEN @NEWSANCTIONED_AMT = 0 THEN SANCTIONED_AMT ELSE @SANCTIONED_AMT END),    
   ENTERED_BY=@USERID,ENTERED_DATE=GETDATE(),    
   REMARKS=@REMARKS    
   WHERE PARTY_CODE = @PARTYCODE    
   AND LEFT(TO_DATE,11) > GETDATE()    
  END    
 END    
END    
    
INSERT INTO TBLCLIENTMARGIN_MAKER_CHECKER_LOG    
      
SELECT PARTY_CODE,MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE,TO_DATE=LEFT(@FROM_DATE-1,11) + ' 23:59:59',  
   ENTERED_BY,ENTERED_DATE,AUTO_RMS,REMARKS,DOC_TYPE,FY_DOC,RECSTATUS=@STATUS,RECTYPE,RECCLOSE,APPROVED_BY=@USERID,APPROVED_ON=GETDATE(),  
   APP_REMARKS=@APPREMARK    
FROM TBLCLIENTMARGIN_MAKER_CHECKER WHERE PARTY_CODE = @PARTYCODE AND SRNO = @SRNO    
    
DELETE FROM TBLCLIENTMARGIN_MAKER_CHECKER WHERE PARTY_CODE = @PARTYCODE AND SRNO = @SRNO    
DELETE FROM TBLCLIENTMARGIN_NEW WHERE FROM_DATE > TO_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BAK_PROC_PRODUCT_LED_ADJUST_20092017
-- --------------------------------------------------
CREATE PROC [dbo].[BAK_PROC_PRODUCT_LED_ADJUST_20092017]  
(  
 @SAUDA_DATE VARCHAR(11),  
 @FORPARTY VARCHAR(10) = '%'  
)  
AS  
  
-- EXEC PROC_PRODUCT_LED_ADJUST 'SEP  4 2017'  
SET NOCOUNT ON  
  
DECLARE @SDTCUR DATETIME,  
  @LDTCUR DATETIME,  
   @NONFNO INT,  
   @FNO INT  
  
 SELECT @NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER  
 WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE  
  
  
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER   
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR   
  
SELECT CLTCODE, AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),2),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #CASHBAL   
FROM ACCOUNT.DBO.LEDGER L  
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN   
    WHERE CLTCODE = PARTY_CODE  
       AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE )  
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE   

INSERT INTO #CASHBAL 
SELECT CLTCODE, AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),2),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER L  
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN   
    WHERE CLTCODE = PARTY_CODE  
       AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE )  
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE  
   
INSERT INTO #CASHBAL   
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER L  
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'   
AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN   
       WHERE CLTCODE = PARTY_CODE  
    AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE )  
AND CLTCODE LIKE @FORPARTY             
GROUP BY CLTCODE   
  
INSERT INTO #CASHBAL   
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER L  
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'    
AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN   
       WHERE CLTCODE = PARTY_CODE  
    AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE )  
AND CLTCODE LIKE @FORPARTY             
GROUP BY CLTCODE   

INSERT INTO #CASHBAL   
SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = -SUM(NETAMT)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND PARTY_CODE LIKE @FORPARTY         
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL   
SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),   
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = SUM(NETAMT)  
FROM TBL_PRODUCT_POSITION P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE = @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY         
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL  
SELECT PARTY_CODE, AMOUNT = 0,  
FOAMOUNT = CONVERT(NUMERIC(18,2),0), MTFAMOUNT = ROUND(SUM(NETAMT),2),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)   
FROM TBL_PRODUCT_POSITION P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY 
--AND PAYIN_DATE <= @SAUDA_DATE        
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL  
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)    
FROM LEDGER L  
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
--AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN   
    WHERE CLTCODE = PARTY_CODE  
       AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE )  
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE   
  
SELECT CLTCODE, AMOUNT = SUM(AMOUNT),  
FOAMOUNT = SUM(FOAMOUNT),  
MTFAMOUNT = SUM(MTFAMOUNT),  
MTFCASHAMOUNT = SUM(MTFCASHAMOUNT)+SUM(MTFAMOUNT),  
INTERNALAMOUNT = SUM(AMOUNT)+SUM(FOAMOUNT),  
ADJAMT=convert(numeric(18,2),0),  
MTFTOCASHJV=convert(numeric(18,2),0),  
MTFTOFOJV=convert(numeric(18,2),0),  
MTFNONCASHADJ=convert(numeric(18,2),0)  
INTO #POSCLOSE FROM #CASHBAL  
GROUP BY CLTCODE    
  
DELETE FROM #POSCLOSE  
WHERE INTERNALAMOUNT < 0   
  
DELETE FROM TBL_PRODUCT_LED_ADJUST  
WHERE SAUDA_DATE= @SAUDA_DATE  
AND CLTCODE LIKE @FORPARTY  
  
INSERT INTO TBL_PRODUCT_LED_ADJUST  
SELECT SAUDA_DATE= @SAUDA_DATE,  
CLTCODE,  
AMOUNT,  
FOAMOUNT,  
MTFAMOUNT,  
MTFCASHAMOUNT,  
INTERNALAMOUNT,  
ADJAMT=0,  
MTFTOCASHJV=0,  
MTFTOFOJV=0,  
MTFNONCASHADJ=0,  
PROCESS_DATE=GETDATE()  
FROM #POSCLOSE  
  
DELETE FROM TBL_PRODUCT_POS_ADJUST_LED  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY  
  
INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
SELECT @SAUDA_DATE, SETT_NO = '2000000',   
SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY),TRANSTYPE,  
ADDED_BY='AUTOLED',GETDATE(), NETAMT = SUM(NETAMT), MTFVAR =0, CL_RATE = 0  
FROM TBL_PRODUCT_POSITION P, #POSCLOSE C  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND P.PARTY_CODE = C.CLTCODE  
AND (INTERNALAMOUNT + MTFCASHAMOUNT) >= MTFAMOUNT  
AND MTFAMOUNT > 0 AND QTY > 0   
AND PAYIN_DATE <= @SAUDA_DATE
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, TRANSTYPE  
  
SELECT P.*, INTERNALAMOUNT, MTFCASHAMOUNT, FOAMOUNT,   
AMOUNT, MTFAMOUNT, ADJQTY = 0, MTFVAR = CONVERT(NUMERIC(18,2),0),  
TCL_RATE = CONVERT(NUMERIC(18,2),0)   
INTO #POSCLOSEDATA  
FROM TBL_PRODUCT_POSITION P, #POSCLOSE C  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND P.PARTY_CODE = C.CLTCODE  
AND (INTERNALAMOUNT + MTFCASHAMOUNT) < MTFAMOUNT  
AND MTFAMOUNT > 0 AND QTY > 0 
AND PAYIN_DATE <= @SAUDA_DATE  
  
CREATE CLUSTERED INDEX SNO ON #POSCLOSEDATA 
(
	SNO
)  

 SELECT *, FOFLAG = 0 INTO #A_TBLSCRIPMARGIN   
 FROM TBLSCRIPMARGIN  
 WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
 UPDATE #A_TBLSCRIPMARGIN SET FOFLAG = 1  
 FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F  
 WHERE F.SYMBOL = #A_TBLSCRIPMARGIN.SCRIP_CD  
 AND   F.EXPIRYDATE >= @SAUDA_DATE  
 AND   INST_TYPE LIKE 'FUT%'  
  
 SELECT V.* INTO #A_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V,   
 MSAJAG.DBO.VARCONTROL C  
 WHERE C.RECDATE = @SAUDA_DATE  
 AND C.DETAILKEY = V.DETAILKEY  
 AND SERIES IN ( 'EQ', 'BE', 'BZ' )   
 AND ISIN IN (SELECT ISIN FROM #POSCLOSEDATA UNION SELECT IsIN FROM TBL_PRODUCT_POS_ADJUST_LED  
 where SAUDA_DATE = @SAUDA_DATE)  
  
 SELECT V.* INTO  #P_BSE_VAR FROM ANAND.BSEDB_AB.dBO.VARDETAIL V  
 WHERE V.FDATE = @SAUDA_DATE  
  
    SELECT V.* INTO #A_BSE_VAR FROM  #P_BSE_VAR V  
 WHERE  ISIN IN (SELECT ISIN FROM #POSCLOSEDATA UNION SELECT IsIN FROM TBL_PRODUCT_POS_ADJUST_LED  
 where SAUDA_DATE = @SAUDA_DATE)  
   
    UPDATE #POSCLOSEDATA   
    SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #A_NSE_VAR M, #A_TBLSCRIPMARGIN T   
    WHERE  M.ISIN = #POSCLOSEDATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE #POSCLOSEDATA   
 SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.MARGIN /*+ 3 * ELM*/ ELSE M.MARGIN /*+ 5 * ELM*/ END)  
 FROM   #A_BSE_VAR M, #A_TBLSCRIPMARGIN T  
 WHERE  M.ISIN = #POSCLOSEDATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE #POSCLOSEDATA SET MTFVAR = 100  
 WHERE MTFVAR = 0  
  
    UPDATE TBL_PRODUCT_POS_ADJUST_LED   
    SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #A_NSE_VAR M, #A_TBLSCRIPMARGIN T   
    WHERE  TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    M.ISIN = TBL_PRODUCT_POS_ADJUST_LED.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE TBL_PRODUCT_POS_ADJUST_LED   
 SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.MARGIN /*+ 3 * ELM*/ ELSE M.MARGIN /*+ 5 * ELM*/ END)  
 FROM   #A_BSE_VAR M, #A_TBLSCRIPMARGIN T  
 WHERE  TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    M.ISIN = TBL_PRODUCT_POS_ADJUST_LED.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
  
 UPDATE TBL_PRODUCT_POS_ADJUST_LED SET MTFVAR = 100  
 WHERE TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    MTFVAR = 0  
    
/*   
UPDATE TBL_PRODUCT_POS_ADJUST_LED SET CL_RATE = CURR_CL_RATE,   
MTFVAR = HAIRCUT  
FROM TBL_MTF_DATA T  
WHERE T.SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_POS_ADJUST_LED.PARTY_CODE = T.PARTY_CODE  
AND TBL_PRODUCT_POS_ADJUST_LED.ISIN = T.ISIN  
*/  
IF @FORPARTY <> '%'  
BEGIN  
 SELECT * FROM #POSCLOSEDATA  
 ORDER BY MTFVAR DESC, TCL_RATE,  SNO   
   
END  

UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFCASHAMOUNT   
WHERE SAUDA_DATE = @SAUDA_DATE AND MTFAMOUNT = 0  
  
DECLARE @POSCUR CURSOR,  
  @PARTY_CODE VARCHAR(10),  
  @AMOUNT NUMERIC(18,2),  
  @QTY INT,  
  @POSQTY INT,  
  @ADJCUR CURSOR,  
  @NETAMOUNT NUMERIC(18,2),  
  @NETRATE NUMERIC(18,2),  
  @SNO NUMERIC(18,0),   
  @MTFVAR NUMERIC(18,2),  
  @TCL_RATE NUMERIC(18,2),  
  @MTFCASHAMOUNT NUMERIC(18,2),  
  @MARGIN NUMERIC(18,2)  
    
SET @POSCUR = CURSOR FOR  
SELECT * FROM (  
SELECT DISTINCT PARTY_CODE, INTERNALAMOUNT, MTFCASHAMOUNT FROM #POSCLOSEDATA  
WHERE INTERNALAMOUNT > 0 AND MTFAMOUNT > 0 ) A  
ORDER BY PARTY_CODE   
OPEN @POSCUR  
FETCH NEXT FROM @POSCUR INTO @PARTY_CODE, @AMOUNT, @MTFCASHAMOUNT  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @ADJCUR = CURSOR FOR  
 SELECT SNO, QTY-ADJQTY, NETAMT, MTFVAR, TCL_RATE, MARGIN = NETAMT*MTFVAR/100 FROM #POSCLOSEDATA  
 WHERE PARTY_CODE = @PARTY_CODE  
 AND (QTY-ADJQTY) > 0 AND ADJQTY >= 0  
 ORDER BY MTFVAR DESC, TCL_RATE,  SNO   
 OPEN @ADJCUR   
 FETCH NEXT FROM @ADJCUR INTO @SNO, @QTY, @NETAMOUNT, @MTFVAR, @TCL_RATE, @MARGIN  
 WHILE @@FETCH_STATUS = 0 AND  @AMOUNT > 0   
 BEGIN   
  IF @FORPARTY <> '%'  
  BEGIN  
   SELECT @AMOUNT, @MTFCASHAMOUNT  
  END  
    
  IF @AMOUNT > 0   
  BEGIN  
   IF @AMOUNT >= (@NETAMOUNT - (CASE WHEN @MTFCASHAMOUNT >= @MARGIN   
             THEN @MARGIN   
             ELSE @MTFCASHAMOUNT   
           END))  
   BEGIN  
    INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
    SELECT @SAUDA_DATE, SETT_NO = '2000000',   
    SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
    PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=QTY,TRANSTYPE,  
    ADDED_BY='AUTOLED',GETDATE(), @NETAMOUNT, @MTFVAR, @TCL_RATE  
    FROM #POSCLOSEDATA  
    WHERE SNO = @SNO   
      
    UPDATE #POSCLOSEDATA SET ADJQTY = ADJQTY + @QTY  
    WHERE SNO = @SNO   
      
    IF @MTFCASHAMOUNT >= @MARGIN   
    BEGIN  
     SET @MTFCASHAMOUNT = @MTFCASHAMOUNT - @MARGIN  
     SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MARGIN  
       
     UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MARGIN  
     WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
    END  
    ELSE  
    BEGIN  
     SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MTFCASHAMOUNT  
       
     UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MTFCASHAMOUNT,  
     MTFNONCASHADJ = MTFNONCASHADJ  + @MARGIN - @MTFCASHAMOUNT  
     WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
       
     SET @MTFCASHAMOUNT = 0  
    END  
   END  
   ELSE  
   BEGIN  
    SET @NETRATE = (@NETAMOUNT / @QTY)  
    IF (@NETRATE  
           -(CASE WHEN @MTFCASHAMOUNT >= @NETAMOUNT*@MTFVAR/100 AND @MTFVAR < 100  
               THEN @NETRATE*@MTFVAR/100 ELSE 0 END)) = 0   
    BEGIN  
     --SELECT @PARTY_CODE, @MTFCASHAMOUNT, @AMOUNT, @NETRATE, @NETRATE*@MTFVAR/100,@MTFVAR  
       
     BREAK;  
    END                 
    SET @POSQTY = FLOOR(@AMOUNT / (@NETRATE  
           -(CASE WHEN @MTFCASHAMOUNT >= @NETAMOUNT*@MTFVAR/100 AND @MTFVAR < 100  
               THEN @NETRATE*@MTFVAR/100 ELSE 0 END)))  
    IF @POSQTY > @QTY   
    BEGIN  
     SET @POSQTY = @QTY  
    END  
    SET @NETAMOUNT = @POSQTY * @NETRATE  
    IF @POSQTY > 0   
    BEGIN   
     INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
     SELECT @SAUDA_DATE, SETT_NO = '2000000',   
     SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
     PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=@POSQTY,TRANSTYPE,  
     ADDED_BY='AUTOLED',GETDATE(),@NETAMOUNT, @MTFVAR, @TCL_RATE  
     FROM #POSCLOSEDATA  
     WHERE SNO = @SNO   
       
     UPDATE #POSCLOSEDATA SET ADJQTY = ADJQTY + @POSQTY  
     WHERE SNO = @SNO   
       
     SET @MARGIN = (case when @MTFVAR < 100 then @NETAMOUNT * @MTFVAR / 100 else 0 end)  
     IF @MTFCASHAMOUNT >= @MARGIN   
     BEGIN  
      SET @MTFCASHAMOUNT = @MTFCASHAMOUNT - @MARGIN  
      SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MARGIN  
      UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MARGIN  
      WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
     END  
     ELSE  
     BEGIN  
      SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MTFCASHAMOUNT  
      UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MTFCASHAMOUNT,  
      MTFNONCASHADJ = MTFNONCASHADJ  + @MARGIN - @MTFCASHAMOUNT  
      WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
      SET @MTFCASHAMOUNT = 0  
     END  
    END  
   END  
  END  
  FETCH NEXT FROM @ADJCUR INTO @SNO, @QTY, @NETAMOUNT, @MTFVAR, @TCL_RATE, @MARGIN  
 END  
 FETCH NEXT FROM @POSCUR INTO @PARTY_CODE, @AMOUNT, @MTFCASHAMOUNT  
END  
CLOSE @POSCUR  
DEALLOCATE @POSCUR  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = ROUND(MTFTOCASHJV,2), MTFTOFOJV = ROUND(MTFTOFOJV,2)  
  
/*  
UPDATE TBL_PRODUCT_LED_ADJUST SET ADJAMT = 0,  MTFTOCASHJV = 0, MTFTOFOJV = 0    
WHERE SAUDA_DATE = @SAUDA_DATE*/  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET ADJAMT = ROUND(A.AMOUNT,2)  
FROM (SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POS_ADJUST_LED  
WHERE SAUDA_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE ) A  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_LED_ADJUST.CLTCODE = A.PARTY_CODE  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = (CASE WHEN MTFAMOUNT = ADJAMT   
               THEN MTFCASHAMOUNT   
               ELSE MTFTOCASHJV  
             END)  
WHERE SAUDA_DATE = @SAUDA_DATE   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOFOJV = (CASE WHEN FOAMOUNT > 0 AND -ADJAMT + MTFTOCASHJV + AMOUNT < 0 AND ADJAMT > 0   
             THEN (CASE WHEN FOAMOUNT > ABS(-ADJAMT + MTFTOCASHJV + AMOUNT)   
                  THEN -ADJAMT + MTFTOCASHJV + AMOUNT   
                  ELSE -FOAMOUNT   
                END)  
             ELSE 0  
              END)  
WHERE SAUDA_DATE = @SAUDA_DATE   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -MTFTOCASHJV   
WHERE SAUDA_DATE = @SAUDA_DATE   
  
/*  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -(CASE WHEN MTFAMOUNT = ADJAMT THEN MTFCASHAMOUNT ELSE ADJAMT-INTERNALAMOUNT END)  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -MTFTOCASHJV+FOAMOUNT,  
MTFTOFOJV = -FOAMOUNT  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV+(-MTFTOCASHJV-AMOUNT+ADJAMT),  
MTFTOFOJV = MTFTOFOJV-(-MTFTOCASHJV-AMOUNT+ADJAMT)  
WHERE   
SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
AND FOAMOUNT > 0   
AND MTFTOCASHJV > 0   
AND MTFTOFOJV < 0   
*/  
IF @FORPARTY <> '%'  
BEGIN  
 SELECT * FROM TBL_PRODUCT_LED_ADJUST   
 WHERE CLTCODE = @FORPARTY  
  
 SELECT * FROM TBL_PRODUCT_POS_ADJUST_LED  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bak_PROC_PRODUCT_PFADJUST
-- --------------------------------------------------

-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
create PROC [dbo].[bak_PROC_PRODUCT_PFADJUST]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 1 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ				NUMERIC(18,4),
		@SDTCUR				DATETIME,
		@LDTCUR				DATETIME
		
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER 
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR		
	
SELECT PARTY_CODE, 
	   MTF_REQ   = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL),
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, POAHOLDING_APP = POAHOLDING_MTF,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,4),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,4),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,4),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,4),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,4),0), 
	   POAADJ =  CONVERT(NUMERIC(18,4),0)
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF

SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)

SET @MTFCUR = CURSOR FOR
SELECT PARTY_CODE, MTF_REQ = ABS(MTF_REQ), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
WHILE @@FETCH_STATUS = 0 
BEGIN 
	SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD) 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'BEN'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN			
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO
					
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG = 'BEN' THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
/*
UPDATE #MARREQ SET CASHCOLLADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > CMCASHCOLLATERAL 
									   THEN CMCASHCOLLATERAL
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + POAADJ) < 0 
AND   CMCASHCOLLATERAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 	
*/
UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 		
/*
UPDATE #MARREQ SET FOCASHCOLL = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ + CASHCOLLADJ + FOLEDBALADJ) > FOCASHCOLL 
									   THEN FOCASHCOLL
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ + CASHCOLLADJ + FOLEDBALADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ + CASHCOLLADJ + FOLEDBALADJ) < 0 
AND   FOCASHCOLL > 0 AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
*/

UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	CREATE NONCLUSTERED INDEX party ON MTF_DELDATA
	(
		party_code
	)
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA

	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)

CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
(
	SNO
)
 
	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE in (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR

	SELECT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = #MARREQ.CASHLEDADJ,
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'C'
	INTO #JVDATA 
	FROM #MARREQ
	WHERE CASHLEDADJ > 0 

	INSERT INTO #JVDATA 
	SELECT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = #MARREQ.FOLEDBALADJ,
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'C'
	FROM #MARREQ
	WHERE FOLEDBALADJ > 0 

	INSERT INTO #JVDATA
	SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)), 
	FLAG = 'CASH', GLCODE = @GLCODE, 
	VNO = CONVERT(VARCHAR(12),''),
    ACNAME = CONVERT(VARCHAR(200),''),
    PROCESSDATE=@PROCESSDATE,
	DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (
	SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER 
	WHERE VDT >= @SDTCUR
	AND VDT <= @LDTCUR + ' 23:59:59'
	AND VDT <= @SAUDA_DATE + ' 23:59:59'
	AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')
	AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)
	GROUP BY CLTCODE 
	UNION ALL
	SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND ADJUST_DATE = @SAUDA_DATE
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')
	AND SELL_BUY = 1 
	GROUP BY PARTY_CODE 
	UNION ALL
	SELECT PARTY_CODE, AMOUNT=-SUM(NETAMT) FROM TBL_PRODUCT_POSITION (NOLOCK)
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN (NOLOCK) WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59'
	AND TBLCLIENTMARGIN.Party_Code = TBL_PRODUCT_POSITION.PARTY_CODE )
	AND SELL_BUY = 1 
	GROUP BY PARTY_CODE
	) A
	GROUP BY cltcode 
	HAVING SUM(AMOUNT) <> 0 

	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
 
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT
			
	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA
	
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG + ' SEGMENT'
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, 
		DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
		AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG + ' SEGMENT'
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BAK_PROC_PRODUCT_PROCESS_19042018
-- --------------------------------------------------
CREATE PROC [dbo].[BAK_PROC_PRODUCT_PROCESS_19042018](
           @SAUDA_DATE DATETIME,
           @FORPARTY VARCHAR(10) = '' )
AS

SET NOCOUNT ON
  
DELETE FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE 
FROM TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY,MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY,MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST_LED
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=1,ISIN,QTY,MKTAMT=NETAMT,NETAMT=NETAMT,CL_RATE,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST_BUY
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = 'DEC 31 2049 23:59'
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

DECLARE @SELLCUR	CURSOR,
		@BUYCUR		CURSOR,
		@SELL_SNO	NUMERIC(18,0), 
		@BUY_SNO	NUMERIC(18,0),
		@PARTY_CODE	VARCHAR(10), 
		@SCRIP_CD	VARCHAR(12), 
		@SERIES		VARCHAR(3), 
		@BSECODE	VARCHAR(6), 
		@ISIN		VARCHAR(12), 
		@SELL_QTY	INT,
		@BUY_QTY	INT,
		@BUY_SAUDA_DATE	DATETIME,
		@SETT_TYPE	VARCHAR(2),
		@SETT_NO	VARCHAR(7),
		@TRANSTYPE	VARCHAR(5)

/*
SET @SELLCUR = CURSOR FOR
	SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, TRANSTYPE
	FROM  TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND Sell_Buy = 2 AND QTY > 0 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION P1
	WHERE  SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE
	AND P.TRANSTYPE = P1.TRANSTYPE) 
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY, @TRANSTYPE
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND QTY > 0 AND TRANSTYPE = @TRANSTYPE
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION
					SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE
					FROM TBL_PRODUCT_POSITION
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2)
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @BUY_SAUDA_DATE
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION
						SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE
						FROM TBL_PRODUCT_POSITION
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2)
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY, @TRANSTYPE
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

DELETE FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE = @SAUDA_DATE AND
SAUDA_DATE = ADJUST_DATE 

SET @SELLCUR = CURSOR FOR
	SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM  TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND Sell_Buy = 2 AND QTY > 0 
	AND ADJUST_DATE = 'DEC 31 2049 23:59' 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION P1
	WHERE  SAUDA_DATE < @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE < @SAUDA_DATE
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND QTY > 0 
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION
					SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE
					FROM TBL_PRODUCT_POSITION
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2)
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @BUY_SAUDA_DATE
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION
						SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE
						FROM TBL_PRODUCT_POSITION
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2)
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

*/
SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF
FROM TBL_PRODUCT_POSITION P1
WHERE  SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)

UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF 
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND TBL_PRODUCT_POSITION.PARTY_CODE = #SQOFF.PARTY_CODE
AND TBL_PRODUCT_POSITION.ISIN = #SQOFF.ISIN

SET @SELLCUR = CURSOR FOR
	SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM TBL_PRODUCT_POSITION P
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 2 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
	AND QTY > 0 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION P1
	WHERE  SAUDA_DATE <= @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN  
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE, SETT_NO, SETT_TYPE
	FROM  TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1
	AND PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND QTY > 0
	ORDER BY SAUDA_DATE, SETT_NO, SETT_TYPE, QTY
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	WHILE @@FETCH_STATUS = 0 
	BEGIN  
		IF @SELL_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE IF @SELL_QTY > @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				INSERT INTO TBL_PRODUCT_POSITION
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@BUY_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION
				WHERE SNO = @SELL_SNO 

				UPDATE TBL_PRODUCT_POSITION SET 
				QTY=QTY-@BUY_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2)
				WHERE SNO = @SELL_SNO 

				SET @SELL_QTY = @SELL_QTY - @BUY_QTY
				SET @BUY_QTY = 0
			END

			ELSE IF @SELL_QTY < @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO

				INSERT INTO TBL_PRODUCT_POSITION
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@SELL_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=ROUND((NETAMT/QTY)*(@SELL_QTY),2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION SET 
				QTY=QTY-@SELL_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*(@SELL_QTY),2)
				WHERE SNO = @BUY_SNO 

				SET @BUY_QTY = @BUY_QTY - @SELL_QTY
				SET @SELL_QTY = 0 
				 
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

DELETE FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 2 AND ADJUST_DATE > SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
 
SELECT PARTY_CODE INTO #CL_PARTY FROM TBLCLIENTMARGIN
WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION
SELECT @SAUDA_DATE, SETT_NO = '2000000', SETT_TYPE = SETT_TYPE,
PARTY_CODE, PRODUCT_CODE, SCRIP_CD, SERIES, BSECODE, SELL_BUY = 2, ISIN,
QTY = SUM(QTY), MKTAMT = 0, NETAMT = 0, CL_RATE = 0, PAYIN_DATE = @SAUDA_DATE,
ADJUST_DATE = @SAUDA_DATE, TRANSTYPE, PROCESSDATE = GETDATE()
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)
GROUP BY SETT_TYPE, PARTY_CODE, PRODUCT_CODE, 
		 SCRIP_CD, SERIES, BSECODE, SELL_BUY, ISIN, TRANSTYPE
		 
UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = @SAUDA_DATE
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.bak_RPT_NSE_MTFFILE_NEW_01072021
-- --------------------------------------------------
CREATE PROC [dbo].[bak_RPT_NSE_MTFFILE_NEW_01072021]      
(      
	@SAUDA_DATE VARCHAR(11),
	@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = ''      
)      
AS      

-- EXEC bak_RPT_NSE_MTFFILE_NEW_01072021 'JUN 30 2021'  

DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'    
AND FLDFILEDATE = @SAUDA_DATE    
/*    
   
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY,      
FRESHBUY,      
FRESHSQTY,    
FRESHSELL,
NETQTY,      
NETAMOUNT
INTO #NSERPT
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

INSERT INTO ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT    
GROUP BY MEMBERCODE     
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
    
  
       
     
    
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' + 
'N,NSE'     
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO 

--select * from #REPORT
--return

CREATE INDEX #PARTY ON #NSERPT
( PARTY_CODE)


SELECT *, EXCHG = 'BSE' INTO #MTFCOLL
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG = 'MTFCOLL' 


create clustered index idx_isin on #MTFCOLL
(
	SAUDA_DATE, 
	isin
)
 

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and ISIN not IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and SCRIP_CD IN ('BALMRLIN','CHEVIOT','DIL','EPCIN','PIXTRANS','WESTLIFEDE','WPIL')



UPDATE #MTFCOLL SET EXCHG = 'NSE'
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'
AND D.DETAILKEY = C.DetailKey 
AND D.ISIN = #MTFCOLL.ISIN
AND D.SCRIP_CD = #MTFCOLL.SCRIP_CD ---

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN LEFT(SCRIP_CD,10) ELSE SCRIP_CD END), 
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG,
CASHCOLL = CONVERT(NUMERIC(18,2),0)
INTO #HOLD
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE 
AND   C.CL_CODE = H.PARTY_CODE
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R 
				     WHERE R.PARTY_CODE = H.PARTY_CODE)
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
--AND EXCHG = 'NSE'
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN MTFLEDBAL - SUM(NETAMT) > 0 
								  THEN MTFLEDBAL - SUM(NETAMT)
								  ELSE 0
						     END)
INTO #COLLCASH
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT) 
	FROM   #HOLD
	GROUP BY PARTY_CODE, CASHCOLL
) A

        
    
      

INSERT INTO #REPORT  
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)
		    + ',' + CAT + ',' + EXCHG
FROM #HOLD

UPDATE #REPORT SET DATA = UPPER(DATA)
UPDATE #REPORT SET DATA = ISNULL (DATA,'')


 

INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
				+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
DATA = LTRIM(RTRIM(DATA))
 FROM #REPORT  
ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BR_YEAREND
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[BR_YEAREND]
 @SDTCUR VARCHAR(11),      
 @LDTCUR VARCHAR(11),      
 @VTYP   SMALLINT,      
 @VNO VARCHAR(12),      
 @BOOKTYPE CHAR(2),      
 @VDT    DATETIME,
 @PNLCODE VARCHAR(10)      
      
AS      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
      
DECLARE      
 @@MAINCTRLAC AS VARCHAR(10),      
 @@MAINACNAME AS VARCHAR(100),      
 @@MAINCOSTCODE AS INT,      
 @@LNO AS INT,      
 @@COSTCODE AS SMALLINT,      
 @@AMT AS MONEY,      
 @@RCURSOR AS CURSOR
  
    
      
SELECT       
 @@LNO =       
 (       
 SELECT       
  LNO       
 FROM LEDGER       
 WHERE VTYP = @VTYP       
  AND BOOKTYPE = @BOOKTYPE       
  AND VNO = @VNO       
  AND CLTCODE = @PNLCODE       
 )      
      
SELECT       
 @@MAINCTRLAC =       
 (       
 SELECT       
  MAINCONTROLAC       
 FROM BRANCHACCOUNTS       
 WHERE DEFAULTAC = 1      
 )      
      
SELECT @@MAINCOSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME IN(SELECT BRANCHNAME FROM BRANCHACCOUNTS WHERE DEFAULTAC = 1)      
      
SELECT       
 @@MAINACNAME =       
 (       
 SELECT       
  ACNAME       
 FROM ACMAST       
 WHERE CLTCODE = @@MAINCTRLAC       
 )    

TRUNCATE TABLE LEDGER_BRANCHBREAKUP

INSERT INTO LEDGER_BRANCHBREAKUP
SELECT VNO, VTYPE, BOOKTYPE, LNO, CLTCODE, CAMT, COSTCODE, DRCR 
FROM LEDGER2 L2 WITH (NOLOCK) WHERE CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE) 
AND EXISTS(SELECT VNO FROM LEDGER L WITH (NOLOCK) WHERE VDT > = @SDTCUR + ' 00:00:00'           
 AND VDT <= @LDTCUR + ' 23:59:59' AND L2.VTYPE = L.VTYP           
AND L2.BOOKTYPE = L.BOOKTYPE           
 AND L2.VNO = L.VNO           
 AND L2.LNO = L.LNO   )  
      
TRUNCATE TABLE BRANCHWISECLBAL 

INSERT INTO BRANCHWISECLBAL
SELECT   
 L2.CLTCODE,           
 A.ACNAME ,           
 COSTCODE,           
 BALANCE=SUM(           
 CASE           
  WHEN UPPER(L2.DRCR) = 'D'           
  THEN CAMT           
  ELSE -CAMT           
 END          
 )           
FROM LEDGER_BRANCHBREAKUP L2,           
 ACMAST A           
  
WHERE 
L2.CLTCODE = A.CLTCODE
 AND           
 (          
  A.ACTYP LIKE 'ASS%'           
  OR A.ACTYP LIKE 'LIAB%'          
 )           
          
GROUP BY COSTCODE,           
 L2.CLTCODE,           
 A.ACNAME        
      
/*
INSERT       
INTO BRANCHWISECLBAL       
SELECT       
 L2.CLTCODE,       
 A.ACNAME ,       
 COSTCODE,       
 BALANCE=SUM(       
 CASE       
  WHEN UPPER(L2.DRCR) = 'D'       
  THEN CAMT       
  ELSE -CAMT       
 END      
 )       
FROM LEDGER2 L2       
LEFT OUTER JOIN       
 ACMAST A       
 ON L2.CLTCODE = A.CLTCODE,       
 LEDGER L       
WHERE L2.VTYPE = L.VTYP       
 AND L2.BOOKTYPE = L.BOOKTYPE       
 AND L2.VNO = L.VNO       
 AND L2.LNO = L.LNO       
 AND L.VDT > = @SDTCUR + ' 00:00:00'       
 AND L.VDT <= @LDTCUR + ' 23:59:59'       
 AND       
 (      
  A.ACTYP LIKE 'ASS%'       
  OR A.ACTYP LIKE 'LIAB%'      
 )       
 AND L2.CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)       
GROUP BY COSTCODE,       
 L2.CLTCODE,       
 A.ACNAME
*/
INSERT       
  INTO BRANCHWISECLBAL       
	SELECT      
	  @@MAINCTRLAC,       
	  @@MAINACNAME,       
	  COSTCODE,      
	  -(SUM(BALANCE))
	 FROM      
	  BRANCHWISECLBAL      
	 GROUP BY      
	  COSTCODE 

    

/*      
SET @@RCURSOR = CURSOR FOR      
 SELECT      
  COSTCODE,      
  SUM(BALANCE)      
 FROM      
  BRANCHWISECLBAL      
 GROUP BY      
  COSTCODE      
      
OPEN @@RCURSOR      
 FETCH NEXT FROM      
  @@RCURSOR       
 INTO      
  @@COSTCODE,      
  @@AMT      
      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  INSERT       
  INTO BRANCHWISECLBAL VALUES      
   (       
    @@MAINCTRLAC,       
    @@MAINACNAME,       
    @@COSTCODE,       
    -(@@AMT)       
   )      
      
  FETCH NEXT FROM      
   @@RCURSOR       
  INTO      
   @@COSTCODE,      
   @@AMT      
 END      
      
CLOSE @@RCURSOR      
DEALLOCATE @@RCURSOR     
*/ 
      
INSERT       
INTO LEDGER2       
SELECT       
 L.VTYP,       
 L.VNO,       
 L.LNO,       
 (      
 CASE       
  WHEN (CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END) >= 0       
  THEN 'D'       
  ELSE 'C'       
 END      
 ),       
 ABS(CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END),       
 COSTCODE,       
 L.BOOKTYPE,       
 B.CLTCODE       
FROM LEDGER L,       
 BRANCHWISECLBAL B       
WHERE L.VTYP = @VTYP       
 AND L.BOOKTYPE = @BOOKTYPE       
 AND L.VNO = @VNO       
 AND L.CLTCODE = B.CLTCODE      
 AND L.CLTCODE NOT IN       
 (       
 SELECT       
  BRCONTROLAC       
 FROM BRANCHACCOUNTS       
 )      
      
INSERT       
INTO LEDGER2       
SELECT       
 @VTYP,       
 @VNO,       
 @@LNO,       
 (      
 CASE       
  WHEN BALANCE >= 0       
  THEN 'D'       
  ELSE 'C'       
 END      
 ),       
 ABS(BALANCE),       
 COSTCODE,       
 @BOOKTYPE,       
 CLTCODE       
FROM BRANCHWISECLBAL B       
WHERE CLTCODE IN       
 (       
 SELECT       
  BRCONTROLAC       
 FROM BRANCHACCOUNTS       
 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Bryearend
-- --------------------------------------------------

CREATE Procedure [dbo].[Bryearend]   
@sdtcur varchar(11),  
@ldtcur varchar(11),  
@vtyp   smallint,  
@vno varchar(12),  
@BookType char(2),  
@vdt    datetime  
  
AS  
declare  
@@mainctrlac as varchar(10),  
@@mainacname as varchar(35),  
@@placname   as varchar(35),  
@@lno        as int,  
@@costcode   as int,  
@@ctrlac     as varchar(10),  
@@ctrlname   as varchar(35),  
@@amt        as money,  
@@maincc     as int,  
@@plamt      as money,  
@@rcursor    as cursor  
  
  
select @@lno = ( select lno from ledger where vtyp = @vtyp and booktype = @booktype and vno = @vno and cltcode = '99999' )  
select @@mainctrlac = ( select MainControlAc from branchaccounts where defaultac = 1)  
select @@mainacname = ( select acname from acmast where cltcode = @@mainctrlac )  
select @@maincc = ( select costcode from costmast, branchaccounts where defaultac = 1 and branchname = costname )  
select @@placname = ( select acname from acmast where cltcode = '99999' )  
  
truncate table branchwiseclbal  
  
insert into branchwiseclbal  
select l2.cltcode, a.acname , costcode, balance=sum( case when upper(l2.drcr) = 'D' then camt else -camt end)  
from ledger2 l2 left outer join acmast a on l2.cltcode = a.cltcode, ledger l  
where l2.vtype = l.vtyp and l2.booktype = l.booktype and l2.vno = l.vno and l2.lno = l.lno  
and l.vdt > = @sdtcur + ' 00:00:00' and l.vdt <= @ldtcur + ' 23:59:59'  
and (a.actyp like 'ASS%' or a.actyp like 'LIAB%')   
group by costcode, l2.cltcode, a.acname  
  
delete from branchwiseclbal where cltcode in (select brcontrolac from branchaccounts)  
delete from branchwiseclbal where cltcode = '99999'  
  
set @@rcursor = cursor for  
select b.costcode, brcontrolac, a.acname, sum(balance)  
from branchwiseclbal b, costmast c, branchaccounts ba, acmast a  
where b.costcode = c.costcode and c.costname = ba.branchname and ba.brcontrolac = a.cltcode  
group by b.costcode, brcontrolac, a.acname  
order by b.costcode, brcontrolac, a.acname  
  
open @@rcursor  
fetch next from @@rcursor   
into @@costcode, @@ctrlac, @@ctrlname, @@amt  
  
while @@fetch_status = 0  
begin  
  if @@costcode <> @@maincc  
/*     begin  
        insert into branchwiseclbal values( '99999', @@placname, @@costcode, -(@@amt) )  
     end  
  else */  
     begin  
        insert into branchwiseclbal values( @@mainctrlac, @@mainacname, @@costcode, -(@@amt) )  
        insert into branchwiseclbal values( @@ctrlac, @@ctrlname, @@maincc, (@@amt) )  
     end  
  
  fetch next from @@rcursor   
  into @@costcode, @@ctrlac, @@ctrlname, @@amt  
end  
  
close @@rcursor  
deallocate @@rcursor  
  
select @@plamt = ( select sum(balance) from branchwiseclbal where costcode = @@maincc )  
/* print convert(varchar,@@plamt) */  
insert into branchwiseclbal values( '99999', @@placname, @@maincc, -(@@plamt) )  
  
insert into ledger2  
select l.vtyp, l.vno, l.lno, ( Case when balance >= 0 then 'D' else 'C' end),  
abs(balance), costcode, l.booktype, b.cltcode  
from ledger l, branchwiseclbal b  
where l.vtyp = @vtyp and l.booktype = @booktype and l.vno = @vno and l.cltcode = b.cltcode  
and b.cltcode not in ( select brcontrolac from branchaccounts )  
  
insert into ledger2   
select @vtyp, @vno, @@lno, (case when balance >= 0 then 'D' else 'C' end), abs(balance), costcode, @booktype, cltcode  
from branchwiseclbal b  
where cltcode in ( select brcontrolac from branchaccounts )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BSE_MTF_FUND
-- --------------------------------------------------
CREATE PROC [dbo].[BSE_MTF_FUND] (@SAUDA_DATE DATETIME)
AS

DECLARE @PREVDATE DATETIME
 

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT MEMBERCODE='123', P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #DATA  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')   
GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0

INSERT INTO #DATA  
SELECT MEMBERCODE='123', P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK) 
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE='123', P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK) 
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  

--SELECT MEMBERCODE='123', P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'C',   
--ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
--EXCHANGE = 'BSE',  
--MAPPING_NO = '0', 
--BODQTY = 0, 
--BODVALUE = 0,
--FRESHBQTY = SUM(QTY),        
--FRESHBUY = CONVERT(NUMERIC(18,2),SUM(CL_RATE*QTY - CL_RATE*QTY*HAIRCUT/100) / 100000),        
--FRESHSQTY = 0,  
--FRESHSELL = CONVERT(NUMERIC(18,2),0),  
--NETAMOUNT = CONVERT(NUMERIC(18,2),0)  INTO #TEMP 
--FROM TBL_PRODUCT_HOLD_DATA P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)---, AngelBSECM.BSEDB_AB.DBO.OWNER    
--WHERE SAUDA_DATE = @SAUDA_DATE   
--AND HOLDFLAG = 'MTFCOLL'  
--AND C.CL_CODE = P.PARTY_CODE  
--GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE 

--CREATE INDEX ISIN ON  #TEMP
--(ISIN)

--INSERT INTO #DATA  
--SELECT * FROM #TEMP WHERE ISIN IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  

 

SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO, 
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO

     
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 
  


CREATE Index #code on #datafinal
(bsecode )
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE

DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE from bse_grp1)

INSERT INTO BSE_MTF  
SELECT  
SAUDA_DATE=@SAUDA_DATE  ,NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932') AND FLAG_FUNDED='F'
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved) 

HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0
 
  
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_FN_GETCODELIST_suresh
-- --------------------------------------------------

CREATE procedure   [dbo].[CBO_FN_GETCODELIST_suresh](
                @STATUSID   VARCHAR(25),
                @STATUSNAME VARCHAR(25),
                @FROMCODE   VARCHAR(25),
                @TOCODE     VARCHAR(25),
                @SEARCHWHAT VARCHAR(20) = 'CLIENT')
                
        AS            
                
                CREATE TABLE [DBO].#CLIENTLOGIN ( 
                        [ENT_CODE]    [VARCHAR](25) NOT NULL,
                        [ENT_NAME]    [VARCHAR](100) NOT NULL,
                        [PARTY_CODE]  [VARCHAR](10) NOT NULL,
                        [PARENTCODE]  [VARCHAR](10) NOT NULL,
                        [AREA]        [VARCHAR](20) NOT NULL,
                        [REGION]      [VARCHAR](20) NOT NULL,
                        [BRANCH_CD]   [VARCHAR](10) NOT NULL,
                        [SUB_BROKER]  [VARCHAR](10) NOT NULL,
                        [TRADER]      [VARCHAR](20) NOT NULL,
                        [FAMILY]      [VARCHAR](10) NOT NULL,
                        [CL_TYPE]     [VARCHAR](10) NOT NULL,
                        [CL_STATUS]   [VARCHAR](10) NOT NULL,
                        [RELMGR]      [VARCHAR](10) NOT NULL,
                        [SBU]         [VARCHAR](10) NOT NULL,
                        [GROUPCODE]   [VARCHAR](10) NOT NULL)


BEGIN
      INSERT INTO #CLIENTLOGIN
      SELECT E.ENT_CODE, 
             E.ENT_NAME, 
             PARTY_CODE, 
             PARENTCODE = PARTY_CODE, 
             AREA, 
             REGION, 
             BRANCH_CD, 
             SUB_BROKER, 
             TRADER, 
             FAMILY, 
             CL_TYPE, 
             CL_STATUS, 
             ISNULL(REL_MGR,''), 
             ISNULL(SBU,''), 
             ISNULL(C_GROUP,'')
      FROM   MSAJAG..CLIENT_DETAILS C, 
             ABVSCITRUS.NBFC.DBO.CBO_TB_ENTITYMASTER E 
      WHERE  PARTY_CODE BETWEEN @FROMCODE AND @TOCODE
             AND E.ENT_TYPE = @SEARCHWHAT 
             AND ENT_CODE = (CASE
                               WHEN @SEARCHWHAT = 'BRANCH'     THEN C.BRANCH_CD
                               WHEN @SEARCHWHAT = 'SUBBROKER'  THEN C.SUB_BROKER
                               WHEN @SEARCHWHAT = 'TRADER'     THEN C.TRADER
                               WHEN @SEARCHWHAT = 'FAMILY'     THEN C.FAMILY
                               WHEN @SEARCHWHAT = 'AREA'       THEN C.AREA
                               WHEN @SEARCHWHAT = 'REGION'     THEN C.REGION
                               WHEN @SEARCHWHAT = 'CLIENT'     THEN C.PARTY_CODE
                               WHEN @SEARCHWHAT = 'CLTYPE'     THEN C.CL_TYPE
                               WHEN @SEARCHWHAT = 'CLSTATUS'   THEN C.CL_STATUS
                               WHEN @SEARCHWHAT = 'RELMGR'     THEN C.REL_MGR
                               WHEN @SEARCHWHAT = 'SBU'        THEN C.SBU
                               WHEN @SEARCHWHAT = 'GROUPCODE'  THEN C.C_GROUP
                               ELSE ''
                             END)
             AND @STATUSNAME = (CASE
                                  WHEN @STATUSID = 'BRANCH'    THEN C.BRANCH_CD
                                  WHEN @STATUSID = 'SUBBROKER' THEN C.SUB_BROKER
                                  WHEN @STATUSID = 'TRADER'    THEN C.TRADER
                                  WHEN @STATUSID = 'FAMILY'    THEN C.FAMILY
                                  WHEN @STATUSID = 'AREA'      THEN C.AREA
                                  WHEN @STATUSID = 'REGION'    THEN C.REGION
                                  WHEN @STATUSID = 'CLIENT'    THEN C.PARTY_CODE
                                  ELSE 'BROKER'
                                END)


    

    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_GETLEDGERBALANCE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CBO_GETLEDGERBALANCE](      
                @STATUSID   VARCHAR(25),      
                @STATUSNAME VARCHAR(25),      
                @EXCHANGE   VARCHAR(25),      
                @SEGMENT    VARCHAR(25),      
                @FROMCODE   VARCHAR(25),      
                @TOCODE     VARCHAR(25),      
                @DATEFROM VARCHAR(11),      
                @DATETO   VARCHAR(11),      
                @SEARCHWHAT VARCHAR(20) = 'CLIENT')      
      
  AS      
      
  SET NOCOUNT ON       
      
  CREATE TABLE [DBO].[#LEDBALANCE] (      
   [ENT_CODE] [VARCHAR] (25) NOT NULL ,      
   [ENT_NAME] [VARCHAR] (100) NOT NULL ,      
   [LEDBAL] [MONEY] NOT NULL ,      
   [DRCR] [VARCHAR] (1) NOT NULL,       
   [BALFLAG] [INT] NOT NULL,       
   [LEDFLAG] [INT] NOT NULL       
  ) ON [PRIMARY]    
  
  
  
 
      
  INSERT INTO #LEDBALANCE       
  SELECT   ENT_CODE,       
           ENT_NAME,       
           LEDBAL = SUM(VAMT),      
           DRCR,        
           BALFLAG = 1,       
           LEDFLAG = 1       
  FROM     LEDGER L (NOLOCK),       
           .DBO.CBO_FN_GETCODELIST(@STATUSID,@STATUSNAME,@FROMCODE,@TOCODE,@SEARCHWHAT) M,       
           PARAMETER P       
  WHERE    @DATETO BETWEEN SDTCUR AND LDTCUR       
   AND VDT >=SDTCUR     
           AND VDT <= @DATETO + ' 23:59:59'       
           AND PARTY_CODE = CLTCODE       
  GROUP BY ENT_CODE,ENT_NAME,DRCR
  
  INSERT INTO #LEDBALANCE       
  SELECT   ENT_CODE,       
           ENT_NAME,       
           LEDBAL = SUM(VAMT),      
           DRCR,        
           BALFLAG = 2,       
           LEDFLAG = 1       
  FROM     LEDGER L (NOLOCK),       
           .DBO.CBO_FN_GETCODELIST(@STATUSID,@STATUSNAME,@FROMCODE,@TOCODE,@SEARCHWHAT) M,       
           PARAMETER P       
  WHERE    VDT BETWEEN SDTCUR AND LDTCUR       
           AND EDT > @DATETO + ' 23:59:59'       
           AND PARTY_CODE = CLTCODE       
  GROUP BY ENT_CODE,ENT_NAME,DRCR      
      
  SELECT   ENT_CODE,       
           ENT_NAME,       
           LEDBAL = SUM(CASE       
                          WHEN LEDFLAG = 1       
                               AND BALFLAG = 1 THEN (CASE       
                                                       WHEN DRCR = 'D' THEN -LEDBAL       
                                                       ELSE LEDBAL       
                                                     END)      
                          ELSE 0       
                        END),      
           MARBAL = SUM(CASE       
                          WHEN LEDFLAG = 2       
                               AND BALFLAG = 1 THEN (CASE       
                                                       WHEN DRCR = 'D' THEN -LEDBAL       
                                                       ELSE LEDBAL       
                                                     END)      
                          ELSE 0       
                        END),      
           UCLBAL = SUM(CASE       
                          WHEN LEDFLAG = 1       
                               AND BALFLAG = 2 THEN (CASE       
                                                       WHEN DRCR = 'D' THEN -LEDBAL       
                                                       ELSE LEDBAL       
                                      END)      
                          ELSE 0       
                        END),       
           @EXCHANGE,       
           @SEGMENT       
  FROM     #LEDBALANCE       
 GROUP BY ENT_CODE, ENT_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_GETLEDGERDETAILS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CBO_GETLEDGERDETAILS](
                @STATUSID   VARCHAR(25),
                @STATUSNAME VARCHAR(25),
                @EXCHANGE   VARCHAR(25),
                @SEGMENT    VARCHAR(25),
                @FROMCODE   VARCHAR(25),
                @TOCODE     VARCHAR(25),
                @FROMDATE   VARCHAR(11),
                @TODATE     VARCHAR(11),
                @SEARCHCODE VARCHAR(25), 
                @SEARCHWHAT VARCHAR(20) = 'CLIENT')

AS

/*
  EXECUTE CBO_GETLEDGERDETAILS 1,258
*/
  SET NOCOUNT ON
  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  IF @SEARCHCODE = '' SELECT SEARCHCODE = '%'

  DECLARE  @FLDAUTO     INT,
           @FLDAUTOFROM INT,
           @OPENDATE    VARCHAR(11)
                        
  SELECT @FLDAUTO = ISNULL(MAX(FLDAUTO),0)
  FROM   PARAMETER WITH (NOLOCK)
  WHERE  CONVERT(DATETIME,CONVERT(CHAR,@TODATE)) BETWEEN SDTCUR AND LDTCUR
     
  SELECT @FLDAUTOFROM = ISNULL(MAX(FLDAUTO),0)
  FROM   PARAMETER WITH (NOLOCK)
  WHERE  CONVERT(DATETIME,CONVERT(CHAR,@FROMDATE)) BETWEEN SDTCUR AND LDTCUR
                                                                      
CREATE TABLE [dbo].[#MINILEDGER_DETAIL] (
	[MLD_VTYP] [smallint] NOT NULL ,
	[MLD_BOOKTYPE] [char] (2) NOT NULL ,
	[MLD_LNO] [decimal](5, 0) NOT NULL ,
	[MLD_VNO] [varchar] (12) NOT NULL ,
	[MLD_EDT] [datetime] NOT NULL ,
	[MLD_VDT] [datetime] NOT NULL ,
	[MLD_SHORTDESC] [char] (35) NOT NULL ,
	[MLD_DRAMT] [money] NOT NULL ,
	[MLD_CRAMT] [money] NOT NULL ,
	[MLD_DDNO] [varchar] (20) NULL ,
	[MLD_NARRATION] [varchar] (300) NULL ,
	[MLD_CLTCODE] [varchar] (10) NOT NULL ,
	[MLD_OPBAL] [money] NOT NULL ,
	[MLD_CROSAC] [varchar] (10) NULL ,
	[MLD_EDIFF] [int] NULL ,
	[MLD_LEDGER] [int] NULL ,
	[MLD_OPBALFLAG] [int] NOT NULL,
	[MLD_ENTEREDBY] [VARCHAR](100) NOT NULL 
) ON [PRIMARY]

CREATE TABLE [dbo].[#MINILEDGER_MASTER] (
	[MLM_ACCAT] [char] (10) NOT NULL ,
	[MLM_CLTCODE] [varchar] (10) NOT NULL ,
	[MLM_BRANCH_CD] [varchar] (10) NOT NULL ,
	[MLM_ACNAME] [varchar] (100) NOT NULL 
) ON [PRIMARY]

CREATE TABLE [dbo].[#MARGINLEDGER_TMP] (
	[VTYP] [smallint] NOT NULL ,
	[BOOKTYPE] [char] (2) NOT NULL ,
	[LNO] [decimal](5, 0) NOT NULL ,
	[VNO] [varchar] (12) NOT NULL ,
	[EDT] [datetime] NOT NULL ,
	[VDT] [datetime] NOT NULL ,
	[VAMT] [money] NOT NULL ,
	[NARRATION] [varchar] (300) NULL ,
	[CLTCODE] [varchar] (10) NOT NULL ,
	[DRCR] [varchar] (1) NOT NULL,
	[ENTEREDBY] [VARCHAR](100)
) ON [PRIMARY]
  
CREATE TABLE [dbo].[#OPPBALANCE_TMP] (
	[CLTCODE] [varchar] (10) NOT NULL ,
	[OPPBAL] [money] NOT NULL ,
	[DRCR] [varchar] (1) NOT NULL 
) ON [PRIMARY]
  
CREATE TABLE [dbo].[#VMAST_TMP] (
	[VTYPE] [smallint] NOT NULL 
) ON [PRIMARY]

CREATE TABLE [dbo].[#CLIENT] (
  [ENT_CODE]    [VARCHAR](25) NOT NULL,
  [ENT_NAME]    [VARCHAR](100) NOT NULL,
  [PARTY_CODE]  [VARCHAR](10) NOT NULL,
  [PARENTCODE]  [VARCHAR](10) NOT NULL,
  [AREA]        [VARCHAR](20) NOT NULL,
  [REGION]      [VARCHAR](20) NOT NULL,
  [BRANCH_CD]   [VARCHAR](10) NOT NULL,
  [SUB_BROKER]  [VARCHAR](10) NOT NULL,
  [TRADER]      [VARCHAR](20) NOT NULL,
  [FAMILY]      [VARCHAR](10) NOT NULL,
  [CL_TYPE]     [VARCHAR](10) NOT NULL,
  [CL_STATUS]   [VARCHAR](10) NOT NULL,
  [RELMGR]      [VARCHAR](10) NOT NULL,
  [SBU]         [VARCHAR](10) NOT NULL,
  [GROUPCODE]   [VARCHAR](10) NOT NULL 
) ON [PRIMARY]

  INSERT INTO #CLIENT 
  SELECT * 
  FROM   .dbo.CBO_FN_GETCODELIST(
                           @STATUSID,
                           @STATUSNAME,
                           @FROMCODE,
                           @TOCODE,
                           @SEARCHWHAT)
  WHERE ENT_CODE LIKE @SEARCHCODE
  
  IF @FLDAUTOFROM <> 0
    BEGIN
      SELECT @OPENDATE = LEFT(SDTCUR,11)
      FROM   PARAMETER WITH (NOLOCK)
      WHERE  FLDAUTO = @FLDAUTOFROM
    END
  ELSE
    BEGIN
    PRINT @FLDAUTO
      SELECT @OPENDATE = LEFT(SDTCUR,11)
      FROM   PARAMETER WITH (NOLOCK)
      WHERE  FLDAUTO = @FLDAUTO
                       
      SELECT @FROMDATE = @OPENDATE
    END
    
  ---------------------------------------------
  --SETTLEMENT LEDGER OPENING BALANCE
  ---------------------------------------------
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE = C.ENT_CODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     LEDGER L WITH (NOLOCK), 
           #CLIENT C
  WHERE    EDT LIKE @OPENDATE + '%' 
           AND VTYP = 18
           AND L.CLTCODE = C.PARTY_CODE 
  GROUP BY C.ENT_CODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE = C.ENT_CODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     LEDGER L WITH (NOLOCK), 
           #CLIENT C
  WHERE    EDT >= @OPENDATE
           AND EDT < @FROMDATE
           AND VTYP <> 18
           AND L.CLTCODE = C.PARTY_CODE 
  GROUP BY C.ENT_CODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE = C.ENT_CODE,
           OPPBAL = ISNULL(SUM(VAMT),0),
           DRCR = (CASE 
                     WHEN DRCR = 'C' THEN 'D'
                     ELSE 'C'
                   END)
  FROM     LEDGER L WITH (NOLOCK), 
           #CLIENT C
  WHERE    EDT >= @OPENDATE
           AND VDT < @OPENDATE
           AND L.CLTCODE = C.PARTY_CODE 
  GROUP BY C.ENT_CODE,DRCR
           
  INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN OPPBAL
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN 0
                    ELSE ABS(OPPBAL)
                  END),
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(@FROMDATE)),
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   (SELECT   CLTCODE,
                   OPPBAL = SUM(CASE 
                                  WHEN DRCR = 'D' THEN OPPBAL
                                  ELSE -OPPBAL
                                END)
          FROM     #OPPBALANCE_TMP
          GROUP BY CLTCODE) L
         
  ---------------------------------------------
  --MARGIN LEDGER OPENING BALANCE
  ---------------------------------------------
  
  TRUNCATE TABLE #OPPBALANCE_TMP
  
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     #MARGINLEDGER_TMP WITH (NOLOCK)
  WHERE    EDT LIKE @OPENDATE + '%' 
           AND VTYP = 18
  GROUP BY CLTCODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     #MARGINLEDGER_TMP WITH (NOLOCK)
  WHERE    EDT >= @OPENDATE
           AND EDT < @FROMDATE
           AND VTYP <> 18
  GROUP BY CLTCODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE,
           OPPBAL = ISNULL(SUM(VAMT),0),
           DRCR = (CASE 
                     WHEN DRCR = 'C' THEN 'D'
                     ELSE 'C'
                   END)
  FROM     #MARGINLEDGER_TMP WITH (NOLOCK)
  WHERE    EDT >= @OPENDATE
           AND VDT < @OPENDATE
  GROUP BY CLTCODE,DRCR
           
  INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN OPPBAL
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN 0
                    ELSE ABS(OPPBAL)
                  END),
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(@FROMDATE)),
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   (SELECT   CLTCODE,
                   OPPBAL = SUM(CASE 
                                  WHEN DRCR = 'D' THEN OPPBAL
                                  ELSE -OPPBAL
                                END)
          FROM     #OPPBALANCE_TMP
          GROUP BY CLTCODE) L
         
  ---------------------------------------------
  --SETTLEMENT LEDGER ENTRIES
  ---------------------------------------------
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         LNO=ACTNODAYS,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         NARRATION = L.NARRATION,
         CLTCODE = C.ENT_CODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 1,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   LEDGER L WITH (NOLOCK),
         VMAST V WITH (NOLOCK),
         #CLIENT C 
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18 
         AND L.CLTCODE = C.PARTY_CODE
  ORDER BY 6, 12, 1, 2, 4, 3
  --ORDER BY L.VDT, L.CLTCODE, L.VTYP, L.BOOKTYPE, L.VNO, L.DRCR, L.LNO 
                        
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         LNO=ACTNODAYS,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         NARRATION = L.NARRATION,
         CLTCODE = C.ENT_CODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 2,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   LEDGER L WITH (NOLOCK),
         VMAST V WITH (NOLOCK), 
         #CLIENT C 
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT > @TODATE + ' 23:59:59' 
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18 
         AND L.CLTCODE = C.PARTY_CODE 
  ORDER BY 6, 12, 1, 2, 4, 3
  --ORDER BY VDT, CLTCODE, VTYP, BOOKTYPE, LNO, VNO, DRCR 
                        
  ---------------------------------------------
  --MARGIN LEDGER ENTRIES
  ---------------------------------------------
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         L.LNO,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         L.NARRATION,
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 1,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   #MARGINLEDGER_TMP L WITH (NOLOCK),
         VMAST V WITH (NOLOCK)
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18
                        
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         L.LNO,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         L.NARRATION,
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 2,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   #MARGINLEDGER_TMP L WITH (NOLOCK),
         VMAST V WITH (NOLOCK)
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT > @TODATE + ' 23:59:59'
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18
                        
  ---------------------------------------------------------------
  --UPDATE CROSS ACCOUNT AND CHEQUE NUMBER
  ---------------------------------------------------------------
  INSERT INTO #VMAST_TMP
  SELECT VTYPE
  FROM   VMAST
  WHERE  VTYPE IN ('1','2','3','4',
                   '5','16','17','19',
                   '20','22','23')

  UPDATE A
  SET    A.MLD_CROSAC = B.CLTCODE
  FROM   #MINILEDGER_DETAIL A,
         LEDGER B
  WHERE  B.CLTCODE <> A.MLD_CLTCODE
         AND A.MLD_BOOKTYPE = B.BOOKTYPE
         AND A.MLD_VNO = B.VNO
         AND A.MLD_VTYP = B.VTYP
         AND EXISTS (SELECT VTYPE
                     FROM   #VMAST_TMP V
                     WHERE  V.VTYPE = A.MLD_VTYP)
         AND (B.VAMT = A.MLD_CRAMT + A.MLD_DRAMT)
             
  UPDATE A
  SET    A.MLD_DDNO = ISNULL(B.DDNO,'')
  FROM   #MINILEDGER_DETAIL A,
         LEDGER1 B WITH (NOLOCK)
  WHERE  A.MLD_BOOKTYPE = B.BOOKTYPE
         AND A.MLD_VNO = B.VNO
         AND A.MLD_VTYP = B.VTYP
         AND EXISTS (SELECT VTYPE
                     FROM   #VMAST_TMP V
                     WHERE  V.VTYPE = A.MLD_VTYP)
                    
  ---------------------------------------------------------------
  --POPULATE MINI LEDGER MASTER RECORDS 
  ---------------------------------------------------------------
  INSERT INTO #MINILEDGER_MASTER
  SELECT   ACCAT,
           CLTCODE,
           BRANCHCODE,
           ACNAME
  FROM     ACMAST A WITH (NOLOCK)
  WHERE    EXISTS (SELECT DISTINCT CLTCODE
                   FROM   #MINILEDGER_DETAIL V
                  WHERE  A.CLTCODE = V.MLD_CLTCODE)
  ORDER BY 1,
           2

  INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = 0,
         CRAMT = 0,
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(CONVERT(CHAR,@FROMDATE))),
         MLM_CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   #MINILEDGER_MASTER 
  WHERE  NOT EXISTS (SELECT DISTINCT MLD_CLTCODE
                     FROM   #MINILEDGER_DETAIL 
                     WHERE  MLM_CLTCODE = MLD_CLTCODE
                            AND MLD_LEDGER = 1
                            AND MLD_OPBALFLAG = 0) 
 
 INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = 0,
         CRAMT = 0,
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(CONVERT(CHAR,@FROMDATE))),
         MLM_CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   #MINILEDGER_MASTER 
  WHERE  NOT EXISTS (SELECT DISTINCT MLD_CLTCODE
                     FROM   #MINILEDGER_DETAIL 
                     WHERE  MLM_CLTCODE = MLD_CLTCODE
                            AND MLD_LEDGER = 2
                            AND MLD_OPBALFLAG = 0) 

  SELECT D.*, 
         @EXCHANGE, 
         @SEGMENT, 
         C.ENT_NAME 
  FROM   #MINILEDGER_DETAIL D, 
         (SELECT DISTINCT ENT_CODE, ENT_NAME FROM #CLIENT) C 
  WHERE  C.ENT_CODE = D.MLD_CLTCODE
  ORDER BY 12, 16, 17, 6, 5, 8 DESC, 9

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_GETLEDGERDETAILS_TEST
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CBO_GETLEDGERDETAILS_TEST](
                @STATUSID   VARCHAR(25),
                @STATUSNAME VARCHAR(25),
                @EXCHANGE   VARCHAR(25),
                @SEGMENT    VARCHAR(25),
                @FROMCODE   VARCHAR(25),
                @TOCODE     VARCHAR(25),
                @FROMDATE   VARCHAR(11),
                @TODATE     VARCHAR(11),
                @SEARCHCODE VARCHAR(25), 
                @SEARCHWHAT VARCHAR(20) = 'CLIENT')

AS

/*
  EXECUTE CBO_GETLEDGERDETAILS 1,258
*/
  SET NOCOUNT ON
  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  IF @SEARCHCODE = '' SELECT SEARCHCODE = '%'

  DECLARE  @FLDAUTO     INT,
           @FLDAUTOFROM INT,
           @OPENDATE    VARCHAR(11)
                        
  SELECT @FLDAUTO = ISNULL(MAX(FLDAUTO),0)
  FROM   PARAMETER WITH (NOLOCK)
  WHERE  CONVERT(DATETIME,CONVERT(CHAR,@TODATE)) BETWEEN SDTCUR AND LDTCUR
     
  SELECT @FLDAUTOFROM = ISNULL(MAX(FLDAUTO),0)
  FROM   PARAMETER WITH (NOLOCK)
  WHERE  CONVERT(DATETIME,CONVERT(CHAR,@FROMDATE)) BETWEEN SDTCUR AND LDTCUR
                                                                      
CREATE TABLE [dbo].[#MINILEDGER_DETAIL] (
	[MLD_VTYP] [smallint] NOT NULL ,
	[MLD_BOOKTYPE] [char] (2) NOT NULL ,
	[MLD_LNO] [decimal](5, 0) NOT NULL ,
	[MLD_VNO] [varchar] (12) NOT NULL ,
	[MLD_EDT] [datetime] NOT NULL ,
	[MLD_VDT] [datetime] NOT NULL ,
	[MLD_SHORTDESC] [char] (35) NOT NULL ,
	[MLD_DRAMT] [money] NOT NULL ,
	[MLD_CRAMT] [money] NOT NULL ,
	[MLD_DDNO] [varchar] (20) NULL ,
	[MLD_NARRATION] [varchar] (300) NULL ,
	[MLD_CLTCODE] [varchar] (10) NOT NULL ,
	[MLD_OPBAL] [money] NOT NULL ,
	[MLD_CROSAC] [varchar] (10) NULL ,
	[MLD_EDIFF] [int] NULL ,
	[MLD_LEDGER] [int] NULL ,
	[MLD_OPBALFLAG] [int] NOT NULL,
	[MLD_ENTEREDBY] [VARCHAR](100) NOT NULL 
) ON [PRIMARY]

CREATE TABLE [dbo].[#MINILEDGER_MASTER] (
	[MLM_ACCAT] [char] (10) NOT NULL ,
	[MLM_CLTCODE] [varchar] (10) NOT NULL ,
	[MLM_BRANCH_CD] [varchar] (10) NOT NULL ,
	[MLM_ACNAME] [varchar] (100) NOT NULL 
) ON [PRIMARY]

CREATE TABLE [dbo].[#MARGINLEDGER_TMP] (
	[VTYP] [smallint] NOT NULL ,
	[BOOKTYPE] [char] (2) NOT NULL ,
	[LNO] [decimal](5, 0) NOT NULL ,
	[VNO] [varchar] (12) NOT NULL ,
	[EDT] [datetime] NOT NULL ,
	[VDT] [datetime] NOT NULL ,
	[VAMT] [money] NOT NULL ,
	[NARRATION] [varchar] (300) NULL ,
	[CLTCODE] [varchar] (10) NOT NULL ,
	[DRCR] [varchar] (1) NOT NULL,
	[ENTEREDBY] [VARCHAR](100)
) ON [PRIMARY]
  
CREATE TABLE [dbo].[#OPPBALANCE_TMP] (
	[CLTCODE] [varchar] (10) NOT NULL ,
	[OPPBAL] [money] NOT NULL ,
	[DRCR] [varchar] (1) NOT NULL 
) ON [PRIMARY]
  
CREATE TABLE [dbo].[#VMAST_TMP] (
	[VTYPE] [smallint] NOT NULL 
) ON [PRIMARY]

CREATE TABLE [dbo].[#CLIENT] (
  [ENT_CODE]    [VARCHAR](25) NOT NULL,
  [ENT_NAME]    [VARCHAR](100) NOT NULL,
  [PARTY_CODE]  [VARCHAR](10) NOT NULL,
  [PARENTCODE]  [VARCHAR](10) NOT NULL,
  [AREA]        [VARCHAR](20) NOT NULL,
  [REGION]      [VARCHAR](20) NOT NULL,
  [BRANCH_CD]   [VARCHAR](10) NOT NULL,
  [SUB_BROKER]  [VARCHAR](10) NOT NULL,
  [TRADER]      [VARCHAR](20) NOT NULL,
  [FAMILY]      [VARCHAR](10) NOT NULL,
  [CL_TYPE]     [VARCHAR](10) NOT NULL,
  [CL_STATUS]   [VARCHAR](10) NOT NULL,
  [RELMGR]      [VARCHAR](10) NOT NULL,
  [SBU]         [VARCHAR](10) NOT NULL,
  [GROUPCODE]   [VARCHAR](10) NOT NULL 
) ON [PRIMARY]

  INSERT INTO #CLIENT 
  SELECT * 
  FROM   .dbo.CBO_FN_GETCODELIST(
                           @STATUSID,
                           @STATUSNAME,
                           @FROMCODE,
                           @TOCODE,
                           @SEARCHWHAT)
  WHERE ENT_CODE LIKE @SEARCHCODE
  
  IF @FLDAUTOFROM <> 0
    BEGIN
      SELECT @OPENDATE = LEFT(SDTCUR,11)
      FROM   PARAMETER WITH (NOLOCK)
      WHERE  FLDAUTO = @FLDAUTOFROM
    END
  ELSE
    BEGIN
    PRINT @FLDAUTO
      SELECT @OPENDATE = LEFT(SDTCUR,11)
      FROM   PARAMETER WITH (NOLOCK)
      WHERE  FLDAUTO = @FLDAUTO
                       
      SELECT @FROMDATE = @OPENDATE
    END
    
  ---------------------------------------------
  --SETTLEMENT LEDGER OPENING BALANCE
  ---------------------------------------------
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE = C.ENT_CODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     LEDGER L WITH (NOLOCK), 
           #CLIENT C
  WHERE    EDT LIKE @OPENDATE + '%' 
           AND VTYP = 18
           AND L.CLTCODE = C.PARTY_CODE 
  GROUP BY C.ENT_CODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE = C.ENT_CODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     LEDGER L WITH (NOLOCK), 
           #CLIENT C
  WHERE    EDT >= @OPENDATE
           AND EDT < @FROMDATE
           AND VTYP <> 18
           AND L.CLTCODE = C.PARTY_CODE 
  GROUP BY C.ENT_CODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE = C.ENT_CODE,
           OPPBAL = ISNULL(SUM(VAMT),0),
           DRCR = (CASE 
                     WHEN DRCR = 'C' THEN 'D'
                     ELSE 'C'
                   END)
  FROM     LEDGER L WITH (NOLOCK), 
           #CLIENT C
  WHERE    EDT >= @OPENDATE
           AND VDT < @OPENDATE
           AND L.CLTCODE = C.PARTY_CODE 
  GROUP BY C.ENT_CODE,DRCR
           
  INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN OPPBAL
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN 0
                    ELSE ABS(OPPBAL)
                  END),
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(@FROMDATE)),
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   (SELECT   CLTCODE,
                   OPPBAL = SUM(CASE 
                                  WHEN DRCR = 'D' THEN OPPBAL
                                  ELSE -OPPBAL
                                END)
          FROM     #OPPBALANCE_TMP
          GROUP BY CLTCODE) L
         
  ---------------------------------------------
  --MARGIN LEDGER OPENING BALANCE
  ---------------------------------------------
  
  TRUNCATE TABLE #OPPBALANCE_TMP
  
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     #MARGINLEDGER_TMP WITH (NOLOCK)
  WHERE    EDT LIKE @OPENDATE + '%' 
           AND VTYP = 18
  GROUP BY CLTCODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE,
           OPBAL = ISNULL(SUM(VAMT),0),
           DRCR
  FROM     #MARGINLEDGER_TMP WITH (NOLOCK)
  WHERE    EDT >= @OPENDATE
           AND EDT < @FROMDATE
           AND VTYP <> 18
  GROUP BY CLTCODE,DRCR
           
  INSERT INTO #OPPBALANCE_TMP
  SELECT   CLTCODE,
           OPPBAL = ISNULL(SUM(VAMT),0),
           DRCR = (CASE 
                     WHEN DRCR = 'C' THEN 'D'
                     ELSE 'C'
                   END)
  FROM     #MARGINLEDGER_TMP WITH (NOLOCK)
  WHERE    EDT >= @OPENDATE
           AND VDT < @OPENDATE
  GROUP BY CLTCODE,DRCR
           
  INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN OPPBAL
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN OPPBAL >= 0 THEN 0
                    ELSE ABS(OPPBAL)
                  END),
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(@FROMDATE)),
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   (SELECT   CLTCODE,
                   OPPBAL = SUM(CASE 
                                  WHEN DRCR = 'D' THEN OPPBAL
                                  ELSE -OPPBAL
                                END)
          FROM     #OPPBALANCE_TMP
          GROUP BY CLTCODE) L
         
  ---------------------------------------------
  --SETTLEMENT LEDGER ENTRIES
  ---------------------------------------------
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         LNO=ACTNODAYS,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         NARRATION = L.NARRATION,
         CLTCODE = C.ENT_CODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 1,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   LEDGER L WITH (NOLOCK),
         VMAST V WITH (NOLOCK),
         #CLIENT C 
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18 
         AND L.CLTCODE = C.PARTY_CODE
  ORDER BY 6, 12, 1, 2, 4, 3
  --ORDER BY L.VDT, L.CLTCODE, L.VTYP, L.BOOKTYPE, L.VNO, L.DRCR, L.LNO 
                        
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         LNO=ACTNODAYS,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         NARRATION = L.NARRATION,
         CLTCODE = C.ENT_CODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 2,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   LEDGER L WITH (NOLOCK),
         VMAST V WITH (NOLOCK), 
         #CLIENT C 
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT > @TODATE + ' 23:59:59' 
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18 
         AND L.CLTCODE = C.PARTY_CODE 
  ORDER BY 6, 12, 1, 2, 4, 3
  --ORDER BY VDT, CLTCODE, VTYP, BOOKTYPE, LNO, VNO, DRCR 
                        
  ---------------------------------------------
  --MARGIN LEDGER ENTRIES
  ---------------------------------------------
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         L.LNO,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         L.NARRATION,
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 1,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   #MARGINLEDGER_TMP L WITH (NOLOCK),
         VMAST V WITH (NOLOCK)
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18
                        
  INSERT INTO #MINILEDGER_DETAIL
  SELECT L.VTYP,
         L.BOOKTYPE,
         L.LNO,
         L.VNO,
         L.EDT,
         L.VDT,
         V.SHORTDESC,
         DRAMT = (CASE 
                    WHEN DRCR = 'D' THEN VAMT
                    ELSE 0
                  END),
         CRAMT = (CASE 
                    WHEN DRCR = 'D' THEN 0
                    ELSE VAMT
                  END),
         DDNO = '',
         L.NARRATION,
         CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 2,
		 MLD_ENTEREDBY = ENTEREDBY
  FROM   #MARGINLEDGER_TMP L WITH (NOLOCK),
         VMAST V WITH (NOLOCK)
  WHERE  L.VTYP = V.VTYPE
         AND L.EDT > @TODATE + ' 23:59:59'
         AND L.VDT <= @TODATE + ' 23:59:59'
         AND V.VTYPE <> 18
                        
  ---------------------------------------------------------------
  --UPDATE CROSS ACCOUNT AND CHEQUE NUMBER
  ---------------------------------------------------------------
  INSERT INTO #VMAST_TMP
  SELECT VTYPE
  FROM   VMAST
  WHERE  VTYPE IN ('1','2','3','4',
                   '5','16','17','19',
                   '20','22','23')

  UPDATE A
  SET    A.MLD_CROSAC = B.CLTCODE
  FROM   #MINILEDGER_DETAIL A,
         LEDGER B
  WHERE  B.CLTCODE <> A.MLD_CLTCODE
         AND A.MLD_BOOKTYPE = B.BOOKTYPE
         AND A.MLD_VNO = B.VNO
         AND A.MLD_VTYP = B.VTYP
         AND EXISTS (SELECT VTYPE
                     FROM   #VMAST_TMP V
                     WHERE  V.VTYPE = A.MLD_VTYP)
         AND (B.VAMT = A.MLD_CRAMT + A.MLD_DRAMT)
             
  UPDATE A
  SET    A.MLD_DDNO = ISNULL(B.DDNO,'')
  FROM   #MINILEDGER_DETAIL A,
         LEDGER1 B WITH (NOLOCK)
  WHERE  A.MLD_BOOKTYPE = B.BOOKTYPE
         AND A.MLD_VNO = B.VNO
         AND A.MLD_VTYP = B.VTYP
         AND EXISTS (SELECT VTYPE
                     FROM   #VMAST_TMP V
                     WHERE  V.VTYPE = A.MLD_VTYP)
                    
  ---------------------------------------------------------------
  --POPULATE MINI LEDGER MASTER RECORDS 
  ---------------------------------------------------------------
  INSERT INTO #MINILEDGER_MASTER
  SELECT   ACCAT,
           CLTCODE,
           BRANCHCODE,
           ACNAME
  FROM     ACMAST A WITH (NOLOCK)
  WHERE    EXISTS (SELECT DISTINCT CLTCODE
                   FROM   #MINILEDGER_DETAIL V
                  WHERE  A.CLTCODE = V.MLD_CLTCODE)
  ORDER BY 1,
           2

  INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = 0,
         CRAMT = 0,
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(CONVERT(CHAR,@FROMDATE))),
         MLM_CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 1,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   #MINILEDGER_MASTER 
  WHERE  NOT EXISTS (SELECT DISTINCT MLD_CLTCODE
                     FROM   #MINILEDGER_DETAIL 
                     WHERE  MLM_CLTCODE = MLD_CLTCODE
                            AND MLD_LEDGER = 1
                            AND MLD_OPBALFLAG = 0) 
 
 INSERT INTO #MINILEDGER_DETAIL
  SELECT VTYP = 18,
         BOOKTYPE = '01',
         LNO = 1,
         VNO = 'OPENING BAL',
         EDT = @FROMDATE,
         VDT = @FROMDATE,
         SHORTDESC = 'OPENEN',
         DRAMT = 0,
         CRAMT = 0,
         DDNO = '',
         NARRATION = 'OPENING BALANCE AS ON ' + LTRIM(RTRIM(CONVERT(CHAR,@FROMDATE))),
         MLM_CLTCODE,
         OPBAL = 0,
         CROSAC = '',
         EDIFF = 0,
         LEDGER = 2,
         OPBALFLAG = 0,
		 MLD_ENTEREDBY = ''
  FROM   #MINILEDGER_MASTER 
  WHERE  NOT EXISTS (SELECT DISTINCT MLD_CLTCODE
                     FROM   #MINILEDGER_DETAIL 
                     WHERE  MLM_CLTCODE = MLD_CLTCODE
                            AND MLD_LEDGER = 2
                            AND MLD_OPBALFLAG = 0) 

  SELECT D.*, 
         @EXCHANGE, 
         @SEGMENT, 
         C.ENT_NAME 
  FROM   #MINILEDGER_DETAIL D, 
         (SELECT DISTINCT ENT_CODE, ENT_NAME FROM #CLIENT) C 
  WHERE  C.ENT_CODE = D.MLD_CLTCODE
  ORDER BY 12, 16, 17, 6, 5, 8 DESC, 9

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_SHOWLEDGERBALANCE
-- --------------------------------------------------

    
CREATE PROCEDURE [dbo].[CBO_SHOWLEDGERBALANCE](    
                @STATUSID   VARCHAR(25),    
                @STATUSNAME VARCHAR(25),    
                @EXCHANGE   VARCHAR(25),    
                @SEGMENT    VARCHAR(25),    
                @SEGMENTDB  VARCHAR(25),    
                @FROMCODE   VARCHAR(25),    
                @TOCODE     VARCHAR(25),    
                @DATEFROM   VARCHAR(11),    
                @DATETO     VARCHAR(11),    
                @SEARCHWHAT VARCHAR(20) = 'CLIENT',
				@RPT_TYPE VARCHAR(20) = 'SUMMARY')    
    
AS    
    
    -- exec CBO_SHOWLEDGERBALANCE 'broker', 'broker', 'mtf', 'mtf', 'mtftrade', 'dcr101', 'dcr101', 'jul  1 2017', 'jul 31 2017'
/*==============================================================================================================      
        EXEC CBO_SHOWLEDGERBALANCE @NOOFDAYS 10    
==============================================================================================================*/    
    
  SET NOCOUNT ON    
    
  CREATE TABLE [DBO].[#SEGMENT] (    
   [EXCHANGE]  [VARCHAR] (25) NOT NULL ,    
   [SEGMENT]   [VARCHAR] (25) NOT NULL ,    
   [SEGMENTDB] [VARCHAR] (25) NOT NULL ,    
  ) ON [PRIMARY]    
    
  IF @SEGMENTDB <> 'ALL'     
       INSERT INTO #SEGMENT     
       SELECT @EXCHANGE,     
              @SEGMENT,     
              @SEGMENTDB    
    
  IF @SEGMENTDB = 'ALL'     
     AND @SEGMENT = 'EQUITIES'     
     AND @EXCHANGE = 'ALL'     
       INSERT INTO #SEGMENT    
       SELECT EXCHANGE,     
              SEGMENT,     
              ACCOUNTDB     
       FROM   MULTICOMPANY     
       WHERE  EXCHANGE IN ('NSE','BSE')     
    
  IF @SEGMENTDB = 'ALL'     
     AND @SEGMENT IN ('CAPITAL','FUTURES')      
     AND @EXCHANGE = 'ALL'     
       INSERT INTO #SEGMENT    
       SELECT EXCHANGE,     
              SEGMENT,     
              ACCOUNTDB     
       FROM   MULTICOMPANY     
       WHERE  EXCHANGE IN ('NSE','BSE')    
              AND SEGMENT = @SEGMENT     
     
  IF @SEGMENTDB = 'ALL'     
     AND @SEGMENT = 'EQUITIES'     
     AND @EXCHANGE IN ('NSE','BSE')     
       INSERT INTO #SEGMENT    
       SELECT EXCHANGE,     
              SEGMENT,     
              ACCOUNTDB     
       FROM   MULTICOMPANY     
       WHERE  EXCHANGE = @EXCHANGE    
    
  CREATE TABLE [DBO].[#BALANCE] (    
   [ENT_CODE] [VARCHAR] (25) NOT NULL ,    
   [ENT_NAME] [VARCHAR] (100) NOT NULL ,    
   [LEDBAL]   [MONEY] NOT NULL ,    
   [MARBAL]   [MONEY] NOT NULL ,    
   [UCLBAL]   [MONEY] NOT NULL ,     
   [EXCHANGE] [VARCHAR] (25) NOT NULL ,    
   [SEGMENT]  [VARCHAR] (25) NOT NULL     
  ) ON [PRIMARY]    
    
  DECLARE  @@ACCCUR       AS CURSOR,    
           @@ACCOUNTDB   VARCHAR(25),    
           @@EXCHANGE    VARCHAR(25),    
           @@SEGMENT     VARCHAR(25),    
           @@SQL         VARCHAR(5000)    
      
  SET @@ACCCUR = CURSOR FOR SELECT  SEGMENTDB,     
                                    EXCHANGE,     
                                    SEGMENT      
                            FROM    #SEGMENT      
    
  OPEN @@ACCCUR    
      
  FETCH NEXT FROM @@ACCCUR    
  INTO @@ACCOUNTDB,    
       @@EXCHANGE,     
       @@SEGMENT            
  WHILE @@FETCH_STATUS = 0    
    BEGIN    
      SELECT @@SQL = ' '    
      SELECT @@SQL = @@SQL + 'INSERT INTO #BALANCE '    
      SELECT @@SQL = @@SQL + 'EXECUTE ' + @@ACCOUNTDB + '.DBO.CBO_GETLEDGERBALANCE '     
      SELECT @@SQL = @@SQL + '@STATUSID   = ''' + @STATUSID + ''', '    
      SELECT @@SQL = @@SQL + '@STATUSNAME = ''' + @STATUSNAME + ''', '    
      SELECT @@SQL = @@SQL + '@EXCHANGE   = ''' + @@EXCHANGE + ''', '    
      SELECT @@SQL = @@SQL + '@SEGMENT    = ''' + @@SEGMENT + ''', '    
      SELECT @@SQL = @@SQL + '@FROMCODE   = ''' + @FROMCODE + ''', '    
      SELECT @@SQL = @@SQL + '@TOCODE     = ''' + @TOCODE + ''', '    
      SELECT @@SQL = @@SQL + '@DATEFROM   = ''' + @DATEFROM + ''', '    
      SELECT @@SQL = @@SQL + '@DATETO     = ''' + @DATETO + ''', '    
      SELECT @@SQL = @@SQL + '@SEARCHWHAT = ''' + @SEARCHWHAT + ''' '    
          
        
print @@SQL    
EXEC( @@SQL)  
      FETCH NEXT FROM @@ACCCUR    
      INTO @@ACCOUNTDB,    
           @@EXCHANGE,     
           @@SEGMENT            
    END    
      
  CLOSE @@ACCCUR    
  DEALLOCATE @@ACCCUR              
    
  SELECT   ENT_CODE,     
           ENT_NAME,     
           LEDBAL = SUM(LEDBAL),     
           MARBAL = SUM(MARBAL),     
           UCLBAL = SUM(UCLBAL),     
    CLRBAL = SUM((LEDBAL + MARBAL) - UCLBAL)     
  FROM     #BALANCE     
  GROUP BY ENT_CODE,ENT_NAME     
  ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_SHOWLEDGERDETAILS
-- --------------------------------------------------



    
    
CREATE PROCEDURE [dbo].[CBO_SHOWLEDGERDETAILS](      
                @STATUSID   VARCHAR(25),      
                @STATUSNAME VARCHAR(25),      
                @EXCHANGE   VARCHAR(25),      
                @SEGMENT    VARCHAR(25),      
                @SEGMENTDB  VARCHAR(25),      
                @FROMCODE   VARCHAR(25),      
                @TOCODE     VARCHAR(25),      
                @DATEFROM   VARCHAR(11),      
                @DATETO     VARCHAR(11),      
                @SEARCHCODE VARCHAR(25),      
                @SEARCHWHAT VARCHAR(20) = 'CLIENT',    
    @RPT_TYPE VARCHAR(20) = 'SUMMARY')      
      
AS      
      
/*==============================================================================================================        
        EXEC CBO_SHOWLEDGERDETAILS @NOOFDAYS 10      
==============================================================================================================*/      
      
  SET NOCOUNT ON      
      
  CREATE TABLE [DBO].[#SEGMENT] (      
   [EXCHANGE]  [VARCHAR] (25) NOT NULL ,      
   [SEGMENT]   [VARCHAR] (25) NOT NULL ,      
   [SEGMENTDB] [VARCHAR] (25) NOT NULL ,      
  ) ON [PRIMARY]      
      
  IF @SEGMENTDB <> 'ALL'       
       INSERT INTO #SEGMENT       
       SELECT @EXCHANGE,       
              @SEGMENT,       
              @SEGMENTDB      
      
  IF @SEGMENTDB = 'ALL'       
     AND @SEGMENT = 'EQUITIES'       
     AND @EXCHANGE = 'ALL'       
       INSERT INTO #SEGMENT      
       SELECT EXCHANGE,       
              SEGMENT,       
              ACCOUNTDB       
       FROM   MULTICOMPANY       
       WHERE  EXCHANGE IN ('NSE','BSE')       
      
  IF @SEGMENTDB = 'ALL'       
     AND @SEGMENT IN ('CAPITAL','FUTURES')        
     AND @EXCHANGE = 'ALL'       
       INSERT INTO #SEGMENT      
       SELECT EXCHANGE,       
              SEGMENT,       
              ACCOUNTDB       
       FROM   MULTICOMPANY       
       WHERE  EXCHANGE IN ('NSE','BSE')      
              AND SEGMENT = @SEGMENT       
       
  IF @SEGMENTDB = 'ALL'       
     AND @SEGMENT = 'EQUITIES'       
     AND @EXCHANGE IN ('NSE','BSE')       
       INSERT INTO #SEGMENT      
       SELECT EXCHANGE,       
              SEGMENT,       
              ACCOUNTDB       
       FROM   MULTICOMPANY       
       WHERE  EXCHANGE = @EXCHANGE      
      
CREATE TABLE [dbo].[#MINILEDGER_DETAIL] (      
 [MLD_SNO] [int] IDENTITY (1, 1) NOT NULL ,      
 [MLD_VTYP] [smallint] NOT NULL ,      
 [MLD_BOOKTYPE] [char] (2) NOT NULL ,      
 [MLD_LNO] [decimal](5, 0) NOT NULL ,      
 [MLD_VNO] [varchar] (12) NOT NULL ,      
 [MLD_EDT] [datetime] NOT NULL ,      
 [MLD_VDT] [datetime] NOT NULL ,      
 [MLD_SHORTDESC] [char] (35) NOT NULL ,      
 [MLD_DRAMT] [money] NOT NULL ,      
 [MLD_CRAMT] [money] NOT NULL ,      
 [MLD_DDNO] [varchar] (20) NULL ,      
 [MLD_NARRATION] [varchar] (300) NULL ,      
 [MLD_CLTCODE] [varchar] (10) NOT NULL ,      
 [MLD_OPBAL] [money] NOT NULL ,      
 [MLD_CROSAC] [varchar] (10) NULL ,      
 [MLD_EDIFF] [int] NULL ,      
 [MLD_LEDGER] [int] NULL ,      
 [MLD_OPBALFLAG] [int] NOT NULL ,       
 [ENTEREDBY]  [varchar] (100) NULL,    
 [EXCHANGE] [varchar] (25) NULL ,      
 [SEGMENT] [varchar] (25) NULL ,       
 [ENT_NAME] [varchar] (100) NULL    
) ON [PRIMARY]      
      
  DECLARE  @@ACCCUR       AS CURSOR,      
           @@ACCOUNTDB   VARCHAR(25),      
           @@EXCHANGE    VARCHAR(25),      
           @@SEGMENT     VARCHAR(25),      
           @@SQL         VARCHAR(5000)      
        
  SET @@ACCCUR = CURSOR FOR SELECT  SEGMENTDB,       
                                    EXCHANGE,       
                                    SEGMENT        
                            FROM    #SEGMENT        
      
  OPEN @@ACCCUR      
        
  FETCH NEXT FROM @@ACCCUR      
  INTO @@ACCOUNTDB,      
       @@EXCHANGE,       
       @@SEGMENT              
  WHILE @@FETCH_STATUS = 0      
    BEGIN      
      SELECT @@SQL = ' '      
     SELECT @@SQL = @@SQL + 'INSERT INTO #MINILEDGER_DETAIL '      
      SELECT @@SQL = @@SQL + 'EXECUTE ' + @@ACCOUNTDB + '.DBO.CBO_GETLEDGERDETAILS '       
      SELECT @@SQL = @@SQL + '@STATUSID   = ''' + @STATUSID + ''', '      
      SELECT @@SQL = @@SQL + '@STATUSNAME = ''' + @STATUSNAME + ''', '      
      SELECT @@SQL = @@SQL + '@EXCHANGE   = ''' + @@EXCHANGE + ''', '      
      SELECT @@SQL = @@SQL + '@SEGMENT    = ''' + @@SEGMENT + ''', '      
      SELECT @@SQL = @@SQL + '@FROMCODE   = ''' + @FROMCODE + ''', '      
      SELECT @@SQL = @@SQL + '@TOCODE     = ''' + @TOCODE + ''', '      
      SELECT @@SQL = @@SQL + '@FROMDATE   = ''' + @DATEFROM + ''', '      
      SELECT @@SQL = @@SQL + '@TODATE     = ''' + @DATETO + ''', '      
      SELECT @@SQL = @@SQL + '@SEARCHCODE = ''' + @SEARCHCODE + ''', '      
      SELECT @@SQL = @@SQL + '@SEARCHWHAT = ''' + @SEARCHWHAT + ''' '      
        PRINT @@SQL    
      EXEC( @@SQL)      
     
      
      FETCH NEXT FROM @@ACCCUR      
      INTO @@ACCOUNTDB,      
           @@EXCHANGE,       
           @@SEGMENT              
    END      
        
  CLOSE @@ACCCUR      
  DEALLOCATE @@ACCCUR                

SELECT  MLD_SNO,MLD_EDT,MLD_VDT,MLD_SHORTDESC,MLD_DRAMT,MLD_CRAMT,    
 MLD_DDNO,MLD_NARRATION,MLD_CLTCODE,MLD_CROSAC,EXCHANGE,SEGMENT,MLD_OPBALFLAG,MLD_LNO       
 INTO #LEDGER    
 FROM            
 (      
  SELECT MLD_SNO, MLD_EDT, MLD_VDT, MLD_SHORTDESC, MLD_DRAMT, MLD_CRAMT, MLD_DDNO,     
   MLD_NARRATION,    
  MLD_CLTCODE,     
  MLD_CROSAC,    
  --MLD_CROSAC='',     
  EXCHANGE, SEGMENT, MLD_OPBALFLAG,MLD_LNO    
  FROM (    
  SELECT MLD_SNO = MIN(MLD_SNO),      
         MLD_EDT=LEFT(MLD_EDT,11),      
         MLD_VDT=LEFT(MLD_VDT,11),      
         MLD_SHORTDESC,      
         MLD_DRAMT = CASE       
                       WHEN SUM(MLD_DRAMT-MLD_CRAMT) > 0 THEN SUM(MLD_DRAMT-MLD_CRAMT)       
                       ELSE 0       
                     END,      
         MLD_CRAMT = CASE       
                       WHEN SUM(MLD_CRAMT-MLD_DRAMT) > 0 THEN SUM(MLD_CRAMT-MLD_DRAMT)       
                       ELSE 0       
                     END,      
         MLD_DDNO,      
         MLD_NARRATION=MLD_NARRATION,      
         MLD_CLTCODE,      
         MLD_CROSAC,      
         EXCHANGE=@EXCHANGE,      
         SEGMENT=@SEGMENT,      
         MLD_OPBALFLAG,MLD_LNO      
  FROM   #MINILEDGER_DETAIL       
  WHERE  MLD_OPBALFLAG = 0       
  GROUP BY MLD_EDT,MLD_VDT,MLD_SHORTDESC,MLD_DDNO,MLD_NARRATION,      
           MLD_CLTCODE,MLD_CROSAC,MLD_OPBALFLAG,MLD_LNO      
  UNION ALL      
  SELECT MLD_SNO = MIN(MLD_SNO),      
         MLD_EDT=LEFT(MLD_EDT,11),      
         MLD_VDT=LEFT(MLD_VDT,11),      
         MLD_SHORTDESC,      
         MLD_DRAMT = CASE       
                       WHEN SUM(MLD_DRAMT-MLD_CRAMT) > 0 THEN SUM(MLD_DRAMT-MLD_CRAMT)       
                       ELSE 0       
                     END,      
         MLD_CRAMT = CASE       
                       WHEN SUM(MLD_CRAMT-MLD_DRAMT) > 0 THEN SUM(MLD_CRAMT-MLD_DRAMT)       
                       ELSE 0       
                     END,      
         MLD_DDNO,      
         MLD_NARRATION,    
         MLD_CLTCODE,      
   MLD_CROSAC,    
         --MLD_CROSAC='',      
         EXCHANGE,      
         SEGMENT,      
         MLD_OPBALFLAG,MLD_LNO      
  FROM (    
  SELECT MLD_SNO = MIN(MLD_SNO),      
         MLD_EDT=LEFT(MLD_EDT,11),      
         MLD_VDT=LEFT(MLD_VDT,11),      
         MLD_SHORTDESC=(CASE WHEN @RPT_TYPE = 'DETAIL' THEN MLD_SHORTDESC   
        /*WHEN MLD_SHORTDESC = 'BIIL' AND SUM(MLD_DRAMT-MLD_CRAMT) > 0 THEN 'PAYBNK'    
          WHEN MLD_SHORTDESC = 'BIIL' AND SUM(MLD_DRAMT-MLD_CRAMT) < 0 THEN 'PAYBNK'    
          ELSE 'PAYBNK' END)*/    
          WHEN ENTEREDBY = 'ANIMESH' OR ENTEREDBY = 'SYSTEM' THEN 'LOAN' ELSE MLD_SHORTDESC END),      
         MLD_DRAMT = CASE       
                       WHEN SUM(MLD_DRAMT-MLD_CRAMT) > 0 THEN SUM(MLD_DRAMT-MLD_CRAMT)       
                       ELSE 0       
                     END,      
         MLD_CRAMT = CASE       
                       WHEN SUM(MLD_CRAMT-MLD_DRAMT) > 0 THEN SUM(MLD_CRAMT-MLD_DRAMT)       
                       ELSE 0       
                     END,      
         MLD_DDNO,      
         MLD_NARRATION=(CASE WHEN @RPT_TYPE = 'DETAIL' THEN MLD_NARRATION    
        WHEN ENTEREDBY = 'ANIMESH' OR ENTEREDBY = 'SYSTEM' THEN 'LOAN' ELSE MLD_NARRATION END),    
         MLD_CLTCODE,     
   MLD_CROSAC,     
         --MLD_CROSAC='',      
         EXCHANGE,      
         SEGMENT,      
         MLD_OPBALFLAG,  
   VNO = (CASE WHEN @RPT_TYPE = 'DETAIL' THEN MLD_VNO    
        WHEN ENTEREDBY = 'ANIMESH' OR ENTEREDBY = 'SYSTEM' THEN '' ELSE MLD_VNO END),MLD_LNO      
  FROM   #MINILEDGER_DETAIL       
  WHERE  MLD_OPBALFLAG <> 0       
  GROUP BY MLD_EDT,MLD_VDT,MLD_SHORTDESC,MLD_DDNO,MLD_BOOKTYPE,ENTEREDBY,(CASE WHEN @RPT_TYPE = 'DETAIL' THEN MLD_VNO    
        WHEN ENTEREDBY = 'ANIMESH' OR ENTEREDBY = 'SYSTEM' THEN '' ELSE MLD_VNO END),    
 (CASE WHEN @RPT_TYPE = 'DETAIL' THEN MLD_NARRATION    
        WHEN ENTEREDBY = 'ANIMESH' OR ENTEREDBY = 'SYSTEM' THEN 'LOAN' ELSE MLD_NARRATION END),    
           MLD_CLTCODE,MLD_CROSAC,EXCHANGE,SEGMENT,MLD_OPBALFLAG,MLD_LNO) B     
 GROUP BY MLD_EDT,MLD_VDT,MLD_SHORTDESC,MLD_NARRATION,MLD_CLTCODE,MLD_DDNO,MLD_CROSAC,EXCHANGE,SEGMENT,MLD_OPBALFLAG,VNO,MLD_LNO    
 HAVING SUM(MLD_CRAMT-MLD_DRAMT) <> 0    
  ) A     
) P    
     
SELECT MLD_SNO,MLD_EDT,MLD_VDT,MLD_SHORTDESC,MLD_DRAMT,MLD_CRAMT,    
MLD_DDNO=(CASE WHEN MLD_DDNO='100214' THEN '' ELSE MLD_DDNO END),    
MLD_NARRATION=UPPER(MLD_NARRATION),MLD_CLTCODE,MLD_CROSAC,EXCHANGE,SEGMENT,
MLD_OPBALFLAG,LONG_NAME,L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, 
L_CITY, L_STATE, L_ZIP,L_NATION,RES_PHONE1,RES_PHONE2,OFF_PHONE1,    
OFF_PHONE2,EMAIL    
FROM   #LEDGER B,MSAJAG.DBO.CLIENT1 C1    
WHERE C1.CL_CODE = B.MLD_CLTCODE    
AND EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN C
			WHERE MLD_CLTCODE = PARTY_CODE AND TO_DATE >=  @DATEFROM )
ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS
-- --------------------------------------------------


--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS]--- take backup --done
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM ANAND1.ACCOUNT.dbo.CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
  
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(40),           
	L_ADDRESS2  VARCHAR(40),           
	L_ADDRESS3 VARCHAR(40),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)




--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C1.CL_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK)/*,           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE */
      WHERE C1.CL_CODE BETWEEN @FCODE AND @TCODE AND EXISTS(SELECT CLTCODE FROM FORMULA_CLIENT_MASTER_PARENT C WHERE C1.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT LIKE @FDATE + '%'
                        AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18) B
						INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
				  --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                  GROUP BY CLTCODE

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT > = @@OPENDATE + ' 00:00:00'  AND VDT < @FDATE          
                        AND CLTCODE BETWEEN @FCODE AND @TCODE ) B                          
						INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
				  --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                  
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK)  WHERE EDT LIKE @@OPENDATE + '%'           
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18)   B   
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                                
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE VDT < @@OPENDATE          
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND EDT >= @@OPENDATE) B
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                               
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
							FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE EDT LIKE @@OPENDATE + '%'           
                                    AND CLTCODE BETWEEN @FCODE AND @TCODE AND VTYP = 18) B     
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE     
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                              
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM (SELECT * FROM LEDGER WITH(NOLOCK) WHERE EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE
									AND CLTCODE BETWEEN @FCODE AND @TCODE          
                                    AND VTYP <> 18) B  
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE         
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                        
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM (SELECT * FROM LEDGER B WITH(NOLOCK) WHERE VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE AND CLTCODE BETWEEN @FCODE AND @TCODE  ) B 
									INNER JOIN #LEDGERCLIENTS L ON PARTY_CODE = CLTCODE         
                              --WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                            
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK) inner join           
                  VMAST V WITH(NOLOCK)   on L.VTYP = V.VTYPE
				  inner join #LEDGERCLIENTS on PARTY_CODE = CLTCODE        
            WHERE VDT between @FDATE + ' 00:00:00' 
				  AND @TDATE +' 23:59:59' 
				  --AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                             
				  --AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK) inner join           
                  VMAST V WITH(NOLOCK)   on L.VTYP = V.VTYPE
				  inner join #LEDGERCLIENTS on PARTY_CODE = CLTCODE        
            WHERE EDT between @FDATE + ' 00:00:00' 
				  AND @TDATE +' 23:59:59'   
				--  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)        
                  --AND L.VTYP = V.VTYPE           
                  --AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                           
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       [EMAIL] VARCHAR(500),
       [MOBILE_PAGER] VARCHAR(50)
       ,PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			EMAIL,
			MOBILE_PAGER
			,C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          
                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
         --select * from #TMPLEDGER 
         
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM LEDGER B WITH(NOLOCK),           
            (SELECT CLTCODE FROM ACMAST WITH(NOLOCK) WHERE ACCAT = 2) V            
      WHERE B.CLTCODE = V.CLTCODE           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS_CASH_COLL
-- --------------------------------------------------



--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS_CASH_COLL]
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM Account..CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
--  print 'CLS_Piece  ' + @STRORDER
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(100),           
	L_ADDRESS2  VARCHAR(100),           
	L_ADDRESS3 VARCHAR(100),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)


--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE 
      --AND EXISTS(SELECT CLTCODE FROM account..FORMULA_CLIENT_MASTER_PARENT C WHERE C2.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	  AND C1.Cl_Code BETWEEN @FCODE AND @TCODE
	  
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM MTF_CASH_COLL_LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_COLL_LEDGER B WITH(NOLOCK)           
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT LIKE @FDATE + '%'           
                        AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_COLL_LEDGER B WITH(NOLOCK)                         
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_COLL_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_COLL_LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM MTF_CASH_COLL_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM MTF_CASH_COLL_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_COLL_LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM MTF_CASH_COLL_LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_COLL_LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)           
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_COLL_LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'  
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (100)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (100)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (100)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       --[EMAIL] VARCHAR(500),
       --[MOBILE_PAGER] VARCHAR(50)
       PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			--EMAIL,
			--MOBILE_PAGER
			C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          

                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM MTF_CASH_COLL_LEDGER B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS_CASH_PAYIN
-- --------------------------------------------------



--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS_CASH_PAYIN]
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM Account..CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
--  print 'CLS_Piece  ' + @STRORDER
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(100),           
	L_ADDRESS2  VARCHAR(100),           
	L_ADDRESS3 VARCHAR(100),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)


--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE 
      --AND EXISTS(SELECT CLTCODE FROM account..FORMULA_CLIENT_MASTER_PARENT C WHERE C2.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	 AND C1.Cl_Code BETWEEN @FCODE AND @TCODE
	  
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM MTF_CASH_PAYIN_LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_PAYIN_LEDGER B WITH(NOLOCK)           
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT LIKE @FDATE + '%'           
                        AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_PAYIN_LEDGER B WITH(NOLOCK)                         
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_PAYIN_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_PAYIN_LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM MTF_CASH_PAYIN_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM MTF_CASH_PAYIN_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_PAYIN_LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM MTF_CASH_PAYIN_LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_PAYIN_LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)           
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_PAYIN_LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'  
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (100)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (100)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (100)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       --[EMAIL] VARCHAR(500),
       --[MOBILE_PAGER] VARCHAR(50)
       PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			--EMAIL,
			--MOBILE_PAGER
			C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          
                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM MTF_CASH_PAYIN_LEDGER B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS_MTF_BILL
-- --------------------------------------------------



--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
create PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS_MTF_BILL]
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM Account..CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
--  print 'CLS_Piece  ' + @STRORDER
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(100),           
	L_ADDRESS2  VARCHAR(100),           
	L_ADDRESS3 VARCHAR(100),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)


--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE 
      --AND EXISTS(SELECT CLTCODE FROM account..FORMULA_CLIENT_MASTER_PARENT C WHERE C2.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	  AND C1.Cl_Code BETWEEN @FCODE AND @TCODE
	  
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM MTF_CASH_BILL WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_BILL B WITH(NOLOCK)           
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT LIKE @FDATE + '%'           
                        AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_BILL B WITH(NOLOCK)                         
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_BILL WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_BILL B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM MTF_CASH_BILL WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM MTF_CASH_BILL WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_BILL B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM MTF_CASH_BILL L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_BILL L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)           
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_BILL L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'  
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (100)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (100)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (100)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       --[EMAIL] VARCHAR(500),
       --[MOBILE_PAGER] VARCHAR(50)
       PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			--EMAIL,
			--MOBILE_PAGER
			C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          

                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM MTF_CASH_BILL B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS_MTF_JV
-- --------------------------------------------------



--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS_MTF_JV]
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM Account..CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
--  print 'CLS_Piece  ' + @STRORDER
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(100),           
	L_ADDRESS2  VARCHAR(100),           
	L_ADDRESS3 VARCHAR(100),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)


--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE 
      --AND EXISTS(SELECT CLTCODE FROM account..FORMULA_CLIENT_MASTER_PARENT C WHERE C2.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	  AND C1.Cl_Code BETWEEN @FCODE AND @TCODE
	  
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM MTF_CASH_JV WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_JV B WITH(NOLOCK)           
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT LIKE @FDATE + '%'           
                        AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_CASH_JV B WITH(NOLOCK)                         
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_JV WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_JV B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM MTF_CASH_JV WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM MTF_CASH_JV WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_CASH_JV B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM MTF_CASH_JV L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_JV L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)           
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_CASH_JV L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'  
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (100)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (100)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (100)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       --[EMAIL] VARCHAR(500),
       --[MOBILE_PAGER] VARCHAR(50)
       PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			--EMAIL,
			--MOBILE_PAGER
			C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          

                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM MTF_CASH_JV B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLEDGER_SEG_DETAILS_MTOM
-- --------------------------------------------------



--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [dbo].[CLS_CLIENTLEDGER_SEG_DETAILS_MTOM]
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @SESSIONID VARCHAR(500),
 @FORPDF VARCHAR(1) = 'N',
 @PARENTCHILD_FLAG CHAR(1) = 'C' --,
--- @DASHBOARD CHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6),
 @CHARGES_FLAG TINYINT  

SET @CHARGES_FLAG = 0 

SELECT @CHARGES_FLAG = ISNULL(PVALUE, 0) FROM Account..CLS_CLIENT_LEDGER_PARAMETERS WHERE SESSIONID = @SESSIONID AND PKEY = 'ddlCharges'
--  print 'CLS_Piece  ' + @STRORDER
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(100),           
	L_ADDRESS2  VARCHAR(100),           
	L_ADDRESS3 VARCHAR(100),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50),
	PAN VARCHAR(50)
)

CREATE CLUSTERED INDEX [clientacc] ON #LEDGERCLIENTS
(
	PARTY_CODE ASC
)


--CREATE TABLE #CL_LIST
--(
--	CLTCODE VARCHAR(10) NOT NULL
--)

--ALTER TABLE #CL_LIST
-- ADD PRIMARY KEY (CLTCODE)

--DECLARE
--	@@SQL VARCHAR(MAX),
--	@ENTITY_FIELD VARCHAR(20)
	

-- SELECT @ENTITY_FIELD =    
--  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
--  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
--  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
--  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
--  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
--  CASE WHEN @STATUSID = 'CLIENT' THEN 'C1.CL_CODE' ELSE 	 
--  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
-- END END END END END END  END  
 
 
-- DECLARE
--	@SHAREDB VARCHAR(25) 
	
--SELECT @SHAREDB = SHAREDB FROM OWNER	

--SET @@SQL = "INSERT INTO #CL_LIST "
--SET @@SQL = @@SQL + "SELECT C1.CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 C1, " + @SHAREDB + ".DBO.CLIENT2_VW C2 "
--SET @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.PARTY_CODE "
--IF @PARENTCHILD_FLAG = 'C'
--	SET @@SQL = @@SQL + "AND PARTY_CODE >= '" + @FCODE + "' AND PARTY_CODE <= '" + @TCODE + "'"
--ELSE
--	SET @@SQL = @@SQL + "AND ParentCode >= '" + @FCODE + "' AND ParentCode <= '" + @TCODE + "'"
--IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
--BEGIN 
-- SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
-- --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
--END  
--PRINT @@SQL
--EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME,          
            BANK_NAME ='',-- ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = '',--ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER,
			PAN_GIR_NO
			      
      FROM MSAJAG.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)           
      /*LEFT OUTER JOIN           
            MSAJAG.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )       */    
      WHERE C1.CL_CODE = C2.CL_CODE 
     -- AND EXISTS(SELECT CLTCODE FROM account..FORMULA_CLIENT_MASTER_PARENT C WHERE C2.CL_CODE = C.CLTCODE AND SESSION_ID = @SESSIONID ) 
	 AND C1.Cl_Code BETWEEN @FCODE AND @TCODE
	  
	  

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM MTF_MTM_LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_MTM_LEDGER B WITH(NOLOCK)           
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT LIKE @FDATE + '%'           
                        AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM MTF_MTM_LEDGER B WITH(NOLOCK)                         
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_MTM_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_MTM_LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM MTF_MTM_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM MTF_MTM_LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM MTF_MTM_LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM MTF_MTM_LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2  
			
			
		DECLARE
		@STARTOFMONTH DATETIME

		SELECT @STARTOFMONTH = DATEADD(MONTH, DATEDIFF(MONTH, 0, @TDATE), 0)                  
  
                     
		--PRINT '1230' + CONVERT(VARCHAR(20),@CHARGES_FLAG )
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_MTM_LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11'  THEN 2 ELSE 1 END	-- AND VDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)           
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM MTF_MTM_LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'  
				  AND 1 = CASE WHEN (@CHARGES_FLAG = 1 OR @CHARGES_FLAG = 0 OR @CHARGES_FLAG = 2) AND BOOKTYPE = '11' THEN 2 ELSE 1 END         -- AND EDT >= @STARTOFMONTH 
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
      END


	  --select * from #LEDGERDATA           
	  --return
	      
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (100)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (100)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (100)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       --[EMAIL] VARCHAR(500),
       --[MOBILE_PAGER] VARCHAR(50)
       PAN VARCHAR(50)

      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
			VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            LTRIM(RTRIM(C.PARTY_CODE)) CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			--EMAIL,
			--MOBILE_PAGER
			C.PAN
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )  
		--WHERE BOOKTYPE <> '11' 	
		where 1 = CASE WHEN VDT >= @STARTOFMONTH AND BOOKTYPE = '11' THEN 2 ELSE 1 END         
          
                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
				--select * from #TMPLEDGER       
				--return
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM MTF_MTM_LEDGER B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MSAJAG.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
            

		--IF @DASHBOARD = 'Y'
	 -- BEGIN
	 --   INSERT INTO #TEMPDASHBOARD
		--SELECT * FROM #TMPLEDGER

	 -- END
	 -- ELSE
	  BEGIN
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
					AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')   
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                  
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104') 
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')  
						AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)                   
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END    
END	              
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_ACC_LEDGER_FORMULA_BALANCES
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_GET_ACC_LEDGER_FORMULA_BALANCES] 
	@FR_DATE VARCHAR(11),-- FROM DATE OF THE PERIOD 
	@EFFDATE VARCHAR(11),-- DATE FOR WHICH THE BALANCE IS REQUIRED  
	@PROCESS_CODE VARCHAR(10),-- PROCESS CODE FROM THE FORMULA MASTER  
	@REPORT_FORMULA VARCHAR(MAX),-- IN CASE NOT TO SET THE FORMULA AND GET THE SPECIFIEC FIELDS
	@EXCHANGE VARCHAR(10) = '',-- EXCHANGE
	@SEGMENT VARCHAR(50) = '',-- SEGMENT
	@REPORT_COLUMN VARCHAR(1000) = '', 
	@REPORT_GROUPING VARCHAR(1000) = '',
	@TABLE_NAME  VARCHAR(1000) = '' 
	
AS
SELECT @REPORT_FORMULA = FORMULANAME
FROM FORMULA_MASTER
WHERE PROCESSCODE = @PROCESS_CODE


IF @EXCHANGE = ''
BEGIN
	SELECT @EXCHANGE = EXCHANGE
		,@SEGMENT = SEGMENT
	FROM pradnya.OWNER
END

DECLARE @START_DATE VARCHAR(11)

IF LEN(@FR_DATE) = 10
	SELECT @FR_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FR_DATE, 103), 109)

IF LEN(@EFFDATE) = 10
BEGIN
	SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)
END

SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)
FROM PARAMETER
WHERE @EFFDATE BETWEEN SDTCUR
		AND LDTCUR

DECLARE @MIN_BILL_DATE VARCHAR(11)
	,@MAX_BILL_DATE VARCHAR(11)

	DECLARE @servername varchar(20)='AngelNseCM.ACCOUNT.DBO'

SELECT @MIN_BILL_DATE = CONVERT(VARCHAR(11), MIN(VDT), 109)
	,@MAX_BILL_DATE = CONVERT(VARCHAR(11), MAX(VDT), 109)
FROM (
	SELECT TOP 2 *
	FROM BILLPOSTED
	WHERE VDT <= @EFFDATE
	ORDER BY VDT DESC
	) A

CREATE TABLE #REPORT_DATA (
	CLTCODE VARCHAR(10)
	,VDTBAL_OPBAL MONEY
	,EDTBAL_OPBAL MONEY
	,VDTBAL_DATES MONEY
	,EDTBAL_DATES MONEY
	,VDTBAL_DATES_CREDIT MONEY
	,VDTBAL_DATES_DEBIT MONEY
	,EDTBAL_DATES_CREDIT MONEY
	,EDTBAL_DATES_DEBIT MONEY
	,VDTBAL MONEY
	,EDTBAL MONEY
	,VDTBAL_RECEIPT MONEY
	,T_DAY_BILL MONEY
	,T1_DAY_BILL MONEY
	,VDTBAL_BILL_DR MONEY
	,VDTBAL_BILL_CR MONEY
	,VDTBAL_NONBILL MONEY
	,EDTBAL_RECEIPT MONEY
	,EDTBAL_BILL_DR MONEY
	,EDTBAL_BILL_CR MONEY
	,EDTBAL_NONBILL MONEY
	,FDT_RECEIPT MONEY
	,FDT_CREDIT_BILLS MONEY
	,FDT_DEBIT_BILLS MONEY
	,FDT_CR MONEY
	,FDT_DR MONEY
	,FDT_BAL MONEY
	,MARGIN_BAL MONEY
	)

DECLARE @@SQL VARCHAR(MAX)

SELECT L.* INTO #LEDGER
FROM LEDGER L(NOLOCK)
		,#FORMULA_CLIENT_MASTER A
	WHERE A.CLTCODE = L.CLTCODE --AND SESSION_ID = @SESSIONID
		AND (
			VDT >= @START_DATE
			OR EDT >= @START_DATE
			)
		AND VDT <= @EFFDATE + ' 23:59'
		AND CDT <= DATEADD(MI, -5, GETDATE() )

INSERT INTO #REPORT_DATA
SELECT CLTCODE
	,VDTBAL_OPBAL = SUM(VDTBAL_OPBAL)
	,EDTBAL_OPBAL = SUM(EDTBAL_OPBAL)
	,VDTBAL_DATES = SUM(VDTBAL_DATES)
	,EDTBAL_DATES = SUM(EDTBAL_DATES)
	,VDTBAL_DATES_CREDIT = SUM(VDTBAL_DATES_CREDIT)
	,VDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
	,EDTBAL_DATES_CREDIT = SUM(EDTBAL_DATES_CREDIT)
	,EDTBAL_DATES_DEBIT = SUM(EDTBAL_DATES_DEBIT)
	,VDTBAL = SUM(VDTBAL)
	,EDTBAL = SUM(EDTBAL)
	,VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT)
	,T_DAY_BILL = SUM(T_DAY_BILL)
	,T1_DAY_BILL = SUM(T1_DAY_BILL)
	,VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR)
	,VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR)
	,VDTBAL_NONBILL = SUM(VDTBAL_NONBILL)
	,EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT)
	,EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR)
	,EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR)
	,EDTBAL_NONBILL = SUM(EDTBAL_NONBILL)
	,FDT_RECEIPT = SUM(FDT_RECEIPT)
	,FDT_CREDIT_BILLS = SUM(FDT_CREDIT_BILLS)
	,FDT_DEBIT_BILLS = SUM(FDT_DEBIT_BILLS)
	,FDT_CR = SUM(FDT_CR)
	,FDT_DR = SUM(FDT_DR)
	,FDT_BAL = SUM(FDT_BAL)
	,MARGIN_BAL = 0
FROM (
	SELECT CLTCODE = L.CLTCODE
		,VDTBAL_OPBAL = CASE WHEN CHARINDEX('VDTBAL_OPBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN (VDT >= @START_DATE
				AND VDT < @FR_DATE) OR VTYP = 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_OPBAL = CASE WHEN CHARINDEX('EDTBAL_OPBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN (EDT >= @START_DATE
				AND EDT < @FR_DATE) OR VTYP = 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_DATES = CASE WHEN CHARINDEX('VDTBAL_DATES', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @FR_DATE AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_DATES = CASE WHEN CHARINDEX('EDTBAL_DATES', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @FR_DATE AND VTYP <> 18
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_DATES_CREDIT = CASE WHEN CHARINDEX('VDTBAL_DATES_CREDIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @FR_DATE AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_DATES_DEBIT = CASE WHEN CHARINDEX('VDTBAL_DATES_DEBIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @FR_DATE AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_DATES_CREDIT = CASE WHEN CHARINDEX('EDTBAL_DATES_CREDIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @FR_DATE 
				AND EDT <= @EFFDATE + ' 23:59' AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_DATES_DEBIT = CASE WHEN CHARINDEX('EDTBAL_DATES_DEBIT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @FR_DATE
				AND EDT <= @EFFDATE + ' 23:59' AND VTYP <> 18
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL = CASE WHEN CHARINDEX('VDTBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL = CASE WHEN CHARINDEX('EDTBAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_RECEIPT = CASE WHEN CHARINDEX('VDTBAL_RECEIPT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,T_DAY_BILL = CASE WHEN CHARINDEX('T_DAY_BILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT LIKE @MAX_BILL_DATE + '%'
				AND VTYP = 15
				THEN SUM(CASE 
							WHEN L.DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,T1_DAY_BILL = CASE WHEN CHARINDEX('T1_DAY_BILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT LIKE @MIN_BILL_DATE + '%'
				AND VTYP = 15
				THEN SUM(CASE 
							WHEN L.DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_BILL_DR = CASE WHEN CHARINDEX('VDTBAL_BILL_DR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_BILL_CR = CASE WHEN CHARINDEX('VDTBAL_BILL_CR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,VDTBAL_NONBILL = CASE WHEN CHARINDEX('VDTBAL_NONBILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN VDT >= @START_DATE
				AND VTYP NOT IN (
					15
					,2
					)
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_RECEIPT = CASE WHEN CHARINDEX('EDTBAL_RECEIPT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 2
				THEN SUM(- VAMT)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_BILL_DR = CASE WHEN CHARINDEX('EDTBAL_BILL_DR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(- VAMT)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_BILL_CR = CASE WHEN CHARINDEX('EDTBAL_BILL_CR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(- VAMT)
			ELSE 0
			END ELSE 0 END
		,EDTBAL_NONBILL = CASE WHEN CHARINDEX('EDTBAL_NONBILL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP NOT IN (
					15
					,2
					)
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END ELSE 0 END
		,FDT_RECEIPT = CASE WHEN CHARINDEX('FDT_RECEIPT', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_CREDIT_BILLS = CASE WHEN CHARINDEX('FDT_CREDIT_BILLS', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_DEBIT_BILLS = CASE WHEN CHARINDEX('FDT_DEBIT_BILLS', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_CR = CASE WHEN CHARINDEX('FDT_CR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND L.DRCR = 'C'
				AND VTYP <> 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_DR = CASE WHEN CHARINDEX('FDT_DR', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND L.DRCR = 'D'
				AND VTYP <> 2
				THEN SUM(VAMT)
			ELSE 0
			END ELSE 0 END
		,FDT_BAL = CASE WHEN CHARINDEX('FDT_BAL', @REPORT_FORMULA) > 0 THEN CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)
			ELSE 0
			END ELSE 0 END
	FROM #LEDGER L
	GROUP BY L.CLTCODE
		,VDT
		,EDT
		,VTYP
		,L.DRCR
	) A
GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0
DECLARE @ML_BAL_REQ TINYINT

SELECT @ML_BAL_REQ = CHARINDEX('MARGIN_BAL', @REPORT_FORMULA)

IF @ML_BAL_REQ > 0
BEGIN
	UPDATE RD
	SET MARGIN_BAL = ML.AMOUNT
	FROM #REPORT_DATA RD
		,(
			SELECT PARTY_CODE
				,AMOUNT = SUM(CASE DRCR
						WHEN 'C'
							THEN AMOUNT
						ELSE - AMOUNT
						END)
			FROM MARGINLEDGER ML
			WHERE VDT >= @START_DATE
				AND VDT <= @EFFDATE + ' 23:59'
			GROUP BY PARTY_CODE
			) ML
	WHERE RD.CLTCODE = PARTY_CODE
END

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/



IF @TABLE_NAME <> ''
	SET @@SQL = "INSERT INTO "+ @servername +'.'+@TABLE_NAME + " SELECT "
ELSE	
	SET @@SQL = " SELECT "

IF @REPORT_COLUMN <> ''
	SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
SET @@SQL = @@SQL + @REPORT_FORMULA
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " #REPORT_DATA R, #FORMULA_CLIENT_MASTER M"
SET @@SQL = @@SQL + " WHERE M.CLTCODE = R.CLTCODE "

IF @REPORT_GROUPING <> ''
	SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING

--END

PRINT @@SQL

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_ACC_LEDGER2_FORMULA_BALANCES
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_GET_ACC_LEDGER2_FORMULA_BALANCES] 
	@FR_DATE VARCHAR(11),-- FROM DATE OF THE PERIOD 
	@EFFDATE VARCHAR(11),-- DATE FOR WHICH THE BALANCE IS REQUIRED  
	@PROCESS_CODE VARCHAR(10),-- PROCESS CODE FROM THE FORMULA MASTER  
	@REPORT_FORMULA VARCHAR(MAX),-- IN CASE NOT TO SET THE FORMULA AND GET THE SPECIFIEC FIELDS
	@EXCHANGE VARCHAR(10) = '',-- EXCHANGE
	@SEGMENT VARCHAR(50) = '',-- SEGMENT
	@REPORT_COLUMN VARCHAR(1000) = '', 
	@REPORT_GROUPING VARCHAR(1000) = '',
	@COSTCODE INT = 0,
	@TABLE_NAME  VARCHAR(1000) = '' 
	
AS
SELECT
	@REPORT_FORMULA = FORMULANAME
FROM FORMULA_MASTER
WHERE PROCESSCODE = @PROCESS_CODE

IF @EXCHANGE = '' BEGIN
SELECT
	@EXCHANGE = EXCHANGE
	,@SEGMENT = SEGMENT
FROM pradnya.OWNER
END

DECLARE @START_DATE VARCHAR(11)

IF LEN(@FR_DATE) = 10 SELECT
	@FR_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FR_DATE, 103), 109)

IF LEN(@EFFDATE) = 10 BEGIN
SELECT
	@EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)
END

SELECT
	@START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)
FROM PARAMETER
WHERE @EFFDATE BETWEEN SDTCUR
AND LDTCUR

DECLARE @MIN_BILL_DATE VARCHAR(11)
, @MAX_BILL_DATE VARCHAR(11)

DECLARE @servername varchar(20)='AngelNseCM.ACCOUNT.DBO'

SELECT
	@MIN_BILL_DATE = CONVERT(VARCHAR(11), MIN(VDT), 109)
	,@MAX_BILL_DATE = CONVERT(VARCHAR(11), MAX(VDT), 109)
FROM (SELECT TOP 2
		*
	FROM BILLPOSTED
	WHERE VDT <= @EFFDATE
	ORDER BY VDT DESC) A

CREATE TABLE #REPORT_DATA(CLTCODE VARCHAR(10)
, VDTBAL_OPBAL MONEY
, EDTBAL_OPBAL MONEY
, VDTBAL_DATES MONEY
, EDTBAL_DATES MONEY
, VDTBAL_DATES_CREDIT MONEY
, VDTBAL_DATES_DEBIT MONEY
, EDTBAL_DATES_CREDIT MONEY
, EDTBAL_DATES_DEBIT MONEY
, VDTBAL MONEY
, EDTBAL MONEY
, VDTBAL_RECEIPT MONEY
, T_DAY_BILL MONEY
, T1_DAY_BILL MONEY
, VDTBAL_BILL_DR MONEY
, VDTBAL_BILL_CR MONEY
, VDTBAL_NONBILL MONEY
, EDTBAL_RECEIPT MONEY
, EDTBAL_BILL_DR MONEY
, EDTBAL_BILL_CR MONEY
, EDTBAL_NONBILL MONEY
, FDT_RECEIPT MONEY
, FDT_CREDIT_BILLS MONEY
, FDT_DEBIT_BILLS MONEY
, FDT_CR MONEY
, FDT_DR MONEY
, MARGIN_BAL MONEY)

DECLARE @@SQL VARCHAR(MAX)

INSERT INTO #REPORT_DATA
	SELECT
		CLTCODE
		,VDTBAL_OPBAL = SUM(VDTBAL_OPBAL)
		,EDTBAL_OPBAL = SUM(EDTBAL_OPBAL)
		,VDTBAL_DATES = SUM(VDTBAL_DATES)
		,EDTBAL_DATES = SUM(EDTBAL_DATES)
		,VDTBAL_DATES_CREDIT = SUM(VDTBAL_DATES_CREDIT)
		,VDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
		,EDTBAL_DATES_CREDIT = SUM(EDTBAL_DATES_CREDIT)
		,EDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
		,VDTBAL = SUM(VDTBAL)
		,EDTBAL = SUM(EDTBAL)
		,VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT)
		,T_DAY_BILL = SUM(T_DAY_BILL)
		,T1_DAY_BILL = SUM(T1_DAY_BILL)
		,VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR)
		,VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR)
		,VDTBAL_NONBILL = SUM(VDTBAL_NONBILL)
		,EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT)
		,EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR)
		,EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR)
		,EDTBAL_NONBILL = SUM(EDTBAL_NONBILL)
		,FDT_RECEIPT = SUM(FDT_RECEIPT)
		,FDT_CREDIT_BILLS = SUM(FDT_CREDIT_BILLS)
		,FDT_DEBIT_BILLS = SUM(FDT_DEBIT_BILLS)
		,FDT_CR = SUM(FDT_CR)
		,FDT_DR = SUM(FDT_DR)
		,MARGIN_BAL = 0
	FROM (SELECT
			CLTCODE = L.CLTCODE
			,VDTBAL_OPBAL =
							CASE
								WHEN (VDT >= @START_DATE AND
									VDT < @FR_DATE) OR
									VTYP = 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,EDTBAL_OPBAL =
							CASE
								WHEN (EDT >= @START_DATE AND
									EDT < @FR_DATE) OR
									VTYP = 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,VDTBAL_DATES =
							CASE
								WHEN VDT >= @FR_DATE AND
									VTYP <> 18 THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,EDTBAL_DATES =
							CASE
								WHEN EDT >= @FR_DATE AND
									VTYP <> 18 AND
									EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L.DRCR
										WHEN 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,VDTBAL_DATES_CREDIT =
									CASE
										WHEN VDT >= @FR_DATE AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'C' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,VDTBAL_DATES_DEBIT =
									CASE
										WHEN VDT >= @FR_DATE AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'D' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,EDTBAL_DATES_CREDIT =
									CASE
										WHEN EDT >= @FR_DATE AND
											EDT <= @EFFDATE + ' 23:59' AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'C' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,EDTBAL_DATES_DEBIT =
									CASE
										WHEN EDT >= @FR_DATE AND
											EDT <= @EFFDATE + ' 23:59' AND
											VTYP <> 18 THEN SUM(CASE L.DRCR
												WHEN 'D' THEN VAMT
												ELSE 0
											END)
										ELSE 0
									END
			,VDTBAL =
						CASE
							WHEN VDT >= @START_DATE THEN SUM(CASE L.DRCR
									WHEN 'D' THEN VAMT
									ELSE -VAMT
								END)
							ELSE 0
						END
			,EDTBAL =
						CASE
							WHEN EDT >= @START_DATE AND
								EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L.DRCR
									WHEN 'D' THEN VAMT
									ELSE -VAMT
								END)
							ELSE 0
						END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,VDTBAL_RECEIPT =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 2 THEN SUM(VAMT)
									ELSE 0
								END
			,T_DAY_BILL =
							CASE
								WHEN VDT LIKE @MAX_BILL_DATE + '%' AND
									VTYP = 15 THEN SUM(CASE
										WHEN L.DRCR = 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,T1_DAY_BILL =
							CASE
								WHEN VDT LIKE @MIN_BILL_DATE + '%' AND
									VTYP = 15 THEN SUM(CASE
										WHEN L.DRCR = 'D' THEN VAMT
										ELSE -VAMT
									END)
								ELSE 0
							END
			,VDTBAL_BILL_DR =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END
			,VDTBAL_BILL_CR =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END
			,VDTBAL_NONBILL =
								CASE
									WHEN VDT >= @START_DATE AND
										VTYP NOT IN (
										15
										, 2
										) THEN SUM(CASE L.DRCR
											WHEN 'D' THEN VAMT
											ELSE -VAMT
										END)
									ELSE 0
								END
			,EDTBAL_RECEIPT =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 2 THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 2 THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_BILL_DR =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 15 AND
					L.DRCR = 'D' THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_BILL_CR =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE AND
					VTYP = 15 AND
					L.DRCR = 'C' THEN SUM(-VAMT)
				ELSE 0
			END
			,EDTBAL_NONBILL =
								CASE
									WHEN EDT >= @START_DATE AND
										EDT <= @EFFDATE + ' 23:59' AND
										VTYP NOT IN (
										15
										, 2
										) THEN SUM(CASE L.DRCR
											WHEN 'D' THEN VAMT
											ELSE -VAMT
										END)
									ELSE 0
								END + CASE
				WHEN EDT >= @START_DATE AND
					VDT < @START_DATE THEN SUM(CASE L.DRCR
						WHEN 'C' THEN VAMT
						ELSE -VAMT
					END)
				ELSE 0
			END
			,FDT_RECEIPT =
							CASE
								WHEN EDT > @EFFDATE + ' 23:59' AND
									VDT <= @EFFDATE + ' 23:59' AND
									VTYP = 2 THEN SUM(VAMT)
								ELSE 0
							END
			,FDT_CREDIT_BILLS =
								CASE
									WHEN EDT > @EFFDATE + ' 23:59' AND
										VDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'C' THEN SUM(VAMT)
									ELSE 0
								END
			,FDT_DEBIT_BILLS =
								CASE
									WHEN EDT > @EFFDATE + ' 23:59' AND
										VDT <= @EFFDATE + ' 23:59' AND
										VTYP = 15 AND
										L.DRCR = 'D' THEN SUM(VAMT)
									ELSE 0
								END
			,FDT_CR =
						CASE
							WHEN EDT > @EFFDATE + ' 23:59' AND
								VDT <= @EFFDATE + ' 23:59' AND
								L.DRCR = 'C' AND
								VTYP <> 2 THEN SUM(VAMT)
							ELSE 0
						END
			,FDT_DR =
						CASE
							WHEN EDT > @EFFDATE + ' 23:59' AND
								VDT <= @EFFDATE + ' 23:59' AND
								L.DRCR = 'D' AND
								VTYP <> 2 THEN SUM(VAMT)
							ELSE 0
						END
		FROM	LEDGER L (NOLOCK)
				,LEDGER2 L2 (NOLOCK)
				,#FORMULA_CLIENT_MASTER A
		WHERE A.CLTCODE = L.CLTCODE --AND SESSION_ID = @SESSIONID
		AND L.VNO = L2.VNO
		AND L.VTYP = L2.VTYPE
		AND L.BOOKTYPE = L2.BOOKTYPE
		AND L.LNO = L2.LNO
		AND L.CLTCODE = L2.CLTCODE
		AND COSTCODE = @COSTCODE
		AND (
		VDT >= @START_DATE
		OR EDT >= @START_DATE
		)
		AND VDT <= @EFFDATE + ' 23:59'
		GROUP BY	L.CLTCODE
					,VDT
					,EDT
					,VTYP
					,L.DRCR) A
	GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0
DECLARE @ML_BAL_REQ TINYINT

SELECT
	@ML_BAL_REQ = CHARINDEX('MARGIN_BAL', @REPORT_FORMULA)

IF @ML_BAL_REQ > 0 BEGIN
UPDATE RD
SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD
, (SELECT
		PARTY_CODE
		,AMOUNT = SUM(CASE DRCR
			WHEN 'C' THEN AMOUNT
			ELSE -AMOUNT
		END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE
	AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE) ML
WHERE RD.CLTCODE = PARTY_CODE
END

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/


IF @TABLE_NAME <> '' SET @@SQL = "INSERT INTO "+ @servername +'.'+@TABLE_NAME +" SELECT " ELSE SET @@SQL = " SELECT "

IF @REPORT_COLUMN <> '' SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
SET @@SQL = @@SQL + @REPORT_FORMULA
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " #REPORT_DATA R, #FORMULA_CLIENT_MASTER M"
SET @@SQL = @@SQL + " WHERE M.CLTCODE = R.CLTCODE "

IF @REPORT_GROUPING <> '' SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING

--END

PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_LEDGER_FORMULA_BALANCES_WPARENT
-- --------------------------------------------------


--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[CLS_GET_LEDGER_FORMULA_BALANCES_WPARENT]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50),
 @PARENTCHILD_FLAG CHAR(1) = 'C'
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL_OPBAL MONEY,  
 EDTBAL_OPBAL MONEY,    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 VDTBAL_RECEIPT MONEY,     
 T_DAY_BILL MONEY,     
 VDTBAL_BILL_DR MONEY,     
 VDTBAL_BILL_CR MONEY,    
 VDTBAL_NONBILL MONEY,     
 EDTBAL_RECEIPT MONEY,    
 EDTBAL_BILL_DR MONEY,    
 EDTBAL_BILL_CR MONEY,    
 EDTBAL_NONBILL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_CR MONEY,     
 FDT_DR MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = SUM(VDTBAL_OPBAL),    
 EDTBAL_OPBAL = SUM(EDTBAL_OPBAL),    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT),     
 T_DAY_BILL = SUM(T_DAY_BILL),     
 VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR),     
 VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR),    
 VDTBAL_NONBILL = SUM(VDTBAL_NONBILL),     
 EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT),    
 EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR),    
 EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR),    
 EDTBAL_NONBILL = SUM(EDTBAL_NONBILL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_CR = SUM(FDT_CR),     
 FDT_DR = SUM(FDT_DR),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_CODE ELSE L.CLTCODE END,  
 PARTY_NAME = CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_NAME ELSE PARTY_NAME END,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = CASE WHEN VDT >= @START_DATE AND VDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL_OPBAL = CASE WHEN EDT >= @START_DATE AND EDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL_RECEIPT = CASE WHEN VDT >= @START_DATE AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,     
 T_DAY_BILL = CASE WHEN VDT LIKE @EFFDATE + '%' AND VTYP = 15 THEN SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 VDTBAL_BILL_DR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END,     
 VDTBAL_BILL_CR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END ,    
 VDTBAL_NONBILL = CASE WHEN VDT >= @START_DATE AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 EDTBAL_RECEIPT = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 2 THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_DR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_CR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_NONBILL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_CR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'C' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END,     
 FDT_DR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'D' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END
FROM     
 LEDGER L,  
 FORMULA_CLIENT_MASTER_PARENT A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 AND (VDT >= @START_DATE OR EDT >= @START_DATE)    
 AND VDT <= @EFFDATE + ' 23:59'    
 GROUP BY     
 CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_CODE ELSE L.CLTCODE END, CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_NAME ELSE PARTY_NAME END, ENTITY_LEVEL, ENTITY_CODE,  VDT, EDT, VTYP, DRCR    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    


UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, FORMULA_CLIENT_MASTER_PARENT C,(
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE C.CLTCODE = PARTY_CODE AND CASE WHEN @PARENTCHILD_FLAG = 'P' THEN PARENT_CODE ELSE C.CLTCODE END = RD.CLTCODE


/*  
DECLARE  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(10)  
   
SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER   
*/
 
SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GL_REPORT
-- --------------------------------------------------

/*
EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
EXEC RPT_ACC_BANKBOOK_NEW 'DEC  1 2010', 'DEC 22 2010', '01/04/2010', 'BANK01', 'BROKER', 'BROKER', '%', 'VDT'
*/

--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'      
CREATE PROC [dbo].[CLS_GL_REPORT]
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @FCODE VARCHAR(10),                          
      @TCODE VARCHAR(10),                          
      @STATUSID VARCHAR(30),                          
      @STATUSNAME VARCHAR(30),                          
      @BRANCH VARCHAR(10),      
      @SELECTIONBY VARCHAR(3) = 'VDT',
      @REPORT_TYPE VARCHAR(5) = 'GL'                           
                          
AS                          
                          
DECLARE                          
 @@OPENDATE AS VARCHAR(11),                          
 @@REPDATE AS VARCHAR(8),                          
 @@STARTDATE AS VARCHAR(11),       
 @@COSTCODE AS SMALLINT
      


CREATE TABLE #GL_OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

CREATE TABLE [DBO].[#TBL_GLREPORT]([SRNO] [INT] IDENTITY (1, 1) NOT NULL,
[BOOKTYPE] [CHAR](2) NULL,
[VOUDT] [VARCHAR](10) NULL,
[EFFDT] [VARCHAR](10) NULL,
[SHORTDESC] [CHAR](6) NOT NULL DEFAULT (' '),
[DRAMT] [MONEY] NULL,
[CRAMT] [MONEY] NULL,
[VNO] [VARCHAR](15) NULL,
[NARRATION] [VARCHAR](500) NULL,
[DDNO] [VARCHAR](32) NULL,
[CLTCODE] [VARCHAR](10) NOT NULL,
[LONGNAME] [VARCHAR](100) NULL,
[VDT] [DATETIME] NULL,
[VTYP] [SMALLINT] NOT NULL,
[ACCAT] [CHAR](2) NULL,
[OPBAL] [MONEY] NOT NULL,
[CROSAC] [VARCHAR](10) NOT NULL,
[ACNAME] [VARCHAR](100) NULL,
[BRANCHCODE] [VARCHAR](35) NULL,
[LNO] [INT] NULL,
[REPDATE] [VARCHAR](8) NULL,
[MAINCODE] [VARCHAR](10) NULL,
[VCHDT] [DATETIME] NULL,
[EDIFF] INT NULL)


--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                        

SELECT
	@@COSTCODE = -1

IF @STATUSID <> 'BROKER' BEGIN
SELECT TOP 1
	@@COSTCODE = COSTCODE
FROM COSTMAST
WHERE COSTNAME = @STATUSNAME
END ELSE IF @STATUSID = 'BROKER' BEGIN
IF @BRANCH <> '' OR @BRANCH <> '%' BEGIN
SELECT TOP 1
	@@COSTCODE = COSTCODE
FROM COSTMAST
WHERE COSTNAME = @BRANCH
END
END


SELECT
	@@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE, 103), 109), 11)


CREATE TABLE #FORMULA_CLIENT_MASTER(CLTCODE VARCHAR(10))


IF @REPORT_TYPE <> 'GL'
BEGIN
	INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT
			CLTCODE
		FROM ACMAST
		WHERE CLTCODE BETWEEN @FCODE AND @TCODE
		AND ACCAT =
					CASE
						WHEN @REPORT_TYPE = 'BANK' THEN 2
						ELSE CASE
								WHEN @REPORT_TYPE = 'CASH' THEN 1
								ELSE 3
							END
					END
		--AND (BRANCHCODE =
		--					CASE
		--						WHEN @BRANCH <> '' OR
		--							@BRANCH <> '%' THEN @BRANCH
		--						ELSE BRANCHCODE
		--					END
		--OR BRANCHCODE = 'ALL')
END
ELSE
BEGIN
	INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT
			CLTCODE
		FROM ACMAST
		WHERE CLTCODE BETWEEN @FCODE AND @TCODE
		AND ACCAT IN(3, 14)
END


	
/* GET OPNING BALANCE */
IF @SELECTIONBY = 'VDT' BEGIN
IF @STATUSID = 'BROKER' AND @@COSTCODE = -1 BEGIN
--INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'VDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,'#GL_OPBAL'

END ELSE BEGIN
--		INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'VDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,@@COSTCODE
											,'#GL_OPBAL'
END
END ELSE BEGIN
IF @STATUSID = 'BROKER' AND @@COSTCODE = -1 BEGIN
--INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'EDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,'#GL_OPBAL'
END ELSE BEGIN
--INSERT INTO #GL_OPBAL
EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES	@FDATE
											,@TDATE
											,''
											,'EDTBAL_OPBAL'
											,'NSE'
											,'CAPITAL'
											,'M.CLTCODE'
											,''
											,@@COSTCODE
											,'#GL_OPBAL'
END
END
/* GET OPNING BALANCE */



/* GET THE RECORDS FROM LEDGER TABLE */
IF @REPORT_TYPE <> 'GL' BEGIN
INSERT INTO #TBL_GLREPORT
	SELECT
		L.BOOKTYPE
		,VOUDT = CONVERT(VARCHAR, L.VDT, 103)
		,EFFDT = CONVERT(VARCHAR, L.EDT, 103)
		,ISNULL(SHORTDESC, '') SHORTDESC
		,DRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'D' THEN VAMT
			ELSE 0
		END)
		,CRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'C' THEN VAMT
			ELSE 0
		END)
		,L.VNO
		,REPLACE(L.NARRATION, '"', '') NARRATION
		,DDNO = (CASE
			WHEN ISNULL(L1.DDNO, '') = '0' THEN ''
			ELSE ISNULL(L1.DDNO, '')
		END)
		,L.CLTCODE
		,A.LONGNAME
		,VDT
		,L.VTYP
		,ACCAT
		,OPBAL = 0
		,CROSAC = ''
		,A.ACNAME
		,A.BRANCHCODE
		,L.LNO
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,L.VDT
		,EDIFF = DATEDIFF(D, L.EDT, GETDATE())
	FROM	LEDGER L
			LEFT JOIN (SELECT
					VTYP
					,BOOKTYPE
					,VNO
					,DDNO = MAX(DDNO)
				FROM LEDGER1
				GROUP BY	VTYP
							,BOOKTYPE
							,VNO) L1
				ON (L1.VTYP = L.VTYP
				AND L1.BOOKTYPE = L.BOOKTYPE
				AND L1.VNO = L.VNO)
			,
			--(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
			(SELECT
					VNO
					,VTYP
					,BOOKTYPE
				FROM LEDGER
				WHERE @FDATE <=
								CASE
									WHEN @SELECTIONBY = 'VDT' THEN VDT
									ELSE EDT
								END
				AND @TDATE + ' 23:59:59' >=
											CASE
												WHEN @SELECTIONBY = 'VDT' THEN VDT
												ELSE EDT
											END
				AND CLTCODE BETWEEN @FCODE AND @TCODE) LL
			,VMAST V
			,ACMAST A
	WHERE L.VNO = LL.VNO
	AND L.VTYP = LL.VTYP
	AND L.BOOKTYPE = LL.BOOKTYPE
	AND L.CLTCODE = A.CLTCODE
	AND L.VTYP = V.VTYPE
	AND NOT EXISTS (SELECT
			CLTCODE
		FROM #FORMULA_CLIENT_MASTER F
		WHERE L.CLTCODE = F.CLTCODE)
	AND L.VTYP <> 18
	
END ELSE BEGIN
IF @@COSTCODE = -1 BEGIN
INSERT INTO #TBL_GLREPORT
	SELECT
		L.BOOKTYPE
		,VOUDT = CONVERT(VARCHAR, L.VDT, 103)
		,EFFDT = CONVERT(VARCHAR, L.EDT, 103)
		,ISNULL(SHORTDESC, '') SHORTDESC
		,DRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'D' THEN VAMT
			ELSE 0
		END)
		,CRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'C' THEN VAMT
			ELSE 0
		END)
		,L.VNO
		,REPLACE(L.NARRATION, '"', '') NARRATION
		,DDNO = ISNULL((SELECT TOP 1
				DDNO
			FROM LEDGER1
			WHERE VTYP = L.VTYP
			AND VNO = L.VNO
			AND BOOKTYPE = L.BOOKTYPE
			AND LNO = L.LNO)
		, '')
		,L.CLTCODE
		,A.LONGNAME
		,VDT
		,L.VTYP
		,ACCAT
		,OPBAL = 0
		,CROSAC = ''
		,A.ACNAME
		,A.BRANCHCODE
		,L.LNO
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,L.VDT
		,EDIFF = DATEDIFF(D, L.EDT, GETDATE())
	FROM	LEDGER L
			,(SELECT
					CLTCODE
					,LONGNAME
					,ACCAT
					,BRANCHCODE
					,ACNAME
				FROM ACMAST
				WHERE CLTCODE BETWEEN @FCODE AND @TCODE
				AND (ACCAT LIKE '3%'
				OR ACCAT LIKE '14%'
				OR ACCAT LIKE '103%')) A
			,VMAST V
	WHERE L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'
	AND VTYP = VTYPE
	AND L.CLTCODE = A.CLTCODE
	AND L.VTYP <> 18
/*ORDER BY                    
   L.CLTCODE,                    
   VOUDT1,                    
   L.VTYP DESC,                    
   L.VNO  */
END ELSE BEGIN
INSERT INTO #TBL_GLREPORT
	SELECT
		L.BOOKTYPE
		,VOUDT = CONVERT(VARCHAR, L.VDT, 103)
		,EFFDT = CONVERT(VARCHAR, L.EDT, 103)
		,ISNULL(SHORTDESC, '') SHORTDESC
		,DRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'D' THEN VAMT
			ELSE 0
		END)
		,CRAMT = (CASE
			WHEN UPPER(L.DRCR) = 'C' THEN VAMT
			ELSE 0
		END)
		,L.VNO
		,REPLACE(L.NARRATION, '"', '') NARRATION
		,DDNO = ISNULL((SELECT TOP 1
				DDNO
			FROM LEDGER1
			WHERE VTYP = L.VTYP
			AND VNO = L.VNO
			AND BOOKTYPE = L.BOOKTYPE
			AND LNO = L.LNO)
		, '')
		,L.CLTCODE
		,A.LONGNAME
		,VDT
		,L.VTYP
		,ACCAT
		,OPBAL = 0
		,CROSAC = ''
		,A.ACNAME
		,A.BRANCHCODE
		,L.LNO
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,L.VDT
		,EDIFF = DATEDIFF(D, L.EDT, GETDATE())
	FROM	LEDGER L
			,LEDGER2 L2
			,(SELECT
					CLTCODE
					,LONGNAME
					,ACCAT
					,BRANCHCODE
					,ACNAME
				FROM ACMAST
				WHERE CLTCODE BETWEEN @FCODE AND @TCODE
				AND (ACCAT LIKE '3%'
				OR ACCAT LIKE '14%'
				OR ACCAT LIKE '103%')) A
			,VMAST V
	WHERE L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'
	AND VTYP = V.VTYPE
	AND L.CLTCODE = A.CLTCODE
	AND L.VTYP <> 18
	AND L.VNO = L2.VNO
	AND L.VTYP = L2.VTYPE
	AND L.BOOKTYPE = L2.BOOKTYPE
	AND L.LNO = L2.LNO
	AND L.CLTCODE = L2.CLTCODE
	AND COSTCODE = @@COSTCODE
/*ORDER BY                    
   L.CLTCODE,                    
   VOUDT1,                    
   L.VTYP DESC,                    
   L.VNO  */
END
END
/* GET THE RECORDS FROM LEDGER TABLE */
--SELECT * FROM #TBL_GLREPORT

/* GET THE RECORDS FROM LEDGER2 TABLE */
/*     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L2.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,    
      L.LNO,      
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT,
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE @FDATE <= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND @TDATE + ' 23:59:59' >= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND CLTCODE = @FCODE) LL,
      VMAST V, ACMAST A, LEDGER2 L2                        
     WHERE       
      L.VNO = L1.VNO                        
      AND L.VTYP = L1.VTYP                        
      AND L.BOOKTYPE = L1.BOOKTYPE                        
      AND L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE       
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.LNO = L2.LNO      
 --     AND L.DRCR = L2.DRCR      
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L2.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L2.CLTCODE <> @FCODE                        
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP <> 18        */
/* GET THE RECORDS FROM LEDGER2 TABLE */




--UPDATE #TBL_GLREPORT
--SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION)



IF @REPORT_TYPE <> 'GL' 
BEGIN
UPDATE #TBL_GLREPORT
SET	OPBAL = O.OPBAL
	,CROSAC = ''
FROM #GL_OPBAL O
WHERE O.CLTCODE = @FCODE

UPDATE #TBL_GLREPORT
SET CROSAC = CLTCODE
UPDATE #TBL_GLREPORT
SET CLTCODE = @FCODE
END 
ELSE 
BEGIN
UPDATE #TBL_GLREPORT
SET	OPBAL = -O.OPBAL
	,CROSAC = ''
FROM #GL_OPBAL O
WHERE O.CLTCODE = #TBL_GLREPORT.CLTCODE

UPDATE #TBL_GLREPORT
SET CROSAC = L.CLTCODE FROM (SELECT VNO, VTYP, BOOKTYPE, CLTCODE FROM LEDGER(NOLOCK) WHERE VTYP IN(2, 3,8))  L
WHERE #TBL_GLREPORT.VNO = L.VNO AND #TBL_GLREPORT.VTYP = L.VTYP AND #TBL_GLREPORT.BOOKTYPE = L.BOOKTYPE AND #TBL_GLREPORT.CLTCODE <> L.CLTCODE

--UPDATE #TBL_GLREPORT
--SET CROSAC = L.CLTCODE FROM (SELECT VNO, VTYP, BOOKTYPE, CLTCODE,LNO FROM LEDGER(NOLOCK) WHERE VTYP IN(8))  L
--WHERE #TBL_GLREPORT.VNO = L.VNO AND #TBL_GLREPORT.VTYP = L.VTYP AND #TBL_GLREPORT.BOOKTYPE = L.BOOKTYPE AND #TBL_GLREPORT.LNO <> L.LNO


INSERT INTO #TBL_GLREPORT
	SELECT
		''
		,''
		,''
		,'OPBAL'
		,CASE
			WHEN OPBAL > 0 THEN OPBAL
			ELSE 0
		END
		,CASE
			WHEN OPBAL <= 0 THEN ABS(OPBAL)
			ELSE 0
		END
		,''
		,'OPENING BALANCE'
		,''
		,CLTCODE
		,''
		,''
		,0
		,''
		,-OPBAL
		,CLTCODE
		,''
		,''
		,''
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,''
		,0
	FROM #GL_OPBAL
END

UPDATE #TBL_GLREPORT
SET ACNAME = A.ACNAME
FROM ACMAST A
WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE

INSERT INTO #TBL_GLREPORT
	SELECT
		''
		,''
		,''
		,'OPBAL'
		,0
		,0
		,''
		,'OPENING BALANCE'
		,''
		,CLTCODE
		,''
		,''
		,0
		,''
		,OPBAL
		,CLTCODE
		,''
		,''
		,''
		,CONVERT(VARCHAR, GETDATE(), 112)
		,''
		,''
		,0
	FROM #GL_OPBAL
	WHERE CLTCODE NOT IN (SELECT
			CLTCODE
		FROM #TBL_GLREPORT
		WHERE NARRATION = 'OPENING BALANCE')
	AND OPBAL <> 0


DELETE FROM #TBL_GLREPORT
WHERE DRAMT = 0
	AND CRAMT = 0
	AND OPBAL = 0
	AND NARRATION <> 'OPENING BALANCE'

UPDATE #TBL_GLREPORT
SET BRANCHCODE = COSTNAME
FROM LEDGER2 L2, COSTMAST C
WHERE #TBL_GLREPORT.VNO = L2.VNO
AND #TBL_GLREPORT.VTYP = L2.VTYPE
AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE
AND #TBL_GLREPORT.LNO = L2.LNO
AND #TBL_GLREPORT.CROSAC = L2.CLTCODE
AND L2.COSTCODE = C.COSTCODE

--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                        
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID  

SELECT
	BOOKTYPE
	,VOUDT VDT
	,EFFDT EDT
	,SHORTDESC
	,DRAMT DEBIT
	,CRAMT CREDIT
	,VNO
	,NARRATION
	,DDNO
	,CLTCODE
	,LONGNAME
	,VTYP
	,ACCAT
	,OPBAL
	,CROSAC
	,ACNAME
	,BRANCHCODE
	,VCHDT
	,EDIFF
FROM #TBL_GLREPORT

ORDER BY CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109), 11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GLLEDGER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_GLLEDGER]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@FROM_GL_CODE VARCHAR(10),
	@TO_GL_CODE VARCHAR(10),
	@VIEWOPTION VARCHAR(10),
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
	
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #FORMULA_CLIENT_MASTER
 ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)
	
DECLARE @servername as varchar(20) = 'AngelNseCM.ACCOUNT.DBO'


CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


SET @@COSTCODE = -1

IF @BRANCHCODE <> '' OR @BRANCHCODE <> '%'
BEGIN
	SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCHCODE
END

CREATE TABLE #TB
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300)
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(VDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL,VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = ' -AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END
ELSE
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL, EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = '-AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
SET @@SQL = @@SQL + "WHERE CLTCODE >= '" + @FROM_GL_CODE + "' AND CLTCODE <= '" + @TO_GL_CODE + "'"
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + " AND ACCAT = 3 "
ELSE IF UPPER(@VIEWOPTION) = 'BANK'
	SET @@SQL = @@SQL + " AND ACCAT = 2 "	
ELSE IF UPPER(@VIEWOPTION) = 'CASH'
	SET @@SQL = @@SQL + " AND ACCAT = 1 "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "
print'sss'
PRINT @@SQL
EXEC(@@SQL)	
print 'dd'


IF UPPER(@STATUSID) = 'BROKER' AND @@COSTCODE = -1
BEGIN

	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', '',''
END
ELSE
BEGIN
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE','',@@COSTCODE, ''
	
END

DROP TABLE #FORMULA_CLIENT_MASTER

print 'A'

SET @@SQL = "INSERT INTO " + @servername +'.'+@TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
/*SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + "SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', -AMOUNT, 0,	'" + @EXCHANGE + "','" +  @SEGMENT + "', '', '' "
SET @@SQL = @@SQL + "FROM #TB WHERE CLTCODE = '' AND ISNULL(AMOUNT, 0) <> 0 "*/
PRINT @@SQL
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GLLEDGER_WRAPPER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_GLLEDGER_WRAPPER]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@FROM_GL_CODE VARCHAR(10),
	@TO_GL_CODE VARCHAR(10),
	@VIEWOPTION VARCHAR(10), /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@EXCSEGMENT VARCHAR(1000) = '',
	@SESSIONID VARCHAR(100) = '1234567890',
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
AS

DECLARE
	@@SQL VARCHAR(MAX),
	@TABLE_NAME VARCHAR(100),
	@TABLE_NAME1 VARCHAR(100),
	@TABLE_EXISTS TINYINT
	
SET @TABLE_NAME = "TB_ALL_" + @SESSIONID
SET @TABLE_NAME1 = @TABLE_NAME
/*
SET @TABLE_EXISTS = 0

SET @@SQL = "SELECT COUNT(1) FROM SYS.TABLES WHERE NAME = '" + @TABLE_NAME + "'"

EXEC(@@SQL)

SELECT @@ROWCOUNT

IF @@ROWCOUNT > 0
BEGIN
	SET @@SQL = "DROP TABLE " + @TABLE_NAME 
	EXEC (@@SQL)
END
*/

SET @@SQL = "CREATE TABLE " + @TABLE_NAME
SET @@SQL = @@SQL + "("
SET @@SQL = @@SQL + "	CLTCODE VARCHAR(10),"
SET @@SQL = @@SQL + "	ACNAME VARCHAR(100),"
SET @@SQL = @@SQL + "	BRANCHCODE VARCHAR(10),"
SET @@SQL = @@SQL + "	EXCHANGE VARCHAR(10),"
SET @@SQL = @@SQL + "	SEGMENT VARCHAR(15),"
SET @@SQL = @@SQL + "	AMOUNT MONEY,"
IF @WITHOPENING = 1
BEGIN
	SET @@SQL = @@SQL + "	OPENING_AMOUNT MONEY,"
	SET @@SQL = @@SQL + "	PERIOD_AMOUNT_CR MONEY,"
	SET @@SQL = @@SQL + "	PERIOD_AMOUNT_DR MONEY,"
END
SET @@SQL = @@SQL + "	ACCAT SMALLINT,"
SET @@SQL = @@SQL + "	GRPCODE VARCHAR(15),"
SET @@SQL = @@SQL + "	GRPNAME VARCHAR(100)"
SET @@SQL = @@SQL + ")"

--print @@SQL

EXEC(@@SQL)



CREATE TABLE [DBO].[#DBNAME]              
 (              
  ACCOUNTDB VARCHAR(20),               
  EXCHANGE VARCHAR(6),               
  SEGMENT VARCHAR(10),              
  ACCOUNTSERVER VARCHAR(20),            
  SHAREDB VARCHAR(20),          
  GROUPID VARCHAR(20),          
  ORDER_SEGMENT INT            
 ) ON [PRIMARY]            
DECLARE  @@DB VARCHAR(1000)          
     
--SET @EXCSEGMENT = REPLACE(LEFT(@EXCSEGMENT,LEN(@EXCSEGMENT)),'|',',')          
--PRINT @EXCSEGMENT    
    
IF @EXCSEGMENT = ''          
 SELECT @EXCSEGMENT = EXCHANGE + '~' + SEGMENT FROM PRADNYA..OWNER          
       
 SET @EXCSEGMENT = REPLACE(@EXCSEGMENT,'|',',')  
          
SELECT @@DB =  " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM CLS_COMPANY_MASTER_SETTING (NOLOCK) WHERE /*SEGMENT <> 'MFSS' and */ EXCHANGE + '~' + SEGMENT IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY EXCHANGE "
--PRINT @@DB
EXEC(@@DB)       
      
DECLARE @@MAINREC AS CURSOR,          
  @@ACCOUNTDB VARCHAR(20),            
  @@SHAREDB VARCHAR(20),               
  @@ACCOUNTSVR VARCHAR(20),              
  @@EXCHANGE VARCHAR(15),              
  @@SEGMENT VARCHAR(15),          
  @@GROUPID VARCHAR(20),          
  @@ORDERSEG VARCHAR(3),          
  @@ORDERSECOUNT INT,
  @@ACCOUNTSERVERDB VARCHAR(20)
SET @@ORDERSECOUNT = (SELECT COUNT(1) FROM COMPANY_MASTER_SETTING)     

SELECT @@ACCOUNTSERVERDB = ACCOUNTSERVER + '.' +  ACCOUNTDB  FROM #DBNAME WHERE ACCOUNTDB = 'ACCOUNT'
SELECT @TABLE_NAME = @@ACCOUNTSERVERDB + '.dbo.' + @TABLE_NAME

  
--SET @@SQL = ""          
SET @@MAINREC = CURSOR FOR              
     SELECT ACCOUNTDB, EXCHANGE, SEGMENT,ACCOUNTSERVER,SHAREDB,GROUPID,ORDER_SEGMENT FROM #DBNAME             
               
OPEN @@MAINREC              
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB,@@GROUPID,@@ORDERSEG              
 WHILE @@FETCH_STATUS = 0              
 BEGIN      
		SET @@SQL = "EXEC " + @@ACCOUNTSVR + '.' + @@ACCOUNTDB + "..CLS_GLLEDGER '" + @FR_DATE + "','" + @VDT + "','" + @FROM_GL_CODE + "','" + @TO_GL_CODE + "','" + @VIEWOPTION + "','" +  @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE + "','" + @SHOWZEROBAL + "','" + @GRPCODE + "','" + @@SHAREDB + "','" + @@EXCHANGE + "','" + @@SEGMENT + "','" + @TABLE_NAME + "','" + @BRANCHCODE + "'," + CONVERT(VARCHAR, @WITHOPENING)
		
		PRINT @@SQL
		EXEC(@@SQL)
		
FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB,@@GROUPID,@@ORDERSEG              
END       		

SET @@SQL = "INSERT INTO " + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT CLTCODE,ACNAME,BRANCHCODE,EXCHANGE = '',SEGMENT = '', "
IF @WITHOPENING = 1
BEGIN
	SET @@SQL = @@SQL + "OPENING_AMOUNT = SUM(OPENING_AMOUNT), PERIOD_AMOUNT_CR = SUM(PERIOD_AMOUNT_CR), PERIOD_AMOUNT_DR = SUM(PERIOD_AMOUNT_DR),"
END
SET @@SQL = @@SQL + "AMOUNT = SUM(AMOUNT),"
SET @@SQL = @@SQL + "ACCAT = 0,GRPCODE = '',GRPNAME = '' "
SET @@SQL = @@SQL + "FROM " + @TABLE_NAME
SET @@SQL = @@SQL + " GROUP BY CLTCODE,ACNAME,BRANCHCODE"

EXEC (@@SQL)

SET @@SQL = "SELECT * FROM " + @TABLE_NAME1 + " ORDER BY CLTCODE, EXCHANGE "
PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = "DROP TABLE " + @TABLE_NAME1 
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MTF_CASHCOLL_DETAIL
-- --------------------------------------------------


CREATE PROC  [dbo].[CLS_MTF_CASHCOLL_DETAIL]
(
@SAUDA_DATE DATETIME,
@FROMPARTY VARCHAR(10),
@TOPARTY VARCHAR(10)
)
AS
BEGIN

	SELECT CLTCODE,VDT=CONVERT(VARCHAR,VDT,103),VTYP,DRCR,NARRATION,VAMT=SUM(CASE WHEN DRCR='C' THEN VAMT ELSE -VAMT END) 
	FROM LEDGER L WHERE
	VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
	--AND VTYP NOT IN ('35','8')
	AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
	GROUP BY CLTCODE,CONVERT(VARCHAR,VDT,103),VTYP,NARRATION,DRCR
	ORDER BY CLTCODE,VTYP,VDT

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MTF_CASHCOLL_JV_DETAIL
-- --------------------------------------------------

CREATE PROC  [dbo].[CLS_MTF_CASHCOLL_JV_DETAIL](@SAUDA_DATE DATETIME
,@FROMPARTY VARCHAR(10)
,@TOPARTY VARCHAR(10))
AS
BEGIN
SELECT VDT=CONVERT(VARCHAR,L.VDT,103),L.CLTCODE,L.VNO,L.VTYP,L.NARRATION,L.DRCR,VAMT=SUM(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM LEDGER L LEFT OUTER JOIN ACCOUNT..LEDGER L1 
ON ( L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT )
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
GROUP BY L.CLTCODE,CONVERT(VARCHAR,L.VDT,103),L.DRCR,L.VNO,L.NARRATION,L.VTYP
HAVING L.NARRATION NOT LIKE '%Interest for the Period%'

UNION

SELECT distinct VDT=CONVERT(VARCHAR,L.VDT,103),L.CLTCODE,L.VNO,L.VTYP,L.NARRATION,L.DRCR,VAMT=(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM ACCOUNT..LEDGER L,LEDGER L1 
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT 
AND L.VTYP IN ('6','35')
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
GROUP BY L.CLTCODE,CONVERT(VARCHAR,L.VDT,103),L.DRCR,L.VNO,L.NARRATION,L.VTYP,L.VAMT
HAVING L.NARRATION NOT LIKE '%Interest for the Period%'
ORDER BY L.CLTCODE,L.VNO,L.NARRATION,CONVERT(VARCHAR,L.VDT,103)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MTF_CASHCOLL_JV_SUMMARY
-- --------------------------------------------------

CREATE PROC  [dbo].[CLS_MTF_CASHCOLL_JV_SUMMARY](@SAUDA_DATE DATETIME
,@FROMPARTY VARCHAR(10)
,@TOPARTY VARCHAR(10))
AS
BEGIN

SELECT VDT=CONVERT(VARCHAR,VDT,103), CLTCODE, VAMT = SUM(VAMT)
FROM
(
SELECT L.VDT,L.CLTCODE,VAMT=SUM(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM LEDGER L LEFT OUTER JOIN ACCOUNT..LEDGER L1 
ON ( L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT AND CONVERT(VARCHAR,L.VDT,111) = CONVERT(VARCHAR,L1.VDT,111))
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
 and L.NARRATION NOT LIKE '%Interest for the Period%'
GROUP BY L.CLTCODE,L.VDT--,L.DRCR


UNION

SELECT distinct  L.VDT,L.CLTCODE,VAMT= (CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM ACCOUNT..LEDGER L,LEDGER L1 
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT 
AND L.VTYP IN ('6','35')
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
and L.NARRATION NOT LIKE '%Interest for the Period%'
GROUP BY L.CLTCODE,L.VDT,(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END)


UNION

SELECT distinct  L.VDT,L.CLTCODE,VAMT= (CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM ACCOUNTFO..LEDGER L,LEDGER L1 
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT 
AND L.VTYP ='6'
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
and L.NARRATION NOT LIKE '%Interest for the Period%'
GROUP BY L.CLTCODE,L.VDT,(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END)


) A
GROUP BY CONVERT(VARCHAR,VDT,103), CLTCODE 
--HAVING SUM(VAMT)<>0
ORDER BY CLTCODE, VDT

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MTF_CASHCOLL_JV_SUMMARY_MISMATCH
-- --------------------------------------------------

CREATE PROC  [dbo].[CLS_MTF_CASHCOLL_JV_SUMMARY_MISMATCH](@SAUDA_DATE DATETIME
,@FROMPARTY VARCHAR(10)
,@TOPARTY VARCHAR(10))
AS
BEGIN

SELECT VDT=CONVERT(VARCHAR,VDT,103), CLTCODE, VAMT = SUM(VAMT)
FROM
(
SELECT L.VDT,L.CLTCODE,VAMT=SUM(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM LEDGER L LEFT OUTER JOIN ACCOUNT..LEDGER L1 
ON ( L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT AND CONVERT(VARCHAR,L.VDT,111) = CONVERT(VARCHAR,L1.VDT,111))
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
 and L.NARRATION NOT LIKE '%Interest for the Period%'
GROUP BY L.CLTCODE,L.VDT--,L.DRCR


UNION

SELECT distinct  L.VDT,L.CLTCODE,VAMT= (CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM ACCOUNT..LEDGER L,LEDGER L1 
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT 
AND L.VTYP IN ('6','35')
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
and L.NARRATION NOT LIKE '%Interest for the Period%'
GROUP BY L.CLTCODE,L.VDT,(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END)


UNION

SELECT distinct  L.VDT,L.CLTCODE,VAMT= (CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END) 
FROM ACCOUNTFO..LEDGER L,LEDGER L1 
WHERE L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
AND L.VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59' 
AND L1.CLTCODE = L.CLTCODE AND L1.Vtyp = L1.VTYP AND L1.DRCR <> L.DRCR AND L1.Vamt = L.VAMT 
AND L.VTYP ='6'
AND NOT EXISTS (SELECT ACCODE FROM VALANACCOUNT V (NOLOCK) WHERE V.ACCODE = L.CLTCODE)
and L.NARRATION NOT LIKE '%Interest for the Period%'
GROUP BY L.CLTCODE,L.VDT,(CASE WHEN L.DRCR='C' THEN L.VAMT ELSE -L.VAMT END)


) A
GROUP BY CONVERT(VARCHAR,VDT,103), CLTCODE 
HAVING SUM(VAMT)<>0
ORDER BY CLTCODE, VDT

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MTF_CASHCOLL_SUMMARY
-- --------------------------------------------------


CREATE proc [dbo].[CLS_MTF_CASHCOLL_SUMMARY]
(
@SAUDA_DATE DATETIME,
@FROMPARTY VARCHAR(10),
@TOPARTY VARCHAR(10)
)
as
begin
select vdt=CONVERT(VARCHAR,VDT,103),cltcode,sum(VTYP35) AS MTF_BILLING,sum(VTYP6) AS MTF_CASH_COLLATERAL,sum(VTYP8) AS MTF_INTEREST,sum(VTYP66) AS MTF_CASH_COLLATERAL_USED_FOR_PAYIN,sum(VTYP67) AS MTF_MTM,sum(TOTAL_VAMT) AS TOTAL_CASH_COLLATERAL
from 
(
SELECT 
    VDT,
    CLTCODE,
	SUM(CASE WHEN VTYP = 35 THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS VTYP35,
    SUM(CASE WHEN VTYP = 6 THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS VTYP6,
    SUM(CASE WHEN VTYP = 8 THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS VTYP8,
	SUM(CASE WHEN VTYP = 66 THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS VTYP66,
	SUM(CASE WHEN VTYP = 67 THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS VTYP67,
    SUM(CASE 
        WHEN VTYP IN (6, 8, 66,67) THEN 
            CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END 
        ELSE 0 
    END) AS TOTAL_VAMT

FROM 
    LEDGER L
WHERE 
   VDT between @SAUDA_DATE and @SAUDA_DATE +'23:59'
AND CLTCODE between @FROMPARTY and @TOPARTY
    AND NOT EXISTS (
        SELECT ACCODE 
        FROM VALANACCOUNT V (NOLOCK) 
        WHERE V.ACCODE = L.CLTCODE
    )
GROUP BY 
   CLTCODE,VTYP,vdt

) A group by 
A.CLTCODE,CONVERT(VARCHAR,A.VDT,103)
 order by 1
 end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MTF_PAYIN_ALLOC_MIS
-- --------------------------------------------------







CREATE	PROC [dbo].[CLS_MTF_PAYIN_ALLOC_MIS]
		(
		@SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)
		)

		AS

/*

DECLARE	@SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)

SET		@SAUDA_DATE = 'JAN 31 2025'
SET		@FROMPARTY = ''
SET		@TOPARTY = 'ZZZZ'

EXEC	CLS_MTF_PAYIN_ALLOC_MIS 'MAR 24 2025','','ZZZZZ'

SELECT * FROM TBL_MTR_REPORTING WHERE SAUDA_DATE ='MAR 24 2025' AND PARTY_CODE='CAD2568'   	BAJAJHFL
*/

DECLARE	@PRE_SAUDADATE	VARCHAR(11),
		@GLCODE	VARCHAR(10)

SELECT	@GLCODE = ACCODE FROM VALANACCOUNT(NOLOCK) WHERE ACNAME = 'MTF JV CONTROL'

SELECT	@PRE_SAUDADATE = LEFT(MAX(START_DATE),11)
FROM	MSAJAG..SETT_MST (NOLOCK) 
WHERE	START_DATE < @SAUDA_DATE AND SETT_TYPE='N'


SELECT	RPT_DATE = @SAUDA_DATE,
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		BSECODE,
		ISIN,
		MTF_JV_FROM_NSE_CASH_SEGMENT = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_JV_FROM_NSE_CASH_SEGMENT,0)),2)),
		QTY = SUM(QTY),
		MKTAMT = SUM(MKTAMT),
		NETAMT = SUM(NETAMT),
		MARGIN_REQUIREMENT = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MARGIN_REQUIREMENT,0)),2)),
		PAYIN_AMT = SUM(PAYIN_AMT),
		M_QTY = SUM(M_QTY),
		M_PRICE = MAX(M_PRICE),
		M_AMT = SUM(M_AMT),
		M_ALLOC_BALANCE = SUM(M_ALLOC_BALANCE),
		NF_QTY = SUM(NF_QTY),
		NF_AMT = SUM(NF_AMT),
		COLL_QTY = SUM(COLL_QTY),
		MTFCOLL_QTY = SUM(MTFCOLL_QTY),
		FRESHBQTY = SUM(FRESHBQTY),
		FRESHBUY = SUM(FRESHBUY),
		FRESHSQTY = SUM(FRESHSQTY),
		FRESHSELL = SUM(FRESHSELL),
		NETQTY = SUM(NETQTY),
		M_FRESHBQTY = SUM(M_FRESHBQTY),
		M_FRESHBUY = SUM(M_FRESHBUY),
		M_NETQTY = SUM(M_NETQTY),
		M_NETAMOUNT = SUM(M_NETAMOUNT),
		MTF_PAYIN_EXCESS_REV = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_PAYIN_EXCESS_REV,0)),2)),
		ALLOC_MISSMATCH = (CASE WHEN (/*(
			CASE 
				WHEN SUM(M_QTY) = SUM(MTFCOLL_QTY) THEN 0
				ELSE 1
			END) +*/ (
			CASE
				WHEN SUM(M_FRESHBQTY) = SUM(MTFCOLL_QTY) THEN 0
				ELSE 1
			END)) > 0 THEN 'MISSMATCH' ELSE 'MATCH'
		END),
		ALLOC_AMT_DIFF = (
			CASE 
				WHEN SUM(M_FRESHBQTY) > 0 THEN ROUND(SUM(M_AMT),2)-ROUND(SUM(M_FRESHBUY),2)
				ELSE 0
			END)
FROM	(
		/*
		SELECT	PARTY_CODE = CLTCODE,
				SCRIP_CD = '',
				SERIES = '',
				BSECODE = '',
				ISIN  = '',
				QTY = 0,
				MKTAMT = 0,
				NETAMT = 0,
				MARGIN_REQUIREMENT = 0,
				PAYIN_AMT = 0,
				M_QTY = 0,
				M_PRICE = 0,
				M_AMT = 0,
				M_ALLOC_BALANCE = 0,
				NF_QTY = 0,
				NF_AMT = 0,
				COLL_QTY = 0,
				MTFCOLL_QTY = 0,
				FRESHBQTY = 0,
				FRESHBUY = 0,
				FRESHSQTY = 0,
				FRESHSELL = 0,
				NETQTY = 0,
				M_FRESHBQTY = 0,
				M_FRESHBUY = 0,
				M_NETQTY = 0,
				M_NETAMOUNT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = SUM(CASE WHEN CHECKEDBY = 'MTF PROCESS' AND NARRATION  IN ('MTF JV FROM CASH','MTF JV FROM FO') AND VTYP = '6' THEN 
						CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END
					 END),
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = SUM(CASE WHEN NARRATION LIKE '%MTF PAYIN EXCESS REV%' THEN 
						CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END
					 END)
		FROM	LEDGER 
		WHERE	VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59' 
				AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY		
				AND VTYP in ( '6','67' )
		GROUP BY
				CLTCODE
		UNION
		
		SELECT	PARTY_CODE = CLTCODE,
				SCRIP_CD = '',
				SERIES = '',
				BSECODE = '',
				ISIN  = '',
				QTY = 0,
				MKTAMT = 0,
				NETAMT = 0,
				MARGIN_REQUIREMENT = 0,
				PAYIN_AMT = 0,
				M_QTY = 0,
				M_PRICE = 0,
				M_AMT = 0,
				M_ALLOC_BALANCE = 0,
				NF_QTY = 0,
				NF_AMT = 0,
				COLL_QTY = 0,
				MTFCOLL_QTY = 0,
				FRESHBQTY = 0,
				FRESHBUY = 0,
				FRESHSQTY = 0,
				FRESHSELL = 0,
				NETQTY = 0,
				M_FRESHBQTY = 0,
				M_FRESHBUY = 0,
				M_NETQTY = 0,
				M_NETAMOUNT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = 0,
				MTF_PAYIN = SUM(CASE WHEN NARRATION LIKE '%MTF PAYIN%' THEN 
						CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END
					 END),
				MTF_PAYIN_EXCESS_REV = 0
		FROM	LEDGER 
		WHERE	VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59' 
				AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
				AND VTYP = '66'
		GROUP BY
				CLTCODE
		
		UNION
		*/

		SELECT	PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN,
				QTY = SUM(QTY),
				MKTAMT = SUM(MKTAMT),
				NETAMT = SUM(NETAMT),
				MARGIN_REQUIREMENT = ROUND(SUM(MARGIN_REQ),2),
				PAYIN_AMT = 0,
				M_QTY = 0,
				M_PRICE = 0,
				M_AMT = 0,
				M_ALLOC_BALANCE = 0,
				NF_QTY = 0,
				NF_AMT = 0,
				COLL_QTY = 0,
				MTFCOLL_QTY = 0,
				FRESHBQTY = 0,
				FRESHBUY = 0,
				FRESHSQTY = 0,
				FRESHSELL = 0,
				NETQTY = 0,
				M_FRESHBQTY = 0,
				M_FRESHBUY = 0,
				M_NETQTY = 0,
				M_NETAMOUNT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = SUM(CASE WHEN ISNULL(CHECKEDBY,'') = 'MTF PROCESS' AND ISNULL(NARRATION,'')  IN ('MTF JV FROM CASH','MTF JV FROM FO') AND ISNULL(VTYP,'') = '6' THEN 
						CASE WHEN ISNULL(DRCR,'') = 'C' THEN ISNULL(VAMT,0) ELSE 0 END
					 END),
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = SUM(CASE WHEN ISNULL(NARRATION,'') LIKE '%MTF PAYIN EXCESS REV%' THEN 
						CASE WHEN ISNULL(DRCR,'') = 'D' THEN -ISNULL(VAMT,0) ELSE ISNULL(VAMT,0) END
					 END)
		FROM	TBL_MTF_DATA_BUY T (NOLOCK) 
				LEFT OUTER JOIN LEDGER L (NOLOCK) ON (
				VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59' 
				AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY		
				AND VTYP in ( '6','67' )
				AND L.CLTCODE = T.PARTY_CODE
				)
		WHERE	SAUDA_DATE BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59' 
				AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		GROUP BY
				PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN

		UNION

		SELECT	PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN,
				QTY = 0,
				MKTAMT = 0,
				NETAMT = 0,
				MARGIN_REQUIREMENT = 0,
				PAYIN_AMT = SUM(PAYIN_AMT),
				M_QTY = SUM(M_QTY),
				M_PRICE,
				M_AMT = SUM(M_AMT),
				M_ALLOC_BALANCE = SUM(M_ALLOC_BALANCE),
				NF_QTY = SUM(NF_QTY),
				NF_AMT = SUM(NF_AMT),
				COLL_QTY = SUM(COLL_QTY),
				MTFCOLL_QTY = 0,
				FRESHBQTY = 0,
				FRESHBUY = 0,
				FRESHSQTY = 0,
				FRESHSELL = 0,
				NETQTY = 0,
				M_FRESHBQTY = 0,
				M_FRESHBUY = 0,
				M_NETQTY = 0,
				M_NETAMOUNT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = 0,
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = 0
		FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC(NOLOCK)
		WHERE	SAUDA_DATE BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59' 
				AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
		GROUP BY
				PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN,
				M_PRICE
		HAVING	SUM(M_QTY) > 0 OR SUM(COLL_QTY) > 0
				
		UNION

		SELECT	PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN,
				QTY = 0,
				MKTAMT = 0,
				NETAMT = 0,
				MARGIN_REQUIREMENT = 0,
				PAYIN_AMT = 0,
				M_QTY = 0,
				M_PRICE = 0,
				M_AMT = 0,
				M_ALLOC_BALANCE = 0,
				NF_QTY = 0,
				NF_AMT = 0,
				COLL_QTY = 0,
				MTFCOLL_QTY = SUM(QTY),
				FRESHBQTY = 0,
				FRESHBUY = 0,
				FRESHSQTY = 0,
				FRESHSELL = 0,
				NETQTY = 0,
				M_FRESHBQTY = 0,
				M_FRESHBUY = 0,
				M_NETQTY = 0,
				M_NETAMOUNT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = 0,
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = 0
		FROM	TBL_PRODUCT_HOLD_DATA(NOLOCK)
		WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
				AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
				AND HOLDFLAG = 'MTFCOLL'
				AND SETT_NO = 'MMQTY'
		GROUP BY
				PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN

		UNION

		SELECT	PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN,
				QTY = 0,
				MKTAMT = 0,
				NETAMT = 0,
				MARGIN_REQUIREMENT = 0,
				PAYIN_AMT = 0,
				M_QTY = 0,
				M_PRICE = 0,
				M_AMT = 0,
				M_ALLOC_BALANCE = 0,
				NF_QTY = 0,
				NF_AMT = 0,
				COLL_QTY = 0,
				MTFCOLL_QTY = 0,
				FRESHBQTY = SUM(FRESHBQTY),
				FRESHBUY = SUM(FRESHBUY),
				FRESHSQTY = SUM(FRESHSQTY),
				FRESHSELL = SUM(FRESHSELL),
				NETQTY = SUM(NETQTY),
				M_FRESHBQTY = SUM(M_FRESHBQTY),
				M_FRESHBUY = SUM(M_FRESHBUY),
				M_NETQTY = SUM(M_NETQTY),
				M_NETAMOUNT = SUM(M_NETAMOUNT),
				MTF_JV_FROM_NSE_CASH_SEGMENT = 0,
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = 0
		FROM	TBL_MTR_REPORTING(NOLOCK)
		WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
				AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
		GROUP BY
				PARTY_CODE,
				SCRIP_CD,
				SERIES,
				BSECODE,
				ISIN
		--HAVING	SUM(M_FRESHBQTY) > 0
		) A
WHERE PARTY_CODE <> @GLCODE
GROUP BY
	PARTY_CODE,
	SCRIP_CD,
	SERIES,
	BSECODE,
	ISIN
HAVING SUM(PAYIN_AMT) > 0
--HAVING SUM(MTF_JV_FROM_NSE_CASH_SEGMENT) <> 0 --AND ((CASE WHEN ROUND(SUM(MTF_PROPABALE_PAYIN),2) > ROUND(SUM(MARGIN_REQUIREMENT),2) THEN ROUND(SUM(MARGIN_REQUIREMENT),2) ELSE ROUND(SUM(MTF_PROPABALE_PAYIN),2) END)-ROUND(SUM(MTF_PAYIN),2)) > 0
ORDER BY 
	PARTY_CODE,
	SCRIP_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MTF_PAYIN_MIS
-- --------------------------------------------------





CREATE	PROC [dbo].[CLS_MTF_PAYIN_MIS]
		(
		@SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)
		)

		AS

/*

DECLARE	@SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)

SET		@SAUDA_DATE = 'JAN 31 2025'
SET		@FROMPARTY = ''
SET		@TOPARTY = 'ZZZZ'
*/
DECLARE @GLCODE	VARCHAR(10)
SELECT	@GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'


SELECT	RPT_DATE = @SAUDA_DATE,
		PARTY_CODE,
		MTF_JV_FROM_NSE_CASH_SEGMENT = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_JV_FROM_NSE_CASH_SEGMENT,0)),2)),
		MTF_INTREST = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_INTREST,0)),2)),
		MTF_MTM = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_MTM,0)),2)),
		MTF_MTM_REV = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_MTM_REV,0)),2)),
		MTF_PROPABALE_PAYIN = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_PROPABALE_PAYIN,0)),2)),
		MARGIN_REQUIREMENT = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MARGIN_REQUIREMENT,0)),2)),
		MTF_MIN_OF_REGQ_PROB_PAYIN = (CASE WHEN ROUND(SUM(ISNULL(MTF_PROPABALE_PAYIN,0)),2) > ROUND(SUM(ISNULL(MARGIN_REQUIREMENT,0)),2) THEN CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MARGIN_REQUIREMENT,0)),2)) ELSE CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_PROPABALE_PAYIN,0)),2)) END),
		MTF_ACTUAL_PAYIN = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_PAYIN,0)),2)),
		MTF_MISSMATCH_PAYIN = CONVERT(NUMERIC(18,2),ROUND(((CASE WHEN ROUND(SUM(ISNULL(MTF_PROPABALE_PAYIN,0)),2) > ROUND(SUM(ISNULL(MARGIN_REQUIREMENT,0)),2) THEN ROUND(SUM(ISNULL(MARGIN_REQUIREMENT,0)),2) ELSE ROUND(SUM(ISNULL(MTF_PROPABALE_PAYIN,0)),2) END)-ROUND(SUM(ISNULL(MTF_PAYIN,0)),2)),2)),
		MTF_PAYIN_EXCESS_REV = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_PAYIN_EXCESS_REV,0)),2)),
		--MTF_MTM_EXCESS_REV = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_MTM_EXCESS_REV,0)),2)),
		MTF_CASHCOLL_EXCESS_REV = CONVERT(NUMERIC(18,2),ROUND(SUM(ISNULL(MTF_CASHCOLL_EXCESS_REV,0)),2))
FROM	(
		SELECT	PARTY_CODE = CLTCODE,
				MARGIN_REQUIREMENT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = SUM(CASE WHEN CHECKEDBY = 'MTF PROCESS' AND NARRATION  IN ('MTF JV FROM CASH','MTF JV FROM FO') AND VTYP = '6' THEN 
						CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END
					 END),
				MTF_INTREST = ISNULL(SUM(CASE WHEN NARRATION LIKE '%6.INTEREST ADJUSTMENT%' AND VTYP = '6' AND DRCR = 'D' THEN VAMT 
						ELSE 0 END),0),
				MTF_MTM = SUM(CASE WHEN NARRATION LIKE '8.BEING THE T DAY MTM TRF FROM CASH COLL LEDGER' AND VTYP = '67' THEN 
						CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END
					 END),
				--MTF_MTM_REV = SUM(CASE WHEN NARRATION LIKE '%MTF MTM REV%' AND VTYP = '67' THEN 
																											
				MTF_MTM_REV = SUM(CASE WHEN NARRATION IN ('4.BEING THE OPENING BALANCE JV TRF TO CASH COLL','9.MTF MTM REV') AND VTYP = '67' THEN 
						CASE WHEN DRCR = 'D' THEN VAMT ELSE VAMT END
					 END),
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = SUM(CASE WHEN NARRATION LIKE '%MTF PAYIN EXCESS REV%' THEN 
						CASE WHEN DRCR = 'D' THEN -VAMT ELSE VAMT END
					 END),
				MTF_PROPABALE_PAYIN = ISNULL(SUM(CASE WHEN CHECKEDBY = 'MTF PROCESS' AND NARRATION IN ('MTF JV FROM CASH','MTF JV FROM FO') AND VTYP = '6' THEN 
						CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END
					 END),0)
					 + ISNULL(SUM(CASE WHEN NARRATION LIKE '%6.INTEREST ADJUSTMENT%' AND VTYP = '6' AND DRCR = 'D' THEN -VAMT 
						ELSE 0
					 END),0)
					 + ISNULL(SUM(CASE WHEN NARRATION LIKE '%8.BEING THE T DAY MTM TRF FROM CASH COLL LEDGER%' AND VTYP = '67' THEN 
						CASE WHEN DRCR = 'D' THEN -VAMT ELSE -VAMT END
					 END),0)
					 + ISNULL(SUM(CASE WHEN NARRATION IN ('4.BEING THE OPENING BALANCE JV TRF TO CASH COLL','9.MTF MTM REV') AND VTYP = '67' THEN 
						CASE WHEN DRCR = 'D' THEN VAMT ELSE VAMT END
					 END),0),
				--MTF_MTM_EXCESS_REV = 0,
				MTF_CASHCOLL_EXCESS_REV = 0
		FROM	LEDGER 
		WHERE	VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
				AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY		
				AND VTYP in ( '6','67' )
		GROUP BY
				CLTCODE
		UNION

		SELECT	PARTY_CODE = CLTCODE,
				MARGIN_REQUIREMENT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = 0,
				MTF_INTREST = 0,
				MTF_MTM = 0,
				MTF_MTM_REV = 0,
				MTF_PAYIN = SUM(CASE WHEN NARRATION LIKE '%MTF PAYIN%' THEN 
						CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END
					 END),
				MTF_PAYIN_EXCESS_REV = 0,
				MTF_PROPABALE_PAYIN = 0,
				--MTF_MTM_EXCESS_REV = 0,
				MTF_CASHCOLL_EXCESS_REV = 0
		FROM	LEDGER 
		WHERE	VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
				AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
				AND VTYP = '66'
		GROUP BY
				CLTCODE
		
		UNION

		SELECT	PARTY_CODE,
				MARGIN_REQUIREMENT = ROUND(SUM(MARGIN_REQ),2),
				MTF_JV_FROM_NSE_CASH_SEGMENT = 0,
				MTF_INTREST = 0,
				MTF_MTM = 0,
				MTF_MTM_REV = 0,
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = 0,
				MTF_PROPABALE_PAYIN = 0,
				--MTF_MTM_EXCESS_REV = 0,
				MTF_CASHCOLL_EXCESS_REV = 0
		FROM	TBL_MTF_DATA_BUY 
		WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
				AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		GROUP BY
				PARTY_CODE

		UNION

		SELECT	PARTY_CODE = CLTCODE,
				MARGIN_REQUIREMENT = 0,
				MTF_JV_FROM_NSE_CASH_SEGMENT = 0,
				MTF_INTREST = 0,
				MTF_MTM = 0,
				MTF_MTM_REV = 0,
				MTF_PAYIN = 0,
				MTF_PAYIN_EXCESS_REV = 0,
				MTF_PROPABALE_PAYIN = 0,
				--MTF_MTM_EXCESS_REV = SUM(VAMT),
				MTF_CASHCOLL_EXCESS_REV = 0
		FROM	ACCOUNT..LEDGER 
		WHERE	VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
				AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
				AND VTYP = '6'
				AND Narration = 'MTF JV FROM MTM EXCESS REV'
				AND DRCR = 'C'
		GROUP BY
				CLTCODE				
		) A
WHERE PARTY_CODE <> @GLCODE
GROUP BY
	PARTY_CODE
HAVING SUM(MTF_JV_FROM_NSE_CASH_SEGMENT) <> 0 --AND ((CASE WHEN ROUND(SUM(MTF_PROPABALE_PAYIN),2) > ROUND(SUM(MARGIN_REQUIREMENT),2) THEN ROUND(SUM(MARGIN_REQUIREMENT),2) ELSE ROUND(SUM(MTF_PROPABALE_PAYIN),2) END)-ROUND(SUM(MTF_PAYIN),2)) > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_ACCALLPARTYLEDVOUCHERDISP
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RPT_ACCALLPARTYLEDVOUCHERDISP]            
 @VTYP SMALLINT ,            
 @VNO VARCHAR (12),            
 @VDT VARCHAR(12) ,            
 @BOOKTYPE VARCHAR(2),            
 @BRANCH VARCHAR(10),            
 @CLTCODE VARCHAR(10)            
            
AS   

 IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0  
  BEGIN  
   SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)  
  END  
 
      
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'            
BEGIN            
 SELECT    
  VAMT, L.VTYP, L.VNO, L.VDT, L.DRCR, CLTCODE, ACNAME,  L.LNO,   
  DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103), PARTY_CODE
 FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO LEFT OUTER JOIN MARGINLEDGER ML ON ML.VTYP = L.VTYP AND ML.BOOKTYPE = L.BOOKTYPE AND ML.VNO = L.VNO         
  AND L.LNO = ML.LNO 
 WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(L.VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
 ORDER BY   
  L.DRCR DESC , L.LNO             
END            
ELSE            
BEGIN            
  SELECT    
  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,             
  DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103)              
  FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO,            
  LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE            
  WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
  AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO            
  AND COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))            
  ORDER BY   
  L2.DRCR DESC , L2.LNO             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TRIALBALANCE_WITHOUTEXCHANGE
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_TRIALBALANCE_WITHOUTEXCHANGE]
	@FR_DATE VARCHAR(25), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(25), /* AS ON DATE ENTERED BY USER */
	@VIEWOPTION VARCHAR(10), /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

--ALTER TABLE #FORMULA_CLIENT_MASTER
-- ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)

CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BROKER' AND @BRANCHCODE <> ''
BEGIN
	SET @STATUSID = 'BRANCH'
	SET @STATUSNAME = @BRANCHCODE
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


CREATE TABLE #TB
(
	CLTCODE VARCHAR(10)
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

	ALTER TABLE #TB
	ADD
		AMOUNT MONEY

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300),
	@DISPLAY_CLIENT_TOTAL VARCHAR(300)
	
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = 'AMOUNT'
		SET @DISPLAY_CLIENT_TOTAL = 'AMOUNT'
		SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(AMOUNT)'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT,VDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
		
		SET @NET_AMOUNT_PARAMETER = 'VDTBAL_OPBAL = SUM(OPENING_AMOUNT), VDTBAL_DATES_CREDIT = SUM(PERIOD_CREDIT), VDTBAL_DATES_DEBIT = SUM(PERIOD_DEBIT), VDTBAL = SUM(AMOUNT)'
	END
END
ELSE
BEGIN
	--SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL_OPBAL = SUM(OPENING_AMOUNT), EDTBAL_DATES_CREDIT = SUM(PERIOD_CREDIT), EDTBAL_DATES_DEBIT = SUM(PERIOD_DEBIT), EDTBAL = SUM(AMOUNT)'

	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = 'AMOUNT'
		SET @DISPLAY_CLIENT_TOTAL = 'AMOUNT'
		SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(AMOUNT)'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT, EDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
		SET @DISPLAY_CLIENT_TOTAL = '0, 0, 0, -AMOUNT'
	END
END


IF UPPER(@VIEWOPTION) = 'GL'
BEGIN
	IF UPPER(@STATUSID) = 'BROKER'
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
	
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
	ELSE
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
		AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE)
		
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
END	


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + "WHERE ACCAT <> 4 "
ELSE IF UPPER(@VIEWOPTION) = 'PARTY'
	SET @@SQL = @@SQL + "WHERE ACCAT = 4 "	
ELSE IF UPPER(@VIEWOPTION) = 'ALL'
	SET @@SQL = @@SQL + "WHERE ACCAT = ACCAT "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "
	
EXEC(@@SQL)	




IF UPPER(@STATUSID) = 'BROKER'
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', ''
END
ELSE
BEGIN
	--SELECT @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT 
	INSERT INTO #TB
	--EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE', ''
	EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', ''
	
END



SET @@SQL = "INSERT INTO ACCOUNT.." + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + " SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', '" + @EXCHANGE + "','" +  @SEGMENT + "', " + @NET_AMOUNT_PARAMETER + ", ACCAT = 0, GRPCODE = '', GRPNAME = '' "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB WHERE CLTCODE = ''  "
IF @SHOWZEROBAL = 'Y'
	SET @@SQL = @@SQL + "	AND ISNULL(AMOUNT, 0) <> 0 "
SET @@SQL = @@SQL + "	GROUP BY CLTCODE "
IF @SORT_BY = 'ACNAME'
SET @@SQL = @@SQL + "		ORDER BY ACNAME "
ELSE
SET @@SQL = @@SQL + "		ORDER BY TB.CLTCODE "




EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_INTEROP_MTF
-- --------------------------------------------------
  
CREATE PROC [dbo].[DELIVERY_INTEROP_MTF]  
(  
 @SAUDA_DATE DATETIME  
)   
AS  
  
-- EXEC DELIVERY_INTEROP_MTF 'OCT 27 2022'  
DECLARE @OTHER_SETT_TYPE VARCHAR(2),  
  @OTHER_SETT_NO VARCHAR(7),  
  @Start_Date VARCHAR(11),  
  @CLEARINGCODE VARCHAR(10),  
  @GROSS_NET_FLAG VARCHAR(1)  
     
SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING  
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
IF @CLEARINGCODE = 'NSCCL'  
BEGIN  
 SELECT @OTHER_SETT_NO = SETT_NO FROM MSAJAG.DBO.SETT_MST   
 WHERE START_DATE = @SAUDA_DATE AND SETT_tYPE = 'N'  
END  
  
IF @CLEARINGCODE = 'ICCL'  
BEGIN  
 SELECT @OTHER_SETT_NO = SETT_NO FROM BSEDB_AB.DBO.SETT_MST   
 WHERE START_DATE = @SAUDA_DATE AND SETT_tYPE = 'D'  
END  
  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES,   
INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),  
QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN  
INTO #NSEDEL  
FROM MTFTRADE.DBO.TBL_PRODUCT_POSITION, MSAJAG.DBO.OWNER  
WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRNSE'  
AND SAUDA_DATE = @SAUDA_DATE AND 1 = 2   
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, MEMBERCODE,ISIN  
  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD=BSECODE, SERIES='BSE',   
INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),  
QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN  
INTO #BSEDEL  
FROM MTFTRADE.DBO.TBL_PRODUCT_POSITION, .BSEDB_AB.DBO.OWNER  
WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRBSE'   
AND SAUDA_DATE = @SAUDA_DATE AND 1 = 2   
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, BSECODE, MEMBERCODE,ISIN   
  
SELECT * INTO #MTFPOS FROM MTFTRADE.DBO.TBL_PRODUCT_POSITION   
WHERE SAUDA_DATE = @SAUDA_DATE AND SETT_NO <> '2000000'  
  
IF @CLEARINGCODE = ''  
BEGIN  
 INSERT INTO #NSEDEL  
 SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES,   
 INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),  
 QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN  
 FROM #MTFPOS, MSAJAG.DBO.OWNER  
 WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRNSE'  
 AND SAUDA_DATE = @SAUDA_DATE  
 GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, MEMBERCODE,ISIN  
  
 INSERT INTO #BSEDEL  
 SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD=BSECODE, SERIES='BSE',   
 INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),  
 QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN   
 FROM #MTFPOS, BSEDB_AB.DBO.OWNER  
 WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRBSE'  
 GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, BSECODE, MEMBERCODE,ISIN   
END   
  
IF @CLEARINGCODE = 'NSCCL'  
BEGIN  
 UPDATE #MTFPOS SET SETT_NO=S1.SETT_NO, Sett_Type = NSE_SETT_TYPE  
 FROM MSAJAG.DBO.TBL_INTEROP_SETT_TYPE S, MSAJAG.DBO.SETT_MST S1  
 WHERE #MTFPOS.SETT_TYPE = BSE_SETT_TYPE   
 AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE   
 AND S1.SETT_TYPE = NSE_SETT_TYPE  
 AND START_DATE = @SAUDA_DATE   
   
 UPDATE #MTFPOS SET SCRIP_CD = NSE_SCRIP_CD, SERIES = NSE_SERIES FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M  
 WHERE M.ISIN = #MTFPOS.ISIN AND @Start_Date BETWEEN FROM_DATE AND TO_DATE   
 AND #MTFPOS.BSECODE = M.BSECODE AND TRANSTYPE = 'TRBSE'  
     
 UPDATE #MTFPOS SET SERIES=LEFT(SERIES,2)  
  
 INSERT INTO #NSEDEL   
 SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES,   
 INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),  
 QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN   
 FROM #MTFPOS, MSAJAG.DBO.OWNER  
 WHERE SETT_NO <> '2000000'    
 AND SAUDA_DATE = @SAUDA_DATE  
 GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, MEMBERCODE,ISIN   
   
END  
  
IF @CLEARINGCODE = 'ICCL'  
BEGIN    
 UPDATE #MTFPOS SET SETT_NO=S1.SETT_NO, Sett_Type = BSE_SETT_TYPE  
 FROM MSAJAG.DBO.TBL_INTEROP_SETT_TYPE S, BSEDB_AB.DBO.SETT_MST S1  
 WHERE #MTFPOS.SETT_TYPE = NSE_SETT_TYPE   
 AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE   
 AND S1.SETT_TYPE = BSE_SETT_TYPE  
 AND START_DATE = @SAUDA_DATE   
  
 UPDATE #MTFPOS SET BSECODE = M.BSECODE FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M  
 WHERE M.ISIN = #MTFPOS.ISIN AND @Start_Date BETWEEN FROM_DATE AND TO_DATE   
 AND #MTFPOS.SCRIP_CD = M.NSE_SCRIP_CD  
 AND #MTFPOS.SERIES = M.NSE_SERIES   
 AND TRANSTYPE = 'TRBSE'  
  
 INSERT INTO #BSEDEL   
 SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD=BSECODE, SERIES='BSE',   
 INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),  
 QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN   
 FROM #MTFPOS, BSEDB.DBO.OWNER  
 WHERE SETT_NO <> '2000000'    
 GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, BSECODE, MEMBERCODE,ISIN   
END   
  
DELETE FROM NSE_DELIVERYCLT_MTF  
WHERE SETT_NO IN (SELECT SETT_NO FROM #NSEDEL  
     WHERE NSE_DELIVERYCLT_MTF.SETT_NO = #NSEDEL.Sett_NO  
     AND NSE_DELIVERYCLT_MTF.SETT_TYPE = #NSEDEL.Sett_Type)  
  
INSERT INTO NSE_DELIVERYCLT_MTF  
(Sett_No,Sett_Type,Scrip_Cd,Series,Party_Code,Qty,Inout,Branch_Cd,Partipantcode,I_ISIN)  
SELECT Sett_No,Sett_Type,Scrip_Cd,Series,Party_Code,Qty,Inout,Branch_Cd,Partipantcode,I_ISIN FROM #NSEDEL  
  
DELETE FROM BSE_DELIVERYCLT_MTF  
WHERE SETT_NO IN (SELECT SETT_NO FROM #BSEDEL  
     WHERE BSE_DELIVERYCLT_MTF.SETT_NO = #BSEDEL.Sett_NO  
     AND BSE_DELIVERYCLT_MTF.SETT_TYPE = #BSEDEL.Sett_Type)  
  
INSERT INTO BSE_DELIVERYCLT_MTF (Sett_No,Sett_Type,Scrip_Cd,Series,Party_Code,Qty,Inout,Branch_Cd,Partipantcode,I_ISIN)  
SELECT Sett_No,Sett_Type,Scrip_Cd,Series,Party_Code,Qty,Inout,Branch_Cd,Partipantcode,I_ISIN FROM #BSEDEL   
  
IF CONVERT(DATETIME, @SAUDA_DATE) >= 'AUG 28 2020'  
BEGIN  
 EXEC  MSAJAGDEMAT.dbo.PROC_MTF_PLD_DATA @SAUDA_DATE   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELIVERY_INTEROP_MTF_BKUP_25Nov2022
-- --------------------------------------------------


CREATE PROC [dbo].[DELIVERY_INTEROP_MTF_BKUP_25Nov2022]
(
	@SAUDA_DATE	DATETIME
) 
AS

--- EXEC DELIVERY_INTEROP_MTF 'JUN 27 2019'
DECLARE @OTHER_SETT_TYPE VARCHAR(2),
		@OTHER_SETT_NO	VARCHAR(7),
		@START_DATE VARCHAR(11),
		@CLEARINGCODE	VARCHAR(10),
		@GROSS_NET_FLAG	VARCHAR(1)
		 
SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

IF @CLEARINGCODE = 'NSCCL'
BEGIN
	SELECT @OTHER_SETT_NO = SETT_NO FROM MSAJAG.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE	AND SETT_TYPE = 'N'
END

IF @CLEARINGCODE = 'ICCL'
BEGIN
	SELECT @OTHER_SETT_NO = SETT_NO FROM ANAND.BSEDB_AB.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE	AND SETT_TYPE = 'D'
END

SELECT SETT_NO, SETT_TYPE, SCRIP_CD, SERIES, PARTY_CODE,
QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END), 
BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN
INTO #NSEDEL
FROM MTFTRADE.DBO.TBL_PRODUCT_POSITION, MSAJAG.DBO.OWNER
WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRNSE'
AND SAUDA_DATE = @SAUDA_DATE AND 1 = 2 
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, MEMBERCODE,ISIN

SELECT SETT_NO, SETT_TYPE,  SCRIP_CD=BSECODE, SERIES='BSE', PARTY_CODE,
QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)),
INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END), 
BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN
INTO #BSEDEL
FROM MTFTRADE.DBO.TBL_PRODUCT_POSITION, ANAND.BSEDB_AB.DBO.OWNER
WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRBSE' 
AND SAUDA_DATE = @SAUDA_DATE AND 1 = 2 
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, BSECODE, MEMBERCODE,ISIN 

SELECT * INTO #MTFPOS FROM MTFTRADE.DBO.TBL_PRODUCT_POSITION 
WHERE SAUDA_DATE = @SAUDA_DATE  

DELETE FROM #MTFPOS
WHERE SETT_NO='2000000'

IF @CLEARINGCODE = ''
BEGIN
	INSERT INTO #NSEDEL
	SELECT SETT_NO, SETT_TYPE, SCRIP_CD, SERIES, PARTY_CODE,
	QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
	INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END), 
	BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN
	FROM #MTFPOS, MSAJAG.DBO.OWNER
	WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRNSE'
	AND SAUDA_DATE = @SAUDA_DATE
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, MEMBERCODE,ISIN

	INSERT INTO #BSEDEL
	SELECT SETT_NO, SETT_TYPE, SCRIP_CD=BSECODE, SERIES='BSE', PARTY_CODE,
	QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)),  
	INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN	
	FROM #MTFPOS, ANAND.BSEDB_AB.DBO.OWNER
	WHERE SETT_NO <> '2000000' AND TRANSTYPE = 'TRBSE'
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, BSECODE, MEMBERCODE,ISIN 
END 

IF @CLEARINGCODE = 'NSCCL'
BEGIN
	UPDATE #MTFPOS SET SETT_NO=@OTHER_SETT_NO, SETT_TYPE = NSE_SETT_TYPE
	FROM MSAJAG.DBO.TBL_INTEROP_SETT_TYPE S
	WHERE SETT_TYPE = BSE_SETT_TYPE 
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  

	INSERT INTO #NSEDEL 
	SELECT SETT_NO, SETT_TYPE, SCRIP_CD, SERIES, PARTY_CODE,
	QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
	INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END)
	, BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN	
	FROM #MTFPOS, MSAJAG.DBO.OWNER
	WHERE SETT_NO <> '2000000'  
	AND SAUDA_DATE = @SAUDA_DATE
	AND SETT_TYPE <>'W'
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, MEMBERCODE,ISIN 

	INSERT INTO #NSEDEL 
	SELECT SETT_NO, SETT_TYPE, SCRIP_CD, SERIES, PARTY_CODE,
	QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
	INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END)
	, BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN	
	FROM #MTFPOS, MSAJAG.DBO.OWNER
	WHERE SETT_NO <> '2000000'  
	AND SAUDA_DATE = @SAUDA_DATE
	AND SETT_TYPE = 'W'
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, MEMBERCODE,ISIN, SELL_BUY
END

IF @CLEARINGCODE = 'ICCL'
BEGIN	
	UPDATE #MTFPOS SET SETT_NO=@OTHER_SETT_NO, SETT_TYPE = BSE_SETT_TYPE
	FROM MSAJAG.DBO.TBL_INTEROP_SETT_TYPE S
	WHERE SETT_TYPE = NSE_SETT_TYPE 
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 
	
	INSERT INTO #BSEDEL 
	SELECT SETT_NO, SETT_TYPE, SCRIP_CD=BSECODE, SERIES='BSE', PARTY_CODE, 
	QTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
	INOUT = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 THEN 'O' ELSE 'I' END),
	BRANCH_CD= 'HO', PARTIPANTCODE=MEMBERCODE,I_ISIN=ISIN 
	FROM #MTFPOS, ANAND.BSEDB_AB.DBO.OWNER
	WHERE SETT_NO <> '2000000'  
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, BSECODE, MEMBERCODE,ISIN 
END 

DELETE FROM NSE_DELIVERYCLT_MTF
WHERE SETT_NO IN (SELECT SETT_NO FROM #NSEDEL
					WHERE NSE_DELIVERYCLT_MTF.SETT_NO = #NSEDEL.SETT_NO
					AND NSE_DELIVERYCLT_MTF.SETT_TYPE = #NSEDEL.SETT_TYPE)					 
					  
INSERT INTO NSE_DELIVERYCLT_MTF
SELECT SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,INOUT,QTY,BRANCH_CD,PARTIPANTCODE,I_ISIN
 FROM #NSEDEL

DELETE FROM BSE_DELIVERYCLT_MTF
WHERE SETT_NO IN (SELECT SETT_NO FROM #BSEDEL
					WHERE BSE_DELIVERYCLT_MTF.SETT_NO = #BSEDEL.SETT_NO
					AND BSE_DELIVERYCLT_MTF.SETT_TYPE = #BSEDEL.SETT_TYPE)

INSERT INTO BSE_DELIVERYCLT_MTF
SELECT * FROM #BSEDEL 

IF CONVERT(DATETIME,@SAUDA_DATE) >= CONVERT(DATETIME,'AUG 28 2020')
BEGIN
	EXEC ANGELDEMAT.MSAJAG.dbo.PROC_MTF_PLD_DATA @SAUDA_DATE
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DRCRNOTEUPLOAD_BULK
-- --------------------------------------------------



CREATE PROC [dbo].[DRCRNOTEUPLOAD_BULK]            
 @FNAME VARCHAR(100),              
 @UNAME VARCHAR(25),              
 @VTYP SMALLINT,              
 @BOOKTYPE VARCHAR(2),              
 @USERCAT INT = 0             
AS              

/*           select * from ledger where vno = '200904150003' and vtyp = 6  
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'              
 EXEC DRCRNOTEUPLOAD_BULK 'e:\Backoffice\DrCrNotes\JV5_BRANCH.csv', 'TEST', 6, '01', 388              
commit  
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'              
*/              
 SET NOCOUNT ON              
              
 DECLARE              
  @@ERROR_COUNT AS INT,              
  @@SQL AS VARCHAR(2000),              
  @@BACKDAYS INT,
  @@BACKDATE DATETIME,    
  @@FUTUREDATE DATETIME,    
  @@BRANCHFLAG TINYINT    
    
           
              
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/              
 IF LTRIM(RTRIM(@FNAME)) = ''              
  BEGIN              
   SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'              
   RETURN              
  END              
              
 CREATE TABLE #FEXIST              
  (F1 INT, F2 INT, F3 INT)              
               
 SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "              
 EXEC (@@SQL)              
              
 SELECT @@ERROR_COUNT = F1 FROM #FEXIST              
 IF @@ERROR_COUNT = 0              
  BEGIN              
   SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'              
   DROP TABLE #FEXIST              
   RETURN              
  END              
              
 BEGIN TRAN              
              
 SELECT               
  @@ERROR_COUNT = COUNT(1)               
 FROM              
  (SELECT               
   U_FILENAME               
  FROM               
   V2_UPLOADED_FILES              
  WHERE               
   U_FILENAME = @FNAME               
   AND U_MODULE = 'DRCR NOTE UPLOAD') A              
              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME              
   ROLLBACK TRAN              
   RETURN              
  END              
              
              
 CREATE TABLE #RECPAY_TABLE_TMP              
 (              
  SRNO INT,              
  VVDT VARCHAR(10),              
  EEDT VARCHAR(10),              
  CLTCODE VARCHAR(10),              
  DRCR VARCHAR(1),              
  AMOUNT MONEY,              
  NARRATION VARCHAR(500),              
  BRANCHCODE VARCHAR(10),            
  L1_SRNO VARCHAR(5)                
 )              
              
 CREATE TABLE [#RECPAY_TABLE]              
 (              
  SRNO INT,              
  VVDT VARCHAR(10),              
  EEDT VARCHAR(10),              
  CLTCODE VARCHAR(10),              
  DRCR VARCHAR(1),              
  AMOUNT MONEY,              
  NARRATION VARCHAR(500),              
  BRANCHCODE VARCHAR(10),              
  L1_SRNO VARCHAR(5),            
  SNO INT IDENTITY (1, 1) NOT NULL ,              
  VDT DATETIME NULL ,              
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),              
  EDT DATETIME NULL ,              
  VNO VARCHAR (12)  NULL ,              
  ACNAME VARCHAR (100)  NULL ,              
  FYSTART DATETIME NULL,              
  FYEND DATETIME NULL,              
  COSTCODE SMALLINT NULL,              
  LNO SMALLINT NOT NULL DEFAULT(0)              
 ) ON [PRIMARY]              
              
 CREATE TABLE [#RECPAY_TABLE_LNO]              
 (              
  SNO INT ,              
  LNO INT IDENTITY (1, 1) NOT NULL              
 ) ON [PRIMARY]              
              
 SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "              
 EXEC(@@SQL)              
            
--NEW            
SELECT @@ERROR_COUNT = COUNT(1) FROM            
(            
        
SELECT R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT            
FROM             
#RECPAY_TABLE_TMP R,             
(SELECT SRNO, L1_SRNO, R1_COUNT = COUNT(1) FROM #RECPAY_TABLE_TMP GROUP BY SRNO, L1_SRNO HAVING COUNT(1) > 1) R1            
WHERE R.SRNO = R1.SRNO         
AND R.L1_SRNO = R1.L1_SRNO            
GROUP BY R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT            
HAVING COUNT(1) <> R1_COUNT            
) A            
            
        
IF  @@ERROR_COUNT > 0             
BEGIN            
   SELECT RESULT = 'CLIENT CODE SHOULD NOT DIFFERENCE WHETHER COST CENTER BREAK UP! '               
   ROLLBACK TRAN           
   RETURN            
END             
            
            
--NEW            
            
         
  INSERT INTO V2_UPLOADED_FILES              
  SELECT              
  @FNAME,              
  @FNAME,              
  COUNT(1),              
  'B',              
  GETDATE(),              
  @UNAME,              
  'DRCR NOTE UPLOAD'          
              
 INSERT INTO #RECPAY_TABLE              
  (SRNO,              
  VVDT,              
  EEDT,              
  CLTCODE,              
  DRCR,              
  AMOUNT,              
  NARRATION,              
  BRANCHCODE,            
  L1_SRNO)              
 SELECT              
  SRNO,              
  VVDT,              
  EEDT,              
  UPPER(CLTCODE),              
  DRCR,              
  AMOUNT,              
  LEFT(NARRATION, 234),              
  BRANCHCODE,            
  L1_SRNO              
 FROM #RECPAY_TABLE_TMP     
    
SELECT @@BRANCHFLAG = BRANCHFLAG FROM PARAMETER, #RECPAY_TABLE WHERE   
CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR  
              
    
	 

IF @@BRANCHFLAG = 1    
BEGIN    
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = C.COSTCODE              
      FROM ACMAST A, PARAMETER P, COSTMAST C              
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR             
      AND A.ACCAT IN ('3','4','104')              
      AND A.BRANCHCODE = C.COSTNAME              
      AND A.BRANCHCODE <> 'ALL'              
              
              
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = C.COSTCODE              
      FROM ACMAST A, PARAMETER P, COSTMAST C              
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR     
      AND A.ACCAT IN ('3','4','104')              
      AND #RECPAY_TABLE.BRANCHCODE = C.COSTNAME              
      AND A.BRANCHCODE = 'ALL'              
      AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'              
      AND #RECPAY_TABLE.COSTCODE IS NULL              
              
              
              
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')              
      FROM ACMAST A, PARAMETER P              
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR         
      AND A.ACCAT IN ('3','4','104')              
      AND A.BRANCHCODE = 'ALL'              
      AND #RECPAY_TABLE.BRANCHCODE = 'ALL'              
      AND #RECPAY_TABLE.COSTCODE IS NULL   
	  
	  ---SELECT * INTO TMP_S FROM #RECPAY_TABLE
	   
END    
    
IF @@BRANCHFLAG = 0    
BEGIN    
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = 0    
      FROM ACMAST A, PARAMETER P    
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR         
      AND A.ACCAT IN ('3','4','104')              
END   



 
 ---------------------------VALIDATION FOR INACTIVE CLIENTS FROM CLIENT5---------------------  
 /*
 UPDATE   
  #RECPAY_TABLE   
  SET UPDFLAG = 'N'   
 FROM ( SELECT   
  PARTY_CODE,   
  INACTIVEFROM   
 FROM MSAJAG.DBO.CLIENT5 C5 WITH(NOLOCK),   
  MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)   
 WHERE C2.CL_CODE = C5.CL_CODE   
  AND C2.PARTY_CODE IN (SELECT CLTCODE FROM #RECPAY_TABLE)   
  AND INACTIVEFROM <= GETDATE()) C   
 WHERE CLTCODE = C.PARTY_CODE  
              */
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/              
              
 DECLARE              
  @@STD_DATE VARCHAR(11),              
  @@LST_DATE VARCHAR(11),              
  @@VNOMETHOD INT,              
  @@ACNAME CHAR(100),              
  @@MICRNO VARCHAR(10),              
  @@DRCR VARCHAR(1)              
              
              
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/              
  
DECLARE              
  @@NEWVNO AS VARCHAR(12),              
  @@VDT AS VARCHAR(11),              
  @@LNOCUR AS CURSOR,              
  @@LNOVNO AS INT,              
  @@NOREC AS INT              
              
 DECLARE              
  @@MAXVNO AS VARCHAR(12),              
  @@VNO AS VARCHAR(12),              
  @@RCOUNT AS INT              
 SELECT TOP 1              
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)              
 FROM              
  #RECPAY_TABLE  
  
 SELECT TOP 1              
  @@VNOMETHOD = VNOFLAG,              
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),              
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)              
 FROM              
  PARAMETER              
 WHERE              
  @@VDT BETWEEN SDTCUR AND LDTCUR  
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN @@STD_DATE AND @@LST_DATE              
              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'DATE MISMATCH'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE FROM V2_UPLOADED_FILES              
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END              
              
/* '--------------------------UPDATE OF COST CODE ------------------------*/              
IF @@BRANCHFLAG = 1    
BEGIN    
 UPDATE #RECPAY_TABLE              
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')              
 WHERE COSTCODE IS NULL              
END    
              
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)              
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END    

/*--------------------------VALIDATION FOR EDT SHOULD NOT BE LESS THAN VDT ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE EDT < VDT
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE VOUCHERS ARE HAVING EFFECTIVE DATE LESS THAN VOUCHER DATE'
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END   

/*--------------------------VALIDATION FOR AMOUNT LESS THAN OT EQUAL TO 0 ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM  #RECPAY_TABLE WHERE AMOUNT <= 0 
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE ENTRIES HAVING AMOUNT LESS THAN OR EQUAL TO 0.'
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END     

/*--------------------------NARRATION SHOULD NOT BE BLANK ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM  #RECPAY_TABLE WHERE ISNULL(NARRATION, '') = ''
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE ENTRIES HAVING BLANK NARRATION.'
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END        
              
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM              
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)              
  FROM #RECPAY_TABLE              
  GROUP BY SRNO              
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END              
              
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM              
 (              
  SELECT DISTINCT              
   CLTCODE              
  FROM #RECPAY_TABLE              
  WHERE UPDFLAG = 'N'              
 ) A              
              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL              
   SELECT DISTINCT              
    CLTCODE              
   FROM #RECPAY_TABLE              
   WHERE UPDFLAG = 'N'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE FROM V2_UPLOADED_FILES              
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END              
              
              
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                  
  /*  SELECT                        
   @@BACKDAYS = ISNULL(MAX(NODAYS), -1)                        
    FROM                        
     USERWRITESTABLE                        
    WHERE                        
     USERCATEGORY = @USERCAT                        
     AND VTYP = @VTYP                        
     AND BOOKTYPE = @BOOKTYPE 
             
    IF @@BACKDAYS >= 0
	BEGIN          
    SELECT                        
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS,                        
	 @@FUTUREDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109))

    SELECT                        
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                        
    FROM                        
     #RECPAY_TABLE                        
    WHERE                        
     VDT < @@BACKDATE OR VDT > @@FUTUREDATE

    IF @@ERROR_COUNT > 0                        
     BEGIN                        
      SELECT                        
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED OR FUTURE DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'                        
      DROP TABLE #RECPAY_TABLE_TMP                        
      DROP TABLE #RECPAY_TABLE                        
      ROLLBACK TRAN                        
      DELETE FROM V2_UPLOADED_FILES                        
      WHERE                        
       U_FILENAME = @FNAME                        
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                        
      RETURN                        
     END
	END
	ELSE
	BEGIN
	SELECT                        
      'THE USER WHO IS TRYING TO UPLOAD THE FILE DOSENT HAVE PERMISSION', 'NA','NA'
      DROP TABLE #RECPAY_TABLE_TMP                        
      DROP TABLE #RECPAY_TABLE                        
      ROLLBACK TRAN                        
      DELETE FROM V2_UPLOADED_FILES                        
      WHERE                        
       U_FILENAME = @FNAME                        
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                        
      RETURN   
	END   */  

/* -------------Reset SNO -----------------------------*/

CREATE TABLE #SNO
(
	SRNO INT,
	SNO INT IDENTITY(1,1)
)

INSERT INTO #SNO(SRNO)
SELECT DISTINCT SRNO FROM #RECPAY_TABLE
ORDER BY SRNO

UPDATE R SET R.SRNO = S.SNO FROM #RECPAY_TABLE R, #SNO S
WHERE R.SRNO = S.SRNO
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/              
            
 SELECT              
  @@NOREC = COUNT(DISTINCT SRNO)              
 FROM              
  #RECPAY_TABLE     
    
 CREATE TABLE #VNO    
 (    
    LASTVNO VARCHAR(12)    
 )             
    
 INSERT INTO #VNO     
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC    
    
 SELECT @@VNO = LASTVNO FROM #VNO    
              
 UPDATE              
  #RECPAY_TABLE              
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)              
              
              
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/              
              
 SET @@LNOCUR = CURSOR FOR              
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE              
 OPEN @@LNOCUR              
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
 WHILE @@FETCH_STATUS = 0              
  BEGIN              
   INSERT INTO #RECPAY_TABLE_LNO              
    (SNO)              
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO              
   UPDATE RP              
    SET LNO = RL.LNO              
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL              
   WHERE RP.SNO = RL.SNO              
  TRUNCATE TABLE #RECPAY_TABLE_LNO              
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
  END              
 CLOSE @@LNOCUR              
 DEALLOCATE @@LNOCUR              
 DROP TABLE #RECPAY_TABLE_LNO              
--select * from #RECPAY_TABLE            
--return            
              
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/              
/*==============================              
      LEDGER RECORD              
==============================*/              
              
 INSERT              
 INTO LEDGER              
 SELECT              
  VTYP = @VTYP,              
  VNO,              
  EDT,              
  L1_SRNO,              
  ACNAME,              
  DRCR,              
  VAMT = SUM(AMOUNT),              
  VDT,              
  VNO1 = VNO,              
  REFNO = 0,              
  BALAMT = SUM(AMOUNT),              
  NODAYS = 0,              
CDT = GETDATE(),              
  CLTCODE,              
  BOOKTYPE = @BOOKTYPE,              
  ENTEREDBY = @UNAME,              
  PDT = GETDATE(),              
  CHECKEDBY = @UNAME,              
  ACTNODAYS = 0,              
  NARRATION              
 FROM              
  #RECPAY_TABLE              
 GROUP BY             
  VNO,              
  EDT,              
  L1_SRNO,              
  ACNAME,              
  DRCR,            
  VDT,              
  CLTCODE,            
  NARRATION            
            
            
/*==============================              
 LEDGER3 RECORD              
==============================*/              
 INSERT              
 INTO LEDGER3              
 SELECT              
  NARATNO = LNO,              
  NARRATION,              
  REFNO = 0,              
  VTYP = @VTYP,              
  VNO,              
  BOOKTYPE = @BOOKTYPE              
      FROM              
  #RECPAY_TABLE              
              
              
   /*               
IF @@BRANCHFLAG = 1    
BEGIN    
 DELETE FROM TEMPLEDGER2              
  WHERE SESSIONID = '9999999999'              
 INSERT INTO TEMPLEDGER2              
 SELECT              
  'BRANCH',              
  C.COSTNAME,              
  AMOUNT,              
  VTYP = @VTYP,              
  VNO,              
  L1_SRNO,              
  DRCR,              
 '0',              
  BOOKTYPE = @BOOKTYPE,              
  SESSIONID = '9999999999',              
  CLIENT_CODE = CLTCODE,              
  'A',              
  '0'              
 FROM              
  #RECPAY_TABLE RP,              
  COSTMAST C              
 WHERE              
  RP.COSTCODE = C.COSTCODE              
            
 DECLARE @@L2CUR AS CURSOR,              
  @@L2VNO AS VARCHAR(12)              
 SET @@L2CUR = CURSOR FOR              
  SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO              
 OPEN @@L2CUR              
 FETCH NEXT FROM @@L2CUR INTO @@L2VNO              
 WHILE @@FETCH_STATUS = 0              
  BEGIN              
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'              
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO              
  END              
  DELETE FROM TEMPLEDGER2              
   WHERE SESSIONID = '9999999999'              
  CLOSE @@L2CUR              
  DEALLOCATE @@L2CUR    
END              
   */
 COMMIT TRAN              
              
 SELECT RESULT = 'Data Uploaded Successfully'              
 UNION ALL              
 SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE              
 DROP TABLE #RECPAY_TABLE_TMP              
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DRCRNOTEUPLOAD_BULK_BAK_10052019
-- --------------------------------------------------



CREATE PROC [dbo].[DRCRNOTEUPLOAD_BULK_BAK_10052019]            
 @FNAME VARCHAR(100),              
 @UNAME VARCHAR(25),              
 @VTYP SMALLINT,              
 @BOOKTYPE VARCHAR(2),              
 @USERCAT INT = 0             
AS              

/*           select * from ledger where vno = '200904150003' and vtyp = 6  
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\Backoffice\DrCrNotes\CR TAMMANA2.csv'              
 EXEC DRCRNOTEUPLOAD_BULK 'e:\Backoffice\DrCrNotes\JV5_BRANCH.csv', 'TEST', 6, '01', 388              
commit  
 EXEC DRCRNOTEUPLOAD_BULK 'd:\Backoffice\DrCrNotes\CR TAMMANA2.csv', 'TEST', 6, '01'              
*/              
 SET NOCOUNT ON              
              
 DECLARE              
  @@ERROR_COUNT AS INT,              
  @@SQL AS VARCHAR(2000),              
  @@BACKDAYS INT,
  @@BACKDATE DATETIME,    
  @@FUTUREDATE DATETIME,    
  @@BRANCHFLAG TINYINT    
    
           
              
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/              
 IF LTRIM(RTRIM(@FNAME)) = ''              
  BEGIN              
   SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'              
   RETURN              
  END              
              
 CREATE TABLE #FEXIST              
  (F1 INT, F2 INT, F3 INT)              
               
 SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "              
 EXEC (@@SQL)              
              
 SELECT @@ERROR_COUNT = F1 FROM #FEXIST              
 IF @@ERROR_COUNT = 0              
  BEGIN              
   SELECT RESULT = 'THE FILE SPECIFIED DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'              
   DROP TABLE #FEXIST              
   RETURN              
  END              
              
 BEGIN TRAN              
              
 SELECT               
  @@ERROR_COUNT = COUNT(1)               
 FROM              
  (SELECT               
   U_FILENAME               
  FROM               
   V2_UPLOADED_FILES              
  WHERE               
   U_FILENAME = @FNAME               
   AND U_MODULE = 'DRCR NOTE UPLOAD') A              
              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME              
   ROLLBACK TRAN              
   RETURN              
  END              
              
              
 CREATE TABLE #RECPAY_TABLE_TMP              
 (              
  SRNO INT,              
  VVDT VARCHAR(10),              
  EEDT VARCHAR(10),              
  CLTCODE VARCHAR(10),              
  DRCR VARCHAR(1),              
  AMOUNT MONEY,              
  NARRATION VARCHAR(500),              
  BRANCHCODE VARCHAR(10),            
  L1_SRNO VARCHAR(5)                
 )              
              
 CREATE TABLE [#RECPAY_TABLE]              
 (              
  SRNO INT,              
  VVDT VARCHAR(10),              
  EEDT VARCHAR(10),              
  CLTCODE VARCHAR(10),              
  DRCR VARCHAR(1),              
  AMOUNT MONEY,              
  NARRATION VARCHAR(500),              
  BRANCHCODE VARCHAR(10),              
  L1_SRNO VARCHAR(5),            
  SNO INT IDENTITY (1, 1) NOT NULL ,              
  VDT DATETIME NULL ,              
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),              
  EDT DATETIME NULL ,              
  VNO VARCHAR (12)  NULL ,              
  ACNAME VARCHAR (100)  NULL ,              
  FYSTART DATETIME NULL,              
  FYEND DATETIME NULL,              
  COSTCODE SMALLINT NULL,              
  LNO SMALLINT NOT NULL DEFAULT(0)              
 ) ON [PRIMARY]              
              
 CREATE TABLE [#RECPAY_TABLE_LNO]              
 (              
  SNO INT ,              
  LNO INT IDENTITY (1, 1) NOT NULL              
 ) ON [PRIMARY]              
              
 SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "              
 EXEC(@@SQL)              
            
--NEW            
SELECT @@ERROR_COUNT = COUNT(1) FROM            
(            
        
SELECT R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT            
FROM             
#RECPAY_TABLE_TMP R,             
(SELECT SRNO, L1_SRNO, R1_COUNT = COUNT(1) FROM #RECPAY_TABLE_TMP GROUP BY SRNO, L1_SRNO HAVING COUNT(1) > 1) R1            
WHERE R.SRNO = R1.SRNO         
AND R.L1_SRNO = R1.L1_SRNO            
GROUP BY R.SRNO, R.L1_SRNO, CLTCODE, R1_COUNT            
HAVING COUNT(1) <> R1_COUNT            
) A            
            
        
IF  @@ERROR_COUNT > 0             
BEGIN            
   SELECT RESULT = 'CLIENT CODE SHOULD NOT DIFFERENCE WHETHER COST CENTER BREAK UP! '               
   ROLLBACK TRAN           
   RETURN            
END             
            
            
--NEW            
            
         
  INSERT INTO V2_UPLOADED_FILES              
  SELECT              
  @FNAME,              
  @FNAME,              
  COUNT(1),              
  'B',              
  GETDATE(),              
  @UNAME,              
  'DRCR NOTE UPLOAD'          
              
 INSERT INTO #RECPAY_TABLE              
  (SRNO,              
  VVDT,              
  EEDT,              
  CLTCODE,              
  DRCR,              
  AMOUNT,              
  NARRATION,              
  BRANCHCODE,            
  L1_SRNO)              
 SELECT              
  SRNO,              
  VVDT,              
  EEDT,              
  UPPER(CLTCODE),              
  DRCR,              
  AMOUNT,              
  LEFT(NARRATION, 234),              
  BRANCHCODE,            
  L1_SRNO              
 FROM #RECPAY_TABLE_TMP     
    
SELECT @@BRANCHFLAG = BRANCHFLAG FROM PARAMETER, #RECPAY_TABLE WHERE   
CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR  
              
    
	 

IF @@BRANCHFLAG = 1    
BEGIN    
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = C.COSTCODE              
      FROM ACMAST A, PARAMETER P, COSTMAST C              
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR             
      AND A.ACCAT IN ('3','4','104')              
      AND A.BRANCHCODE = C.COSTNAME              
      AND A.BRANCHCODE <> 'ALL'              
              
              
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = C.COSTCODE              
      FROM ACMAST A, PARAMETER P, COSTMAST C              
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR     
      AND A.ACCAT IN ('3','4','104')              
      AND #RECPAY_TABLE.BRANCHCODE = C.COSTNAME              
      AND A.BRANCHCODE = 'ALL'              
      AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'              
      AND #RECPAY_TABLE.COSTCODE IS NULL              
              
              
              
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')              
      FROM ACMAST A, PARAMETER P              
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR         
      AND A.ACCAT IN ('3','4','104')              
      AND A.BRANCHCODE = 'ALL'              
      AND #RECPAY_TABLE.BRANCHCODE = 'ALL'              
      AND #RECPAY_TABLE.COSTCODE IS NULL   
	  
	  ---SELECT * INTO TMP_S FROM #RECPAY_TABLE
	   
END    
    
IF @@BRANCHFLAG = 0    
BEGIN    
 UPDATE              
  #RECPAY_TABLE              
  SET              
   VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),              
   EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),              
   FYSTART = P.SDTCUR,              
   FYEND = P.LDTCUR,              
   UPDFLAG = 'Y',              
   ACNAME = LONGNAME,              
   #RECPAY_TABLE.COSTCODE = 0    
      FROM ACMAST A, PARAMETER P    
      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE              
      AND CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)) BETWEEN SDTCUR AND LDTCUR         
      AND A.ACCAT IN ('3','4','104')              
END   



 
 ---------------------------VALIDATION FOR INACTIVE CLIENTS FROM CLIENT5---------------------  
 /*
 UPDATE   
  #RECPAY_TABLE   
  SET UPDFLAG = 'N'   
 FROM ( SELECT   
  PARTY_CODE,   
  INACTIVEFROM   
 FROM MSAJAG.DBO.CLIENT5 C5 WITH(NOLOCK),   
  MSAJAG.DBO.CLIENT2 C2 WITH(NOLOCK)   
 WHERE C2.CL_CODE = C5.CL_CODE   
  AND C2.PARTY_CODE IN (SELECT CLTCODE FROM #RECPAY_TABLE)   
  AND INACTIVEFROM <= GETDATE()) C   
 WHERE CLTCODE = C.PARTY_CODE  
              */
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/              
              
 DECLARE              
  @@STD_DATE VARCHAR(11),              
  @@LST_DATE VARCHAR(11),              
  @@VNOMETHOD INT,              
  @@ACNAME CHAR(100),              
  @@MICRNO VARCHAR(10),              
  @@DRCR VARCHAR(1)              
              
              
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/              
  
DECLARE              
  @@NEWVNO AS VARCHAR(12),              
  @@VDT AS VARCHAR(11),              
  @@LNOCUR AS CURSOR,              
  @@LNOVNO AS INT,              
  @@NOREC AS INT              
              
 DECLARE              
  @@MAXVNO AS VARCHAR(12),              
  @@VNO AS VARCHAR(12),              
  @@RCOUNT AS INT              
 SELECT TOP 1              
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)              
 FROM              
  #RECPAY_TABLE  
  
 SELECT TOP 1              
  @@VNOMETHOD = VNOFLAG,              
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),              
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)              
 FROM              
  PARAMETER              
 WHERE              
  @@VDT BETWEEN SDTCUR AND LDTCUR  
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN @@STD_DATE AND @@LST_DATE              
              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'DATE MISMATCH'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE FROM V2_UPLOADED_FILES              
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END              
              
/* '--------------------------UPDATE OF COST CODE ------------------------*/              
IF @@BRANCHFLAG = 1    
BEGIN    
 UPDATE #RECPAY_TABLE              
  SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')              
 WHERE COSTCODE IS NULL              
END    
              
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)              
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END    

/*--------------------------VALIDATION FOR EDT SHOULD NOT BE LESS THAN VDT ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE EDT < VDT
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE VOUCHERS ARE HAVING EFFECTIVE DATE LESS THAN VOUCHER DATE'
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END   

/*--------------------------VALIDATION FOR AMOUNT LESS THAN OT EQUAL TO 0 ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM  #RECPAY_TABLE WHERE AMOUNT <= 0 
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE ENTRIES HAVING AMOUNT LESS THAN OR EQUAL TO 0.'
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END     

/*--------------------------NARRATION SHOULD NOT BE BLANK ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM  #RECPAY_TABLE WHERE ISNULL(NARRATION, '') = ''
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'SOME OF THE ENTRIES HAVING BLANK NARRATION.'
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN          
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END        
              
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM              
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)              
  FROM #RECPAY_TABLE              
  GROUP BY SRNO              
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE FROM V2_UPLOADED_FILES              
   WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END              
              
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/              
              
 SELECT @@ERROR_COUNT = COUNT(1) FROM              
 (              
  SELECT DISTINCT              
   CLTCODE              
  FROM #RECPAY_TABLE              
  WHERE UPDFLAG = 'N'              
 ) A              
              
 IF @@ERROR_COUNT > 0              
  BEGIN              
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL              
   SELECT DISTINCT              
    CLTCODE              
   FROM #RECPAY_TABLE              
   WHERE UPDFLAG = 'N'              
   DROP TABLE #RECPAY_TABLE_TMP              
   DROP TABLE #RECPAY_TABLE              
   ROLLBACK TRAN              
   DELETE FROM V2_UPLOADED_FILES              
    WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'              
   RETURN              
  END              
              
              
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                  
  /*  SELECT                        
   @@BACKDAYS = ISNULL(MAX(NODAYS), -1)                        
    FROM                        
     USERWRITESTABLE                        
    WHERE                        
     USERCATEGORY = @USERCAT                        
     AND VTYP = @VTYP                        
     AND BOOKTYPE = @BOOKTYPE 
             
    IF @@BACKDAYS >= 0
	BEGIN          
    SELECT                        
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS,                        
	 @@FUTUREDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109))

    SELECT                        
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                        
    FROM                        
     #RECPAY_TABLE                        
    WHERE                        
     VDT < @@BACKDATE OR VDT > @@FUTUREDATE

    IF @@ERROR_COUNT > 0                        
     BEGIN                        
      SELECT                        
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED OR FUTURE DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'                        
      DROP TABLE #RECPAY_TABLE_TMP                        
      DROP TABLE #RECPAY_TABLE                        
      ROLLBACK TRAN                        
      DELETE FROM V2_UPLOADED_FILES                        
      WHERE                        
       U_FILENAME = @FNAME                        
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                        
      RETURN                        
     END
	END
	ELSE
	BEGIN
	SELECT                        
      'THE USER WHO IS TRYING TO UPLOAD THE FILE DOSENT HAVE PERMISSION', 'NA','NA'
      DROP TABLE #RECPAY_TABLE_TMP                        
      DROP TABLE #RECPAY_TABLE                        
      ROLLBACK TRAN                        
      DELETE FROM V2_UPLOADED_FILES                        
      WHERE                        
       U_FILENAME = @FNAME                        
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                        
      RETURN   
	END   */  

/* -------------Reset SNO -----------------------------*/

CREATE TABLE #SNO
(
	SRNO INT,
	SNO INT IDENTITY(1,1)
)

INSERT INTO #SNO(SRNO)
SELECT DISTINCT SRNO FROM #RECPAY_TABLE
ORDER BY SRNO

UPDATE R SET R.SRNO = S.SNO FROM #RECPAY_TABLE R, #SNO S
WHERE R.SRNO = S.SRNO
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/              
            
 SELECT              
  @@NOREC = COUNT(DISTINCT SRNO)              
 FROM              
  #RECPAY_TABLE     
    
 CREATE TABLE #VNO    
 (    
    LASTVNO VARCHAR(12)    
 )             
    
 INSERT INTO #VNO     
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC    
    
 SELECT @@VNO = LASTVNO FROM #VNO    
              
 UPDATE              
  #RECPAY_TABLE              
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)              
              
              
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/              
              
 SET @@LNOCUR = CURSOR FOR              
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE              
 OPEN @@LNOCUR              
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
 WHILE @@FETCH_STATUS = 0              
  BEGIN              
   INSERT INTO #RECPAY_TABLE_LNO              
    (SNO)              
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO              
   UPDATE RP              
    SET LNO = RL.LNO              
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL              
   WHERE RP.SNO = RL.SNO              
  TRUNCATE TABLE #RECPAY_TABLE_LNO              
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO              
  END              
 CLOSE @@LNOCUR              
 DEALLOCATE @@LNOCUR              
 DROP TABLE #RECPAY_TABLE_LNO              
--select * from #RECPAY_TABLE            
--return            
              
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/              
/*==============================              
      LEDGER RECORD              
==============================*/              
              
 INSERT              
 INTO LEDGER              
 SELECT              
  VTYP = @VTYP,              
  VNO,              
  EDT,              
  L1_SRNO,              
  ACNAME,              
  DRCR,              
  VAMT = SUM(AMOUNT),              
  VDT,              
  VNO1 = VNO,              
  REFNO = 0,              
  BALAMT = SUM(AMOUNT),              
  NODAYS = 0,              
CDT = GETDATE(),              
  CLTCODE,              
  BOOKTYPE = @BOOKTYPE,              
  ENTEREDBY = @UNAME,              
  PDT = GETDATE(),              
  CHECKEDBY = @UNAME,              
  ACTNODAYS = 0,              
  NARRATION              
 FROM              
  #RECPAY_TABLE              
 GROUP BY             
  VNO,              
  EDT,              
  L1_SRNO,              
  ACNAME,              
  DRCR,            
  VDT,              
  CLTCODE,            
  NARRATION            
            
            
/*==============================              
 LEDGER3 RECORD              
==============================*/              
 INSERT              
 INTO LEDGER3              
 SELECT              
  NARATNO = LNO,              
  NARRATION,              
  REFNO = 0,              
  VTYP = @VTYP,              
  VNO,              
  BOOKTYPE = @BOOKTYPE              
      FROM              
  #RECPAY_TABLE              
              
              
              
IF @@BRANCHFLAG = 1    
BEGIN    
 DELETE FROM TEMPLEDGER2              
  WHERE SESSIONID = '9999999999'              
 INSERT INTO TEMPLEDGER2              
 SELECT              
  'BRANCH',              
  C.COSTNAME,              
  AMOUNT,              
  VTYP = @VTYP,              
  VNO,              
  L1_SRNO,              
  DRCR,              
 '0',              
  BOOKTYPE = @BOOKTYPE,              
  SESSIONID = '9999999999',              
  CLIENT_CODE = CLTCODE,              
  'A',              
  '0'              
 FROM              
  #RECPAY_TABLE RP,              
  COSTMAST C              
 WHERE              
  RP.COSTCODE = C.COSTCODE              
              
 DECLARE @@L2CUR AS CURSOR,              
  @@L2VNO AS VARCHAR(12)              
 SET @@L2CUR = CURSOR FOR              
  SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO              
 OPEN @@L2CUR              
 FETCH NEXT FROM @@L2CUR INTO @@L2VNO              
 WHILE @@FETCH_STATUS = 0              
  BEGIN              
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'              
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO              
  END              
  DELETE FROM TEMPLEDGER2              
   WHERE SESSIONID = '9999999999'              
  CLOSE @@L2CUR              
  DEALLOCATE @@L2CUR    
END              
 COMMIT TRAN              
              
 SELECT RESULT = 'Data Uploaded Successfully'              
 UNION ALL              
 SELECT RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO FROM #RECPAY_TABLE              
 DROP TABLE #RECPAY_TABLE_TMP              
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EDP_DP_BALANCE_UPDATE_NEW
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[EDP_DP_BALANCE_UPDATE_NEW]    
AS          
TRUNCATE TABLE DELCDSLBALANCE    

/*
RETURN -- POA BLOCKED DUE TO MARGIN PLEDGE   / REPLEDGE MODULE
      
SELECT * INTO #DELCDSLBALANCE FROM DELCDSLBALANCE WHERE 1=2      
      	  
CREATE CLUSTERED INDEX IDX_D ON #DELCDSLBALANCE
(
	CLTDPID,
	DPID
)
  	  
CREATE NONCLUSTERED INDEX IDX_I ON #DELCDSLBALANCE
(
	ISIN 
)

/*INSERT INTO #DELCDSLBALANCE1 (PARTY_CODE,DPID,CLTDPID,SCRIP_CD,SERIES,ISIN,FREEBAL,CURRBAL,FREEZEBAL,LOCKINBAL,PLEDGEBAL,DPVBAL,DPCBAL,RPCBAL,ELIMBAL,EARMARKBAL,REMLOCKBAL,TOTALBALANCE,TRDATE)  
SELECT NULL,LEFT(HLD_AC_CODE,8),HLD_AC_CODE,NULL,NULL,HLD_ISIN_CODE,FLOOR(HLD_AC_POS),0,0,0,0,0,0,0,0,0,0,FLOOR(HLD_AC_POS),LEFT(HLD_HOLD_DATE,4) + ''-'' + SUBSTRING(HLD_HOLD_DATE,5,2) + ''-'' + RIGHT(HLD_HOLD_DATE,2) FROM [192.168.3.25].ACERCROSS.DBO.HOL
DING

 WHERE HLD_AC_TYPE=11     
*/  
  
SELECT *, CLTID = CONVERT(VARCHAR(16),'') INTO #PARTYDP FROM [CSOKYC-6].GENERAL.DBO.[VW_POA_ACTIVE]
WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN)

CREATE CLUSTERED INDEX IDX_P ON #PARTYDP
(
	PARTY_CODE,CLTID
)

UPDATE #PARTYDP SET CLTID = CLTDPNO
FROM MSAJAG.DBO.MULTICLTID M
WHERE #PARTYDP.Party_Code = M.PARTY_CODE 
AND M.DEF = 1  
 
INSERT INTO #DELCDSLBALANCE (PARTY_CODE,DPID,CLTDPID,SCRIP_CD,SERIES,ISIN,FREEBAL,CURRBAL,FREEZEBAL,LOCKINBAL,PLEDGEBAL,
DPVBAL,DPCBAL,RPCBAL,ELIMBAL,EARMARKBAL,REMLOCKBAL,TOTALBALANCE,TRDATE)  
SELECT  NULL,LEFT(HLD_AC_CODE,8),HLD_AC_CODE,NULL,NULL,HLD_ISIN_CODE,FLOOR(FREE_QTY),0,0,0,0,0,0,0,0,0,0,FLOOR(FREE_QTY),
LEFT(HLD_HOLD_DATE,4) + '-' + SUBSTRING(HLD_HOLD_DATE,5,2) + '-' + RIGHT(HLD_HOLD_DATE,2) FROM AGMUBODPL3.DMAT.CITRUS_USR.HOLDING 
WHERE FREE_QTY>0     
AND HLD_AC_CODE IN (SELECT CLTID FROM #PARTYDP)
       
UPDATE D          
SET D.PARTY_CODE = M.PARTY_CODE          
FROM #DELCDSLBALANCE D, MSAJAG.DBO.MULTICLTID M          
WHERE D.CLTDPID = M.CLTDPNO AND D.DPID = M.DPID AND M.DEF = 1          
AND M.Party_Code IN (SELECT Party_Code FROM #PARTYDP where #PARTYDP.party_code = m.Party_code)
          
UPDATE D          
SET D.SCRIP_CD = I.SCRIP_CD, D.SERIES = I.SERIES          
FROM #DELCDSLBALANCE D, MSAJAG.DBO.MULTIISIN I          
WHERE D.ISIN = I.ISIN AND I.VALID = 1          
          
UPDATE D          
SET D.SCRIP_CD = I.SCRIP_CD, D.SERIES = I.SERIES          
FROM #DELCDSLBALANCE D, AngelBSECM.BSEDB_AB.DBO.MULTIISIN I          
WHERE D.ISIN = I.ISIN AND I.VALID = 1 AND D.SCRIP_CD IS NULL          
          
UPDATE #DELCDSLBALANCE          
SET PARTY_CODE = ''          
WHERE PARTY_CODE IS NULL          
          
UPDATE #DELCDSLBALANCE          
SET SCRIP_CD = ''          
WHERE SCRIP_CD IS NULL          
          
UPDATE #DELCDSLBALANCE          
SET SERIES = ''          
WHERE SERIES IS NULL          
      
INSERT INTO DELCDSLBALANCE    
SELECT * FROM #DELCDSLBALANCE      
WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
			  WHERE #DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)   
      
DROP TABLE #DELCDSLBALANCE        
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFCT_DATA
-- --------------------------------------------------
CREATE PROC EFFCT_DATA
(
 @A INT 
)
AS

DECLARE @TODATE VARCHAR (10) =CONVERT(VARCHAR(11),GETDATE()- @A ,120)
 
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4
FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59' 
GROUP BY CLTCODE 

INSERT INTO #BAL4
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER
WHERE VDT < '2019-04-01'  AND EDT >  @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')
GROUP BY CLTCODE 

select CLTCODE,SUM(BAL) BAL from #BAL4   
WHERE BAL > 0
GROUP BY CLTCODE
order by CLTCODE

DROP TABLE #BAL4

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE
-- --------------------------------------------------
CREATE proc [dbo].[EFFECTIVE_BALANCE]

 (  

@TODATE   VARCHAR (11)  

) AS BEGIN   



select L.CLTCODE,SUM(case when drcr='D'then vamt else -vamt end)vamt from ledger L (nolock) ,ACMAST A (nolock) 

where  VDT>='apr  1 2017' and  

edt<=@TODATE + ' 23:59:59' AND A.CLTCODE=L.CLTCODE AND A.accat =4  
AND A.CLTCODE IN (SELECT * FROM OLDNEW) 

group by L.cltcode 

--having SUM(case when drcr='D'then vamt else -vamt end)<>0

order by L.CLTCODE 

  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_BSE
-- --------------------------------------------------
  
  
  
  
CREATE proc [dbo].[EFFECTIVE_BALANCE_BSE]  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
 (    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
@TODATE   VARCHAR (11)    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
) AS BEGIN     
  
  
  
  
  
  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4  
  
  
  
FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL4  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER  
  
  
  
 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
   
  
  
  
  
  
--------------------------------------------BSE  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL5  
  
  
  
FROM [AngelBSECM].ACCOUNT_Ab.dbo.LEDGER with (nolock) WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL5  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM [AngelBSECM].ACCOUNT_Ab.dbo.LEDGER with (nolock)  
  
  
  
 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
 select 'BSE'as SEGMENT,CLTCODE,SUM(BAL) BAL INTO #DATA  from #BAL5    
  
  
  
where    cltcode IN (SELECT * FROM MTFTRADE.dbo.oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
  
INSERT  INTO #DATA   
  
 select 'MTF'as SEGMENT,CLTCODE,SUM(BAL) BAL from #BAL4     
  
  
  
where    cltcode IN (SELECT * FROM oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
  
SELECT * into data12 FROM #DATA   
  
  
SELECT * FROM DATA12   
order by SEGMENT  
  
drop table DATA12  
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_BSX
-- --------------------------------------------------
  
  
  
  
CREATE proc [dbo].[EFFECTIVE_BALANCE_BSX]  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
 (    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
@TODATE   VARCHAR (11)    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
) AS BEGIN     
  
  
  
  
  
  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4  
  
  
  
FROM LEDGER WHERE VDT >='2018-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL4  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER  
  
  
  
 WHERE VDT < '2018-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
   
  
  
  
  
  
--------------------------------------------BSE  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL5  
  
  
  
FROM [AngelCommodity].ACCOUNTCURBFO.dbo.LEDGER with (nolock) WHERE VDT >='2018-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL5  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM [AngelCommodity].ACCOUNTCURBFO.dbo.LEDGER with (nolock)  
  
  
  
 WHERE VDT < '2018-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
 select 'BSX'as SEGMENT,CLTCODE,SUM(BAL) BAL INTO #DATA  from #BAL5    
  
  
  
where    cltcode IN (SELECT * FROM MTFTRADE.dbo.oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
  
INSERT  INTO #DATA   
  
 select 'MTF'as SEGMENT,CLTCODE,SUM(BAL) BAL from #BAL4     
  
  
  
where    cltcode IN (SELECT * FROM oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
  
SELECT * FROM #DATA   
  
order by SEGMENT  
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_DATA
-- --------------------------------------------------


--Exec EFFECTIVE_BALANCE_new 'DEC  5 2017'



create  proc [dbo].[EFFECTIVE_BALANCE_DATA]







 (  







@TODATE   VARCHAR (11)  







) AS BEGIN   





SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4

FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59' 

GROUP BY CLTCODE 



INSERT INTO #BAL4

SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER

 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')

 GROUP BY CLTCODE 

 

 select CLTCODE,SUM(BAL) BAL from #BAL4   

--where    cltcode IN (SELECT * FROM oldnew) 

GROUP BY CLTCODE

order by CLTCODE







END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_MFSS
-- --------------------------------------------------
CREATE proc [dbo].[EFFECTIVE_BALANCE_MFSS]  
 (    
@TODATE   VARCHAR (11)    
) AS BEGIN     
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4  
FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
GROUP BY CLTCODE   
INSERT INTO #BAL4  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER  
 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
 GROUP BY CLTCODE   
  
select 'MFSS'as SEGMENT,L.CLTCODE,SUM(CRAMOUNT-DRAMOUNT) BALANCE INTO #DATA from ANGELFO.BBO_FA.DBO.MFSS_LEDGER_BSE L (nolock) ,[AngelFO].BBO_FA.DBO.ACMAST A (nolock)   
where  VDT>='apr  1 2018' and    
edt<= @TODATE + ' 23:59:59' AND A.CLTCODE=L.CLTCODE AND A.accat =4    
 AND A.CLTCODE IN (SELECT * FROM MTFTRADE.dbo.oldnew  
)  
group by L.cltcode   
--having SUM(case when drcr='D'then vamt else -vamt end)<>0  
order by L.CLTCODE   
INSERT  INTO #DATA   
 select 'MTF'as SEGMENT,CLTCODE,SUM(BAL) BAL from #BAL4     
where    cltcode IN (SELECT * FROM oldnew)   
GROUP BY CLTCODE  
order by CLTCODE  
SELECT * into data12 FROM #DATA   
SELECT * FROM DATA12   
order by SEGMENT  
drop table DATA12  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_new
-- --------------------------------------------------


--Exec EFFECTIVE_BALANCE_new 'DEC  5 2017'



CREATE proc [dbo].[EFFECTIVE_BALANCE_new]







 (  







@TODATE   VARCHAR (11)  







) AS BEGIN   





SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4

FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59' 

GROUP BY CLTCODE 



INSERT INTO #BAL4

SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER

 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')

 GROUP BY CLTCODE 

 

 select CLTCODE,SUM(BAL) BAL from #BAL4   

where    cltcode IN (SELECT * FROM oldnew) 

GROUP BY CLTCODE

order by CLTCODE







END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_NSE
-- --------------------------------------------------




CREATE proc [dbo].[EFFECTIVE_BALANCE_NSE]















 (  















@TODATE   VARCHAR (11)  















) AS BEGIN   













SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4



FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59' 



GROUP BY CLTCODE 







INSERT INTO #BAL4



SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER



 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')



 GROUP BY CLTCODE 



 





--------------------------------------------NSE







SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL5



FROM ACCOUNT.dbo.LEDGER with (nolock) WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59' 



GROUP BY CLTCODE 







INSERT INTO #BAL5



SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM ACCOUNT.dbo.LEDGER with (nolock)



 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')



 GROUP BY CLTCODE 



 select 'NSE'as SEGMENT,CLTCODE,SUM(BAL) BAL INTO #DATA  from #BAL5  



where    cltcode IN (SELECT * FROM MTFTRADE.dbo.oldnew) 



GROUP BY CLTCODE



order by CLTCODE



INSERT  INTO #DATA 

 select 'MTF'as SEGMENT,CLTCODE,SUM(BAL) BAL from #BAL4   



where    cltcode IN (SELECT * FROM oldnew) 



GROUP BY CLTCODE



order by CLTCODE

SELECT * into data12 FROM #DATA 


SELECT * FROM DATA12 
order by SEGMENT

drop table DATA12



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_NSEFO
-- --------------------------------------------------
  
  
  
  
CREATE proc [dbo].[EFFECTIVE_BALANCE_NSEFO]  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
 (    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
@TODATE   VARCHAR (11)    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
) AS BEGIN     
  
  
  
  
  
  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4  
  
  
  
FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL4  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER  
  
  
  
 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
   
  
  
  
  
  
--------------------------------------------NSEFO  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL5  
  
  
  
FROM [AngelFO].ACCOUNTfo.dbo.LEDGER with (nolock) WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL5  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM [AngelFO].ACCOUNTfo.dbo.LEDGER with (nolock)  
  
  
  
 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
 select 'NSEFO'as SEGMENT,CLTCODE,SUM(BAL) BAL INTO #DATA  from #BAL5    
  
  
  
where    cltcode IN (SELECT * FROM MTFTRADE.dbo.oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
  
INSERT  INTO #DATA   
  
 select 'MTF'as SEGMENT,CLTCODE,SUM(BAL) BAL from #BAL4     
  
  
  
where    cltcode IN (SELECT * FROM oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
SELECT * into data12 FROM #DATA   
  
  
SELECT * FROM DATA12   
order by SEGMENT  
  
drop table DATA12  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EFFECTIVE_BALANCE_NSX
-- --------------------------------------------------
  
  
  
  
CREATE proc [dbo].[EFFECTIVE_BALANCE_NSX]  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
 (    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
@TODATE   VARCHAR (11)    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
) AS BEGIN     
  
  
  
  
  
  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL4  
  
  
  
FROM LEDGER WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL4  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM LEDGER  
  
  
  
 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
   
  
  
  
  
  
--------------------------------------------BSE  
  
  
  
  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT ELSE VAMT*-1 END) BAL INTO #BAL5  
  
  
  
FROM [AngelFO].ACCOUNTcurfo.dbo.LEDGER with (nolock) WHERE VDT >='2019-04-01'   AND EDT <= @TODATE + ' 23:59:59'   
  
  
  
GROUP BY CLTCODE   
  
  
  
  
  
  
  
INSERT INTO #BAL5  
  
  
  
SELECT CLTCODE ,SUM(CASE WHEN DRCR='D' THEN VAMT*-1 ELSE VAMT END) FROM [AngelFO].ACCOUNTcurfo.dbo.LEDGER with (nolock)  
  
  
  
 WHERE VDT < '2019-04-01'  AND EDT > @TODATE + ' 23:59:59'   AND  VTYP in ( '15' ,'35')  
  
  
  
 GROUP BY CLTCODE   
  
  
  
 select 'NSX'as SEGMENT,CLTCODE,SUM(BAL) BAL INTO #DATA  from #BAL5    
  
  
  
where    cltcode IN (SELECT * FROM MTFTRADE.dbo.oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
  
INSERT  INTO #DATA   
  
 select 'MTF'as SEGMENT,CLTCODE,SUM(BAL) BAL from #BAL4     
  
  
  
where    cltcode IN (SELECT * FROM oldnew)   
  
  
  
GROUP BY CLTCODE  
  
  
  
order by CLTCODE  
  
  
SELECT * into data12 FROM #DATA   
  
  
SELECT * FROM DATA12   
order by SEGMENT  
  
drop table DATA12  
  
  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FN
-- --------------------------------------------------
  
CREATE PROC FN @FUN VARCHAR(25)AS             
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @FUN + '%' AND XTYPE='FN' ORDER BY NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Formula_client_master_DATA
-- --------------------------------------------------

--EXEC Formula_client_master_DATA

CREATE PROCEDURE [dbo].[Formula_client_master_DATA]

as
begin
CREATE TABLE #CL_LIST    
(    
 PARTY_CODE VARCHAR(10),    
 PARTY_NAME VARCHAR(100),    
 CLIENT_PAN VARCHAR(50),
 CL_TYPE VARCHAR(10),
 PARENT_CODE VARCHAR(10)   
)    
     

INSERT INTO #CL_LIST    
SELECT CL_CODE, LONG_NAME, PAN_GIR_NO, CL_TYPE, PARENTCODE = CASE WHEN 0 = 1 THEN PARENTCODE ELSE CL_CODE END
FROM MSAJAG.dbo.VW_CLIENT_DETAILS_DATA   
WHERE CL_CODE BETWEEN '0000' AND 'zzzz'    

 
/* QUERY TO UPDATE THE PARENT DETAILS FOR THE DETAILS */
--IF @@PARENT_FLAG = 1
BEGIN
	UPDATE C SET C.PARTY_NAME =C1.PARTY_NAME, C.CLIENT_PAN = C1.CLIENT_PAN
	FROM #CL_LIST C, (SELECT * FROM #CL_LIST WHERE PARTY_CODE = PARENT_CODE) C1
	WHERE C.PARTY_CODE = C1.PARENT_CODE
END
 
DELETE FROM FORMULA_CLIENT_MASTER WHERE SESSION_ID = '8888888888'
 
INSERT INTO FORMULA_CLIENT_MASTER 
SELECT PARTY_CODE, PARTY_NAME, 'PARTY', '', '8888888888', GETDATE() FROM #CL_LIST 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Get_JoBStatus
-- --------------------------------------------------
   
CREATE procedure Get_JoBStatus    
(@jobname varchar(500),    
@Status varchar(20)=''  output)    
as    
begin    
    
DECLARE @Job_ID as varchar(100)    
SELECT @Job_ID= JOB_ID       
 FROM msdb.dbo.sysjobs         
 WHERE name =@jobname -- you can specify a job id to query for a certain job    
 --IF (((DATEPART(DW,GETDATE()) = 1) or (DATEPART(DW,GETDATE()) = 7)) OR((DATEPART(DW,GETDATE())=2) and (DATEPART(HH,GETDATE())<=7)))      
--DECLARE @Job_ID as varchar(100)    
--SET @Job_ID = '%' -- you can specify a job id to query for a certain job     
    
    
CREATE TABLE #JobResults    
    (job_id uniqueidentifier NOT NULL,     
    last_run_date int NOT NULL,     
    last_run_time int NOT NULL,     
    next_run_date int NOT NULL,     
    next_run_time int NOT NULL,     
    next_run_schedule_id int NOT NULL,     
    requested_to_run int NOT NULL, /* bool*/     
    request_source int NOT NULL,     
    request_source_id sysname     
    COLLATE database_default NULL,     
    running int NOT NULL, /* bool*/     
    current_step int NOT NULL,     
    current_retry_attempt int NOT NULL,     
    job_state int NOT NULL)     
    
INSERT    #JobResults     
EXEC master.dbo.xp_sqlagent_enum_jobs 1, '';    
    
SELECT        
    r.job_id,     
    job.name as Job_Name,     
        
    (select top 1 start_execution_date     
            FROM [msdb].[dbo].[sysjobactivity]    
            where job_id = r.job_id    
            order by start_execution_date desc) as Job_Start_DateTime,    
                
    cast((select top 1 ISNULL(stop_execution_date, GETDATE()) - start_execution_date      
            FROM [msdb].[dbo].[sysjobactivity]    
            where job_id = r.job_id    
            order by start_execution_date desc) as time) as Job_Duration,     
                
    r.current_step AS Current_Running_Step_ID,    
    CASE     
        WHEN r.running = 0 then jobinfo.last_run_outcome    
        ELSE    
            --convert to the uniform status numbers (my design)    
            CASE    
                WHEN r.job_state = 0 THEN 1    --success    
                WHEN r.job_state = 4 THEN 1    
                WHEN r.job_state = 5 THEN 1    
                WHEN r.job_state = 1 THEN 2    --in progress    
                WHEN r.job_state = 2 THEN 2    
                WHEN r.job_state = 3 THEN 2    
                WHEN r.job_state = 7 THEN 2    
            END    
    END as Run_Status,    
    CASE     
        WHEN r.running = 0 then     
            -- convert to the uniform status numbers (my design)    
            -- no longer running, use the last outcome in the sysjobservers    
            -- sysjobservers will give last run status, but does not know about current running jobs    
            CASE     
                WHEN jobInfo.last_run_outcome = 0 THEN 'Failed'    
                WHEN jobInfo.last_run_outcome = 1 THEN 'Success'    
                WHEN jobInfo.last_run_outcome = 3 THEN 'Canceled'    
                ELSE 'Unknown'    
            end    
            -- convert to the uniform status numbers (my design)    
            -- if running, use the job state in xp_sqlagent_enum_jobs        
            -- xp_sqlagent_enum_jobs will give current status, but does not know if a completed job    
            -- succeeded, failed or was canceled.    
            WHEN r.job_state = 0 THEN 'Success'    
            WHEN r.job_state = 4 THEN 'Success'    
            WHEN r.job_state = 5 THEN 'Success'    
            WHEN r.job_state = 1 THEN 'In Progress'    
            WHEN r.job_state = 2 THEN 'In Progress'    
            WHEN r.job_state = 3 THEN 'In Progress'    
            WHEN r.job_state = 7 THEN 'In Progress'    
         ELSE 'Unknown' END AS Run_Status_Description    
         into #JobResultsFinal    
FROM    #JobResults as r left join    
        msdb.dbo.sysjobservers as jobInfo on r.job_id = jobInfo.job_id inner join    
      msdb.dbo.sysjobs as job on r.job_id = job.job_id     
WHERE    cast(r.job_id as varchar(100)) like @Job_ID    
        and job.[enabled] = 1    
order by job.name    
select  @Status=Run_Status_Description from #JobResultsFinal    
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA
-- --------------------------------------------------






--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 
 --(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE)      
 --AND VDT <= @EFFDATE + ' 23:59')    L,/*    
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE 
 --(VDT >= @START_DATE OR 
 EDT >= @START_DATE
 --)      
 AND VDT <= @EFFDATE + ' 23:59')    L,
 /*  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,*/
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR--, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_BKUP_06FEB21
-- --------------------------------------------------






--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_BKUP_06FEB21]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L/*  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO*/,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR--, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_BKUP_21JAN2021
-- --------------------------------------------------


--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''    
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'    
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_BKUP_21JAN2021]      
 @EFFDATE VARCHAR(11),    
 @SESSIONID VARCHAR(500),    
 @PROCESS_CODE VARCHAR(10),    
 @REPORT_FORMULA VARCHAR(MAX),  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(50),
 @TABLE_NAME VARCHAR(20) = '' 
AS      
    
DECLARE      
 @START_DATE VARCHAR(11)      
      
IF LEN(@EFFDATE) = 10      
BEGIN      
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)      
END      
      
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)      
FROM PARAMETER      
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR      
    
    
CREATE TABLE #REPORT_DATA    
(    
 CLTCODE VARCHAR(10),    
 PARTY_NAME VARCHAR(100),       
 ENTITY_LEVEL VARCHAR(20),    
 ENTITY_CODE VARCHAR(25),      
 VDTBAL MONEY,      
 EDTBAL MONEY,      
 FDT_RECEIPT MONEY,      
 FDT_PAYMENTS MONEY,  
 MARGIN_BAL MONEY    
)    
    
DECLARE    
 @@SQL VARCHAR(MAX)    
    
INSERT INTO #REPORT_DATA      
SELECT       
 CLTCODE,    
 PARTY_NAME,       
 ENTITY_LEVEL,    
 ENTITY_CODE,      
 VDTBAL = SUM(VDTBAL),      
 EDTBAL = SUM(EDTBAL),      
 FDT_RECEIPT = SUM(FDT_RECEIPT),      
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),  
 MARGIN_BAL = 0  
FROM      
(SELECT       
 CLTCODE = L.CLTCODE,    
 PARTY_NAME,    
 ENTITY_LEVEL,    
 ENTITY_CODE,      
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,      
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END       
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,      
 FDT_RECEIPT = 0, --CASE WHEN (/*RELDT = '' OR */RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,      
 FDT_PAYMENTS = 0 --CASE WHEN (/*RELDT = '' OR */RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END  
FROM       
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE)      
 AND VDT <= @EFFDATE + ' 23:59')    L,/*    
 LEFT OUTER JOIN (SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '')) L1  
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,  */
 FORMULA_CLIENT_MASTER A      
WHERE      
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID    
   
 GROUP BY       
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR--, L1.RELDT      
) A      
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE        
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0 

UPDATE R SET R.FDT_RECEIPT = A.FDT_RECEIPT, R.FDT_PAYMENTS = A.FDT_PAYMENTS
FROM #REPORT_DATA R, (SELECT CLTCODE, FDT_RECEIPT = SUM(CASE WHEN L1.VTYP = 2 THEN VAMT ELSE 0 END),
FDT_PAYMENTS = SUM(CASE WHEN L1.VTYP = 3 THEN VAMT ELSE 0 END) FROM
(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE VDT <= @EFFDATE + ' 23:59')    L,    
(SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '') and CLEAR_MODE <> 'C') L1  
 WHERE L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO
AND L1.VTYP IN(2, 3)  
GROUP BY CLTCODE ) A
WHERE R.CLTCODE = A.CLTCODE
  
/*  
UPDATE RD SET MARGIN_BAL = ML.AMOUNT  
FROM #REPORT_DATA RD, (  
 SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)  
 FROM MARGINLEDGER ML  
 WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'  
 GROUP BY PARTY_CODE  
)ML  
WHERE RD.CLTCODE = PARTY_CODE  
*/  
IF @TABLE_NAME <> ''
BEGIN
	SET @@SQL = " TRUNCATE TABLE " + @TABLE_NAME  
	EXEC (@@SQL)
END

IF @TABLE_NAME <> ''
   SET @@SQL = " INSERT INTO " + @TABLE_NAME + " SELECT "    
ELSE
SET @@SQL = " SELECT "   
 
SET @@SQL = @@SQL + " CLTCODE, "    
SET @@SQL = @@SQL + " PARTY_NAME, "    
SET @@SQL = @@SQL + " ENTITY_LEVEL,"    
SET @@SQL = @@SQL + " ENTITY_CODE, "    
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "    
SET @@SQL = @@SQL + " FROM "    
SET @@SQL = @@SQL + " #REPORT_DATA"    

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT
-- --------------------------------------------------


--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''    
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'    


CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_SINGLE_CLIENT]      
 @EFFDATE VARCHAR(11), 
  @CLTCODE VARCHAR(12),
 @SESSIONID VARCHAR(500),    
 @PROCESS_CODE VARCHAR(10),    
 @REPORT_FORMULA VARCHAR(MAX),  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(50),
 @TABLE_NAME VARCHAR(20) = '' 
AS      
    
DECLARE      
 @START_DATE VARCHAR(11)      
      
IF LEN(@EFFDATE) = 10      
BEGIN      
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)      
END      
      
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)      
FROM PARAMETER      
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR      
    
    
--CREATE TABLE #REPORT_DATA    
--(    
-- CLTCODE VARCHAR(10),    
-- PARTY_NAME VARCHAR(100),       
-- ENTITY_LEVEL VARCHAR(20),    
-- ENTITY_CODE VARCHAR(25),      
-- VDTBAL MONEY,      
-- EDTBAL MONEY,      
-- FDT_RECEIPT MONEY,      
-- FDT_PAYMENTS MONEY,  
-- MARGIN_BAL MONEY    
--)    
    
DECLARE    
 @@SQL VARCHAR(MAX)    
    
SELECT       
 CLTCODE = L.CLTCODE,    
 VDTBAL = SUM(CASE WHEN VDT >= @START_DATE THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),      
 EDTBAL = SUM(CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN (CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END       
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN (CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),      
 FDT_RECEIPT = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN (VAMT) ELSE 0 END) ,      
 FDT_PAYMENTS = SUM(CASE WHEN (EDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN (VAMT) ELSE 0 END ) INTO #LEDGER
FROM       
 --(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE)      
 --AND VDT <= @EFFDATE + ' 23:59')    L,/*    
 (SELECT  CLTCODE,VDT,VTYP,EDT,DRCR,VAMT  FROM LEDGER (NOLOCK) WHERE 
 --(VDT >= @START_DATE OR 
 CLTCODE =@CLTCODE AND
 EDT >= @START_DATE
  AND CDT <= DATEADD(MI, -15, GETDATE())
 --)      
 AND VDT <= @EFFDATE + ' 23:59' --AND CDT <= DATEADD(MI, -15, GETDATE())
 )    L 
 GROUP BY CLTCODE /*    
 LEFT OUTER JOIN (SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '')) L1  
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,  */
 
 
 
 --INSERT INTO #REPORT_DATA      
SELECT       
 L.CLTCODE,    
 PARTY_NAME,       
 ENTITY_LEVEL,    
 ENTITY_CODE,      
 VDTBAL = SUM(VDTBAL),      
 EDTBAL = SUM(EDTBAL),      
 FDT_RECEIPT = SUM(FDT_RECEIPT),      
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),  
 MARGIN_BAL = 0  INTO #REPORT_DATA      
FROM      
 #LEDGER L (Nolock)  ,
 FORMULA_CLIENT_MASTER A    (Nolock)  
WHERE      
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID    
 GROUP BY       
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE --, L1.RELDT      
      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0 
/*
UPDATE R SET R.FDT_RECEIPT = A.FDT_RECEIPT, R.FDT_PAYMENTS = A.FDT_PAYMENTS
FROM #REPORT_DATA R, (SELECT CLTCODE, FDT_RECEIPT = SUM(CASE WHEN L1.VTYP = 2 THEN VAMT ELSE 0 END),
FDT_PAYMENTS = SUM(CASE WHEN L1.VTYP = 3 THEN VAMT ELSE 0 END) FROM
(SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE VDT <= @EFFDATE + ' 23:59')    L,    
(SELECT RELDT = (CASE WHEN RELDT = '' THEN CONVERT(DATETIME,'DEC 31 2049 23:59') ELSE RELDT END), 
						    VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '') and CLEAR_MODE <> 'C') L1  
 WHERE L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO
AND L1.VTYP IN(2, 3)  
GROUP BY CLTCODE ) A
WHERE R.CLTCODE = A.CLTCODE
 */ 
/*  
UPDATE RD SET MARGIN_BAL = ML.AMOUNT  
FROM #REPORT_DATA RD, (  
 SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)  
 FROM MARGINLEDGER ML  
 WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'  
 GROUP BY PARTY_CODE  
)ML  
WHERE RD.CLTCODE = PARTY_CODE  
*/  
--IF @TABLE_NAME <> ''
--BEGIN
--	SET @@SQL = " TRUNCATE TABLE " + @TABLE_NAME  
--	EXEC (@@SQL)
--END

--IF @TABLE_NAME <> ''
--   SET @@SQL = " INSERT INTO " + @TABLE_NAME + " SELECT "    
--ELSE
SET @@SQL = " SELECT "   
 
SET @@SQL = @@SQL + " CLTCODE, "    
SET @@SQL = @@SQL + " PARTY_NAME, "    
SET @@SQL = @@SQL + " ENTITY_LEVEL,"    
SET @@SQL = @@SQL + " ENTITY_CODE, "    
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "    
SET @@SQL = @@SQL + " FROM "    
SET @@SQL = @@SQL + " #REPORT_DATA"    

EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_MARGIN
-- --------------------------------------------------
CREATE PROC [dbo].[GET_LEDGER_MARGIN]            
AS            
SELECT CLTCODE = party_code INTO #ACMAST             
FROM ANGELFO.NSEFO.DBO.TBL_MARGINPARTY       
            
CREATE CLUSTERED INDEX CLTIDX ON #ACMAST            
(            
 CLTCODE            
)            

TRUNCATE TABLE LEDGER_MARGIN            
/*            
SELECT L.VTYP,L.VNO,EDT=(CASE WHEN RELDT = 'JAN  1 1900'             
         THEN '2049-12-31'            
         ELSE RELDT             
       END),            
    L.LNO,L.ACNAME,L.DRCR,VAMT,VDT,VNO1,L.REFNO,BALAMT,            
    NODAYS,CDT,L.CLTCODE,L.BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,            
    ACTNODAYS,NARRATION            
INTO #LEDGER_MARGIN            
FROM LEDGER L (NOLOCK), LEDGER1 L1 (NOLOCK), #ACMAST A (NOLOCK)            
WHERE L.VNO = L1.VNO            
AND L.VTYP = L1.VTYP            
AND L.BOOKTYPE = L1.BOOKTYPE            
AND L.VTYP IN (2,3)            
AND L.CLTCODE = A.CLTCODE             
*/            
            
INSERT INTO LEDGER_MARGIN            
SELECT L.* FROM LEDGER L (NOLOCK),             
    #ACMAST A (NOLOCK)            
WHERE VDT >= 'APR  1 2014'            
AND L.CLTCODE = A.CLTCODE             
/*
INSERT INTO LEDGER_MARGIN 
SELECT L.* FROM MTFTRADE.DBO.LEDGER L (NOLOCK),             
    ACMAST A (NOLOCK)            
WHERE VDT >= 'APR  1 2014'            
AND L.CLTCODE = A.CLTCODE  */
/*           
UPDATE LEDGER_MARGIN SET EDT = (CASE WHEN RELDT = 'JAN  1 1900'             
         THEN '2049-12-31'            
         ELSE RELDT             
       END)            
FROM LEDGER1 L1            
WHERE LEDGER_MARGIN.VNO = L1.VNO            
AND LEDGER_MARGIN.VTYP = L1.VTYP            
AND LEDGER_MARGIN.BOOKTYPE = L1.BOOKTYPE          
AND LEDGER_MARGIN.VTYP = 2          
AND LEDGER_MARGIN.BOOKTYPE <> (CASE WHEN VDT >= 'JAN 29 2015' THEN '' ELSE 'E8' END)          
        
UPDATE LEDGER_MARGIN SET EDT = VDT         
WHERE VTYP = 2           
AND ENTEREDBY = 'TPR'          
AND EDT >= GETDATE()          
AND CHECKEDBY = 'ONLINE'          
AND EDT >= '2049-12-31'         
/*        
SELECT VNO, VTYP, CLTCODE, VDT = CONVERT(VARCHAR,VDT,103), EDT,        
VAMT, ENTEREDBY, CHECKEDBY FROM LEDGER_MARGIN          
WHERE VTYP = 2           
AND ENTEREDBY = 'TPR'          
AND EDT >= GETDATE()          
AND CHECKEDBY = 'ONLINE'          
*/ 

*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_TB_DATA
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[GET_TB_DATA]
	@FROM_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@DATE_TYPE VARCHAR(3),
	@REPORT_TYPE VARCHAR(10),
	@WITH_OPEN BIT
AS

DECLARE
	@OPEN_DATE VARCHAR(11)
	
SELECT @OPEN_DATE = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @TO_DATE BETWEEN SDTCUR AND LDTCUR

DECLARE
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10)

--SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER

SET @EXCHANGE  = 'MTFTRADE'
SET	@SEGMENT   = 'MTFTRADE'

CREATE TABLE #CL_LIST
(
	CL_CODE VARCHAR(10),
	PARENT_CODE VARCHAR(10),
	PARENT_NAME VARCHAR(100)
)

INSERT INTO #CL_LIST
SELECT CL_CODE, PARENTCODE, LONG_NAME
FROM MSAJAG..CLIENT_DETAILS where cl_code not like '05%' and PAN_GIR_NO not LIKE '%[^0-9A-Za-z]%' OR LEN(PAN_GIR_NO) <> '10'


UPDATE C SET C.PARENT_NAME = CL.LONG_NAME
FROM #CL_LIST C, MSAJAG..CLIENT_DETAILS CL
WHERE CL.CL_CODE = PARENT_CODE

CREATE TABLE #LED_BALANCE
(
	CLTCODE VARCHAR(10),
	ACNAME VARCHAR(100),
	OPEN_BAL MONEY,
	PERIOD_CR MONEY,
	PERIOD_DR MONEY,
	CL_BAL MONEY,
	ACCAT INT
)

IF @DATE_TYPE = 'VDT'
BEGIN
	INSERT INTO #LED_BALANCE
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN (VDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18) THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT = 4
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND VDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY PARENT_CODE, PARENT_NAME

	INSERT INTO #LED_BALANCE
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.ACNAME, OPEN_BAL = SUM(CASE WHEN (VDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18)  THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.CLTCODE
	AND VDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	AND ACCAT <> 4
	GROUP BY L.CLTCODE, A.Acname, ACCAT
END

IF @DATE_TYPE = 'EDT'
BEGIN
	INSERT INTO #LED_BALANCE
	SELECT CLTCODE, PARENT_NAME, OPEN_BAL = SUM(OPEN_BAL), PERIOD_CR = SUM(PERIOD_CR), PERIOD_DR = SUM(PERIOD_DR), CL_BAL = SUM(CL_BAL), ACCAT = 4 FROM
	(
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN (EDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18)  THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND EDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY PARENT_CODE, PARENT_NAME
	UNION ALL
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END), 
	PERIOD_CR = 0,
	PERIOD_DR = 0,
	CL_BAL =  SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND EDT >= @OPEN_DATE AND VDT < @OPEN_DATE
	GROUP BY PARENT_CODE, PARENT_NAME
	) A
	GROUP BY CLTCODE, PARENT_NAME

	INSERT INTO #LED_BALANCE
	SELECT CLTCODE, PARENT_NAME, OPEN_BAL = SUM(OPEN_BAL), PERIOD_CR = SUM(PERIOD_CR), PERIOD_DR = SUM(PERIOD_DR), CL_BAL = SUM(CL_BAL), ACCAT FROM
	(
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.Acname, OPEN_BAL = SUM(CASE WHEN (EDT < @FROM_DATE AND VTYP <> 18) OR (CONVERT(VARCHAR(11), VDT, 109) = @OPEN_DATE AND VTYP = 18) THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.Cltcode
	AND EDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	AND ACCAT <> 4
	GROUP BY L.CLTCODE, A.ACNAME, ACCAT
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.Acname, OPEN_BAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END), 
	PERIOD_CR = 0,
	PERIOD_DR = 0,
	CL_BAL =  SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.Cltcode
	AND EDT >= @OPEN_DATE AND VDT < @OPEN_DATE
	AND ACCAT <> 4
	GROUP BY L.CLTCODE, A.ACNAME, ACCAT
	) A
	GROUP BY CLTCODE, PARENT_NAME, ACCAT
END

IF @WITH_OPEN = 0
BEGIN
	SELECT 
		--CLTCODE = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, 
		CLTCODE = replace(CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END,' ',''), 
		ACNAME = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END, 
		CL_BAL = SUM(CL_BAL), EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT 
	FROM #LED_BALANCE 
		WHERE ACCAT = CASE WHEN @REPORT_TYPE = 'PARTY' THEN 4 ELSE ACCAT END 
	GROUP BY CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END
	HAVING SUM(CL_BAL) <> 0
END
ELSE
BEGIN
	SELECT 
		--CLTCODE = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, 
		CLTCODE = replace(CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END,' ',''), 
		ACNAME = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END, 
		OPEN_BAL = SUM(OPEN_BAL),
		PERIOD_CR = SUM(PERIOD_CR),
		PERIOD_DR = SUM(PERIOD_DR),
		CL_BAL = SUM(CL_BAL), EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT 
	FROM #LED_BALANCE 
		WHERE ACCAT = CASE WHEN @REPORT_TYPE = 'PARTY' THEN 4 ELSE ACCAT END 
	GROUP BY CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END
	HAVING (SUM(OPEN_BAL) <>  0 OR SUM(PERIOD_CR) <> 0 OR SUM(PERIOD_DR) <> 0 OR SUM(CL_BAL) <> 0)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_TB_DATA_BKUP
-- --------------------------------------------------

Create PROCEDURE [dbo].[GET_TB_DATA_BKUP]
	@FROM_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@DATE_TYPE VARCHAR(3),
	@REPORT_TYPE VARCHAR(10),
	@WITH_OPEN BIT
AS

DECLARE
	@OPEN_DATE VARCHAR(11)
	
SELECT @OPEN_DATE = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @TO_DATE BETWEEN SDTCUR AND LDTCUR

DECLARE
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10)

--SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER

SET @EXCHANGE  = 'MTFTRADE'
SET	@SEGMENT   = 'MTFTRADE'

CREATE TABLE #CL_LIST
(
	CL_CODE VARCHAR(10),
	PARENT_CODE VARCHAR(10),
	PARENT_NAME VARCHAR(100)
)

INSERT INTO #CL_LIST
SELECT CL_CODE, PARENTCODE, LONG_NAME
FROM MSAJAG..CLIENT_DETAILS


UPDATE C SET C.PARENT_NAME = CL.LONG_NAME
FROM #CL_LIST C, MSAJAG..CLIENT_DETAILS CL
WHERE CL.CL_CODE = PARENT_CODE

CREATE TABLE #LED_BALANCE
(
	CLTCODE VARCHAR(10),
	ACNAME VARCHAR(100),
	OPEN_BAL MONEY,
	PERIOD_CR MONEY,
	PERIOD_DR MONEY,
	CL_BAL MONEY,
	ACCAT INT
)

IF @DATE_TYPE = 'VDT'
BEGIN
	INSERT INTO #LED_BALANCE
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN VDT < @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT = 4
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND VDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY PARENT_CODE, PARENT_NAME

	INSERT INTO #LED_BALANCE
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.ACNAME, OPEN_BAL = SUM(CASE WHEN VDT < @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN VDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.CLTCODE
	AND VDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY L.CLTCODE, A.Acname, ACCAT
END

IF @DATE_TYPE = 'EDT'
BEGIN
	INSERT INTO #LED_BALANCE
	SELECT CLTCODE, PARENT_NAME, OPEN_BAL = SUM(OPEN_BAL), PERIOD_CR = SUM(PERIOD_CR), PERIOD_DR = SUM(PERIOD_DR), CL_BAL = SUM(CL_BAL), ACCAT = 4 FROM
	(
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN EDT < @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND EDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY PARENT_CODE, PARENT_NAME
	UNION ALL
	SELECT CLTCODE = PARENT_CODE, PARENT_NAME, OPEN_BAL = SUM(CASE WHEN EDT < @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = 0,
	PERIOD_DR = 0,
	CL_BAL =  SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, #CL_LIST C
	WHERE CLTCODE = CL_CODE
	AND EDT >= @OPEN_DATE AND VDT < @OPEN_DATE
	GROUP BY PARENT_CODE, PARENT_NAME
	) A
	GROUP BY CLTCODE, PARENT_NAME

	INSERT INTO #LED_BALANCE
	SELECT CLTCODE, PARENT_NAME, OPEN_BAL = SUM(OPEN_BAL), PERIOD_CR = SUM(PERIOD_CR), PERIOD_DR = SUM(PERIOD_DR), CL_BAL = SUM(CL_BAL), ACCAT FROM
	(
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.Acname, OPEN_BAL = SUM(CASE WHEN EDT < @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END ELSE 0 END) ,
	PERIOD_DR = SUM(CASE WHEN EDT >= @FROM_DATE THEN CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END ELSE 0 END),
	CL_BAL =  SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.Cltcode
	AND EDT BETWEEN @OPEN_DATE AND @TO_DATE + ' 23:59'
	GROUP BY L.CLTCODE, A.ACNAME, ACCAT
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, PARENT_NAME = A.Acname, OPEN_BAL = SUM(CASE WHEN EDT < @FROM_DATE THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END), 
	PERIOD_CR = 0,
	PERIOD_DR = 0,
	CL_BAL =  SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END), ACCAT
	FROM LEDGER L, ACMAST A
	WHERE L.CLTCODE = A.Cltcode
	AND EDT >= @OPEN_DATE AND VDT < @OPEN_DATE
	GROUP BY L.CLTCODE, A.ACNAME, ACCAT
	) A
	GROUP BY CLTCODE, PARENT_NAME, ACCAT
END

IF @WITH_OPEN = 0
BEGIN
	SELECT 
		CLTCODE = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, 
		ACNAME = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END, 
		CL_BAL = SUM(CL_BAL), EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT 
	FROM #LED_BALANCE 
		WHERE ACCAT = CASE WHEN @REPORT_TYPE = 'PARTY' THEN 4 ELSE ACCAT END 
	GROUP BY CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END
	HAVING SUM(CL_BAL) <> 0
END
ELSE
BEGIN
	SELECT 
		CLTCODE = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, 
		ACNAME = CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END, 
		OPEN_BAL = SUM(OPEN_BAL),
		PERIOD_CR = SUM(PERIOD_CR),
		PERIOD_DR = SUM(PERIOD_DR),
		CL_BAL = SUM(CL_BAL), EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT 
	FROM #LED_BALANCE 
		WHERE ACCAT = CASE WHEN @REPORT_TYPE = 'PARTY' THEN 4 ELSE ACCAT END 
	GROUP BY CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY_ACC' ELSE CLTCODE END, CASE WHEN @REPORT_TYPE = 'GL' AND ACCAT = 4 THEN 'PARTY ACCOUNT SUMMARY' ELSE ACNAME END
	HAVING (SUM(OPEN_BAL) <>  0 OR SUM(PERIOD_CR) <> 0 OR SUM(PERIOD_DR) <> 0 OR SUM(CL_BAL) <> 0)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertToLedger2
-- --------------------------------------------------

    
CREATE PROC [dbo].[InsertToLedger2]         
(      
      @sessionid varchar(15),        
      @vno varchar(12),        
      @branchflag tinyint,        
      @costcenterflag tinyint,        
      @costenable char(1),        
      @statusid as varchar(30),        
      @statusname as varchar(30)        
)       
      
As        
      
set nocount on      
      
declare        
      @@onlyall tinyint,        
      @@onebranch tinyint,        
      @@multibranch tinyint,        
      @@oneBranchAll tinyint,        
      @@MultiBranchall tinyint,        
      @@Allcount smallint,        
      @@Branchcount smallint,        
      @@OldBranch varchar(10),        
      @@vtype varchar(2),        
      @@party2 varchar(10),        
      @@costbreakup smallint,        
      @@costcode1 int,        
        
/*=======================================================================================      
      Fields retrived from templedger2       
=======================================================================================*/      
      @@category varchar(20),        
      @@branch varchar(25),        
      @@amt    money,        
      @@vtyp varchar(2),        
      @@vno  varchar(12),        
      @@lno  int,        
      @@drcr char(1),        
      @@costcode smallint,        
      @@booktype varchar(2),        
      @@sessionid varchar(25),        
      @@party_code varchar(10),        
      @@mainbr as varchar(10),           
      @@rcursor as cursor        
        
if @branchflag = 1 and @costcenterflag  = 1        
begin        
/*=======================================================================================      
      0 = True   1 = False          
=======================================================================================*/      
      select @@onlyall = 0               /* True */        
      select @@onebranch = 1             /* True */        
      select @@multibranch = 1           /* False */        
      select @@onebranchall = 1          /* False */        
      select @@Multibranchall = 1        /* False */        
              
      select @@allcount = 0        
      select @@Branchcount = 0        
      select @@OldBranch = ''        
        
      SELECT @@mainbr =       
                  (      
                        SELECT       
                              BranchName       
                        FROM branchaccounts       
                        WHERE DefaultAc = 1      
                  )       
        
      SELECT @@vtype =       
                  (      
                        SELECT DISTINCT       
                              vtype       
                        FROM templedger2       
                        WHERE rtrim(sessionid) = rtrim(@sessionid)       
                              AND vno = @vno      
                  )       
           
      SELECT @@costbreakup =       
                  (      
                        SELECT       
                              count(*)       
                        FROM templedger2       
                        WHERE rtrim(sessionid) = rtrim(@sessionid)       
                              AND category = 'BRANCH'       
                              AND vno = @vno       
                              AND costflag = 'C'      
                  )       
        
      /*=======================================================================================      
            if @@vtype = 8 and @@costbreakup > 0        
      =======================================================================================*/      
      if @@costbreakup > 0        
      begin        
            DELETE t2      
            FROM templedger2 t2      
            WHERE rtrim(sessionid) = rtrim(@sessionid)       
                  AND upper(rtrim(branch)) = 'ALL'       
                  AND vno = @vno       
                  AND costflag = 'A'       
                  AND exists       
                        (       
                              SELECT       
               party_code       
                              FROM templedger2 t1      
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'C'      
        )       
      
            /*DELETE t2      
            FROM templedger2 t2      
            WHERE rtrim(sessionid) = rtrim(@sessionid)       
                  AND vno = @vno       
                  AND costflag = 'C'       
       AND exists       
                        (       
                              SELECT       
                                    party_code       
                              FROM templedger2 t1      
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'A' and upper(rtrim(t1.branch)) <> 'ALL'      
                        )   */    
      
  end    
      
            UPDATE       
                  templedger2       
                  SET costflag = 'A'       
            
            if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24        
            begin        
                  UPDATE       
                    templedger2       
                        SET branch = 'HO'       
                  WHERE upper(rtrim(branch)) = 'ALL'       
                        AND costflag = 'A'       
                    
      end        
        
      set @@rcursor = cursor for        
            SELECT       
                  category,      
                  branch,      
                  paidamt,      
                  vtype,      
                  vno,      
                  lno,      
                  drcr,      
                  costcode,      
                  booktype,      
                  sessionid,      
                  party_code       
            FROM templedger2       
            WHERE category = 'BRANCH'       
                  AND rtrim(sessionid) = rtrim(@sessionid)       
                  AND vno =@vno       
                  AND costflag = 'A'       
      open @@rcursor        
      fetch next from @@rcursor         
      into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code         
        
      while @@fetch_status = 0        
      begin        
            if rtrim(@@branch) = 'ALL'        
            begin        
                  select @@Allcount = @@Allcount + 1        
            end        
            else         
            if rtrim(@@branch) = @@OldBranch        
            begin        
                  select @@OnlyAll = 1        
            end        
            else        
            if @@OldBranch = ''        
            begin        
                  select @@OnlyAll = 1        
                  select @@OldBranch = rtrim(@@branch)        
                  select @@Branchcount = @@Branchcount + 1        
            end        
            else         
            begin        
                  select @@OnlyAll = 1        
                  select @@Branchcount = @@Branchcount + 1        
                  select @@Multibranch = 0        
                  select @@OneBranch = 1                   
            end        
                  
            fetch next from @@rcursor         
            into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code         
      end        
      close @@rcursor        
      deallocate @@rcursor        
        
/*      select "AllCount = " + convert(varchar,@@Allcount)        
      select "BranchCount = " + convert(varchar,@@BranchCount)  */      
        
      if @@onlyall = 1        
      begin        
            if @@Allcount = 0        
            begin        
                  if @@branchcount = 1        
                  begin        
                        select @@onebranch = 0        
                        select @@multibranch = 1        
                        select @@oneBranchAll = 1        
                        select @@MultiBranchall = 1        
                end        
                  else        
                  begin        
                        select @@Multibranch = 0        
                        select @@onebranch = 1        
                        select @@oneBranchAll = 1        
                        select @@MultiBranchall = 1        
                  end        
            end        
            else        
            begin        
           if @@branchcount = 1        
                  begin        
                        select @@onebranchAll = 0        
                        select @@onebranch = 1        
                        select @@multibranch = 1        
                        select @@MultiBranchall = 1        
                  end        
                  else        
                  begin        
                        select @@MultibranchAll = 0        
          select @@onebranch = 1        
                        select @@multibranch = 1        
                        select @@onebranchAll = 1        
                  end        
            end        
      end        
        
      if @@Onlyall = 0         
      begin        
            SELECT       
                  @@vtype =       
                        (      
                              SELECT DISTINCT       
                                    vtype       
                              FROM templedger2       
                              WHERE rtrim(sessionid) = rtrim(@sessionid)       
                                    AND vno = @vno      
        )       
                  SELECT       
                  @@party2 =       
                        (      
                              SELECT DISTINCT       
                                    party_code       
                              FROM templedger2       
                              WHERE rtrim(sessionid) = rtrim(@sessionid)       
                                    AND upper(rtrim(branch)) = 'ALL'       
                                    AND vno = @vno       
                                    AND costflag = 'A'       
                                    AND lno = 1      
                        )       
            SELECT       
                  @@costbreakup =       
                        (      
                              SELECT       
                                    count(*)       
                              FROM templedger2       
                              WHERE rtrim(sessionid) = rtrim(@sessionid)       
                                    AND category = 'BRANCH'       
                                    AND vno = @vno       
                                    AND costflag = 'C'      
                        )       
            
            if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')         
            begin        
                  DELETE       
                  FROM templedger2       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND category = 'BRANCH'       
                        AND upper(branch) = 'ALL'       
                        AND vno = @vno       
                        AND costflag = 'A'       
            
                  DELETE       
                  FROM templedger2       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND category = 'BRANCH'       
                        AND upper(drcr) = 'C'       
                        AND vno = @vno       
                        AND costflag = 'C'       
            
                  INSERT       
                  INTO templedger2       
                  SELECT       
                        category,       
                        branch,       
                        paidamt,       
                        vtype,       
                        vno,       
                        1,       
                        (       
                              CASE       
                                    WHEN drcr = 'D'       
                                    THEN 'C'       
                                    ELSE 'D'       
                              END      
                        ),       
                        costcode,       
                        booktype,       
                        sessionid,       
                        @@party2,       
                        costflag,       
                        1       
                  FROM templedger2       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND category = 'BRANCH'       
                        AND vno = @vno       
            end        
if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )        
            begin        
                  DELETE       
                  FROM templedger2       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND category = 'BRANCH'       
                        AND upper(branch) = 'ALL'       
                        AND vno = @vno       
                        AND costflag = 'A'       
            
                  DELETE       
                  FROM templedger2       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND category = 'BRANCH'       
        AND upper(drcr) = 'D'       
                        AND vno = @vno       
                        AND costflag = 'C'       
            
                  INSERT       
                  INTO templedger2       
                  SELECT       
                        category,       
                        branch,       
                        paidamt,       
                        vtype,       
                        vno,       
                        1,       
                        (       
                              CASE       
                                    WHEN drcr = 'D'       
                                    THEN 'C'       
                           ELSE 'D'       
                              END      
                        ),       
                        costcode,       
                        booktype,       
                        sessionid,       
                        @@party2,       
                        costflag,       
                        1       
                  FROM templedger2       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND category = 'BRANCH'       
                        AND vno = @vno       
            end        
      end        
        
        
      if @@Onlyall = 0         
      begin         
            if @statusid = 'BRANCH'         
            begin        
                  INSERT       
                  INTO ledger2       
                  SELECT       
                        vtype,       
                        vno,       
                        lno,       
                        drcr,       
                        paidamt,       
                        c.costcode,       
                        BookType,      
                        upper(party_code)       
                  FROM templedger2 t,       
                        costmast c       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND rtrim(costname) = rtrim(@statusname)       
                        AND category = 'BRANCH'       
                        AND vno =@vno       
                        AND costflag = 'A'       
            end        
            else        
            begin        
                  INSERT       
                  INTO ledger2       
                  SELECT       
                        vtype,       
                        vno,       
                        lno,       
                        drcr,       
                        paidamt,       
                        c.costcode,       
                        BookType,      
                        upper(party_code)       
                  FROM templedger2 t,       
                        Branchaccounts b,       
                        costmast c       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND DefaultAc = 1       
                        AND rtrim(BranchName) = rtrim(costname)       
                        AND category = 'BRANCH'       
                        AND vno =@vno       
                        AND costflag = 'A'       
            end        
      end        
      else        
      if @@OneBranch = 0        
      begin        
            INSERT       
            INTO ledger2       
            SELECT       
                  vtype,       
                  vno,       
                  lno,       
                  drcr,       
                  paidamt,       
                  c.costcode,       
                  BookType,       
                  upper(party_code )       
            FROM templedger2 t,       
       costmast c       
            WHERE rtrim(sessionid) = rtrim(@sessionid)       
                  AND rtrim(branch) = rtrim(costname)       
                  AND category = 'BRANCH'       
                  AND vno =@vno       
                  AND costflag = 'A'       
      end        
      else        
      if @@MultiBranch = 0        
      Begin        
            INSERT       
            INTO ledger2       
            SELECT       
                  vtype,       
                  vno,       
                  lno,       
                  drcr,       
                  paidamt,       
                  c.costcode,       
                  BookType,       
                  upper(party_code)       
            FROM templedger2 t,       
                  costmast c       
            WHERE rtrim(sessionid) = rtrim(@sessionid)       
                  AND rtrim(branch) = rtrim(costname)       
                  AND category = 'BRANCH'       
                  AND vno =@vno       
                  AND costflag = 'A'       
            
            INSERT       
            INTO ledger2       
            SELECT       
                  vtype,       
                  vno,       
                  lno,       
                  drcr,       
                  paidamt,       
                  costcode=       
                        (       
                              SELECT       
                                    costcode       
                              FROM costmast c,       
 branchaccounts b       
                              WHERE DefaultAc = 1       
                                    AND rtrim(branchname) = rtrim(costname)      
                        ),       
                  BookType,       
                  upper(BrControlAc)       
            FROM templedger2 t,       
                  branchaccounts b       
            WHERE rtrim(sessionid) = rtrim(@sessionid)       
                  AND rtrim(branch) = rtrim(branchname)       
                  AND category = 'BRANCH'       
                  AND vno =@vno       
                  AND costflag = 'A'       
                  AND rtrim(branch) <> rtrim(@@mainbr)       
            
            INSERT       
            INTO ledger2       
            SELECT       
                  vtype,       
                  vno,       
                  lno,       
                  (       
                        CASE       
                              WHEN drcr= 'd'       
                              OR drcr = 'D'       
                              THEN 'C'       
                              ELSE 'D'       
                        END      
                  ),       
                  paidamt,       
                  c.costcode,       
                  BookType,       
                  upper(MainControlAc)       
            FROM templedger2 t,       
                  costmast c,       
                  branchaccounts b       
            WHERE rtrim(sessionid) = rtrim(@sessionid)       
                  AND rtrim(branch) = rtrim(costname)       
                  AND rtrim(BranchName) = rtrim(branch)       
                  AND category = 'BRANCH'       
                  AND vno =@vno       
                  AND costflag = 'A'       
                  AND rtrim(branch) <> rtrim(@@mainbr)       
      end        
      else        
      if @@OneBranchAll = 0         
      begin        
      set @@rcursor = cursor for        
            SELECT       
                  branch       
            FROM templedger2       
            WHERE category = 'BRANCH'       
                  AND rtrim(sessionid) = rtrim(@sessionid)       
                  AND vno = @vno       
                  AND branch <> 'ALL'       
                  AND costflag = 'A'       
            ORDER BY branch       
            open @@rcursor        
            fetch next from @@rcursor into @@branch         
            while @@fetch_status = 0        
            begin        
            SELECT @@costcode1 =       
                        (       
                              SELECT       
                                    costcode       
                              FROM costmast       
                              WHERE rtrim(@@branch) = rtrim(costname)      
                        )       
                  fetch next from @@rcursor into @@branch         
                  end        
                  close @@rcursor        
                  deallocate @@rcursor        
                  
                  INSERT       
                  INTO ledger2       
                  SELECT       
                        vtype,       
                        vno,       
                        lno,       
                        drcr,       
                        paidamt,       
                        c.costcode,       
                        BookType,       
                        upper(party_code)       
                  FROM templedger2 t,       
                        costmast c       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND rtrim(branch) = rtrim(costname)       
                        AND category = 'BRANCH'       
                        AND vno =@vno       
                        AND costflag = 'A'       
                  
                  INSERT       
                  INTO ledger2       
                  SELECT       
                        vtype,       
                        vno,       
                        lno,       
                        drcr,       
                        paidamt,       
                        @@costcode1,       
                        BookType,       
                        upper(party_code)       
                  FROM templedger2 t       
                  WHERE rtrim(sessionid) = rtrim(@sessionid)       
                        AND rtrim(branch) = 'ALL'       
                        AND category = 'BRANCH'       
                        AND vno =@vno       
                        AND costflag = 'A'       
            end        
      end        
        
      if @costcenterflag  = 1        
      begin        
            INSERT       
            INTO ledger2       
            SELECT       
                  vtype,       
                  @vno,       
                  lno,       
                  drcr,       
                  paidamt,       
                  costcode,       
                  BookType,      
                  upper(party_code )       
            FROM templedger2 t       
            WHERE rtrim(sessionid) = rtrim(@sessionid)       
                  AND vno = @vno       
                  AND costflag = 'C'       
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_CLOSEPOS
-- --------------------------------------------------

CREATE PROC [dbo].[MFUND_RPT_FUNDING_CLOSEPOS](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(50)='',                    
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                    
  @OPT VARCHAR(20)=''                  
)            
AS     

SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY 
						WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOPARTY END) 

SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @FROMSCRIP 
						WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOSCRIP END) 

SELECT SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE), 
EXCHANGE = (CASE WHEN SETT_TYPE IN ('D', 'C') THEN 'BSE' ELSE 'NSE' END),
SETT_NO, SETT_TYPE, 
T.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),
SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MARKETVALUE=MKTAMT, NETVALUE = NETAMT, CL_RATE 
INTO #DATA
FROM TBL_PRODUCT_POSITION T, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE ADJUST_DATE = @FROMDATE 
AND SELL_BUY = 1
AND C1.CL_CODE = T.PARTY_CODE
AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND @STATUSNAME =          
                  (CASE          
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD          
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER          
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER          
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY          
                        WHEN @STATUSID = 'AREA' THEN C1.AREA          
                        WHEN @STATUSID = 'REGION' THEN C1.REGION          
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE          
                  ELSE          
                        'BROKER'          
                  END)    
 
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES            
            
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1, ANGELDEMAT.BSEDB.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.BSECODE = #DATA.BSECODE      
AND SCRIP_NAME = ''     

SELECT * FROM #DATA
WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP            
ORDER BY PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_HOLDING
-- --------------------------------------------------

CREATE PROC [dbo].[MFUND_RPT_FUNDING_HOLDING](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(50)='',                    
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                    
  @OPT VARCHAR(20)='MTF'                  
)            
AS  

SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY 
						WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOPARTY END) 

SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @TOSCRIP 
						WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOSCRIP END) 

SELECT T.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),
SCRIP_CD, SERIES, BSECODE, ISIN,
APP_FLAG = (CASE WHEN FOGFLAG = 1 THEN 'APPROV' ELSE 'UNAPPROV' END), 
DEBITHOLD=SUM(CASE WHEN HOLDFLAG = 'BEN' THEN QTY ELSE 0 END),
MTFCOLL=SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN QTY ELSE 0 END),
CMCOLL=SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN QTY ELSE 0 END),
FOCOLL=SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN QTY ELSE 0 END),
POA=SUM(CASE WHEN HOLDFLAG = 'POA' THEN QTY ELSE 0 END), 
SELLSHORT=SUM(CASE WHEN HOLDFLAG = 'OPEN SELL POSITION' THEN QTY ELSE 0 END),
CL_RATE, 
GROSS_AMT = CONVERT(NUMERIC(18,2),0),
VARRATE = HAIRCUT,
NET_AMT = CONVERT(NUMERIC(18,2),0)
INTO #DATA FROM TBL_PRODUCT_HOLD_DATA T, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE = @FROMDATE  
AND C1.CL_CODE = T.PARTY_CODE
AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND @STATUSNAME =          
                  (CASE          
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD          
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER          
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER          
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY          
                        WHEN @STATUSID = 'AREA' THEN C1.AREA          
                        WHEN @STATUSID = 'REGION' THEN C1.REGION          
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE          
                  ELSE          
                        'BROKER'          
                  END)    
AND HOLDFLAG NOT IN ('PAY-IN GIVEN') 
AND HOLDFLAG = (CASE WHEN @OPT = 'MTF' THEN 'MTFCOLL' ELSE HOLDFLAG END)
GROUP BY T.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, BSECODE, ISIN, CL_RATE,HAIRCUT, FOGFLAG

UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES            
            
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1, ANGELDEMAT.BSEDB.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.BSECODE = #DATA.BSECODE      
AND SCRIP_NAME = ''     

UPDATE #DATA SET GROSS_AMT = (DEBITHOLD + CMCOLL + MTFCOLL + FOCOLL - SELLSHORT + POA) * CL_RATE,
			     NET_AMT = (DEBITHOLD + CMCOLL + MTFCOLL + FOCOLL + POA) * CL_RATE
						 - (DEBITHOLD + CMCOLL + MTFCOLL + FOCOLL + POA) * CL_RATE * VARRATE / 100
						 - (SELLSHORT*CL_RATE + SELLSHORT*CL_RATE*VARRATE/100)

SELECT * FROM #DATA
WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP            
ORDER BY PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_OPENPOS
-- --------------------------------------------------
    
CREATE PROC [dbo].[MFUND_RPT_FUNDING_OPENPOS](                      
  @STATUSID VARCHAR(50),                        
  @STATUSNAME VARCHAR(50),                        
  @FROMDATE VARCHAR(11),                        
  @TODATE  VARCHAR(11),                        
  @FROMPARTY VARCHAR(10),                        
  @TOPARTY VARCHAR(10),                        
  @FROMSCRIP VARCHAR(50)='',                        
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                        
  @OPT VARCHAR(20)=''                      
)                
AS         
-- EXEC MFUND_RPT_FUNDING_OPENPOS 'BROKER', 'BROKER', 'JAN  6 2022', 'JAN  6 2022', 'H31224', 'H31224', '0', 'ZZZ', ''    
    
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY     
      WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'    
      ELSE @TOPARTY END)     
    
SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @FROMSCRIP     
      WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'    
      ELSE @TOSCRIP END)     
                  
SELECT ORGBUYDATE = CONVERT(VARCHAR,SAUDA_DATE,103),     
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),    
EXCHANGE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'BSE' ELSE 'NSE' END),    
SETT_NO, SETT_TYPE,     
T.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),    
SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MARKETVALUE=MKTAMT, NETVALUE = NETAMT,     
CL_RATE,    
HAIRCUT = CONVERT(NUMERIC(18,4),0),    
MTOMLOSS = CONVERT(NUMERIC(18,4),0),    
MARG_REQ = CONVERT(NUMERIC(18,4),0),    
TOTAL_REQ = CONVERT(NUMERIC(18,4),0),    
OPENDAY = DATEDIFF(D,SAUDA_DATE,CONVERT(DATETIME,@FROMDATE))    
INTO #DATA    
FROM TBL_PRODUCT_POSITION T WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS  C1  WITH(NOLOCK)  
WHERE SAUDA_DATE <= @FROMDATE     
AND ADJUST_DATE > @FROMDATE    
AND SELL_BUY = 1     
AND C1.CL_CODE = T.PARTY_CODE    
AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
AND @STATUSNAME =              
                  (CASE              
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD              
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER              
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER              
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY              
                        WHEN @STATUSID = 'AREA' THEN C1.AREA              
                        WHEN @STATUSID = 'REGION' THEN C1.REGION              
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE              
                  ELSE              
                        'BROKER'              
                  END)        
    
UPDATE #DATA SET CL_RATE = CURR_CL_RATE,    
HAIRCUT = C.HAIRCUT    
FROM TBL_MTF_DATA C  WITH(NOLOCK)  
WHERE C.SAUDA_DATE = @FROMDATE    
AND #DATA.ISIN = C.ISIN    
AND #DATA.PARTY_CODE = C.PARTY_CODE    
  
  
SELECT PARTY_CODE, ISIN,QTY= SUM(QTY),MARGIN_REQ=SUM(MARGIN_REQ),MTOM_LOSS=SUM(MTOM_LOSS)   
INTO #MAR FROM TBL_MTF_DATA C  WITH(NOLOCK)  
WHERE C.SAUDA_DATE = @FROMDATE    
GROUP BY PARTY_CODE,ISIN  
  
UPDATE #DATA SET MTOMLOSS = (CL_RATE * QTY - MARKETVALUE )     
WHERE HAIRCUT <> 100    
    
UPDATE #DATA SET MARG_REQ = (CASE WHEN NETVALUE > CL_RATE*QTY THEN  CL_RATE * QTY * HAIRCUT / 100 ELSE NETVALUE * HAIRCUT / 100 END)   
    
  UPDATE #DATA SET MTOMLOSS = (C.MTOM_LOSS/C.QTY)*#DATA.QTY,  MARG_REQ=(C.MARGIN_REQ/C.QTY)*#DATA.QTY  
  FROM #MAR C  
  WHERE C.PARTY_CODE = #DATA.PARTY_CODE  
  AND C.ISIN= #DATA.ISIN  
  
  
UPDATE #DATA SET TOTAL_REQ = MARG_REQ - MTOMLOSS    
    
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1 WITH(NOLOCK), MSAJAG.DBO.SCRIP2 S2   WITH(NOLOCK)             
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES                
                
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1 WITH(NOLOCK), ANGELDEMAT.BSEDB.DBO.SCRIP2 S2    WITH(NOLOCK)            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                
AND S2.BSECODE = #DATA.BSECODE               
AND SCRIP_NAME = ''         
    
SELECT * FROM #DATA    
WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP                
ORDER BY OPENDAY, PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_OPENPOS_bak_nov282019
-- --------------------------------------------------

CREATE PROC [dbo].[MFUND_RPT_FUNDING_OPENPOS](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(50)='',                    
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                    
  @OPT VARCHAR(20)=''                  
)            
AS     
-- EXEC MFUND_RPT_FUNDING_OPENPOS 'BROKER', 'BROKER', 'aug 14 2017', 'aug 14 2017', 'V67413', 'V67413', '0', 'ZZZ', ''

SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY 
						WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOPARTY END) 

SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @FROMSCRIP 
						WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOSCRIP END) 
 												 
SELECT ORGBUYDATE = CONVERT(VARCHAR,SAUDA_DATE,103), 
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),
EXCHANGE = (CASE WHEN SETT_TYPE IN ('D', 'C') THEN 'BSE' ELSE 'NSE' END),
SETT_NO, SETT_TYPE, 
t.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),
SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MARKETVALUE=MKTAMT, NETVALUE = NETAMT, 
CL_RATE,
HAIRCUT = CONVERT(NUMERIC(18,4),0),
MTOMLOSS = CONVERT(NUMERIC(18,4),0),
MARG_REQ = CONVERT(NUMERIC(18,4),0),
TOTAL_REQ = CONVERT(NUMERIC(18,4),0),
OPENDAY = DATEDIFF(D,SAUDA_DATE,CONVERT(DATETIME,@FROMDATE))
INTO #DATA
FROM TBL_PRODUCT_POSITION T, MSAJAG.DBO.CLIENT_details C1
WHERE SAUDA_DATE <= @FROMDATE 
AND ADJUST_DATE > @FROMDATE
AND SELL_BUY = 1 
AND C1.CL_CODE = t.PARTY_CODE
AND t.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND @STATUSNAME =          
                  (CASE          
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD          
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER          
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER          
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY          
                        WHEN @STATUSID = 'AREA' THEN C1.AREA          
                        WHEN @STATUSID = 'REGION' THEN C1.REGION          
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE          
                  ELSE          
                        'BROKER'          
                  END)    

UPDATE #DATA SET CL_RATE = CURR_CL_RATE,
HAIRCUT = C.HAIRCUT
FROM TBL_MTF_DATA C
WHERE C.SAUDA_DATE = @FROMDATE
AND #DATA.ISIN = C.ISIN
AND #DATA.PARTY_CODE = C.PARTY_CODE

UPDATE #DATA SET MTOMLOSS = (CL_RATE * QTY - MARKETVALUE ) 
WHERE HAIRCUT <> 100

UPDATE #DATA SET MARG_REQ = MARKETVALUE * HAIRCUT / 100

UPDATE #DATA SET TOTAL_REQ = MARG_REQ - MTOMLOSS

UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES            
            
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1, ANGELDEMAT.BSEDB.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.BSECODE = #DATA.BSECODE           
AND SCRIP_NAME = ''     

SELECT * FROM #DATA
WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP            
ORDER BY OPENDAY, PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_OPENPOS_BKUP_25Nov2022
-- --------------------------------------------------
  
Create PROC [dbo].[MFUND_RPT_FUNDING_OPENPOS_BKUP_25Nov2022](                    
  @STATUSID VARCHAR(50),                      
  @STATUSNAME VARCHAR(50),                      
  @FROMDATE VARCHAR(11),                      
  @TODATE  VARCHAR(11),                      
  @FROMPARTY VARCHAR(10),                      
  @TOPARTY VARCHAR(10),                      
  @FROMSCRIP VARCHAR(50)='',                      
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                      
  @OPT VARCHAR(20)=''                    
)              
AS       
-- EXEC MFUND_RPT_FUNDING_OPENPOS 'BROKER', 'BROKER', 'JAN  6 2022', 'JAN  6 2022', 'H31224', 'H31224', '0', 'ZZZ', ''  
  
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY   
      WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'  
      ELSE @TOPARTY END)   
  
SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @FROMSCRIP   
      WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'  
      ELSE @TOSCRIP END)   
                
SELECT ORGBUYDATE = CONVERT(VARCHAR,SAUDA_DATE,103),   
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),  
EXCHANGE = (CASE WHEN SETT_TYPE IN ('D', 'C') THEN 'BSE' ELSE 'NSE' END),  
SETT_NO, SETT_TYPE,   
T.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),  
SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MARKETVALUE=MKTAMT, NETVALUE = NETAMT,   
CL_RATE,  
HAIRCUT = CONVERT(NUMERIC(18,4),0),  
MTOMLOSS = CONVERT(NUMERIC(18,4),0),  
MARG_REQ = CONVERT(NUMERIC(18,4),0),  
TOTAL_REQ = CONVERT(NUMERIC(18,4),0),  
OPENDAY = DATEDIFF(D,SAUDA_DATE,CONVERT(DATETIME,@FROMDATE))  
INTO #DATA  
FROM TBL_PRODUCT_POSITION T WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS  C1  WITH(NOLOCK)
WHERE SAUDA_DATE <= @FROMDATE   
AND ADJUST_DATE > @FROMDATE  
AND SELL_BUY = 1   
AND C1.CL_CODE = T.PARTY_CODE  
AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
AND @STATUSNAME =            
                  (CASE            
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
                        WHEN @STATUSID = 'AREA' THEN C1.AREA            
                        WHEN @STATUSID = 'REGION' THEN C1.REGION            
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE            
                  ELSE            
                        'BROKER'            
                  END)      
  
UPDATE #DATA SET CL_RATE = CURR_CL_RATE,  
HAIRCUT = C.HAIRCUT  
FROM TBL_MTF_DATA C  WITH(NOLOCK)
WHERE C.SAUDA_DATE = @FROMDATE  
AND #DATA.ISIN = C.ISIN  
AND #DATA.PARTY_CODE = C.PARTY_CODE  


SELECT PARTY_CODE, ISIN,QTY= SUM(QTY),MARGIN_REQ=SUM(MARGIN_REQ),MTOM_LOSS=SUM(MTOM_LOSS) 
INTO #MAR FROM TBL_MTF_DATA C  WITH(NOLOCK)
WHERE C.SAUDA_DATE = @FROMDATE  
GROUP BY PARTY_CODE,ISIN

UPDATE #DATA SET MTOMLOSS = (CL_RATE * QTY - MARKETVALUE )   
WHERE HAIRCUT <> 100  
  
UPDATE #DATA SET MARG_REQ = (CASE WHEN NETVALUE > CL_RATE*QTY THEN  CL_RATE * QTY * HAIRCUT / 100 ELSE NETVALUE * HAIRCUT / 100 END) 
  
  UPDATE #DATA SET MTOMLOSS = (C.MTOM_LOSS/C.QTY)*#DATA.QTY,  MARG_REQ=(C.MARGIN_REQ/C.QTY)*#DATA.QTY
  FROM #MAR C
  WHERE C.PARTY_CODE = #DATA.PARTY_CODE
  AND C.ISIN= #DATA.ISIN


UPDATE #DATA SET TOTAL_REQ = MARG_REQ - MTOMLOSS  
  
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1 WITH(NOLOCK), MSAJAG.DBO.SCRIP2 S2   WITH(NOLOCK)           
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES              
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES              
              
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1 WITH(NOLOCK), ANGELDEMAT.BSEDB.DBO.SCRIP2 S2    WITH(NOLOCK)          
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES              
AND S2.BSECODE = #DATA.BSECODE             
AND SCRIP_NAME = ''       
  
SELECT * FROM #DATA  
WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP              
ORDER BY OPENDAY, PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_OPENPOS_MORETHAN_90DAYS
-- --------------------------------------------------

CREATE PROC [dbo].[MFUND_RPT_FUNDING_OPENPOS_MORETHAN_90DAYS](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(50)='',                    
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                    
  @OPT VARCHAR(20)=''                  
)            
AS     
-- EXEC MFUND_RPT_FUNDING_OPENPOS 'BROKER', 'BROKER', 'aug 14 2017', 'aug 14 2017', 'V67413', 'V67413', '0', 'ZZZ', ''

SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY 
						WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOPARTY END) 

SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @FROMSCRIP 
						WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOSCRIP END) 
 												 
SELECT ORGBUYDATE = CONVERT(VARCHAR,SAUDA_DATE,103), 
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),
EXCHANGE = (CASE WHEN SETT_TYPE IN ('D', 'C') THEN 'BSE' ELSE 'NSE' END),
SETT_NO, SETT_TYPE, 
t.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),
SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MARKETVALUE=MKTAMT, NETVALUE = NETAMT, 
CL_RATE,
HAIRCUT = CONVERT(NUMERIC(18,4),0),
MTOMLOSS = CONVERT(NUMERIC(18,4),0),
MARG_REQ = CONVERT(NUMERIC(18,4),0),
TOTAL_REQ = CONVERT(NUMERIC(18,4),0),
OPENDAY = DATEDIFF(D,SAUDA_DATE,CONVERT(DATETIME,@FROMDATE))
INTO #DATA
FROM TBL_PRODUCT_POSITION T, MSAJAG.DBO.CLIENT_details C1
WHERE SAUDA_DATE <= @FROMDATE 
AND ADJUST_DATE > @FROMDATE
AND SELL_BUY = 1 
AND C1.CL_CODE = t.PARTY_CODE
AND t.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
 

UPDATE #DATA SET CL_RATE = CURR_CL_RATE,
HAIRCUT = C.HAIRCUT
FROM TBL_MTF_DATA C
WHERE C.SAUDA_DATE = @FROMDATE
AND #DATA.ISIN = C.ISIN
AND #DATA.PARTY_CODE = C.PARTY_CODE

UPDATE #DATA SET MTOMLOSS = (CL_RATE * QTY - MARKETVALUE ) 
WHERE HAIRCUT <> 100

UPDATE #DATA SET MARG_REQ = MARKETVALUE * HAIRCUT / 100

UPDATE #DATA SET TOTAL_REQ = MARG_REQ - MTOMLOSS

UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES            
            
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1, ANGELDEMAT.BSEDB.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.BSECODE = #DATA.BSECODE           
AND SCRIP_NAME = ''     

SELECT * FROM #DATA WHERE OPENDAY >=90
--WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP            
ORDER BY OPENDAY, PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_SELLPOS
-- --------------------------------------------------
  
CREATE PROC [dbo].[MFUND_RPT_FUNDING_SELLPOS](                    
  @STATUSID VARCHAR(50),                      
  @STATUSNAME VARCHAR(50),                      
  @FROMDATE VARCHAR(11),                      
  @TODATE  VARCHAR(11),                      
  @FROMPARTY VARCHAR(10),                      
  @TOPARTY VARCHAR(10),                      
  @FROMSCRIP VARCHAR(50)='',                      
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                      
  @OPT VARCHAR(20)=''                    
)              
AS       
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY   
      WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'  
      ELSE @TOPARTY END)   
  
SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @FROMSCRIP   
      WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'  
      ELSE @TOSCRIP END)   
  
SELECT SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE),   
EXCHANGE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'BSE' ELSE 'NSE' END),  
SETT_NO, SETT_TYPE,   
t.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),  
SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MARKETVALUE=MKTAMT, NETVALUE = NETAMT, CL_RATE   
INTO #DATA  
FROM TBL_PRODUCT_POSITION T, MSAJAG.DBO.CLIENT_details C1  
WHERE SAUDA_DATE = @FROMDATE   
AND SELL_BUY = 2   
AND C1.CL_CODE = t.PARTY_CODE  
AND t.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
AND @STATUSNAME =            
                  (CASE            
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
                        WHEN @STATUSID = 'AREA' THEN C1.AREA            
                        WHEN @STATUSID = 'REGION' THEN C1.REGION            
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE            
                  ELSE            
                        'BROKER'            
                  END)      
  
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2              
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES              
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES              
              
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1, ANGELDEMAT.BSEDB.DBO.SCRIP2 S2              
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES              
AND S2.BSECODE = #DATA.BSECODE        
AND SCRIP_NAME = ''       
  
SELECT * FROM #DATA  
WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP              
ORDER BY PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_SELLPOS_BKUP_25Nov2022
-- --------------------------------------------------


CREATE PROC [dbo].[MFUND_RPT_FUNDING_SELLPOS_BKUP_25Nov2022](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(50)='',                    
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                    
  @OPT VARCHAR(20)=''                  
)            
AS     
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY 
						WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOPARTY END) 

SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @FROMSCRIP 
						WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'
						ELSE @TOSCRIP END) 

SELECT SAUDA_DATE = CONVERT(DATETIME,SAUDA_DATE), 
EXCHANGE = (CASE WHEN SETT_TYPE IN ('D', 'C') THEN 'BSE' ELSE 'NSE' END),
SETT_NO, SETT_TYPE, 
t.PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),
SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MARKETVALUE=MKTAMT, NETVALUE = NETAMT, CL_RATE 
INTO #DATA
FROM TBL_PRODUCT_POSITION T, MSAJAG.DBO.CLIENT_details C1
WHERE SAUDA_DATE = @FROMDATE 
AND SELL_BUY = 2 
AND C1.CL_CODE = t.PARTY_CODE
AND t.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND @STATUSNAME =          
                  (CASE          
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD          
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER          
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER          
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY          
                        WHEN @STATUSID = 'AREA' THEN C1.AREA          
                        WHEN @STATUSID = 'REGION' THEN C1.REGION          
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE          
                  ELSE          
                        'BROKER'          
                  END)    

UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES            
            
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM ANGELDEMAT.BSEDB.DBO.SCRIP1 S1, ANGELDEMAT.BSEDB.DBO.SCRIP2 S2            
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES            
AND S2.BSECODE = #DATA.BSECODE      
AND SCRIP_NAME = ''     

SELECT * FROM #DATA
WHERE SCRIP_NAME  >= @FROMSCRIP AND SCRIP_NAME  <= @TOSCRIP            
ORDER BY PARTY_CODE, LONG_NAME, SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_SUMMARY
-- --------------------------------------------------

CREATE PROC [dbo].[MFUND_RPT_FUNDING_SUMMARY](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(12)='',                    
  @TOSCRIP VARCHAR(12)='',                    
  @OPT VARCHAR(20)=''                  
)            
AS               

-- EXEC MFUND_RPT_FUNDING_SUMMARY 'BROKER', 'BROKER', 'SEP 15 2020','SEP 15 2020','R188978','R188978'
DECLARE @PREVDATE VARCHAR(11),            
  @TRANSDATE VARCHAR(11)            
            
SET @TRANSDATE = @FROMDATE            
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' THEN 'ZZZZZ' ELSE @TOPARTY END)     

SELECT M.* INTO #TBL_MTF_DATA
FROM TBL_MTF_DATA M, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE = @FROMDATE
AND m.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = m.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)  

UPDATE #TBL_MTF_DATA SET MTOM_LOSS = -MTOM_LOSS
WHERE SAUDA_DATE <= 'NOV 27 2019'

SELECT m.PARTY_CODE, LONG_NAME,
	   MTF_REQ   = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL),
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, POAHOLDING_APP = POAHOLDING_MTF,
	   CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ, 
	   NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ
INTO #MARREQ
FROM #TBL_MTF_DATA M, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE = @FROMDATE
AND m.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = m.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)          
GROUP BY m.PARTY_CODE,LONG_NAME,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF

SELECT * FROM #MARREQ
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_SUMMARY_LOG
-- --------------------------------------------------

CREATE PROC [dbo].[MFUND_RPT_FUNDING_SUMMARY_LOG](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(12)='',                    
  @TOSCRIP VARCHAR(12)='',                    
  @OPT VARCHAR(20)=''                  
)            
AS               

-- EXEC MFUND_RPT_FUNDING_SUMMARY 'BROKER', 'BROKER', 'NOV 29 2019','NOV 29 2019','N77688','N77688'
DECLARE @PREVDATE VARCHAR(11),            
  @TRANSDATE VARCHAR(11)            
            
SET @TRANSDATE = @FROMDATE            
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' THEN 'ZZZZZ' ELSE @TOPARTY END)     

SELECT M.* INTO #TBL_MTF_DATA
FROM TBL_MTF_DATA_LOG M, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE = @FROMDATE
AND m.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = m.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)  

UPDATE #TBL_MTF_DATA SET MTOM_LOSS = -MTOM_LOSS
WHERE SAUDA_DATE <= 'NOV 27 2019'

SELECT RUNDATE,m.PARTY_CODE, LONG_NAME,
	   MTF_REQ   = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL),
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, POAHOLDING_APP = POAHOLDING_MTF,
	   CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ, 
	   NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ
INTO #MARREQ
FROM #TBL_MTF_DATA M, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE = @FROMDATE
AND m.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = m.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)          
GROUP BY RUNDATE,m.PARTY_CODE,LONG_NAME,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF

SELECT * FROM #MARREQ
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_FUNDING_SUMMARY_NRMS
-- --------------------------------------------------

create PROC [dbo].[MFUND_RPT_FUNDING_SUMMARY_NRMS](                  
  @STATUSID VARCHAR(50),                    
  @STATUSNAME VARCHAR(50),                    
  @FROMDATE VARCHAR(11),                    
  @TODATE  VARCHAR(11),                    
  @FROMPARTY VARCHAR(10),                    
  @TOPARTY VARCHAR(10),                    
  @FROMSCRIP VARCHAR(12)='',                    
  @TOSCRIP VARCHAR(12)='',                    
  @OPT VARCHAR(20)=''                  
)            
AS               

-- EXEC MFUND_RPT_FUNDING_SUMMARY 'BROKER', 'BROKER', 'Oct 07 2023','Oct 07 2023','',''
DECLARE @PREVDATE VARCHAR(11),            
  @TRANSDATE VARCHAR(11)            
            
SET @TRANSDATE = @FROMDATE            
SELECT @FROMPARTY = (CASE WHEN @FROMPARTY = '' THEN 'AAAAA' ELSE @TOPARTY END)     
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' THEN 'ZZZZZ' ELSE @TOPARTY END)     

SELECT M.* INTO #TBL_MTF_DATA
FROM TBL_MTF_DATA M, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE = @FROMDATE
AND m.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = m.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)  

UPDATE #TBL_MTF_DATA SET MTOM_LOSS = -MTOM_LOSS
WHERE SAUDA_DATE <= 'NOV 27 2019'

SELECT m.PARTY_CODE, LONG_NAME,
	   MTF_REQ   = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL),
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, POAHOLDING_APP = POAHOLDING_MTF,
	   CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ, 
	   NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ
INTO #MARREQ
FROM #TBL_MTF_DATA M, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE = @FROMDATE
AND m.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = m.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)          
GROUP BY m.PARTY_CODE,LONG_NAME,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF

SELECT * FROM #MARREQ
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MFUND_RPT_POSITIONCLOSE_MANUAL
-- --------------------------------------------------
  
CREATE PROC [dbo].[MFUND_RPT_POSITIONCLOSE_MANUAL](                    
  @STATUSID VARCHAR(50),                      
  @STATUSNAME VARCHAR(50),                      
  @FROMDATE VARCHAR(11),                      
  @TODATE  VARCHAR(11),                      
  @FROMPARTY VARCHAR(10),                      
  @TOPARTY VARCHAR(10),                      
  @FROMSCRIP VARCHAR(50)='',                      
  @TOSCRIP VARCHAR(50)='ZZZZZZZ',                      
  @OPT VARCHAR(20)=''                    
)              
AS    
  
SELECT @TOPARTY = (CASE WHEN @TOPARTY = '' AND @FROMPARTY <> '' THEN @FROMPARTY   
      WHEN @TOPARTY = '' AND @FROMPARTY = '' THEN 'ZZZZZZZZZZ'  
      ELSE @TOPARTY END)   
  
SELECT @TOSCRIP = (CASE WHEN @TOSCRIP = '' AND @FROMSCRIP <> '' THEN @TOSCRIP   
      WHEN @TOSCRIP = '' AND @FROMSCRIP = '' THEN 'ZZZZZZZZZZ'  
      ELSE @TOSCRIP END)   
  
SELECT TRADE_DATE = CONVERT(VARCHAR,SAUDA_DATE,103),
T.PARTY_CODE, LONG_NAME,  
SCRIP_CD, SERIES, BSECODE, ISIN,  
QTY, ADDED_BY, ADDED_ON = CONVERT(VARCHAR,ADDED_ON,103) + ' ' + CONVERT(VARCHAR,ADDED_ON,108) 
INTO #DATA FROM TBL_PRODUCT_POS_ADJUST T, MSAJAG.DBO.CLIENT_DETAILS C1  
WHERE SAUDA_DATE = @FROMDATE    
AND C1.CL_CODE = T.PARTY_CODE  
AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
AND @STATUSNAME =            
                  (CASE            
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD            
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER            
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER            
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY            
                        WHEN @STATUSID = 'AREA' THEN C1.AREA            
                        WHEN @STATUSID = 'REGION' THEN C1.REGION            
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE            
                  ELSE            
                        'BROKER'            
                  END)           
                  
SELECT * FROM #DATA                
ORDER BY PARTY_CODE, LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_Activation
-- --------------------------------------------------


CREATE Proc [dbo].[MTF_Activation]

as

SELECT * INTO #TEMP  FROM ( 

SELECT DISTINCT PARTY_CODE   FROM ABVSKYCMIS.KYC.DBO.VW_CLIENTMARGIN_CAMPAIGN M WITH(NOLOCK) WHERE IS_ACCEPTED ='Y' AND PARTY_CODE <>''

AND NOT EXISTS  (SELECT PARTY_CODE FROM TBLCLIENTMARGIN T WITH(NOLOCK) WHERE T.PARTY_CODE  =M.PARTY_CODE ) )A

WHERE PARTY_CODE NOT IN  (SELECT CL_CODE FROM MSAJAG.DBO.CLIENT_DETAILS C WITH(NOLOCK) WHERE    CL_TYPE IN ('NRI','NBF','NRO','NRE','CBI','ING'))

--SELECT * FROM ABVSKYCMIS.KYC.DBO.VW_CLIENTMARGIN_CAMPAIGN WHERE PARTY_CODE ='BIPINDEL123'

DELETE from #TEMP WHERE LEN(PARTY_CODE) > 10

 INSERT INTO TBLCLIENTMARGIN 
SELECT UPPER(PARTY_CODE),'0' A,'14.000' B,'-1','0','0',CONVERT(VARCHAR(11),GETDATE(),120),'2049-12-31 23:59:59.000','BACKEND',GETDATE(),
'N','','OTHER','2016-2017'
 FROM #TEMP 


INSERT INTO TBLCLIENTMARGIN_NEW
SELECT UPPER(PARTY_CODE),'0','14.000','-1','0','0',CONVERT(VARCHAR(11),GETDATE(),120),'2049-12-31 23:59:59.000','BACKEND',GETDATE(),
'N','','OTHER','2016-2017'
FROM #TEMP 

 
--SELECT DISTINCT PARTY_CODE INTO #DEACTIVE FROM ABVSKYCMIS.KYC.DBO.VW_CLIENTMARGIN_CAMPAIGN WHERE IS_ACCEPTED ='N' AND PARTY_CODE <>''
----INSERT INTO TBLCLIENTMARGIN_MAKER_CHECKER

--SELECT UPPER(T.PARTY_CODE),MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE=CONVERT(VARCHAR(11),GETDATE(),120),TO_DATE,ENTERED_BY,

--ENTERED_DATE=CONVERT(VARCHAR(11),GETDATE(),120),AUTO_RMS,REMARKS,DOC_TYPE='OTHER^',FY_DOC

--,'M','EDIT','Y' FROM TBLCLIENTMARGIN T,#DEACTIVE S

--WHERE S.PARTY_CODE=T.PARTY_CODE  AND TO_DATE >=GETDATE()

/****Reactive Status*/

SELECT * INTO #REACTIVE FROM ( 
SELECT DISTINCT PARTY_CODE   FROM ABVSKYCMIS.KYC.DBO.VW_CLIENTMARGIN_CAMPAIGN M WITH(NOLOCK) WHERE IS_ACCEPTED ='Y' AND PARTY_CODE <>''
AND CreationDate >GETDATE()-2
AND EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN T WITH(NOLOCK) WHERE T.PARTY_CODE  =M.PARTY_CODE AND TO_DATE <=GETDATE() ) )A
WHERE PARTY_CODE NOT IN  (SELECT CL_CODE FROM MSAJAG.DBO.CLIENT_DETAILS C WITH(NOLOCK) WHERE    CL_TYPE IN ('NRI','NBF','NRO','NRE','CBI','ING'))

INSERT INTO TBLCLIENTMARGIN_MAKER_CHECKER
SELECT UPPER(T.PARTY_CODE),MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE=CONVERT(VARCHAR(11),GETDATE(),120),'2049-12-31 23:59:59.000',
ENTERED_BY='AUTO',
ENTERED_DATE=CONVERT(VARCHAR(11),GETDATE(),120),AUTO_RMS,REMARKS,DOC_TYPE='OTHER^',FY_DOC
,'M','ADD','N' FROM TBLCLIENTMARGIN T WITH(NOLOCK),#REACTIVE S WITH(NOLOCK)
WHERE S.PARTY_CODE=T.PARTY_CODE  AND TO_DATE <=GETDATE()
AND S.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN_MAKER_CHECKER)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_ACTIVATION_DEACTIVATION
-- --------------------------------------------------
CREATE  PROC [dbo].[MTF_ACTIVATION_DEACTIVATION]
AS
SELECT * INTO #TEMP  FROM ( 
SELECT DISTINCT PARTY_CODE   FROM ABVSKYCMIS.KYC.DBO.VW_CLIENTMARGIN_CAMPAIGN M WHERE IS_ACCEPTED ='Y' AND PARTY_CODE <>''
AND NOT EXISTS  (SELECT PARTY_CODE FROM TBLCLIENTMARGIN T WHERE T.PARTY_CODE  =M.PARTY_CODE ) )A
WHERE PARTY_CODE NOT IN  (SELECT CL_CODE FROM MSAJAG.DBO.CLIENT_DETAILS C WHERE    CL_TYPE IN ('NRI','NBF','NRO','NRE','CBI','ING'))

 INSERT INTO TBLCLIENTMARGIN
SELECT UPPER(PARTY_CODE),'0','14.000','-1','0','0',CONVERT(VARCHAR(11),GETDATE(),120),'2049-12-31 23:59:59.000','BACKEND',GETDATE(),
'N','','OTHER','2016-2017'
 FROM #TEMP 

INSERT INTO TBLCLIENTMARGIN_NEW
SELECT UPPER(PARTY_CODE),'0','14.000','-1','0','0',CONVERT(VARCHAR(11),GETDATE(),120),'2049-12-31 23:59:59.000','BACKEND',GETDATE(),
'N','','OTHER','2016-2017'
FROM #TEMP 

SELECT DISTINCT PARTY_CODE INTO #DEACTIVE FROM ABVSKYCMIS.KYC.DBO.VW_CLIENTMARGIN_CAMPAIGN WHERE IS_ACCEPTED ='N' AND PARTY_CODE <>''

INSERT INTO TBLCLIENTMARGIN_MAKER_CHECKER
SELECT UPPER(T.PARTY_CODE),MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE=CONVERT(VARCHAR(11),GETDATE(),120),TO_DATE,ENTERED_BY,
ENTERED_DATE=CONVERT(VARCHAR(11),GETDATE(),120),AUTO_RMS,REMARKS,DOC_TYPE='OTHER^',FY_DOC
,'M','EDIT','Y' FROM TBLCLIENTMARGIN T,#DEACTIVE S
WHERE S.PARTY_CODE=T.PARTY_CODE  AND TO_DATE >=GETDATE()
AND S.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN_MAKER_CHECKER)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_CLIENT_ACTIVATION
-- --------------------------------------------------
 CREATE PROC [dbo].[MTF_CLIENT_ACTIVATION] (@party_code Varchar(10),@empcode Varchar(15))
 AS
 
 DECLARE @CLCNT INT

SELECT @CLCNT=COUNT(1) FROM TBLCLIENTMARGIN WHERE PARTY_CODE =@PARTY_CODE AND To_Date >GETDATE() 

IF @CLCNT >0 
BEGIN 
 SELECT REMARK ='CLIENT ALREADY ACTIVE IN MTF'
END

ELSE 
BEGIN 

IF (Select Count(1) from TBLCLIENTMARGIN  WHERE  PARTY_CODE =@PARTY_CODE ) = 1
	BEGIN 

	UPDATE  TBLCLIENTMARGIN SET From_Date =CONVERT(VARCHAR(11),GETDATE(),120),To_Date= '2049-12-31 23:59:59.000',Entered_By=@EMPCODE WHERE  PARTY_CODE =@PARTY_CODE 

	END
	ELSE
	BEGIN

	INSERT INTO TBLCLIENTMARGIN
	SELECT UPPER(@PARTY_CODE),'0' A,'14.000' B,'-1','0','0',CONVERT(VARCHAR(11),GETDATE(),120),'2049-12-31 23:59:59.000',@EMPCODE,GETDATE(),
	'N','','OTHER','2016-2017'

	END
 
INSERT INTO TBLCLIENTMARGIN_NEW
SELECT UPPER(@PARTY_CODE),'0','14.000','-1','0','0',CONVERT(VARCHAR(11),GETDATE(),120),'2049-12-31 23:59:59.000',@EMPCODE,GETDATE(),
'N','','OTHER','2016-2017'

SELECT REMARK ='CLIENT ACTIVATED IN MTF'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Mtf_deactivate
-- --------------------------------------------------
  
CREATE Proc Mtf_deactivate (@party_code varchar(10))  
as   
  
DECLARE @CNT INT  
  
SELECT @CNT = COUNT(1) FROM TBLCLIENTMARGIN WHERE Party_Code =@party_code AND TO_DATE <=GETDATE()  
  
IF @CNT >1   
 BEGIN   
  SELECT 'Party Code Already Deactivated'  
  RETURN  
 END    
  
 SET @CNT =0  
  
SELECT @CNT =COUNT(1) FROM TBLCLIENTMARGIN WHERE Party_Code =@party_code    
IF @CNT =0  
 BEGIN   
  SELECT 'Party Code Not exist for MTF Deacivation'  
  RETURN  
END    
  
   
INSERT INTO TBLCLIENTMARGIN_MAKER_CHECKER  
SELECT UPPER(T.PARTY_CODE),MARGIN_FUNDING,MARGIN_INTEREST,SANCTIONED_AMT,MAX_AMT,MIN_COVER,FROM_DATE=CONVERT(VARCHAR(11),GETDATE(),120),TO_DATE,  
ENTERED_BY='INHOUSE',  
ENTERED_DATE=CONVERT(VARCHAR(11),GETDATE(),120),AUTO_RMS,REMARKS,DOC_TYPE='OTHER^',FY_DOC  
,'M','EDIT','Y' FROM TBLCLIENTMARGIN T WHERE Party_Code =@party_code  
  
--SELECT 'Party Code Deactivated' as MSG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_Fund_Summary
-- --------------------------------------------------


  
CREATE Proc [dbo].[MTF_Fund_Summary] ( @fromdate datetime,@todate datetime, @access_to varchar(20),@access_Code varchar(20) )  
--  MTF_Fund_Summary '2020-01-01','2020-01-08','',''
as   
  
SELECT  sauda_date,SUM(CASE WHEN SELL_BUY=2 THEN NETAMT ELSE 0 END)/10000000 AS TODAY_SELL INTO #SELL  
 FROM TBL_PRODUCT_DATA where sauda_date >=@fromdate and sauda_date <=@todate +' 23:59'  
 GROUP BY sauda_date  
  
  SELECT T.SAUDA_DATE,SUM(BODVALUE)/10000000 AS PREV_POS ,SUM(FRESHBUY)/10000000 AS TODAYS_BUY,SUM(FRESHSELL)/10000000 AS TODAYS_SELL INTO #MTF   
  FROM TBL_NSE_REPORTING  T   
  WHERE T.SAUDA_DATE >=@fromdate and t.sauda_date <=@todate +' 23:59'  
  GROUP BY T.SAUDA_DATE  
  
  UPDATE #MTF SET PREV_POS =PREV_POS +(NETAMT/100)
  FROM BSE_MTF B WHERE #MTF.SAUDA_DATE = B.SAUDA_dATE 


     
  SELECT  row_number() over(order by M.SAUDA_DATE) AS R,M.SAUDA_DATE,PREV_POS,TODAYS_BUY,(TODAYS_SELL-ISNULL(TODAY_SELL,0)) AS TODAYS_SELL ,  
 TODAY_SELL AS OTHER_SELL ,  
 PREV_POS+TODAYS_BUY-TODAYS_SELL AS  TODAY_POS INTO #FINAL  
  FROM #MTF M  
 LEFT OUTER JOIN   
  #SELL S ON M.SAUDA_DATE=S.SAUDA_DATE   
  ORDER BY M.SAUDA_DATE  
   
 SELECT *,[Decrease Due to sell]= [Pos Decrement]-TODAYS_SELL,[Decrase due to others]= TODAYS_SELL,EXCHANGE='BOTH'  FROM (   
    SELECT G.SAUDA_DATE AS TRADE_DAY,TDAY_FUNDED=ROUND(G.TODAY_POS,2),H.SAUDA_DATE AS [T+1_DAY],  
 ROUND(H.TODAY_POS,2) AS [T+1 Day Funded],[Net Diffrence]= ROUND(G.TODAY_POS-H.TODAY_POS,2),  
 [Pos Increment]= ROUND(H.TODAYS_BUY,2), [Pos Decrement]= ROUND(G.TODAY_POS-H.TODAY_POS+H.TODAYS_BUY,2),  
ROUND( h.TODAYS_SELL ,2)  TODAYS_SELL
 FROM #FINAL G  
 LEFT OUTER JOIN   
 (SELECT SAUDA_DATe,R,TODAY_POS,TODAYS_BUY ,TODAYS_SELL FROM #FINAL  WHERE R>1) H  
 ON G.R =H.R-1 )A

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_Fund_Summary_08012020
-- --------------------------------------------------


  
CREATE Proc MTF_Fund_Summary_08012020 ( @fromdate datetime,@todate datetime)  
  
as   
  
SELECT  sauda_date,SUM(CASE WHEN SELL_BUY=2 THEN NETAMT ELSE 0 END)/10000000 AS TODAY_SELL INTO #SELL  
 FROM TBL_PRODUCT_DATA where sauda_date >=@fromdate and sauda_date <=@todate +' 23:59'  
 GROUP BY sauda_date  
  
  SELECT T.SAUDA_DATE,SUM(BODVALUE)/10000000 AS PREV_POS ,SUM(FRESHBUY)/10000000 AS TODAYS_BUY,SUM(FRESHSELL)/10000000 AS TODAYS_SELL INTO #MTF   
  FROM TBL_NSE_REPORTING  T   
  WHERE T.SAUDA_DATE >=@fromdate and t.sauda_date <=@todate +' 23:59'  
  GROUP BY T.SAUDA_DATE  
  
     
    SELECT  row_number() over(order by M.SAUDA_DATE) AS R,M.SAUDA_DATE,PREV_POS,TODAYS_BUY,(TODAYS_SELL-ISNULL(TODAY_SELL,0)) AS TODAYS_SELL ,  
 TODAY_SELL AS OTHER_SELL ,  
 PREV_POS+TODAYS_BUY-TODAYS_SELL AS  TODAY_POS INTO #FINAL  
  FROM #MTF M  
 LEFT OUTER JOIN   
  #SELL S ON M.SAUDA_DATE=S.SAUDA_DATE   
  ORDER BY M.SAUDA_DATE  
   
 SELECT *,[Decrease Due to sell]= [Pos Decrement]-TODAYS_SELL,[Decrase due to others]= TODAYS_SELL,EXCHANGE ='NSE' FROM (   
    SELECT G.SAUDA_DATE AS TRADE_DAY,TDAY_FUNDED=G.TODAY_POS,H.SAUDA_DATE AS [T+1_DAY],  
 H.TODAY_POS AS [T+1 Day Funded],[Net Diffrence]=G.TODAY_POS-H.TODAY_POS,  
 [Pos Increment]=H.TODAYS_BUY, [Pos Decrement]=G.TODAY_POS-H.TODAY_POS+H.TODAYS_BUY,  
 h.TODAYS_SELL   
 FROM #FINAL G  
 LEFT OUTER JOIN   
 (SELECT SAUDA_DATe,R,TODAY_POS,TODAYS_BUY ,TODAYS_SELL FROM #FINAL  WHERE R>1) H  
 ON G.R =H.R-1 )A

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_LEDGER
-- --------------------------------------------------
--EXEC MTF_LEDGER @TODATE


  
  
---EXEC MTF_LEDGER 'MAR 26 2021'  
CREATE PROCEDURE MTF_LEDGER  
(  
@TODATE VARCHAR(20)  
)  
AS BEGIN   
  
  
TRUNCATE TABLE SSSRS_MTF  
  
INSERT INTO SSSRS_MTF  
SELECT CLTCODE,SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)BALANCE,'MTF' AS EXCHANGE  
 FROM  LEDGER WITH(NOLOCK) WHERE    
  VDT >='2021-04-01 00:00:00' AND vdt<=@TODATE + ' 23:59'     
  GROUP BY CLTCODE  
  
SELECT * FROM SSSRS_MTF WHERE BALANCE <>0  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_POS_RECO_DET
-- --------------------------------------------------


-- EXEC MTF_POS_RECO_DET 'DEC 21 2020', 'NON RECO', 'J83805'          
CREATE PROC [dbo].[MTF_POS_RECO_DET]            
(            
 @TRANSDATE VARCHAR(11),        
 @OPT VARCHAR(10) = 'NON RECO',          
 @PARTY_CODE VARCHAR(10)='%',          
 @ISIN  VARCHAR(12)='%',  
 @flag int = 0            
)            
AS            
      
--SET XACT_ABORT ON      
      
DECLARE @INTERNALPARTY VARCHAR(10)      
      
SELECT @INTERNALPARTY = ''     
        
--SET @ISIN = 'INE421D01022'        
        
--DECLARE @TRANSDATE VARCHAR(11)          
          
--SET @TRANSDATE = 'OCT 14 2013'          
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
SET @PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN '%' ELSE @PARTY_CODE END)        
SET @ISIN = (CASE WHEN @ISIN = '' THEN '%' ELSE @ISIN END)        
        
IF LEN(@TRANSDATE) = 10         
BEGIN        
 SELECT @TRANSDATE = LEFT(CONVERT(DATETIME,@TRANSDATE,103),11)        
END        

--TRUNCATE TABLE TMP_HOLD        
          
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
ISIN,           
NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),      
BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),           
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
INTO #POS FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND ADJUST_DATE > @TRANSDATE   
AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0    

IF CONVERT(DATETIME,@TRANSDATE) + ' 16:30' > GETDATE() 
BEGIN
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN -QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN -QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0  
	
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST_buy (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0   	 
 	
END
 

IF CONVERT(DATETIME,@TRANSDATE) + ' 14:30' > GETDATE() AND  @TRANSDATE = LEFT( GETDATE(), 11)
BEGIN 
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
		SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
		SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),''), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
		ISIN=CERTNO,           
		NSEPOSQTY = 0,           
		BSEPOSQTY = 0,        
		FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
		FUTPAYOUTQTY = SUM(QTY) ,           
		NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
		BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
		POAQTY = CONVERT(NUMERIC(18,3),0),          
		PLDGQTY = CONVERT(NUMERIC(18,3),0),         
		CAQTY = 0,        
		AUCQTY = CONVERT(NUMERIC(18,3),0),        
		BROKERQTY = CONVERT(NUMERIC(18,3),0),        
		CLTDPID=CONVERT(VARCHAR(17),'')          
		FROM MSAJAGDEMAT.DBO.TBL_POA_PLD_ADNL     
		WHERE EXEDATE = @TRANSDATE  
		AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
		AND CERTNO = (CASE WHEN @ISIN = '%' THEN CERTNO ELSE @ISIN END)
		--AND PAYQTY <> QTY        
		GROUP BY PARTY_CODE, SCRIP_CD, SERIES, CERTNO          
		HAVING SUM(QTY) > 0  
END 

SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),SCRIP_CD), 
SERIES = CONVERT(VARCHAR(3),SERIES), BSECODE, ISIN,
QTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
FLAG = CONVERT(VARCHAR(12),'PAYOUT'), RECFLAG = 'MTF'
INTO #BTST
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
--AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  
AND Sett_No <> '2000000' 
AND SAUDA_DATE < 'JUL 15 2019'
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 

INSERT INTO #BTST
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN,
QTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
--AND SELL_BUY = 2 
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)   
AND Sett_No <> '2000000' 
AND SAUDA_DATE < 'JUL 15 2019'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) < 0 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, BSECODE='', I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYOUT', RECFLAG = 'MTF'
FROM NSE_DELIVERYCLT_MTF N, MSAJAG.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN > @TRANSDATE   
AND INOUT  ='O'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 
 
INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, BSECODE='', I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM NSE_DELIVERYCLT_MTF N, MSAJAG.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN > @TRANSDATE   
AND INOUT  ='I'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 
 
INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,  
FUTPAYINQTY = SUM(CASE WHEN FLAG = 'PAYIN' THEN (QTY) ELSE 0 END),          
FUTPAYOUTQTY = SUM(CASE WHEN FLAG = 'PAYOUT' THEN (QTY) ELSE 0 END),                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),            
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')  
FROM (
SELECT Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG, QTY = MIN(QTY) 
FROM #BTST 
GROUP BY Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG) A
GROUP BY Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG 

/*
INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,  
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
FUTPAYOUTQTY = SUM(QTY),                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),            
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  
AND Sett_No <> '2000000'         
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0   
     
INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     
ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,          
FUTPAYINQTY = SUM(QTY),          
FUTPAYOUTQTY = 0,                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),           
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
AND SELL_BUY = 2 AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)   
AND Sett_No <> '2000000'        
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0   
*/
  

SELECT DISTINCT SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SELL_BUY   
INTO #DATA  
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE > @TRANSDATE   
 
INSERT INTO #POS            
EXEC MSAJAGDEMAT.DBO.MTF_RECO @TRANSDATE, @OPT, @PARTY_CODE, @ISIN  

UPDATE #POS SET SCRIP_NAME = ''        
      
UPDATE #POS SET      
SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES           
FROM MSAJAGDEMAT.DBO.MULTIISIN M          
WHERE #POS.ISIN = M.ISIN     
AND VALID = 1         
  
UPDATE #POS SET      
BSECODE = M.SCRIP_CD        
FROM BSEDB.DBO.MULTIISIN M          
WHERE #POS.ISIN = M.ISIN     
AND VALID = 1         
          
UPDATE #POS SET PARTY_NAME = LONG_NAME FROM MSAJAG.DBO.CLIENT1 (NOLOCK)          
WHERE CL_CODE = PARTY_CODE          

UPDATE #POS SET CLTDPID = (CASE WHEN BANKID LIKE 'IN%' THEN C4.BANKID + ' ' + C4.CLTDPID ELSE 'C' + C4.CLTDPID END)
FROM MSAJAG.DBO.CLIENT4 C4
WHERE #POS.PARTY_CODE = C4.PARTY_CODE
AND C4.DEPOSITORY IN ('CDSL','NSDL')
AND DEFDP = 1 

ALTER TABLE #POS        
ADD D_FLAG VARCHAR(1)        
          
update #POS set D_FLAG = ''  
   
UPDATE #POS SET D_FLAG = 'Y', PARTY_NAME = '*' + PARTY_NAME         
FROM TBLCLIENTMARGIN D  (NOLOCK)      
WHERE #POS.PARTY_CODE = D.PARTY_CODE        
AND TO_DATE <= @TRANSDATE + ' 23:59:59'        
  
SELECT PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG,  
 NSEPOSQTY=SUM(NSEPOSQTY), BSEPOSQTY = SUM(BSEPOSQTY),  
 FUTPAYINQTY=(CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END),          
 FUTPAYOUTQTY=(CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END),          
 NSEPOOLQTY=SUM(NSEPOOLQTY), BSEPOOLQTY = SUM(BSEPOOLQTY),            
 DIFFQTY=SUM(NSEPOSQTY + BSEPOSQTY)+  
   (CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END)-  
   (CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END)-  
   SUM(NSEPOOLQTY) - SUM(BSEPOOLQTY)-SUM(POAQTY)-SUM(PLDGQTY)-SUM(CAQTY)  
INTO #POSFINAL  
FROM #POS           
GROUP BY PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG  
  
update #POSFINAL set SCRIP_NAME = s1.long_name from msajag.dbo.scrip1 s1, msajag.dbo.scrip2 s2  
where s1.co_code = s2.co_code   
and s1.series = s2.series   
and s2.scrip_cd = #POSFINAL.scrip_cd   
and s2.series = #POSFINAL.series   
and #POSFINAL.SCRIP_NAME = ''  
  
update #POSFINAL set SCRIP_NAME = s1.long_name from BSEDB_AB.dbo.scrip1 s1, BSEDB_AB.dbo.scrip2 s2  
where s1.co_code = s2.co_code   
and s1.series = s2.series   
and s2.bsecode = #POSFINAL.BSECODE    
and #POSFINAL.SCRIP_NAME = ''  

DELETE FROM #POSFINAL WHERE ISIN = 'INX528G01035'
  
IF @TRANSDATE = LEFT(GETDATE(),11)  
BEGIN  
 DELETE FROM TBL_MTF_RECO  
 WHERE SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE)  
 and PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
 AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)    
  
 INSERT INTO TBL_MTF_RECO  
 SELECT SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE), *   
 FROM #POSFINAL  
 WHERE PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
 AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)    
END  
  
if @flag = 0  
begin  
 IF @OPT = 'NON RECO'         
 BEGIN          
  SELECT * FROM #POSFINAL  
  WHERE DIFFQTY <> 0      
  ORDER BY D_FLAG, PARTY_CODE, ISIN        
 END        
         
 IF @OPT = 'RECO'         
 BEGIN          
    
  SELECT * FROM #POSFINAL  
  WHERE DIFFQTY = 0      
  ORDER BY D_FLAG, PARTY_CODE, ISIN          
 END        
         
 IF @OPT = 'ALL'         
 BEGIN          
    
  SELECT * FROM #POSFINAL    
  ORDER BY D_FLAG, PARTY_CODE, ISIN           
 END           
END  
DROP TABLE #POS         
DROP TABLE #POSFINAL         
              
        
--SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_POS_RECO_DET_bak_no282019
-- --------------------------------------------------

      
    
    
      
-- EXEC MTF_POS_RECO_DET 'AUG 21 2017', 'NON RECO'        
CREATE PROC [dbo].[MTF_POS_RECO_DET]          
(          
 @TRANSDATE VARCHAR(11),      
 @OPT VARCHAR(10) = 'NON RECO',        
 @PARTY_CODE VARCHAR(10)='%',        
 @ISIN  VARCHAR(12)='%',
 @flag	int = 0          
)          
AS          
    
--SET XACT_ABORT ON    
    
DECLARE @INTERNALPARTY VARCHAR(10)    
    
SELECT @INTERNALPARTY = ''   
      
--SET @ISIN = 'INE421D01022'      
      
--DECLARE @TRANSDATE VARCHAR(11)        
        
--SET @TRANSDATE = 'OCT 14 2013'        
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
SET @PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN '%' ELSE @PARTY_CODE END)      
SET @ISIN = (CASE WHEN @ISIN = '' THEN '%' ELSE @ISIN END)      
      
IF LEN(@TRANSDATE) = 10       
BEGIN      
 SELECT @TRANSDATE = LEFT(CONVERT(DATETIME,@TRANSDATE,103),11)      
END      
      
--TRUNCATE TABLE TMP_HOLD      
        
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),        
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),           
ISIN,         
NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),    
BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),         
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),        
FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),         
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0), 
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),  
POAQTY = CONVERT(NUMERIC(18,3),0),        
PLDGQTY = CONVERT(NUMERIC(18,3),0),       
CAQTY = 0,      
AUCQTY = CONVERT(NUMERIC(18,3),0),      
BROKERQTY = CONVERT(NUMERIC(18,3),0),      
CLTDPID=CONVERT(VARCHAR(17),'')        
INTO #POS FROM TBL_PRODUCT_POSITION (NOLOCK)        
WHERE SAUDA_DATE <= @TRANSDATE       
AND ADJUST_DATE > @TRANSDATE 
AND SELL_BUY = 1 
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)      
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)       
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN        
HAVING SUM(QTY) > 0 

IF CONVERT(DATETIME,@TRANSDATE) + ' 16:30' > GETDATE() 
BEGIN
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN -QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN -QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0  
	
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST_buy (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0   	 
END

INSERT INTO #POS 
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),        
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),           
ISIN,         
NSEPOSQTY = 0,          
BSEPOSQTY = 0,
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),        
FUTPAYOUTQTY = SUM(QTY),              
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0), 
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),          
POAQTY = CONVERT(NUMERIC(18,3),0),        
PLDGQTY = CONVERT(NUMERIC(18,3),0),       
CAQTY = 0,      
AUCQTY = CONVERT(NUMERIC(18,3),0),      
BROKERQTY = CONVERT(NUMERIC(18,3),0),      
CLTDPID=CONVERT(VARCHAR(17),'')        
FROM TBL_PRODUCT_POSITION (NOLOCK)        
WHERE SAUDA_DATE <= @TRANSDATE       
AND PAYIN_DATE >= @TRANSDATE 
AND SELL_BUY = 1 
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)      
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)
AND Sett_No <> '2000000'       
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN        
HAVING SUM(QTY) > 0 
 

INSERT INTO #POS 
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),        
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),           
ISIN,         
NSEPOSQTY = 0,          
BSEPOSQTY = 0,        
FUTPAYINQTY = SUM(QTY),        
FUTPAYOUTQTY = 0,              
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0), 
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),         
POAQTY = CONVERT(NUMERIC(18,3),0),        
PLDGQTY = CONVERT(NUMERIC(18,3),0),       
CAQTY = 0,      
AUCQTY = CONVERT(NUMERIC(18,3),0),      
BROKERQTY = CONVERT(NUMERIC(18,3),0),      
CLTDPID=CONVERT(VARCHAR(17),'')        
FROM TBL_PRODUCT_POSITION (NOLOCK)        
WHERE SAUDA_DATE <= @TRANSDATE       
AND PAYIN_DATE >= @TRANSDATE 
AND SELL_BUY = 2 
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)      
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END) 
AND Sett_No <> '2000000'      
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN        
HAVING SUM(QTY) > 0 

SELECT DISTINCT SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SELL_BUY 
INTO #DATA
FROM TBL_PRODUCT_POSITION (NOLOCK)        
WHERE SAUDA_DATE <= @TRANSDATE       
AND PAYIN_DATE > @TRANSDATE 
          

INSERT INTO #POS          
EXEC ANGELDEMAT.MSAJAG.DBO.MTF_RECO @TRANSDATE, @OPT, @PARTY_CODE, @ISIN


UPDATE #POS SET SCRIP_NAME = ''      
    
UPDATE #POS SET    
SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES         
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M        
WHERE #POS.ISIN = M.ISIN   
AND VALID = 1       

UPDATE #POS SET    
BSECODE = M.SCRIP_CD      
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M        
WHERE #POS.ISIN = M.ISIN   
AND VALID = 1       
        
UPDATE #POS SET PARTY_NAME = LONG_NAME FROM MSAJAG.DBO.CLIENT1 (NOLOCK)        
WHERE CL_CODE = PARTY_CODE        
 
ALTER TABLE #POS      
ADD D_FLAG VARCHAR(1)      
        
update #POS set D_FLAG = ''
 
UPDATE #POS SET D_FLAG = 'Y', PARTY_NAME = '*' + PARTY_NAME       
FROM TBLCLIENTMARGIN D  (NOLOCK)    
WHERE #POS.PARTY_CODE = D.PARTY_CODE      
AND TO_DATE <= @TRANSDATE + ' 23:59:59'      

SELECT PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG,
 NSEPOSQTY=SUM(NSEPOSQTY), BSEPOSQTY = SUM(BSEPOSQTY),
 FUTPAYINQTY=(CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END),        
 FUTPAYOUTQTY=(CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END),        
 NSEPOOLQTY=SUM(NSEPOOLQTY), BSEPOOLQTY = SUM(BSEPOOLQTY),          
 DIFFQTY=SUM(NSEPOSQTY + BSEPOSQTY)+
			(CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END)-
			(CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END)-
			SUM(NSEPOOLQTY) - SUM(BSEPOOLQTY)-SUM(POAQTY)-SUM(PLDGQTY)-SUM(CAQTY)
INTO #POSFINAL
FROM #POS         
GROUP BY PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG

update #POSFINAL set SCRIP_NAME = s1.long_name from msajag.dbo.scrip1 s1, msajag.dbo.scrip2 s2
where s1.co_code = s2.co_code 
and s1.series = s2.series 
and s2.scrip_cd = #POSFINAL.scrip_cd 
and s2.series = #POSFINAL.series 
and #POSFINAL.SCRIP_NAME = ''

update #POSFINAL set SCRIP_NAME = s1.long_name from anand.bsedb_ab.dbo.scrip1 s1, anand.bsedb_ab.dbo.scrip2 s2
where s1.co_code = s2.co_code 
and s1.series = s2.series 
and s2.bsecode = #POSFINAL.BSECODE  
and #POSFINAL.SCRIP_NAME = ''

IF @TRANSDATE = LEFT(GETDATE(),11) or @TRANSDATE = 'JUL 30 2019'
BEGIN
	DELETE FROM TBL_MTF_RECO
	WHERE SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE)
	and PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)      
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  

	INSERT INTO TBL_MTF_RECO
	SELECT SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE), * 
	FROM #POSFINAL
	WHERE PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)      
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  
END

if @flag = 0
begin
	IF @OPT = 'NON RECO'       
	BEGIN        
	 SELECT * FROM #POSFINAL
	 WHERE DIFFQTY <> 0    
	 ORDER BY D_FLAG, PARTY_CODE, ISIN      
	END      
	      
	IF @OPT = 'RECO'       
	BEGIN        
	 
	 SELECT * FROM #POSFINAL
	 WHERE DIFFQTY = 0    
	 ORDER BY D_FLAG, PARTY_CODE, ISIN        
	END      
	      
	IF @OPT = 'ALL'       
	BEGIN        
	 
	 SELECT * FROM #POSFINAL  
	 ORDER BY D_FLAG, PARTY_CODE, ISIN         
	END         
END
DROP TABLE #POS       
DROP TABLE #POSFINAL       
            
      
--SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_POS_RECO_DET_BAKDEC042019
-- --------------------------------------------------


-- EXEC MTF_POS_RECO_DET 'JUL 17 2019', 'NON RECO', '%'          
CREATE PROC [dbo].[MTF_POS_RECO_DET]            
(            
 @TRANSDATE VARCHAR(11),        
 @OPT VARCHAR(10) = 'NON RECO',          
 @PARTY_CODE VARCHAR(10)='%',          
 @ISIN  VARCHAR(12)='%',  
 @flag int = 0            
)            
AS            
      
--SET XACT_ABORT ON      
      
DECLARE @INTERNALPARTY VARCHAR(10)      
      
SELECT @INTERNALPARTY = ''     
        
--SET @ISIN = 'INE421D01022'        
        
--DECLARE @TRANSDATE VARCHAR(11)          
          
--SET @TRANSDATE = 'OCT 14 2013'          
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
SET @PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN '%' ELSE @PARTY_CODE END)        
SET @ISIN = (CASE WHEN @ISIN = '' THEN '%' ELSE @ISIN END)        
        
IF LEN(@TRANSDATE) = 10         
BEGIN        
 SELECT @TRANSDATE = LEFT(CONVERT(DATETIME,@TRANSDATE,103),11)        
END        

--TRUNCATE TABLE TMP_HOLD        
          
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
ISIN,           
NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),      
BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),           
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
INTO #POS FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND ADJUST_DATE > @TRANSDATE   
AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0   

IF CONVERT(DATETIME,@TRANSDATE) + ' 16:30' > GETDATE() 
BEGIN
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN -QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN -QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0  
	
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST_buy (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0   	 
END

SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),SCRIP_CD), 
SERIES = CONVERT(VARCHAR(3),SERIES), BSECODE, ISIN,
QTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
FLAG = CONVERT(VARCHAR(12),'PAYOUT'), RECFLAG = 'MTF'
INTO #BTST
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
--AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  
AND Sett_No <> '2000000' 
AND SAUDA_DATE < 'JUL 15 2019'
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 

INSERT INTO #BTST
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN,
QTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
--AND SELL_BUY = 2 
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)   
AND Sett_No <> '2000000' 
AND SAUDA_DATE < 'JUL 15 2019'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) < 0 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, BSECODE='', I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYOUT', RECFLAG = 'MTF'
FROM NSE_DELIVERYCLT_MTF N, MSAJAG.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN >= @TRANSDATE   
AND INOUT  ='O'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD='', N.SERIES, BSECODE=SCRIP_CD, I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYOUT', RECFLAG = 'MTF'
FROM BSE_DELIVERYCLT_MTF N, anand.BSEDB_ab.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN >= @TRANSDATE   
AND INOUT  ='O'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, BSECODE='', I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM NSE_DELIVERYCLT_MTF N, MSAJAG.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN >= @TRANSDATE   
AND INOUT  ='I'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD='', N.SERIES, BSECODE=SCRIP_CD, I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM BSE_DELIVERYCLT_MTF N, anand.BSEDB_ab.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN >= @TRANSDATE   
AND INOUT  ='I'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,  
FUTPAYINQTY = SUM(CASE WHEN FLAG = 'PAYIN' THEN (QTY) ELSE 0 END),          
FUTPAYOUTQTY = SUM(CASE WHEN FLAG = 'PAYOUT' THEN (QTY) ELSE 0 END),                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),            
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')  
FROM (
SELECT Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG, QTY = MIN(QTY) 
FROM #BTST 
GROUP BY Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG) A
GROUP BY Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG 

/*
INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,  
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
FUTPAYOUTQTY = SUM(QTY),                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),            
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  
AND Sett_No <> '2000000'         
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0   
     
INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     
ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,          
FUTPAYINQTY = SUM(QTY),          
FUTPAYOUTQTY = 0,                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),           
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
AND SELL_BUY = 2 AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)   
AND Sett_No <> '2000000'        
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0   
*/
  
SELECT DISTINCT SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SELL_BUY   
INTO #DATA  
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE > @TRANSDATE   
         
INSERT INTO #POS            
EXEC angeldemat.MSAJAG.DBO.MTF_RECO @TRANSDATE, @OPT, @PARTY_CODE, @ISIN  

UPDATE #POS SET SCRIP_NAME = ''        
      
UPDATE #POS SET      
SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES           
FROM MSAJAG.DBO.MULTIISIN M          
WHERE #POS.ISIN = M.ISIN     
AND VALID = 1         
  
UPDATE #POS SET      
BSECODE = M.SCRIP_CD        
FROM anand.BSEDB_ab.DBO.MULTIISIN M          
WHERE #POS.ISIN = M.ISIN     
AND VALID = 1         
          
UPDATE #POS SET PARTY_NAME = LONG_NAME FROM MSAJAG.DBO.CLIENT1 (NOLOCK)          
WHERE CL_CODE = PARTY_CODE          

UPDATE #POS SET CLTDPID = (CASE WHEN BANKID LIKE 'IN%' THEN C4.BANKID + ' ' + C4.CLTDPID ELSE 'C' + C4.CLTDPID END)
FROM MSAJAG.DBO.CLIENT4 C4
WHERE #POS.PARTY_CODE = C4.PARTY_CODE
AND C4.DEPOSITORY IN ('CDSL','NSDL')
AND DEFDP = 1 

ALTER TABLE #POS        
ADD D_FLAG VARCHAR(1)        
          
update #POS set D_FLAG = ''  
   
UPDATE #POS SET D_FLAG = 'Y', PARTY_NAME = '*' + PARTY_NAME         
FROM TBLCLIENTMARGIN D  (NOLOCK)      
WHERE #POS.PARTY_CODE = D.PARTY_CODE        
AND TO_DATE <= @TRANSDATE + ' 23:59:59'        
  
SELECT PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG,  
 NSEPOSQTY=SUM(NSEPOSQTY), BSEPOSQTY = SUM(BSEPOSQTY),  
 FUTPAYINQTY=(CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END),          
 FUTPAYOUTQTY=(CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END),          
 NSEPOOLQTY=SUM(NSEPOOLQTY), BSEPOOLQTY = SUM(BSEPOOLQTY),            
 DIFFQTY=SUM(NSEPOSQTY + BSEPOSQTY)+  
   (CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END)-  
   (CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END)-  
   SUM(NSEPOOLQTY) - SUM(BSEPOOLQTY)-SUM(POAQTY)-SUM(PLDGQTY)-SUM(CAQTY)  
INTO #POSFINAL  
FROM #POS           
GROUP BY PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG  
  
update #POSFINAL set SCRIP_NAME = s1.long_name from msajag.dbo.scrip1 s1, msajag.dbo.scrip2 s2  
where s1.co_code = s2.co_code   
and s1.series = s2.series   
and s2.scrip_cd = #POSFINAL.scrip_cd   
and s2.series = #POSFINAL.series   
and #POSFINAL.SCRIP_NAME = ''  
  
update #POSFINAL set SCRIP_NAME = s1.long_name from anand.BSEDB_ab.dbo.scrip1 s1, anand.BSEDB_ab.dbo.scrip2 s2  
where s1.co_code = s2.co_code   
and s1.series = s2.series   
and s2.bsecode = #POSFINAL.BSECODE    
and #POSFINAL.SCRIP_NAME = ''  
  
IF @TRANSDATE = LEFT(GETDATE(),11)  
BEGIN  
 DELETE FROM TBL_MTF_RECO  
 WHERE SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE)  
 and PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
 AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)    
  
 INSERT INTO TBL_MTF_RECO  
 SELECT SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE), *   
 FROM #POSFINAL  
 WHERE PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
 AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)    
END  
  
if @flag = 0  
begin  
 IF @OPT = 'NON RECO'         
 BEGIN          
  SELECT * FROM #POSFINAL  
  WHERE DIFFQTY <> 0      
  ORDER BY D_FLAG, PARTY_CODE, ISIN        
 END        
         
 IF @OPT = 'RECO'         
 BEGIN          
    
  SELECT * FROM #POSFINAL  
  WHERE DIFFQTY = 0      
  ORDER BY D_FLAG, PARTY_CODE, ISIN          
 END        
         
 IF @OPT = 'ALL'         
 BEGIN          
    
  SELECT * FROM #POSFINAL    
  ORDER BY D_FLAG, PARTY_CODE, ISIN           
 END           
END  
DROP TABLE #POS         
DROP TABLE #POSFINAL         
              
        
--SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_POS_RECO_DET_test
-- --------------------------------------------------


-- EXEC MTF_POS_RECO_DET_TEST 'OCT 27 2020', 'NON RECO', 'DELP5896'       

CREATE PROC [dbo].[MTF_POS_RECO_DET_TEST]            
(            
 @TRANSDATE VARCHAR(11),        
 @OPT VARCHAR(10) = 'NON RECO',          
 @PARTY_CODE VARCHAR(10)='%',          
 @ISIN  VARCHAR(12)='%',  
 @flag int = 0            
)            
AS            
      
--SET XACT_ABORT ON      
      
DECLARE @INTERNALPARTY VARCHAR(10)      
      
SELECT @INTERNALPARTY = ''     
        
--SET @ISIN = 'INE421D01022'        
        
--DECLARE @TRANSDATE VARCHAR(11)          
          
--SET @TRANSDATE = 'OCT 14 2013'          
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
SET @PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN '%' ELSE @PARTY_CODE END)        
SET @ISIN = (CASE WHEN @ISIN = '' THEN '%' ELSE @ISIN END)        
        
IF LEN(@TRANSDATE) = 10         
BEGIN        
 SELECT @TRANSDATE = LEFT(CONVERT(DATETIME,@TRANSDATE,103),11)        
END        

--TRUNCATE TABLE TMP_HOLD        
          
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
ISIN,           
NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),      
BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),           
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
INTO #POS FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND ADJUST_DATE > @TRANSDATE   
AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0    

IF CONVERT(DATETIME,@TRANSDATE) + ' 16:30' > GETDATE() 
BEGIN
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN -QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN -QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0  
	
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
	SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
	SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
	ISIN,           
	NSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRNSE' THEN QTY ELSE 0 END),      
	BSEPOSQTY = SUM(CASE WHEN TRANSTYPE = 'TRBSE' THEN QTY ELSE 0 END),           
	FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
	FUTPAYOUTQTY = CONVERT(NUMERIC(18,3),0),           
	NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
	BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
	POAQTY = CONVERT(NUMERIC(18,3),0),          
	PLDGQTY = CONVERT(NUMERIC(18,3),0),         
	CAQTY = 0,        
	AUCQTY = CONVERT(NUMERIC(18,3),0),        
	BROKERQTY = CONVERT(NUMERIC(18,3),0),        
	CLTDPID=CONVERT(VARCHAR(17),'')          
	FROM TBL_PRODUCT_POS_ADJUST_buy (NOLOCK)          
	WHERE SAUDA_DATE = @TRANSDATE  
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
	AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)         
	GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
	HAVING SUM(QTY) > 0   	 
 	
END

IF CONVERT(DATETIME,@TRANSDATE) + ' 13:30' < GETDATE() 
BEGIN
	INSERT INTO #POS 
	SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
		SCRIP_CD=CONVERT(VARCHAR(12),SCRIP_CD), 
		SERIES=CONVERT(VARCHAR(3),SERIES), BSECODE=CONVERT(VARCHAR(12),''), SCRIP_NAME=CONVERT(VARCHAR(100),''),             
		ISIN=CERTNO,           
		NSEPOSQTY = 0,           
		BSEPOSQTY = 0,        
		FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
		FUTPAYOUTQTY = -SUM(QTY) ,           
		NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
		BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),    
		POAQTY = CONVERT(NUMERIC(18,3),0),          
		PLDGQTY = CONVERT(NUMERIC(18,3),0),         
		CAQTY = 0,        
		AUCQTY = CONVERT(NUMERIC(18,3),0),        
		BROKERQTY = CONVERT(NUMERIC(18,3),0),        
		CLTDPID=CONVERT(VARCHAR(17),'')          
		FROM ANGELDEMAT.MSAJAG.DBO.TBL_POA_PLD_ADNL     
		WHERE EXEDATE = @TRANSDATE  
		AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
		AND CERTNO = (CASE WHEN @ISIN = '%' THEN CERTNO ELSE @ISIN END)
		AND PAYQTY <> QTY        
		GROUP BY PARTY_CODE, SCRIP_CD, SERIES, CERTNO          
		HAVING SUM(QTY) > 0  
END 

SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),SCRIP_CD), 
SERIES = CONVERT(VARCHAR(3),SERIES), BSECODE, ISIN,
QTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), 
FLAG = CONVERT(VARCHAR(12),'PAYOUT'), RECFLAG = 'MTF'
INTO #BTST
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
--AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  
AND Sett_No <> '2000000' 
AND SAUDA_DATE < 'JUL 15 2019'
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) > 0 

INSERT INTO #BTST
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN,
QTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END)), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
--AND SELL_BUY = 2 
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)   
AND Sett_No <> '2000000' 
AND SAUDA_DATE < 'JUL 15 2019'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE -QTY END) < 0 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, BSECODE='', I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYOUT', RECFLAG = 'MTF'
FROM NSE_DELIVERYCLT_MTF N, MSAJAG.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN > @TRANSDATE   
AND INOUT  ='O'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD='', N.SERIES, BSECODE=SCRIP_CD, I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYOUT', RECFLAG = 'MTF'
FROM BSE_DELIVERYCLT_MTF N, ANAND.BSEDB_AB.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN > @TRANSDATE   
AND INOUT  ='O'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, BSECODE='', I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM NSE_DELIVERYCLT_MTF N, MSAJAG.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN > @TRANSDATE   
AND INOUT  ='I'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #BTST
SELECT N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD='', N.SERIES, BSECODE=SCRIP_CD, I_ISIN,
QTY = SUM(QTY), FLAG = 'PAYIN', RECFLAG = 'MTF'
FROM BSE_DELIVERYCLT_MTF N, ANAND.BSEDB_AB.DBO.SETT_MST S (NOLOCK)          
WHERE START_DATE <= @TRANSDATE         
AND SEC_PAYIN > @TRANSDATE   
AND INOUT  ='I'
AND N.SETT_NO = S.SETT_NO
AND N.SETT_TYPE = S.SETT_TYPE
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND I_ISIN = (CASE WHEN @ISIN = '%' THEN I_ISIN ELSE @ISIN END)   
AND N.Sett_No <> '2000000' 
AND START_DATE >= 'JUL 15 2019'  
GROUP BY N.SETT_NO, N.SETT_TYPE, PARTY_CODE, SCRIP_CD, N.SERIES, I_ISIN 

INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,  
FUTPAYINQTY = SUM(CASE WHEN FLAG = 'PAYIN' THEN (QTY) ELSE 0 END),          
FUTPAYOUTQTY = SUM(CASE WHEN FLAG = 'PAYOUT' THEN (QTY) ELSE 0 END),                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),            
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')  
FROM (
SELECT Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG, QTY = MIN(QTY) 
FROM #BTST 
GROUP BY Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG) A
GROUP BY Sett_No, Sett_Type, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, FLAG 

/*
INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,  
FUTPAYINQTY = CONVERT(NUMERIC(18,3),0),          
FUTPAYOUTQTY = SUM(QTY),                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),            
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
AND SELL_BUY = 1   
AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)  
AND Sett_No <> '2000000'         
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0   
     
INSERT INTO #POS   
SELECT PARTY_CODE, PARTY_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD, SERIES, BSECODE=CONVERT(VARCHAR(12),BSECODE), SCRIP_NAME=CONVERT(VARCHAR(100),''),     
ISIN,           
NSEPOSQTY = 0,            
BSEPOSQTY = 0,          
FUTPAYINQTY = SUM(QTY),          
FUTPAYOUTQTY = 0,                
NSEPOOLQTY = CONVERT(NUMERIC(18,3),0),   
BSEPOOLQTY = CONVERT(NUMERIC(18,3),0),           
POAQTY = CONVERT(NUMERIC(18,3),0),          
PLDGQTY = CONVERT(NUMERIC(18,3),0),         
CAQTY = 0,        
AUCQTY = CONVERT(NUMERIC(18,3),0),        
BROKERQTY = CONVERT(NUMERIC(18,3),0),        
CLTDPID=CONVERT(VARCHAR(17),'')          
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE >= @TRANSDATE   
AND SELL_BUY = 2 AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)   
AND Sett_No <> '2000000'        
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN          
HAVING SUM(QTY) > 0   
*/
  

SELECT DISTINCT SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SELL_BUY   
INTO #DATA  
FROM TBL_PRODUCT_POSITION (NOLOCK)          
WHERE SAUDA_DATE <= @TRANSDATE         
AND PAYIN_DATE > @TRANSDATE   

INSERT INTO #POS            
EXEC ANGELDEMAT.MSAJAG.DBO.MTF_RECO_TEST @TRANSDATE, @OPT, @PARTY_CODE, @ISIN  

UPDATE #POS SET SCRIP_NAME = ''        
      
UPDATE #POS SET      
SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES           
FROM MSAJAG.DBO.MULTIISIN M          
WHERE #POS.ISIN = M.ISIN     
AND VALID = 1         
  
UPDATE #POS SET      
BSECODE = M.SCRIP_CD        
FROM ANAND.BSEDB_AB.DBO.MULTIISIN M          
WHERE #POS.ISIN = M.ISIN     
AND VALID = 1         
          
UPDATE #POS SET PARTY_NAME = LONG_NAME FROM MSAJAG.DBO.CLIENT1 (NOLOCK)          
WHERE CL_CODE = PARTY_CODE          

UPDATE #POS SET CLTDPID = (CASE WHEN BANKID LIKE 'IN%' THEN C4.BANKID + ' ' + C4.CLTDPID ELSE 'C' + C4.CLTDPID END)
FROM MSAJAG.DBO.CLIENT4 C4
WHERE #POS.PARTY_CODE = C4.PARTY_CODE
AND C4.DEPOSITORY IN ('CDSL','NSDL')
AND DEFDP = 1 

ALTER TABLE #POS        
ADD D_FLAG VARCHAR(1)        
          
update #POS set D_FLAG = ''  
   
UPDATE #POS SET D_FLAG = 'Y', PARTY_NAME = '*' + PARTY_NAME         
FROM TBLCLIENTMARGIN D  (NOLOCK)      
WHERE #POS.PARTY_CODE = D.PARTY_CODE        
AND TO_DATE <= @TRANSDATE + ' 23:59:59'        
  
SELECT PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG,  
 NSEPOSQTY=SUM(NSEPOSQTY), BSEPOSQTY = SUM(BSEPOSQTY),  
 FUTPAYINQTY=(CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END),          
 FUTPAYOUTQTY=(CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END),          
 NSEPOOLQTY=SUM(NSEPOOLQTY), BSEPOOLQTY = SUM(BSEPOOLQTY),            
 DIFFQTY=SUM(NSEPOSQTY + BSEPOSQTY)+  
   (CASE WHEN SUM(FUTPAYINQTY) > 0 THEN SUM(FUTPAYINQTY) ELSE 0 END)-  
   (CASE WHEN SUM(FUTPAYOUTQTY) > 0 THEN SUM(FUTPAYOUTQTY) ELSE 0 END)-  
   SUM(NSEPOOLQTY) - SUM(BSEPOOLQTY)-SUM(POAQTY)-SUM(PLDGQTY)-SUM(CAQTY)  
INTO #POSFINAL  
FROM #POS           
GROUP BY PARTY_CODE,PARTY_NAME,SCRIP_CD,SERIES,BSECODE,SCRIP_NAME,ISIN,CLTDPID,D_FLAG  
  
update #POSFINAL set SCRIP_NAME = s1.long_name from msajag.dbo.scrip1 s1, msajag.dbo.scrip2 s2  
where s1.co_code = s2.co_code   
and s1.series = s2.series   
and s2.scrip_cd = #POSFINAL.scrip_cd   
and s2.series = #POSFINAL.series   
and #POSFINAL.SCRIP_NAME = ''  
  
update #POSFINAL set SCRIP_NAME = s1.long_name from ANAND.BSEDB_AB.dbo.scrip1 s1, ANAND.BSEDB_AB.dbo.scrip2 s2  
where s1.co_code = s2.co_code   
and s1.series = s2.series   
and s2.bsecode = #POSFINAL.BSECODE    
and #POSFINAL.SCRIP_NAME = ''  

--DELETE FROM #POSFINAL WHERE ISIN = 'INX528G01035'
  
IF @TRANSDATE = LEFT(GETDATE(),11)  
BEGIN  
 DELETE FROM TBL_MTF_RECO  
 WHERE SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE)  
 and PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
 AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)    
  
 INSERT INTO TBL_MTF_RECO  
 SELECT SAUDA_DATE=CONVERT(DATETIME,@TRANSDATE), *   
 FROM #POSFINAL  
 WHERE PARTY_CODE = (CASE WHEN @PARTY_CODE = '%' THEN PARTY_CODE ELSE @PARTY_CODE END)        
 AND ISIN = (CASE WHEN @ISIN = '%' THEN ISIN ELSE @ISIN END)    
END  
  
if @flag = 0  
begin  
 IF @OPT = 'NON RECO'         
 BEGIN          
  SELECT * FROM #POSFINAL  
  WHERE DIFFQTY <> 0      
  ORDER BY D_FLAG, PARTY_CODE, ISIN        
 END        
         
 IF @OPT = 'RECO'         
 BEGIN          
    
  SELECT * FROM #POSFINAL  
  WHERE DIFFQTY = 0      
  ORDER BY D_FLAG, PARTY_CODE, ISIN          
 END        
         
 IF @OPT = 'ALL'         
 BEGIN          
    
  SELECT * FROM #POSFINAL    
  ORDER BY D_FLAG, PARTY_CODE, ISIN           
 END           
END  
DROP TABLE #POS         
DROP TABLE #POSFINAL         
              
--SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet
-- --------------------------------------------------
CREATE Procedure [dbo].[NCMS_POdet](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
 
if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin         
update INTRANET.CMS.dbo.ncms_batch_process set StartDate=GETDATE() where srno=13
End
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
       select distinct party_code into #PO_client from  INTRANET.cms.dbo.NCMS_PO_Request_ForPayout with(nolock) 

  create index #PO_cli on #PO_client(Party_code)
       
 Truncate table NCMS_PO            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)    ,#PO_client p           
 where VDT>=@sdtcur and VDT <= @ToDate   and CLTCODE=p.party_code          
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table NCMS_PO_NSEIPO          
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           
END            
ELSE            
BEGIN            
            
 delete from NCMS_PO where Cltcode=@pcode            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode           
 group by cltcode            
         
/* exec Fetch_CliUnreco @pcode            */
 /*         
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
   */   
   /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account.dbo.ledger with (nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
 
 /*   
        
 delete from NCMS_PO_NSEIPO where Cltcode=@pcode            
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
where substring(Cltcode,2,10)=@pcode          
*/             
END   

if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin
update INTRANET.CMS.dbo.ncms_batch_process set EndDate=GETDATE(),Flag=1 where srno=13
end
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_09May2022
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_09May2022](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
 
if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin         
update [196.1.115.132].CMS.dbo.ncms_batch_process set StartDate=GETDATE() where srno=13
End
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
            
 Truncate table NCMS_PO            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate             
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table NCMS_PO_NSEIPO          
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           
END            
ELSE            
BEGIN            
            
 delete from NCMS_PO where Cltcode=@pcode            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode           
 group by cltcode            
         
/* exec Fetch_CliUnreco @pcode            */
 /*         
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
   */   
   /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account.dbo.ledger with (nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
 
 /*   
        
 delete from NCMS_PO_NSEIPO where Cltcode=@pcode            
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
where substring(Cltcode,2,10)=@pcode          
*/             
END   

if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin
update [196.1.115.132].CMS.dbo.ncms_batch_process set EndDate=GETDATE(),Flag=1 where srno=13
end
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_bkup_23122019
-- --------------------------------------------------
create Procedure [dbo].[NCMS_POdet_bkup_23122019](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
         
            
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
            
 Truncate table NCMS_PO            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate             
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table NCMS_PO_NSEIPO          
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           
END            
ELSE            
BEGIN            
            
 delete from NCMS_PO where Cltcode=@pcode            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode           
 group by cltcode            
         
/* exec Fetch_CliUnreco @pcode            */
 /*         
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
   */   
   /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account.dbo.ledger with (nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
 
 /*   
        
 delete from NCMS_PO_NSEIPO where Cltcode=@pcode            
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
where substring(Cltcode,2,10)=@pcode          
*/             
END   

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_ForRealTime_PO
-- --------------------------------------------------

CREATE Procedure [dbo].[NCMS_POdet_ForRealTime_PO](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
 
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
          
     select distinct party_code into #PO_client from  INTRANET.cms.dbo.NCMS_RealPO_ForProcess  with(nolock)  where validationtxt='OK'

  create index #PO_cli on #PO_client(Party_code)
       
 Truncate table NCMS_PO            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)    ,#PO_client p           
 where VDT>=@sdtcur and VDT <= @ToDate   and CLTCODE=p.party_code          
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table NCMS_PO_NSEIPO          
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
 
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_morning
-- --------------------------------------------------
CREATE Procedure [dbo].[NCMS_POdet_morning](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
 
if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin         
update INTRANET.CMS.dbo.ncms_batch_process set StartDate=GETDATE() where srno=13
End
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
            
 Truncate table NCMS_PO            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate             
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table NCMS_PO_NSEIPO          
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           
END            
ELSE            
BEGIN            
            
 delete from NCMS_PO where Cltcode=@pcode            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode           
 group by cltcode            
         
/* exec Fetch_CliUnreco @pcode            */
 /*         
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
   */   
   /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account.dbo.ledger with (nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
 
 /*   
        
 delete from NCMS_PO_NSEIPO where Cltcode=@pcode            
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
where substring(Cltcode,2,10)=@pcode          
*/             
END   

if((CONVERT(VARCHAR(5),GETDATE(),108)>='06:59') and (CONVERT(VARCHAR(5),GETDATE(),108)<='23:59'))    
Begin
update INTRANET.CMS.dbo.ncms_batch_process set EndDate=GETDATE(),Flag=1 where srno=13
end
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_Unpledge
-- --------------------------------------------------

CREATE Procedure [dbo].[NCMS_POdet_Unpledge](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
         
            
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
            
 Truncate table Unpleadge_PO            
         
 insert into Unpleadge_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate             
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update Unpleadge_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where Unpleadge_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table NCMS_PO_NSEIPO          
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           
END            
ELSE            
BEGIN            
            
 delete from Unpleadge_PO where Cltcode=@pcode            
         
 insert into Unpleadge_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode           
 group by cltcode            
         
/* exec Fetch_CliUnreco @pcode            */
 /*         
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
   */   
   /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update Unpleadge_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account.dbo.ledger with (nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where Unpleadge_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    
 
 /*   
        
 delete from NCMS_PO_NSEIPO where Cltcode=@pcode            
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
where substring(Cltcode,2,10)=@pcode          
*/             
END   

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NCMS_POdet_WithOutTdayBilling
-- --------------------------------------------------

CREATE Procedure [dbo].[NCMS_POdet_WithOutTdayBilling](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
         
            
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
            
 Truncate table NCMS_PO            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate             
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where NCMS_PO.cltcode=b.cltcode 
 
 /* REMOVAL of Tday Bill Added by Siva */ 
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then VAMT else -VAMT end) into #tdaybill        
 from ledger  with (nolock) where vtyp in (15,35) and (narration like '%NSECMNBILL POSTED%' or narration like '%NSECMWBILL POSTED%')
 and VDT>=(CONVERT(varchar(11),getdate())) and VDT <=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 group by cltcode

 Create index #t on #tdaybill (cltcode)

 update NCMS_PO set VBal=VBal+t.B2Bamt
 from #tdaybill t where NCMS_PO.cltcode =T.CLTCODE 

 /*****Completed ******/
 
      
 /* B2B End */      
 
 /*       
 truncate table NCMS_PO_NSEIPO          
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           
END            
ELSE            
BEGIN            
            
 delete from NCMS_PO where Cltcode=@pcode            
         
 insert into NCMS_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and Cltcode=@pcode           
 group by cltcode            
         
/* exec Fetch_CliUnreco @pcode            */
 /*         
 update NCMS_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
         
 update NCMS_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from NCMS_PO where cltcode like '98%' and VBAL < 0) b            
 where NCMS_PO.cltcode=b.cltcode and NCMS_PO.Cltcode=@pcode            
   */   
   /* Bill to Bill Client */    
 if (select COUNT(1) from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B' and partycode=@pcode) > 0     
 BEGIN    
  update NCMS_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from     
  (    
   select     
   CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)    
   from account.dbo.ledger with (nolock) where cltcode=@pcode and    
   vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')    
   group by cltcode    
  ) b where NCMS_PO.cltcode=b.cltcode    
 END     
 /* B2B End */    

 /* REMOVAL of Tday Bill Added by Siva */ 
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then VAMT else -VAMT end) into #tdaybill1        
 from ledger  with (nolock) where vtyp in (15,35) and (narration like '%NSECMNBILL POSTED%' or narration like '%NSECMWBILL POSTED%')
 and VDT>=(CONVERT(varchar(11),getdate())) and VDT <=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 group by cltcode

 Create index #t on #tdaybill1 (cltcode)

 update NCMS_PO set VBal=VBal+t.B2Bamt
 from #tdaybill1 t where NCMS_PO.cltcode =T.CLTCODE 

 /*****Completed ******/
 
 /*   
        
 delete from NCMS_PO_NSEIPO where Cltcode=@pcode            
 insert into NCMS_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from NCMS_PO           
where substring(Cltcode,2,10)=@pcode          
*/             
END   

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_POST_LEDGER
-- --------------------------------------------------
CREATE PROC [dbo].[OFFLINE_POST_LEDGER]                  
(                  
           @UNAME     VARCHAR(25),                                      
           @USERCAT   INT,                                      
           @EXCHANGE  VARCHAR(3),                                      
           @SEGMENT   VARCHAR(10),                                      
           @RECOFLAG  CHAR(1) = 'N'                                     
)                  
                  
AS  
DECLARE @@LEDVDT VARCHAR(11)                  
DECLARE @@VTYP SMALLINT              
              
DECLARE LEDPOST CURSOR FOR                  
 --SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
 SELECT DISTINCT LEFT(VDATE,11) AS VDT, VOUCHERTYPE               
 FROM AngelBSECM.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES                  
 WHERE EXCHANGE = @EXCHANGE                  
 AND SEGMENT = @SEGMENT                  
 AND ROWSTATE = 0      AND APPROVALFLAG ='1'            
 AND VDATE NOT LIKE 'JAN  1 1900%'                  
                  
OPEN LEDPOST                  
                  
-- Perform the first fetch.                  
FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP                   
                  
-- Check @@FETCH_STATUS to see if there are any more rows to fetch.                  
WHILE @@FETCH_STATUS = 0                  
BEGIN                  
         
--IF @@VTYP = 3               
-- BEGIN              
--   EXEC V2_OFFLINE_PAYMENTUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG                  
-- END     
   
   
IF @@VTYP = 8               
 BEGIN              
   EXEC V2_OFFLINE_JVDRCRUPLOAD_RND @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG,@@VTYP                  
 END          
             
 --IF @@VTYP = 2               
 --BEGIN              
 --  EXEC V2_OFFLINE_RECPAYUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG                  
 --END            
  
 /*IF @@VTYP = 8               
 BEGIN              
   EXEC V2_OFFLINE_JVDRCRUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG,@@VTYP                  
 END             
*/                   
-- This is executed as long as the previous fetch succeeds.                  
   FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP                   
END                  
                  
CLOSE LEDPOST                  
DEALLOCATE LEDPOST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ONETIME_MANT_BAL
-- --------------------------------------------------


CREATE PROC ONETIME_MANT_BAL
(
@SAUDA_DATE VARCHAR(11)
)

AS

--ONETIME_MANT_BAL 'JUN 30 2025'

SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,NETQTY,NETAMOUNT,EXCHANGE,ISIN,BSECODE,MARGIN_REQ,PAYIN_AMT,MTM_AMT,
M_QTY,M_PRICE,M_AMT,NF_QTY,NF_AMT,COLL_QTY,HAIRCUT,PRO_PER
FROM TBL_MTR_OPEN_BALANCE (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE
ORDER BY PARTY_CODE,SCRIP_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.pro_d_Archive_TBL_PRODUCT_HOLD_DATA_Tables_Weekly
-- --------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE pro_d_Archive_TBL_PRODUCT_HOLD_DATA_Tables_Weekly
AS
--BEGIN
--	SET NOCOUNT ON;

--	-- to be scheduled on Saturday @02:30
--	DECLARE @ArchiveUpTo	DATETIME
--	SELECT @ArchiveUpTo = CONVERT(VARCHAR(10), GETDATE()-7, 121) + ' 23:59:59.999'

--	-- INSERT RECORDS
--	INSERT INTO MTFTRADE.dbo.TBL_PRODUCT_HOLD_DATA_HIST
--	SELECT * FROM MTFTRADE.dbo.TBL_PRODUCT_HOLD_DATA WITH (NOLOCK) WHERE SAUDA_DATE <= @ArchiveUpTo


	------ DELETE RECORDS IN LOOP 
	----WHILE EXISTS(SELECT SAUDA_DATE from MTFTRADE.dbo.TBL_PRODUCT_HOLD_DATA WITH (NOLOCK) WHERE SAUDA_DATE <= @ArchiveUpTo)
	----	BEGIN
	----		SET ROWCOUNT 200000
	----		DELETE from MTFTRADE.dbo.TBL_PRODUCT_HOLD_DATA WHERE SAUDA_DATE <= @ArchiveUpTo
	----		SET ROWCOUNT 0
	----		Waitfor DELAY '00:00:02.000' 
	------	END

	
--END

---TBL_PRODUCT_HOLD_DATA
--TBL_PRODUCT_HOLD_DATA_HIST

--MTFTRADE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_FNO_JV
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MARGIN_FNO_JV]            
(            
 @TRANSDATE VARCHAR(11),            
 @EXCHANGE VARCHAR(3),            
 @SEGMENT VARCHAR(7),            
 @BATCHNO INT            
)            
AS            
            
DECLARE                   
--  @PREVDATE_1 VARCHAR(11),                  
  @PREVDATE VARCHAR(11),                  
  @SDTCUR VARCHAR(11),                
  @LDTCUR VARCHAR(11),                
  @CUTOFFDATE DATETIME,            
  @RefNo Varchar(4),            
  @filebrokercode varchar(1)            
              
DECLARE @STARTDATE VARCHAR(11)              
          
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER                  
WHERE @TRANSDATE BETWEEN SDTCUR AND LDTCUR              
          
SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=FROM_EXCHANGE, FROM_SEGMENT = FROM_SEGMENT,            
TO_EXCHANGE, TO_SEGMENT,              
BANKNAME = CONVERT(VARCHAR(4),''),            
BANK_GL = CONVERT(VARCHAR(10),''),            
JV_GL = CONVERT(VARCHAR(10),''),            
NARR = CONVERT(VARCHAR(100),''),            
INTNO = CONVERT(VARCHAR(15),'')            
INTO #FINALLEDGER_CR              
FROM ANGELFO.NSEFO.DBO.Tbl_ALL_MarginProcess_Fund                  
WHERE TRANSDATE = @TRANSDATE             
AND POSTEDFLAG = 0            
AND AMOUNT > 0             
AND FROM_EXCHANGE = @EXCHANGE            
AND FROM_SEGMENT = @SEGMENT             
            
SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=TO_EXCHANGE, FROM_SEGMENT = TO_SEGMENT,             
TO_EXCHANGE=FROM_EXCHANGE, TO_SEGMENT=FROM_SEGMENT,             
BANKNAME = CONVERT(VARCHAR(4),''),            
BANK_GL = CONVERT(VARCHAR(10),''),            
JV_GL = CONVERT(VARCHAR(10),''),            
NARR = CONVERT(VARCHAR(100),''),            
INTNO = CONVERT(VARCHAR(15),'')            
INTO #FINALLEDGER_DR              
FROM ANGELFO.NSEFO.DBO.Tbl_ALL_MarginProcess_Fund                  
WHERE TRANSDATE = @TRANSDATE             
AND POSTEDFLAG = 0            
AND AMOUNT > 0             
AND TO_EXCHANGE = @EXCHANGE            
AND TO_SEGMENT = @SEGMENT             
            
UPDATE #FINALLEDGER_DR SET JV_GL = JV_GLCODE            
FROM ANGELFO.NSEFO.DBO.Tbl_OTHERGLCODE	 N            
WHERE #FINALLEDGER_DR.FROM_EXCHANGE = N.FROM_EXCHANGE            
AND #FINALLEDGER_DR.FROM_SEGMENT = N.FROM_SEGMENT            
AND #FINALLEDGER_DR.TO_EXCHANGE = N.TO_EXCHANGE            
AND #FINALLEDGER_DR.TO_SEGMENT = N.TO_SEGMENT            
            
UPDATE #FINALLEDGER_CR SET JV_GL = JV_GLCODE            
FROM ANGELFO.NSEFO.DBO.Tbl_OTHERGLCODE N            
WHERE #FINALLEDGER_CR.FROM_EXCHANGE = N.FROM_EXCHANGE            
AND #FINALLEDGER_CR.FROM_SEGMENT = N.FROM_SEGMENT            
AND #FINALLEDGER_CR.TO_EXCHANGE = N.TO_EXCHANGE            
AND #FINALLEDGER_CR.TO_SEGMENT = N.TO_SEGMENT            

            
SELECT *,            
BANK_GL = CONVERT(VARCHAR(10),''),            
JV_GL = CONVERT(VARCHAR(10),''),            
INTNO = CONVERT(VARCHAR(15),'')             
INTO #LEDGER_CR FROM LEDGER                  
WHERE VTYP = 2 AND 1 =2                  
                  
SELECT *,            
BANK_GL = CONVERT(VARCHAR(10),''),            
JV_GL = CONVERT(VARCHAR(10),''),            
INTNO = CONVERT(VARCHAR(15),'')             
INTO #LEDGER_DR FROM LEDGER                  
WHERE VTYP = 3 AND 1 =2                  
                  
ALTER TABLE #LEDGER_CR                  
ADD SNO INT IDENTITY(1,1)                  
                  
ALTER TABLE #LEDGER_DR                  
ADD SNO INT IDENTITY(1,1)                  
                  
DECLARE @VNO BIGINT                  
                  
ALTER TABLE #FINALLEDGER_CR                  
ADD SNO INT IDENTITY(1,1)                  
                  
ALTER TABLE #FINALLEDGER_DR                  
ADD SNO INT IDENTITY(1,1)                  
            
TRUNCATE TABLE #LEDGER_CR            
TRUNCATE TABLE #LEDGER_DR            
            
SET @VNO = 0                   
            
TRUNCATE TABLE #LEDGER_CR            
TRUNCATE TABLE #LEDGER_DR            
            
SET @VNO = 0                   
INSERT INTO #LEDGER_CR                  
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='C', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,                
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),                 
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGMENT JV FROM ' + TO_EXCHANGE+TO_SEGMENT,           
BANK_GL,            
JV_GL,            
INTNO=''                     
FROM #FINALLEDGER_DR              
WHERE BANK_GL = ''                
ORDER BY SNO                  
                
INSERT INTO #LEDGER_DR                  
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='D', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,                
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),                 
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGMENT JV TO ' + TO_EXCHANGE+TO_SEGMENT,            
BANK_GL,            
JV_GL,            
INTNO=''                   
FROM #FINALLEDGER_CR                  
WHERE BANK_GL = ''            
ORDER BY SNO                  
                
DECLARE @REC INT    
SELECT @REC = 0    
SELECT @REC = COUNT(1) FROM #LEDGER_CR    
    
CREATE TABLE #VNO    
(    
 LASTVNO BIGINT  
)    
    
IF @REC > 0     
BEGIN    
 INSERT INTO #VNO    
 EXEC ACC_GENVNO_NEW    
   @TRANSDATE,    
   '8',    
   '01',    
   @SDTCUR ,    
   @LDTCUR,    
   @REC    
   
   SELECT @VNO = LASTVNO - 1  
   FROM   #VNO    
  
 INSERT INTO LEDGER                  
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE='01',ENTEREDBY='ANIMESH',                  
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION                 
 FROM #LEDGER_CR                   
                 
 INSERT INTO LEDGER                  
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='D',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE=JV_GL,BOOKTYPE='01',ENTEREDBY='ANIMESH',                  
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION                 
 FROM #LEDGER_CR                   
                  
 TRUNCATE TABLE #LEDGER_CR                
END               
            
SET @VNO = 0              
    
SELECT @REC = 0    
SELECT @REC = COUNT(1) FROM #LEDGER_DR    
    
TRUNCATE TABLE #VNO    
    
IF @REC > 0     
BEGIN    
 INSERT INTO #VNO    
 EXEC ACC_GENVNO_NEW    
   @TRANSDATE,    
   '8',    
   '01',    
   @SDTCUR ,    
   @LDTCUR,    
   @REC    
       
   SELECT @VNO = LASTVNO - 1   
   FROM   #VNO    
                     
 INSERT INTO LEDGER                  
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,                
 BOOKTYPE='01',ENTEREDBY='ANIMESH',                  
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR                   
                   
 INSERT INTO LEDGER                  
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='C',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,                
 CLTCODE=JV_GL,BOOKTYPE='01',ENTEREDBY='ANIMESH',                  
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR                   
END      
                   
TRUNCATE TABLE #LEDGER_DR                
            
UPDATE LEDGER SET ACNAME = LONGNAME             
FROM ACMAST A                  
WHERE VDT = @TRANSDATE AND A.CLTCODE = LEDGER.CLTCODE                  
AND LEDGER.ACNAME <> LONGNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_APP_SCRIP
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MTF_APP_SCRIP]  
(  
 @TDATE  VARCHAR(10),   
 @FILEFOR VARCHAR(20),   
 @FILETYPE VARCHAR(50),   
 @PROGID  VARCHAR(50),   
 @UNAME  VARCHAR(50),  
 @FILENAME VARCHAR(500) = ''  
)  
AS  
  
DECLARE @RECCNT NUMERIC(18,0),  
  @FROMDATE DATETIME  
  
SELECT @FROMDATE = ISNULL(MIN(CONVERT(DATETIME,.DBO.PIECE(FILE_DATA,',',6),103)),GETDATE())  
FROM FILEDATA  
WHERE PROGID = @PROGID   
AND .DBO.PIECE(FILE_DATA,',',1) NOT LIKE 'COMPANY NAME%'  
AND ISNULL(FILE_DATA,'') <> ''  
  
  
IF @FROMDATE >= CONVERT(DATETIME,LEFT(GETDATE(),11))  
BEGIN  
 UPDATE TBLSCRIPMARGIN SET TO_DATE = LEFT(@FROMDATE - 1,11) + ' 23:59:00'  
 WHERE TO_DATE >= LEFT(GETDATE(),11)  
  
 INSERT INTO TBLSCRIPMARGIN   
 (BSECODE,FUND_PER,SCRIP_GROUP,ISIN,SCRIP_CD,FROM_DATE,TO_DATE,ENTERED_BY,ENTERED_DATE,SERIES)  
 SELECT .DBO.PIECE(FILE_DATA,',',2),   
 0, .DBO.PIECE(FILE_DATA,',',3),  
 LEFT(LTRIM(RTRIM(.DBO.PIECE(FILE_DATA,',',4))),12), .DBO.PIECE(FILE_DATA,',',5),   
 CONVERT(DATETIME,.DBO.PIECE(FILE_DATA,',',6),103),   
    LEFT(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA,',',7),'-','/'),103),11) + ' 23:59:00',  
 ENTERED_BY=@UNAME,ENTERED_DATE=GETDATE(),SERIES=''  
 FROM FILEDATA  
 WHERE PROGID = @PROGID   
 AND .DBO.PIECE(FILE_DATA,',',1) NOT LIKE 'COMPANY NAME%'  
  
 UPDATE TBLSCRIPMARGIN SET SERIES = M.SERIES, SCRIP_CD = M.SCRIP_CD FROM MSAJAG.DBO.MULTIISIN M
 WHERE TBLSCRIPMARGIN.ISIN = M.ISIN  
 AND VALID = 1 
 
 UPDATE TBLSCRIPMARGIN SET BSECODE = M.SCRIP_CD FROM AngelBSECM.BSEDB_AB.DBO.MULTIISIN M
 WHERE TBLSCRIPMARGIN.ISIN = M.ISIN  
 AND VALID = 1 
 
 SELECT @RECCNT = ISNULL(COUNT(1),0) FROM FILEDATA  
 WHERE PROGID = @PROGID   
 AND .DBO.PIECE(FILE_DATA,',',1) NOT LIKE 'COMPANY NAME%'  
  
 SELECT STRMSGCODE = 1, STRMSG = CONVERT(VARCHAR,@RECCNT) + ' RECORD(S) IMPORTED SUCCESSFULLY.'  
END  
ELSE  
BEGIN  
 SELECT STRMSGCODE = -1, STRMSG = 'INVALID FROM DATE.'   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_AUTO_CLOSE
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MTF_AUTO_CLOSE]
AS

SET NOCOUNT ON
DECLARE @SAUDA_DATE VARCHAR(11),
		@SDTCUR	VARCHAR(11),
		@LDTCUR	VARCHAR(11)
		
	SET @SAUDA_DATE = LEFT(GETDATE(),11)
	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), NETAMT=SUM(NETAMT), MTFLED=CONVERT(NUMERIC(18,4),0),
ADJQTY=0 INTO #MTF_DATA FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE <=@SAUDA_DATE
AND SELL_BUY= 1 
AND ADJUST_DATE > @SAUDA_DATE
AND QTY > 0 
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN

CREATE CLUSTERED INDEX IDX_PARTY ON #MTF_DATA
(
	PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
)

SELECT DISTINCT PARTY_CODE INTO #B_MTF_DATA FROM #MTF_DATA

UPDATE #MTF_DATA  SET MTFLED = VDTLEDBAL
FROM (SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE ) L
WHERE PARTY_CODE =CLTCODE

	SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0) 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)      
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)      
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 	
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE  
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 	
	
	INSERT INTO #B_LEDBAL 
	SELECT PARTY_CODE, VDTLEDBAL=0, MTFLED=SUM(NETAMT)+MTFLED FROM #MTF_DATA
	GROUP BY PARTY_CODE,MTFLED
	HAVING SUM(NETAMT)+MTFLED > 0 
	 
	DECLARE @MTFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@ISIN		VARCHAR(12),
			@POSCUR		CURSOR,
			@QTY		INT,
			@AMT		NUMERIC(18,4),
			@LEDBAL		NUMERIC(18,4),
			@ADJQTY		INT,
			@SCRIP_CD	VARCHAR(12), 
			@SERIES		VARCHAR(3), 
			@BSECODE	VARCHAR(12)

	SET @MTFCUR = CURSOR FOR
	SELECT CLTCODE, VDTLEDBAL=SUM(VDTLEDBAL)+SUM(MTFLED) FROM #B_LEDBAL	
	GROUP BY CLTCODE
	HAVING SUM(VDTLEDBAL)+SUM(MTFLED) > 0 
	ORDER BY CLTCODE 
	OPEN @MTFCUR
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @LEDBAL
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @LEDBAL > 0 
		BEGIN
			SET @POSCUR = CURSOR FOR 
			SELECT ISIN, QTY, NETAMT, SCRIP_CD, SERIES, BSECODE FROM #MTF_DATA
			WHERE PARTY_CODE = @PARTY_CODE 
			ORDER BY NETAMT DESC 
			OPEN @POSCUR 
			FETCH NEXT FROM @POSCUR INTO @ISIN, @QTY, @AMT, @SCRIP_CD, @SERIES, @BSECODE 
			WHILE @@FETCH_STATUS = 0 
			BEGIN
				IF @AMT <= @LEDBAL 
				BEGIN
					UPDATE #MTF_DATA SET ADJQTY = @QTY
					WHERE PARTY_CODE = @PARTY_CODE 
					AND SCRIP_CD = @SCRIP_CD
					AND SERIES =  @SERIES
					AND BSECODE = @BSECODE
					AND ISIN = @ISIN

					SET @LEDBAL = @LEDBAL - @AMT
				END
				ELSE
				BEGIN
					SET @ADJQTY = FLOOR(@LEDBAL/ (@AMT / @QTY))
					IF @ADJQTY <= @QTY 
					BEGIN
						UPDATE #MTF_DATA SET ADJQTY = @ADJQTY
						WHERE PARTY_CODE = @PARTY_CODE  
						AND SCRIP_CD = @SCRIP_CD
						AND SERIES =  @SERIES
						AND BSECODE = @BSECODE
						AND ISIN = @ISIN
					END
					ELSE
					BEGIN
						SET @ADJQTY = 0 
					END
					SET @LEDBAL = @LEDBAL - (@ADJQTY*(@AMT / @QTY))
				END
				FETCH NEXT FROM @POSCUR INTO @ISIN, @QTY, @AMT, @SCRIP_CD, @SERIES, @BSECODE 
			END 
		END
		FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @LEDBAL
	END
	CLOSE @MTFCUR
	DEALLOCATE @MTFCUR 

SELECT CLTCODE, VDTLEDBAL=SUM(VDTLEDBAL),MTFLED=SUM(MTFLED), ADJAMT=CONVERT(NUMERIC(18,4),0) 
INTO #FINAL FROM #B_LEDBAL	
GROUP BY CLTCODE
HAVING SUM(VDTLEDBAL)+SUM(MTFLED) > 0 
ORDER BY CLTCODE 

UPDATE #FINAL SET ADJAMT = M.ADJAMT
FROM (SELECT PARTY_CODE, ADJAMT=SUM(ADJQTY*(NETAMT/QTY)) FROM #MTF_DATA
	  GROUP BY PARTY_CODE )M
WHERE M.PARTY_CODE =#FINAL.CLTCODE

SELECT * FROM #FINAL WHERE ADJAMT > 0
ORDER BY CLTCODE

SELECT *FROM #MTF_DATA
WHERE PARTY_CODE IN (SELECT CLTCODE FROM #FINAL
WHERE ADJAMT > 0)
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_AUTO_CLOSE_1
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MTF_AUTO_CLOSE_1]
AS

SET NOCOUNT ON
DECLARE @SAUDA_DATE VARCHAR(11),
		@SDTCUR	VARCHAR(11),
		@LDTCUR	VARCHAR(11)
		
	SET @SAUDA_DATE = LEFT(GETDATE(),11)
	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), NETAMT=SUM(NETAMT), MTFLED=CONVERT(NUMERIC(18,4),0),
ADJQTY=0 INTO #MTF_DATA FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE <=@SAUDA_DATE
AND SELL_BUY= 1 
AND ADJUST_DATE > @SAUDA_DATE
AND QTY > 0 
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN

CREATE CLUSTERED INDEX IDX_PARTY ON #MTF_DATA
(
	PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
)

SELECT DISTINCT PARTY_CODE INTO #B_MTF_DATA FROM #MTF_DATA

UPDATE #MTF_DATA  SET MTFLED = VDTLEDBAL
FROM (SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE ) L
WHERE PARTY_CODE =CLTCODE

	SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0) 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)      
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)      
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 	
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE  
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 	
	
	INSERT INTO #B_LEDBAL 
	SELECT PARTY_CODE, VDTLEDBAL=0, MTFLED=SUM(NETAMT)+MTFLED FROM #MTF_DATA
	GROUP BY PARTY_CODE,MTFLED
	HAVING SUM(NETAMT)+MTFLED > 0 
	 
	DECLARE @MTFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@ISIN		VARCHAR(12),
			@POSCUR		CURSOR,
			@QTY		INT,
			@AMT		NUMERIC(18,4),
			@LEDBAL		NUMERIC(18,4),
			@ADJQTY		INT,
			@SCRIP_CD	VARCHAR(12), 
			@SERIES		VARCHAR(3), 
			@BSECODE	VARCHAR(12)

	SET @MTFCUR = CURSOR FOR
	SELECT CLTCODE, VDTLEDBAL=SUM(VDTLEDBAL)+SUM(MTFLED) FROM #B_LEDBAL	
	GROUP BY CLTCODE
	HAVING SUM(VDTLEDBAL)+SUM(MTFLED) > 0 
	ORDER BY CLTCODE 
	OPEN @MTFCUR
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @LEDBAL
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @LEDBAL > 0 
		BEGIN
			SET @POSCUR = CURSOR FOR 
			SELECT ISIN, QTY, NETAMT, SCRIP_CD, SERIES, BSECODE FROM #MTF_DATA
			WHERE PARTY_CODE = @PARTY_CODE 
			ORDER BY NETAMT DESC 
			OPEN @POSCUR 
			FETCH NEXT FROM @POSCUR INTO @ISIN, @QTY, @AMT, @SCRIP_CD, @SERIES, @BSECODE 
			WHILE @@FETCH_STATUS = 0 
			BEGIN
				IF @AMT <= @LEDBAL 
				BEGIN
					UPDATE #MTF_DATA SET ADJQTY = @QTY
					WHERE PARTY_CODE = @PARTY_CODE 
					AND SCRIP_CD = @SCRIP_CD
					AND SERIES =  @SERIES
					AND BSECODE = @BSECODE
					AND ISIN = @ISIN

					SET @LEDBAL = @LEDBAL - @AMT
				END
				ELSE
				BEGIN
					SET @ADJQTY = FLOOR(@LEDBAL/ (@AMT / @QTY))
					IF @ADJQTY <= @QTY 
					BEGIN
						UPDATE #MTF_DATA SET ADJQTY = @ADJQTY
						WHERE PARTY_CODE = @PARTY_CODE  
						AND SCRIP_CD = @SCRIP_CD
						AND SERIES =  @SERIES
						AND BSECODE = @BSECODE
						AND ISIN = @ISIN
					END
					ELSE
					BEGIN
						SET @ADJQTY = 0 
					END
					SET @LEDBAL = @LEDBAL - (@ADJQTY*(@AMT / @QTY))
				END
				FETCH NEXT FROM @POSCUR INTO @ISIN, @QTY, @AMT, @SCRIP_CD, @SERIES, @BSECODE 
			END 
		END
		FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @LEDBAL
	END
	CLOSE @MTFCUR
	DEALLOCATE @MTFCUR 

SELECT CLTCODE, VDTLEDBAL=SUM(VDTLEDBAL),MTFLED=SUM(MTFLED), ADJAMT=CONVERT(NUMERIC(18,4),0) 
INTO #FINAL FROM #B_LEDBAL	
GROUP BY CLTCODE
HAVING SUM(VDTLEDBAL)+SUM(MTFLED) > 0 
ORDER BY CLTCODE 

UPDATE #FINAL SET ADJAMT = M.ADJAMT
FROM (SELECT PARTY_CODE, ADJAMT=SUM(ADJQTY*(NETAMT/QTY)) FROM #MTF_DATA
	  GROUP BY PARTY_CODE )M
WHERE M.PARTY_CODE =#FINAL.CLTCODE

SELECT * FROM #FINAL WHERE ADJAMT > 0
ORDER BY CLTCODE

--SELECT *FROM #MTF_DATA
--WHERE PARTY_CODE IN (SELECT CLTCODE FROM #FINAL
--WHERE ADJAMT > 0)
--ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_AUTO_CLOSE_2
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MTF_AUTO_CLOSE_2]
AS

SET NOCOUNT ON
DECLARE @SAUDA_DATE VARCHAR(11),
		@SDTCUR	VARCHAR(11),
		@LDTCUR	VARCHAR(11)
		
	SET @SAUDA_DATE = LEFT(GETDATE(),11)
	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), NETAMT=SUM(NETAMT), MTFLED=CONVERT(NUMERIC(18,4),0),
ADJQTY=0 INTO #MTF_DATA FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE <=@SAUDA_DATE
AND SELL_BUY= 1 
AND ADJUST_DATE > @SAUDA_DATE
AND QTY > 0 
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN

CREATE CLUSTERED INDEX IDX_PARTY ON #MTF_DATA
(
	PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
)

SELECT DISTINCT PARTY_CODE INTO #B_MTF_DATA FROM #MTF_DATA

UPDATE #MTF_DATA  SET MTFLED = VDTLEDBAL
FROM (SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE ) L
WHERE PARTY_CODE =CLTCODE

	SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0) 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)      
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)      
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 	
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE  
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END),
			MTFLED=CONVERT(NUMERIC(18,4),0)  
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 	
	
	INSERT INTO #B_LEDBAL 
	SELECT PARTY_CODE, VDTLEDBAL=0, MTFLED=SUM(NETAMT)+MTFLED FROM #MTF_DATA
	GROUP BY PARTY_CODE,MTFLED
	HAVING SUM(NETAMT)+MTFLED > 0 
	 
	DECLARE @MTFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@ISIN		VARCHAR(12),
			@POSCUR		CURSOR,
			@QTY		INT,
			@AMT		NUMERIC(18,4),
			@LEDBAL		NUMERIC(18,4),
			@ADJQTY		INT,
			@SCRIP_CD	VARCHAR(12), 
			@SERIES		VARCHAR(3), 
			@BSECODE	VARCHAR(12)

	SET @MTFCUR = CURSOR FOR
	SELECT CLTCODE, VDTLEDBAL=SUM(VDTLEDBAL)+SUM(MTFLED) FROM #B_LEDBAL	
	GROUP BY CLTCODE
	HAVING SUM(VDTLEDBAL)+SUM(MTFLED) > 0 
	ORDER BY CLTCODE 
	OPEN @MTFCUR
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @LEDBAL
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @LEDBAL > 0 
		BEGIN
			SET @POSCUR = CURSOR FOR 
			SELECT ISIN, QTY, NETAMT, SCRIP_CD, SERIES, BSECODE FROM #MTF_DATA
			WHERE PARTY_CODE = @PARTY_CODE 
			ORDER BY NETAMT DESC 
			OPEN @POSCUR 
			FETCH NEXT FROM @POSCUR INTO @ISIN, @QTY, @AMT, @SCRIP_CD, @SERIES, @BSECODE 
			WHILE @@FETCH_STATUS = 0 
			BEGIN
				IF @AMT <= @LEDBAL 
				BEGIN
					UPDATE #MTF_DATA SET ADJQTY = @QTY
					WHERE PARTY_CODE = @PARTY_CODE 
					AND SCRIP_CD = @SCRIP_CD
					AND SERIES =  @SERIES
					AND BSECODE = @BSECODE
					AND ISIN = @ISIN

					SET @LEDBAL = @LEDBAL - @AMT
				END
				ELSE
				BEGIN
					SET @ADJQTY = FLOOR(@LEDBAL/ (@AMT / @QTY))
					IF @ADJQTY <= @QTY 
					BEGIN
						UPDATE #MTF_DATA SET ADJQTY = @ADJQTY
						WHERE PARTY_CODE = @PARTY_CODE  
						AND SCRIP_CD = @SCRIP_CD
						AND SERIES =  @SERIES
						AND BSECODE = @BSECODE
						AND ISIN = @ISIN
					END
					ELSE
					BEGIN
						SET @ADJQTY = 0 
					END
					SET @LEDBAL = @LEDBAL - (@ADJQTY*(@AMT / @QTY))
				END
				FETCH NEXT FROM @POSCUR INTO @ISIN, @QTY, @AMT, @SCRIP_CD, @SERIES, @BSECODE 
			END 
		END
		FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @LEDBAL
	END
	CLOSE @MTFCUR
	DEALLOCATE @MTFCUR 

SELECT CLTCODE, VDTLEDBAL=SUM(VDTLEDBAL),MTFLED=SUM(MTFLED), ADJAMT=CONVERT(NUMERIC(18,4),0) 
INTO #FINAL FROM #B_LEDBAL	
GROUP BY CLTCODE
HAVING SUM(VDTLEDBAL)+SUM(MTFLED) > 0 
ORDER BY CLTCODE 

UPDATE #FINAL SET ADJAMT = M.ADJAMT
FROM (SELECT PARTY_CODE, ADJAMT=SUM(ADJQTY*(NETAMT/QTY)) FROM #MTF_DATA
	  GROUP BY PARTY_CODE )M
WHERE M.PARTY_CODE =#FINAL.CLTCODE

--SELECT * FROM #FINAL WHERE ADJAMT > 0
--ORDER BY CLTCODE

SELECT *FROM #MTF_DATA
WHERE PARTY_CODE IN (SELECT CLTCODE FROM #FINAL
WHERE ADJAMT > 0)
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CA_ADJUST
-- --------------------------------------------------



CREATE PROC [dbo].[PROC_MTF_CA_ADJUST]
(
		@SAUDA_DATE VARCHAR(11),
		@OLDISIN	VARCHAR(12),
		@NEWISIN	VARCHAR(12),
		@RATIO		NUMERIC(18,4),
		@EFFDATE	VARCHAR(11)
) AS

-- EXEC PROC_MTF_CA_ADJUST @SAUDA_DATE= 'APR 19 2022', @OLDISIN = 'INE797F01012', @NEWISIN = 'INE797F01020', @RATIO = 5, @EFFDATE = 'APR 21 2022'
	
INSERT INTO TBL_PRODUCT_POS_ADJUST
SELECT SAUDA_DATE=@EFFDATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN,QTY=SUM(QTY),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE()
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE > @EFFDATE
AND ISIN = @OLDISIN
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE
HAVING FLOOR(SUM(QTY)*@RATIO) > 0 
AND SUM(QTY) <> FLOOR(SUM(QTY)*@RATIO)

---SAUDA_dATE PROCESS DATE APR  6 2018

INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY
SELECT SAUDA_DATE=@EFFDATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN=@NEWISIN,QTY=FLOOR(SUM(QTY)*@RATIO),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE(),
MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE > @EFFDATE
AND ISIN = @OLDISIN
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE
HAVING FLOOR(SUM(QTY)*@RATIO) > 0 
AND SUM(QTY) <> FLOOR(SUM(QTY)*@RATIO)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CA_ADJUST_BAKDEC172019
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_MTF_CA_ADJUST]
(
		@SAUDA_DATE VARCHAR(11),
		@OLDISIN	VARCHAR(12),
		@NEWISIN	VARCHAR(12),
		@RATIO		NUMERIC(18,4),
		@Process_date	VARCHAR(11) = ''
) AS

-- EXEC PROC_MTF_CA_ADJUST @SAUDA_DATE= 'SEP 10 2018', @OLDISIN = 'INE520A01019', @NEWISIN = 'INE520A01027', @RATIO = 1.5 

if @Process_date =''
	set @Process_date = left(getdate(),11)

INSERT INTO TBL_PRODUCT_POS_ADJUST
SELECT SAUDA_DATE=@Process_date,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN,QTY=SUM(QTY),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE()
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = 'DEC 31 2049 23:59'
AND ISIN = @OLDISIN
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

---SAUDA_dATE PROCESS DATE APR  6 2018

INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY
SELECT SAUDA_DATE=@Process_date,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN=@NEWISIN,QTY=FLOOR(SUM(QTY)*@RATIO),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE(),
MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = 'DEC 31 2049 23:59'
AND ISIN = @OLDISIN
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CA_ADJUST_test
-- --------------------------------------------------



CREATE PROC [dbo].[PROC_MTF_CA_ADJUST_test]
(
		@SAUDA_DATE VARCHAR(11),
		@OLDISIN	VARCHAR(12),
		@NEWISIN	VARCHAR(12),
		@RATIO		NUMERIC(18,4),
		@Process_date	VARCHAR(11) = ''
) AS

-- EXEC PROC_MTF_CA_ADJUST @SAUDA_DATE= 'SEP 10 2018', @OLDISIN = 'INE520A01019', @NEWISIN = 'INE520A01027', @RATIO = 1.5 

if @Process_date =''
	set @Process_date = left(getdate(),11)

--INSERT INTO TBL_PRODUCT_POS_ADJUST
SELECT SAUDA_DATE=@Process_date,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN,QTY=SUM(QTY),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE()
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = 'DEC 31 2049 23:59'
AND ISIN = @OLDISIN
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

---SAUDA_dATE PROCESS DATE APR  6 2018

--INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY
SELECT SAUDA_DATE=@Process_date,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN=@NEWISIN,QTY=FLOOR(SUM(QTY)*@RATIO),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE(),
MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = 'DEC 31 2049 23:59'
AND ISIN = @OLDISIN
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CA_ADJUST_TEST1
-- --------------------------------------------------




CREATE PROC [dbo].[PROC_MTF_CA_ADJUST_TEST1]  
(  
  @SAUDA_DATE VARCHAR(11),  
  @OLDISIN VARCHAR(12),  
  @NEWISIN VARCHAR(12),  
  @RATIO  NUMERIC(18,4) ,
  @PROCESS_DATE	VARCHAR(11) = ''
) AS  
  
-- EXEC PROC_MTF_CA_ADJUST @SAUDA_DATE= 'SEP 18 2019', @OLDISIN = 'INE040A01026', @NEWISIN = 'INE040A01034', @RATIO = 2   

IF @PROCESS_DATE = ''
BEGIN
	SET @PROCESS_DATE = LEFT(GETDATE(),11)
END

--INSERT INTO TBL_PRODUCT_POS_ADJUST  
SELECT SAUDA_DATE=@PROCESS_DATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),  
PARTY_CODE,SCRIP_CD,  
SERIES,BSECODE,ISIN,QTY=SUM(QTY),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE()  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE 
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE 
AND ISIN = @OLDISIN  
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE  
  
---SAUDA_dATE PROCESS DATE APR  6 2018  
  
--INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY  
SELECT SAUDA_DATE=@PROCESS_DATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),  
PARTY_CODE,SCRIP_CD,  
SERIES,BSECODE,ISIN=@NEWISIN,QTY=FLOOR(SUM(QTY)*@RATIO),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE(),  
MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE
AND ISIN = @OLDISIN  
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CA_NAMECHG
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MTF_CA_NAMECHG]
(
		@SAUDA_DATE VARCHAR(11),
		@OLDSYMBOL	VARCHAR(12),
		@NEWSYMBOL	VARCHAR(12),
		@OLDISIN	VARCHAR(12),
		@NEWISIN	VARCHAR(12),
		@RATIO		NUMERIC(18,4)
) AS

--  EXEC PROC_MTF_CA_NAMECHG @SAUDA_DATE= 'MAR 17 2020', @OLDSYMBOL = 'YESBANK', @NEWSYMBOL = 'YESBANK', @OLDISIN = 'INE528G01027', @NEWISIN = 'INE528G01035', @RATIO = 1  

INSERT INTO TBL_PRODUCT_POS_ADJUST
SELECT SAUDA_DATE=@SAUDA_DATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN,QTY=SUM(QTY),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE()
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE >= 'DEC 31 2049'
AND ISIN = @OLDISIN
AND SCRIP_CD = @OLDSYMBOL
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

---SAUDA_dATE PROCESS DATE APR  6 2018

INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY
SELECT SAUDA_DATE=@SAUDA_DATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD=@NEWSYMBOL,
SERIES,BSECODE,ISIN=@NEWISIN,QTY=FLOOR(SUM(QTY)*@RATIO),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE(),
MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE >= 'DEC 31 2049'
AND ISIN = @OLDISIN
AND SCRIP_CD = @OLDSYMBOL
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CA_NAMECHG_dummy
-- --------------------------------------------------




CREATE PROC [dbo].[PROC_MTF_CA_NAMECHG_dummy]
(
		@SAUDA_DATE VARCHAR(11),
		@OLDSYMBOL	VARCHAR(12),
		@NEWSYMBOL	VARCHAR(12),
		@OLDISIN	VARCHAR(12),
		@NEWISIN	VARCHAR(12),
		@RATIO		NUMERIC(18,4)
) AS

--  EXEC PROC_MTF_CA_NAMECHG @SAUDA_DATE= 'MAR 17 2020', @OLDSYMBOL = 'YESBANK', @NEWSYMBOL = 'YESBANK', @OLDISIN = 'INE528G01027', @NEWISIN = 'INE528G01035', @RATIO = 1  

--INSERT INTO TBL_PRODUCT_POS_ADJUST
SELECT SAUDA_DATE=@SAUDA_DATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN,QTY=SUM(QTY),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE()
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE >= 'DEC 31 2049'
AND ISIN = @OLDISIN
AND SCRIP_CD = @OLDSYMBOL
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

---SAUDA_dATE PROCESS DATE APR  6 2018

---INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY
SELECT SAUDA_DATE=@SAUDA_DATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD=@NEWSYMBOL,
SERIES,BSECODE,ISIN=@NEWISIN,QTY=FLOOR(SUM(QTY)*@RATIO),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE(),
MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE >= 'DEC 31 2049'
AND ISIN = @OLDISIN
AND SCRIP_CD = @OLDSYMBOL
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CASH_MAR_ADJ
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MTF_CASH_MAR_ADJ] 
(
	@MARGINDATE VARCHAR(11),
	@FROMPARTY	VARCHAR(10),
	@TOPARTY	VARCHAR(10),
	@FLAG		INT = 0 
)
AS 

-- EXEC PROC_MTF_CASH_MAR_ADJ 'SEP 19 2022','0','ZZZZZZ',0

DECLARE @PREVDATE	VARCHAR(11)

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),@MARGINDATE) FROM TBL_MTF_DATA WHERE SAUDA_DATE < @MARGINDATE

SELECT PARTY_CODE, ISIN,
SETTLEQTY = SUM(CASE WHEN PAYIN_DATE <= @MARGINDATE THEN QTY ELSE 0 END),
OPENQTY = SUM(CASE WHEN PAYIN_DATE > @MARGINDATE THEN QTY ELSE 0 END), 
SETTLEAMT=SUM(CASE WHEN PAYIN_DATE <= @MARGINDATE THEN MKTAMT ELSE 0 END),
OPENAMT=SUM(CASE WHEN PAYIN_DATE > @MARGINDATE THEN MKTAMT ELSE 0 END),
SETTL_MARGIN_REQ=CONVERT(NUMERIC(18,4),0),SETTL_MTOM_LOSS=CONVERT(NUMERIC(18,4),0),
OPEN_MARGIN_REQ=CONVERT(NUMERIC(18,4),0),OPEN_MTOM_LOSS=CONVERT(NUMERIC(18,4),0),
ACTUAL_MARGIN_REQ=CONVERT(NUMERIC(18,4),0),ACTUAL_MTOM_LOSS=CONVERT(NUMERIC(18,4),0)
INTO #DATA 
FROM TBL_PRODUCT_POSITION (NOLOCK) WHERE SAUDA_DATE<=@MARGINDATE
AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
AND ADJUST_DATE > @MARGINDATE AND SELL_BUY = 1
GROUP BY PARTY_CODE, ISIN

SELECT PARTY_CODE, NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL) 
INTO #MTF_REQ FROM  TBL_MTF_DATA
WHERE SAUDA_DATE =@MARGINDATE
AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
GROUP BY PARTY_CODE, MTFLEDBAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL

SELECT SAUDA_DATE,PARTY_CODE, ISIN, QTY = SUM(QTY), MARGIN_REQ=SUM(MARGIN_REQ),MTOM_LOSS=SUM(MTOM_LOSS),HAIRCUT,CURR_CL_RATE
INTO #MAR FROM TBL_MTF_DATA
WHERE SAUDA_DATE>=@PREVDATE
AND SAUDA_DATE<=@MARGINDATE
AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
GROUP BY SAUDA_DATE,PARTY_CODE, ISIN,HAIRCUT,CURR_CL_RATE

UPDATE #DATA SET SETTL_MARGIN_REQ = SETTLEAMT*HAIRCUT/100, 
				 SETTL_MTOM_LOSS = SETTLEAMT-CURR_CL_RATE*SETTLEQTY
FROM #MAR
WHERE #MAR.SAUDA_DATE=@PREVDATE
AND #DATA.PARTY_CODE = #MAR.PARTY_CODE
AND #DATA.ISIN = #MAR.ISIN

UPDATE #DATA SET OPEN_MARGIN_REQ = OPENAMT*HAIRCUT/100, 
				 OPEN_MTOM_LOSS = OPENAMT-CURR_CL_RATE*OPENQTY
FROM #MAR
WHERE #MAR.SAUDA_DATE=@MARGINDATE
AND #DATA.PARTY_CODE = #MAR.PARTY_CODE
AND #DATA.ISIN = #MAR.ISIN

UPDATE #DATA SET ACTUAL_MARGIN_REQ = SETTLEAMT*HAIRCUT/100, 
				 ACTUAL_MTOM_LOSS = SETTLEAMT-CURR_CL_RATE*SETTLEQTY
FROM #MAR
WHERE #MAR.SAUDA_DATE=@MARGINDATE
AND #DATA.PARTY_CODE = #MAR.PARTY_CODE
AND #DATA.ISIN = #MAR.ISIN

IF @FLAG = 0 
BEGIN
	SELECT * FROM #DATA 
END

SELECT PARTY_CODE, MTFREQ=SUM(OPEN_MARGIN_REQ)+(CASE WHEN SUM(OPEN_MTOM_LOSS) > 0 THEN SUM(OPEN_MTOM_LOSS) ELSE 0 END),
MARGININCREASE=(CASE WHEN SUM(SETTL_MARGIN_REQ)+(CASE WHEN SUM(SETTL_MTOM_LOSS) > 0 THEN SUM(SETTL_MTOM_LOSS) ELSE 0 END)
										  -  (SUM(ACTUAL_MARGIN_REQ)+(CASE WHEN SUM(ACTUAL_MTOM_LOSS) > 0 THEN SUM(ACTUAL_MTOM_LOSS) ELSE 0 END)) < 0 
										THEN ABS(SUM(SETTL_MARGIN_REQ)+(CASE WHEN SUM(SETTL_MTOM_LOSS) > 0 THEN SUM(SETTL_MTOM_LOSS) ELSE 0 END)
										  -  (SUM(ACTUAL_MARGIN_REQ)+(CASE WHEN SUM(ACTUAL_MTOM_LOSS) > 0 THEN SUM(ACTUAL_MTOM_LOSS) ELSE 0 END)))
										ELSE 0 END),
MTF_SHORT = CONVERT(NUMERIC(18,4),0),
COLLECTED = CONVERT(NUMERIC(18,4),0)
INTO #NETMAR
FROM #DATA
GROUP BY PARTY_CODE 

UPDATE  #NETMAR SET MTF_SHORT = NET_MTF_REQ, COLLECTED = MTFREQ+MARGININCREASE+(CASE WHEN NET_MTF_REQ < 0 THEN NET_MTF_REQ ELSE 0 END)
FROM #MTF_REQ 
WHERE #NETMAR.PARTY_CODE = #MTF_REQ.PARTY_CODE

UPDATE  #NETMAR SET COLLECTED = 0 WHERE COLLECTED < 0 

SELECT * FROM #NETMAR

DROP TABLE #MTF_REQ
DROP TABLE #DATA 
DROP TABLE #NETMAR
DROP TABLE #MAR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CHECK
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MTF_CHECK]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

-- EXEC PROC_MTF_CHECK 'FEB 27 2020'

DECLARE @SDTCUR		DATETIME,
		@LDTCUR		DATETIME

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR 

SELECT DISTINCT PARTY_CODE INTO #MTFREJECT FROM TBL_PRODUCT_POSITION 
WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1     
AND ADJUST_DATE > @SAUDA_DATE

CREATE INDEX #PARTY ON #MTFREJECT(PARTY_CODE)


SELECT L.CLTCODE,     
           VDTLEDBAL = SUM(CASE     
                             WHEN DRCR = 'C' THEN VAMT     
                             ELSE -VAMT     
                           END)     
    INTO   #P_LEDBAL     
    FROM   ACCOUNT.DBO.LEDGER L (NOLOCK),      
     (SELECT DISTINCT PARTY_CODE      
                             FROM   #MTFREJECT (NOLOCK) ) M     
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
           AND L.CLTCODE = PARTY_CODE    
     AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'     
        THEN '35' ELSE '' END)     
    GROUP  BY L.CLTCODE     
       
    INSERT INTO #P_LEDBAL     
    SELECT L.CLTCODE,     
           VDTLEDBAL = SUM(CASE     
                             WHEN DRCR = 'C' THEN VAMT     
                             ELSE -VAMT     
                           END)     
    FROM   ACCOUNT_AB.DBO.LEDGER L  ,      
     (SELECT DISTINCT PARTY_CODE      
                             FROM   #MTFREJECT ) M     
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
           AND L.CLTCODE = PARTY_CODE    
     AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'     
        THEN '35' ELSE '' END)    
    GROUP  BY L.CLTCODE       

CREATE TABLE #P_MTFREVLED
(
	PARTY_CODE	VARCHAR(10),
	AMOUNT		NUMERIC(18,2)
)

DECLARE @NARR VARCHAR(100)
SELECT @NARR = 'SETTNO='+SETT_NO+'NSECM'+LTRIM(RTRIM(SETT_TYPE))+'BILL POSTED' 
FROM MSAJAG.DBO.SETT_MST WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'

IF (SELECT ISNULL(COUNT(1),0) FROM ACCOUNT.DBO.LEDGER 
WHERE VDT = @SAUDA_DATE AND VTYP = 15 AND NARRATION = @NARR ) > 0
BEGIN 
	INSERT INTO #P_MTFREVLED
	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) FROM (    
	SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1     
	AND ADJUST_DATE = @SAUDA_DATE     
	GROUP BY PARTY_CODE 
	UNION ALL    
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1  
	AND ADJUST_DATE = @SAUDA_DATE 
	GROUP BY PARTY_CODE ) A    
	GROUP BY PARTY_CODE  
END
ELSE
BEGIN
	INSERT INTO #P_MTFREVLED
	SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1  
	AND ADJUST_DATE > @SAUDA_DATE 
	GROUP BY PARTY_CODE 
END

INSERT INTO #P_LEDBAL     
SELECT * FROM #P_MTFREVLED  

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ACCOUNTFO.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE     

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ACCOUNTCURFO.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE 

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ACCOUNTNCDX.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE 

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ACCOUNTMCDX.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE 

/* Margin Addition */

 --DECLARE @MAXDT_M DATETIME ,@PREVDT_M DATETIME

 --SELECT @MAXDT_M = MAX(UPDATEDDATE)  FROM [CSOKYC-6].GENERAL.DBO.NCMS_LD_API_UAT  WITH(NOLOCK)

 -- SELECT CLIENT_CODE ,MARGIN=SUM((MCX_SPAN+MCX_MVM)+(NCDX_SPAN+NCDX_MVM)+(NSEC_SPAN+NSEC_MVM)+(MCXC_SPAN+MCXC_MVM+NSEF_SPAN+NSEF_MVM) )  INTO #MARGIN
 -- FROM [CSOKYC-6].GENERAL.DBO.NCMS_LD_API_UAT WITH(NOLOCK) WHERE  UPDATEDDATE = @MAXDT_M
 --  GROUP BY CLIENT_CODE
 -- HAVING SUM( (MCX_SPAN+MCX_MVM)+(NCDX_SPAN+NCDX_MVM)+(NSEC_SPAN+NSEC_MVM)+(MCXC_SPAN+MCXC_MVM+NSEF_SPAN+NSEF_MVM) ) <>0
 

  -- SELECT @PREVDT_M=MAX(EFFDATE)
  --FROM MSAJAG.DBO.COLLATERALDETAILS (NOLOCK) WHERE EFFDATE >=GETDATE()-5

  --  SELECT PARTY_CODE,MARGIN=SUM(FINALAMOUNT) INTO #NONCASH
  --FROM MSAJAG.DBO.COLLATERALDETAILS (NOLOCK) WHERE EFFDATE >=@PREVDT_M GROUP BY PARTY_CODE


  --SELECT M.*,ISNULL(N.MARGIN,0) AS NC , NET=( -M.MARGIN+ISNULL(N.MARGIN,0)) INTO #FINAL_NET  FROM #MARGIN M
  --LEFT OUTER JOIN 
  --#NONCASH N ON CLIENT_CODE=PARTY_CODE
  
  --INSERT INTO #P_LEDBAL
  --SELECT CLIENT_CODE,NET FROM #FINAL_NET WHERE NET <-500

  /*Margin addition Completed */
  /* MTF Stock auto closure Consideration 
   Date : 2023-09-26
   Added :  K Siva Kumar*/
 
  --SELECT  PARTY_CODE,TOTALRELEASEVALUE=SUM(TOTALRELEASEVALUE) INTO #MTF_RELEASE FROM INTRANET.CMS.DBO.MTF_AUTORELEASE WITH(NOLOCK)
  --GROUP BY PARTY_CODE

  --INSERT INTO #P_LEDBAL
  --SELECT  PARTY_CODE,TOTALRELEASEVALUE=TOTALRELEASEVALUE*-1 FROM #MTF_RELEASE WITH(NOLOCK)
  ---GROUP BY PARTY_CODE  

  /*End*/
   

SELECT CLTCODE, VDTLEDBAL = SUM(VDTLEDBAL)
INTO #MTFREJECTCODE
FROM   #P_LEDBAL
GROUP BY CLTCODE
HAVING SUM(VDTLEDBAL) >= -500


  /* Credit Balance Client Addition Based on RMTF
   Modify : Direct Payout
   Date: 2024-11-08
   Changed By : Siva Kumar
   Approved by : Rahul Shah*/
 
 --SELECT DISTINCT PARTY_CODE INTO #RMTF FROM  ANGELDEMAT.INHOUSE.DBO.TBL_POA_PLD_ADNL_RMTF WITH(NOLOCK) 
 --WHERE TRANSDATE>=@SAUDA_DATE  AND TRANSDATE<=  @SAUDA_DATE +' 23:59:59'

 --CREATE INDEX #PARTY ON #RMTF(PARTY_CODE)

 --DELETE FROM #MTFREJECTCODE  WHERE EXISTS (SELECT PARTY_CODE FROM #RMTF WHERE PARTY_CODE=CLTCODE)


  /* Credit Balance Client Addition Based on RMTF*/


DELETE FROM TBL_MTFREJECTCODE
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT  INTO TBL_MTFREJECTCODE
SELECT SAUDA_DATE = @SAUDA_DATE, *, RUNDATE=GETDATE()
FROM #MTFREJECTCODE

/*
DECLARE @SAUDA_DATE VARCHAR(11),
		@SDTCUR		DATETIME,
		@LDTCUR		DATETIME

SET @SAUDA_DATE = 'FEB 18 2020'
SET @SDTCUR		= 'APR  1 2019'
SET @LDTCUR		= 'MAR 31 2020 23:59:59'
*/
DELETE FROM TBL_PRODUCT_POSITION    
WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1     
AND ADJUST_DATE > @SAUDA_DATE 
AND PARTY_CODE IN (SELECT CLTCODE FROM TBL_MTFREJECTCODE
				   WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = CLTCODE) 
AND SETT_NO <> '2000000'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CHECK_BAK_20230713
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MTF_CHECK_BAK_20230713]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

-- EXEC PROC_MTF_CHECK 'FEB 27 2020'

DECLARE @SDTCUR		DATETIME,
		@LDTCUR		DATETIME

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR 

SELECT DISTINCT PARTY_CODE INTO #MTFREJECT FROM TBL_PRODUCT_POSITION 
WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1     
AND ADJUST_DATE > @SAUDA_DATE

SELECT L.CLTCODE,     
           VDTLEDBAL = SUM(CASE     
                             WHEN DRCR = 'C' THEN VAMT     
                             ELSE -VAMT     
                           END)     
    INTO   #P_LEDBAL     
    FROM   ACCOUNT.DBO.LEDGER L,      
     (SELECT DISTINCT PARTY_CODE      
                             FROM   #MTFREJECT ) M     
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
           AND L.CLTCODE = PARTY_CODE    
     AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'     
        THEN '35' ELSE '' END)     
    GROUP  BY L.CLTCODE     
       
    INSERT INTO #P_LEDBAL     
    SELECT L.CLTCODE,     
           VDTLEDBAL = SUM(CASE     
                             WHEN DRCR = 'C' THEN VAMT     
                             ELSE -VAMT     
                           END)     
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,      
     (SELECT DISTINCT PARTY_CODE      
                             FROM   #MTFREJECT ) M     
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
           AND L.CLTCODE = PARTY_CODE    
     AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'     
        THEN '35' ELSE '' END)    
    GROUP  BY L.CLTCODE       

CREATE TABLE #P_MTFREVLED
(
	PARTY_CODE	VARCHAR(10),
	AMOUNT		NUMERIC(18,2)
)

DECLARE @NARR VARCHAR(100)
SELECT @NARR = 'SETTNO='+SETT_NO+'NSECM'+LTRIM(RTRIM(SETT_TYPE))+'BILL POSTED' 
FROM MSAJAG.DBO.SETT_MST WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'

IF (SELECT ISNULL(COUNT(1),0) FROM ACCOUNT.DBO.LEDGER 
WHERE VDT = @SAUDA_DATE AND VTYP = 15 AND NARRATION = @NARR ) > 0
BEGIN 
	INSERT INTO #P_MTFREVLED
	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) FROM (    
	SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1     
	AND ADJUST_DATE = @SAUDA_DATE     
	GROUP BY PARTY_CODE 
	UNION ALL    
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1  
	AND ADJUST_DATE = @SAUDA_DATE 
	GROUP BY PARTY_CODE ) A    
	GROUP BY PARTY_CODE  
END
ELSE
BEGIN
	INSERT INTO #P_MTFREVLED
	SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1  
	AND ADJUST_DATE > @SAUDA_DATE 
	GROUP BY PARTY_CODE 
END

INSERT INTO #P_LEDBAL     
SELECT * FROM #P_MTFREVLED  

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE     

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE 

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE 

INSERT INTO #P_LEDBAL     
SELECT L.CLTCODE,     
        VDTLEDBAL = SUM(CASE     
                            WHEN DRCR = 'C' THEN VAMT     
                            ELSE -VAMT     
                        END)     
FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,     
    (SELECT DISTINCT PARTY_CODE      
                            FROM   #MTFREJECT ) M     
WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
        AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
        AND L.CLTCODE = PARTY_CODE     
GROUP  BY L.CLTCODE 

SELECT CLTCODE, VDTLEDBAL = SUM(VDTLEDBAL)
INTO #MTFREJECTCODE
FROM   #P_LEDBAL
GROUP BY CLTCODE
HAVING SUM(VDTLEDBAL) >= -500

DELETE FROM TBL_MTFREJECTCODE
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT  INTO TBL_MTFREJECTCODE
SELECT SAUDA_DATE = @SAUDA_DATE, *, RUNDATE=GETDATE()
FROM #MTFREJECTCODE

/*
DECLARE @SAUDA_DATE VARCHAR(11),
		@SDTCUR		DATETIME,
		@LDTCUR		DATETIME

SET @SAUDA_DATE = 'FEB 18 2020'
SET @SDTCUR		= 'APR  1 2019'
SET @LDTCUR		= 'MAR 31 2020 23:59:59'
*/
DELETE FROM TBL_PRODUCT_POSITION    
WHERE  SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 1     
AND ADJUST_DATE > @SAUDA_DATE 
AND PARTY_CODE IN (SELECT CLTCODE FROM TBL_MTFREJECTCODE
				   WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = CLTCODE) 
AND SETT_NO <> '2000000'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_COLL_BREAKUP
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[PROC_MTF_COLL_BREAKUP]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS   
-- EXEC PROC_MTF_COLL_BREAKUP @SAUDA_DATE = 'APR 15 2019'  
DECLARE @PARTY_CODE VARCHAR(10),  
 @ISIN VARCHAR(12),  
 @SRNO INT,  
 @MARGIN_REQ NUMERIC(18,4),  
 @COLLCUR CURSOR,  
 @DELCUR CURSOR,  
 @NEWQTY INT,  
 @QTY INT,  
 @CL_RATE NUMERIC(18,4),  
 @HAIRCUT NUMERIC(18,4)  
   
SELECT P.PARTY_CODE, ISIN, SCRIP_CD, SERIES, BSECODE, QTY = SUM(QTY), MKTAMT=SUM(NETAMT),NETAMT=SUM(NETAMT),   
HAIRCUT = CONVERT(NUMERIC(18,4),0),  
CL_RATE = CONVERT(NUMERIC(18,4),0), MARGIN_REQ = CONVERT(NUMERIC(18,4),0),  
MTOM_LOSS =  CONVERT(NUMERIC(18,4),0)    
INTO #BSEREQ  
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), BSEDB.DBO.OWNER             
WHERE SAUDA_DATE <= @SAUDA_DATE             
AND ADJUST_DATE > @SAUDA_DATE            
AND SELL_BUY = 1             
AND C.CL_CODE = P.PARTY_CODE            
AND TRANSTYPE = 'TRBSE'         
GROUP BY P.PARTY_CODE, ISIN, SCRIP_CD, SERIES, BSECODE         
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0       
  
UPDATE #BSEREQ SET HAIRCUT = D.HAIRCUT, CL_RATE = D.CURR_CL_RATE,   
MARGIN_REQ = (CASE WHEN (CURR_CL_RATE*#BSEREQ.QTY) > #BSEREQ.MKTAMT THEN #BSEREQ.MKTAMT * d.HAIRCUT / 100   
ELSE (CURR_CL_RATE*#BSEREQ.QTY) * d.HAIRCUT / 100 END)   
FROM TBL_MTF_DATA D   
WHERE SAUDA_DATE = @SAUDA_DATE   
AND #BSEREQ.PARTY_CODE = D.PARTY_CODE   
AND #BSEREQ.ISIN = D.ISIN   
  
UPDATE #BSEREQ                     
    SET    MARGIN_REQ = MKTAMT * HAIRCUT / 100  
 WHERE CL_RATE = 0   
   
    UPDATE #BSEREQ                     
    SET    MTOM_LOSS = (( MKTAMT / QTY - CL_RATE ) * QTY)       
    --WHERE  HAIRCUT <> 100     
           
 UPDATE #BSEREQ SET  MTOM_LOSS = (CASE WHEN A.MTOM_LOSS > 0 THEN #BSEREQ.MTOM_LOSS ELSE 0 END)      
 FROM (      
   SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)      
   FROM #BSEREQ      
   GROUP BY PARTY_CODE      
   ) A      
 WHERE #BSEREQ.PARTY_CODE = A.PARTY_CODE                        
  
UPDATE TBL_PRODUCT_HOLD_DATA SET SETT_NO = ''  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND SETT_NO = 'BSE' AND HOLDFLAG= 'MTFCOLL'  
  
SET @COLLCUR = CURSOR FOR   
SELECT PARTY_CODE, MARGIN_REQ=SUM(MARGIN_REQ+MTOM_LOSS) FROM #BSEREQ  
GROUP BY PARTY_CODE  
OPEN @COLLCUR   
FETCH NEXT FROM @COLLCUR INTO @PARTY_CODE, @MARGIN_REQ  
WHILE @@FETCH_STATUS = 0   
BEGIN   
 IF @MARGIN_REQ > 0   
 BEGIN  
  SET @DELCUR = CURSOR FOR   
  SELECT SRNO, ISIN, QTY, CL_RATE, HAIRCUT FROM TBL_PRODUCT_HOLD_DATA  
  WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE  
  AND SETT_NO = '' AND HOLDFLAG= 'MTFCOLL'  
  ORDER BY QTY DESC, CL_RATE   
  OPEN @DELCUR   
  FETCH NEXT FROM @DELCUR INTO @SRNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @MARGIN_REQ >= @QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100  
   BEGIN   
    UPDATE TBL_PRODUCT_HOLD_DATA SET SETT_NO = 'BSE'  
    WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE  
    AND ISIN = @ISIN AND SRNO = @SRNO   
  
    SET @MARGIN_REQ = @MARGIN_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)  
   END  
   ELSE  
   BEGIN  
    SET @NEWQTY = FLOOR(@MARGIN_REQ/(@CL_RATE - @CL_RATE*@HAIRCUT/100))  
    IF @NEWQTY > @QTY   
    BEGIN  
     SET @NEWQTY = @QTY   
    END  
    IF @NEWQTY > 0   
    BEGIN  
     INSERT INTO TBL_PRODUCT_HOLD_DATA  
     SELECT SAUDA_DATE, SETT_NO = 'BSE', SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN,   
     QTY = @NEWQTY, SEC_PAYIN, START_DATE, ORGQTY=@NEWQTY, HOLDFLAG, CL_RATE, HAIRCUT, FOGFLAG, MTFHAIRCUT  
     FROM TBL_PRODUCT_HOLD_DATA  
     WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE  
     AND ISIN = @ISIN AND SRNO = @SRNO   
  
     UPDATE TBL_PRODUCT_HOLD_DATA SET QTY = QTY - @NEWQTY   
     WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE  
     AND ISIN = @ISIN AND SRNO = @SRNO   
  
     SET @MARGIN_REQ = @MARGIN_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)  
    END  
   END  
  
   IF @MARGIN_REQ <= 0   
   BEGIN  
    BREAK  
   END  
   FETCH NEXT FROM @DELCUR INTO @SRNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT  
  END  
  CLOSE @DELCUR  
  DEALLOCATE @DELCUR  
 END  
 FETCH NEXT FROM @COLLCUR INTO @PARTY_CODE, @MARGIN_REQ  
END  
CLOSE @COLLCUR  
DEALLOCATE @COLLCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_COLL_BREAKUP_BKUP_25Nov2022
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_MTF_COLL_BREAKUP_BKUP_25Nov2022]
(
	@SAUDA_DATE	VARCHAR(11)
)
AS 
-- EXEC PROC_MTF_COLL_BREAKUP @SAUDA_DATE = 'APR 15 2019'
DECLARE @PARTY_CODE VARCHAR(10),
	@ISIN	VARCHAR(12),
	@SRNO	INT,
	@MARGIN_REQ NUMERIC(18,4),
	@COLLCUR	CURSOR,
	@DELCUR	CURSOR,
	@NEWQTY INT,
	@QTY INT,
	@CL_RATE NUMERIC(18,4),
	@HAIRCUT	NUMERIC(18,4)
	
SELECT P.PARTY_CODE, ISIN, SCRIP_CD, SERIES, BSECODE, QTY = SUM(QTY), MKTAMT=SUM(NETAMT),NETAMT=SUM(NETAMT), 
HAIRCUT = CONVERT(NUMERIC(18,4),0),
CL_RATE = CONVERT(NUMERIC(18,4),0), MARGIN_REQ = CONVERT(NUMERIC(18,4),0),
MTOM_LOSS =  CONVERT(NUMERIC(18,4),0)  
INTO #BSEREQ
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), BSEDB.DBO.OWNER           
WHERE SAUDA_DATE <= @SAUDA_DATE           
AND ADJUST_DATE > @SAUDA_DATE          
AND SELL_BUY = 1           
AND C.CL_CODE = P.PARTY_CODE          
AND SETT_TYPE IN ('AD', 'D', 'C')           
GROUP BY P.PARTY_CODE, ISIN, SCRIP_CD, SERIES, BSECODE       
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0     

UPDATE #BSEREQ SET HAIRCUT = D.HAIRCUT, CL_RATE = D.CURR_CL_RATE, 
MARGIN_REQ = (CASE WHEN (CURR_CL_RATE*#BSEREQ.QTY) > #BSEREQ.MKTAMT THEN #BSEREQ.MKTAMT * d.HAIRCUT / 100	
ELSE (CURR_CL_RATE*#BSEREQ.QTY) * d.HAIRCUT / 100 END) 
FROM TBL_MTF_DATA D 
WHERE SAUDA_DATE = @SAUDA_DATE 
AND #BSEREQ.PARTY_CODE = D.PARTY_CODE 
AND #BSEREQ.ISIN = D.ISIN 

UPDATE #BSEREQ                   
    SET    MARGIN_REQ = MKTAMT * HAIRCUT / 100
	WHERE CL_RATE = 0 
	
    UPDATE #BSEREQ                   
    SET    MTOM_LOSS = (( MKTAMT / QTY - CL_RATE ) * QTY)     
    --WHERE  HAIRCUT <> 100   
         
 UPDATE #BSEREQ SET  MTOM_LOSS = (CASE WHEN A.MTOM_LOSS > 0 THEN #BSEREQ.MTOM_LOSS ELSE 0 END)    
 FROM (    
   SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)    
   FROM #BSEREQ    
   GROUP BY PARTY_CODE    
   ) A    
 WHERE #BSEREQ.PARTY_CODE = A.PARTY_CODE                      

UPDATE TBL_PRODUCT_HOLD_DATA SET SETT_NO = ''
WHERE SAUDA_DATE = @SAUDA_DATE
AND SETT_NO = 'BSE' AND HOLDFLAG= 'MTFCOLL'

SET @COLLCUR = CURSOR FOR 
SELECT PARTY_CODE, MARGIN_REQ=SUM(MARGIN_REQ+MTOM_LOSS) FROM #BSEREQ
GROUP BY PARTY_CODE
OPEN @COLLCUR 
FETCH NEXT FROM @COLLCUR INTO @PARTY_CODE, @MARGIN_REQ
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @MARGIN_REQ > 0 
	BEGIN
		SET @DELCUR = CURSOR FOR 
		SELECT SRNO, ISIN, QTY, CL_RATE, HAIRCUT FROM TBL_PRODUCT_HOLD_DATA
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND SETT_NO = '' AND HOLDFLAG= 'MTFCOLL'
		ORDER BY QTY DESC, CL_RATE 
		OPEN @DELCUR 
		FETCH NEXT FROM @DELCUR INTO @SRNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT
		WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @MARGIN_REQ >= @QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100
			BEGIN 
				UPDATE TBL_PRODUCT_HOLD_DATA SET SETT_NO = 'BSE'
				WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
				AND ISIN = @ISIN AND SRNO = @SRNO 

				SET @MARGIN_REQ = @MARGIN_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
			END
			ELSE
			BEGIN
				SET @NEWQTY = FLOOR(@MARGIN_REQ/(@CL_RATE - @CL_RATE*@HAIRCUT/100))
				IF @NEWQTY > @QTY 
				BEGIN
					SET @NEWQTY = @QTY 
				END
				IF @NEWQTY	> 0 
				BEGIN
					INSERT INTO TBL_PRODUCT_HOLD_DATA
					SELECT SAUDA_DATE, SETT_NO = 'BSE', SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, 
					QTY = @NEWQTY, SEC_PAYIN, START_DATE, ORGQTY=@NEWQTY, HOLDFLAG, CL_RATE, HAIRCUT, FOGFLAG, MTFHAIRCUT
					FROM TBL_PRODUCT_HOLD_DATA
					WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
					AND ISIN = @ISIN AND SRNO = @SRNO 

					UPDATE TBL_PRODUCT_HOLD_DATA SET QTY = QTY - @NEWQTY	
					WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
					AND ISIN = @ISIN AND SRNO = @SRNO 

					SET @MARGIN_REQ = @MARGIN_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END

			IF @MARGIN_REQ <= 0 
			BEGIN
				BREAK
			END
			FETCH NEXT FROM @DELCUR INTO @SRNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
	END
	FETCH NEXT FROM @COLLCUR INTO @PARTY_CODE, @MARGIN_REQ
END
CLOSE @COLLCUR
DEALLOCATE @COLLCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_CORPACT_QTY
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_MTF_CORPACT_QTY]
(
		@SAUDA_DATE VARCHAR(11),
		@OLDISIN	VARCHAR(12),
		@NEWISIN	VARCHAR(12),
		@FROMRATIO		NUMERIC(18,4),
		@TORATIO		NUMERIC(18,4),
		@EFFDATE	VARCHAR(11),
		@CORPTYPE	VARCHAR(20)
) AS

DECLARE @NEWSYMBOL	VARCHAR(12),
		@NEWSERIES	VARCHAR(3),
		@BSECODE	VARCHAR(12)

SELECT @NEWSYMBOL = '', @NEWSERIES = '', @BSECODE = ''

SELECT @NEWSYMBOL = SCRIP_CD, @NEWSERIES = SERIES FROM MSAJAG.DBO.MULTIISIN WHERE ISIN = @NEWISIN AND VALID = 1 
SELECT @BSECODE = SCRIP_CD FROM [ANGELBSECM].BSEDB_AB.DBO.MULTIISIN WHERE ISIN = @NEWISIN AND VALID = 1 

-- EXEC PROC_MTF_CORPACT_QTY @SAUDA_DATE= 'DEC 13 2019', @OLDISIN = 'INE860A01027', @NEWISIN = 'INE860A01027', @FROMRATIO = 2, @TORATIO = 1, @EFFDATE = 'DEC 17 2019', @CORPTYPE = 'BONUS'
	
INSERT INTO TBL_PRODUCT_POS_ADJUST
SELECT SAUDA_DATE=@EFFDATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
PARTY_CODE,SCRIP_CD,
SERIES,BSECODE,ISIN,QTY=SUM(QTY),TRANSTYPE,ADDED_BY='',ADDED_ON=GETDATE()
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE > @EFFDATE
AND ISIN = @OLDISIN
GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE
HAVING FLOOR(SUM(QTY)*@TORATIO/@FROMRATIO) > 0  

---SAUDA_dATE PROCESS DATE APR  6 2018

IF @CORPTYPE = 'BONUS'
BEGIN
	INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY
	SELECT SAUDA_DATE=@EFFDATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
	PARTY_CODE,SCRIP_CD,
	SERIES,BSECODE,ISIN=@NEWISIN,QTY=SUM(QTY)+FLOOR(SUM(QTY)*@TORATIO/@FROMRATIO),TRANSTYPE,ADDED_BY=@CORPTYPE,ADDED_ON=GETDATE(),
	MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE < @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE > @EFFDATE
	AND ISIN = @OLDISIN
	GROUP BY PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE
	HAVING FLOOR(SUM(QTY)*@TORATIO/@FROMRATIO) > 0 
END

IF @CORPTYPE <> 'BONUS'
BEGIN
	UPDATE TBL_PRODUCT_POSITION SET SCRIP_CD=@NEWSYMBOL,SERIES=@NEWSERIES,BSECODE=@BSECODE,ISIN=@NEWISIN
	WHERE SAUDA_DATE >= @SAUDA_DATE AND SELL_BUY = 1 
	AND ADJUST_DATE > @EFFDATE
	AND ISIN = @OLDISIN

	INSERT INTO TBL_PRODUCT_POS_ADJUST_BUY
	SELECT SAUDA_DATE=@EFFDATE,SETT_NO='2000000',SETT_TYPE=(CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END),
	PARTY_CODE,SCRIP_CD=@NEWSYMBOL,SERIES=@NEWSERIES,BSECODE=@BSECODE,ISIN=@NEWISIN,QTY=FLOOR(SUM(QTY)*@TORATIO/@FROMRATIO),TRANSTYPE,ADDED_BY=@CORPTYPE,ADDED_ON=GETDATE(),
	MKTAMT = SUM(MKTAMT), NETAMT = SUM(NETAMT)
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE < @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE > @EFFDATE
	AND ISIN = @OLDISIN
	GROUP BY PARTY_CODE,ISIN,TRANSTYPE
	HAVING FLOOR(SUM(QTY)*@TORATIO/@FROMRATIO) > 0 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_ONETIME_ALLOC
-- --------------------------------------------------







CREATE PROC [dbo].[PROC_MTF_ONETIME_ALLOC]
	(
	@SAUDA_DATE		VARCHAR(11),
	@PROCESS_FLAG	INT = 0,
	@MTM_FLAG		INT = 0,
	@ALLOC_FLAG		INT = 0
	)

	AS

	--DECLARE	@SAUDA_DATE		VARCHAR(11)
	--SET		@SAUDA_DATE = 'JUN 30 2025'
	/*
	@PROCESS_FLAG	= 0 -	RUN/EXECUTE BEFORE MTF PROCESS
	@PROCESS_FLAG	= 1 -	RUN/EXECUTE AFTER MTF PROCESS
	@MTM_FLAG		= 0	-	MTM NOT CONSIDER
	@MTM_FLAG		= 1 -	MTM DEDUCT FROM PAYIN AMOUNT
	@MTM_FLAG		= 2 -	PAYIN AMT DEDUCT FROM AVAIL BALANCE 

	BEGIN TRAN
	EXEC	PROC_MTF_ONETIME_ALLOC 'JUN 30 2025', 0, 0, 0  -- BEFORE MTF PROCESS
	EXEC	PROC_MTF_ONETIME_ALLOC 'JUN 30 2025', 1, 0, 0  -- AFTER MTF PROCESS

	EXEC	PROC_MTF_ONETIME_ALLOC 'JUN 30 2025', 0, 2, 1
	ROLLBACK
	COMMIT

	SELECT * FROM TBL_MTR_OPEN_BALANCE --WHERE PAYIN_AMT > 0 AND PARTY_CODE='500A3998'
	ORDER BY PARTY_CODE,SCRIP_CD

	SELECT * FROM TBL_MTF_DATA WHERE SAUDA_DATE='JUN 30 2025' AND PARTY_CODE='500S577'
	SELECT * FROM TBL_MTR_OPEN_BALANCE WHERE PARTY_CODE='500S577'
	ROLLBACK

	SELECT * FROM TBL_MTR_REPORTING WHERE M_FRESHBQTY>0 AND FRESHBQTY>0
	ORDER BY PARTY_CODE,SCRIP_CD,SAUDA_DATE 

	select sum(vamt) from ledger where vdt='JUN 30 2025' and narration='ONE TIME MAINT. MARGIN ALLOC FOR DATE: JUN 30 2025' and vtyp='66'
	and cltcode='GL222'
	cltcode='500A3998'
	*/


	DECLARE	@EDT		DATETIME,
			@SETTNO		VARCHAR(10),
			@RECCNT		INT,
			@VNO		VARCHAR(12),
			@GLCODE		VARCHAR(10),
			@PREVDATE	VARCHAR(11),     
			@BATCHNO	INT,
			@SDTCUR		DATETIME,
			@LDTCUR		DATETIME,
			@NONFNO		INT,
			@FNO		INT

	SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
	WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT	@NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER(NOLOCK)
	WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT	@EDT = LEFT(FUNDS_PAYIN,11), @SETTNO = SM.SETT_NO 
	FROM	MSAJAG.DBO.SETT_MST SM(NOLOCK)
	WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND SETT_TYPE = 'N'

	SELECT	@GLCODE = ACCODE FROM VALANACCOUNT(NOLOCK) WHERE ACNAME = 'MTF JV CONTROL'


	IF @PROCESS_FLAG = 1
	BEGIN

		UPDATE	TBL_MTR_REPORTING
		SET		M_FRESHBQTY = ISNULL(T.M_QTY,0),
				M_FRESHBUY	= ISNULL(ROUND(T.M_AMT,2),0),
				M_NETQTY	= ISNULL(T.NF_QTY,0),	
				M_NETAMOUNT = ISNULL(ROUND(T.NF_AMT,2),0)
		FROM	TBL_MTR_OPEN_BALANCE T(NOLOCK)
		WHERE	TBL_MTR_REPORTING.SAUDA_DATE = @SAUDA_DATE
				AND T.PARTY_CODE = TBL_MTR_REPORTING.PARTY_CODE
				AND T.SCRIP_CD = TBL_MTR_REPORTING.SCRIP_CD
				AND T.SERIES = TBL_MTR_REPORTING.SERIES
				AND T.BODQTY = TBL_MTR_REPORTING.BODQTY
				AND T.BODVALUE = TBL_MTR_REPORTING.BODVALUE

		/*
		SELECT	PARTY_CODE, 
				SELLPAYIN_AMT = SUM(M_FRESHBUY),
				VNO = CONVERT(VARCHAR(12),''),
				ACNAME = CONVERT(VARCHAR(100),''),
				DRCR = 'D',
				GLCODE = @GLCODE
		INTO	#MTR_OP_BAL_SELLPAYIN_JV
		FROM	TBL_MTR_REPORTING (NOLOCK) 
		WHERE	SAUDA_DATE=@EDT 
				AND NETQTY = 0 
				AND M_FRESHBQTY > 0
				AND M_FRESHBQTY > 0
		GROUP BY PARTY_CODE
		ORDER BY PARTY_CODE


		SET		@RECCNT = 0
		SET		@VNO = ''

		ALTER TABLE #MTR_OP_BAL_SELLPAYIN_JV
		ADD SNO	INT	IDENTITY(1,1)

		SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #MTR_OP_BAL_SELLPAYIN_JV 
	
		IF @RECCNT > 0 
		BEGIN
		
			CREATE TABLE #VNO1
			(
				VNO	VARCHAR(12)
			)

			INSERT	INTO #VNO1 
			EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

			SELECT	@VNO = VNO FROM #VNO1

			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET ACNAME = A.LONGNAME 
			FROM	ACMAST A
			WHERE	#MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = A.CLTCODE


			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '66'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)


			/*---- MTF_CASH_COLL_LEDGER -----------*/

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0

		
			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0
		
			
			UPDATE	TBL_MTR_REPORTING
			SET		M_FRESHBQTY = 0,
					M_FRESHBUY	= 0,
					M_NETQTY	= 0,	
					M_NETAMOUNT = 0
			WHERE	SAUDA_DATE=@EDT 
					AND NETQTY = 0 
					AND M_FRESHBQTY > 0
					AND M_FRESHBQTY > 0		
		
		END
		*/
		
		--SELECT * FROM TBL_MTR_REPORTING(NOLOCK) WHERE SAUDA_DATE='JUL  1 2025' AND NETQTY <> 0 AND M_FRESHBQTY > 0 AND FRESHSQTY > 0 --AND PARTY_CODE='ABAD2K116'
		--ORDER BY PARTY_CODE,SCRIP_CD
		--		SELECT AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE),2)),* FROM #CLOSEPOS
		--ORDER BY PARTY_CODE,SCRIP_CD

		SELECT	PARTY_CODE,
				SCRIP_CD,
				SERIES,
				NETQTY,
				CLOSE_QTY = ABS(NETQTY-(M_FRESHBQTY+M_NETQTY)),
				M_FRESHBQTY,
				M_FRESHBUY,
				M_NETQTY,
				M_PRICE = ROUND(M_FRESHBUY/M_FRESHBQTY,4),
				M_NETQTY_NEW = 0,
				M_FRESHBQTY_NEW = 0,
				EXCHANGE,
				ISIN,
				SRNO,
				BSECODE,
				FRESHBQTY,
				FRESHBUY,
				FRESHSQTY,
				FRESHSELL,
				NETAMOUNT,
				M_NETAMOUNT
		INTO	#CLOSEPOS
		FROM	TBL_MTR_REPORTING
		WHERE	SAUDA_DATE=@SAUDA_DATE AND NETQTY <> 0 AND M_FRESHBQTY > 0 AND FRESHSQTY > 0
			   
		IF @ALLOC_FLAG = 1
		BEGIN
		
			ALTER	TABLE #CLOSEPOS
			ADD		MARGIN_REQ	NUMERIC(18,4),
					HAIRCUT		NUMERIC(18,4),
					PRO_M_QTY	INT,
					PRO_PRICE	NUMERIC(18,4),
					BAL_NET_QTY	INT,
					PRO_ALLOC_PER	NUMERIC(18,4)

			UPDATE	#CLOSEPOS 
			SET		MARGIN_REQ	= 0,
					HAIRCUT		= 0,
					PRO_M_QTY	= 0,
					PRO_PRICE	= 0,
					BAL_NET_QTY = 0,
					PRO_ALLOC_PER = 0

			UPDATE	#CLOSEPOS
			SET		PRO_ALLOC_PER = ROUND(M_FRESHBUY/(M_FRESHBUY+M_NETAMOUNT)*100,2)
			WHERE	M_FRESHBUY > 0 AND (M_FRESHBUY+M_NETAMOUNT) > 0

			UPDATE	#CLOSEPOS
			SET		MARGIN_REQ = ((FRESHSQTY*M_PRICE)/100*PRO_ALLOC_PER),
					PRO_PRICE = ROUND(M_PRICE,4)
			WHERE	FRESHSELL > 0 AND PRO_ALLOC_PER > 0

			UPDATE	#CLOSEPOS
			SET		PRO_M_QTY = FLOOR((MARGIN_REQ/PRO_PRICE)) 
			WHERE	PRO_PRICE > 0 AND MARGIN_REQ > 0

			UPDATE	#CLOSEPOS
			SET		BAL_NET_QTY = (FRESHSQTY-PRO_M_QTY)
			WHERE	PRO_M_QTY > 0 AND FRESHSQTY > 0

			UPDATE	#CLOSEPOS
			SET		M_FRESHBQTY = (M_FRESHBQTY-PRO_M_QTY)
			WHERE	PRO_M_QTY > 0 AND M_FRESHBQTY > 0
		
			UPDATE	#CLOSEPOS
			SET		M_FRESHBQTY_NEW = (
					CASE 
						WHEN (M_FRESHBQTY - PRO_M_QTY) >= 0 THEN (M_FRESHBQTY - PRO_M_QTY) 
						ELSE M_FRESHBQTY 
					END)

			UPDATE	#CLOSEPOS
			SET		M_NETQTY_NEW = M_NETQTY - BAL_NET_QTY
			WHERE	(M_NETQTY - BAL_NET_QTY) >= 0

		END
		ElSE
		BEGIN

			UPDATE	#CLOSEPOS
			SET		M_NETQTY_NEW = (CASE WHEN (M_NETQTY - CLOSE_QTY) <= 0 THEN 0 ELSE (M_NETQTY - CLOSE_QTY) END)

			UPDATE	#CLOSEPOS
			SET		M_FRESHBQTY_NEW = (
					CASE 
						WHEN M_NETQTY_NEW = 0 THEN 
						CASE WHEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) > 0 THEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) ELSE 0 END 
						ELSE M_FRESHBQTY 
					END)

		END


		--SELECT	PARTY_CODE, 
		--		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(SUM((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE),2))
		--FROM	#CLOSEPOS
		--WHERE	(M_FRESHBQTY-M_FRESHBQTY_NEW) > 0
		--GROUP BY 
		--		PARTY_CODE
		--ORDER BY
		--		PARTY_CODE

		
		SELECT	PARTY_CODE, 
				SELLPAYIN_AMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SELLPAYIN_AMT),2)),
				VNO = CONVERT(VARCHAR(12),''),
				ACNAME = CONVERT(VARCHAR(100),''),
				DRCR = 'D',
				GLCODE = @GLCODE
		INTO	#MTR_OP_BAL_SELLPAYIN_JV
		FROM	(
				SELECT	PARTY_CODE, 
						SELLPAYIN_AMT = SUM(M_FRESHBUY)
				FROM	TBL_MTR_REPORTING (NOLOCK) 
				WHERE	SAUDA_DATE=@SAUDA_DATE 
						AND NETQTY = 0 
						AND M_FRESHBQTY > 0
						AND M_FRESHBQTY > 0
				GROUP BY PARTY_CODE
		
				UNION

				SELECT	PARTY_CODE, 
						SELLPAYIN_AMT = SUM((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE)
				FROM	#CLOSEPOS
				WHERE	(M_FRESHBQTY-M_FRESHBQTY_NEW) > 0
				GROUP BY 
						PARTY_CODE
				) A
		GROUP BY 
				PARTY_CODE
		ORDER BY
				PARTY_CODE


		SET		@RECCNT = 0
		SET		@VNO = ''

		ALTER TABLE #MTR_OP_BAL_SELLPAYIN_JV
		ADD SNO	INT	IDENTITY(1,1)

		SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #MTR_OP_BAL_SELLPAYIN_JV 
	
		IF @RECCNT > 0 
		BEGIN
		
			CREATE TABLE #VNO2
			(
				VNO	VARCHAR(12)
			)

			INSERT	INTO #VNO2 
			EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

			SELECT	@VNO = VNO FROM #VNO2

			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET ACNAME = A.LONGNAME 
			FROM	ACMAST A
			WHERE	#MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = A.CLTCODE


			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '66'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)


			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0

		
			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0
		

			UPDATE	TBL_MTR_REPORTING
			SET		M_FRESHBQTY = 0,
					M_FRESHBUY	= 0,
					M_NETQTY	= 0,	
					M_NETAMOUNT = 0
			WHERE	SAUDA_DATE=@SAUDA_DATE 
					AND NETQTY = 0 
					AND M_FRESHBQTY > 0
					AND M_FRESHBQTY > 0		

			
			UPDATE	TBL_MTR_REPORTING
			SET		M_FRESHBQTY = M_FRESHBQTY_NEW,
					M_FRESHBUY	= ROUND((M_FRESHBQTY_NEW*M_PRICE),2),
					M_NETQTY	= M_NETQTY_NEW,	
					M_NETAMOUNT = ROUND((M_NETQTY_NEW*M_PRICE),2)
			FROM	#CLOSEPOS
			WHERE	SAUDA_DATE=@SAUDA_DATE 
					AND #CLOSEPOS.PARTY_CODE = TBL_MTR_REPORTING.PARTY_CODE
					AND #CLOSEPOS.SCRIP_CD = TBL_MTR_REPORTING.SCRIP_CD
					AND #CLOSEPOS.SERIES = TBL_MTR_REPORTING.SERIES
					AND #CLOSEPOS.ISIN = TBL_MTR_REPORTING.ISIN
					AND TBL_MTR_REPORTING.NETQTY <> 0 
					AND TBL_MTR_REPORTING.M_FRESHBQTY > 0 
					AND TBL_MTR_REPORTING.FRESHSQTY > 0

		END 


		DROP TABLE #CLOSEPOS
		DROP TABLE #MTR_OP_BAL_SELLPAYIN_JV

		RETURN
		RETURN

	END



	TRUNCATE TABLE TBL_MTR_OPEN_BALANCE

	INSERT	INTO TBL_MTR_OPEN_BALANCE
	SELECT	[SAUDA_DATE] = @SAUDA_DATE,
			[PARTY_CODE] = PARTY_CODE,
			[SCRIP_CD] = SCRIP_CD,
			[SERIES] = SERIES,
			[BODQTY] = SUM(QTY),
			[BODVALUE] = SUM(MKTAMT),
			[FRESHBQTY] = 0,
			[FRESHBUY] = 0,
			[FRESHSQTY] = 0,
			[FRESHSELL] = 0,
			[NETQTY] = SUM(QTY),
			[NETAMOUNT] = SUM(MKTAMT),
			[M_BODQTY] = 0,
			[M_BODVALUE] = 0,
			[M_FRESHBQTY] = 0,
			[M_FRESHBUY] = 0,
			[M_FRESHSQTY] = 0,
			[M_FRESHSELL] = 0,
			[M_NETQTY] = 0,
			[M_NETAMOUNT] = 0,
			[EXCHANGE] = TRANSTYPE,
			[PROCESSDATE] = GETDATE(),
			[ISIN] = ISIN,
			[BSECODE] = BSECODE,
			[MARGIN_REQ] = 0,
			[MTM_AMT] = 0,
			[PAYIN_AMT] = 0,
			[PAYIN_AMT_BAL] = 0,
			[M_QTY] = 0,
			[M_PRICE] = 0,
			[M_AMT] = 0,
			[M_ALLOC_BALANCE] = 0,
			[NF_QTY] = 0,
			[NF_AMT] = 0,
			[COLL_QTY] = 0,
			[HAIRCUT] = 0,
			[PRO_PER] = 0
	FROM	VW_PRODUCT_POSITION (NOLOCK)
	WHERE	SAUDA_DATE <= @SAUDA_DATE       
			AND ADJUST_DATE > @SAUDA_DATE      
			AND SELL_BUY = 1
	GROUP BY
			PARTY_CODE,SCRIP_CD,SERIES,
			TRANSTYPE,ISIN,BSECODE
	HAVING	SUM(QTY) > 0 AND SUM(MKTAMT) > 0

	/*--- following condition commented in order to check 30 jun allocation & 1 jul dealloc --*/
	--IF @PROCESS_FLAG = 1
	--BEGIN
	--	DELETE	FROM TBL_MTR_OPEN_BALANCE
	--	WHERE	EXISTS (SELECT DISTINCT PARTY_CODE FROM TBL_NSE_REPORTING N(NOLOCK) 
	--			WHERE SAUDA_DATE=@EDT
	--			AND TBL_MTR_OPEN_BALANCE.PARTY_CODE = N.PARTY_CODE
	--			AND TBL_MTR_OPEN_BALANCE.SCRIP_CD = N.SCRIP_CD
	--			AND TBL_MTR_OPEN_BALANCE.SERIES = N.SERIES
	--			AND TBL_MTR_OPEN_BALANCE.BODQTY = N.BODQTY
	--			AND N.NETQTY = 0)
	--END


	SELECT V.* INTO #B_NSE_VAR FROM NSE_VARDETAIL V, 
	NSE_VARCONTROL  C
	WHERE C.RECDATE >= @SAUDA_DATE aND c.REcDATE <= @SAUDA_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES NOT IN ('BO')
	AND ISIN IN (SELECT DISTINCT ISIN FROM TBL_MTR_OPEN_BALANCE)

	SELECT V.* INTO  #BSE_VAR FROM BSE_VARDETAIL V
	WHERE V.FDATE >= @SAUDA_DATE aND v.FDATE <= @SAUDA_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM TBL_MTR_OPEN_BALANCE)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE	TBL_MTR_OPEN_BALANCE 
    SET		HAIRCUT = M.APPVAR + @NONFNO * SECSPECVAR
    FROM	#B_NSE_VAR M
    WHERE	M.ISIN = TBL_MTR_OPEN_BALANCE.ISIN 
	AND		HAIRCUT = 0

	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		HAIRCUT = M.MARGIN + @NONFNO * ELM
	FROM	#B_BSE_VAR M
	WHERE	M.ISIN = TBL_MTR_OPEN_BALANCE.ISIN 
	AND		HAIRCUT = 0


	UPDATE	TBL_MTR_OPEN_BALANCE
	SET		MARGIN_REQ = BODVALUE*HAIRCUT/100	


	SELECT	PARTY_CODE, 
			VAMT = (CASE WHEN SUM(VAMT) > SUM(MTM_VAMT) THEN SUM(VAMT)+(CASE WHEN @MTM_FLAG = 1 THEN -SUM(MTM_VAMT) ELSE 0 END) ELSE 0 END),
			MTM_VAMT = SUM(MTM_VAMT)
	INTO	#PAYIN
	FROM	(
			SELECT	PARTY_CODE, VAMT = SUM(NETAMT) + MTFLEDBAL,
					MTM_VAMT = SUM(MTOM_LOSS)
			FROM	TBL_MTF_DATA M WITH (NOLOCK)
			WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
					--AND 1 = (CASE WHEN @MTM_FLAG = 1 THEN 1 ELSE 0 END)
			GROUP BY
					PARTY_CODE, MTFLEDBAL
			HAVING	(SUM(NETAMT) + MTFLEDBAL) > 0
			) A
	GROUP BY 
			PARTY_CODE	
	
	/*
	SELECT	CLTCODE,
			VAMT = SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)
	INTO	#PAYIN
	FROM	LEDGER P(NOLOCK)
	WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
			AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
			AND P.VTYP <> '35'
			--AND P.EDT BETWEEN @EDT AND @EDT + ' 23:59:59'
	GROUP BY
			CLTCODE
	HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0

	UNION
			
	SELECT	PARTY_CODE, MTM_VAMT = -SUM(MTOM_LOSS)
	FROM	TBL_MTF_DATA M WITH (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND 1 = (CASE WHEN @MTM_FLAG = 1 THEN 1 ELSE 0 END)
	GROUP BY
			PARTY_CODE
	HAVING	SUM(MTOM_LOSS) > 0
	*/

	--SELECT * FROM TBL_MTR_OPEN_BALANCE ORDER BY PARTY_CODE
	--SELECT * FROM #PAYIN  ORDER BY PARTY_CODE

	--RETURN


	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		PAYIN_AMT = ISNULL(P.VAMT,0),
			MTM_AMT	= ISNULL(P.MTM_VAMT,0)
	FROM	#PAYIN P(NOLOCK)
	WHERE	P.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE

	/*
	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		PAYIN_AMT = ISNULL(D.VAMT,0)
	FROM	(
			SELECT	PARTY_CODE,
					VAMT = SUM(VAMT)
			FROM	#PAYIN P(NOLOCK)
			GROUP BY
					PARTY_CODE
			HAVING	SUM(VAMT) > 0
			) D
	WHERE	D.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE


	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		PAYIN_AMT = ISNULL(D.MTM_VAMT,0)
	FROM	(
			SELECT	PARTY_CODE,
					MTM_VAMT = SUM(MTM_VAMT)
			FROM	#PAYIN P(NOLOCK)
			GROUP BY
					PARTY_CODE
			HAVING	SUM(MTM_VAMT) > 0
			) D
	WHERE	D.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE


	--UPDATE	TBL_MTR_OPEN_BALANCE 
	--SET		MTM_AMT = ISNULL(D.MTM_VAMT,0)
	--FROM	(
	--		SELECT	PARTY_CODE, MTM_VAMT = SUM(MTOM_LOSS)
	--		FROM	TBL_MTF_DATA M WITH (NOLOCK)
	--		WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	--		GROUP BY
	--				PARTY_CODE
	--		HAVING	SUM(MTOM_LOSS) > 0
	--		) D
	--WHERE	D.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE
	*/

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@PARTYCODE	VARCHAR(20),
			@PAYIN_AMT	NUMERIC(18,4),
			@MKTAMT		NUMERIC(18,4),
			@MARGIN_REQ	NUMERIC(18,4),
			@SNO		INT,
			@MAMT		NUMERIC(18,4),
			@SAUDA_DATE_PAYIN	DATETIME,
			@PRO_PER	NUMERIC(18,2)

	SET @ADJCUR = CURSOR FOR
		SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
				PRO_PER =  (
				CASE 
					WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
					ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
				END)
		FROM	TBL_MTR_OPEN_BALANCE
		WHERE	PAYIN_AMT > 0
		GROUP BY PARTY_CODE, SAUDA_DATE
		ORDER BY PARTY_CODE, SAUDA_DATE
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
	WHILE @@FETCH_STATUS = 0
	BEGIN 

		SET @DELCUR = CURSOR FOR
			SELECT SNO=SRNO, MKTAMT=BODVALUE, 
			MARGIN_REQ = (CASE WHEN @ALLOC_FLAG = 1 THEN (MARGIN_REQ*@PRO_PER/100) ELSE  MARGIN_REQ END)
			FROM TBL_MTR_OPEN_BALANCE
			WHERE SAUDA_DATE = @SAUDA_DATE_PAYIN 
			AND PARTY_CODE = @PARTYCODE
			AND BODVALUE > 0 AND MARGIN_REQ > 0
			ORDER BY PARTY_CODE, SRNO
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @PAYIN_AMT > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @ALLOC_FLAG = 1
				BEGIN
					SET		@MAMT = 0
				
					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		PAYIN_AMT_BAL = @MARGIN_REQ, 
							PRO_PER = @PRO_PER
					WHERE	SRNO = @SNO

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		M_PRICE = ROUND((BODVALUE/BODQTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		M_AMT = M_AMT + ROUND((M_PRICE*M_QTY),2),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - ROUND((M_PRICE*M_QTY),2),
							@MAMT = ROUND((M_PRICE*M_QTY),2)
					WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		NF_QTY = (BODQTY-M_QTY),
							NF_AMT = M_PRICE*(BODQTY-M_QTY)
					WHERE	SRNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

					--IF @PARTYCODE='500A3998'
					--BEGIN
					--	SELECT @MARGIN_REQ
					--	SELECT * FROM TBL_MTR_OPEN_BALANCE WHERE PARTY_CODE=@PARTYCODE
					--END

					--SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT
				END
				ELSE
				BEGIN				
					
					IF @PAYIN_AMT >= @MARGIN_REQ 
					--IF PRADNYA.DBO.FNMIN(@PAYIN_AMT,@MARGIN_REQ)
					BEGIN
				
						SET		@MAMT = 0
				
						UPDATE	TBL_MTR_OPEN_BALANCE SET PAYIN_AMT_BAL = @MARGIN_REQ
						WHERE	SRNO = @SNO

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_PRICE = ROUND((BODVALUE/BODQTY),4)--,
								--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_AMT = M_AMT + ROUND((M_PRICE*M_QTY),2),
								M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - ROUND((M_PRICE*M_QTY),2),
								@MAMT = ROUND((M_PRICE*M_QTY),2)
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		NF_QTY = (BODQTY-M_QTY),
								NF_AMT = M_PRICE*(BODQTY-M_QTY)
						WHERE	SRNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

						SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT

						--SELECT	SRNO = @SNO, PAYIN_AMT=@PAYIN_AMT, M_AMT = @MAMT, PAYIN_BALANCE = (@PAYIN_AMT - @MAMT)
						--SET @PAYIN_AMT = @PAYIN_AMT - @MARGIN_REQ

					END
					ELSE
					BEGIN

						UPDATE	TBL_MTR_OPEN_BALANCE SET PAYIN_AMT_BAL = @PAYIN_AMT
						WHERE	SRNO = @SNO

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_PRICE = ROUND((BODVALUE/BODQTY),4)--,
								--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_AMT = M_AMT + ROUND((M_PRICE*M_QTY),2),
								M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - ROUND((M_PRICE*M_QTY),2),
								@MAMT = ROUND((M_PRICE*M_QTY),2)
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		NF_QTY = (BODQTY-M_QTY),
								NF_AMT = M_PRICE*(BODQTY-M_QTY)
						WHERE	SRNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0
				
						SET @PAYIN_AMT = 0

					END
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
		END
	
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR

	
	UPDATE	TBL_MTR_OPEN_BALANCE
	SET		COLL_QTY = M_QTY
	WHERE	M_QTY > 0

	IF @PROCESS_FLAG = 0
	BEGIN
		
		INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
		SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY=BODQTY,MKTAMT=BODVALUE,NETAMT=BODVALUE,
				SETT_NO=@SETTNO,PAYIN_DATE=@EDT,
				EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
				M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE, NF_QTY,NF_AMT,SELL_BUY=1,
				COLL_QTY,
				PROCESS_ON=GETDATE(), 
				PROCESS_BY='OPENBAL'
		FROM	TBL_MTR_OPEN_BALANCE 
		WHERE	M_QTY > 0

	--END
	--ELSE
	--BEGIN
	
		SELECT	PARTY_CODE, 
				PAYIN_AMT = MAX(PAYIN_AMT)+(CASE WHEN @MTM_FLAG = 1 THEN 0 ELSE MAX(MTM_AMT) END),
				M_AMT = SUM(M_AMT), 
				MTM_AMT = (
				CASE 
					WHEN @MTM_FLAG = 1 THEN MAX(MTM_AMT) 
					WHEN @MTM_FLAG = 2 THEN 
					(CASE WHEN MAX(MTM_AMT) > (MAX(PAYIN_AMT)-SUM(M_AMT)) THEN (MAX(PAYIN_AMT)-SUM(M_AMT)) ELSE MAX(MTM_AMT) END)
					ELSE 0 
				END),
				VNO = CONVERT(VARCHAR(12),''),
				ACNAME = CONVERT(VARCHAR(100),''),
				DRCR = 'D',
				GLCODE = @GLCODE,
				MARGIN_REQ = SUM(MARGIN_REQ),
				BAL_PAYIN_AMT = MAX(PAYIN_AMT)-SUM(MARGIN_REQ),
				MTM_AMT_JV = (CASE WHEN MAX(MTM_AMT) > (SUM(M_AMT)-SUM(MARGIN_REQ)) THEN (SUM(M_AMT)-SUM(MARGIN_REQ)) ELSE MAX(MTM_AMT) END)
		INTO	#MTR_OP_BAL_JV
		FROM	TBL_MTR_OPEN_BALANCE
		WHERE	M_QTY > 0
		GROUP BY PARTY_CODE
		ORDER BY PARTY_CODE


		SET		@RECCNT = 0
		SET		@VNO = ''

		ALTER TABLE #MTR_OP_BAL_JV
		ADD SNO	INT	IDENTITY(1,1)

		SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #MTR_OP_BAL_JV 
	
		IF @RECCNT > 0 
		BEGIN
		
			CREATE TABLE #VNO
			(
				VNO	VARCHAR(12)
			)

			INSERT	INTO #VNO 
			EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

			SELECT	@VNO = VNO FROM #VNO

			UPDATE	#MTR_OP_BAL_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
			UPDATE	#MTR_OP_BAL_JV SET ACNAME = A.LONGNAME 
			FROM	ACMAST A
			WHERE	#MTR_OP_BAL_JV.PARTY_CODE = A.CLTCODE

			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEGIN OPENING BALANCE JV FOR MTM ON DATE:%' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MTM_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEGIN OPENING BALANCE JV FOR MTM ON DATE:%' AND VTYP = '67'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MTM_AMT <> 0)
		
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%ONE TIME MAINT. MARGIN ALLOC FOR DATE:%' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND M_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%ONE TIME MAINT. MARGIN ALLOC FOR DATE:%' AND VTYP = '66'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND M_AMT <> 0)

			/*--- COMMENTED ON DATE : 19/09/2025 [ FOLLOWING LOGIC IS FOR OPENING MTF CASH COLL LEDGER BASE ON MTF LEDGER CR ENTRY ] ------*/

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR='D', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=1, A.ACNAME, DRCR='C', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '02', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT > 0

	
			INSERT INTO LEDGER
			SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT > 0		


		
			INSERT INTO LEDGER
			SELECT '67', VNO, @EDT, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '67', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT <> 0		



			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT > 0		

			---- ONE TIME OPENNING BALANCE AGAINST MAINTENANCE MARGIN ---



			---- ONE TIME OPENNING BALANCE AGAINST MAINTENANCE MARGIN ---

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE M_AMT > 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND M_AMT > 0


		
			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE M_AMT > 0

			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND M_AMT > 0


			DROP TABLE #MTR_OP_BAL_JV

		END

	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTF_ONETIME_ALLOC_BKUP_26SEP2025
-- --------------------------------------------------







CREATE PROC [dbo].[PROC_MTF_ONETIME_ALLOC]
	(
	@SAUDA_DATE		VARCHAR(11),
	@PROCESS_FLAG	INT = 0,
	@MTM_FLAG		INT = 0,
	@ALLOC_FLAG		INT = 0
	)
 
	AS

	--DECLARE	@SAUDA_DATE		VARCHAR(11)
	--SET		@SAUDA_DATE = 'JUN 30 2025'
	/*
	@PROCESS_FLAG	= 0 -	RUN/EXECUTE BEFORE MTF PROCESS
	@PROCESS_FLAG	= 1 -	RUN/EXECUTE AFTER MTF PROCESS
	@MTM_FLAG		= 0	-	MTM NOT CONSIDER
	@MTM_FLAG		= 1 -	MTM DEDUCT FROM PAYIN AMOUNT
	@MTM_FLAG		= 2 -	PAYIN AMT DEDUCT FROM AVAIL BALANCE 

	BEGIN TRAN
	EXEC	PROC_MTF_ONETIME_ALLOC 'JUN 30 2025', 0, 0, 0  -- BEFORE MTF PROCESS
	EXEC	PROC_MTF_ONETIME_ALLOC 'JUN 30 2025', 1, 0, 0  -- AFTER MTF PROCESS

	EXEC	PROC_MTF_ONETIME_ALLOC 'JUN 30 2025', 0, 2, 1
	ROLLBACK
	COMMIT

	SELECT * FROM TBL_MTR_OPEN_BALANCE --WHERE PAYIN_AMT > 0 AND PARTY_CODE='500A3998'
	ORDER BY PARTY_CODE,SCRIP_CD

	SELECT * FROM TBL_MTF_DATA WHERE SAUDA_DATE='JUN 30 2025' AND PARTY_CODE='500S577'
	SELECT * FROM TBL_MTR_OPEN_BALANCE WHERE PARTY_CODE='500S577'
	ROLLBACK

	SELECT * FROM TBL_MTR_REPORTING WHERE M_FRESHBQTY>0 AND FRESHBQTY>0
	ORDER BY PARTY_CODE,SCRIP_CD,SAUDA_DATE 

	select sum(vamt) from ledger where vdt='JUN 30 2025' and narration='ONE TIME MAINT. MARGIN ALLOC FOR DATE: JUN 30 2025' and vtyp='66'
	and cltcode='GL222'
	cltcode='500A3998'
	*/


	DECLARE	@EDT		DATETIME,
			@SETTNO		VARCHAR(10),
			@RECCNT		INT,
			@VNO		VARCHAR(12),
			@GLCODE		VARCHAR(10),
			@PREVDATE	VARCHAR(11),     
			@BATCHNO	INT,
			@SDTCUR		DATETIME,
			@LDTCUR		DATETIME,
			@NONFNO		INT,
			@FNO		INT

	SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
	WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT	@NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER(NOLOCK)
	WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT	@EDT = LEFT(FUNDS_PAYIN,11), @SETTNO = SM.SETT_NO 
	FROM	MSAJAG.DBO.SETT_MST SM(NOLOCK)
	WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND SETT_TYPE = 'N'

	SELECT	@GLCODE = ACCODE FROM VALANACCOUNT(NOLOCK) WHERE ACNAME = 'MTF JV CONTROL'


	IF @PROCESS_FLAG = 1
	BEGIN

		UPDATE	TBL_MTR_REPORTING
		SET		M_FRESHBQTY = ISNULL(T.M_QTY,0),
				M_FRESHBUY	= ISNULL(ROUND(T.M_AMT,2),0),
				M_NETQTY	= ISNULL(T.NF_QTY,0),	
				M_NETAMOUNT = ISNULL(ROUND(T.NF_AMT,2),0)
		FROM	TBL_MTR_OPEN_BALANCE T(NOLOCK)
		WHERE	TBL_MTR_REPORTING.SAUDA_DATE = @SAUDA_DATE
				AND T.PARTY_CODE = TBL_MTR_REPORTING.PARTY_CODE
				AND T.SCRIP_CD = TBL_MTR_REPORTING.SCRIP_CD
				AND T.SERIES = TBL_MTR_REPORTING.SERIES
				AND T.BODQTY = TBL_MTR_REPORTING.BODQTY
				AND T.BODVALUE = TBL_MTR_REPORTING.BODVALUE

		/*
		SELECT	PARTY_CODE, 
				SELLPAYIN_AMT = SUM(M_FRESHBUY),
				VNO = CONVERT(VARCHAR(12),''),
				ACNAME = CONVERT(VARCHAR(100),''),
				DRCR = 'D',
				GLCODE = @GLCODE
		INTO	#MTR_OP_BAL_SELLPAYIN_JV
		FROM	TBL_MTR_REPORTING (NOLOCK) 
		WHERE	SAUDA_DATE=@EDT 
				AND NETQTY = 0 
				AND M_FRESHBQTY > 0
				AND M_FRESHBQTY > 0
		GROUP BY PARTY_CODE
		ORDER BY PARTY_CODE


		SET		@RECCNT = 0
		SET		@VNO = ''

		ALTER TABLE #MTR_OP_BAL_SELLPAYIN_JV
		ADD SNO	INT	IDENTITY(1,1)

		SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #MTR_OP_BAL_SELLPAYIN_JV 
	
		IF @RECCNT > 0 
		BEGIN
		
			CREATE TABLE #VNO1
			(
				VNO	VARCHAR(12)
			)

			INSERT	INTO #VNO1 
			EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

			SELECT	@VNO = VNO FROM #VNO1

			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET ACNAME = A.LONGNAME 
			FROM	ACMAST A
			WHERE	#MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = A.CLTCODE


			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '66'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)


			/*---- MTF_CASH_COLL_LEDGER -----------*/

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0

		
			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0
		
			
			UPDATE	TBL_MTR_REPORTING
			SET		M_FRESHBQTY = 0,
					M_FRESHBUY	= 0,
					M_NETQTY	= 0,	
					M_NETAMOUNT = 0
			WHERE	SAUDA_DATE=@EDT 
					AND NETQTY = 0 
					AND M_FRESHBQTY > 0
					AND M_FRESHBQTY > 0		
		
		END
		*/
		
		--SELECT * FROM TBL_MTR_REPORTING(NOLOCK) WHERE SAUDA_DATE='JUL  1 2025' AND NETQTY <> 0 AND M_FRESHBQTY > 0 AND FRESHSQTY > 0 --AND PARTY_CODE='ABAD2K116'
		--ORDER BY PARTY_CODE,SCRIP_CD
		--		SELECT AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE),2)),* FROM #CLOSEPOS
		--ORDER BY PARTY_CODE,SCRIP_CD

		SELECT	PARTY_CODE,
				SCRIP_CD,
				SERIES,
				NETQTY,
				CLOSE_QTY = ABS(NETQTY-(M_FRESHBQTY+M_NETQTY)),
				M_FRESHBQTY,
				M_FRESHBUY,
				M_NETQTY,
				M_PRICE = ROUND(M_FRESHBUY/M_FRESHBQTY,4),
				M_NETQTY_NEW = 0,
				M_FRESHBQTY_NEW = 0,
				EXCHANGE,
				ISIN,
				SRNO,
				BSECODE,
				FRESHBQTY,
				FRESHBUY,
				FRESHSQTY,
				FRESHSELL,
				NETAMOUNT,
				M_NETAMOUNT
		INTO	#CLOSEPOS
		FROM	TBL_MTR_REPORTING
		WHERE	SAUDA_DATE=@SAUDA_DATE AND NETQTY <> 0 AND M_FRESHBQTY > 0 AND FRESHSQTY > 0
			   
		IF @ALLOC_FLAG = 1
		BEGIN
		
			ALTER	TABLE #CLOSEPOS
			ADD		MARGIN_REQ	NUMERIC(18,4),
					HAIRCUT		NUMERIC(18,4),
					PRO_M_QTY	INT,
					PRO_PRICE	NUMERIC(18,4),
					BAL_NET_QTY	INT,
					PRO_ALLOC_PER	NUMERIC(18,4)

			UPDATE	#CLOSEPOS 
			SET		MARGIN_REQ	= 0,
					HAIRCUT		= 0,
					PRO_M_QTY	= 0,
					PRO_PRICE	= 0,
					BAL_NET_QTY = 0,
					PRO_ALLOC_PER = 0

			UPDATE	#CLOSEPOS
			SET		PRO_ALLOC_PER = ROUND(M_FRESHBUY/(M_FRESHBUY+M_NETAMOUNT)*100,2)
			WHERE	M_FRESHBUY > 0 AND (M_FRESHBUY+M_NETAMOUNT) > 0

			UPDATE	#CLOSEPOS
			SET		MARGIN_REQ = ((FRESHSQTY*M_PRICE)/100*PRO_ALLOC_PER),
					PRO_PRICE = ROUND(M_PRICE,4)
			WHERE	FRESHSELL > 0 AND PRO_ALLOC_PER > 0

			UPDATE	#CLOSEPOS
			SET		PRO_M_QTY = FLOOR((MARGIN_REQ/PRO_PRICE)) 
			WHERE	PRO_PRICE > 0 AND MARGIN_REQ > 0

			UPDATE	#CLOSEPOS
			SET		BAL_NET_QTY = (FRESHSQTY-PRO_M_QTY)
			WHERE	PRO_M_QTY > 0 AND FRESHSQTY > 0

			UPDATE	#CLOSEPOS
			SET		M_FRESHBQTY = (M_FRESHBQTY-PRO_M_QTY)
			WHERE	PRO_M_QTY > 0 AND M_FRESHBQTY > 0
		
			UPDATE	#CLOSEPOS
			SET		M_FRESHBQTY_NEW = (
					CASE 
						WHEN (M_FRESHBQTY - PRO_M_QTY) >= 0 THEN (M_FRESHBQTY - PRO_M_QTY) 
						ELSE M_FRESHBQTY 
					END)

			UPDATE	#CLOSEPOS
			SET		M_NETQTY_NEW = M_NETQTY - BAL_NET_QTY
			WHERE	(M_NETQTY - BAL_NET_QTY) >= 0

		END
		ElSE
		BEGIN

			UPDATE	#CLOSEPOS
			SET		M_NETQTY_NEW = (CASE WHEN (M_NETQTY - CLOSE_QTY) <= 0 THEN 0 ELSE (M_NETQTY - CLOSE_QTY) END)

			UPDATE	#CLOSEPOS
			SET		M_FRESHBQTY_NEW = (
					CASE 
						WHEN M_NETQTY_NEW = 0 THEN 
						CASE WHEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) > 0 THEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) ELSE 0 END 
						ELSE M_FRESHBQTY 
					END)

		END


		--SELECT	PARTY_CODE, 
		--		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(SUM((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE),2))
		--FROM	#CLOSEPOS
		--WHERE	(M_FRESHBQTY-M_FRESHBQTY_NEW) > 0
		--GROUP BY 
		--		PARTY_CODE
		--ORDER BY
		--		PARTY_CODE

		
		SELECT	PARTY_CODE, 
				SELLPAYIN_AMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SELLPAYIN_AMT),2)),
				VNO = CONVERT(VARCHAR(12),''),
				ACNAME = CONVERT(VARCHAR(100),''),
				DRCR = 'D',
				GLCODE = @GLCODE
		INTO	#MTR_OP_BAL_SELLPAYIN_JV
		FROM	(
				SELECT	PARTY_CODE, 
						SELLPAYIN_AMT = SUM(M_FRESHBUY)
				FROM	TBL_MTR_REPORTING (NOLOCK) 
				WHERE	SAUDA_DATE=@SAUDA_DATE 
						AND NETQTY = 0 
						AND M_FRESHBQTY > 0
						AND M_FRESHBQTY > 0
				GROUP BY PARTY_CODE
		
				UNION

				SELECT	PARTY_CODE, 
						SELLPAYIN_AMT = SUM((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE)
				FROM	#CLOSEPOS
				WHERE	(M_FRESHBQTY-M_FRESHBQTY_NEW) > 0
				GROUP BY 
						PARTY_CODE
				) A
		GROUP BY 
				PARTY_CODE
		ORDER BY
				PARTY_CODE


		SET		@RECCNT = 0
		SET		@VNO = ''

		ALTER TABLE #MTR_OP_BAL_SELLPAYIN_JV
		ADD SNO	INT	IDENTITY(1,1)

		SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #MTR_OP_BAL_SELLPAYIN_JV 
	
		IF @RECCNT > 0 
		BEGIN
		
			CREATE TABLE #VNO2
			(
				VNO	VARCHAR(12)
			)

			INSERT	INTO #VNO2 
			EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

			SELECT	@VNO = VNO FROM #VNO2

			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
			UPDATE	#MTR_OP_BAL_SELLPAYIN_JV SET ACNAME = A.LONGNAME 
			FROM	ACMAST A
			WHERE	#MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = A.CLTCODE


			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '66'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_SELLPAYIN_JV WHERE #MTR_OP_BAL_SELLPAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND SELLPAYIN_AMT <> 0)


			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0

		
			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV
			WHERE SELLPAYIN_AMT <> 0

			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ABS(SELLPAYIN_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
			FROM #MTR_OP_BAL_SELLPAYIN_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND SELLPAYIN_AMT <> 0
		

			UPDATE	TBL_MTR_REPORTING
			SET		M_FRESHBQTY = 0,
					M_FRESHBUY	= 0,
					M_NETQTY	= 0,	
					M_NETAMOUNT = 0
			WHERE	SAUDA_DATE=@SAUDA_DATE 
					AND NETQTY = 0 
					AND M_FRESHBQTY > 0
					AND M_FRESHBQTY > 0		

			
			UPDATE	TBL_MTR_REPORTING
			SET		M_FRESHBQTY = M_FRESHBQTY_NEW,
					M_FRESHBUY	= ROUND((M_FRESHBQTY_NEW*M_PRICE),2),
					M_NETQTY	= M_NETQTY_NEW,	
					M_NETAMOUNT = ROUND((M_NETQTY_NEW*M_PRICE),2)
			FROM	#CLOSEPOS
			WHERE	SAUDA_DATE=@SAUDA_DATE 
					AND #CLOSEPOS.PARTY_CODE = TBL_MTR_REPORTING.PARTY_CODE
					AND #CLOSEPOS.SCRIP_CD = TBL_MTR_REPORTING.SCRIP_CD
					AND #CLOSEPOS.SERIES = TBL_MTR_REPORTING.SERIES
					AND #CLOSEPOS.ISIN = TBL_MTR_REPORTING.ISIN
					AND TBL_MTR_REPORTING.NETQTY <> 0 
					AND TBL_MTR_REPORTING.M_FRESHBQTY > 0 
					AND TBL_MTR_REPORTING.FRESHSQTY > 0

		END 


		DROP TABLE #CLOSEPOS
		DROP TABLE #MTR_OP_BAL_SELLPAYIN_JV

		RETURN
		RETURN

	END



	TRUNCATE TABLE TBL_MTR_OPEN_BALANCE

	INSERT	INTO TBL_MTR_OPEN_BALANCE
	SELECT	[SAUDA_DATE] = @SAUDA_DATE,
			[PARTY_CODE] = PARTY_CODE,
			[SCRIP_CD] = SCRIP_CD,
			[SERIES] = SERIES,
			[BODQTY] = SUM(QTY),
			[BODVALUE] = SUM(MKTAMT),
			[FRESHBQTY] = 0,
			[FRESHBUY] = 0,
			[FRESHSQTY] = 0,
			[FRESHSELL] = 0,
			[NETQTY] = SUM(QTY),
			[NETAMOUNT] = SUM(MKTAMT),
			[M_BODQTY] = 0,
			[M_BODVALUE] = 0,
			[M_FRESHBQTY] = 0,
			[M_FRESHBUY] = 0,
			[M_FRESHSQTY] = 0,
			[M_FRESHSELL] = 0,
			[M_NETQTY] = 0,
			[M_NETAMOUNT] = 0,
			[EXCHANGE] = TRANSTYPE,
			[PROCESSDATE] = GETDATE(),
			[ISIN] = ISIN,
			[BSECODE] = BSECODE,
			[MARGIN_REQ] = 0,
			[MTM_AMT] = 0,
			[PAYIN_AMT] = 0,
			[PAYIN_AMT_BAL] = 0,
			[M_QTY] = 0,
			[M_PRICE] = 0,
			[M_AMT] = 0,
			[M_ALLOC_BALANCE] = 0,
			[NF_QTY] = 0,
			[NF_AMT] = 0,
			[COLL_QTY] = 0,
			[HAIRCUT] = 0,
			[PRO_PER] = 0
	FROM	VW_PRODUCT_POSITION (NOLOCK)
	WHERE	SAUDA_DATE <= @SAUDA_DATE       
			AND ADJUST_DATE > @SAUDA_DATE      
			AND SELL_BUY = 1
	GROUP BY
			PARTY_CODE,SCRIP_CD,SERIES,
			TRANSTYPE,ISIN,BSECODE
	HAVING	SUM(QTY) > 0 AND SUM(MKTAMT) > 0

	/*--- following condition commented in order to check 30 jun allocation & 1 jul dealloc --*/
	--IF @PROCESS_FLAG = 1
	--BEGIN
	--	DELETE	FROM TBL_MTR_OPEN_BALANCE
	--	WHERE	EXISTS (SELECT DISTINCT PARTY_CODE FROM TBL_NSE_REPORTING N(NOLOCK) 
	--			WHERE SAUDA_DATE=@EDT
	--			AND TBL_MTR_OPEN_BALANCE.PARTY_CODE = N.PARTY_CODE
	--			AND TBL_MTR_OPEN_BALANCE.SCRIP_CD = N.SCRIP_CD
	--			AND TBL_MTR_OPEN_BALANCE.SERIES = N.SERIES
	--			AND TBL_MTR_OPEN_BALANCE.BODQTY = N.BODQTY
	--			AND N.NETQTY = 0)
	--END


	SELECT V.* INTO #B_NSE_VAR FROM NSE_VARDETAIL V, 
	NSE_VARCONTROL  C
	WHERE C.RECDATE >= @SAUDA_DATE aND c.REcDATE <= @SAUDA_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES NOT IN ('BO')
	AND ISIN IN (SELECT DISTINCT ISIN FROM TBL_MTR_OPEN_BALANCE)

	SELECT V.* INTO  #BSE_VAR FROM BSE_VARDETAIL V
	WHERE V.FDATE >= @SAUDA_DATE aND v.FDATE <= @SAUDA_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM TBL_MTR_OPEN_BALANCE)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE	TBL_MTR_OPEN_BALANCE 
    SET		HAIRCUT = M.APPVAR + @NONFNO * SECSPECVAR
    FROM	#B_NSE_VAR M
    WHERE	M.ISIN = TBL_MTR_OPEN_BALANCE.ISIN 
	AND		HAIRCUT = 0

	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		HAIRCUT = M.MARGIN + @NONFNO * ELM
	FROM	#B_BSE_VAR M
	WHERE	M.ISIN = TBL_MTR_OPEN_BALANCE.ISIN 
	AND		HAIRCUT = 0


	UPDATE	TBL_MTR_OPEN_BALANCE
	SET		MARGIN_REQ = BODVALUE*HAIRCUT/100	


	SELECT	PARTY_CODE, 
			VAMT = (CASE WHEN SUM(VAMT) > SUM(MTM_VAMT) THEN SUM(VAMT)+(CASE WHEN @MTM_FLAG = 1 THEN -SUM(MTM_VAMT) ELSE 0 END) ELSE 0 END),
			MTM_VAMT = SUM(MTM_VAMT)
	INTO	#PAYIN
	FROM	(
			SELECT	PARTY_CODE, VAMT = SUM(NETAMT) + MTFLEDBAL,
					MTM_VAMT = SUM(MTOM_LOSS)
			FROM	TBL_MTF_DATA M WITH (NOLOCK)
			WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
					--AND 1 = (CASE WHEN @MTM_FLAG = 1 THEN 1 ELSE 0 END)
			GROUP BY
					PARTY_CODE, MTFLEDBAL
			HAVING	(SUM(NETAMT) + MTFLEDBAL) > 0
			) A
	GROUP BY 
			PARTY_CODE	
	
	/*
	SELECT	CLTCODE,
			VAMT = SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END)
	INTO	#PAYIN
	FROM	LEDGER P(NOLOCK)
	WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
			AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
			AND P.VTYP <> '35'
			--AND P.EDT BETWEEN @EDT AND @EDT + ' 23:59:59'
	GROUP BY
			CLTCODE
	HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0

	UNION
			
	SELECT	PARTY_CODE, MTM_VAMT = -SUM(MTOM_LOSS)
	FROM	TBL_MTF_DATA M WITH (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
			AND 1 = (CASE WHEN @MTM_FLAG = 1 THEN 1 ELSE 0 END)
	GROUP BY
			PARTY_CODE
	HAVING	SUM(MTOM_LOSS) > 0
	*/

	--SELECT * FROM TBL_MTR_OPEN_BALANCE ORDER BY PARTY_CODE
	--SELECT * FROM #PAYIN  ORDER BY PARTY_CODE

	--RETURN


	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		PAYIN_AMT = ISNULL(P.VAMT,0),
			MTM_AMT	= ISNULL(P.MTM_VAMT,0)
	FROM	#PAYIN P(NOLOCK)
	WHERE	P.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE

	/*
	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		PAYIN_AMT = ISNULL(D.VAMT,0)
	FROM	(
			SELECT	PARTY_CODE,
					VAMT = SUM(VAMT)
			FROM	#PAYIN P(NOLOCK)
			GROUP BY
					PARTY_CODE
			HAVING	SUM(VAMT) > 0
			) D
	WHERE	D.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE


	UPDATE	TBL_MTR_OPEN_BALANCE 
	SET		PAYIN_AMT = ISNULL(D.MTM_VAMT,0)
	FROM	(
			SELECT	PARTY_CODE,
					MTM_VAMT = SUM(MTM_VAMT)
			FROM	#PAYIN P(NOLOCK)
			GROUP BY
					PARTY_CODE
			HAVING	SUM(MTM_VAMT) > 0
			) D
	WHERE	D.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE


	--UPDATE	TBL_MTR_OPEN_BALANCE 
	--SET		MTM_AMT = ISNULL(D.MTM_VAMT,0)
	--FROM	(
	--		SELECT	PARTY_CODE, MTM_VAMT = SUM(MTOM_LOSS)
	--		FROM	TBL_MTF_DATA M WITH (NOLOCK)
	--		WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	--		GROUP BY
	--				PARTY_CODE
	--		HAVING	SUM(MTOM_LOSS) > 0
	--		) D
	--WHERE	D.PARTY_CODE = TBL_MTR_OPEN_BALANCE.PARTY_CODE
	*/

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@PARTYCODE	VARCHAR(20),
			@PAYIN_AMT	NUMERIC(18,4),
			@MKTAMT		NUMERIC(18,4),
			@MARGIN_REQ	NUMERIC(18,4),
			@SNO		INT,
			@MAMT		NUMERIC(18,4),
			@SAUDA_DATE_PAYIN	DATETIME,
			@PRO_PER	NUMERIC(18,2)

	SET @ADJCUR = CURSOR FOR
		SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
				PRO_PER =  (
				CASE 
					WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
					ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
				END)
		FROM	TBL_MTR_OPEN_BALANCE
		WHERE	PAYIN_AMT > 0
		GROUP BY PARTY_CODE, SAUDA_DATE
		ORDER BY PARTY_CODE, SAUDA_DATE
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
	WHILE @@FETCH_STATUS = 0
	BEGIN 

		SET @DELCUR = CURSOR FOR
			SELECT SNO=SRNO, MKTAMT=BODVALUE, 
			MARGIN_REQ = (CASE WHEN @ALLOC_FLAG = 1 THEN (MARGIN_REQ*@PRO_PER/100) ELSE  MARGIN_REQ END)
			FROM TBL_MTR_OPEN_BALANCE
			WHERE SAUDA_DATE = @SAUDA_DATE_PAYIN 
			AND PARTY_CODE = @PARTYCODE
			AND BODVALUE > 0 AND MARGIN_REQ > 0
			ORDER BY PARTY_CODE, SRNO
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @PAYIN_AMT > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @ALLOC_FLAG = 1
				BEGIN
					SET		@MAMT = 0
				
					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		PAYIN_AMT_BAL = @MARGIN_REQ, 
							PRO_PER = @PRO_PER
					WHERE	SRNO = @SNO

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		M_PRICE = ROUND((BODVALUE/BODQTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		M_AMT = M_AMT + ROUND((M_PRICE*M_QTY),2),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - ROUND((M_PRICE*M_QTY),2),
							@MAMT = ROUND((M_PRICE*M_QTY),2)
					WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	TBL_MTR_OPEN_BALANCE 
					SET		NF_QTY = (BODQTY-M_QTY),
							NF_AMT = M_PRICE*(BODQTY-M_QTY)
					WHERE	SRNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

					--IF @PARTYCODE='500A3998'
					--BEGIN
					--	SELECT @MARGIN_REQ
					--	SELECT * FROM TBL_MTR_OPEN_BALANCE WHERE PARTY_CODE=@PARTYCODE
					--END

					--SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT
				END
				ELSE
				BEGIN				
					
					IF @PAYIN_AMT >= @MARGIN_REQ 
					--IF PRADNYA.DBO.FNMIN(@PAYIN_AMT,@MARGIN_REQ)
					BEGIN
				
						SET		@MAMT = 0
				
						UPDATE	TBL_MTR_OPEN_BALANCE SET PAYIN_AMT_BAL = @MARGIN_REQ
						WHERE	SRNO = @SNO

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_PRICE = ROUND((BODVALUE/BODQTY),4)--,
								--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_AMT = M_AMT + ROUND((M_PRICE*M_QTY),2),
								M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - ROUND((M_PRICE*M_QTY),2),
								@MAMT = ROUND((M_PRICE*M_QTY),2)
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		NF_QTY = (BODQTY-M_QTY),
								NF_AMT = M_PRICE*(BODQTY-M_QTY)
						WHERE	SRNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

						SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT

						--SELECT	SRNO = @SNO, PAYIN_AMT=@PAYIN_AMT, M_AMT = @MAMT, PAYIN_BALANCE = (@PAYIN_AMT - @MAMT)
						--SET @PAYIN_AMT = @PAYIN_AMT - @MARGIN_REQ

					END
					ELSE
					BEGIN

						UPDATE	TBL_MTR_OPEN_BALANCE SET PAYIN_AMT_BAL = @PAYIN_AMT
						WHERE	SRNO = @SNO

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_PRICE = ROUND((BODVALUE/BODQTY),4)--,
								--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		M_AMT = M_AMT + ROUND((M_PRICE*M_QTY),2),
								M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - ROUND((M_PRICE*M_QTY),2),
								@MAMT = ROUND((M_PRICE*M_QTY),2)
						WHERE	SRNO = @SNO AND PAYIN_AMT_BAL > 0

						UPDATE	TBL_MTR_OPEN_BALANCE 
						SET		NF_QTY = (BODQTY-M_QTY),
								NF_AMT = M_PRICE*(BODQTY-M_QTY)
						WHERE	SRNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0
				
						SET @PAYIN_AMT = 0

					END
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
		END
	
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR

	
	UPDATE	TBL_MTR_OPEN_BALANCE
	SET		COLL_QTY = M_QTY
	WHERE	M_QTY > 0

	IF @PROCESS_FLAG = 0
	BEGIN
		
		INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
		SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY=BODQTY,MKTAMT=BODVALUE,NETAMT=BODVALUE,
				SETT_NO=@SETTNO,PAYIN_DATE=@EDT,
				EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
				M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE, NF_QTY,NF_AMT,SELL_BUY=1,
				COLL_QTY,
				PROCESS_ON=GETDATE(), 
				PROCESS_BY='OPENBAL'
		FROM	TBL_MTR_OPEN_BALANCE 
		WHERE	M_QTY > 0

	--END
	--ELSE
	--BEGIN
	
		SELECT	PARTY_CODE, 
				PAYIN_AMT = MAX(PAYIN_AMT)+(CASE WHEN @MTM_FLAG = 1 THEN 0 ELSE MAX(MTM_AMT) END),
				M_AMT = SUM(M_AMT), 
				MTM_AMT = (
				CASE 
					WHEN @MTM_FLAG = 1 THEN MAX(MTM_AMT) 
					WHEN @MTM_FLAG = 2 THEN 
					(CASE WHEN MAX(MTM_AMT) > (MAX(PAYIN_AMT)-SUM(M_AMT)) THEN (MAX(PAYIN_AMT)-SUM(M_AMT)) ELSE MAX(MTM_AMT) END)
					ELSE 0 
				END),
				VNO = CONVERT(VARCHAR(12),''),
				ACNAME = CONVERT(VARCHAR(100),''),
				DRCR = 'D',
				GLCODE = @GLCODE,
				MARGIN_REQ = SUM(MARGIN_REQ),
				BAL_PAYIN_AMT = MAX(PAYIN_AMT)-SUM(MARGIN_REQ),
				MTM_AMT_JV = (CASE WHEN MAX(MTM_AMT) > (SUM(M_AMT)-SUM(MARGIN_REQ)) THEN (SUM(M_AMT)-SUM(MARGIN_REQ)) ELSE MAX(MTM_AMT) END)
		INTO	#MTR_OP_BAL_JV
		FROM	TBL_MTR_OPEN_BALANCE
		WHERE	M_QTY > 0
		GROUP BY PARTY_CODE
		ORDER BY PARTY_CODE


		SET		@RECCNT = 0
		SET		@VNO = ''

		ALTER TABLE #MTR_OP_BAL_JV
		ADD SNO	INT	IDENTITY(1,1)

		SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #MTR_OP_BAL_JV 
	
		IF @RECCNT > 0 
		BEGIN
		
			CREATE TABLE #VNO
			(
				VNO	VARCHAR(12)
			)

			INSERT	INTO #VNO 
			EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

			SELECT	@VNO = VNO FROM #VNO

			UPDATE	#MTR_OP_BAL_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
			UPDATE	#MTR_OP_BAL_JV SET ACNAME = A.LONGNAME 
			FROM	ACMAST A
			WHERE	#MTR_OP_BAL_JV.PARTY_CODE = A.CLTCODE

			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEGIN OPENING BALANCE JV FOR MTM ON DATE:%' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MTM_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEGIN OPENING BALANCE JV FOR MTM ON DATE:%' AND VTYP = '67'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MTM_AMT <> 0)
		
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%ONE TIME MAINT. MARGIN ALLOC FOR DATE:%' AND VTYP = '6'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND M_AMT <> 0)
			DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%ONE TIME MAINT. MARGIN ALLOC FOR DATE:%' AND VTYP = '66'
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #MTR_OP_BAL_JV WHERE #MTR_OP_BAL_JV.PARTY_CODE = LEDGER.CLTCODE AND M_AMT <> 0)

			/*--- COMMENTED ON DATE : 19/09/2025 [ FOLLOWING LOGIC IS FOR OPENING MTF CASH COLL LEDGER BASE ON MTF LEDGER CR ENTRY ] ------*/

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR='D', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=1, A.ACNAME, DRCR='C', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '02', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT > 0

	
			INSERT INTO LEDGER
			SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(MTM_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT > 0		


		
			INSERT INTO LEDGER
			SELECT '67', VNO, @EDT, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '67', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT <> 0		



			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE MTM_AMT > 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(MTM_AMT,2), @EDT, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEGIN OPENING BALANCE JV FOR MTM ON DATE:'+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND MTM_AMT > 0		

			---- ONE TIME OPENNING BALANCE AGAINST MAINTENANCE MARGIN ---



			---- ONE TIME OPENNING BALANCE AGAINST MAINTENANCE MARGIN ---

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE M_AMT > 0

			INSERT INTO LEDGER
			SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND M_AMT > 0


		
			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV
			WHERE M_AMT > 0

			INSERT INTO LEDGER
			SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(M_AMT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
			GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'ONE TIME MAINT. MARGIN ALLOC FOR DATE: '+ @SAUDA_DATE
			FROM #MTR_OP_BAL_JV J, ACMAST A
			WHERE J.GLCODE = A.CLTCODE
			AND M_AMT > 0


			DROP TABLE #MTR_OP_BAL_JV

		END

	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTFBILLPOST
-- --------------------------------------------------
  
  
-- EXEC PROC_MTFBILLPOST 'MAR 13 2019'  
  
CREATE PROC [dbo].[PROC_MTFBILLPOST]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
DECLARE   
  @GLCODE  VARCHAR(10),  
  @VNO  VARCHAR(12),  
  @NSECASHVNO  VARCHAR(12),  
  @BSECASHVNO  VARCHAR(12),  
  @SDTCUR  VARCHAR(11),  
  @LDTCUR  VARCHAR(11),  
  @PAYIN_DATE DATETIME,  
  @FROMDATE VARCHAR(11),  
  @CLEARINGCODE VARCHAR(10),  
  @SETT_NO  VARCHAR(7),  
  @SETT_TYPE  VARCHAR(2),
  @SETT_NO_T1		VARCHAR(7),
  @SETT_TYPE_T1	VARCHAR(2)  
  
SET @VNO = ''  
SET @CLEARINGCODE = ''  
SET @SETT_NO = ''  
SET @SETT_NO_T1 = ''  
  
SET @VNO = ''  
  
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR  
FROM PARAMETER WHERE @SAUDA_DATE BETWEEN @SDTCUR AND LDTCUR  
  
SELECT @PAYIN_DATE = @SAUDA_DATE-- MAX(SEC_PAYIN) FROM MSAJAG.DBO.SETT_MST WHERE START_DATE <= @SAUDA_DATE AND SETT_TYPE = 'N'  
  
-- EXEC PROC_MTFBILLPOST 'JUL 11 2017'  
   
SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING  
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  

SELECT DISTINCT ISIN, PAYIN_DATE INTO #PAY_SEC FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE = @SAUDA_DATE
AND SETT_NO <>'2000000'
AND SELL_BUY = 2

IF @CLEARINGCODE = 'NSCCL'
BEGIN
	SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE FROM MSAJAG.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'
	SELECT @SETT_NO_T1 = SETT_NO, @SETT_TYPE_T1 = SETT_TYPE FROM MSAJAG.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'M'
END
IF @CLEARINGCODE = 'ICCL'
BEGIN
	SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE FROM BSEDB.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'D'
	SELECT @SETT_NO_T1 = SETT_NO, @SETT_TYPE_T1 = SETT_TYPE FROM BSEDB.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'RD'
END
     
SELECT @GLCODE = ACCODE FROM VALANACCOUNT  
WHERE ACNAME =  'MTF VALAN'  
  
SELECT @VNO = ISNULL(MAX(VNO),'') FROM MTF_BILL_DETAIL  
WHERE BILLDATE = @SAUDA_DATE   
  
IF @VNO = ''  
BEGIN  
 CREATE TABLE #VNO  
 (  
  VNO VARCHAR(12)  
 )  
 INSERT INTO #VNO   
 EXEC ACC_GENVNO @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1  
  
 SELECT @VNO = VNO FROM #VNO  
   
 INSERT INTO MTF_BILL_DETAIL  
 SELECT @SAUDA_DATE, @VNO  
END  
ELSE  
BEGIN  
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = '35' AND BOOKTYPE = '01'    
END  
  
SELECT @NSECASHVNO = ISNULL(MAX(VNO),'') FROM ACCOUNT.DBO.MTF_BILL_DETAIL  
WHERE BILLDATE = @SAUDA_DATE   
  
IF @NSECASHVNO <> ''  
BEGIN  
 DELETE FROM ACCOUNT.DBO.LEDGER WHERE VNO = @NSECASHVNO AND VTYP = '35' AND BOOKTYPE = '01'    
END  
  
IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'  
BEGIN    
 IF @NSECASHVNO = ''  
 BEGIN  
  CREATE TABLE #NSECASHVNO  
  (  
   VNO VARCHAR(12)  
  )  
  INSERT INTO #NSECASHVNO   
  EXEC ACCOUNT.DBO.ACC_GENVNO_NEW @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1  
  
  SELECT @NSECASHVNO = VNO FROM #NSECASHVNO  
   
  INSERT INTO ACCOUNT.DBO.MTF_BILL_DETAIL  
  SELECT @SAUDA_DATE, @NSECASHVNO  
 END    
END  
   
SELECT *, MT_LIQUIDATE = 0, NEWSEC_PAYIN = @PAYIN_DATE  
INTO #MT_LIQUID   
FROM TBL_PRODUCT_POSITION P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE = @SAUDA_DATE   
  
CREATE CLUSTERED INDEX IDX_SNO ON #MT_LIQUID  
(   
 SNO  
)  
CREATE NONCLUSTERED INDEX IDX_PARTY ON #MT_LIQUID  
(   
 PARTY_CODE,  
 ISIN,  
 SAUDA_DATE  
)  
  
UPDATE #MT_LIQUID SET NEWSEC_PAYIN = P.PAYIN_DATE
FROM #PAY_SEC P 
WHERE #MT_LIQUID.ISIN = P.ISIN 
  
DECLARE @PARTY_CODE VARCHAR(10),  
  @ISIN  VARCHAR(12),  
  @QTY  INT,  
  @MTCUR  CURSOR,  
  @POSQTY  INT,  
  @POSCUR  CURSOR,  
  @POSDATE DATETIME,  
  @SNO  NUMERIC(18,0)  
  
SET @MTCUR = CURSOR FOR  
SELECT PARTY_CODE, ISIN, QTY = SUM(QTY) FROM TBL_PRODUCT_POSITION P1  
WHERE P1.SAUDA_DATE = @SAUDA_DATE   
AND P1.SELL_BUY = 2 AND P1.SETT_NO = '2000000'  
GROUP BY PARTY_CODE, ISIN  
ORDER BY PARTY_CODE, ISIN  
OPEN @MTCUR  
FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @POSCUR = CURSOR FOR  
 SELECT SNO, QTY, SAUDA_DATE FROM #MT_LIQUID  
 WHERE PARTY_CODE = @PARTY_CODE  
 AND ISIN = @ISIN  
 ORDER BY SAUDA_DATE   
 OPEN @POSCUR  
 FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  IF @POSQTY >= @QTY  
  BEGIN  
   UPDATE #MT_LIQUID SET MT_LIQUIDATE = @QTY   
   WHERE SNO = @SNO   
   SET @QTY = 0  
  END  
  ELSE  
  BEGIN  
   UPDATE #MT_LIQUID SET MT_LIQUIDATE = @POSQTY   
   WHERE SNO = @SNO   
   SET @QTY = @QTY - @POSQTY  
  END  
  IF @QTY <= 0   
  BEGIN  
   BREAK  
  END  
  FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE  
 END  
 CLOSE @POSCUR  
 DEALLOCATE @POSCUR  
 FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY  
END  
CLOSE @MTCUR  
DEALLOCATE @MTCUR  
  
SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END),   
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',  
PAYIN_DATE=(CASE WHEN PAYIN_DATE > NEWSEC_PAYIN THEN PAYIN_DATE ELSE NEWSEC_PAYIN END),VNO = @VNO  
INTO #BILL  
FROM #MT_LIQUID P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE = @SAUDA_DATE    
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > NEWSEC_PAYIN THEN PAYIN_DATE ELSE NEWSEC_PAYIN END)  
HAVING (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END) > 0   
   
INSERT INTO #BILL  
SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE SUM(NETAMT) END) ,   
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',  
PAYIN_DATE=(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END),VNO = @VNO  
FROM #MT_LIQUID P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE = @SAUDA_DATE  
AND MT_LIQUIDATE > 0   
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END)  
  
IF @CLEARINGCODE = ''  
BEGIN  
 INSERT INTO #BILL  
 SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),   
 NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',  
 PAYIN_DATE,VNO = @VNO  
 FROM TBL_PRODUCT_POSITION  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND SELL_BUY = 1 --AND SETT_NO <> '2000000'  
 GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE  
END  
ELSE  
BEGIN  
 INSERT INTO #BILL  
 SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),   
 NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',  
 PAYIN_DATE,VNO = @VNO  
 FROM TBL_PRODUCT_POSITION  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND SELL_BUY = 1 --AND SETT_NO <> '2000000'  
 AND Sett_Type IN ('N','D','C','W')
 GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE  

 INSERT INTO #BILL  
 SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),   
 NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO_T1 + '-' + LTRIM(RTRIM(@SETT_TYPE_T1)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',  
 PAYIN_DATE,VNO = @VNO  
 FROM TBL_PRODUCT_POSITION  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND SELL_BUY = 1 --AND SETT_NO <> '2000000'  
 AND Sett_Type NOT IN ('N','D','C','W')
 GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE  
END  
  
ALTER TABLE #BILL  
ADD SNO INT IDENTITY(1,1)  
  
UPDATE #BILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)  
  
INSERT INTO #BILL  
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), PAYIN_DATE, VNO  
FROM #BILL  
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR   
  
ALTER TABLE #BILL  
ADD ACNAME VARCHAR(200)   
  
UPDATE #BILL SET ACNAME = A.LONGNAME   
FROM ACMAST A  
WHERE #BILL.PARTY_CODE = A.CLTCODE  
  
INSERT INTO LEDGER  
SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION  
FROM #BILL  
  
IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'  
BEGIN   
 SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END),   
 NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',  
 PAYIN_DATE=(CASE WHEN PAYIN_DATE > NEWSEC_PAYIN THEN PAYIN_DATE ELSE NEWSEC_PAYIN END),VNO = @NSECASHVNO  
 INTO #NSECASHBILL  
 FROM #MT_LIQUID P  
 WHERE SAUDA_DATE <= @SAUDA_DATE  
 AND SELL_BUY = 1   
 AND ADJUST_DATE = @SAUDA_DATE   
 AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1   
              WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1  
           WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1  
           ELSE 2 END)  
 GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > NEWSEC_PAYIN THEN PAYIN_DATE ELSE NEWSEC_PAYIN END) 
 HAVING (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END) > 0   
  
 INSERT INTO #NSECASHBILL  
 SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE SUM(NETAMT) END),   
 NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',  
 PAYIN_DATE=(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END),VNO = @NSECASHVNO  
 FROM #MT_LIQUID P  
 WHERE SAUDA_DATE <= @SAUDA_DATE  
 AND SELL_BUY = 1   
 AND ADJUST_DATE = @SAUDA_DATE  
 AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1   
              WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1  
           WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1  
           ELSE 2 END)  
 AND MT_LIQUIDATE > 0   
 GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END)  
  
 IF @CLEARINGCODE = ''  
 BEGIN  
  INSERT INTO #NSECASHBILL  
  SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),   
  NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',  
  PAYIN_DATE,VNO = @NSECASHVNO  
  FROM TBL_PRODUCT_POSITION  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'  
  GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE  
 END  
 ELSE  
 BEGIN  
  INSERT INTO #NSECASHBILL  
  SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),   
  NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',  
  PAYIN_DATE,VNO = @NSECASHVNO  
  FROM TBL_PRODUCT_POSITION  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND SELL_BUY = 1 --AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'  
  AND Sett_Type IN ('N','D','C','W')
  GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE  

  INSERT INTO #NSECASHBILL  
  SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),   
  NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO_T1 + '-' + LTRIM(RTRIM(@SETT_TYPE_T1)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',  
  PAYIN_DATE,VNO = @NSECASHVNO  
  FROM TBL_PRODUCT_POSITION  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND SELL_BUY = 1 --AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'  
  AND Sett_Type NOT IN ('N','D','C','W')
  GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE  

 END  
  
 UPDATE #NSECASHBILL SET DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END)  
  
 ALTER TABLE #NSECASHBILL  
 ADD SNO INT IDENTITY(1,1)  
  
 UPDATE #NSECASHBILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)  
  
 INSERT INTO #NSECASHBILL  
 SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END),   
 PAYIN_DATE, VNO  
 FROM #NSECASHBILL  
 GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR   
  
 ALTER TABLE #NSECASHBILL  
 ADD ACNAME VARCHAR(200)   
  
 UPDATE #NSECASHBILL SET ACNAME = A.LONGNAME   
 FROM ACMAST A  
 WHERE #NSECASHBILL.PARTY_CODE = A.CLTCODE  
  
 INSERT INTO ACCOUNT.DBO.LEDGER  
 SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION  
 FROM #NSECASHBILL  
END  
   
SET @FROMDATE = LEFT(@SAUDA_DATE,3) + '  1 ' + CONVERT(VARCHAR,RIGHT(@SAUDA_DATE,4))  
  
--EXEC CBO_INT_COMPUTATION @DATEFROM = @FROMDATE, @DATETO = @SAUDA_DATE  , @UNAME = '', @FLAG = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTFBILLPOST_15072019
-- --------------------------------------------------



CREATE PROC [dbo].[PROC_MTFBILLPOST]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

DECLARE 
		@GLCODE		VARCHAR(10),
		@VNO		VARCHAR(12),
		@CASHVNO		VARCHAR(12),
		@SDTCUR		VARCHAR(11),
		@LDTCUR		VARCHAR(11),
		@PAYIN_DATE	DATETIME

SET @VNO = ''

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
FROM PARAMETER WHERE @SAUDA_DATE BETWEEN @SDTCUR AND LDTCUR

SELECT @PAYIN_DATE = MAX(SEC_PAYIN) FROM MSAJAG.DBO.SETT_MST WHERE START_DATE <= @SAUDA_DATE AND SETT_TYPE = 'N'

-- EXEC PROC_MTFBILLPOST 'JUL 11 2017'
 
SELECT @GLCODE = ACCODE FROM VALANACCOUNT
WHERE ACNAME =  'MTF VALAN'

SELECT @VNO = ISNULL(MAX(VNO),'') FROM MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @VNO = ''
BEGIN
	CREATE TABLE #VNO
	(
		VNO	VARCHAR(12)
	)
	INSERT INTO #VNO 
	EXEC ACC_GENVNO @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

	SELECT @VNO = VNO FROM #VNO
	
	INSERT INTO MTF_BILL_DETAIL
	SELECT @SAUDA_DATE, @VNO
END
ELSE
BEGIN
	DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

SELECT @CASHVNO = ISNULL(MAX(VNO),'') FROM ACCOUNT.DBO.MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @CASHVNO = ''
BEGIN
	CREATE TABLE #CASHVNO
	(
		VNO	VARCHAR(12)
	)
	INSERT INTO #CASHVNO 
	EXEC ACCOUNT.DBO.ACC_GENVNO_NEW @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

	SELECT @CASHVNO = VNO FROM #CASHVNO
	
	INSERT INTO ACCOUNT.DBO.MTF_BILL_DETAIL
	SELECT @SAUDA_DATE, @CASHVNO
END
ELSE
BEGIN
	DELETE FROM ACCOUNT.DBO.LEDGER WHERE VNO = @CASHVNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' bill Dated ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
PAYIN_DATE,VNO = @VNO
INTO #BILL
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE = @SAUDA_DATE
AND SELL_BUY = 1 
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE

INSERT INTO #BILL
SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), NARRATION = 'Reversed against sale of MTF shares dated ' + @SAUDA_DATE,DRCR = 'C',
PAYIN_DATE=@PAYIN_DATE,VNO = @VNO
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' bill Dated ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
PAYIN_DATE,VNO = @CASHVNO
INTO #CASHBILL
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE = @SAUDA_DATE
AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE'
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE

INSERT INTO #CASHBILL
SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), NARRATION = 'Reversed against sale of MTF shares dated ' + @SAUDA_DATE,DRCR = 'C',
PAYIN_DATE=@PAYIN_DATE,VNO = @CASHVNO
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE'
AND ADJUST_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE 
 
UPDATE #CASHBILL SET DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END)

ALTER TABLE #CASHBILL
ADD SNO INT IDENTITY(1,1)

ALTER TABLE #BILL
ADD SNO INT IDENTITY(1,1)

INSERT INTO #BILL
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), PAYIN_DATE, VNO
FROM #BILL
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

ALTER TABLE #BILL
ADD ACNAME VARCHAR(200) 

UPDATE #BILL SET ACNAME = A.LONGNAME 
FROM ACMAST A
WHERE #BILL.PARTY_CODE = A.CLTCODE

INSERT INTO LEDGER
SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
FROM #BILL


INSERT INTO #CASHBILL
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
PAYIN_DATE, VNO
FROM #CASHBILL
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

ALTER TABLE #CASHBILL
ADD ACNAME VARCHAR(200) 

UPDATE #CASHBILL SET ACNAME = A.LONGNAME 
FROM ACMAST A
WHERE #CASHBILL.PARTY_CODE = A.CLTCODE

INSERT INTO ACCOUNT.DBO.LEDGER
SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
FROM #CASHBILL

EXEC ANAND.ACCOUNT_AB.DBO.PROC_MTFBILLPOST @SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTFBILLPOST_bak_13012020
-- --------------------------------------------------

create PROC [dbo].[PROC_MTFBILLPOST_bak_13012020]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

DECLARE 
		@GLCODE		VARCHAR(10),
		@VNO		VARCHAR(12),
		@CASHVNO		VARCHAR(12),
		@SDTCUR		VARCHAR(11),
		@LDTCUR		VARCHAR(11),
		@PAYIN_DATE	DATETIME,
		@CLEARINGCODE	VARCHAR(10),
		@SETT_NO		VARCHAR(7),
		@SETT_TYPE		VARCHAR(2)

SET @VNO = ''
SET @CLEARINGCODE = ''
SET @SETT_NO = ''

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
FROM PARAMETER WHERE @SAUDA_DATE BETWEEN @SDTCUR AND LDTCUR

SELECT @PAYIN_DATE = MAX(SEC_PAYIN) FROM MSAJAG.DBO.SETT_MST WHERE START_DATE <= @SAUDA_DATE AND SETT_TYPE = 'N'

SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

IF @CLEARINGCODE = 'NSCCL'
BEGIN
	SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE FROM MSAJAG.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'
END
IF @CLEARINGCODE = 'ICCL'
BEGIN
	SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE FROM ANAND.BSEDB_AB.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'D'
END

-- EXEC PROC_MTFBILLPOST 'JUL 11 2017'
 
SELECT @GLCODE = ACCODE FROM VALANACCOUNT
WHERE ACNAME =  'MTF VALAN'

SELECT @VNO = ISNULL(MAX(VNO),'') FROM MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @VNO = ''
BEGIN
	CREATE TABLE #VNO
	(
		VNO	VARCHAR(12)
	)
	INSERT INTO #VNO 
	EXEC ACC_GENVNO @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

	SELECT @VNO = VNO FROM #VNO
	
	INSERT INTO MTF_BILL_DETAIL
	SELECT @SAUDA_DATE, @VNO
END
ELSE
BEGIN
	DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN 
	SELECT @CASHVNO = ISNULL(MAX(VNO),'') FROM ACCOUNT.DBO.MTF_BILL_DETAIL
	WHERE BILLDATE = @SAUDA_DATE 

	IF @CASHVNO = ''
	BEGIN
		CREATE TABLE #CASHVNO
		(
			VNO	VARCHAR(12)
		)
		INSERT INTO #CASHVNO 
		EXEC ACCOUNT.DBO.ACC_GENVNO_NEW @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

		SELECT @CASHVNO = VNO FROM #CASHVNO
	
		INSERT INTO ACCOUNT.DBO.MTF_BILL_DETAIL
		SELECT @SAUDA_DATE, @CASHVNO
	END
	ELSE
	BEGIN
		DELETE FROM ACCOUNT.DBO.LEDGER WHERE VNO = @CASHVNO AND VTYP = '35' AND BOOKTYPE = '01'  
	END
END

SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=@PAYIN_DATE,VNO = @VNO
INTO #BILL
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

IF @CLEARINGCODE = ''
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' bill Dated ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END
ELSE
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' bill Dated ' 
	          + LEFT(SAUDA_DATE,11)), DRCR = 'D',PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 
	GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN 
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' 
	       + @SAUDA_DATE),DRCR = 'C',PAYIN_DATE=@PAYIN_DATE,VNO = @CASHVNO
	INTO #CASHBILL
	FROM TBL_PRODUCT_POSITION P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	AND ADJUST_DATE = @SAUDA_DATE
	GROUP BY PARTY_CODE 
	
	IF @CLEARINGCODE = ''
	BEGIN
		INSERT INTO #CASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' bill Dated ' 
		          + LEFT(SAUDA_DATE,11)), DRCR = 'D',PAYIN_DATE,VNO = @CASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE'
		GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END
	ELSE
	BEGIN
		INSERT INTO #CASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' bill Dated ' 
		          + LEFT(SAUDA_DATE,11)), DRCR = 'D',PAYIN_DATE,VNO = @CASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1
		GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END

	UPDATE #CASHBILL SET DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END)

	ALTER TABLE #CASHBILL
	ADD SNO INT IDENTITY(1,1)
	
	INSERT INTO #CASHBILL
	SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
	PAYIN_DATE, VNO
	FROM #CASHBILL
	GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

	ALTER TABLE #CASHBILL
	ADD ACNAME VARCHAR(200) 

	UPDATE #CASHBILL SET ACNAME = A.LONGNAME 
	FROM ACMAST A
	WHERE #CASHBILL.PARTY_CODE = A.CLTCODE

	INSERT INTO ACCOUNT.DBO.LEDGER
	SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
	       PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
	FROM #CASHBILL
END

ALTER TABLE #BILL
ADD SNO INT IDENTITY(1,1)

INSERT INTO #BILL
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), PAYIN_DATE, VNO
FROM #BILL
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

ALTER TABLE #BILL
ADD ACNAME VARCHAR(200) 

UPDATE #BILL SET ACNAME = A.LONGNAME 
FROM ACMAST A
WHERE #BILL.PARTY_CODE = A.CLTCODE

INSERT INTO LEDGER
SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
       PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
FROM #BILL

EXEC ANAND.ACCOUNT_AB.DBO.PROC_MTFBILLPOST @SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTFBILLPOST_BAK_28112019
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MTFBILLPOST_BAK_28112019]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

DECLARE 
		@GLCODE		VARCHAR(10),
		@VNO		VARCHAR(12),
		@CASHVNO		VARCHAR(12),
		@SDTCUR		VARCHAR(11),
		@LDTCUR		VARCHAR(11),
		@PAYIN_DATE	DATETIME,
		@CLEARINGCODE	VARCHAR(10),
		@SETT_NO		VARCHAR(7),
		@SETT_TYPE		VARCHAR(2)

SET @VNO = ''
SET @CLEARINGCODE = ''
SET @SETT_NO = ''

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
FROM PARAMETER WHERE @SAUDA_DATE BETWEEN @SDTCUR AND LDTCUR

SELECT @PAYIN_DATE = MAX(SEC_PAYIN) FROM MSAJAG.DBO.SETT_MST WHERE START_DATE <= @SAUDA_DATE AND SETT_TYPE = 'N'

SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

IF @CLEARINGCODE = 'NSCCL'
BEGIN
	SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE FROM MSAJAG.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'
END
IF @CLEARINGCODE = 'ICCL'
BEGIN
	SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE FROM ANAND.BSEDB_AB.DBO.SETT_MST 
	WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'D'
END

-- EXEC PROC_MTFBILLPOST 'JUL 11 2017'
 
SELECT @GLCODE = ACCODE FROM VALANACCOUNT
WHERE ACNAME =  'MTF VALAN'

SELECT @VNO = ISNULL(MAX(VNO),'') FROM MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @VNO = ''
BEGIN
	CREATE TABLE #VNO
	(
		VNO	VARCHAR(12)
	)
	INSERT INTO #VNO 
	EXEC ACC_GENVNO @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

	SELECT @VNO = VNO FROM #VNO
	
	INSERT INTO MTF_BILL_DETAIL
	SELECT @SAUDA_DATE, @VNO
END
ELSE
BEGIN
	DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN 
	SELECT @CASHVNO = ISNULL(MAX(VNO),'') FROM ACCOUNT.DBO.MTF_BILL_DETAIL
	WHERE BILLDATE = @SAUDA_DATE 

	IF @CASHVNO = ''
	BEGIN
		CREATE TABLE #CASHVNO
		(
			VNO	VARCHAR(12)
		)
		INSERT INTO #CASHVNO 
		EXEC ACCOUNT.DBO.ACC_GENVNO_NEW @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

		SELECT @CASHVNO = VNO FROM #CASHVNO
	
		INSERT INTO ACCOUNT.DBO.MTF_BILL_DETAIL
		SELECT @SAUDA_DATE, @CASHVNO
	END
	ELSE
	BEGIN
		DELETE FROM ACCOUNT.DBO.LEDGER WHERE VNO = @CASHVNO AND VTYP = '35' AND BOOKTYPE = '01'  
	END
END

SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=@PAYIN_DATE,VNO = @VNO
INTO #BILL
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE

IF @CLEARINGCODE = ''
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' bill Dated ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END
ELSE
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' bill Dated ' 
	          + LEFT(SAUDA_DATE,11)), DRCR = 'D',PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 
	GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN 
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' 
	       + @SAUDA_DATE),DRCR = 'C',PAYIN_DATE=@PAYIN_DATE,VNO = @CASHVNO
	INTO #CASHBILL
	FROM TBL_PRODUCT_POSITION P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	AND ADJUST_DATE = @SAUDA_DATE
	GROUP BY PARTY_CODE 
	
	IF @CLEARINGCODE = ''
	BEGIN
		INSERT INTO #CASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' bill Dated ' 
		          + LEFT(SAUDA_DATE,11)), DRCR = 'D',PAYIN_DATE,VNO = @CASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE'
		GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END
	ELSE
	BEGIN
		INSERT INTO #CASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' bill Dated ' 
		          + LEFT(SAUDA_DATE,11)), DRCR = 'D',PAYIN_DATE,VNO = @CASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1
		GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END

	UPDATE #CASHBILL SET DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END)

	ALTER TABLE #CASHBILL
	ADD SNO INT IDENTITY(1,1)
	
	INSERT INTO #CASHBILL
	SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
	PAYIN_DATE, VNO
	FROM #CASHBILL
	GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

	ALTER TABLE #CASHBILL
	ADD ACNAME VARCHAR(200) 

	UPDATE #CASHBILL SET ACNAME = A.LONGNAME 
	FROM ACMAST A
	WHERE #CASHBILL.PARTY_CODE = A.CLTCODE

	INSERT INTO ACCOUNT.DBO.LEDGER
	SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
	       PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
	FROM #CASHBILL
END

ALTER TABLE #BILL
ADD SNO INT IDENTITY(1,1)

INSERT INTO #BILL
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), PAYIN_DATE, VNO
FROM #BILL
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

ALTER TABLE #BILL
ADD ACNAME VARCHAR(200) 

UPDATE #BILL SET ACNAME = A.LONGNAME 
FROM ACMAST A
WHERE #BILL.PARTY_CODE = A.CLTCODE

INSERT INTO LEDGER
SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
       PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
FROM #BILL

EXEC ANAND.ACCOUNT_AB.DBO.PROC_MTFBILLPOST @SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTFBILLPOST_BKUP_25Nov2022
-- --------------------------------------------------


-- EXEC PROC_MTFBILLPOST 'MAR 13 2019'

CREATE PROC [dbo].[PROC_MTFBILLPOST_BKUP_25Nov2022]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

DECLARE 
		@GLCODE		VARCHAR(10),
		@VNO		VARCHAR(12),
		@NSECASHVNO		VARCHAR(12),
		@BSECASHVNO		VARCHAR(12),
		@SDTCUR		VARCHAR(11),
		@LDTCUR		VARCHAR(11),
		@PAYIN_DATE	DATETIME,
		@FROMDATE	VARCHAR(11),
		@CLEARINGCODE	VARCHAR(10),
		@SETT_NO		VARCHAR(7),
		@SETT_TYPE		VARCHAR(2)

SET @VNO = ''
SET @CLEARINGCODE = ''
SET @SETT_NO = ''


SET @VNO = ''

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
FROM PARAMETER WHERE @SAUDA_DATE BETWEEN @SDTCUR AND LDTCUR

SELECT @PAYIN_DATE = @SAUDA_DATE-- MAX(SEC_PAYIN) FROM MSAJAG.DBO.SETT_MST WHERE START_DATE <= @SAUDA_DATE AND SETT_TYPE = 'N'

-- EXEC PROC_MTFBILLPOST 'JUL 11 2017'
 
SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
 
SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE,@PAYIN_DATE=Sec_Payin FROM MSAJAG.DBO.SETT_MST 
WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'
 

SELECT @GLCODE = ACCODE FROM VALANACCOUNT
WHERE ACNAME =  'MTF VALAN'

SELECT @VNO = ISNULL(MAX(VNO),'') FROM MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @VNO = ''
BEGIN
	CREATE TABLE #VNO
	(
		VNO	VARCHAR(12)
	)
	INSERT INTO #VNO 
	EXEC ACC_GENVNO @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

	SELECT @VNO = VNO FROM #VNO
	
	INSERT INTO MTF_BILL_DETAIL
	SELECT @SAUDA_DATE, @VNO
END
ELSE
BEGIN
	DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

SELECT @NSECASHVNO = ISNULL(MAX(VNO),'') FROM ACCOUNT.DBO.MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @NSECASHVNO <> ''
BEGIN
	DELETE FROM ACCOUNT.DBO.LEDGER WHERE VNO = @NSECASHVNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN  
	IF @NSECASHVNO = ''
	BEGIN
		CREATE TABLE #NSECASHVNO
		(
			VNO	VARCHAR(12)
		)
		INSERT INTO #NSECASHVNO 
		EXEC ACCOUNT.DBO.ACC_GENVNO_NEW @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

		SELECT @NSECASHVNO = VNO FROM #NSECASHVNO
	
		INSERT INTO ACCOUNT.DBO.MTF_BILL_DETAIL
		SELECT @SAUDA_DATE, @NSECASHVNO
	END  
END
 
SELECT *, MT_LIQUIDATE = 0
INTO #MT_LIQUID 
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE 

CREATE CLUSTERED INDEX IDX_SNO ON #MT_LIQUID
(	
	SNO
)
CREATE NONCLUSTERED INDEX IDX_PARTY ON #MT_LIQUID
(	
	PARTY_CODE,
	ISIN,
	SAUDA_DATE
)


DECLARE @PARTY_CODE VARCHAR(10),
		@ISIN		VARCHAR(12),
		@QTY		INT,
		@MTCUR		CURSOR,
		@POSQTY		INT,
		@POSCUR		CURSOR,
		@POSDATE	DATETIME,
		@SNO		NUMERIC(18,0)

SET @MTCUR = CURSOR FOR
SELECT PARTY_CODE, ISIN, QTY = SUM(QTY) FROM TBL_PRODUCT_POSITION P1
WHERE P1.SAUDA_DATE = @SAUDA_DATE	
AND P1.SELL_BUY = 2 AND P1.SETT_NO = '2000000'
GROUP BY PARTY_CODE, ISIN
ORDER BY PARTY_CODE, ISIN
OPEN @MTCUR
FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @POSCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE FROM #MT_LIQUID
	WHERE PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN
	ORDER BY SAUDA_DATE 
	OPEN @POSCUR
	FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF @POSQTY >= @QTY
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @QTY 
			WHERE SNO = @SNO 
			SET @QTY = 0
		END
		ELSE
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @POSQTY 
			WHERE SNO = @SNO 
			SET @QTY = @QTY - @POSQTY
		END
		IF @QTY <= 0 
		BEGIN
			BREAK
		END
		FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	END
	CLOSE @POSCUR
	DEALLOCATE @POSCUR
	FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
END
CLOSE @MTCUR
DEALLOCATE @MTCUR

SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END), 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END),VNO = @VNO
INTO #BILL
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END)
HAVING (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END) > 0 
 
INSERT INTO #BILL
SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE SUM(NETAMT) END) , 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END),VNO = @VNO
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
AND MT_LIQUIDATE > 0 
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END)

IF @CLEARINGCODE = ''
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 --AND SETT_NO <> '2000000'
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END
ELSE
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 --AND SETT_NO <> '2000000'
	GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END

ALTER TABLE #BILL
ADD SNO INT IDENTITY(1,1)

UPDATE #BILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)

INSERT INTO #BILL
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), PAYIN_DATE, VNO
FROM #BILL
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

ALTER TABLE #BILL
ADD ACNAME VARCHAR(200) 

UPDATE #BILL SET ACNAME = A.LONGNAME 
FROM ACMAST A
WHERE #BILL.PARTY_CODE = A.CLTCODE

INSERT INTO LEDGER
SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
FROM #BILL

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN 
	SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END), 
	NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
	PAYIN_DATE=(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END),VNO = @NSECASHVNO
	INTO #NSECASHBILL
	FROM #MT_LIQUID P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE = @SAUDA_DATE 
	AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END)
	HAVING (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END) > 0 

	INSERT INTO #NSECASHBILL
	SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE SUM(NETAMT) END), 
	NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
	PAYIN_DATE=(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END),VNO = @NSECASHVNO
	FROM #MT_LIQUID P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE = @SAUDA_DATE
	AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	AND MT_LIQUIDATE > 0 
	GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END)

	IF @CLEARINGCODE = ''
	BEGIN
		INSERT INTO #NSECASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
		PAYIN_DATE,VNO = @NSECASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'
		GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END
	ELSE
	BEGIN
		INSERT INTO #NSECASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
		PAYIN_DATE,VNO = @NSECASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1 --AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'
		GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END

	UPDATE #NSECASHBILL SET DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END)

	ALTER TABLE #NSECASHBILL
	ADD SNO INT IDENTITY(1,1)

	UPDATE #NSECASHBILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)

	INSERT INTO #NSECASHBILL
	SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
	PAYIN_DATE, VNO
	FROM #NSECASHBILL
	GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

	ALTER TABLE #NSECASHBILL
	ADD ACNAME VARCHAR(200) 

	UPDATE #NSECASHBILL SET ACNAME = A.LONGNAME 
	FROM ACMAST A
	WHERE #NSECASHBILL.PARTY_CODE = A.CLTCODE

	INSERT INTO ACCOUNT.DBO.LEDGER
	SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
	FROM #NSECASHBILL
END
 
SET @FROMDATE = LEFT(@SAUDA_DATE,3) + '  1 ' + CONVERT(VARCHAR,RIGHT(@SAUDA_DATE,4))

--EXEC CBO_INT_COMPUTATION @DATEFROM = @FROMDATE, @DATETO = @SAUDA_DATE  , @UNAME = '', @FLAG = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTFBILLPOST_TEST
-- --------------------------------------------------


-- EXEC PROC_MTFBILLPOST_TEST 'JAN  4 2022'

CREATE PROC [dbo].[PROC_MTFBILLPOST_TEST]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

DECLARE 
		@GLCODE		VARCHAR(10),
		@VNO		VARCHAR(12),
		@NSECASHVNO		VARCHAR(12),
		@BSECASHVNO		VARCHAR(12),
		@SDTCUR		VARCHAR(11),
		@LDTCUR		VARCHAR(11),
		@PAYIN_DATE	DATETIME,
		@FROMDATE	VARCHAR(11),
		@CLEARINGCODE	VARCHAR(10),
		@SETT_NO		VARCHAR(7),
		@SETT_TYPE		VARCHAR(2)

SET @VNO = ''
SET @CLEARINGCODE = ''
SET @SETT_NO = ''


SET @VNO = ''

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
FROM PARAMETER WHERE @SAUDA_DATE BETWEEN @SDTCUR AND LDTCUR

SELECT @PAYIN_DATE = @SAUDA_DATE

-- EXEC PROC_MTFBILLPOST 'JUL 11 2017'
 
SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
 
SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE,@PAYIN_DATE=Sec_Payin FROM MSAJAG.DBO.SETT_MST 
WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'
 
SELECT @GLCODE = ACCODE FROM VALANACCOUNT
WHERE ACNAME =  'MTF VALAN'

SELECT @VNO = ISNULL(MAX(VNO),'') FROM MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 
 
SELECT *, MT_LIQUIDATE = 0
INTO #MT_LIQUID 
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE 
AND PARTY_CODE IN ('SWPG1155','A140953')

CREATE CLUSTERED INDEX IDX_SNO ON #MT_LIQUID
(	
	SNO
)
CREATE NONCLUSTERED INDEX IDX_PARTY ON #MT_LIQUID
(	
	PARTY_CODE,
	ISIN,
	SAUDA_DATE
)


DECLARE @PARTY_CODE VARCHAR(10),
		@ISIN		VARCHAR(12),
		@QTY		INT,
		@MTCUR		CURSOR,
		@POSQTY		INT,
		@POSCUR		CURSOR,
		@POSDATE	DATETIME,
		@SNO		NUMERIC(18,0)

SET @MTCUR = CURSOR FOR
SELECT PARTY_CODE, ISIN, QTY = SUM(QTY) FROM TBL_PRODUCT_POSITION P1
WHERE P1.SAUDA_DATE = @SAUDA_DATE	
AND P1.SELL_BUY = 2 AND P1.SETT_NO = '2000000' AND PARTY_CODE IN ('SWPG1155','A140953')
GROUP BY PARTY_CODE, ISIN
ORDER BY PARTY_CODE, ISIN
OPEN @MTCUR
FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @POSCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE FROM #MT_LIQUID
	WHERE PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN
	ORDER BY SAUDA_DATE 
	OPEN @POSCUR
	FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF @POSQTY >= @QTY
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @QTY 
			WHERE SNO = @SNO 
			SET @QTY = 0
		END
		ELSE
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @POSQTY 
			WHERE SNO = @SNO 
			SET @QTY = @QTY - @POSQTY
		END
		IF @QTY <= 0 
		BEGIN
			BREAK
		END
		FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	END
	CLOSE @POSCUR
	DEALLOCATE @POSCUR
	FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
END
CLOSE @MTCUR
DEALLOCATE @MTCUR

SELECT *, @PAYIN_DATE, (CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN 1 ELSE 2 END) FROM #MT_LIQUID

SELECT * FROM #MT_LIQUID

SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END), 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END),VNO = @VNO
INTO #BILL
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END)
HAVING (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END) > 0 
 
INSERT INTO #BILL
SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE SUM(NETAMT) END) , 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END),VNO = @VNO
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
AND MT_LIQUIDATE > 0 
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END)

IF @CLEARINGCODE = ''
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE='SWPG1155'
	AND SELL_BUY = 1 --AND SETT_NO <> '2000000'
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END
ELSE
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE='SWPG1155'
	AND SELL_BUY = 1 --AND SETT_NO <> '2000000'
	GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END

ALTER TABLE #BILL
ADD SNO INT IDENTITY(1,1)

UPDATE #BILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)

INSERT INTO #BILL
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), PAYIN_DATE, VNO
FROM #BILL
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

ALTER TABLE #BILL
ADD ACNAME VARCHAR(200) 
 
IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN 
	SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END), 
	NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
	PAYIN_DATE=(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END),VNO = @NSECASHVNO
	INTO #NSECASHBILL
	FROM #MT_LIQUID P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE = @SAUDA_DATE 
	AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END)
	HAVING (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END) > 0 

	INSERT INTO #NSECASHBILL
	SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE SUM(NETAMT) END), 
	NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
	PAYIN_DATE=(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END),VNO = @NSECASHVNO
	FROM #MT_LIQUID P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE = @SAUDA_DATE
	AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	AND MT_LIQUIDATE > 0 
	GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @SAUDA_DATE THEN PAYIN_DATE ELSE @SAUDA_DATE END)

	IF @CLEARINGCODE = ''
	BEGIN
		INSERT INTO #NSECASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
		PAYIN_DATE,VNO = @NSECASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE='SWPG1155'
		AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'
		GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END
	ELSE
	BEGIN
		INSERT INTO #NSECASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
		PAYIN_DATE,VNO = @NSECASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE='SWPG1155'
		AND SELL_BUY = 1 --AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'
		GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END

	UPDATE #NSECASHBILL SET DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END)

	ALTER TABLE #NSECASHBILL
	ADD SNO INT IDENTITY(1,1)

	UPDATE #NSECASHBILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)

	INSERT INTO #NSECASHBILL
	SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
	PAYIN_DATE, VNO
	FROM #NSECASHBILL
	GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

	ALTER TABLE #NSECASHBILL
	ADD ACNAME VARCHAR(200) 
	 
	 
END


SELECT * FROM #BILL WHERE PARTY_CODE IN ('SWPG1155','A140953')
SELECT * FROM #NSECASHBILL WHERE PARTY_CODE IN ('SWPG1155','A140953')

SET @FROMDATE = LEFT(@SAUDA_DATE,3) + '  1 ' + CONVERT(VARCHAR,RIGHT(@SAUDA_DATE,4))

--EXEC CBO_INT_COMPUTATION @DATEFROM = @FROMDATE, @DATETO = @SAUDA_DATE  , @UNAME = '', @FLAG = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MTFBILLPOST_TOCHECK
-- --------------------------------------------------


-- EXEC PROC_MTFBILLPOST 'MAR 13 2019'

CREATE PROC [dbo].[PROC_MTFBILLPOST_TOCHECK]
(
	@SAUDA_DATE VARCHAR(11)
)
AS

DECLARE 
		@GLCODE		VARCHAR(10),
		@VNO		VARCHAR(12),
		@NSECASHVNO		VARCHAR(12),
		@BSECASHVNO		VARCHAR(12),
		@SDTCUR		VARCHAR(11),
		@LDTCUR		VARCHAR(11),
		@PAYIN_DATE	DATETIME,
		@FROMDATE	VARCHAR(11),
		@CLEARINGCODE	VARCHAR(10),
		@SETT_NO		VARCHAR(7),
		@SETT_TYPE		VARCHAR(2)

SET @VNO = ''
SET @CLEARINGCODE = ''
SET @SETT_NO = ''


SET @VNO = ''

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
FROM PARAMETER WHERE @SAUDA_DATE BETWEEN @SDTCUR AND LDTCUR

SELECT @PAYIN_DATE = MAX(SEC_PAYIN) FROM MSAJAG.DBO.SETT_MST WHERE START_DATE <= @SAUDA_DATE AND SETT_TYPE = 'N'

-- EXEC PROC_MTFBILLPOST 'JUL 11 2017'
 
SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM MSAJAG.DBO.TBL_INTEROP_SETTING
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
 
SELECT @SETT_NO = SETT_NO, @SETT_TYPE = SETT_TYPE FROM MSAJAG.DBO.SETT_MST 
WHERE START_DATE = @SAUDA_DATE AND SETT_TYPE = 'N'
 

SELECT @GLCODE = ACCODE FROM VALANACCOUNT
WHERE ACNAME =  'MTF VALAN'

SELECT @VNO = ISNULL(MAX(VNO),'') FROM MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @VNO = ''
BEGIN
	CREATE TABLE #VNO
	(
		VNO	VARCHAR(12)
	)
	INSERT INTO #VNO 
	EXEC ACC_GENVNO @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

	SELECT @VNO = VNO FROM #VNO
	
	INSERT INTO MTF_BILL_DETAIL
	SELECT @SAUDA_DATE, @VNO
END
ELSE
BEGIN
	DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

SELECT @NSECASHVNO = ISNULL(MAX(VNO),'') FROM ACCOUNT.DBO.MTF_BILL_DETAIL
WHERE BILLDATE = @SAUDA_DATE 

IF @NSECASHVNO <> ''
BEGIN
	DELETE FROM ACCOUNT.DBO.LEDGER WHERE VNO = @NSECASHVNO AND VTYP = '35' AND BOOKTYPE = '01'  
END

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN  
	IF @NSECASHVNO = ''
	BEGIN
		CREATE TABLE #NSECASHVNO
		(
			VNO	VARCHAR(12)
		)
		INSERT INTO #NSECASHVNO 
		EXEC ACCOUNT.DBO.ACC_GENVNO_NEW @SAUDA_DATE, 35, '01', @SDTCUR, @LDTCUR, 1

		SELECT @NSECASHVNO = VNO FROM #NSECASHVNO
	
		INSERT INTO ACCOUNT.DBO.MTF_BILL_DETAIL
		SELECT @SAUDA_DATE, @NSECASHVNO
	END  
END
 
SELECT *, MT_LIQUIDATE = 0
INTO #MT_LIQUID 
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE 

DECLARE @PARTY_CODE VARCHAR(10),
		@ISIN		VARCHAR(12),
		@QTY		INT,
		@MTCUR		CURSOR,
		@POSQTY		INT,
		@POSCUR		CURSOR,
		@POSDATE	DATETIME,
		@SNO		NUMERIC(18,0)

SET @MTCUR = CURSOR FOR
SELECT PARTY_CODE, ISIN, QTY = SUM(QTY) FROM TBL_PRODUCT_POSITION P1
WHERE P1.SAUDA_DATE = @SAUDA_DATE	
AND P1.SELL_BUY = 2 AND P1.SETT_NO = '2000000'
GROUP BY PARTY_CODE, ISIN
ORDER BY PARTY_CODE, ISIN
OPEN @MTCUR
FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @POSCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE FROM #MT_LIQUID
	WHERE PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN
	ORDER BY SAUDA_DATE 
	OPEN @POSCUR
	FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF @POSQTY >= @QTY
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @QTY 
			WHERE SNO = @SNO 
			SET @QTY = 0
		END
		ELSE
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @POSQTY 
			WHERE SNO = @SNO 
			SET @QTY = @QTY - @POSQTY
		END
		IF @QTY <= 0 
		BEGIN
			BREAK
		END
		FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	END
	CLOSE @POSCUR
	DEALLOCATE @POSCUR
	FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
END
CLOSE @MTCUR
DEALLOCATE @MTCUR

SELECT PARTY_CODE, AMOUNT = SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE), 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=@PAYIN_DATE,VNO = @VNO
INTO #BILL
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE
HAVING SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) > 0 

INSERT INTO #BILL
SELECT PARTY_CODE, AMOUNT = SUM((NETAMT/QTY)*MT_LIQUIDATE), 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=@SAUDA_DATE,VNO = @VNO
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
AND MT_LIQUIDATE > 0 
GROUP BY PARTY_CODE

IF @CLEARINGCODE = ''
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 --AND SETT_NO <> '2000000'
	GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END
ELSE
BEGIN
	INSERT INTO #BILL
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
	NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
	PAYIN_DATE,VNO = @VNO
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 1 --AND SETT_NO <> '2000000'
	GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
END

ALTER TABLE #BILL
ADD SNO INT IDENTITY(1,1)

UPDATE #BILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)

INSERT INTO #BILL
SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), PAYIN_DATE, VNO
FROM #BILL
GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

ALTER TABLE #BILL
ADD ACNAME VARCHAR(200) 

UPDATE #BILL SET ACNAME = A.LONGNAME 
FROM ACMAST A
WHERE #BILL.PARTY_CODE = A.CLTCODE

INSERT INTO LEDGER
SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
FROM #BILL

IF @CLEARINGCODE = '' OR @CLEARINGCODE = 'NSCCL'
BEGIN 
	SELECT PARTY_CODE, AMOUNT = SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE), 
	NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
	PAYIN_DATE=@PAYIN_DATE,VNO = @NSECASHVNO
	INTO #NSECASHBILL
	FROM #MT_LIQUID P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE = @SAUDA_DATE 
	AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	GROUP BY PARTY_CODE
	HAVING SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) > 0 

	INSERT INTO #NSECASHBILL
	SELECT PARTY_CODE, AMOUNT = SUM((NETAMT/QTY)*MT_LIQUIDATE), 
	NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
	PAYIN_DATE=@SAUDA_DATE,VNO = @NSECASHVNO
	FROM #MT_LIQUID P
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1 
	AND ADJUST_DATE = @SAUDA_DATE
	AND 1 = (CASE WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRNSE' THEN 1 
							       WHEN @CLEARINGCODE = 'NSCCL' AND TRANSTYPE = 'TRBSE' THEN 1
								   WHEN @CLEARINGCODE = '' AND TRANSTYPE = 'TRNSE' THEN 1
								   ELSE 2 END)
	AND MT_LIQUIDATE > 0 
	GROUP BY PARTY_CODE

	IF @CLEARINGCODE = ''
	BEGIN
		INSERT INTO #NSECASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + SETT_NO + '-' + LTRIM(RTRIM(SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
		PAYIN_DATE,VNO = @NSECASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1 AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'
		GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END
	ELSE
	BEGIN
		INSERT INTO #NSECASHBILL
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT), 
		NARRATION = CONVERT(VARCHAR(100),'Transferred to MTF for ' + @SETT_NO + '-' + LTRIM(RTRIM(@SETT_TYPE)) + ' BILL DATE ' + LEFT(SAUDA_DATE,11)), DRCR = 'D',
		PAYIN_DATE,VNO = @NSECASHVNO
		FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND SELL_BUY = 1 --AND TRANSTYPE = 'TRNSE' --AND SETT_NO <> '2000000'
		GROUP BY PARTY_CODE, SAUDA_DATE,PAYIN_DATE
	END

	UPDATE #NSECASHBILL SET DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END)

	ALTER TABLE #NSECASHBILL
	ADD SNO INT IDENTITY(1,1)

	UPDATE #NSECASHBILL SET AMOUNT = CONVERT(NUMERIC(18,2),AMOUNT)

	INSERT INTO #NSECASHBILL
	SELECT @GLCODE, AMOUNT = SUM(AMOUNT), NARRATION, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
	PAYIN_DATE, VNO
	FROM #NSECASHBILL
	GROUP BY NARRATION, PAYIN_DATE, VNO, DRCR 

	ALTER TABLE #NSECASHBILL
	ADD ACNAME VARCHAR(200) 

	UPDATE #NSECASHBILL SET ACNAME = A.LONGNAME 
	FROM ACMAST A
	WHERE #NSECASHBILL.PARTY_CODE = A.CLTCODE

	INSERT INTO ACCOUNT.DBO.LEDGER
	SELECT '35', VNO, PAYIN_DATE, SNO, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION
	FROM #NSECASHBILL
END
 
SET @FROMDATE = LEFT(@SAUDA_DATE,3) + '  1 ' + CONVERT(VARCHAR,RIGHT(@SAUDA_DATE,4))

--EXEC CBO_INT_COMPUTATION @DATEFROM = @FROMDATE, @DATETO = @SAUDA_DATE  , @UNAME = '', @FLAG = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_ADJUST_IMPORT
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_PRODUCT_ADJUST_IMPORT] 
(
	@TDATE		VARCHAR(10), 
	@FILEFOR	VARCHAR(20), 
	@FILETYPE	VARCHAR(50), 
	@PROGID		VARCHAR(50), 
	@UNAME		VARCHAR(50),
	@FILENAME	VARCHAR(100) = '')
AS

-- EXEC PROC_PRODUCT_ADJUST_IMPORT '01/12/2016', '', '', '1234567890', ''

DECLARE @FILEDATE	VARCHAR(11),
		@TOTAMT		NUMERIC(18,4),
		@RECCNT		INT,
		@SUMTOTAMT		NUMERIC(18,4),
		@SUMRECCNT		INT

/*
SELECT @FILEDATE = LEFT(RIGHT(@FILENAME,12),8)

IF @FILEDATE <> REPLACE(@TDATE,'/','')
BEGIN 
	SELECT strMsgCode = -1, strMsg = 'INVALID FILE OR SELECTED DATE IS NOT MATCHING WITH THE DATE PRESENT IN THE HEADER RECORD.'
	RETURN
END

IF CONVERT(DATETIME,@TDATE,103) < CONVERT(DATETIME,LEFT(GETDATE(),11))
BEGIN 
	SELECT strMsgCode = -1, strMsg = 'BACKDATED FILE IMPORT IS NOT ALLOWED'
	RETURN
END

IF CONVERT(DATETIME,@TDATE,103) > CONVERT(DATETIME,LEFT(GETDATE(),11))
BEGIN 
	SELECT strMsgCode = -1, strMsg = 'FUTURE DATED FILE IMPORT IS NOT ALLOWED'
	RETURN
END
*/

SELECT * INTO #TBL_PRODUCT_POS_ADJUST FROM TBL_PRODUCT_POS_ADJUST
WHERE 1 = 2 

INSERT INTO #TBL_PRODUCT_POS_ADJUST
SELECT CONVERT(DATETIME,@TDATE,103), SETT_NO = '2000000', SETT_TYPE = 'N', 
PARTY_CODE = .DBO.PIECE(FILE_DATA,',',1), 
SCRIP_CD = ISNULL(.DBO.PIECE(FILE_DATA,',',2), ''),
SERIES = ISNULL(.DBO.PIECE(FILE_DATA,',',3), ''),
BSECODE = ISNULL(.DBO.PIECE(FILE_DATA,',',4),''),
ISIN = .DBO.PIECE(FILE_DATA,',',5), 
QTY = cONVERT(NUMERIC(18,0),.DBO.PIECE(FILE_DATA,',',6)),
TRANSTYPE = 'TRNSE', AADED_BY = @UNAME, ADDED_ON = GETDATE()
FROM FILEDATA
WHERE PROGID = @PROGID
AND .DBO.PIECE(FILE_DATA,',',5) LIKE 'IN%'
/*
UPDATE #TBL_PRODUCT_POS_ADJUST SET ISIN = M.ISIN 
FROM BSEDB.DBO.MULTIISIN M
WHERE M.SCRIP_CD = #TBL_PRODUCT_POS_ADJUST.BSECODE
AND VALID = 1 
AND #TBL_PRODUCT_POS_ADJUST.BSECODE <> ''
AND #TBL_PRODUCT_POS_ADJUST.ISIN = ''

UPDATE #TBL_PRODUCT_POS_ADJUST SET ISIN = M.ISIN 
FROM MSAJAG.DBO.MULTIISIN M
WHERE M.SCRIP_CD = #TBL_PRODUCT_POS_ADJUST.SCRIP_CD
AND M.Series = #TBL_PRODUCT_POS_ADJUST.SERIES
AND VALID = 1 
AND #TBL_PRODUCT_POS_ADJUST.SCRIP_CD <> ''
*/

DELETE FROM #TBL_PRODUCT_POS_ADJUST
WHERE ISIN = ''

--DELETE FROM #TBL_PRODUCT_POS_ADJUST
--WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN)

SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #TBL_PRODUCT_POS_ADJUST  

INSERT INTO TBL_PRODUCT_POS_ADJUST
SELECT * FROM #TBL_PRODUCT_POS_ADJUST

DELETE FROM FILEDATA
WHERE PROGID = @PROGID

SELECT strMsgCode = 1, strMsg = 'FILE UPLOADED SUCCESSFULLY WITH NO OF RECORDS AS ' 
                              +  CONVERT(VARCHAR,@RECCNT)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST
-- --------------------------------------------------




-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON
	
	---Select * from TBL_MTF_MULTIPLIER

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE <= @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	DECLARE  @PREV_DATE_NEW varchar(11)
   

IF (CONVERT(DATETIME,@SAUDA_DATE,109) >= 'JUN 30 2025')

BEGIN
              SET @PREV_DATE_NEW = @SAUDA_DATE
END
         ELSE
BEGIN
              SET @PREV_DATE_NEW = @PREV_DATE
END


	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM AngelBSECM.BSEDB_AB.DBO.DELIVERYCLT D, AngelBSECM.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  AngelBSECM.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE_NEW  aND c.REcDATE <= @PREV_DATE_NEW  + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE_NEW  aND v.FDATE <= @PREV_DATE_NEW  + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
 
	
    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1  AND HAIRCUT < 25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
    FROM   #B_TBLSCRIPMARGIN T 
    WHERE  #B_MTF_DATA.ISIN = T.ISIN AND FOFLAG=1
	AND    HAIRCUT <> 0


	--UPDATE  #B_MTF_DATA SET  HAIRCUT = (CASE WHEN FOFLAG = 1 AND HAIRCUT <25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
	--WHERE HAIRCUT <> 0

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	
	
	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE #B_MTF_DATA 
    SET    HAIRCUT = F.VARMARGIN
	FROM MTF_ANGEL_Varmargin F
	WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date
	AND #B_MTF_DATA.ISIN = F.ISIN 
	AND HAIRCUT < F.VARMARGIN

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	/* 100% var Margin Change Start */   /*Changes Done by Siva K and Ganesh J 07032024*/
	UPDATE TBL_PRODUCT_HOLD_DATA
	SET    MTFHAIRCUT = 100,
		   HAIRCUT = 100
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE TBL_PRODUCT_HOLD_DATA.ISIN=T.ISIN)
	  UPDATE #B_MTF_DATA
    SET    HAIRCUT = 100
    WHERE
	 NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE #B_MTF_DATA.ISIN=T.ISIN)
	 	/* 100% var Margin Change End */


	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	--WHERE HAIRCUT <> 100

	--/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN MTOM_LOSS < 0 THEN 0 ELSE MTOM_LOSS END)
	--FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	--FROM #B_MTF_DATA 
	--GROUP BY PARTY_CODE) A
	--WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	--*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/

	CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT >=GETDATE()-10
	       AND L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_BAK_20122024
-- --------------------------------------------------



-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_BAK_20122024] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON
	
	---Select * from TBL_MTF_MULTIPLIER

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE <= @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM AngelBSECM.BSEDB_AB.DBO.DELIVERYCLT D, AngelBSECM.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  AngelBSECM.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE aND c.REcDATE <= @PREV_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE aND v.FDATE <= @PREV_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
 
	
    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1  AND HAIRCUT < 25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
    FROM   #B_TBLSCRIPMARGIN T 
    WHERE  #B_MTF_DATA.ISIN = T.ISIN AND FOFLAG=1
	AND    HAIRCUT <> 0


	--UPDATE  #B_MTF_DATA SET  HAIRCUT = (CASE WHEN FOFLAG = 1 AND HAIRCUT <25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
	--WHERE HAIRCUT <> 0

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	
	
	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE #B_MTF_DATA 
    SET    HAIRCUT = F.VARMARGIN
	FROM MTF_ANGEL_Varmargin F
	WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date
	AND #B_MTF_DATA.ISIN = F.ISIN 
	AND HAIRCUT < F.VARMARGIN

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	/* 100% var Margin Change Start */   /*Changes Done by Siva K and Ganesh J 07032024*/
	UPDATE TBL_PRODUCT_HOLD_DATA
	SET    MTFHAIRCUT = 100,
		   HAIRCUT = 100
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE TBL_PRODUCT_HOLD_DATA.ISIN=T.ISIN)
	  UPDATE #B_MTF_DATA
    SET    HAIRCUT = 100
    WHERE
	 NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE #B_MTF_DATA.ISIN=T.ISIN)
	 	/* 100% var Margin Change End */


	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	WHERE HAIRCUT <> 100

	/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN A.MTOM_LOSS < 0 THEN 0 ELSE #B_MTF_DATA.MTOM_LOSS END)
	FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	FROM #B_MTF_DATA 
	GROUP BY PARTY_CODE) A
	WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/

	CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT >=GETDATE()-10
	       AND L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_Bak_25102024
-- --------------------------------------------------



-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_Bak_25102024] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON
	
	Select * from TBL_MTF_MULTIPLIER

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE <= @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM AngelBSECM.BSEDB_AB.DBO.DELIVERYCLT D, AngelBSECM.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  AngelBSECM.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE aND c.REcDATE <= @PREV_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE aND v.FDATE <= @PREV_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
 
	
 --   UPDATE #B_MTF_DATA 
 --   SET    HAIRCUT = (CASE WHEN FOFLAG = 1  AND HAIRCUT < 25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
 --   FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
 --   WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	--AND    M.ISIN = T.ISIN
	--AND    HAIRCUT = 0


	--UPDATE  #B_MTF_DATA SET  HAIRCUT = (CASE WHEN FOFLAG = 1 AND HAIRCUT <25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
	--WHERE HAIRCUT <> 0

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	
	
	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE #B_MTF_DATA 
    SET    HAIRCUT = F.VARMARGIN
	FROM MTF_ANGEL_Varmargin F
	WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date
	AND #B_MTF_DATA.ISIN = F.ISIN 
	AND HAIRCUT < F.VARMARGIN

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	/* 100% var Margin Change Start */   /*Changes Done by Siva K and Ganesh J 07032024*/
	UPDATE TBL_PRODUCT_HOLD_DATA
	SET    MTFHAIRCUT = 100,
		   HAIRCUT = 100
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE TBL_PRODUCT_HOLD_DATA.ISIN=T.ISIN)
	  UPDATE #B_MTF_DATA
    SET    HAIRCUT = 100
    WHERE
	 NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE #B_MTF_DATA.ISIN=T.ISIN)
	 	/* 100% var Margin Change End */


	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	WHERE HAIRCUT <> 100

	/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN A.MTOM_LOSS < 0 THEN 0 ELSE #B_MTF_DATA.MTOM_LOSS END)
	FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	FROM #B_MTF_DATA 
	GROUP BY PARTY_CODE) A
	WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/

	CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT >=GETDATE()-10
	       AND L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_BAK_25112020
-- --------------------------------------------------


-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
Create  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_BAK_25112020] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON 

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE < @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM ANAND.BSEDB_AB.DBO.DELIVERYCLT D, ANAND.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  ANAND.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE aND c.REcDATE <= @PREV_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM ANAND.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE aND v.FDATE <= @PREV_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	WHERE HAIRCUT <> 100
	/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN A.MTOM_LOSS < 0 THEN 0 ELSE #B_MTF_DATA.MTOM_LOSS END)
	FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	FROM #B_MTF_DATA 
	GROUP BY PARTY_CODE) A
	WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    ANAND.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   ANAND.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_bak_nov282019
-- --------------------------------------------------



-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE PROC [dbo].[PROC_PRODUCT_BUY_ADJUST] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT

	SET NOCOUNT ON 

	SELECT @NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE


	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE  LEFT(SAUDA_DATE, 11) <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT @AMOUNT, @SNO, @ISIN, @QTY, @NETAMT
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM ANAND.BSEDB_AB.DBO.DELIVERYCLT D, ANAND.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE

	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))

	--IF @SAUDA_DATE = LEFT(GETDATE(),11) 
	IF 1=1
	BEGIN
		EXEC EDP_DP_BALANCE_UPDATE_NEW

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
	END

	SELECT SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
	ORGQTY, HOLDFLAG, CL_RATE, HAIRCUT, FOGFLAG, MTFHAIRCUT
	INTO #TBL_PRODUCT_HOLD_DATA
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO #TBL_PRODUCT_HOLD_DATA
	SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
	ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
	FROM #B_BTSTMTF
	WHERE QTY > 0
	
	CREATE CLUSTERED INDEX IDX_HLD ON #TBL_PRODUCT_HOLD_DATA
	(
		SAUDA_DATE,
		PARTY_CODE,
		ISIN
	)

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE #TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE #TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE #TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE #TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1



	
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM #TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY, 
           MKTAMT, 
           NETAMT, 
           CL_RATE, 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0),
		   ORGSAUDA_DATE = SAUDA_DATE 
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   MSAJAG.DBO.CLOSING C 
    WHERE  SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   MSAJAG.DBO.CLOSING C 
    WHERE  SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   ANAND.BSEDB_AB.DBO.CLOSING C 
    WHERE  SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @SAUDA_DATE  AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  ANAND.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @SAUDA_DATE AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
	
	
	
	
	UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND #TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE #TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND #B_TBLSCRIPMARGIN.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL C
	WHERE C.RECDATE between  @SAUDA_DATE and @SAUDA_DATE + ' 23:59:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM ANAND.BSEDB_AB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM ANAND.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE = @SAUDA_DATE

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )



	
    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
	IF CONVERT(DATETIME,@SAUDA_DATE) > CONVERT(DATETIME,'AUG 10 2017') 
	BEGIN
		UPDATE #B_MTF_DATA 
		SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELM ELSE M.MARGIN + 5 * ELM END)
		FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
		WHERE  M.ISIN = #B_MTF_DATA.ISIN 
		AND    M.ISIN = T.ISIN
		AND    HAIRCUT = 0
	END
	ELSE
	BEGIN
	    UPDATE #B_MTF_DATA 
		SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELM ELSE M.MARGIN + 5 * ELM END)
		FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
		WHERE  M.ISIN = #B_MTF_DATA.ISIN 
		AND    M.ISIN = T.ISIN
		AND    HAIRCUT = 0
	END
	
    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    M.ISIN = T.ISIN
	
    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN

    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	AND    M.ISIN = T.ISIN
		
    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  (HAIRCUT = 0 OR HAIRCUT > 100)

	UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = 100
    WHERE SAUDA_DATE = @SAUDA_DATE
    AND (MTFHAIRCUT = 0 OR MTFHAIRCUT > 100)
    
	UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100
    WHERE SAUDA_DATE = @SAUDA_DATE
    AND (HAIRCUT = 0 OR HAIRCUT > 100)
    
    UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = MKTAMT * HAIRCUT / 100 

    UPDATE #B_MTF_DATA 
    SET    MTOM_LOSS = -(( MKTAMT / QTY - CURR_CL_RATE ) * QTY) 
    WHERE  QTY > 0 AND CURR_CL_RATE > 0 AND MKTAMT > 0 AND HAIRCUT <> 100
    
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM #TBL_PRODUCT_HOLD_DATA WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)
    GROUP  BY L.CLTCODE 
	
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   ANAND.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM #B_MTF_DATA
		WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)
    GROUP  BY L.CLTCODE 
    
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'CMCOLL'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'FOCOLL'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'MTFCOLL'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG = 'POA'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG = 'BEN'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA

	DELETE FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_PRODUCT_HOLD_DATA
	SELECT SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
	ORGQTY, HOLDFLAG, CL_RATE, HAIRCUT, FOGFLAG, MTFHAIRCUT 
	FROM #TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_BKP_12MAR2024_SRE-23325
-- --------------------------------------------------


-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_BKP_12MAR2024_SRE-23325] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON 

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE < @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM AngelBSECM.BSEDB_AB.DBO.DELIVERYCLT D, AngelBSECM.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  AngelBSECM.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE aND c.REcDATE <= @PREV_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE aND v.FDATE <= @PREV_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE #B_MTF_DATA 
    SET    HAIRCUT = F.VARMARGIN
	FROM MTF_ANGEL_Varmargin F
	WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date
	AND #B_MTF_DATA.ISIN = F.ISIN 
	AND HAIRCUT < F.VARMARGIN

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	WHERE HAIRCUT <> 100

	/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN A.MTOM_LOSS < 0 THEN 0 ELSE #B_MTF_DATA.MTOM_LOSS END)
	FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	FROM #B_MTF_DATA 
	GROUP BY PARTY_CODE) A
	WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/

	CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT >=GETDATE()-10
	       AND L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_BKUP_14JAN2025
-- --------------------------------------------------



-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_BKUP_14JAN2025] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON
	
	---Select * from TBL_MTF_MULTIPLIER

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE <= @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM AngelBSECM.BSEDB_AB.DBO.DELIVERYCLT D, AngelBSECM.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  AngelBSECM.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE aND c.REcDATE <= @PREV_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE aND v.FDATE <= @PREV_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
 
	
    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1  AND HAIRCUT < 25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
    FROM   #B_TBLSCRIPMARGIN T 
    WHERE  #B_MTF_DATA.ISIN = T.ISIN AND FOFLAG=1
	AND    HAIRCUT <> 0


	--UPDATE  #B_MTF_DATA SET  HAIRCUT = (CASE WHEN FOFLAG = 1 AND HAIRCUT <25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
	--WHERE HAIRCUT <> 0

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	
	
	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE #B_MTF_DATA 
    SET    HAIRCUT = F.VARMARGIN
	FROM MTF_ANGEL_Varmargin F
	WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date
	AND #B_MTF_DATA.ISIN = F.ISIN 
	AND HAIRCUT < F.VARMARGIN

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	/* 100% var Margin Change Start */   /*Changes Done by Siva K and Ganesh J 07032024*/
	UPDATE TBL_PRODUCT_HOLD_DATA
	SET    MTFHAIRCUT = 100,
		   HAIRCUT = 100
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE TBL_PRODUCT_HOLD_DATA.ISIN=T.ISIN)
	  UPDATE #B_MTF_DATA
    SET    HAIRCUT = 100
    WHERE
	 NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE #B_MTF_DATA.ISIN=T.ISIN)
	 	/* 100% var Margin Change End */


	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	WHERE HAIRCUT <> 100

	--/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN MTOM_LOSS < 0 THEN 0 ELSE MTOM_LOSS END)
	--FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	--FROM #B_MTF_DATA 
	--GROUP BY PARTY_CODE) A
	--WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	--*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/

	CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT >=GETDATE()-10
	       AND L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_BKUP_25Nov2022
-- --------------------------------------------------


-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_BKUP_25Nov2022] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON 

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE < @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM ANAND.BSEDB_AB.DBO.DELIVERYCLT D, ANAND.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  ANAND.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE aND c.REcDATE <= @PREV_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM ANAND.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE aND v.FDATE <= @PREV_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE #B_MTF_DATA 
    SET    HAIRCUT = F.VARMARGIN
	FROM MTF_ANGEL_Varmargin F
	WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date
	AND #B_MTF_DATA.ISIN = F.ISIN 
	AND HAIRCUT < F.VARMARGIN

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	WHERE HAIRCUT <> 100

	/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN A.MTOM_LOSS < 0 THEN 0 ELSE #B_MTF_DATA.MTOM_LOSS END)
	FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	FROM #B_MTF_DATA 
	GROUP BY PARTY_CODE) A
	WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/

	CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    ANAND.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   ANAND.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT >=GETDATE()-10
	       AND L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_BKUP_30JUN2025_SRE-38205
-- --------------------------------------------------



-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_BKUP_30JUN2025_SRE-38205] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT,
			@PREV_DATE varchar(11),
			@MTFCOLLVAR INT	

	SET NOCOUNT ON
	
	---Select * from TBL_MTF_MULTIPLIER

	SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE <= @SAUDA_DATE 

	SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	--WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM AngelBSECM.BSEDB_AB.DBO.DELIVERYCLT D, AngelBSECM.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE
	AND 1 =2 
	/*
	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))
	*/
	
	--IF @SAUDA_DATE = LEFT(GETDATE(),11)
	IF 1 = 1 
	BEGIN	
		IF @FLAG <> 2 
		BEGIN
			EXEC EDP_DP_BALANCE_UPDATE_NEW
		END

		INSERT INTO #B_BTSTMTF
		SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
		SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
		ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
		FROM DELCDSLBALANCE
		WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN 
					  WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)

		DELETE FROM TBL_PRODUCT_HOLD_DATA    
		WHERE SAUDA_DATE = @SAUDA_DATE    
		AND HOLDFLAG IN ('POA','1 BTST POSITION') 

		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
		ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM #B_BTSTMTF
		WHERE QTY > 0   
	/*
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'
									WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'
									WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'
									ELSE 'BEN_P'
							   END), 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,
		(SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM BSEDB.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
		UNION 
		SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT
		FROM MSAJAG.DBO.DELIVERYDP DP
		WHERE DP.DESCRIPTION NOT LIKE '%POOL%'
		AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
		AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND P.BDPID = D.DPID
		AND P.BCLTDPID = D.DPCLTNO
		AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0
	
		INSERT INTO TBL_PRODUCT_HOLD_DATA
		SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN, 
		NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END), 
		SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE, 
		ORGQTY = 0, HOLDFLAG = 'POA_P', 
		CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
		FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P
		WHERE RECORDDATE <= @SAUDA_DATE
		AND STATUSFLAG = 'P'
		AND RECORDLOCATION = 'DP'*/
	END

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1
	/*
	UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM MSAJAG.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN

	UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM BSEDB.DBO.MULTIISIN_NEW M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
	AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	*/
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY = Sum(Qty), 
           MKTAMT = Sum(Mktamt), 
           NETAMT = Sum(Netamt), 
           CL_RATE =max(Cl_Rate), 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,
		   ORGSAUDA_DATE = SAUDA_DATE */
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 AND QTY > 0 
	Group By 
		   PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN


	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  AngelBSECM.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C
    WHERE  SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE+ ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @PREV_DATE
           AND SYSDATE <= @PREV_DATE + ' 23:59' 
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	
	CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN
	(
		ISIN
	)
	
	INSERT INTO #B_TBLSCRIPMARGIN 
	SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,
					SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0 
	FROM TBLSCRIPMARGIN 
	WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE=@SAUDA_DATE
--		  SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN
	AND ACTIVEFLAG = 1
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL  C
	WHERE C.RECDATE >= @PREV_DATE aND c.REcDATE <= @PREV_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE >= @PREV_DATE aND v.FDATE <= @PREV_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
 
	
    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1  AND HAIRCUT < 25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
    FROM   #B_TBLSCRIPMARGIN T 
    WHERE  #B_MTF_DATA.ISIN = T.ISIN AND FOFLAG=1
	AND    HAIRCUT <> 0


	--UPDATE  #B_MTF_DATA SET  HAIRCUT = (CASE WHEN FOFLAG = 1 AND HAIRCUT <25 THEN HAIRCUT + 2  ELSE HAIRCUT END)
	--WHERE HAIRCUT <> 0

	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd
	
	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
	
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1

    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	--AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1
		
    UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 
							  THEN M.MARGIN + @FNO * ELM 
							  ELSE M.MARGIN + @NONFNO * ELM 
					     END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1

	IF @MTFCOLLVAR = 1 
	BEGIN
		UPDATE TBL_PRODUCT_HOLD_DATA     
		SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT  
		WHERE SAUDA_DATE = @SAUDA_DATE
		AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN) 
	END

	
	
	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE #B_MTF_DATA 
    SET    HAIRCUT = F.VARMARGIN
	FROM MTF_ANGEL_Varmargin F
	WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date
	AND #B_MTF_DATA.ISIN = F.ISIN 
	AND HAIRCUT < F.VARMARGIN

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100

	UPDATE TBL_PRODUCT_HOLD_DATA     
	SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END), 
		   HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)  
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)
	
	UPDATE TBL_PRODUCT_HOLD_DATA              
	SET     HAIRCUT = 100        
	WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)     

	/* 100% var Margin Change Start */   /*Changes Done by Siva K and Ganesh J 07032024*/
	UPDATE TBL_PRODUCT_HOLD_DATA
	SET    MTFHAIRCUT = 100,
		   HAIRCUT = 100
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE TBL_PRODUCT_HOLD_DATA.ISIN=T.ISIN)
	  UPDATE #B_MTF_DATA
    SET    HAIRCUT = 100
    WHERE
	 NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE #B_MTF_DATA.ISIN=T.ISIN)
	 	/* 100% var Margin Change End */


	UPDATE TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100   
	WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0
	AND HOLDFLAG = 'MTFCOLL'

     UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)

	
	 
	UPDATE #B_MTF_DATA 
	SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY 
	--WHERE HAIRCUT <> 100

	--/*	
	UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN MTOM_LOSS < 0 THEN 0 ELSE MTOM_LOSS END)
	--FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)
	--FROM #B_MTF_DATA 
	--GROUP BY PARTY_CODE) A
	--WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
	--*/
	/*
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/

	CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT  INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
		
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM    AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 

	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   AngelBSECM.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		--WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		WHERE   SAUDA_DATE = @SAUDA_DATE 
           AND ADJUST_DATE >= @SAUDA_DATE 
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A where 1 = 2 
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED
	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE 
    /*
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT <= @SAUDA_DATE
           AND EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)*/
    GROUP  BY L.CLTCODE
	*/
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT >=GETDATE()-10
	       AND L.VDT <= @SAUDA_DATE
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 


	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTNCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	
	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'D' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM  ANGELCOMMODITY.ACCOUNTMCDX.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT <= @SAUDA_DATE 
           AND L.EDT > @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('POA', 'POA_P')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = 0--NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	
	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH 
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100) 
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG IN ('BEN_C')
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	/*
	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE
	*/
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE
		    
	UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)
    FROM   MSAJAG.DBO.TBL_CMMARGIN C 
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE) 
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1 
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.MCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   
    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM    ANGELCOMMODITY.NCDX.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0 
	FROM #B_MTF_DATA

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_NEWMTF
-- --------------------------------------------------
  
  
  
  
-- EXEC PROC_PRODUCT_BUY_ADJUST 'JUL 11 2017'  
CREATE  PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_NEWMTF] (@SAUDA_DATE VARCHAR(11), @flag int = 0 )   
AS    
    DECLARE @PAYIN_DATE VARCHAR(11),  
   @SDTCUR DATETIME,  
   @LDTCUR DATETIME,  
   @NONFNO INT,  
   @FNO INT,  
   @PREV_DATE varchar(11),  
   @MTFCOLLVAR INT,  
    @ADHOC_MARGIN NUMERIC(18,4)  
  
 SET NOCOUNT ON  
   
 ---Select * from TBL_MTF_MULTIPLIER  
  
 SELECT @PREV_DATE = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C   
 WHERE SYSDATE <= @SAUDA_DATE   
  
 SELECT @NONFNO = NONFNO, @FNO = FNO, @MTFCOLLVAR = MTFCOLLVAR,@ADHOC_MARGIN = ISNULL(ADHOC_MARGIN,0) FROM TBL_MTF_MULTIPLIER  
 WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE  
  
 DECLARE  @PREV_DATE_NEW varchar(11)  
     
  
IF (CONVERT(DATETIME,@SAUDA_DATE,109) >= 'JUN 30 2025')  
  
BEGIN  
              SET @PREV_DATE_NEW = @SAUDA_DATE  
END  
         ELSE  
BEGIN  
              SET @PREV_DATE_NEW = @PREV_DATE  
END  
  
  
 SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER   
 WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR    
  
 SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)  
 INTO #B_PFVALUE  
 FROM  TBL_PRODUCT_POSITION   
    WHERE SAUDA_DATE <= @SAUDA_DATE   
           AND ADJUST_DATE > @SAUDA_DATE   
           AND SELL_BUY = 1  
 GROUP BY PARTY_CODE  
  
 UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT  
 FROM TBLCLIENTMARGIN P  
 WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE  
 AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
 DELETE FROM #B_PFVALUE  
 --WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)  
  
 DECLARE @PFCUR  CURSOR,  
   @PARTY_CODE VARCHAR(10),  
   @AMOUNT  NUMERIC(18,4),  
   @BUYCUR  CURSOR,  
   @SNO  INT,  
   @ISIN  VARCHAR(12),  
   @QTY  INT,  
   @NETAMT  NUMERIC(18,4),  
   @ADJRATE NUMERIC(18,4),  
   @ADJQTY  INT  
  
 SET @PFCUR = CURSOR FOR  
 SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM  
 FROM #B_PFVALUE  
 ORDER BY PARTY_CODE  
 OPEN @PFCUR  
 FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT  
 WHILE @@FETCH_STATUS = 0  
 BEGIN  
  SET @BUYCUR = CURSOR FOR  
  SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION  
  WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE  
  AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 and sett_no <> '2000000'  
  ORDER BY NETAMT DESC  
  OPEN @BUYCUR  
  FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT  
  WHILE @@FETCH_STATUS = 0  
  BEGIN   
   IF @AMOUNT > 0   
   BEGIN  
    IF @AMOUNT >= @NETAMT  
    BEGIN  
     UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0   
     WHERE SNO = @SNO  
  
     SET @AMOUNT = @AMOUNT - @NETAMT  
    END   
    ELSE  
    BEGIN  
     SET @ADJRATE = @NETAMT / @QTY  
     SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)  
     SET @ADJQTY = @QTY - @ADJQTY  
       
     UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),  
     NETAMT = @ADJQTY * (NETAMT / @QTY)  
     WHERE SNO = @SNO  
  
     SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)  
    END   
   END  
   FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT  
  END  
  CLOSE @BUYCUR  
  DEALLOCATE @BUYCUR  
  
  FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT  
 END  
 CLOSE @PFCUR  
 DEALLOCATE @PFCUR  
  
 DELETE FROM TBL_PRODUCT_POSITION  
 WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0  
    
 SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES),   
 BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,   
 ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'  
 INTO #B_BTSTMTF  
 FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S  
 WHERE S.SETT_NO = D.SETT_NO  
 AND   S.SETT_TYPE = D.SETT_TYPE   
 AND   INOUT = 'O'  
 AND   D.SETT_TYPE IN ('N', 'W')  
 AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
 AND S.START_DATE < @SAUDA_DATE  
 AND S.SEC_PAYIN > @SAUDA_DATE  
 AND 1 =2   
  
 INSERT INTO #B_BTSTMTF  
 SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
 BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,     
 ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'   
 FROM BSEDB_AB.DBO.DELIVERYCLT D, BSEDB_AB.DBO.SETT_MST S  
 WHERE S.SETT_NO = D.SETT_NO  
 AND   S.SETT_TYPE = D.SETT_TYPE   
 AND   INOUT = 'O'  
 AND   D.SETT_TYPE IN ('D', 'C')  
 AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
 AND S.START_DATE < @SAUDA_DATE  
 AND S.SEC_PAYIN > @SAUDA_DATE  
 AND 1 =2   
 /*  
 UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY  
 FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,  
    BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D  
    WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1   
    GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D  
 WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO  
 AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE  
 AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE  
 AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD  
 AND   #B_BTSTMTF.SERIES = D.SERIES)  
 OR   (#B_BTSTMTF.BSECODE = D.BSECODE))  
 */  
   
 --IF @SAUDA_DATE = LEFT(GETDATE(),11)  
 IF 1 = 1   
 BEGIN   
  IF @FLAG <> 2   
  BEGIN  
   EXEC EDP_DP_BALANCE_UPDATE_NEW  
  END  
  
  INSERT INTO #B_BTSTMTF  
  SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '',   
  SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',     
  ORGQTY = FREEBAL, HOLDFLAG = 'POA'   
  FROM DELCDSLBALANCE  
  WHERE EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN   
       WHERE DELCDSLBALANCE.PARTY_CODE = TBLCLIENTMARGIN.PARTY_CODE)  
  
  DELETE FROM TBL_PRODUCT_HOLD_DATA      
  WHERE SAUDA_DATE = @SAUDA_DATE      
  AND HOLDFLAG IN ('POA','1 BTST POSITION')   
  
  INSERT INTO TBL_PRODUCT_HOLD_DATA  
  SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE,   
  ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
  FROM #B_BTSTMTF  
  WHERE QTY > 0     
 /*  
  INSERT INTO TBL_PRODUCT_HOLD_DATA  
  SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN,   
  NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END),   
  SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE,   
  ORGQTY = 0, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL_P'  
         WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL_P'  
         WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL_P'  
         ELSE 'BEN_P'  
          END),   
  CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
  FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P,  
  (SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT  
  FROM BSEDB.DBO.DELIVERYDP DP  
  WHERE DP.DESCRIPTION NOT LIKE '%POOL%'  
  AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
  AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
  UNION   
  SELECT DPID, DPCLTNO, ACCOUNTTYPE, SEGMENT  
  FROM MSAJAG.DBO.DELIVERYDP DP  
  WHERE DP.DESCRIPTION NOT LIKE '%POOL%'  
  AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
  AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)) D  
  WHERE RECORDDATE <= @SAUDA_DATE  
  AND STATUSFLAG = 'P'  
  AND P.BDPID = D.DPID  
  AND P.BCLTDPID = D.DPCLTNO  
  AND (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END) > 0  
   
  INSERT INTO TBL_PRODUCT_HOLD_DATA  
  SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, NEW_ISIN,   
  NEWQTY = (CASE WHEN CORP_TYPE = 'SPLIT' THEN NEWQTY - QTY ELSE NEWQTY END),   
  SEC_PAYIN = @SAUDA_DATE, START_DATE = @SAUDA_DATE,   
  ORGQTY = 0, HOLDFLAG = 'POA_P',   
  CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
  FROM MSAJAG.DBO.TBL_CORP_DATA_PROV P  
  WHERE RECORDDATE <= @SAUDA_DATE  
  AND STATUSFLAG = 'P'  
  AND RECORDLOCATION = 'DP'*/  
 END  
   Select *  INTO #NSE_ISIN from  MSAJAGDEMAT.DBO.MULTIISIN  
 Select *  INTO #BSE_ISIN from  BSEDB.DBO.MULTIISIN   
          
        CREATE INDEX #NI ON #NSE_ISIN   
 (ISIN ,VALID)  
  
        CREATE INDEX #BI ON #BSE_ISIN   
 (ISIN ,VALID)  
  
/*  
 UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES  
 FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN  
 AND VALID = 1   
  
 UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)  
 FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN  
 AND VALID = 1  */  
  
  
 UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES  
 FROM #NSE_ISIN M  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN  
 AND VALID = 1   
  
 UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)  
 FROM #BSE_ISIN M  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN  
 AND VALID = 1  
 /*  
 UPDATE TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES  
 FROM MSAJAG.DBO.MULTIISIN_NEW M  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO  
 AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN  
  
 UPDATE TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)  
 FROM BSEDB.DBO.MULTIISIN_NEW M  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO  
 AND TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN  
 */  
 SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN  
 INTO #B_HOLDDATA FROM TBL_PRODUCT_HOLD_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
    
    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE),     
           PARTY_CODE,     
           SCRIP_CD,     
           SERIES,     
           BSECODE,     
           ISIN,     
           QTY = Sum(Qty),     
           MKTAMT = Sum(Mktamt),     
           NETAMT = Sum(Netamt),     
           CL_RATE =max(Cl_Rate),     
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0),     
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0),     
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0),     
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0),     
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0),     
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0),     
     MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0),      
     FOLEDBAL = CONVERT(NUMERIC(18, 4), 0),     
     CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0),     
     CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),    
     CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),    
     CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),    
     MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),    
     MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),    
     MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),    
     FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0),     
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),    
     POAHOLDING= CONVERT(NUMERIC(18, 4), 0),    
     POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),    
     SELLSHORT = CONVERT(NUMERIC(18, 4), 0),/*,    
     ORGSAUDA_DATE = SAUDA_DATE */    
    /*--- MTF NEW CHANGES ---*/  
       
     MTF_FLAG = 0,  
     SETT_NO = MAX(SETT_NO),  
     PAYIN_DATE = MAX(PAYIN_DATE),  
     TRANSTYPE = MAX(TRANSTYPE)  
    INTO   #B_MTF_DATA     
    FROM   TBL_PRODUCT_POSITION WITH(NOLOCK)    
    WHERE  SAUDA_DATE < @SAUDA_DATE     
           AND ADJUST_DATE > @SAUDA_DATE     
           AND SELL_BUY = 1 AND QTY > 0     
 Group By     
     PARTY_CODE,     
           SCRIP_CD,     
           SERIES,     
           BSECODE,     
           ISIN    
    
   /*--- START NEW MTF CHANGES ---*/  
      
    INSERT INTO #B_MTF_DATA       
 SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE),     
           PARTY_CODE,     
           SCRIP_CD,     
           SERIES,     
           BSECODE,     
           ISIN,     
           QTY = Sum(Qty),     
           MKTAMT = Sum(Mktamt),     
           NETAMT = Sum(Netamt),     
           CL_RATE =max(Cl_Rate),     
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0),     
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0),     
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0),     
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0),     
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0),     
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0),     
     MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0),      
     FOLEDBAL = CONVERT(NUMERIC(18, 4), 0),     
     CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0),     
     CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),    
     CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),    
     CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),    
     MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),    
     MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),    
     MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),    
     FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),     
     FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0),     
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),    
     POAHOLDING= CONVERT(NUMERIC(18, 4), 0),    
     POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),    
     SELLSHORT = CONVERT(NUMERIC(18, 4), 0)/*,    
     ORGSAUDA_DATE = SAUDA_DATE */    
      ,MTF_FLAG = 1,   ----NEW MTF CHANGES DECLARE NEW FLAG----  
    SETT_NO,  
     PAYIN_DATE,  
     TRANSTYPE  
    FROM   TBL_PRODUCT_POSITION WITH(NOLOCK)    
    WHERE  SAUDA_DATE = @SAUDA_DATE     
           AND ADJUST_DATE > @SAUDA_DATE     
           AND SELL_BUY = 1 AND QTY > 0     
 Group By     
     PARTY_CODE,     
           SCRIP_CD,     
           SERIES,     
           BSECODE,     
           ISIN,  
     SETT_NO,  
     PAYIN_DATE,  
     TRANSTYPE  
  /*--- END NEW MTF CHANGES ---*/  
 SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE  AND SYSDATE <= @PREV_DATE + ' 23:59'   
 SELECT *  INTO #BSE_CLOSING from  BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE AND SYSDATE <= @PREV_DATE + ' 23:59'   
          
        CREATE INDEX #NCLOSING ON #NSE_CLOSING   
 (SCRIP_CD ,SERIES)  
  
        CREATE INDEX #BCLSOING ON #BSE_CLOSING   
 (SCRIP_CD )  
   

   DECLARE @PREV_DATE_T1 VARCHAR(11)

	SELECT @PREV_DATE_T1 = left(ISNULL(MAX(SYSDATE),@SAUDA_DATE),11) FROM   MSAJAG.DBO.CLOSING C 
	WHERE SYSDATE <  @SAUDA_DATE 

	SELECT *  INTO #NSE_CLOSING_P from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @PREV_DATE_T1  AND SYSDATE <= @PREV_DATE_T1 + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING_P from  BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @PREV_DATE_T1 AND SYSDATE <= @PREV_DATE_T1 + ' 23:59' 


	       CREATE INDEX #NCLOSING ON #NSE_CLOSING_P 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING_P 
	(SCRIP_CD )





   
    UPDATE #B_MTF_DATA   
    SET    CURR_CL_RATE = C.CL_RATE   
    FROM   #NSE_CLOSING C  
    WHERE  SYSDATE >= @PREV_DATE  
           AND SYSDATE <= @PREV_DATE + ' 23:59'   
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD   
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' )   
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' )   
           AND #B_MTF_DATA.CURR_CL_RATE = 0   
  
    UPDATE #B_MTF_DATA   
    SET    CURR_CL_RATE = C.CL_RATE   
    FROM   #NSE_CLOSING C   
    WHERE  SYSDATE >= @PREV_DATE  
           AND SYSDATE <= @PREV_DATE+ ' 23:59'   
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD   
           AND #B_MTF_DATA.SERIES = C.SERIES   
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' )   
           AND #B_MTF_DATA.CURR_CL_RATE = 0   
  
    UPDATE #B_MTF_DATA   
    SET    CURR_CL_RATE = C.CL_RATE   
    FROM   #BSE_CLOSING C  
    WHERE  SYSDATE >= @PREV_DATE  
           AND SYSDATE <= @PREV_DATE+ ' 23:59'   
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD   
           AND #B_MTF_DATA.CURR_CL_RATE = 0   
  
 /* CLOSING PRICE OPTI*/  
   
 UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    CL_RATE = C.CL_RATE   
    FROM   #NSE_CLOSING_P C   
    WHERE  SAUDA_DATE = @SAUDA_DATE  --AND SYSDATE >= @PREV_DATE  
           --AND SYSDATE <= @PREV_DATE + ' 23:59'   
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD   
         AND TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' )   
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' )   
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0   
  
    UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    CL_RATE = C.CL_RATE   
    FROM   #NSE_CLOSING_P C   
    WHERE  SAUDA_DATE = @SAUDA_DATE --AND SYSDATE >= @PREV_DATE  
         --  AND SYSDATE <= @PREV_DATE + ' 23:59'   
           AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD   
           AND TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES   
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' )   
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0   
  
    UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    CL_RATE = C.CL_RATE   
    FROM   #BSE_CLOSING_P C   
    WHERE  SAUDA_DATE = @SAUDA_DATE ---AND SYSDATE >= @PREV_DATE  
          -- AND SYSDATE <= @PREV_DATE + ' 23:59'   
           AND TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD   
           AND TBL_PRODUCT_HOLD_DATA.CL_RATE = 0   
  
 SELECT *, FOFLAG = 0, ACTIVEFLAG = 1 INTO #B_TBLSCRIPMARGIN   
 FROM TBLSCRIPMARGIN  
 WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
   
 CREATE CLUSTERED INDEX IDXDT ON #B_TBLSCRIPMARGIN  
 (  
  ISIN  
 )  
   
 INSERT INTO #B_TBLSCRIPMARGIN   
 SELECT DISTINCT SCRIP_CD,FROM_DATE=@SAUDA_DATE,TO_DATE=@SAUDA_DATE + ' 23:59:59',ENTERED_BY='',ENTERED_DATE=@SAUDA_DATE,  
     SERIES,BSECODE,ISIN,SCRIP_GROUP,FUND_PER, FOFLAG = 0, ACTIVEFLAG = 0   
 FROM TBLSCRIPMARGIN   
 WHERE ISIN NOT IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)  
  
 UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1  
 FROM NSEFO.DBO.FOSCRIP2 F  
 WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD  
 AND   F.EXPIRYDATE >= @SAUDA_DATE  
 AND   INST_TYPE LIKE 'FUT%'  
  
 UPDATE TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1  
 FROM #B_TBLSCRIPMARGIN  
 WHERE SAUDA_DATE=@SAUDA_DATE  
--    SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
 AND #B_TBLSCRIPMARGIN.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN  
 AND ACTIVEFLAG = 1  
   
 SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V,   
 MSAJAG.DBO.VARCONTROL  C  
 WHERE C.RECDATE >= @PREV_DATE_NEW  aND c.REcDATE <= @PREV_DATE_NEW  + ' 23:59'  
 AND C.DETAILKEY = V.DETAILKEY  
 AND SERIES IN ( 'EQ', 'BE', 'BZ' )   
 AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)  
  
 --SELECT V.* INTO #B_BSE_VAR FROM BSEDB.DBO.VARDETAIL V  
 --WHERE V.FDATE = @SAUDA_DATE  
 --AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)  
  
 /** For Optimization*/   
 SELECT V.* INTO  #BSE_VAR FROM BSEDB_AB.DBO.VARDETAIL V  
 WHERE V.FDATE >= @PREV_DATE_NEW  aND v.FDATE <= @PREV_DATE_NEW  + ' 23:59'  
  
    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V  
 WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)  
  
 CREATE CLUSTERED INDEX #NISIN ON #B_NSE_VAR  
 (ISIN )  
 CREATE CLUSTERED INDEX #BISIN ON #B_BSE_VAR  
 (ISIN )  
  
    UPDATE #B_MTF_DATA   
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T   
    WHERE  M.ISIN = #B_MTF_DATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    HAIRCUT = 0  
   
   
   
    UPDATE #B_MTF_DATA   
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1  AND HAIRCUT < 25 THEN HAIRCUT + 2  ELSE HAIRCUT END)  
    FROM   #B_TBLSCRIPMARGIN T   
    WHERE  #B_MTF_DATA.ISIN = T.ISIN AND FOFLAG=1  
 AND    HAIRCUT <> 0  
  
  
 --UPDATE  #B_MTF_DATA SET  HAIRCUT = (CASE WHEN FOFLAG = 1 AND HAIRCUT <25 THEN HAIRCUT + 2  ELSE HAIRCUT END)  
 --WHERE HAIRCUT <> 0  
  
 UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1   
         THEN M.MARGIN + @FNO * ELM   
         ELSE M.MARGIN + @NONFNO * ELM   
          END)  
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE  
 AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFHAIRCUT = 0  
 AND    TBL_PRODUCT_HOLD_DATA.BSECODE = M.Scrip_Cd  
   
 UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1   
         THEN M.MARGIN + @FNO * ELM   
         ELSE M.MARGIN + @NONFNO * ELM   
          END)  
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE  
 AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFHAIRCUT = 0  
   
    UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    HAIRCUT = M.APPVAR  
    FROM   #B_NSE_VAR M--,  #B_TBLSCRIPMARGIN T   
    WHERE  SAUDA_DATE = @SAUDA_DATE  
 AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN    
 --AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1  
   
    UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T   
    WHERE  SAUDA_DATE = @SAUDA_DATE  
 AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN   
 AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1  
  
    UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)  
    FROM   #B_BSE_VAR M--,  #B_TBLSCRIPMARGIN T    
    WHERE  SAUDA_DATE = @SAUDA_DATE  
 AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN    
 AND    HAIRCUT = 0  
 --AND    M.ISIN = T.ISIN AND ACTIVEFLAG = 1  
    
    UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1   
         THEN M.MARGIN + @FNO * ELM   
         ELSE M.MARGIN + @NONFNO * ELM   
          END)  
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE  
 AND    M.ISIN = TBL_PRODUCT_HOLD_DATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFHAIRCUT = 0 AND ACTIVEFLAG = 1  
  
 IF @MTFCOLLVAR = 1   
 BEGIN  
  UPDATE TBL_PRODUCT_HOLD_DATA       
  SET    MTFHAIRCUT = HAIRCUT, HAIRCUT = MTFHAIRCUT    
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND ISIN IN (SELECT ISIN FROM #B_TBLSCRIPMARGIN)   
 END  
  
   
   
 UPDATE TBL_PRODUCT_HOLD_DATA       
 SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT = 0 THEN 100 ELSE MTFHAIRCUT END),   
     HAIRCUT = (CASE WHEN HAIRCUT = 0 THEN 100 ELSE HAIRCUT END)    
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND (MTFHAIRCUT = 0 OR HAIRCUT = 0)  
  
    UPDATE #B_MTF_DATA   
    SET    HAIRCUT = 100   
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100  
  
 UPDATE #B_MTF_DATA   
    SET    HAIRCUT = F.VARMARGIN  
 FROM MTF_ANGEL_Varmargin F  
 WHERE @SAUDA_DATE BETWEEN F.From_date AND F.end_date  
 AND #B_MTF_DATA.ISIN = F.ISIN   
 AND HAIRCUT < F.VARMARGIN  
  
    UPDATE #B_MTF_DATA   
    SET    HAIRCUT = 100   
    WHERE  HAIRCUT = 0 OR HAIRCUT > 100  
  
 UPDATE TBL_PRODUCT_HOLD_DATA       
 SET    MTFHAIRCUT = (CASE WHEN MTFHAIRCUT > 100 THEN 100 ELSE MTFHAIRCUT END),   
     HAIRCUT = (CASE WHEN HAIRCUT > 100 THEN 100 ELSE HAIRCUT END)    
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND (MTFHAIRCUT > 100 OR HAIRCUT > 100)  
   
 UPDATE TBL_PRODUCT_HOLD_DATA                
 SET     HAIRCUT = 100          
 WHERE SAUDA_DATE = @SAUDA_DATE AND ISIN  IN (SELECT DISTINCT ISIN FROM MSAJAG.DBO.LIQUID_ISIN_FOVIOLATION L WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)       
  
 /* 100% var Margin Change Start */   /*Changes Done by Siva K and Ganesh J 07032024*/  
 UPDATE TBL_PRODUCT_HOLD_DATA  
 SET    MTFHAIRCUT = 100,  
     HAIRCUT = 100  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE TBL_PRODUCT_HOLD_DATA.ISIN=T.ISIN)  
   UPDATE #B_MTF_DATA  
    SET    HAIRCUT = 100  
    WHERE  
  NOT EXISTS (SELECT ISIN FROM   #B_TBLSCRIPMARGIN T WHERE #B_MTF_DATA.ISIN=T.ISIN)  
   /* 100% var Margin Change End */  
  
  
 UPDATE TBL_PRODUCT_HOLD_DATA   
    SET    HAIRCUT = 100     
 WHERE SAUDA_DATE = @SAUDA_DATE AND FOGFLAG = 0  
 AND HOLDFLAG = 'MTFCOLL'  
  
    -- UPDATE #B_MTF_DATA   
    --SET    MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*HAIRCUT / 100 Else NETAMT*HAIRCUT / 100 End)  
  
 /*--- ADDED NEW CONDITION FOR NEW MTF ---*/  
 UPDATE #B_MTF_DATA   
    SET  MARGIN_REQ = (Case When NETAMT > Curr_Cl_Rate*Qty Then Curr_Cl_Rate*Qty*(HAIRCUT+@ADHOC_MARGIN) / 100 Else NETAMT*(HAIRCUT+@ADHOC_MARGIN) / 100 End)  
  /*--- ADDED NEW CONDITION FOR NEW MTF ---*/  
  
 UPDATE #B_MTF_DATA   
 SET    MTOM_LOSS = ( MKTAMT / QTY - CURR_CL_RATE ) * QTY   
 --WHERE HAIRCUT <> 100  
  
 --/*   
 UPDATE #B_MTF_DATA SET MTOM_LOSS = (CASE WHEN MTOM_LOSS < 0 THEN 0 ELSE MTOM_LOSS END)  
 --FROM (SELECT PARTY_CODE, MTOM_LOSS = SUM(MTOM_LOSS)  
 --FROM #B_MTF_DATA   
 --GROUP BY PARTY_CODE) A  
 --WHERE A.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
 --*/  
 /*  
 UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT  
 FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)  
    FROM TBL_PRODUCT_HOLD_DATA WHERE HOLDFLAG = 'OPEN SELL POS'  
    GROUP BY PARTY_CODE  
    HAVING SUM(QTY) > 0) A  
 WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
 */  
  
 CREATE INDEX #PARTY ON #B_MTF_DATA (PARTY_CODE)  
  
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    INTO   #B_LEDBAL   
    FROM   ACCOUNT.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
     /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        THEN '35' ELSE '' END)*/  
    GROUP  BY L.CLTCODE   
  
 INSERT  INTO   #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'D' THEN VAMT   
                             ELSE -VAMT   
                           END)  
    FROM   ACCOUNT.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT <= @SAUDA_DATE  
           AND L.EDT > @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
     /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        THEN '35' ELSE '' END)*/  
    GROUP  BY L.CLTCODE   
    
 if @flag = 0  
 begin  
  INSERT INTO   #B_LEDBAL  
  SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV  
  FROM TBL_PRODUCT_LED_ADJUST  
  WHERE SAUDA_DATE = @SAUDA_DATE  
 end  
    
 INSERT INTO   #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)       
    FROM    ACCOUNT_AB.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
     /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        THEN '35' ELSE '' END)*/  
    GROUP  BY L.CLTCODE   
  
 INSERT INTO   #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'D' THEN VAMT   
                             ELSE -VAMT   
                           END)       
    FROM   ACCOUNT_AB.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT <= @SAUDA_DATE  
           AND L.EDT > @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
     /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        THEN '35' ELSE '' END)*/  
    GROUP  BY L.CLTCODE   
   
    /*    
       
    INSERT INTO #B_LEDBAL   
    SELECT A.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM   ACCOUNTBSE.DBO.LEDGER L,   
           ACCOUNTBSE.DBO.PARAMETER P,   
           ACCOUNTBSE.DBO.ACMAST A   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = A.CLTCODE   
           AND A.ACCAT = 4   
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR   
           AND A.CLTCODE IN (SELECT PARTY_CODE   
     FROM   #B_MTF_DATA   
                             WHERE  PARTY_CODE = A.CLTCODE)   
    GROUP  BY A.CLTCODE         
       
    */   
  
 SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (  
  SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM TBL_PRODUCT_POSITION  
  --WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1   
  WHERE   SAUDA_DATE = @SAUDA_DATE   
           AND ADJUST_DATE >= @SAUDA_DATE   
           AND SELL_BUY = 1 --AND SETT_NO = '2000000'  
  GROUP BY PARTY_CODE  
  UNION ALL  
  SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION  
  WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1   
      AND ADJUST_DATE = @SAUDA_DATE   
  GROUP BY PARTY_CODE ) A where 1 = 2   
 GROUP BY PARTY_CODE  
  
 INSERT INTO #B_LEDBAL   
 SELECT * FROM #B_MTFREVLED  
  
    UPDATE #B_MTF_DATA   
    SET    CMLEDBAL = VDTLEDBAL   
    FROM   (SELECT CLTCODE,   
                   VDTLEDBAL = SUM(VDTLEDBAL)   
            FROM   #B_LEDBAL   
            GROUP  BY CLTCODE) A   
    WHERE  CLTCODE = PARTY_CODE   
  
 TRUNCATE TABLE #B_LEDBAL  
  
 UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT  
  
 INSERT INTO #B_LEDBAL   
 SELECT * FROM #B_MTFREVLED  
   
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)    
    FROM   LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
     /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        THEN '35' ELSE '' END)*/  
    GROUP  BY L.CLTCODE   
 /*--- ADDED NEW CONDITION FOR NEW MTF 02/07/2025 ----*/  
 /*  
 UNION ALL   
  
 SELECT L.CLTCODE,   
   VDTLEDBAL = SUM(CASE   
        WHEN DRCR = 'C' THEN -VAMT   
        ELSE VAMT   
       END)    
 --SELECT NARRATION,*  
 FROM   LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M  
 WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
     AND VTYP IN ('66','67')  
     /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        THEN '35' ELSE '' END)*/  
 GROUP  BY L.CLTCODE   
 */  
 /*--- ADDED NEW CONDITION FOR NEW MTF 02/07/2025 ----*/  
    /*  
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'D' THEN VAMT   
                             ELSE -VAMT   
                           END)    
    FROM   LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT <= @SAUDA_DATE  
           AND EDT > @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
     /*AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'   
        THEN '35' ELSE '' END)*/  
    GROUP  BY L.CLTCODE  
 */  
 if @flag = 0  
 begin  
  INSERT INTO   #B_LEDBAL  
  SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV  
  FROM TBL_PRODUCT_LED_ADJUST  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  
  INSERT INTO   #B_LEDBAL  
  SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV  
  FROM TBL_PRODUCT_LED_ADJUST  
  WHERE SAUDA_DATE = @SAUDA_DATE  
 end  
    
    UPDATE #B_MTF_DATA   
    SET    MTFLEDBAL = VDTLEDBAL   
    FROM   (SELECT CLTCODE,   
                   VDTLEDBAL = SUM(VDTLEDBAL)   
            FROM   #B_LEDBAL   
            GROUP  BY CLTCODE) A   
    WHERE  CLTCODE = PARTY_CODE   
  
 TRUNCATE TABLE #B_LEDBAL  
    INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM   ACCOUNTFO.DBO.LEDGER L,   
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE   
    GROUP  BY L.CLTCODE   
  
    INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'D' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM   ACCOUNTFO.DBO.LEDGER L,   
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT >=GETDATE()-10  
        AND L.VDT <= @SAUDA_DATE  
           AND L.EDT > @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE   
    GROUP  BY L.CLTCODE   
  
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM   ACCOUNTCURFO.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
    GROUP  BY L.CLTCODE   
  
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'D' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM  ACCOUNTCURFO.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT <= @SAUDA_DATE   
           AND L.EDT > @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
    GROUP  BY L.CLTCODE   
  
  
   
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM   ACCOUNTNCDX.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
    GROUP  BY L.CLTCODE   
  
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'D' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM  ACCOUNTNCDX.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT <= @SAUDA_DATE   
           AND L.EDT > @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
    GROUP  BY L.CLTCODE   
  
   
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'C' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM   ACCOUNTMCDX.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR   
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
    GROUP  BY L.CLTCODE   
  
 INSERT INTO #B_LEDBAL   
    SELECT L.CLTCODE,   
           VDTLEDBAL = SUM(CASE   
                             WHEN DRCR = 'D' THEN VAMT   
                             ELSE -VAMT   
                           END)   
    FROM  ACCOUNTMCDX.DBO.LEDGER L,    
     (SELECT DISTINCT PARTY_CODE    
                             FROM   #B_MTF_DATA ) M   
    WHERE  L.VDT <= @SAUDA_DATE   
           AND L.EDT > @SAUDA_DATE + ' 23:59:59'   
           AND L.CLTCODE = PARTY_CODE  
    GROUP  BY L.CLTCODE   
  
 if @flag = 0  
 begin  
  INSERT INTO   #B_LEDBAL  
  SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV  
  FROM TBL_PRODUCT_LED_ADJUST  
  WHERE SAUDA_DATE = @SAUDA_DATE  
 end  
    
    UPDATE #B_MTF_DATA   
    SET    FOLEDBAL = VDTLEDBAL   
    FROM   (SELECT CLTCODE,   
  VDTLEDBAL = SUM(VDTLEDBAL)   
            FROM   #B_LEDBAL   
            GROUP  BY CLTCODE) A   
    WHERE  CLTCODE = PARTY_CODE   
  
    UPDATE #B_MTF_DATA   
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C   
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE)   
                         FROM   MSAJAG.DBO.COLLATERAL C1   
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
     AND EXCHANGE NOT IN ('MCX', 'NCX')  
     AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0   
  
    UPDATE #B_MTF_DATA   
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C   
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE)   
                         FROM   MSAJAG.DBO.COLLATERAL C1   
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
     AND EXCHANGE NOT IN ('MCX', 'NCX')  
     AND SEGMENT = 'CAPITAL'     
  
 /*--- ADDED NEW CONDITION FOR NEW MTF 02/07/2025 ( CHANGES IN EXISTING CONDITION ADD 'MMQTY' ) ----*/  
  
 UPDATE #B_MTF_DATA   
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,  
     CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF  
 FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),  
   NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)  
   FROM TBL_PRODUCT_HOLD_DATA  
   WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('CMCOLL','CMCOLL_P','MMQTY')  
   GROUP BY PARTY_CODE ) A  
 WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
  
 /*--- ADDED NEW CONDITION FOR NEW MTF 02/07/2025 ----*/  
  
    UPDATE #B_MTF_DATA   
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C   
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE)   
                         FROM   MSAJAG.DBO.COLLATERAL C1   
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
     AND EXCHANGE NOT IN ('MCX', 'NCX')  
     AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0   
  
    UPDATE #B_MTF_DATA   
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C   
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE)   
                         FROM   MSAJAG.DBO.COLLATERAL C1   
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
     AND EXCHANGE NOT IN ('MCX', 'NCX')  
     AND SEGMENT = 'FUTURES'   
  
  
 UPDATE #B_MTF_DATA   
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,  
     FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF  
 FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),  
   NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)  
   FROM TBL_PRODUCT_HOLD_DATA  
   WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('FOCOLL', 'FOCOLL_P')  
   GROUP BY PARTY_CODE ) A  
 WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
  
    UPDATE #B_MTF_DATA   
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG    
    FROM   MSAJAG.DBO.COLLATERAL C   
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE)   
               FROM   MSAJAG.DBO.COLLATERAL C1   
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
     AND EXCHANGE = 'MTF'  
     AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0  
  
    UPDATE #B_MTF_DATA   
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG    
    FROM   MSAJAG.DBO.COLLATERAL C   
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE)   
                         FROM   MSAJAG.DBO.COLLATERAL C1   
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
     AND EXCHANGE = 'MTF'  
     AND SEGMENT = 'MTF'    
  
 UPDATE #B_MTF_DATA   
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH  
 FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)  
   FROM TBL_PRODUCT_HOLD_DATA  
   WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG IN ('MTFCOLL','MTFCOLL_P')  
   GROUP BY PARTY_CODE ) A  
 WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
  
 UPDATE #B_MTF_DATA   
    SET    POAHOLDING = NONCASH,  
     POAHOLDING_MTF = NONCASHMTF  
 FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),  
   NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)  
   FROM TBL_PRODUCT_HOLD_DATA  
   WHERE SAUDA_DATE = @SAUDA_DATE  
   AND HOLDFLAG IN ('POA', 'POA_P')  
   GROUP BY PARTY_CODE ) A  
 WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
  
 UPDATE #B_MTF_DATA   
    SET    CMDEBITHOLD = NONCASH,  
     CMDEBITHOLD_MTF = 0--NONCASHMTF  
 FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),  
   NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)  
   FROM TBL_PRODUCT_HOLD_DATA  
   WHERE SAUDA_DATE = @SAUDA_DATE  
   AND HOLDFLAG IN ('BEN', 'BEN_P', 'EPN')  
   GROUP BY PARTY_CODE ) A  
 WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
  
   
 UPDATE #B_MTF_DATA   
    SET    CMDEBITHOLD = CMDEBITHOLD + NONCASH   
 FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)   
   FROM TBL_PRODUCT_HOLD_DATA  
   WHERE SAUDA_DATE = @SAUDA_DATE  
   AND HOLDFLAG IN ('BEN_C')  
   GROUP BY PARTY_CODE ) A  
 WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
  
 /*  
 UPDATE #B_MTF_DATA   
    SET    CMOPENPOS = NONCASH  
 FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)  
   FROM TBL_PRODUCT_HOLD_DATA  
   WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'  
   GROUP BY PARTY_CODE ) A  
 WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE  
 */  
    UPDATE #B_MTF_DATA   
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM   
    FROM   NSEFO.DBO.FOMARGINNEW C   
    WHERE  MDATE = (SELECT MAX(MDATE)   
                    FROM    NSEFO.DBO.FOMARGINNEW C1   
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE  
        
 UPDATE #B_MTF_DATA   
    SET    FOMARGIN = FOMARGIN + (CASE WHEN TOTAL_MARGIN > PEAKMARGIN THEN TOTAL_MARGIN ELSE PEAKMARGIN END)  
    FROM   MSAJAG.DBO.TBL_CMMARGIN C   
    WHERE  MARGINDATE = (SELECT MAX(MARGINDATE)   
                    FROM    MSAJAG.DBO.TBL_CMMARGIN C1   
                    WHERE  C1.MARGINDATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
  
    UPDATE #B_MTF_DATA   
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM   
    FROM   NSECURFO.DBO.FOMARGINNEW C   
    WHERE  MDATE = (SELECT MAX(MDATE)   
                    FROM     NSECURFO.DBO.FOMARGINNEW C1   
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
  
       
    UPDATE #B_MTF_DATA   
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM   
    FROM   MCDX.DBO.FOMARGINNEW C   
    WHERE  MDATE = (SELECT MAX(MDATE)   
                    FROM    MCDX.DBO.FOMARGINNEW C1   
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
       
    UPDATE #B_MTF_DATA   
    SET    FOMARGIN = FOMARGIN + TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM   
    FROM   NCDX.DBO.FOMARGINNEW C   
    WHERE  MDATE = (SELECT MAX(MDATE)   
                    FROM    NCDX.DBO.FOMARGINNEW C1   
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59')   
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
 /*   
 DELETE FROM TBL_MTF_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
  
 INSERT INTO TBL_MTF_DATA  
 SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,  
 MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,  
 CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,  
 CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,  
 CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,  
 FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,  
 NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,  
 CASHDEBITADJ = 0,  
 CASHNONCASHADJ = 0,  
 FONONCASHADJ = 0,  
 CASHLEDADJ = 0,  
 FOLEDBALADJ = 0,  
 POAADJ = 0   
 FROM #B_MTF_DATA  
  
 */  
    
  /*--- START NEW MTF CHANGES EXISTING CODE ---*/  
  
 DELETE FROM TBL_MTF_DATA    
 WHERE SAUDA_DATE = @SAUDA_DATE    
    
 INSERT INTO TBL_MTF_DATA    
 SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,  
 QTY=SUM(QTY),    
 MKTAMT = SUM(MKTAMT),   
 NETAMT = SUM(NETAMT),CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,    
 CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,    
 CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,    
 CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,    
 FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,    
 NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,    
 CASHDEBITADJ = 0,    
 CASHNONCASHADJ = 0,    
 FONONCASHADJ = 0,    
 CASHLEDADJ = 0,    
 FOLEDBALADJ = 0,    
 POAADJ = 0     
 FROM #B_MTF_DATA    
 GROUP BY SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,  
 CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,  
 CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,    
 CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,    
 CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,    
 FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,    
 NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT  
  
 /*--- START NEW MTF CHANGES ---*/  
  
 DELETE FROM TBL_MTF_DATA_BUY  
 WHERE SAUDA_DATE = @SAUDA_DATE  
  
  
 INSERT INTO TBL_MTF_DATA_BUY    
 SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,    
 MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,    
 CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,    
 CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,    
 CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,    
 FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,    
 NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,    
 CASHDEBITADJ = 0,    
 CASHNONCASHADJ = 0,    
 FONONCASHADJ = 0,    
 CASHLEDADJ = 0,    
 FOLEDBALADJ = 0,    
 POAADJ = 0,  
 0,  
 0,  
 SETT_NO,  
 PAYIN_DATE,  
 TRANSTYPE  
 FROM #B_MTF_DATA    
 WHERE MTF_FLAG=1  
  
  
 DROP TABLE #B_MTF_DATA  
  
 /*--- END NEW MTF CHANGES ---*/  
 /* INSERT INTO TBL_MTF_DATA_LOG  
 SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,  
 MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,  
 CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,  
 CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,  
 CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,  
 FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,  
 NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,  
 CASHDEBITADJ = 0,  
 CASHNONCASHADJ = 0,  
 FONONCASHADJ = 0,  
 CASHLEDADJ = 0,  
 FOLEDBALADJ = 0,  
 POAADJ = 0  
 FROM #B_MTF_DATA*/--ADDED SURESH  
  
/*  
    SELECT PARTY_CODE,  
           NETFUNDREQ = ( CASE   
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL +   
                                 COLLATERAL   
                                 - SUM(   
                                 MTOM_LOSS) > 0 THEN SUM(CASE   
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT   
                 ELSE 0   
                          END)   
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL +   
                                 COLLATERAL   
                      - SUM(   
                                 MTOM_LOSS)   
                          END )   
    INTO   #B_FUND_REQ   
    FROM   #B_MTF_DATA   
    GROUP  BY PARTY_CODE,   
              FOMARGIN,   
              LEDBAL,   
              COLLATERAL   
  
    UPDATE #B_MTF_DATA   
    SET    NET_AVL_FUND = NETFUNDREQ   
    FROM   #B_FUND_REQ   
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE   
  
    DELETE FROM TBL_PRODUCT_DETAIL   
    WHERE  RUNDATE = @SAUDA_DATE   
  
    INSERT INTO TBL_PRODUCT_DETAIL   
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE),   
           *,   
           PROCESS_ON = GETDATE(),   
           PROCESS_BY = ''  
    FROM   #B_MTF_DATA   
  
    DROP TABLE #B_MTF_DATA   
  
    DROP TABLE #B_LEDBAL   
  
    DROP TABLE #B_FUND_REQ   
  
    DROP TABLE #B_NRML_DATE     
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_BUY_ADJUST_test
-- --------------------------------------------------


-- EXEC PROC_PRODUCT_BUY_ADJUST_TEST 'JUL 11 2017'
CREATE PROC [dbo].[PROC_PRODUCT_BUY_ADJUST_TEST] (@SAUDA_DATE VARCHAR(11), @flag int = 0 ) 
AS  
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT

	SET NOCOUNT ON 

	SELECT @NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE


	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER 
	WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE  LEFT(SAUDA_DATE, 11) <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	WHERE (AMOUNT <= SANC_LIM OR SANC_LIM = -1)

	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = AMOUNT - SANC_LIM
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT FROM TBL_PRODUCT_POSITION
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN
			SELECT @AMOUNT, @SNO, @ISIN, @QTY, @NETAMT
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE TBL_PRODUCT_POSITION SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = CEILING(@AMOUNT / @ADJRATE)
					SET @ADJQTY = @QTY - @ADJQTY
					
					UPDATE TBL_PRODUCT_POSITION SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - (@QTY - @ADJQTY) * (@NETAMT / @QTY)
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0
	 
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES = CONVERT(VARCHAR(3),D.SERIES), 
	BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION'
	INTO #B_BTSTMTF
	FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND   INOUT = 'O'
	AND	  D.SETT_TYPE IN ('N', 'W')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE

	INSERT INTO #B_BTSTMTF
	SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
	BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  	
	ORGQTY = QTY, HOLDFLAG = '1 BTST POSITION' 
	FROM ANAND.BSEDB_AB.DBO.DELIVERYCLT D, ANAND.BSEDB_AB.DBO.SETT_MST S
	WHERE S.SETT_NO = D.SETT_NO
	AND   S.SETT_TYPE = D.SETT_TYPE 
	AND	  INOUT = 'O'
	AND	  D.SETT_TYPE IN ('D', 'C')
	AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
	AND S.START_DATE < @SAUDA_DATE
	AND	S.SEC_PAYIN > @SAUDA_DATE

	UPDATE #B_BTSTMTF SET QTY = QTY - D.BUYQTY
	FROM (SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE,
		  BUYQTY = SUM(QTY) FROM TBL_PRODUCT_POSITION D
		  WHERE SAUDA_DATE <= @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE AND SELL_BUY = 1 
		  GROUP BY  D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) D
	WHERE #B_BTSTMTF.SETT_NO = D.SETT_NO
	AND   #B_BTSTMTF.SETT_TYPE = D.SETT_TYPE
	AND   #B_BTSTMTF.PARTY_CODE = D.PARTY_CODE
	AND   ((#B_BTSTMTF.SCRIP_CD = D.SCRIP_CD
	AND   #B_BTSTMTF.SERIES = D.SERIES)
	OR   (#B_BTSTMTF.BSECODE = D.BSECODE))

	EXEC EDP_DP_BALANCE_UPDATE_NEW

	INSERT INTO #B_BTSTMTF
	SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '', 
	SERIES, BSECODE = '', ISIN, QTY=FREEBAL, SEC_PAYIN='DEC 31 2049', START_DATE='DEC 31 2049',  	
	ORGQTY = FREEBAL, HOLDFLAG = 'POA' 
	FROM DELCDSLBALANCE
	
	SELECT SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
	ORGQTY, HOLDFLAG, CL_RATE, HAIRCUT, FOGFLAG, MTFHAIRCUT
	INTO #TBL_PRODUCT_HOLD_DATA
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO #TBL_PRODUCT_HOLD_DATA
	SELECT @SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
	ORGQTY, HOLDFLAG, CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
	FROM #B_BTSTMTF
	WHERE QTY > 0
	
	CREATE CLUSTERED INDEX IDX_HLD ON #TBL_PRODUCT_HOLD_DATA
	(
		SAUDA_DATE,
		PARTY_CODE,
		ISIN
	)

	Select *  INTO #NSE_ISIN from  ANGELDEMAT.MSAJAG.DBO.MULTIISIN
	Select *  INTO #BSE_ISIN from  ANGELDEMAT.BSEDB.DBO.MULTIISIN 
        
        CREATE INDEX #NI ON #NSE_ISIN 
	(ISIN ,VALID)

        CREATE INDEX #BI ON #BSE_ISIN 
	(ISIN ,VALID)

/*
	UPDATE #TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE #TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1  */


	UPDATE #TBL_PRODUCT_HOLD_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES
	FROM #NSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1 

	UPDATE #TBL_PRODUCT_HOLD_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
	FROM #BSE_ISIN M
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND #TBL_PRODUCT_HOLD_DATA.ISIN = M.ISIN
	AND VALID = 1



	
	SELECT DISTINCT SCRIP_CD, SERIES, BSECODE, ISIN
	INTO #B_HOLDDATA FROM #TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

    SELECT SAUDA_DATE = CONVERT(DATETIME,@SAUDA_DATE), 
           PARTY_CODE, 
           SCRIP_CD, 
           SERIES, 
           BSECODE, 
           ISIN, 
           QTY, 
           MKTAMT, 
           NETAMT, 
           CL_RATE, 
           CURR_CL_RATE = CONVERT(NUMERIC(18, 4), 0), 
           HAIRCUT = CONVERT(NUMERIC(18, 4), 0), 
           MARGIN_REQ = CONVERT(NUMERIC(18, 4), 0), 
           MTOM_LOSS = CONVERT(NUMERIC(18, 4), 0), 
           FOMARGIN = CONVERT(NUMERIC(18, 4), 0), 
           CMLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   MTFLEDBAL = CONVERT(NUMERIC(18, 4), 0), 	
		   FOLEDBAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
           CMNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   CMNONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
		   CMDEBITHOLD = CONVERT(NUMERIC(18, 4), 0),
		   CMDEBITHOLD_MTF = CONVERT(NUMERIC(18, 4), 0),
		   CMOPENPOS = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0),
		   FOCASHEQCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FOCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL = CONVERT(NUMERIC(18, 4), 0), 
		   FONONCASHCOLLATERAL_MTF = CONVERT(NUMERIC(18, 4), 0), 
           NET_AVL_FUND= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING= CONVERT(NUMERIC(18, 4), 0),
		   POAHOLDING_MTF= CONVERT(NUMERIC(18, 4), 0),
		   SELLSHORT = CONVERT(NUMERIC(18, 4), 0),
		   ORGSAUDA_DATE = SAUDA_DATE 
    INTO   #B_MTF_DATA 
    FROM   TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   MSAJAG.DBO.CLOSING C 
    WHERE  SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   MSAJAG.DBO.CLOSING C 
    WHERE  SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #B_MTF_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #B_MTF_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

    UPDATE #B_MTF_DATA 
    SET    CURR_CL_RATE = C.CL_RATE 
    FROM   ANAND.BSEDB_AB.DBO.CLOSING C 
    WHERE  SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #B_MTF_DATA.BSECODE = C.SCRIP_CD 
           AND #B_MTF_DATA.CURR_CL_RATE = 0 

	/* CLOSING PRICE OPTI*/
	
	SELECT *  INTO #NSE_CLOSING from  MSAJAG.DBO.CLOSING WHERE SYSDATE >= @SAUDA_DATE  AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
	SELECT *  INTO #BSE_CLOSING from  ANAND.BSEDB_AB.DBO.CLOSING  WHERE SYSDATE >= @SAUDA_DATE AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
        
        CREATE INDEX #NCLOSING ON #NSE_CLOSING 
	(SCRIP_CD ,SERIES)

        CREATE INDEX #BCLSOING ON #BSE_CLOSING 
	(SCRIP_CD )
	
	
	
	
	
	
	UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #TBL_PRODUCT_HOLD_DATA.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND C.SERIES IN ( 'EQ', 'BE', 'BZ' ) 
           AND #TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #NSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #TBL_PRODUCT_HOLD_DATA.SCRIP_CD = C.SCRIP_CD 
           AND #TBL_PRODUCT_HOLD_DATA.SERIES = C.SERIES 
           AND C.SERIES NOT IN ( 'EQ', 'BE', 'BZ' ) 
           AND #TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    CL_RATE = C.CL_RATE 
    FROM   #BSE_CLOSING C 
    WHERE  SAUDA_DATE = @SAUDA_DATE AND SYSDATE >= @SAUDA_DATE 
           AND SYSDATE <= @SAUDA_DATE + ' 23:59' 
           AND #TBL_PRODUCT_HOLD_DATA.BSECODE = C.SCRIP_CD 
           AND #TBL_PRODUCT_HOLD_DATA.CL_RATE = 0 

	SELECT *, FOFLAG = 0 INTO #B_TBLSCRIPMARGIN 
	FROM TBLSCRIPMARGIN
	WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	UPDATE #B_TBLSCRIPMARGIN SET FOFLAG = 1
	FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
	WHERE F.SYMBOL = #B_TBLSCRIPMARGIN.SCRIP_CD
	AND   F.EXPIRYDATE >= @SAUDA_DATE
	AND   INST_TYPE LIKE 'FUT%'

	UPDATE #TBL_PRODUCT_HOLD_DATA SET FOGFLAG = 1
	FROM #B_TBLSCRIPMARGIN
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND #B_TBLSCRIPMARGIN.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN
	
	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL C
	WHERE C.RECDATE = @SAUDA_DATE
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
	AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	--SELECT V.* INTO #B_BSE_VAR FROM ANAND.BSEDB_AB.DBO.VARDETAIL V
	--WHERE V.FDATE = @SAUDA_DATE
	--AND ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

 /** For Optimization*/ 
	SELECT V.* INTO  #BSE_VAR FROM ANAND.BSEDB_AB.DBO.VARDETAIL V
	WHERE V.FDATE = @SAUDA_DATE

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #B_MTF_DATA UNION SELECT ISIN FROM #B_HOLDDATA)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )



	
    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  M.ISIN = #B_MTF_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    HAIRCUT = 0
	
	IF CONVERT(DATETIME,@SAUDA_DATE) > CONVERT(DATETIME,'AUG 10 2017') 
	BEGIN
		UPDATE #B_MTF_DATA 
		SET    HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELM ELSE M.MARGIN + 5 * ELM END)
		FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
		WHERE  M.ISIN = #B_MTF_DATA.ISIN 
		AND    M.ISIN = T.ISIN
		AND    HAIRCUT = 0
	END
	ELSE
	BEGIN
	    UPDATE #B_MTF_DATA 
		SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELM ELSE M.MARGIN + 5 * ELM END)
		FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
		WHERE  M.ISIN = #B_MTF_DATA.ISIN 
		AND    M.ISIN = T.ISIN
		AND    HAIRCUT = 0
	END
	
    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.APPVAR
    FROM   #B_NSE_VAR M,  #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    M.ISIN = T.ISIN
	
    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
    FROM   #B_NSE_VAR M, #B_TBLSCRIPMARGIN T 
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN

    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M,  #B_TBLSCRIPMARGIN T  
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN  
	AND    HAIRCUT = 0
	AND    M.ISIN = T.ISIN
		
    UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = M.MARGIN --(CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELLM ELSE M.MARGIN + 5 * ELM END)
    FROM   #B_BSE_VAR M, #B_TBLSCRIPMARGIN T
    WHERE  SAUDA_DATE = @SAUDA_DATE
	AND    M.ISIN = #TBL_PRODUCT_HOLD_DATA.ISIN 
	AND    M.ISIN = T.ISIN
	AND    MTFHAIRCUT = 0

    UPDATE #B_MTF_DATA 
    SET    HAIRCUT = 100 
    WHERE  HAIRCUT = 0 

	UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    MTFHAIRCUT = 100
    WHERE SAUDA_DATE = @SAUDA_DATE
    AND MTFHAIRCUT = 0
    
	UPDATE #TBL_PRODUCT_HOLD_DATA 
    SET    HAIRCUT = 100
    WHERE SAUDA_DATE = @SAUDA_DATE
    AND HAIRCUT = 0
    
    UPDATE #B_MTF_DATA 
    SET    MARGIN_REQ = MKTAMT * HAIRCUT / 100 

    UPDATE #B_MTF_DATA 
    SET    MTOM_LOSS = -(( MKTAMT / QTY - CURR_CL_RATE ) * QTY) 
    WHERE  QTY > 0 AND CURR_CL_RATE > 0 AND MKTAMT > 0 AND HAIRCUT <> 100
    
	UPDATE #B_MTF_DATA SET SELLSHORT = A.SELL_SHORT
	FROM (SELECT PARTY_CODE, SELL_SHORT = SUM(QTY*CL_RATE + QTY*CL_RATE*HAIRCUT/100)
		  FROM #TBL_PRODUCT_HOLD_DATA WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'OPEN SELL POS'
		  GROUP BY PARTY_CODE
		  HAVING SUM(QTY) > 0) A
	WHERE #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    INTO   #B_LEDBAL 
    FROM   ACCOUNT.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)
    GROUP  BY L.CLTCODE 
	
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
	INSERT INTO   #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)     
    FROM   ANAND.ACCOUNT_AB.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)
    GROUP  BY L.CLTCODE 
	
    /*  
     
    INSERT INTO #B_LEDBAL 
    SELECT A.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ACCOUNTBSE.DBO.LEDGER L, 
           ACCOUNTBSE.DBO.PARAMETER P, 
           ACCOUNTBSE.DBO.ACMAST A 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = A.CLTCODE 
           AND A.ACCAT = 4 
           AND GETDATE() BETWEEN @SDTCUR AND @LDTCUR 
           AND A.CLTCODE IN (SELECT PARTY_CODE 
                             FROM   #B_MTF_DATA 
                             WHERE  PARTY_CODE = A.CLTCODE) 
    GROUP  BY A.CLTCODE       
     
    */ 

	SELECT PARTY_CODE, AMOUNT = SUM(AMOUNT) INTO #B_MTFREVLED FROM (
		SELECT PARTY_CODE, AMOUNT = SUM(NETAMT) FROM #B_MTF_DATA
		WHERE  orgSAUDA_DATE = @SAUDA_DATE --AND SELL_BUY = 1 
		GROUP BY PARTY_CODE
		UNION ALL
		SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT) FROM TBL_PRODUCT_POSITION
		WHERE  SAUDA_DATE <= @SAUDA_DATE AND SELL_BUY = 1 
			   AND ADJUST_DATE = @SAUDA_DATE 
		GROUP BY PARTY_CODE ) A
	GROUP BY PARTY_CODE

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

    UPDATE #B_MTF_DATA 
    SET    CMLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL

	UPDATE #B_MTFREVLED SET AMOUNT = -AMOUNT

	INSERT INTO #B_LEDBAL 
	SELECT * FROM #B_MTFREVLED

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END)  
    FROM   LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M	
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
		   AND VTYP <> (CASE WHEN VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
							 THEN '35' ELSE '' END)
    GROUP  BY L.CLTCODE 
    
	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOCASHJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE

		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = -MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    MTFLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

	TRUNCATE TABLE #B_LEDBAL
    INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTFO.DBO.LEDGER L, 
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE 
    GROUP  BY L.CLTCODE 

	INSERT INTO #B_LEDBAL 
    SELECT L.CLTCODE, 
           VDTLEDBAL = SUM(CASE 
                             WHEN DRCR = 'C' THEN VAMT 
                             ELSE -VAMT 
                           END) 
    FROM   ANGELFO.ACCOUNTCURFO.DBO.LEDGER L,  
		   (SELECT DISTINCT PARTY_CODE		
                             FROM   #B_MTF_DATA ) M 
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR 
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
           AND L.CLTCODE = PARTY_CODE
    GROUP  BY L.CLTCODE 

	if @flag = 0
	begin
		INSERT INTO   #B_LEDBAL
		SELECT CLTCODE, VDTLEDBAL = MTFTOFOJV
		FROM TBL_PRODUCT_LED_ADJUST
		WHERE SAUDA_DATE = @SAUDA_DATE
	end
		
    UPDATE #B_MTF_DATA 
    SET    FOLEDBAL = VDTLEDBAL 
    FROM   (SELECT CLTCODE, 
                   VDTLEDBAL = SUM(VDTLEDBAL) 
            FROM   #B_LEDBAL 
            GROUP  BY CLTCODE) A 
    WHERE  CLTCODE = PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    CMCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'  AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    CMCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'CAPITAL'   

	UPDATE #B_MTF_DATA 
    SET    CMNONCASHCOLLATERAL = CMNONCASHCOLLATERAL + NONCASH,
		   CMNONCASHCOLLATERAL_MTF = CMNONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'CMCOLL'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOCASHCOLLATERAL = CASH - TOTALFD - TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' AND (CASH - TOTALFD - TOTALBG) > 0 

    UPDATE #B_MTF_DATA 
    SET    FOCASHEQCOLLATERAL = TOTALFD + TOTALBG
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE NOT IN ('MCX', 'NCX')
		   AND SEGMENT = 'FUTURES' 


	UPDATE #B_MTF_DATA 
    SET    FONONCASHCOLLATERAL = FONONCASHCOLLATERAL + NONCASH,
		   FONONCASHCOLLATERAL_MTF = FONONCASHCOLLATERAL_MTF + NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'FOCOLL'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    MTFCASHCOLLATERAL = CASH - TOTALFD - TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
               FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF' AND (CASH - TOTALFD - TOTALBG) > 0

    UPDATE #B_MTF_DATA 
    SET    MTFCASHEQCOLLATERAL = TOTALFD + TOTALBG  
    FROM   MSAJAG.DBO.COLLATERAL C 
    WHERE  TRANS_DATE = (SELECT MAX(TRANS_DATE) 
                         FROM   MSAJAG.DBO.COLLATERAL C1 
                         WHERE  C1.TRANS_DATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 
		   AND EXCHANGE = 'MTF'
		   AND SEGMENT = 'MTF'  

	UPDATE #B_MTF_DATA 
    SET    MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL + NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = 'MTFCOLL'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    POAHOLDING = NONCASH,
		   POAHOLDING_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG = 'POA'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMDEBITHOLD = NONCASH,
		   CMDEBITHOLD_MTF = NONCASHMTF
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),
			NONCASHMTF = SUM(CASE WHEN FOGFLAG = 1 THEN QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100 ELSE 0 END)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE
			AND HOLDFLAG = 'BEN'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

	UPDATE #B_MTF_DATA 
    SET    CMOPENPOS = NONCASH
	FROM   (SELECT PARTY_CODE, NONCASH = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100)
			FROM #TBL_PRODUCT_HOLD_DATA
			WHERE SAUDA_DATE = @SAUDA_DATE AND HOLDFLAG = '1 BTST POSITION'
			GROUP BY PARTY_CODE ) A
	WHERE  #B_MTF_DATA.PARTY_CODE = A.PARTY_CODE

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM   ANGELFO.NSEFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    UPDATE #B_MTF_DATA 
    SET    FOMARGIN = TOTALMARGIN--FOMARGIN + SPREADMARGIN + MTOM 
    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C 
    WHERE  MDATE = (SELECT MAX(MDATE) 
                    FROM   ANGELFO.NSECURFO.DBO.FOMARGINNEW C1 
                    WHERE  C1.MDATE <= @SAUDA_DATE + ' 23:59') 
           AND C.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

	DELETE FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_DATA
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA

	DELETE FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_PRODUCT_HOLD_DATA
	SELECT SAUDA_DATE, SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, SEC_PAYIN, START_DATE, 
	ORGQTY, HOLDFLAG, CL_RATE, HAIRCUT, FOGFLAG, MTFHAIRCUT 
	FROM #TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	/*	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,
	MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,FOMARGIN,
	CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,
	CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,
	CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
	FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,
	NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
	CASHDEBITADJ = 0,
	CASHNONCASHADJ = 0,
	FONONCASHADJ = 0,
	CASHLEDADJ = 0,
	FOLEDBALADJ = 0,
	POAADJ = 0
	FROM #B_MTF_DATA*/--ADDED SURESH

/*
    SELECT PARTY_CODE,
           NETFUNDREQ = ( CASE 
                            WHEN SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) > 0 THEN SUM(CASE 
                          WHEN @SAUDA_DATE = SAUDA_DATE THEN MKTAMT - NETAMT 
                 ELSE 0 
                          END) 
                            ELSE SUM(-MARGIN_REQ + MKTAMT) - FOMARGIN + LEDBAL + 
                                 COLLATERAL 
                                 - SUM( 
                                 MTOM_LOSS) 
                          END ) 
    INTO   #B_FUND_REQ 
    FROM   #B_MTF_DATA 
    GROUP  BY PARTY_CODE, 
              FOMARGIN, 
              LEDBAL, 
              COLLATERAL 

    UPDATE #B_MTF_DATA 
    SET    NET_AVL_FUND = NETFUNDREQ 
    FROM   #B_FUND_REQ 
    WHERE  #B_FUND_REQ.PARTY_CODE = #B_MTF_DATA.PARTY_CODE 

    DELETE FROM TBL_PRODUCT_DETAIL 
    WHERE  RUNDATE = @SAUDA_DATE 

    INSERT INTO TBL_PRODUCT_DETAIL 
    SELECT RUNDATE=CONVERT(DATETIME, @SAUDA_DATE), 
           *, 
           PROCESS_ON = GETDATE(), 
           PROCESS_BY = ''
    FROM   #B_MTF_DATA 

    DROP TABLE #B_MTF_DATA 

    DROP TABLE #B_LEDBAL 

    DROP TABLE #B_FUND_REQ 

    DROP TABLE #B_NRML_DATE   
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA
-- --------------------------------------------------

  
  
CREATE PROC [dbo].[PROC_PRODUCT_DATA](  
           @SAUDA_DATE VARCHAR(11))  
AS  
  
SET NOCOUNT ON  
-- EXEC PROC_PRODUCT_DATA 'Sep 18 2019'  
  
DECLARE @PROCESSFLAG INT,  
  @PROCESS_START DATETIME,  
  @PROVPROCESSFLAG INT  
    
SELECT @PROCESS_START = GETDATE()  
  
SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG  
WHERE FUNDING_DATE = @SAUDA_DATE  
  
SELECT @PROVPROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_PROV_LOG  
WHERE FUNDING_DATE = @SAUDA_DATE  
  
SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN   
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE   
  
CREATE CLUSTERED INDEX PARTY ON #PARTY  
(  
 PARTY_CODE  
)  
  
IF @PROCESSFLAG=0 AND @PROVPROCESSFLAG = 0   
BEGIN  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND TRANSTYPE = 'TRNSE'  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND TRANSTYPE = 'TRBSE'  
  
  
  
--MTF TRADES --  
----DELETE TBL_MTF_ORDER WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
  
----INSERT INTO TBL_MTF_ORDER  
----SELECT EXCHNAGE = 'NSE',SEGMENT = 'CAPITAL',SAUDA_DATE,ORDER_NO,SCRIP_CD,SERIES,'SYSTEM',IMPORTED_ON   
----FROM MSAJAG..TRADE_PRODUCT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' And PRODUCT_CODE = 'MTF'  
  
----INSERT INTO TBL_MTF_ORDER  
----SELECT EXCHNAGE = 'BSE',SEGMENT = 'CAPITAL',SAUDA_DATE,ORDER_NO,SCRIP_CD,SERIES,'SYSTEM',IMPORTED_ON   
----FROM BSEDB..TRADE_PRODUCT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' And PRODUCT_CODE = 'MTF'  
--MTF TRADES --  
  
--SELECT * INTO #NSE_MTF FROM MSAJAG.DBO.TBL_CONTRACT_TERMINAL_MAPPING_NSE_MTF N   
---WHERE N.FROM_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
  
---SELECT * INTO #BSE_MTF FROM BSEDB.DBO.TBL_CONTRACT_TERMINAL_MAPPING_BSE_MTF N    
----WHERE N.FROM_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'     
  
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE  
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA  
WHERE 1 = 2   
  
CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA  
(  
 SCRIP_CD,  
 SERIES  
)  
  
INSERT INTO #TBL_PRODUCT_DATA   
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY,   
ISIN = CONVERT(VARCHAR(12),''),  
QTY=SUM(TRADEQTY),  
MKTAMT=SUM(TRADEQTY*MARKETRATE),  
NETAMT=SUM(CASE WHEN SELL_BUY = 1   
    THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
    ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
     END),  
CL_RATE = 0,  
PAYIN_DATE=SM.SEC_PAYIN,  
ADJUST_DATE='DEC 31 2049 23:59',  
TRANSTYPE = 'TRNSE',  
PROCESSDATE=GETDATE()--,  
--TRADE_NO='', Order_No=''  
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P  
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND TRADEQTY > 0   
AND AUCTIONPART NOT LIKE 'F%'  
AND AUCTIONPART NOT LIKE 'A%'  
AND S.SETT_NO = SM.SETT_NO   
AND S.SETT_TYPE = SM.SETT_TYPE   
AND S.SETT_TYPE IN ('N', 'W','M','Z')  
AND P.PARTY_CODE = S.PARTY_CODE  
AND SETTFLAG NOT IN (2,3)  
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES,   
SELL_BUY, SEC_PAYIN   
   
     
INSERT INTO #TBL_PRODUCT_DATA   
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY,   
ISIN = CONVERT(VARCHAR(12),''),  
QTY=SUM(TRADEQTY),  
MKTAMT=SUM(TRADEQTY*MARKETRATE),  
NETAMT=SUM(CASE WHEN SELL_BUY = 1   
    THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
    ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
     END),  
CL_RATE = 0,  
PAYIN_DATE=SM.SEC_PAYIN,  
ADJUST_DATE='DEC 31 2049 23:59',  
TRANSTYPE = 'TRBSE',  
PROCESSDATE=GETDATE()--,  
--TRADE_NO='', Order_No=''  
FROM BSEDB_AB.DBO.SETTLEMENT S, BSEDB_AB.DBO.SETT_MST SM, #PARTY P  
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND TRADEQTY > 0   
AND AUCTIONPART NOT LIKE 'F%'  
AND AUCTIONPART NOT LIKE 'A%'  
AND S.SETT_NO = SM.SETT_NO   
AND S.SETT_TYPE = SM.SETT_TYPE  
AND S.SETT_TYPE IN ('D', 'C', 'RD','RC')  
AND P.PARTY_CODE = S.PARTY_CODE  
AND SETTFLAG NOT IN (2,3)  
--AND PRODUCT_CODE = 'NRML'  
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES,   
SELL_BUY, SEC_PAYIN  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M  
WHERE M.NSE_SCRIP_CD = #TBL_PRODUCT_DATA.SCRIP_CD  
AND M.NSE_SERIES = #TBL_PRODUCT_DATA.SERIES   
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M  
WHERE M.BSECODE = #TBL_PRODUCT_DATA.SCRIP_CD  
AND M.BSECODE <> ''  
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM MSAJAGDEMAT.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.SCRIP_CD IN ('BE','EQ','BZ')  
AND #TBL_PRODUCT_DATA.SERIES IN ('BE','EQ','BZ')  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.ISIN = ''  
AND TRANSTYPE = 'TRNSE'  
  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM MSAJAGDEMAT.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.Scrip_cd  
AND #TBL_PRODUCT_DATA.SERIES = M.Series  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.ISIN = ''  
AND TRANSTYPE = 'TRNSE'  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM BSEDB.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.BSECODE = M.Scrip_cd   
AND VALID = 1   
AND #TBL_PRODUCT_DATA.ISIN = ''  
AND TRANSTYPE = 'TRBSE'  
  
UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.Scrip_cd,6)  
FROM BSEDB.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.BSECODE = ''  
  
UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.Scrip_cd, SERIES = M.Series   
FROM MSAJAGDEMAT.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''  
  
SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'  
  
UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE  
FROM #NSECLOSING C  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD  
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES  
AND #TBL_PRODUCT_DATA.CL_RATE = 0  
AND SAUDA_DATE = LEFT(SYSDATE,11)  
  
SELECT * INTO #BSECLOSING FROM BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'  
  
CREATE INDEX #BSE ON #BSECLOSING  
(SCRIP_CD,SYSDATE)  
  
UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE  
FROM #BSECLOSING C  
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE  
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD  
AND #TBL_PRODUCT_DATA.CL_RATE = 0  
AND SAUDA_DATE = LEFT(SYSDATE,11)   
  
----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817  
  /*
SELECT * INTO #SQOFF FROM MTF_SQUP_DETAILS  
WHERE PARTY_CODE IN (  
SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE  
AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2  
AND left(EXCHANGE,3)= right(TRANSTYPE,3))  
AND @SAUDA_DATE =LEFT(PROCESSDATE,11)  
  
UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)  
FROM #SQOFF  
WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE  
AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN   
AND SELL_BUY = 2   
AND left(EXCHANGE,3)= right(TRANSTYPE,3)  
*/
  
DELETE FROM #TBL_PRODUCT_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY <= 0   
  
DELETE FROM #TBL_PRODUCT_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)  
AND SELL_BUY = 1   
  
UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)  
WHERE SAUDA_DATE = @SAUDA_DATE  
  
INSERT INTO TBL_PRODUCT_DATA  
SELECT * FROM #TBL_PRODUCT_DATA  
  
--INSERT INTO MTF_SQUP_DETAILS_LOG  
--SELECT *,GETDATE() FROM #SQOFF  
  
-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817  
  
END  
  
EXEC PROC_PRODUCT_SALE_ADJUST  @SAUDA_DATE  
  
--IF @PROCESSFLAG = 0   
--BEGIN  
 EXEC PROC_PRODUCT_PROCESS   @SAUDA_DATE  
--END     
  
EXEC PROC_MTFBILLPOST    @SAUDA_DATE  
  
--EXEC PROC_PRODUCT_BUY_ADJUST  @SAUDA_DATE    
EXEC PROC_PRODUCT_BUY_ADJUST_NEWMTF @SAUDA_DATE  ---- NEW MTF CHANGES ---
  
EXEC PROC_PRODUCT_PFADJUST   @SAUDA_DATE, 0    
EXEC PROC_PRODUCT_PFADJUST_NEWMTF @SAUDA_DATE, 0  ---- NEW MTF CHANGES ---
  
INSERT INTO TBL_MTF_DATA_LOG  
  
SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,  
  
  FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,  
  
  CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,FOCASHEQCOLLATERAL,  
  
  FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,  
  
  CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ, RUNDATE=GETDATE()  
  
FROM TBL_MTF_DATA  
  
WHERE SAUDA_DATE = @SAUDA_DATE  
  
IF @PROCESSFLAG = 0   
BEGIN  
 TRUNCATE TABLE TBL_PRODUCT_POSITION_TMP  
  
 --INSERT INTO TBL_PRODUCT_POSITION_TMP  
 --SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,SELL_BUY,  
 --    ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE,TRADE_NO, Order_No  
 --FROM  TBL_PRODUCT_POSITION   
 --   WHERE  SAUDA_DATE = @SAUDA_DATE    
 --          AND SELL_BUY = 1  
   
 --EXEC PROC_PRODUCT_REQSHORT_ADJUST @SAUDA_DATE  
 --EXEC PROC_PRODUCT_BUY_ADJUST @SAUDA_DATE, 2  
 EXEC PROC_PRODUCT_BUY_ADJUST_NEWMTF @SAUDA_DATE, 2	---- NEW MTF CHANGES ---
 EXEC PROC_PRODUCT_PFADJUST  @SAUDA_DATE, 1  
 EXEC PROC_PRODUCT_PFADJUST_NEWMTF @SAUDA_DATE, 1		---- NEW MTF CHANGES ---
END  
  
   
EXEC DELIVERY_INTEROP_MTF @SAUDA_DATE  
  
IF @PROCESSFLAG = 0   
BEGIN   
 EXEC MTF_POS_RECO_DET @SAUDA_DATE, 'NON RECO', '%', '%', 1  
 --EXEC MSAJAG.DBO.MTF_POOL_BEN_ADJUST @SAUDA_DATE  
END  
  
EXEC PROC_PRODUCT_LEDGER_ADJUST @SAUDA_DATE, 0  
  
EXEC RPT_NSE_MTFFILE @SAUDA_DATE, 1, ''   
EXEC RPT_NSE_MTFFILE_NEWMTF @SAUDA_DATE, 1, ''		---- NEW MTF CHANGES ---
  
  
INSERT INTO TBL_MTF_DATA_LOG  
  
SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,  
  
  FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,  
  
  CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,FOCASHEQCOLLATERAL,  
  
  FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,  
  
  CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ, RUNDATE=GETDATE()   
  
FROM TBL_MTF_DATA  
  
WHERE SAUDA_DATE = @SAUDA_DATE  
  
INSERT INTO TBL_MTF_LOG  
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()  
  
SELECT FLAG = 1, MSG = 'PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_14082017
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_PRODUCT_DATA_14082017](
           @SAUDA_DATE VARCHAR(11))
AS

-- EXEC PROC_PRODUCT_DATA 'AUG  1 2017'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

INSERT INTO TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
		 SELL_BUY, SEC_PAYIN

INSERT INTO TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S, ANAND.BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
		 SELL_BUY, SEC_PAYIN

UPDATE TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.SCRIP_CD = M.SCRIP_CD
AND TBL_PRODUCT_DATA.SERIES = M.SERIES
AND VALID = 1 
AND TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.BSECODE = M.SCRIP_CD 
AND VALID = 1 
AND TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE TBL_PRODUCT_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND TBL_PRODUCT_DATA.BSECODE = ''

UPDATE TBL_PRODUCT_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM angeldemat.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND TBL_PRODUCT_DATA.SCRIP_CD = ''

UPDATE TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM MSAJAG.DBO.CLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND TBL_PRODUCT_DATA.SERIES = C.SERIES
AND TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

UPDATE TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM ANAND.BSEDB_AB.DBO.CLOSING C
WHERE SAUDA_DATE   BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

DELETE FROM TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

EXEC PROC_PRODUCT_SALE_ADJUST @SAUDA_DATE
EXEC PROC_PRODUCT_PROCESS @SAUDA_DATE
EXEC PROC_PRODUCT_BUY_ADJUST @SAUDA_DATE

IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_PFADJUST @SAUDA_DATE
END
ELSE
BEGIN
	EXEC PROC_PRODUCT_PFADJUST @SAUDA_DATE, 0
END
EXEC PROC_MTFBILLPOST @SAUDA_DATE

EXEC RPT_NSE_MTFFILE @SAUDA_DATE, 1

INSERT INTO TBL_MTF_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

SELECT FLAG = 1, MSG = 'PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_BAK_27092018
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_PRODUCT_DATA_BAK_27092018](
           @SAUDA_DATE VARCHAR(11))
AS

-- EXEC PROC_PRODUCT_DATA 'AUG 24 2017'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

INSERT INTO TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
		 SELL_BUY, SEC_PAYIN

INSERT INTO TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S, ANAND.BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
		 SELL_BUY, SEC_PAYIN


UPDATE TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.SCRIP_CD = M.SCRIP_CD
AND TBL_PRODUCT_DATA.SERIES IN ('EQ','BE','BZ') 
and M.SERIES IN ('EQ','BE','BZ')
AND VALID = 1 
AND TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.SCRIP_CD = M.SCRIP_CD
AND TBL_PRODUCT_DATA.SERIES = M.SERIES
AND VALID = 1 
AND TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.BSECODE = M.SCRIP_CD 
AND VALID = 1 
AND TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE TBL_PRODUCT_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND TBL_PRODUCT_DATA.BSECODE = ''

UPDATE TBL_PRODUCT_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM angeldemat.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND TBL_PRODUCT_DATA.SCRIP_CD = ''

UPDATE TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM MSAJAG.DBO.CLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND TBL_PRODUCT_DATA.SERIES = C.SERIES
AND TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

UPDATE TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM ANAND.BSEDB_AB.DBO.CLOSING C
WHERE SAUDA_DATE  =@SAUDA_DATE
AND TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

DELETE FROM TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

UPDATE TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)
WHERE SAUDA_DATE = @SAUDA_DATE

EXEC PROC_PRODUCT_SALE_ADJUST @SAUDA_DATE
IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_PROCESS @SAUDA_DATE
END

IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_LED_ADJUST @SAUDA_DATE
	
	EXEC PROC_PRODUCT_PROCESS @SAUDA_DATE
END

EXEC PROC_PRODUCT_BUY_ADJUST @SAUDA_DATE, @PROCESSFLAG

IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_PFADJUST @SAUDA_DATE
END
ELSE
BEGIN
	EXEC PROC_PRODUCT_PFADJUST @SAUDA_DATE, 0
END
EXEC PROC_MTFBILLPOST @SAUDA_DATE

EXEC RPT_NSE_MTFFILE @SAUDA_DATE, 1
IF @PROCESSFLAG = 0 
BEGIN
	EXEC MTF_POS_RECO_DET @SAUDA_DATE, 'NON RECO', '%', '%', 1
	EXEC ANGELDEMAT.MSAJAG.DBO.MTF_POOL_BEN_ADJUST @SAUDA_DATE
END
INSERT INTO TBL_MTF_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

SELECT FLAG = 1, MSG = 'PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_bak_nov282019
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_PRODUCT_DATA](
           @SAUDA_DATE VARCHAR(11))
AS

-- EXEC PROC_PRODUCT_DATA 'AUG 24 2017'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'

SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA
WHERE 1 = 2

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA
(
	SCRIP_CD,
	SERIES
)

INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
		 SELL_BUY, SEC_PAYIN

INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S, ANAND.BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
		 SELL_BUY, SEC_PAYIN


UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES IN ('EQ','BE','BZ') 
and M.SERIES IN ('EQ','BE','BZ')
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES = M.SERIES
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.BSECODE = M.SCRIP_CD 
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.BSECODE = ''

UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM angeldemat.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''


SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #NSECLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

/** Changes done for optimze 

UPDATE TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM ANAND.BSEDB_AB.DBO.CLOSING C
WHERE SAUDA_DATE  =@SAUDA_DATE
AND TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

 *******/

SELECT * INTO #BSECLOSING FROM ANAND.BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

 

CREATE INDEX #BSE ON #BSECLOSING
(SCRIP_CD,SYSDATE)


UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #BSECLOSING C
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11) 


----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817

SELECT * INTO #SQOFF FROM MTF_SQUP_DETAILS
WHERE PARTY_CODE IN (
SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE
AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2
AND left(EXCHANGE,3)= right(TRANSTYPE,3))

UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)
FROM #SQOFF
WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE
AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN 
AND SELL_BUY = 2 
AND left(EXCHANGE,3)= right(TRANSTYPE,3)

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND QTY <= 0 


-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817


DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_PRODUCT_DATA
SELECT * FROM #TBL_PRODUCT_DATA

EXEC PROC_PRODUCT_SALE_ADJUST @SAUDA_DATE

IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_PROCESS @SAUDA_DATE
END

IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_LED_ADJUST @SAUDA_DATE
	
	EXEC PROC_PRODUCT_PROCESS @SAUDA_DATE
END

IF @SAUDA_DATE = 'JUN 17 2019' 
BEGIN
	EXEC PROC_PRODUCT_PROCESS @SAUDA_DATE
END

EXEC PROC_PRODUCT_BUY_ADJUST @SAUDA_DATE, @PROCESSFLAG

IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_PFADJUST @SAUDA_DATE
END
ELSE
BEGIN
	EXEC PROC_PRODUCT_PFADJUST @SAUDA_DATE, 0
END
EXEC PROC_MTFBILLPOST @SAUDA_DATE

EXEC RPT_NSE_MTFFILE @SAUDA_DATE, 1

IF @PROCESSFLAG = 0 
BEGIN
	EXEC PROC_PRODUCT_LEDGER_ADJUST @SAUDA_DATE, 0
END

EXEC MTF_POS_RECO_DET @SAUDA_DATE, 'NON RECO', '%', '%', 1

IF @PROCESSFLAG = 0 
BEGIN
	EXEC ANGELDEMAT.MSAJAG.DBO.MTF_POOL_BEN_ADJUST @SAUDA_DATE
END
INSERT INTO TBL_MTF_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

SELECT FLAG = 1, MSG = 'PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_BKUP_05SEP2025
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[PROC_PRODUCT_DATA](  
           @SAUDA_DATE VARCHAR(11))  
AS  
  
SET NOCOUNT ON  
-- EXEC PROC_PRODUCT_DATA 'Sep 18 2019'  
  
DECLARE @PROCESSFLAG INT,  
  @PROCESS_START DATETIME,  
  @PROVPROCESSFLAG INT  
    
SELECT @PROCESS_START = GETDATE()  
  
SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG  
WHERE FUNDING_DATE = @SAUDA_DATE  
  
SELECT @PROVPROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_PROV_LOG  
WHERE FUNDING_DATE = @SAUDA_DATE  
  
SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN   
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE   
  
CREATE CLUSTERED INDEX PARTY ON #PARTY  
(  
 PARTY_CODE  
)  
  
IF @PROCESSFLAG=0 AND @PROVPROCESSFLAG = 0   
BEGIN  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND TRANSTYPE = 'TRNSE'  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND TRANSTYPE = 'TRBSE'  
  
  
  
--MTF TRADES --  
----DELETE TBL_MTF_ORDER WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
  
----INSERT INTO TBL_MTF_ORDER  
----SELECT EXCHNAGE = 'NSE',SEGMENT = 'CAPITAL',SAUDA_DATE,ORDER_NO,SCRIP_CD,SERIES,'SYSTEM',IMPORTED_ON   
----FROM MSAJAG..TRADE_PRODUCT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' And PRODUCT_CODE = 'MTF'  
  
----INSERT INTO TBL_MTF_ORDER  
----SELECT EXCHNAGE = 'BSE',SEGMENT = 'CAPITAL',SAUDA_DATE,ORDER_NO,SCRIP_CD,SERIES,'SYSTEM',IMPORTED_ON   
----FROM BSEDB..TRADE_PRODUCT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' And PRODUCT_CODE = 'MTF'  
--MTF TRADES --  
  
--SELECT * INTO #NSE_MTF FROM MSAJAG.DBO.TBL_CONTRACT_TERMINAL_MAPPING_NSE_MTF N   
---WHERE N.FROM_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
  
---SELECT * INTO #BSE_MTF FROM BSEDB.DBO.TBL_CONTRACT_TERMINAL_MAPPING_BSE_MTF N    
----WHERE N.FROM_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'     
  
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE  
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA  
WHERE 1 = 2   
  
CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA  
(  
 SCRIP_CD,  
 SERIES  
)  
  
INSERT INTO #TBL_PRODUCT_DATA   
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY,   
ISIN = CONVERT(VARCHAR(12),''),  
QTY=SUM(TRADEQTY),  
MKTAMT=SUM(TRADEQTY*MARKETRATE),  
NETAMT=SUM(CASE WHEN SELL_BUY = 1   
    THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
    ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
     END),  
CL_RATE = 0,  
PAYIN_DATE=SM.SEC_PAYIN,  
ADJUST_DATE='DEC 31 2049 23:59',  
TRANSTYPE = 'TRNSE',  
PROCESSDATE=GETDATE()--,  
--TRADE_NO='', Order_No=''  
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P  
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND TRADEQTY > 0   
AND AUCTIONPART NOT LIKE 'F%'  
AND AUCTIONPART NOT LIKE 'A%'  
AND S.SETT_NO = SM.SETT_NO   
AND S.SETT_TYPE = SM.SETT_TYPE   
AND S.SETT_TYPE IN ('N', 'W','M','Z')  
AND P.PARTY_CODE = S.PARTY_CODE  
AND SETTFLAG NOT IN (2,3)  
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES,   
SELL_BUY, SEC_PAYIN   
   
     
INSERT INTO #TBL_PRODUCT_DATA   
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY,   
ISIN = CONVERT(VARCHAR(12),''),  
QTY=SUM(TRADEQTY),  
MKTAMT=SUM(TRADEQTY*MARKETRATE),  
NETAMT=SUM(CASE WHEN SELL_BUY = 1   
    THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
    ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG)   
     END),  
CL_RATE = 0,  
PAYIN_DATE=SM.SEC_PAYIN,  
ADJUST_DATE='DEC 31 2049 23:59',  
TRANSTYPE = 'TRBSE',  
PROCESSDATE=GETDATE()--,  
--TRADE_NO='', Order_No=''  
FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT S, AngelBSECM.BSEDB_AB.DBO.SETT_MST SM, #PARTY P  
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND TRADEQTY > 0   
AND AUCTIONPART NOT LIKE 'F%'  
AND AUCTIONPART NOT LIKE 'A%'  
AND S.SETT_NO = SM.SETT_NO   
AND S.SETT_TYPE = SM.SETT_TYPE  
AND S.SETT_TYPE IN ('D', 'C', 'RD','RC')  
AND P.PARTY_CODE = S.PARTY_CODE  
AND SETTFLAG NOT IN (2,3)  
--AND PRODUCT_CODE = 'NRML'  
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES,   
SELL_BUY, SEC_PAYIN  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M  
WHERE M.NSE_SCRIP_CD = #TBL_PRODUCT_DATA.SCRIP_CD  
AND M.NSE_SERIES = #TBL_PRODUCT_DATA.SERIES   
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M  
WHERE M.BSECODE = #TBL_PRODUCT_DATA.SCRIP_CD  
AND M.BSECODE <> ''  
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.SCRIP_CD IN ('BE','EQ','BZ')  
AND #TBL_PRODUCT_DATA.SERIES IN ('BE','EQ','BZ')  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.ISIN = ''  
AND TRANSTYPE = 'TRNSE'  
  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.Scrip_cd  
AND #TBL_PRODUCT_DATA.SERIES = M.Series  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.ISIN = ''  
AND TRANSTYPE = 'TRNSE'  
  
UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN  
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.BSECODE = M.Scrip_cd   
AND VALID = 1   
AND #TBL_PRODUCT_DATA.ISIN = ''  
AND TRANSTYPE = 'TRBSE'  
  
UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.Scrip_cd,6)  
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.BSECODE = ''  
  
UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.Scrip_cd, SERIES = M.Series   
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN  
AND VALID = 1   
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''  
  
SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'  
  
UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE  
FROM #NSECLOSING C  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD  
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES  
AND #TBL_PRODUCT_DATA.CL_RATE = 0  
AND SAUDA_DATE = LEFT(SYSDATE,11)  
  
SELECT * INTO #BSECLOSING FROM AngelBSECM.BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'  
  
CREATE INDEX #BSE ON #BSECLOSING  
(SCRIP_CD,SYSDATE)  
  
UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE  
FROM #BSECLOSING C  
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE  
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD  
AND #TBL_PRODUCT_DATA.CL_RATE = 0  
AND SAUDA_DATE = LEFT(SYSDATE,11)   
  
----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817  
  
SELECT * INTO #SQOFF FROM MTF_SQUP_DETAILS  
WHERE PARTY_CODE IN (  
SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE  
AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2  
AND left(EXCHANGE,3)= right(TRANSTYPE,3))  
AND @SAUDA_DATE =LEFT(PROCESSDATE,11)  
  
UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)  
FROM #SQOFF  
WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE  
AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN   
AND SELL_BUY = 2   
AND left(EXCHANGE,3)= right(TRANSTYPE,3)  
  
DELETE FROM #TBL_PRODUCT_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY <= 0   
  
DELETE FROM #TBL_PRODUCT_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)  
AND SELL_BUY = 1   
  
UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)  
WHERE SAUDA_DATE = @SAUDA_DATE  
  
INSERT INTO TBL_PRODUCT_DATA  
SELECT * FROM #TBL_PRODUCT_DATA  
  
INSERT INTO MTF_SQUP_DETAILS_LOG  
SELECT *,GETDATE() FROM #SQOFF  
  
-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817  
  
END  
  
EXEC PROC_PRODUCT_SALE_ADJUST  @SAUDA_DATE  
  
--IF @PROCESSFLAG = 0   
--BEGIN  
 EXEC PROC_PRODUCT_PROCESS   @SAUDA_DATE  
--END     
  
EXEC PROC_MTFBILLPOST    @SAUDA_DATE  
  
EXEC PROC_PRODUCT_BUY_ADJUST  @SAUDA_DATE  
  
--EXEC PROC_PRODUCT_PFADJUST   @SAUDA_DATE, 0  
  
INSERT INTO TBL_MTF_DATA_LOG  
  
SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,  
  
  FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,  
  
  CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,FOCASHEQCOLLATERAL,  
  
  FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,  
  
  CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ, RUNDATE=GETDATE()  
  
FROM TBL_MTF_DATA  
  
WHERE SAUDA_DATE = @SAUDA_DATE  
  
IF @PROCESSFLAG = 0   
BEGIN  
 TRUNCATE TABLE TBL_PRODUCT_POSITION_TMP  
  
 --INSERT INTO TBL_PRODUCT_POSITION_TMP  
 --SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,SELL_BUY,  
 --    ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE,TRADE_NO, Order_No  
 --FROM  TBL_PRODUCT_POSITION   
 --   WHERE  SAUDA_DATE = @SAUDA_DATE    
 --          AND SELL_BUY = 1  
   
 --EXEC PROC_PRODUCT_REQSHORT_ADJUST @SAUDA_DATE  
 --EXEC PROC_PRODUCT_BUY_ADJUST @SAUDA_DATE, 2  
 EXEC PROC_PRODUCT_PFADJUST  @SAUDA_DATE, 1  
END  
  
   
EXEC DELIVERY_INTEROP_MTF @SAUDA_DATE  
  
IF @PROCESSFLAG = 0   
BEGIN   
 EXEC MTF_POS_RECO_DET @SAUDA_DATE, 'NON RECO', '%', '%', 1  
 --EXEC MSAJAG.DBO.MTF_POOL_BEN_ADJUST @SAUDA_DATE  
END  
  
EXEC PROC_PRODUCT_LEDGER_ADJUST @SAUDA_DATE, 0  
  
EXEC RPT_NSE_MTFFILE @SAUDA_DATE, 1, ''   
  
  
INSERT INTO TBL_MTF_DATA_LOG  
  
SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,  
  
  FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,  
  
  CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,FOCASHEQCOLLATERAL,  
  
  FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,  
  
  CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ, RUNDATE=GETDATE()   
  
FROM TBL_MTF_DATA  
  
WHERE SAUDA_DATE = @SAUDA_DATE  
  
INSERT INTO TBL_MTF_LOG  
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()  
  
SELECT FLAG = 1, MSG = 'PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_BKUP_25Nov2022
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_PRODUCT_DATA_BKUP_25Nov2022](
           @SAUDA_DATE VARCHAR(11))
AS

SET NOCOUNT ON
-- EXEC PROC_PRODUCT_DATA 'Sep 18 2019'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME,
		@PROVPROCESSFLAG	INT
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

SELECT @PROVPROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_PROV_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

IF @PROCESSFLAG=0 AND @PROVPROCESSFLAG = 0 
BEGIN
DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'



--MTF TRADES --
----DELETE TBL_MTF_ORDER WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'

----INSERT INTO TBL_MTF_ORDER
----SELECT EXCHNAGE = 'NSE',SEGMENT = 'CAPITAL',SAUDA_DATE,ORDER_NO,SCRIP_CD,SERIES,'SYSTEM',IMPORTED_ON 
----FROM MSAJAG..TRADE_PRODUCT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' And PRODUCT_CODE = 'MTF'

----INSERT INTO TBL_MTF_ORDER
----SELECT EXCHNAGE = 'BSE',SEGMENT = 'CAPITAL',SAUDA_DATE,ORDER_NO,SCRIP_CD,SERIES,'SYSTEM',IMPORTED_ON 
----FROM BSEDB..TRADE_PRODUCT WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' And PRODUCT_CODE = 'MTF'
--MTF TRADES --

--SELECT * INTO #NSE_MTF FROM MSAJAG.DBO.TBL_CONTRACT_TERMINAL_MAPPING_NSE_MTF N 
---WHERE N.FROM_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'

---SELECT * INTO #BSE_MTF FROM BSEDB.DBO.TBL_CONTRACT_TERMINAL_MAPPING_BSE_MTF N  
----WHERE N.FROM_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'   

SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA
WHERE 1 = 2 

CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA
(
	SCRIP_CD,
	SERIES
)

INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN 
	
		 
INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S, ANAND.BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.NSE_SCRIP_CD = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.NSE_SERIES = #TBL_PRODUCT_DATA.SERIES 
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.BSECODE = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.BSECODE <> ''
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD IN ('BE','EQ','BZ')
AND #TBL_PRODUCT_DATA.SERIES IN ('BE','EQ','BZ')
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'


UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.Scrip_cd
AND #TBL_PRODUCT_DATA.SERIES = M.Series
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.BSECODE = M.Scrip_cd 
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.Scrip_cd,6)
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.BSECODE = ''

UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.Scrip_cd, SERIES = M.Series 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''

SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #NSECLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

SELECT * INTO #BSECLOSING FROM ANAND.BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

CREATE INDEX #BSE ON #BSECLOSING
(SCRIP_CD,SYSDATE)

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #BSECLOSING C
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11) 

----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817

SELECT * INTO #SQOFF FROM MTF_SQUP_DETAILS
WHERE PARTY_CODE IN (
SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE
AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2
AND left(EXCHANGE,3)= right(TRANSTYPE,3))
AND @SAUDA_DATE =LEFT(PROCESSDATE,11)

UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)
FROM #SQOFF
WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE
AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN 
AND SELL_BUY = 2 
AND left(EXCHANGE,3)= right(TRANSTYPE,3)

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND QTY <= 0 

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_PRODUCT_DATA
SELECT * FROM #TBL_PRODUCT_DATA

INSERT INTO MTF_SQUP_DETAILS_LOG
SELECT *,GETDATE() FROM #SQOFF

-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817

END

EXEC PROC_PRODUCT_SALE_ADJUST		@SAUDA_DATE

--IF @PROCESSFLAG = 0 
--BEGIN
	EXEC PROC_PRODUCT_PROCESS			@SAUDA_DATE
--END   

EXEC PROC_MTFBILLPOST				@SAUDA_DATE

EXEC PROC_PRODUCT_BUY_ADJUST		@SAUDA_DATE

--EXEC PROC_PRODUCT_PFADJUST			@SAUDA_DATE, 0

INSERT INTO TBL_MTF_DATA_LOG

SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,

		FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,

		CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,FOCASHEQCOLLATERAL,

		FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,

		CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ, RUNDATE=GETDATE()

FROM TBL_MTF_DATA

WHERE SAUDA_DATE = @SAUDA_DATE

IF @PROCESSFLAG = 0 
BEGIN
	TRUNCATE TABLE TBL_PRODUCT_POSITION_TMP

	--INSERT INTO TBL_PRODUCT_POSITION_TMP
	--SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,SELL_BUY,
	--	   ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE,TRADE_NO, Order_No
	--FROM  TBL_PRODUCT_POSITION 
 --   WHERE  SAUDA_DATE = @SAUDA_DATE  
 --          AND SELL_BUY = 1
	
	--EXEC PROC_PRODUCT_REQSHORT_ADJUST	@SAUDA_DATE
	--EXEC PROC_PRODUCT_BUY_ADJUST	@SAUDA_DATE, 2
	EXEC PROC_PRODUCT_PFADJUST		@SAUDA_DATE, 1
END

 
EXEC DELIVERY_INTEROP_MTF @SAUDA_DATE

IF @PROCESSFLAG = 0 
BEGIN 
	EXEC MTF_POS_RECO_DET @SAUDA_DATE, 'NON RECO', '%', '%', 1
	--EXEC MSAJAG.DBO.MTF_POOL_BEN_ADJUST @SAUDA_DATE
END

EXEC PROC_PRODUCT_LEDGER_ADJUST @SAUDA_DATE, 0

EXEC RPT_NSE_MTFFILE @SAUDA_DATE, 1, '' 


INSERT INTO TBL_MTF_DATA_LOG

SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,

		FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,

		CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,FOCASHEQCOLLATERAL,

		FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,

		CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ, RUNDATE=GETDATE() 

FROM TBL_MTF_DATA

WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_MTF_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

SELECT FLAG = 1, MSG = 'PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_PROV
-- --------------------------------------------------

--Altered this SP under SRE-36105

CREATE PROC [dbo].[PROC_PRODUCT_DATA_PROV](
           @SAUDA_DATE VARCHAR(11))
AS

SET NOCOUNT ON
-- EXEC PROC_PRODUCT_DATA 'Sep 18 2019'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

IF @PROCESSFLAG > 0 
BEGIN
	SELECT FLAG = 1, MSG = 'ACTUAL MTF PROCESS ALREADY DONE.'
	RETURN
END 

IF @PROCESSFLAG=0
BEGIN
DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'

 
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA
WHERE 1 = 2 

CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA
(
	SCRIP_CD,
	SERIES
)

INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W', 'M','Z')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
AND S.SERIES NOT IN('RR','BE','IV') AND SELL_BUY=2
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN 
	
		 
INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM BSEDB_AB.DBO.SETTLEMENT S, BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C', 'RC','RD')
AND P.PARTY_CODE = S.PARTY_CODE AND SELL_BUY=2
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN

/***************** START MTF PARTIAL BOOKING STATRT -SRE-35713  ------------------***********/
DECLARE @SETT_NO VARCHAR(10) 
 
SELECT @SETT_NO =SETT_NO FROM MSAJAG.DBO.SETT_MST WHERE START_DATE =@SAUDA_DATE AND SETT_TYPE IN ('M')

SELECT PARTY_CODE,SUM(QTY) QTY , ISIN,VALID INTO  #POS_VERIFY FROM MTF_PURCHASE_DATA  WHERE TRADEDATE =@SAUDA_DATE
GROUP BY PARTY_CODE,ISIN,VALID

CREATE INDEX #PARTY ON #POS_VERIFY(PARTY_CODE,ISIN)

UPDATE P SET VALID=1 FROM #POS_VERIFY P WHERE EXISTS (
SELECT * FROM MSAJAG.DBO.DELIVERYCLT D WHERE D.PARTY_CODE =P.PARTY_CODE AND ISIN =I_ISIN AND SETT_NO=@SETT_NO AND P.QTY<=D.QTY AND INOUT='O') 

--/**** Added to Avoid poor Scrip and Out side DP Start *********/
--UPDATE A SET VALID=0 FROM #POS_VERIFY A  
--WHERE  EXISTS (SELECT ISIN  FROM [CSOKYC-6].GENERAL.DBO.SCRIPCATG R WHERE CATEGORY IN('POOR')  AND R.ISIN=A.ISIN)

--UPDATE A SET VALID=0 FROM #POS_VERIFY A  
--WHERE  EXISTS (SELECT CL_CODE  FROM ANGELDEMAT.MSAJAG.DBO.CLIENT4 R (NOLOCK) WHERE R.CL_CODE=A.PARTY_CODE AND BANKID NOT IN 
--( SELECT BANKID FROM MSAJAG.DBO.BANK WHERE BANKNAME LIKE 'ANGEL%') AND DEPOSITORY IN ('CDSL','NSDL') AND DEFDP='1')

--/**** Added to Avoid poor Scrip and Out side DP Start END *********/



UPDATE P SET VALID=1 FROM MTF_PURCHASE_DATA P WHERE EXISTS (
SELECT * FROM #POS_VERIFY D WHERE D.PARTY_CODE =P.PARTY_CODE AND D.ISIN =P.ISIN AND D.VALID=1)  AND TRADEDATE =@SAUDA_DATE

UPDATE MTF_PURCHASE_DATA SET BSECODE = LEFT(M.SCRIP_CD,6)
FROM  BSEDB_AB.DBO.MULTIISIN M
WHERE TRADEDATE  =@SAUDA_DATE
AND MTF_PURCHASE_DATA.ISIN = M.ISIN
AND M.VALID = 1 
 

UPDATE MTF_PURCHASE_DATA SET SCRIP_CD = M.SCRIP_CD,SERIES =M.SERIES
FROM  MSAJAG.DBO.MULTIISIN M
WHERE TRADEDATE  =@SAUDA_DATE
AND MTF_PURCHASE_DATA.ISIN = M.ISIN
AND M.VALID = 1 
 AND MTF_PURCHASE_DATA.SCRIP_CD IS NULL



INSERT INTO #TBL_PRODUCT_DATA
SELECT SAUDA_DATE = LEFT(TRADEDATE,11), SETT_NO, SETT_TYPE, PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD  , SERIES  , BSECODE  , SELL_BUY,
ISIN  ,
QTY ,
MKTAMT ,
NETAMT,
CL_RATE = 0,
PAYIN_DATE ,
ADJUST_DATE='DEC 31 2049 23:59',
EXCHANGE ='TR'+EXCHANGE, 
PROCESSDATE=GETDATE() FROM  MTF_PURCHASE_DATA M WHERE TRADEDATE =@SAUDA_DATE AND  VALID=1

/********************* END***********************************/

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.NSE_SCRIP_CD = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.NSE_SERIES = #TBL_PRODUCT_DATA.SERIES 
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.BSECODE = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.BSECODE <> ''
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM  MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD IN ('BE','EQ','BZ')
AND #TBL_PRODUCT_DATA.SERIES IN ('BE','EQ','BZ')
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'


UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM  MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.Scrip_cd
AND #TBL_PRODUCT_DATA.SERIES = M.Series
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM  BSEDB_AB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.BSECODE = M.Scrip_cd 
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.Scrip_cd,6)
FROM BSEDB_AB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.BSECODE = ''

UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.Scrip_cd, SERIES = M.Series 
FROM  MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''

SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #NSECLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

SELECT * INTO #BSECLOSING FROM  BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

CREATE INDEX #BSE ON #BSECLOSING
(SCRIP_CD,SYSDATE)

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #BSECLOSING C
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11) 

----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817
 

--SELECT 
--PARTY_CODE,	ISIN,	SCRIP_CD,	SERIES,	EXCHANGE,	SQQTY,	processdate
--INTO #SQOFF FROM MTF_SQUP_DETAILS
--WHERE PARTY_CODE IN (
--SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA
--WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE
--AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2
--AND left(EXCHANGE,3)= right(TRANSTYPE,3))
--AND @SAUDA_DATE =LEFT(PROCESSDATE,11)

--UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)
--FROM #SQOFF
--WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE
--AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN 
--AND SELL_BUY = 2 
--AND left(EXCHANGE,3)= right(TRANSTYPE,3)

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND QTY <= 0 

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_PRODUCT_DATA
SELECT * FROM #TBL_PRODUCT_DATA

--INSERT INTO MTF_SQUP_DETAILS_LOG
--SELECT *,GETDATE() FROM #SQOFF

-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817

END
  
EXEC PROC_PRODUCT_PROCESS			@SAUDA_DATE
   
EXEC DELIVERY_INTEROP_MTF @SAUDA_DATE

--EXEC ANGELDEMAT.MSAJAG.DBO.MTF_STATUS_UPD @SAUDA_DATE
 
 

INSERT INTO TBL_MTF_PROV_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

--Added below Logic on 31st Nov 2023 to avoid manual execution by BO team

---EXEC MSAJAG.DBO.USP_PROV_MTF_INSERT


SELECT FLAG = 1, MSG = 'PROVISIONAL PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_PROV_BKP_20250412
-- --------------------------------------------------



CREATE PROC [dbo].[PROC_PRODUCT_DATA_PROV_BKP_20250412](
           @SAUDA_DATE VARCHAR(11))
AS

SET NOCOUNT ON
-- EXEC PROC_PRODUCT_DATA 'Sep 18 2019'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

IF @PROCESSFLAG > 0 
BEGIN
	SELECT FLAG = 1, MSG = 'ACTUAL MTF PROCESS ALREADY DONE.'
	RETURN
END 

IF @PROCESSFLAG=0
BEGIN
DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'

 
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA
WHERE 1 = 2 

CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA
(
	SCRIP_CD,
	SERIES
)

INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W', 'M','Z')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
AND S.SERIES NOT IN('RR','BE','IV')
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN 
	
		 
INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM AngelBSECM.BSEDB_AB.DBO.SETTLEMENT S, AngelBSECM.BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C', 'RC','RD')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.NSE_SCRIP_CD = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.NSE_SERIES = #TBL_PRODUCT_DATA.SERIES 
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.BSECODE = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.BSECODE <> ''
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD IN ('BE','EQ','BZ')
AND #TBL_PRODUCT_DATA.SERIES IN ('BE','EQ','BZ')
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'


UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.Scrip_cd
AND #TBL_PRODUCT_DATA.SERIES = M.Series
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.BSECODE = M.Scrip_cd 
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.Scrip_cd,6)
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.BSECODE = ''

UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.Scrip_cd, SERIES = M.Series 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''

SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #NSECLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

SELECT * INTO #BSECLOSING FROM AngelBSECM.BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

CREATE INDEX #BSE ON #BSECLOSING
(SCRIP_CD,SYSDATE)

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #BSECLOSING C
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11) 

----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817
 

SELECT 
PARTY_CODE,	ISIN,	SCRIP_CD,	SERIES,	EXCHANGE,	SQQTY,	processdate
INTO #SQOFF FROM MTF_SQUP_DETAILS
WHERE PARTY_CODE IN (
SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE
AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2
AND left(EXCHANGE,3)= right(TRANSTYPE,3))
AND @SAUDA_DATE =LEFT(PROCESSDATE,11)

UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)
FROM #SQOFF
WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE
AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN 
AND SELL_BUY = 2 
AND left(EXCHANGE,3)= right(TRANSTYPE,3)

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND QTY <= 0 

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_PRODUCT_DATA
SELECT * FROM #TBL_PRODUCT_DATA

INSERT INTO MTF_SQUP_DETAILS_LOG
SELECT *,GETDATE() FROM #SQOFF

-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817

END
  
	EXEC PROC_PRODUCT_PROCESS			@SAUDA_DATE
   
EXEC DELIVERY_INTEROP_MTF @SAUDA_DATE

EXEC ANGELDEMAT.MSAJAG.DBO.MTF_STATUS_UPD
 

INSERT INTO TBL_MTF_PROV_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

--Added below Logic on 31st Nov 2023 to avoid manual execution by BO team

EXEC ANGELDEMAT.MSAJAG.DBO.USP_PROV_MTF_INSERT


SELECT FLAG = 1, MSG = 'PROVISIONAL PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_PROV_BKUP_25Nov2022
-- --------------------------------------------------



CREATE PROC [dbo].[PROC_PRODUCT_DATA_PROV_BKUP_25Nov2022](
           @SAUDA_DATE VARCHAR(11))
AS

SET NOCOUNT ON
-- EXEC PROC_PRODUCT_DATA 'Sep 18 2019'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

IF @PROCESSFLAG > 0 
BEGIN
	SELECT FLAG = 1, MSG = 'ACTUAL MTF PROCESS ALREADY DONE.'
	RETURN
END 

IF @PROCESSFLAG=0
BEGIN
DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'

 
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA
WHERE 1 = 2 

CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA
(
	SCRIP_CD,
	SERIES
)

INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN 
	
		 
INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S, ANAND.BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.NSE_SCRIP_CD = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.NSE_SERIES = #TBL_PRODUCT_DATA.SERIES 
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.BSECODE = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.BSECODE <> ''
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD IN ('BE','EQ','BZ')
AND #TBL_PRODUCT_DATA.SERIES IN ('BE','EQ','BZ')
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'


UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.Scrip_cd
AND #TBL_PRODUCT_DATA.SERIES = M.Series
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.BSECODE = M.Scrip_cd 
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.Scrip_cd,6)
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.BSECODE = ''

UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.Scrip_cd, SERIES = M.Series 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''

SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #NSECLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

SELECT * INTO #BSECLOSING FROM ANAND.BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

CREATE INDEX #BSE ON #BSECLOSING
(SCRIP_CD,SYSDATE)

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #BSECLOSING C
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11) 

----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817
 

SELECT * INTO #SQOFF FROM MTF_SQUP_DETAILS
WHERE PARTY_CODE IN (
SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE
AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2
AND left(EXCHANGE,3)= right(TRANSTYPE,3))
AND @SAUDA_DATE =LEFT(PROCESSDATE,11)

UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)
FROM #SQOFF
WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE
AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN 
AND SELL_BUY = 2 
AND left(EXCHANGE,3)= right(TRANSTYPE,3)

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND QTY <= 0 

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_PRODUCT_DATA
SELECT * FROM #TBL_PRODUCT_DATA

INSERT INTO MTF_SQUP_DETAILS_LOG
SELECT *,GETDATE() FROM #SQOFF

-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817

END
  
	EXEC PROC_PRODUCT_PROCESS			@SAUDA_DATE
   
EXEC DELIVERY_INTEROP_MTF @SAUDA_DATE
 

INSERT INTO TBL_MTF_PROV_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

SELECT FLAG = 1, MSG = 'PROVISIONAL PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_DATA_TEST
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_PRODUCT_DATA_TEST](
           @SAUDA_DATE VARCHAR(11))
AS

SET NOCOUNT ON
-- EXEC PROC_PRODUCT_DATA 'Sep 18 2019'

DECLARE @PROCESSFLAG	INT,
		@PROCESS_START	DATETIME
		
SELECT @PROCESS_START = GETDATE()

SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG
WHERE FUNDING_DATE = @SAUDA_DATE

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN 
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX PARTY ON #PARTY
(
	PARTY_CODE
)

IF @PROCESSFLAG > 0 
BEGIN
	SELECT FLAG = 1, MSG = 'ACTUAL MTF PROCESS ALREADY DONE.'
	RETURN
END 

IF @PROCESSFLAG=0
BEGIN
DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRNSE'

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND TRANSTYPE = 'TRBSE'

 
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE
INTO #TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA
WHERE 1 = 2 

CREATE CLUSTERED INDEX SCR ON #TBL_PRODUCT_DATA
(
	SCRIP_CD,
	SERIES
)

INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', S.SCRIP_CD, S.SERIES, BSECODE = '', SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRNSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM MSAJAG.DBO.SETTLEMENT S, MSAJAG.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE 
AND S.SETT_TYPE IN ('N', 'W')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN 
	
		 
INSERT INTO #TBL_PRODUCT_DATA 
SELECT SAUDA_DATE = LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, PRODUCT_CODE='MTF', SCRIP_CD = '', SERIES = '', BSECODE = S.SCRIP_CD, SELL_BUY, 
ISIN = CONVERT(VARCHAR(12),''),
QTY=SUM(TRADEQTY),
MKTAMT=SUM(TRADEQTY*MARKETRATE),
NETAMT=SUM(CASE WHEN SELL_BUY = 1 
				THEN TRADEQTY*MARKETRATE+(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
				ELSE TRADEQTY*MARKETRATE-(TRADEQTY*NBROKAPP+NSERTAX+TURN_TAX+SEBI_TAX+INS_CHRG+OTHER_CHRG+BROKER_CHRG) 
		   END),
CL_RATE = 0,
PAYIN_DATE=SM.SEC_PAYIN,
ADJUST_DATE='DEC 31 2049 23:59',
TRANSTYPE = 'TRBSE',
PROCESSDATE=GETDATE()--,
--TRADE_NO='', Order_No=''
FROM ANAND.BSEDB_AB.DBO.SETTLEMENT S, ANAND.BSEDB_AB.DBO.SETT_MST SM, #PARTY P
WHERE S.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND TRADEQTY > 0 
AND AUCTIONPART NOT LIKE 'F%'
AND AUCTIONPART NOT LIKE 'A%'
AND S.SETT_NO = SM.SETT_NO	
AND S.SETT_TYPE = SM.SETT_TYPE
AND S.SETT_TYPE IN ('D', 'C')
AND P.PARTY_CODE = S.PARTY_CODE
AND SETTFLAG NOT IN (2,3)
--AND PRODUCT_CODE = 'NRML'
GROUP BY LEFT(S.SAUDA_DATE,11), S.SETT_NO, S.SETT_TYPE, S.PARTY_CODE, S.SCRIP_CD, S.SERIES, 
SELL_BUY, SEC_PAYIN

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.NSE_SCRIP_CD = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.NSE_SERIES = #TBL_PRODUCT_DATA.SERIES 
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M
WHERE M.BSECODE = #TBL_PRODUCT_DATA.SCRIP_CD
AND M.BSECODE <> ''
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD IN ('BE','EQ','BZ')
AND #TBL_PRODUCT_DATA.SERIES IN ('BE','EQ','BZ')
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'


UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = M.Scrip_cd
AND #TBL_PRODUCT_DATA.SERIES = M.Series
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRNSE'

UPDATE #TBL_PRODUCT_DATA SET ISIN = M.ISIN
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.BSECODE = M.Scrip_cd 
AND VALID = 1 
AND #TBL_PRODUCT_DATA.ISIN = ''
AND TRANSTYPE = 'TRBSE'

UPDATE #TBL_PRODUCT_DATA SET BSECODE = LEFT(M.Scrip_cd,6)
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.BSECODE = ''

UPDATE #TBL_PRODUCT_DATA SET SCRIP_CD = M.Scrip_cd, SERIES = M.Series 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.ISIN = M.ISIN
AND VALID = 1 
AND #TBL_PRODUCT_DATA.SCRIP_CD = ''

SELECT * INTO #NSECLOSING FROM MSAJAG.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #NSECLOSING C
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND #TBL_PRODUCT_DATA.SCRIP_CD = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.SERIES = C.SERIES
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11)

SELECT * INTO #BSECLOSING FROM ANAND.BSEDB_AB.DBO.CLOSING WHERE  SYSDATE >= @SAUDA_DATE AND SYSDATE <=  @SAUDA_DATE + ' 23:59'

CREATE INDEX #BSE ON #BSECLOSING
(SCRIP_CD,SYSDATE)

UPDATE #TBL_PRODUCT_DATA SET CL_RATE = C.CL_RATE
FROM #BSECLOSING C
WHERE #TBL_PRODUCT_DATA.SAUDA_DATE  =@SAUDA_DATE
AND #TBL_PRODUCT_DATA.BSECODE = C.SCRIP_CD
AND #TBL_PRODUCT_DATA.CL_RATE = 0
AND SAUDA_DATE = LEFT(SYSDATE,11) 

----- BELOW QUERY LIVE ON 08112019 FOR TESTING N47817
 

SELECT * INTO #SQOFF FROM MTF_SQUP_DETAILS
WHERE PARTY_CODE IN (
SELECT PARTY_CODE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE AND #TBL_PRODUCT_DATA.PARTY_CODE = MTF_SQUP_DETAILS.PARTY_CODE
AND #TBL_PRODUCT_DATA.ISIN =MTF_SQUP_DETAILS.ISIN AND Sell_Buy=2
AND left(EXCHANGE,3)= right(TRANSTYPE,3))
AND @SAUDA_DATE =LEFT(PROCESSDATE,11)

UPDATE #TBL_PRODUCT_DATA SET QTY = QTY - SQQTY, MKTAMT = (MKTAMT/QTY) * (QTY - SQQTY),NETAMT = (NETAMT/QTY)* (QTY - SQQTY)
FROM #SQOFF
WHERE #SQOFF.PARTY_CODE = #TBL_PRODUCT_DATA.PARTY_CODE
AND #SQOFF.ISIN = #TBL_PRODUCT_DATA.ISIN 
AND SELL_BUY = 2 
AND left(EXCHANGE,3)= right(TRANSTYPE,3)

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND QTY <= 0 

DELETE FROM #TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND #TBL_PRODUCT_DATA.ISIN = TBLSCRIPMARGIN.ISIN)
AND SELL_BUY = 1 

UPDATE #TBL_PRODUCT_DATA SET MKTAMT = ROUND(MKTAMT,2), NETAMT = ROUND(NETAMT,2)
WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_PRODUCT_DATA
SELECT * FROM #TBL_PRODUCT_DATA

INSERT INTO MTF_SQUP_DETAILS_LOG
SELECT *,GETDATE() FROM #SQOFF

-----ABOVE QUERY LIVE ON 08112019 FOR TESTING N47817

END
  
	EXEC PROC_PRODUCT_PROCESS			@SAUDA_DATE
   
EXEC DELIVERY_INTEROP_MTF @SAUDA_DATE
 

INSERT INTO TBL_MTF_PROV_LOG
SELECT @SAUDA_DATE, @PROCESS_START, GETDATE()

SELECT FLAG = 1, MSG = 'PROVISIONAL PROCESS OVER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_LED_ADJUST
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_PRODUCT_LED_ADJUST]  
(  
 @SAUDA_DATE VARCHAR(11),  
 @FORPARTY VARCHAR(10) = '%'  
)  
AS  
  
-- EXEC PROC_PRODUCT_LED_ADJUST_TEST 'SEP  4 2017'  
SET NOCOUNT ON  
  
DECLARE @SDTCUR DATETIME,  
  @LDTCUR DATETIME,  
   @NONFNO INT,  
   @FNO INT,
   @MARGINDATE	VARCHAR(11)  
  
 SELECT @NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER  
 WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE  
  
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER   
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR   

SELECT DISTINCT PARTY_CODE INTO #TBLCLIENTMARGIN FROM TBLCLIENTMARGIN
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 
AND PARTY_CODE LIKE @FORPARTY

CREATE CLUSTERED INDEX IDX_P ON #TBLCLIENTMARGIN
(
	PARTY_CODE
)

SELECT CLTCODE, AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),2),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #CASHBAL   
FROM ACCOUNT.DBO.LEDGER L, #TBLCLIENTMARGIN 
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE = PARTY_CODE
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE   

INSERT INTO #CASHBAL 
SELECT CLTCODE, AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),2),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM AngelBSECM.ACCOUNT_AB.DBO.LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE = PARTY_CODE
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE  

SELECT * INTO #FOBAL FROM #CASHBAL WHERE 1 = 2 
   
INSERT INTO #FOBAL   
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'   
AND CLTCODE = PARTY_CODE
AND CLTCODE LIKE @FORPARTY             
GROUP BY CLTCODE   
  
INSERT INTO #FOBAL   
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'    
AND CLTCODE = PARTY_CODE 
AND CLTCODE LIKE @FORPARTY             
GROUP BY CLTCODE   

SELECT @MARGINDATE = MAX(MDATE) FROM ANGELFO.NSEFO.DBO.FOMARGINNEW 
WHERE MDATE <= @SAUDA_DATE + ' 23:59'

INSERT INTO #FOBAL
SELECT M.PARTY_CODE, AMOUNT = 0, FOAMOUNT = -TOTALMARGIN,
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM ANGELFO.NSEFO.DBO.FOMARGINNEW M, #TBLCLIENTMARGIN T
WHERE MDATE = @MARGINDATE AND TOTALMARGIN > 0
AND T.Party_Code = M.PARTY_CODE 
				   				   
SELECT @MARGINDATE = MAX(MDATE) FROM ANGELFO.NSECURFO.DBO.FOMARGINNEW 
WHERE MDATE <= @SAUDA_DATE + ' 23:59'

INSERT INTO #FOBAL
SELECT M.PARTY_CODE, AMOUNT = 0, FOAMOUNT = -TOTALMARGIN,
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM ANGELFO.NSECURFO.DBO.FOMARGINNEW M, #TBLCLIENTMARGIN T
WHERE MDATE = @MARGINDATE AND TOTALMARGIN > 0
AND T.Party_Code = M.PARTY_CODE 

INSERT INTO #CASHBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT), FOAMOUNT = SUM(FOAMOUNT),
MTFAMOUNT = SUM(MTFAMOUNT), MTFCASHAMOUNT = SUM(MTFCASHAMOUNT)
FROM #FOBAL
GROUP BY CLTCODE 
HAVING SUM(FOAMOUNT) > 0 

INSERT INTO #CASHBAL   
SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = -SUM(NETAMT)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND PARTY_CODE LIKE @FORPARTY         
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL   
SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),   
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = SUM(NETAMT)  
FROM TBL_PRODUCT_POSITION P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE = @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY         
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL  
SELECT PARTY_CODE, AMOUNT = 0,  
FOAMOUNT = CONVERT(NUMERIC(18,2),0), MTFAMOUNT = ROUND(SUM(NETAMT),2),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)   
FROM TBL_PRODUCT_POSITION P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY 
--AND PAYIN_DATE <= @SAUDA_DATE        
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL  
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)    
FROM LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
--AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE = PARTY_CODE   
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE   
  
SELECT CLTCODE, AMOUNT = SUM(AMOUNT),  
FOAMOUNT = SUM(FOAMOUNT),  
MTFAMOUNT = SUM(MTFAMOUNT) + (CASE WHEN SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT) > 0 
																		   THEN 0 ELSE ABS(SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT)) END),  
MTFCASHAMOUNT = (CASE WHEN SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT) > 0 
												THEN SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT) ELSE 0 END),   
INTERNALAMOUNT = SUM(AMOUNT)+SUM(FOAMOUNT),  
ADJAMT=CONVERT(NUMERIC(18,2),0),  
MTFTOCASHJV=CONVERT(NUMERIC(18,2),0),  
MTFTOFOJV=CONVERT(NUMERIC(18,2),0),  
MTFNONCASHADJ=CONVERT(NUMERIC(18,2),0)  
INTO #POSCLOSE FROM #CASHBAL  
GROUP BY CLTCODE    

DELETE FROM #POSCLOSE  
WHERE INTERNALAMOUNT < 0   
AND (INTERNALAMOUNT + MTFCASHAMOUNT) < MTFAMOUNT 
AND MTFCASHAMOUNT < MTFAMOUNT
  
DELETE FROM TBL_PRODUCT_LED_ADJUST  
WHERE SAUDA_DATE= @SAUDA_DATE  
AND CLTCODE LIKE @FORPARTY  
  
INSERT INTO TBL_PRODUCT_LED_ADJUST  
SELECT SAUDA_DATE= @SAUDA_DATE,  
CLTCODE,  
AMOUNT,  
FOAMOUNT,  
MTFAMOUNT,  
MTFCASHAMOUNT,  
INTERNALAMOUNT,  
ADJAMT=0,  
MTFTOCASHJV=0,  
MTFTOFOJV=0,  
MTFNONCASHADJ=0,  
PROCESS_DATE=GETDATE()  
FROM #POSCLOSE  
  
DELETE FROM TBL_PRODUCT_POS_ADJUST_LED  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY  
  
INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
SELECT @SAUDA_DATE, SETT_NO = '2000000',   
SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY),TRANSTYPE,  
ADDED_BY='AUTOLED',GETDATE(), NETAMT = SUM(NETAMT), MTFVAR =0, CL_RATE = 0  
FROM TBL_PRODUCT_POSITION P, #POSCLOSE C  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND P.PARTY_CODE = C.CLTCODE  
AND ((INTERNALAMOUNT + MTFCASHAMOUNT) >= MTFAMOUNT  
or MTFCASHAMOUNT >= MTFAMOUNT)
AND MTFAMOUNT > 0 AND QTY > 0   
AND PAYIN_DATE <= @SAUDA_DATE
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, TRANSTYPE  
  
SELECT P.*, INTERNALAMOUNT, MTFCASHAMOUNT, FOAMOUNT,   
AMOUNT, MTFAMOUNT, ADJQTY = 0, MTFVAR = CONVERT(NUMERIC(18,2),0),  
TCL_RATE = CONVERT(NUMERIC(18,2),0)   
INTO #POSCLOSEDATA  
FROM TBL_PRODUCT_POSITION P, #POSCLOSE C  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND P.PARTY_CODE = C.CLTCODE  
AND (INTERNALAMOUNT + MTFCASHAMOUNT) < MTFAMOUNT  
AND MTFAMOUNT > 0 AND QTY > 0 
AND PAYIN_DATE <= @SAUDA_DATE 
  
CREATE CLUSTERED INDEX SNO ON #POSCLOSEDATA 
(
	SNO
)  

CREATE NONCLUSTERED INDEX IDX_PA ON #POSCLOSEDATA 
(
	PARTY_CODE
)  

 SELECT *, FOFLAG = 0 INTO #A_TBLSCRIPMARGIN   
 FROM TBLSCRIPMARGIN  
 WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
 UPDATE #A_TBLSCRIPMARGIN SET FOFLAG = 1  
 FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F  
 WHERE F.SYMBOL = #A_TBLSCRIPMARGIN.SCRIP_CD  
 AND   F.EXPIRYDATE >= @SAUDA_DATE  
 AND   INST_TYPE LIKE 'FUT%'  
  
 SELECT V.* INTO #A_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V,   
 MSAJAG.DBO.VARCONTROL C  
 WHERE C.RECDATE = @SAUDA_DATE  
 AND C.DETAILKEY = V.DETAILKEY  
 AND SERIES IN ( 'EQ', 'BE', 'BZ' )   
 AND ISIN IN (SELECT ISIN FROM #POSCLOSEDATA UNION SELECT IsIN FROM TBL_PRODUCT_POS_ADJUST_LED  
 where SAUDA_DATE = @SAUDA_DATE)  
  
 SELECT V.* INTO  #P_BSE_VAR FROM AngelBSECM.BSEDB_AB.dBO.VARDETAIL V  
 WHERE V.FDATE = @SAUDA_DATE  
  
    SELECT V.* INTO #A_BSE_VAR FROM  #P_BSE_VAR V  
 WHERE  ISIN IN (SELECT ISIN FROM #POSCLOSEDATA UNION SELECT IsIN FROM TBL_PRODUCT_POS_ADJUST_LED  
 where SAUDA_DATE = @SAUDA_DATE)  
   
    UPDATE #POSCLOSEDATA   
    SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #A_NSE_VAR M, #A_TBLSCRIPMARGIN T   
    WHERE  M.ISIN = #POSCLOSEDATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE #POSCLOSEDATA   
 SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.MARGIN /*+ 3 * ELM*/ ELSE M.MARGIN /*+ 5 * ELM*/ END)  
 FROM   #A_BSE_VAR M, #A_TBLSCRIPMARGIN T  
 WHERE  M.ISIN = #POSCLOSEDATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE #POSCLOSEDATA SET MTFVAR = 100  
 WHERE (MTFVAR = 0  OR MTFVAR > 100)
  
    UPDATE TBL_PRODUCT_POS_ADJUST_LED   
    SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #A_NSE_VAR M, #A_TBLSCRIPMARGIN T   
    WHERE  TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    M.ISIN = TBL_PRODUCT_POS_ADJUST_LED.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE TBL_PRODUCT_POS_ADJUST_LED   
 SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.MARGIN /*+ 3 * ELM*/ ELSE M.MARGIN /*+ 5 * ELM*/ END)  
 FROM   #A_BSE_VAR M, #A_TBLSCRIPMARGIN T  
 WHERE  TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    M.ISIN = TBL_PRODUCT_POS_ADJUST_LED.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
  
 UPDATE TBL_PRODUCT_POS_ADJUST_LED SET MTFVAR = 100  
 WHERE TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    (MTFVAR = 0  OR MTFVAR > 100)
    
/*   
UPDATE TBL_PRODUCT_POS_ADJUST_LED SET CL_RATE = CURR_CL_RATE,   
MTFVAR = HAIRCUT  
FROM TBL_MTF_DATA T  
WHERE T.SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_POS_ADJUST_LED.PARTY_CODE = T.PARTY_CODE  
AND TBL_PRODUCT_POS_ADJUST_LED.ISIN = T.ISIN  
*/  
IF @FORPARTY <> '%'  
BEGIN  
 SELECT * FROM #POSCLOSEDATA  
 ORDER BY MTFVAR DESC, TCL_RATE,  SNO   
   
END  

UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFCASHAMOUNT   
WHERE SAUDA_DATE = @SAUDA_DATE AND MTFAMOUNT = 0  
  
DECLARE @POSCUR CURSOR,  
  @PARTY_CODE VARCHAR(10),  
  @AMOUNT NUMERIC(18,2),  
  @QTY INT,  
  @POSQTY INT,  
  @ADJCUR CURSOR,  
  @NETAMOUNT NUMERIC(18,2),  
  @NETRATE NUMERIC(18,2),  
  @SNO NUMERIC(18,0),   
  @MTFVAR NUMERIC(18,2),  
  @TCL_RATE NUMERIC(18,2),  
  @MTFCASHAMOUNT NUMERIC(18,2),  
  @MARGIN NUMERIC(18,2)  


SELECT DISTINCT PARTY_CODE, INTERNALAMOUNT, MTFCASHAMOUNT INTO #PDATA FROM #POSCLOSEDATA  
WHERE INTERNALAMOUNT > 0 AND MTFAMOUNT > 0 
    
SET @POSCUR = CURSOR FOR  
SELECT * FROM #PDATA A  
ORDER BY PARTY_CODE   
OPEN @POSCUR  
FETCH NEXT FROM @POSCUR INTO @PARTY_CODE, @AMOUNT, @MTFCASHAMOUNT  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @ADJCUR = CURSOR FOR  
 SELECT SNO, QTY-ADJQTY, NETAMT, MTFVAR, TCL_RATE, MARGIN = NETAMT*MTFVAR/100 FROM #POSCLOSEDATA  
 WHERE PARTY_CODE = @PARTY_CODE  
 AND (QTY-ADJQTY) > 0 AND ADJQTY >= 0  
 ORDER BY MTFVAR DESC, TCL_RATE,  SNO   
 OPEN @ADJCUR   
 FETCH NEXT FROM @ADJCUR INTO @SNO, @QTY, @NETAMOUNT, @MTFVAR, @TCL_RATE, @MARGIN  
 WHILE @@FETCH_STATUS = 0  
 BEGIN   
  IF @FORPARTY <> '%'  
  BEGIN  
   SELECT @AMOUNT, @MTFCASHAMOUNT  
  END  
   
  IF @AMOUNT <= 0
  BEGIN
    BREAK;
  END
  IF @AMOUNT > 0   
  BEGIN  
   IF @AMOUNT >= (@NETAMOUNT - (CASE WHEN @MTFCASHAMOUNT >= @MARGIN   
             THEN @MARGIN   
             ELSE @MTFCASHAMOUNT   
           END))  
   BEGIN  
    INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
    SELECT @SAUDA_DATE, SETT_NO = '2000000',   
    SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
    PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=QTY,TRANSTYPE,  
    ADDED_BY='AUTOLED',GETDATE(), @NETAMOUNT, @MTFVAR, @TCL_RATE  
    FROM #POSCLOSEDATA  
    WHERE SNO = @SNO   
      
    UPDATE #POSCLOSEDATA SET ADJQTY = ADJQTY + @QTY  
    WHERE SNO = @SNO   
      
    IF @MTFCASHAMOUNT >= @MARGIN   
    BEGIN  
     SET @MTFCASHAMOUNT = @MTFCASHAMOUNT - @MARGIN  
     SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MARGIN  
       
     UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MARGIN  
     WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
    END  
    ELSE  
    BEGIN  
     SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MTFCASHAMOUNT  
       
     UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MTFCASHAMOUNT,  
     MTFNONCASHADJ = MTFNONCASHADJ  + @MARGIN - @MTFCASHAMOUNT  
     WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
       
     SET @MTFCASHAMOUNT = 0  
    END  
   END  
   ELSE  
   BEGIN  
    SET @NETRATE = (@NETAMOUNT / @QTY)  
    IF (@NETRATE  
           -(CASE WHEN @MTFCASHAMOUNT >= @NETAMOUNT*@MTFVAR/100 AND @MTFVAR < 100  
               THEN @NETRATE*@MTFVAR/100 ELSE 0 END)) = 0   
    BEGIN  
     --SELECT @PARTY_CODE, @MTFCASHAMOUNT, @AMOUNT, @NETRATE, @NETRATE*@MTFVAR/100,@MTFVAR  
       
     BREAK;  
    END                 
    SET @POSQTY = FLOOR(@AMOUNT / (@NETRATE  
           -(CASE WHEN @MTFCASHAMOUNT >= @NETAMOUNT*@MTFVAR/100 AND @MTFVAR < 100  
               THEN @NETRATE*@MTFVAR/100 ELSE 0 END)))  
    IF @POSQTY > @QTY   
    BEGIN  
     SET @POSQTY = @QTY  
    END  
    SET @NETAMOUNT = @POSQTY * @NETRATE  
    IF @POSQTY > 0   
    BEGIN   
     INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
     SELECT @SAUDA_DATE, SETT_NO = '2000000',   
     SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
     PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=@POSQTY,TRANSTYPE,  
     ADDED_BY='AUTOLED',GETDATE(),@NETAMOUNT, @MTFVAR, @TCL_RATE  
     FROM #POSCLOSEDATA  
     WHERE SNO = @SNO   
       
     UPDATE #POSCLOSEDATA SET ADJQTY = ADJQTY + @POSQTY  
     WHERE SNO = @SNO   
       
     SET @MARGIN = (case when @MTFVAR < 100 then @NETAMOUNT * @MTFVAR / 100 else 0 end)  
     IF @MTFCASHAMOUNT >= @MARGIN   
     BEGIN  
      SET @MTFCASHAMOUNT = @MTFCASHAMOUNT - @MARGIN  
      SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MARGIN  
      UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MARGIN  
      WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
     END  
     ELSE  
     BEGIN  
      SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MTFCASHAMOUNT  
      UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MTFCASHAMOUNT,  
      MTFNONCASHADJ = MTFNONCASHADJ  + @MARGIN - @MTFCASHAMOUNT  
      WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
      SET @MTFCASHAMOUNT = 0  
     END  
    END  
   END  
  END  
  FETCH NEXT FROM @ADJCUR INTO @SNO, @QTY, @NETAMOUNT, @MTFVAR, @TCL_RATE, @MARGIN  
 END  
 FETCH NEXT FROM @POSCUR INTO @PARTY_CODE, @AMOUNT, @MTFCASHAMOUNT  
END  
CLOSE @POSCUR  
DEALLOCATE @POSCUR  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = ROUND(MTFTOCASHJV,2), MTFTOFOJV = ROUND(MTFTOFOJV,2)  
 WHERE SAUDA_DATE = @SAUDA_DATE  

/*  
UPDATE TBL_PRODUCT_LED_ADJUST SET ADJAMT = 0,  MTFTOCASHJV = 0, MTFTOFOJV = 0    
WHERE SAUDA_DATE = @SAUDA_DATE*/  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET ADJAMT = ROUND(A.AMOUNT,2)  
FROM (SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POS_ADJUST_LED  
WHERE SAUDA_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE ) A  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_LED_ADJUST.CLTCODE = A.PARTY_CODE  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = (CASE WHEN MTFAMOUNT = ADJAMT   
               THEN MTFCASHAMOUNT   
               ELSE MTFTOCASHJV  
             END)  
WHERE SAUDA_DATE = @SAUDA_DATE   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOFOJV = (CASE WHEN FOAMOUNT > 0 AND -ADJAMT + MTFTOCASHJV + AMOUNT < 0 AND ADJAMT > 0   
             THEN (CASE WHEN FOAMOUNT > ABS(-ADJAMT + MTFTOCASHJV + AMOUNT)   
                  THEN -ADJAMT + MTFTOCASHJV + AMOUNT   
                  ELSE -FOAMOUNT   
                END)  
             ELSE 0  
              END)  
WHERE SAUDA_DATE = @SAUDA_DATE 
AND MTFCASHAMOUNT < MTFAMOUNT   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -MTFTOCASHJV   
WHERE SAUDA_DATE = @SAUDA_DATE   
  
/*  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -(CASE WHEN MTFAMOUNT = ADJAMT THEN MTFCASHAMOUNT ELSE ADJAMT-INTERNALAMOUNT END)  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -MTFTOCASHJV+FOAMOUNT,  
MTFTOFOJV = -FOAMOUNT  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV+(-MTFTOCASHJV-AMOUNT+ADJAMT),  
MTFTOFOJV = MTFTOFOJV-(-MTFTOCASHJV-AMOUNT+ADJAMT)  
WHERE   
SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
AND FOAMOUNT > 0   
AND MTFTOCASHJV > 0   
AND MTFTOFOJV < 0   
*/  
IF @FORPARTY <> '%'  
BEGIN  
 SELECT * FROM TBL_PRODUCT_LED_ADJUST   
 WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @FORPARTY  
  
 SELECT * FROM TBL_PRODUCT_POS_ADJUST_LED  
 WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @FORPARTY  
 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_LED_ADJUST_TEST
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_PRODUCT_LED_ADJUST_TEST]  
(  
 @SAUDA_DATE VARCHAR(11),  
 @FORPARTY VARCHAR(10) = '%'  
)  
AS  
  
-- EXEC PROC_PRODUCT_LED_ADJUST_TEST 'SEP  4 2017'  
SET NOCOUNT ON  
  
DECLARE @SDTCUR DATETIME,  
  @LDTCUR DATETIME,  
   @NONFNO INT,  
   @FNO INT,
   @MARGINDATE	VARCHAR(11)  
  
 SELECT @NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER  
 WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE  
  
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER   
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR   

SELECT DISTINCT PARTY_CODE INTO #TBLCLIENTMARGIN FROM TBLCLIENTMARGIN
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 

CREATE CLUSTERED INDEX IDX_P ON #TBLCLIENTMARGIN
(
	PARTY_CODE
)

SELECT CLTCODE, AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),2),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #CASHBAL   
FROM ACCOUNT.DBO.LEDGER L, #TBLCLIENTMARGIN 
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE = PARTY_CODE
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE   

INSERT INTO #CASHBAL 
SELECT CLTCODE, AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),2),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANAND.ACCOUNT_AB.DBO.LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE = PARTY_CODE
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE  

SELECT * INTO #FOBAL FROM #CASHBAL WHERE 1 = 2 
   
INSERT INTO #FOBAL   
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANGELFO.ACCOUNTFO.DBO.LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'   
AND CLTCODE = PARTY_CODE
AND CLTCODE LIKE @FORPARTY             
GROUP BY CLTCODE   
  
INSERT INTO #FOBAL   
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM ANGELFO.ACCOUNTCURFO.DBO.LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'    
AND CLTCODE = PARTY_CODE 
AND CLTCODE LIKE @FORPARTY             
GROUP BY CLTCODE   

SELECT @MARGINDATE = MAX(MDATE) FROM ANGELFO.NSEFO.DBO.FOMARGINNEW 
WHERE MDATE <= @SAUDA_DATE + ' 23:59'

INSERT INTO #FOBAL
SELECT M.PARTY_CODE, AMOUNT = 0, FOAMOUNT = -TOTALMARGIN,
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM ANGELFO.NSEFO.DBO.FOMARGINNEW M, #TBLCLIENTMARGIN T
WHERE MDATE = @MARGINDATE AND TOTALMARGIN > 0
AND T.Party_Code = M.PARTY_CODE 
				   				   
SELECT @MARGINDATE = MAX(MDATE) FROM ANGELFO.NSECURFO.DBO.FOMARGINNEW 
WHERE MDATE <= @SAUDA_DATE + ' 23:59'

INSERT INTO #FOBAL
SELECT M.PARTY_CODE, AMOUNT = 0, FOAMOUNT = -TOTALMARGIN,
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM ANGELFO.NSECURFO.DBO.FOMARGINNEW M, #TBLCLIENTMARGIN T
WHERE MDATE = @MARGINDATE AND TOTALMARGIN > 0
AND T.Party_Code = M.PARTY_CODE 

INSERT INTO #CASHBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT), FOAMOUNT = SUM(FOAMOUNT),
MTFAMOUNT = SUM(MTFAMOUNT), MTFCASHAMOUNT = SUM(MTFCASHAMOUNT)
FROM #FOBAL
GROUP BY CLTCODE 
HAVING SUM(FOAMOUNT) > 0 

INSERT INTO #CASHBAL   
SELECT PARTY_CODE, AMOUNT = SUM(NETAMT),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = -SUM(NETAMT)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND PARTY_CODE LIKE @FORPARTY         
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL   
SELECT PARTY_CODE, AMOUNT = -SUM(NETAMT),  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),   
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = SUM(NETAMT)  
FROM TBL_PRODUCT_POSITION P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE = @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY         
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL  
SELECT PARTY_CODE, AMOUNT = 0,  
FOAMOUNT = CONVERT(NUMERIC(18,2),0), MTFAMOUNT = ROUND(SUM(NETAMT),2),  
MTFCASHAMOUNT = CONVERT(NUMERIC(18,2),0)   
FROM TBL_PRODUCT_POSITION P  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY 
--AND PAYIN_DATE <= @SAUDA_DATE        
GROUP BY PARTY_CODE   
  
INSERT INTO #CASHBAL  
SELECT CLTCODE, AMOUNT = 0,  
FOAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFAMOUNT = CONVERT(NUMERIC(18,2),0),  
MTFCASHAMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)    
FROM LEDGER L, #TBLCLIENTMARGIN   
WHERE VDT >= @SDTCUR  
AND VDT <= @LDTCUR + ' 23:59:59'  
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
--AND VTYP <> (CASE WHEN LEFT(VDT,11) = @SAUDA_DATE THEN '35' ELSE '' END)   
AND CLTCODE = PARTY_CODE   
AND CLTCODE LIKE @FORPARTY         
GROUP BY CLTCODE   
  
SELECT CLTCODE, AMOUNT = SUM(AMOUNT),  
FOAMOUNT = SUM(FOAMOUNT),  
MTFAMOUNT = SUM(MTFAMOUNT) + (CASE WHEN SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT) > 0 
																		   THEN 0 ELSE ABS(SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT)) END),  
MTFCASHAMOUNT = (CASE WHEN SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT) > 0 
												THEN SUM(MTFCASHAMOUNT)  + SUM(MTFAMOUNT) ELSE 0 END),   
INTERNALAMOUNT = SUM(AMOUNT)+SUM(FOAMOUNT),  
ADJAMT=CONVERT(NUMERIC(18,2),0),  
MTFTOCASHJV=CONVERT(NUMERIC(18,2),0),  
MTFTOFOJV=CONVERT(NUMERIC(18,2),0),  
MTFNONCASHADJ=CONVERT(NUMERIC(18,2),0)  
INTO #POSCLOSE FROM #CASHBAL  
GROUP BY CLTCODE    

DELETE FROM #POSCLOSE  
WHERE INTERNALAMOUNT < 0   
AND (INTERNALAMOUNT + MTFCASHAMOUNT) < MTFAMOUNT 
AND MTFCASHAMOUNT < MTFAMOUNT
  
DELETE FROM TBL_PRODUCT_LED_ADJUST  
WHERE SAUDA_DATE= @SAUDA_DATE  
AND CLTCODE LIKE @FORPARTY  
  
INSERT INTO TBL_PRODUCT_LED_ADJUST  
SELECT SAUDA_DATE= @SAUDA_DATE,  
CLTCODE,  
AMOUNT,  
FOAMOUNT,  
MTFAMOUNT,  
MTFCASHAMOUNT,  
INTERNALAMOUNT,  
ADJAMT=0,  
MTFTOCASHJV=0,  
MTFTOFOJV=0,  
MTFNONCASHADJ=0,  
PROCESS_DATE=GETDATE()  
FROM #POSCLOSE  
  
DELETE FROM TBL_PRODUCT_POS_ADJUST_LED  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PARTY_CODE LIKE @FORPARTY  
  
INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
SELECT @SAUDA_DATE, SETT_NO = '2000000',   
SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY),TRANSTYPE,  
ADDED_BY='AUTOLED',GETDATE(), NETAMT = SUM(NETAMT), MTFVAR =0, CL_RATE = 0  
FROM TBL_PRODUCT_POSITION P, #POSCLOSE C  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND P.PARTY_CODE = C.CLTCODE  
AND ((INTERNALAMOUNT + MTFCASHAMOUNT) >= MTFAMOUNT  
or MTFCASHAMOUNT >= MTFAMOUNT)
AND MTFAMOUNT > 0 AND QTY > 0   
AND PAYIN_DATE <= @SAUDA_DATE
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, TRANSTYPE  
  
SELECT P.*, INTERNALAMOUNT, MTFCASHAMOUNT, FOAMOUNT,   
AMOUNT, MTFAMOUNT, ADJQTY = 0, MTFVAR = CONVERT(NUMERIC(18,2),0),  
TCL_RATE = CONVERT(NUMERIC(18,2),0)   
INTO #POSCLOSEDATA  
FROM TBL_PRODUCT_POSITION P, #POSCLOSE C  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND SELL_BUY = 1   
AND ADJUST_DATE > @SAUDA_DATE  
AND P.PARTY_CODE = C.CLTCODE  
AND (INTERNALAMOUNT + MTFCASHAMOUNT) < MTFAMOUNT  
AND MTFAMOUNT > 0 AND QTY > 0 
AND PAYIN_DATE <= @SAUDA_DATE 
  
CREATE CLUSTERED INDEX SNO ON #POSCLOSEDATA 
(
	SNO
)  

CREATE NONCLUSTERED INDEX IDX_PA ON #POSCLOSEDATA 
(
	PARTY_CODE
)  

 SELECT *, FOFLAG = 0 INTO #A_TBLSCRIPMARGIN   
 FROM TBLSCRIPMARGIN  
 WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
 UPDATE #A_TBLSCRIPMARGIN SET FOFLAG = 1  
 FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F  
 WHERE F.SYMBOL = #A_TBLSCRIPMARGIN.SCRIP_CD  
 AND   F.EXPIRYDATE >= @SAUDA_DATE  
 AND   INST_TYPE LIKE 'FUT%'  
  
 SELECT V.* INTO #A_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V,   
 MSAJAG.DBO.VARCONTROL C  
 WHERE C.RECDATE = @SAUDA_DATE  
 AND C.DETAILKEY = V.DETAILKEY  
 AND SERIES IN ( 'EQ', 'BE', 'BZ' )   
 AND ISIN IN (SELECT ISIN FROM #POSCLOSEDATA UNION SELECT IsIN FROM TBL_PRODUCT_POS_ADJUST_LED  
 where SAUDA_DATE = @SAUDA_DATE)  
  
 SELECT V.* INTO  #P_BSE_VAR FROM ANAND.BSEDB_AB.dBO.VARDETAIL V  
 WHERE V.FDATE = @SAUDA_DATE  
  
    SELECT V.* INTO #A_BSE_VAR FROM  #P_BSE_VAR V  
 WHERE  ISIN IN (SELECT ISIN FROM #POSCLOSEDATA UNION SELECT IsIN FROM TBL_PRODUCT_POS_ADJUST_LED  
 where SAUDA_DATE = @SAUDA_DATE)  
   
    UPDATE #POSCLOSEDATA   
    SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #A_NSE_VAR M, #A_TBLSCRIPMARGIN T   
    WHERE  M.ISIN = #POSCLOSEDATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE #POSCLOSEDATA   
 SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.MARGIN /*+ 3 * ELM*/ ELSE M.MARGIN /*+ 5 * ELM*/ END)  
 FROM   #A_BSE_VAR M, #A_TBLSCRIPMARGIN T  
 WHERE  M.ISIN = #POSCLOSEDATA.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE #POSCLOSEDATA SET MTFVAR = 100  
 WHERE MTFVAR = 0  
  
    UPDATE TBL_PRODUCT_POS_ADJUST_LED   
    SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)  
    FROM   #A_NSE_VAR M, #A_TBLSCRIPMARGIN T   
    WHERE  TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    M.ISIN = TBL_PRODUCT_POS_ADJUST_LED.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
   
 UPDATE TBL_PRODUCT_POS_ADJUST_LED   
 SET    MTFVAR = (CASE WHEN FOFLAG = 1 THEN M.MARGIN /*+ 3 * ELM*/ ELSE M.MARGIN /*+ 5 * ELM*/ END)  
 FROM   #A_BSE_VAR M, #A_TBLSCRIPMARGIN T  
 WHERE  TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    M.ISIN = TBL_PRODUCT_POS_ADJUST_LED.ISIN   
 AND    M.ISIN = T.ISIN  
 AND    MTFVAR = 0  
  
 UPDATE TBL_PRODUCT_POS_ADJUST_LED SET MTFVAR = 100  
 WHERE TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
    AND    MTFVAR = 0  
    
/*   
UPDATE TBL_PRODUCT_POS_ADJUST_LED SET CL_RATE = CURR_CL_RATE,   
MTFVAR = HAIRCUT  
FROM TBL_MTF_DATA T  
WHERE T.SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_POS_ADJUST_LED.SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_POS_ADJUST_LED.PARTY_CODE = T.PARTY_CODE  
AND TBL_PRODUCT_POS_ADJUST_LED.ISIN = T.ISIN  
*/  
IF @FORPARTY <> '%'  
BEGIN  
 SELECT * FROM #POSCLOSEDATA  
 ORDER BY MTFVAR DESC, TCL_RATE,  SNO   
   
END  

UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFCASHAMOUNT   
WHERE SAUDA_DATE = @SAUDA_DATE AND MTFAMOUNT = 0  
  
DECLARE @POSCUR CURSOR,  
  @PARTY_CODE VARCHAR(10),  
  @AMOUNT NUMERIC(18,2),  
  @QTY INT,  
  @POSQTY INT,  
  @ADJCUR CURSOR,  
  @NETAMOUNT NUMERIC(18,2),  
  @NETRATE NUMERIC(18,2),  
  @SNO NUMERIC(18,0),   
  @MTFVAR NUMERIC(18,2),  
  @TCL_RATE NUMERIC(18,2),  
  @MTFCASHAMOUNT NUMERIC(18,2),  
  @MARGIN NUMERIC(18,2)  


SELECT DISTINCT PARTY_CODE, INTERNALAMOUNT, MTFCASHAMOUNT INTO #PDATA FROM #POSCLOSEDATA  
WHERE INTERNALAMOUNT > 0 AND MTFAMOUNT > 0 
    
SET @POSCUR = CURSOR FOR  
SELECT * FROM #PDATA A  
ORDER BY PARTY_CODE   
OPEN @POSCUR  
FETCH NEXT FROM @POSCUR INTO @PARTY_CODE, @AMOUNT, @MTFCASHAMOUNT  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @ADJCUR = CURSOR FOR  
 SELECT SNO, QTY-ADJQTY, NETAMT, MTFVAR, TCL_RATE, MARGIN = NETAMT*MTFVAR/100 FROM #POSCLOSEDATA  
 WHERE PARTY_CODE = @PARTY_CODE  
 AND (QTY-ADJQTY) > 0 AND ADJQTY >= 0  
 ORDER BY MTFVAR DESC, TCL_RATE,  SNO   
 OPEN @ADJCUR   
 FETCH NEXT FROM @ADJCUR INTO @SNO, @QTY, @NETAMOUNT, @MTFVAR, @TCL_RATE, @MARGIN  
 WHILE @@FETCH_STATUS = 0  
 BEGIN   
  IF @FORPARTY <> '%'  
  BEGIN  
   SELECT @AMOUNT, @MTFCASHAMOUNT  
  END  
   
  IF @AMOUNT <= 0
  BEGIN
    BREAK;
  END
  IF @AMOUNT > 0   
  BEGIN  
   IF @AMOUNT >= (@NETAMOUNT - (CASE WHEN @MTFCASHAMOUNT >= @MARGIN   
             THEN @MARGIN   
             ELSE @MTFCASHAMOUNT   
           END))  
   BEGIN  
    INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
    SELECT @SAUDA_DATE, SETT_NO = '2000000',   
    SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
    PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=QTY,TRANSTYPE,  
    ADDED_BY='AUTOLED',GETDATE(), @NETAMOUNT, @MTFVAR, @TCL_RATE  
    FROM #POSCLOSEDATA  
    WHERE SNO = @SNO   
      
    UPDATE #POSCLOSEDATA SET ADJQTY = ADJQTY + @QTY  
    WHERE SNO = @SNO   
      
    IF @MTFCASHAMOUNT >= @MARGIN   
    BEGIN  
     SET @MTFCASHAMOUNT = @MTFCASHAMOUNT - @MARGIN  
     SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MARGIN  
       
     UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MARGIN  
     WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
    END  
    ELSE  
    BEGIN  
     SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MTFCASHAMOUNT  
       
     UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MTFCASHAMOUNT,  
     MTFNONCASHADJ = MTFNONCASHADJ  + @MARGIN - @MTFCASHAMOUNT  
     WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
       
     SET @MTFCASHAMOUNT = 0  
    END  
   END  
   ELSE  
   BEGIN  
    SET @NETRATE = (@NETAMOUNT / @QTY)  
    IF (@NETRATE  
           -(CASE WHEN @MTFCASHAMOUNT >= @NETAMOUNT*@MTFVAR/100 AND @MTFVAR < 100  
               THEN @NETRATE*@MTFVAR/100 ELSE 0 END)) = 0   
    BEGIN  
     --SELECT @PARTY_CODE, @MTFCASHAMOUNT, @AMOUNT, @NETRATE, @NETRATE*@MTFVAR/100,@MTFVAR  
       
     BREAK;  
    END                 
    SET @POSQTY = FLOOR(@AMOUNT / (@NETRATE  
           -(CASE WHEN @MTFCASHAMOUNT >= @NETAMOUNT*@MTFVAR/100 AND @MTFVAR < 100  
               THEN @NETRATE*@MTFVAR/100 ELSE 0 END)))  
    IF @POSQTY > @QTY   
    BEGIN  
     SET @POSQTY = @QTY  
    END  
    SET @NETAMOUNT = @POSQTY * @NETRATE  
    IF @POSQTY > 0   
    BEGIN   
     INSERT INTO TBL_PRODUCT_POS_ADJUST_LED  
     SELECT @SAUDA_DATE, SETT_NO = '2000000',   
     SETT_TYPE = (CASE WHEN TRANSTYPE = 'TRBSE' THEN 'D' ELSE 'N' END),   
     PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=@POSQTY,TRANSTYPE,  
     ADDED_BY='AUTOLED',GETDATE(),@NETAMOUNT, @MTFVAR, @TCL_RATE  
     FROM #POSCLOSEDATA  
     WHERE SNO = @SNO   
       
     UPDATE #POSCLOSEDATA SET ADJQTY = ADJQTY + @POSQTY  
     WHERE SNO = @SNO   
       
     SET @MARGIN = (case when @MTFVAR < 100 then @NETAMOUNT * @MTFVAR / 100 else 0 end)  
     IF @MTFCASHAMOUNT >= @MARGIN   
     BEGIN  
      SET @MTFCASHAMOUNT = @MTFCASHAMOUNT - @MARGIN  
      SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MARGIN  
      UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MARGIN  
      WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
     END  
     ELSE  
     BEGIN  
      SET @AMOUNT = @AMOUNT - @NETAMOUNT + @MTFCASHAMOUNT  
      UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV + @MTFCASHAMOUNT,  
      MTFNONCASHADJ = MTFNONCASHADJ  + @MARGIN - @MTFCASHAMOUNT  
      WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @PARTY_CODE   
      SET @MTFCASHAMOUNT = 0  
     END  
    END  
   END  
  END  
  FETCH NEXT FROM @ADJCUR INTO @SNO, @QTY, @NETAMOUNT, @MTFVAR, @TCL_RATE, @MARGIN  
 END  
 FETCH NEXT FROM @POSCUR INTO @PARTY_CODE, @AMOUNT, @MTFCASHAMOUNT  
END  
CLOSE @POSCUR  
DEALLOCATE @POSCUR  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = ROUND(MTFTOCASHJV,2), MTFTOFOJV = ROUND(MTFTOFOJV,2)  
 WHERE SAUDA_DATE = @SAUDA_DATE  

/*  
UPDATE TBL_PRODUCT_LED_ADJUST SET ADJAMT = 0,  MTFTOCASHJV = 0, MTFTOFOJV = 0    
WHERE SAUDA_DATE = @SAUDA_DATE*/  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET ADJAMT = ROUND(A.AMOUNT,2)  
FROM (SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POS_ADJUST_LED  
WHERE SAUDA_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE ) A  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND TBL_PRODUCT_LED_ADJUST.CLTCODE = A.PARTY_CODE  
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = (CASE WHEN MTFAMOUNT = ADJAMT   
               THEN MTFCASHAMOUNT   
               ELSE MTFTOCASHJV  
             END)  
WHERE SAUDA_DATE = @SAUDA_DATE   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOFOJV = (CASE WHEN FOAMOUNT > 0 AND -ADJAMT + MTFTOCASHJV + AMOUNT < 0 AND ADJAMT > 0   
             THEN (CASE WHEN FOAMOUNT > ABS(-ADJAMT + MTFTOCASHJV + AMOUNT)   
                  THEN -ADJAMT + MTFTOCASHJV + AMOUNT   
                  ELSE -FOAMOUNT   
                END)  
             ELSE 0  
              END)  
WHERE SAUDA_DATE = @SAUDA_DATE 
AND MTFCASHAMOUNT < MTFAMOUNT   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -MTFTOCASHJV   
WHERE SAUDA_DATE = @SAUDA_DATE   
  
/*  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -(CASE WHEN MTFAMOUNT = ADJAMT THEN MTFCASHAMOUNT ELSE ADJAMT-INTERNALAMOUNT END)  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = -MTFTOCASHJV+FOAMOUNT,  
MTFTOFOJV = -FOAMOUNT  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
  
UPDATE TBL_PRODUCT_LED_ADJUST SET MTFTOCASHJV = MTFTOCASHJV+(-MTFTOCASHJV-AMOUNT+ADJAMT),  
MTFTOFOJV = MTFTOFOJV-(-MTFTOCASHJV-AMOUNT+ADJAMT)  
WHERE   
SAUDA_DATE = @SAUDA_DATE  
AND MTFAMOUNT > 0  
AND ADJAMT > 0   
AND FOAMOUNT > 0   
AND MTFTOCASHJV > 0   
AND MTFTOFOJV < 0   
*/  
IF @FORPARTY <> '%'  
BEGIN  
 SELECT * FROM TBL_PRODUCT_LED_ADJUST   
 WHERE SAUDA_DATE = @SAUDA_DATE AND CLTCODE = @FORPARTY  
  
 SELECT * FROM TBL_PRODUCT_POS_ADJUST_LED  
 WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @FORPARTY  
 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_LEDGER_ADJUST
-- --------------------------------------------------




CREATE PROC [dbo].[PROC_PRODUCT_LEDGER_ADJUST]            
(            
 @SAUDA_DATE  VARCHAR(11),            
 @FLAG   INT = 0             
)            
AS    
DECLARE @GLCODE VARCHAR(10)  ,         
   @PROCESSDATE DATETIME,      
   @SDTCUR varchar(11),    
   @LDTCUR varchar(11)

  
DECLARE @SQL VARCHAR(MAX) 

 SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER     
 WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR

  SET @PROCESSDATE = GETDATE()            

  
  UPDATE TBL_MTF_DATA SET MTFLEDBAL = VAMT  
  FROM (  
 SELECT VAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
 CLTCODE FROM LEDGER  
 WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
 AND VDT <= @SAUDA_DATE + ' 23:59'  
 GROUP BY CLTCODE  
  ) L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE  
    
  UPDATE TBL_MTF_DATA SET CMLEDBAL = VAMT  
  FROM (  
 SELECT VAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
 CLTCODE FROM ACCOUNT.DBO.LEDGER L, TBLCLIENTMARGIN T  
 WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
 AND VDT <= @SAUDA_DATE + ' 23:59'  
 AND T.PARTY_CODE = CLTCODE  
 GROUP BY CLTCODE  
  ) L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE  
  
truncate table TBL_LED_OTHER

SET @SQL = ' insert into TBL_LED_OTHER  select a.* from ( SELECT * from OPENQUERY( ''select VAMT = SUM(CASE WHEN DRCR = ''''C'''' THEN VAMT ELSE -VAMT END), CLTCODE '
set @sql=@sql + ' FROM ACCOUNT_AB.DBO.LEDGER L WHERE VDT BETWEEN ''''' + @SDTCUR + ''''' AND ''''' + @LDTCUR + ' 23:59:59'''' AND VDT <= ''''' + @SAUDA_DATE + ' 23:59'''' group by cltcode'') ) a ,' 
set @sql=@sql + ' TBLCLIENTMARGIN T  '
set @sql=@sql + '  WHERE T.PARTY_CODE = CLTCODE'
exec (@sql)

  UPDATE TBL_MTF_DATA SET CMLEDBAL = CMLEDBAL + VAMT  
  FROM  TBL_LED_OTHER L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE 
  
  
truncate table TBL_LED_OTHER
SET @SQL = ' insert into TBL_LED_OTHER select a.* from ( SELECT * from OPENQUERY( ''select VAMT = SUM(CASE WHEN DRCR = ''''C'''' THEN VAMT ELSE -VAMT END), CLTCODE '
set @sql=@sql + ' FROM ACCOUNTFO.DBO.LEDGER L WHERE VDT BETWEEN ''''' + @SDTCUR + ''''' AND ''''' + @LDTCUR + ' 23:59:59'''' AND VDT <= ''''' + @SAUDA_DATE + ' 23:59'''' group by cltcode'') ) a ,' 
set @sql=@sql + ' TBLCLIENTMARGIN T  '
set @sql=@sql + '  WHERE T.PARTY_CODE = CLTCODE'
exec (@sql)

  UPDATE TBL_MTF_DATA SET FOLEDBAL = VAMT  
  FROM  TBL_LED_OTHER L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE 
  
truncate table TBL_LED_OTHER
SET @SQL = ' insert into TBL_LED_OTHER select a.* from ( SELECT * from OPENQUERY( ''select VAMT = SUM(CASE WHEN DRCR = ''''C'''' THEN VAMT ELSE -VAMT END), CLTCODE '
set @sql=@sql + ' FROM ACCOUNTcurFO.DBO.LEDGER L WHERE VDT BETWEEN ''''' + @SDTCUR + ''''' AND ''''' + @LDTCUR + ' 23:59:59'''' AND VDT <= ''''' + @SAUDA_DATE + ' 23:59'''' group by cltcode'') ) a ,' 
set @sql=@sql + ' TBLCLIENTMARGIN T  '
set @sql=@sql + '  WHERE T.PARTY_CODE = CLTCODE'
exec (@sql) 
 
 
  UPDATE TBL_MTF_DATA SET FOLEDBAL = VAMT  
  FROM  TBL_LED_OTHER L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE 

  
truncate table TBL_LED_OTHER
SET @SQL = ' insert into TBL_LED_OTHER select a.* from ( SELECT * from OPENQUERY( ''select VAMT = SUM(CASE WHEN DRCR = ''''C'''' THEN VAMT ELSE -VAMT END), CLTCODE '
set @sql=@sql + ' FROM ACCOUNTNCDX.DBO.LEDGER L WHERE VDT BETWEEN ''''' + @SDTCUR + ''''' AND ''''' + @LDTCUR + ' 23:59:59'''' AND VDT <= ''''' + @SAUDA_DATE + ' 23:59'''' group by cltcode'') ) a ,' 
set @sql=@sql + ' TBLCLIENTMARGIN T  '
set @sql=@sql + '  WHERE T.PARTY_CODE = CLTCODE'
exec (@sql) 
 
 
  UPDATE TBL_MTF_DATA SET FOLEDBAL = VAMT  
  FROM  TBL_LED_OTHER L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE 
  
truncate table TBL_LED_OTHER
SET @SQL = ' insert into TBL_LED_OTHER select a.* from ( SELECT * from OPENQUERY( ''select VAMT = SUM(CASE WHEN DRCR = ''''C'''' THEN VAMT ELSE -VAMT END), CLTCODE '
set @sql=@sql + ' FROM ACCOUNTMCDX.DBO.LEDGER L WHERE VDT BETWEEN ''''' + @SDTCUR + ''''' AND ''''' + @LDTCUR + ' 23:59:59'''' AND VDT <= ''''' + @SAUDA_DATE + ' 23:59'''' group by cltcode'') ) a ,' 
set @sql=@sql + ' TBLCLIENTMARGIN T  '
set @sql=@sql + '  WHERE T.PARTY_CODE = CLTCODE'
exec (@sql) 
 
 
  UPDATE TBL_MTF_DATA SET FOLEDBAL = VAMT  
  FROM  TBL_LED_OTHER L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_LEDGER_ADJUST_bak_nov282019
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_PRODUCT_LEDGER_ADJUST]            
(            
 @SAUDA_DATE  VARCHAR(11),            
 @FLAG   INT = 0             
)            
AS    
DECLARE @GLCODE VARCHAR(10)  ,         
   @PROCESSDATE DATETIME,      
   @SDTCUR DATETIME,    
   @LDTCUR DATETIME

 
 SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER     
 WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR

  SET @PROCESSDATE = GETDATE()            
            
 SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'   

	SELECT PARTY_CODE, FUND_AMT = CONVERT(NUMERIC(18,2),SUM(NETAMT)), MTFSEG = CONVERT(NUMERIC(18,2),0), 
	CASHSEG = CONVERT(NUMERIC(18,2),0), FOSEG = CONVERT(NUMERIC(18,2),0), 
	MARGINSHORT = CONVERT(NUMERIC(18,2),0), CASHJV = CONVERT(NUMERIC(18,2),0), FOJV = CONVERT(NUMERIC(18,2),0)
	INTO #INTJVDATA 
	FROM  TBL_PRODUCT_POSITION 
	WHERE SAUDA_DATE <= @SAUDA_DATE 
	AND ADJUST_DATE > @SAUDA_DATE 
	AND SELL_BUY = 1
	GROUP BY PARTY_CODE

	INSERT INTO #INTJVDATA 
	SELECT L.CLTCODE,  FUND_AMT = 0, 
	MTFSEG =  SUM(CASE WHEN DRCR = 'C' THEN VAMT     
                             ELSE -VAMT     
                           END),   
           CASHSEG = 0, FOSEG = 0, MARGINSHORT = 0, CASHJV = CONVERT(NUMERIC(18,4),0), FOJV = CONVERT(NUMERIC(18,4),0)  
    FROM   LEDGER L, TBLCLIENTMARGIN M     
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
           AND L.CLTCODE = PARTY_CODE 
		AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
		AND CLTCODE NOT IN (SELECT PARTY_CODE FROM #INTJVDATA WHERE L.cltcode = #INTJVDATA.PARTY_CODE)
    GROUP  BY L.CLTCODE 
	/*
	INSERT INTO #INTJVDATA 
	SELECT L.CLTCODE,  FUND_AMT = 0, MTFSEG = 0,   
           CASHSEG = SUM(CASE     
                             WHEN DRCR = 'C' THEN VAMT     
                             ELSE -VAMT     
                           END), FOSEG = 0, MARGINSHORT = 0 , CASHJV = CONVERT(NUMERIC(18,4),0), FOJV = CONVERT(NUMERIC(18,4),0) 
    FROM   ACCOUNT.DBO.LEDGER L, TBLCLIENTMARGIN M     
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
           AND L.CLTCODE = PARTY_CODE 
		AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
    GROUP  BY L.CLTCODE     

	INSERT INTO #INTJVDATA  
    SELECT L.CLTCODE,     
           FUND_AMT = 0, MTFSEG = 0,   
           CASHSEG = SUM(CASE     
                             WHEN DRCR = 'C' THEN VAMT     
                             ELSE -VAMT     
                           END), FOSEG = 0, MARGINSHORT = 0, CASHJV = CONVERT(NUMERIC(18,4),0), FOJV = CONVERT(NUMERIC(18,4),0)  
    FROM   ANAND.ACCOUNT_AB.DBO.LEDGER L, TBLCLIENTMARGIN M        
    WHERE  L.VDT BETWEEN @SDTCUR AND @LDTCUR     
           AND L.VDT <= @SAUDA_DATE + ' 23:59:59'     
           AND L.CLTCODE = PARTY_CODE
		AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
    GROUP  BY L.CLTCODE
	*/
			
SELECT PARTY_CODE, FUND_AMT=SUM(FUND_AMT), MTFSEG=SUM(MTFSEG), 
CASHSEG = SUM(CASHSEG), FOSEG = SUM(FOSEG), MARGINSHORT = SUM(MARGINSHORT), 
CASHJV = SUM(CASHJV), FOJV = SUM(FOJV) 
INTO #INTJVDATA_FINAL 
FROM #INTJVDATA
GROUP BY PARTY_CODE

--UPDATE #INTJVDATA_FINAL SET CASHJV = ABS(MTFSEG)
  
UPDATE #INTJVDATA_FINAL SET CASHJV = ROUND(MTFSEG,2)
WHERE FUND_AMT = 0 AND MTFSEG <> 0

 SELECT SAUDA_DATE = @SAUDA_DATE,             
     PARTY_CODE, AMOUNT = ABS(CASHJV),            
     FLAG = 'CASH',            
     GLCODE = @GLCODE,            
     VNO = CONVERT(VARCHAR(12),''),            
     ACNAME = CONVERT(VARCHAR(200),''),            
     PROCESSDATE=@PROCESSDATE,            
     DRCR = (CASE WHEN CASHJV < 0 THEN 'C' ELSE 'D' END),
	 --NARR = 'MTF JV FROM'           
	 NARR =(CASE WHEN CASHJV < 0 THEN 'FOR RECOVERY OF INTEREST AND OTHER CHARGES' ELSE 'TRNF OF SURPLUS CREDIT FROM MTF TO' END)  
 INTO #JVDATA             
 FROM #INTJVDATA_FINAL        
WHERE CASHJV <> 0  

INSERT INTO #JVDATA             
 SELECT SAUDA_DATE = @SAUDA_DATE,             
     PARTY_CODE, AMOUNT = ABS(FOJV),            
     FLAG = 'FO',            
     GLCODE = @GLCODE,            
     VNO = CONVERT(VARCHAR(12),''),            
     ACNAME = CONVERT(VARCHAR(200),''),            
     PROCESSDATE=@PROCESSDATE,            
     DRCR = (CASE WHEN FOJV < 0 THEN 'C' ELSE 'D' END),
	 --NARR = 'MTF JV FROM'
	 NARR =(CASE WHEN FOJV < 0 THEN 'FOR RECOVERY OF INTEREST AND OTHER CHARGES' ELSE 'TRNF OF SURPLUS CREDIT FROM MTF TO' END)   
 FROM #INTJVDATA_FINAL        
WHERE FOJV <> 0  

 DELETE FROM MTF_JVDATA            
 WHERE SAUDA_DATE = @SAUDA_DATE            
            
 INSERT INTO MTF_JVDATA            
 SELECT SAUDA_DATE, PARTY_CODE, AMOUNT, FLAG, GLCODE, VNO, ACNAME, PROCESSDATE, DRCR              
 FROM #JVDATA            
             
 ALTER TABLE #JVDATA            
 ADD SNO INT IDENTITY(1,1)            
             
 DECLARE @VNO  VARCHAR(12),            
   @RECCNT  INT            
            
 SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA            
             
 IF @RECCNT > 0             
 BEGIN            
  CREATE TABLE #VNO            
  (            
   VNO VARCHAR(12)            
  )            
            
  INSERT INTO #VNO             
  EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT            
            
  SELECT @VNO = VNO FROM #VNO            
            
  UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)            
             
  UPDATE #JVDATA SET ACNAME = A.LONGNAME             
  FROM ACMAST A            
  WHERE #JVDATA.PARTY_CODE = A.CLTCODE            
             
  INSERT INTO LEDGER            
  SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(),             
  PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = NARR + ' ' + FLAG            
  FROM #JVDATA            
            
  INSERT INTO LEDGER            
  SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END),             
  AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(),             
  GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = NARR + ' ' + FLAG            
  FROM #JVDATA J, ACMAST A            
  WHERE J.GLCODE = A.CLTCODE            
            
  EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE   
  --EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
      /*
  UPDATE TBL_MTF_DATA SET MTFLEDBAL = VAMT  
  FROM (  
 SELECT VAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
 CLTCODE FROM LEDGER  
 WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
 AND VDT <= @SAUDA_DATE + ' 23:59'  
 GROUP BY CLTCODE  
  ) L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE  
    
  UPDATE TBL_MTF_DATA SET CMLEDBAL = VAMT  
  FROM (  
 SELECT VAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
 CLTCODE FROM ACCOUNT.DBO.LEDGER L, TBLCLIENTMARGIN T  
 WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
 AND VDT <= @SAUDA_DATE + ' 23:59'  
 AND T.PARTY_CODE = CLTCODE  
 GROUP BY CLTCODE  
  ) L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE  

  UPDATE TBL_MTF_DATA SET CMLEDBAL = CMLEDBAL + VAMT  
  FROM (  
 SELECT VAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),  
 CLTCODE FROM ANAND.ACCOUNT_AB.DBO.LEDGER L, TBLCLIENTMARGIN T  
 WHERE VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'  
 AND VDT <= @SAUDA_DATE + ' 23:59'  
 AND T.PARTY_CODE = CLTCODE  
 GROUP BY CLTCODE  
  ) L  
  WHERE SAUDA_DATE = @SAUDA_DATE  
  AND PARTY_CODE = CLTCODE 
      */
 END  

DROP TABLE #INTJVDATA
DROP TABLE #INTJVDATA_FINAL
DROP TABLE #JVDATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_BAK_04122025
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)

/*--- ADDED NEW CONDITION FOR NEW MTF ---*/

DECLARE	@MMNETAMT	NUMERIC(18,4)

SELECT	PARTY_CODE,NETAMT = SUM((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100)
INTO	#MMQTY_ALLOC
FROM	#MTFADJDATA
WHERE	HOLDFLAG = 'MMQTY'
GROUP BY PARTY_CODE

/*--- ADDED NEW CONDITION FOR NEW MTF ---*/
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		/*--- ADDED NEW CONDITION FOR NEW MTF ---*/

		SET @MMNETAMT = 0
		SELECT @MMNETAMT = SUM(NETAMT) FROM #MMQTY_ALLOC WHERE PARTY_CODE=@PARTY_CODE

		IF @MMNETAMT > 0
		BEGIN
			UPDATE	#MTFADJDATA 
			SET		ADJQTY = QTY,
					ADJAMT = ((QTY*CL_RATE)-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100)
			WHERE	PARTY_CODE = @PARTY_CODE
					AND EXISTS (SELECT PARTY_CODE FROM #MMQTY_ALLOC WHERE #MMQTY_ALLOC.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
			

			IF (@MTF_REQ - @MMNETAMT) > 0
			BEGIN
				SET @MTF_REQ = @MTF_REQ - @MMNETAMT
			END
			ELSE
			BEGIN
				SET @MTF_REQ = 0
			END

		END
		
		/*--- ADDED NEW CONDITION FOR NEW MTF ---*/
		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG in ('CMCOLL','MMQTY') THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG in ('FOCOLL','MMQTY') THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/


UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0


UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA 
	WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA SET                
CASHLEDADJ = TBL_MTF_DATA.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA.PARTY_CODE = #EXCESSMAR.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC MSAJAGDEMAT.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM MSAJAGDEMAT.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	/*--- ADDED NEW CONDITION FOR NEW MTF ---*/	

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=ADJQTY,HOLDFLAG, RUNDATE=GETDATE()
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'MMQTY'
	AND ADJQTY > 0
	--AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_MARKING T WHERE T.PARTY_CODE = #MTFADJDATA.PARTY_CODE AND T.ISIN = #MTFADJDATA.ISIN)
	
	/*--- ADDED NEW CONDITION FOR NEW MTF ---*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
 --AND CASHLEDADJ <> 0   --- NEW MTF CHANGES ( STOP REVERSAL JV )
 AND CASHLEDADJ > 0
  
	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
 --AND FOLEDBALADJ <> 0   --- NEW MTF CHANGES ( STOP REVERSAL JV )
 AND FOLEDBALADJ > 0
      
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
	
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	
	EXEC MSAJAGDEMAT.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_Bak_20240712
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
Create PROC [dbo].[PROC_PRODUCT_PFADJUST_Bak_20240712]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
 
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/

UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA 
	WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA SET                
CASHLEDADJ = TBL_MTF_DATA.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA.PARTY_CODE = #EXCESSMAR.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND CASHLEDADJ <> 0 

	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND FOLEDBALADJ <> 0 
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
	
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_bak_nov282019
-- --------------------------------------------------

-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 1 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ				NUMERIC(18,4),
		@SDTCUR				DATETIME,
		@LDTCUR				DATETIME
		
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER 
WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR		
	
SELECT PARTY_CODE, 
	   MTF_REQ   = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL),
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, POAHOLDING_APP = POAHOLDING_MTF,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,4),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,4),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,4),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,4),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,4),0), 
	   POAADJ =  CONVERT(NUMERIC(18,4),0)
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF

SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SET @MTFCUR = CURSOR FOR
SELECT PARTY_CODE, MTF_REQ = ABS(MTF_REQ), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
WHILE @@FETCH_STATUS = 0 
BEGIN 
	SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD) 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'BEN'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN			
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO
					
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG = 'BEN' THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

CREATE INDEX #CLCODE ON #MARREQ 
(PARTY_CODE)


	
/*
UPDATE #MARREQ SET FOCASHCOLL = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ + CASHCOLLADJ + FOLEDBALADJ) > FOCASHCOLL 
									   THEN FOCASHCOLL
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ + CASHCOLLADJ + FOLEDBALADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ + CASHCOLLADJ + FOLEDBALADJ) < 0 
AND   FOCASHCOLL > 0 AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
*/

UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE
*/
IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	CREATE NONCLUSTERED INDEX party ON MTF_DELDATA
	(
		party_code
	)
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	
	/*
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA

	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)

CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
(
	SNO
)
 
	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			*/
			DECLARE @PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()
	/*
	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE in (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	*/
	SELECT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = #MARREQ.CASHLEDADJ,
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'C'
	INTO #JVDATA 
	FROM #MARREQ
	WHERE CASHLEDADJ > 0 

	INSERT INTO #JVDATA 
	SELECT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = #MARREQ.FOLEDBALADJ,
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'C'
	FROM #MARREQ
	WHERE FOLEDBALADJ > 0 

	INSERT INTO #JVDATA
	SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)), 
	FLAG = 'CASH', GLCODE = @GLCODE, 
	VNO = CONVERT(VARCHAR(12),''),
    ACNAME = CONVERT(VARCHAR(200),''),
    PROCESSDATE=@PROCESSDATE,
	DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (
	SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER 
	WHERE VDT >= @SDTCUR
	AND VDT <= @LDTCUR + ' 23:59:59'
	AND VDT <= @SAUDA_DATE + ' 23:59:59'
	AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')
	AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)
	GROUP BY CLTCODE 
	UNION ALL
	SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND ADJUST_DATE = @SAUDA_DATE
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')
	AND SELL_BUY = 1 
	GROUP BY PARTY_CODE 
	UNION ALL
	SELECT PARTY_CODE, AMOUNT=-SUM(NETAMT) FROM TBL_PRODUCT_POSITION (NOLOCK)
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN (NOLOCK) WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59'
	AND TBLCLIENTMARGIN.Party_Code = TBL_PRODUCT_POSITION.PARTY_CODE )
	AND SELL_BUY = 1 
	GROUP BY PARTY_CODE
	) A
	GROUP BY cltcode 
	HAVING SUM(AMOUNT) <> 0 

	INSERT INTO   #JVDATA
	SELECT SAUDA_DATE = @SAUDA_DATE, 
	   PARTY_CODE=CLTCODE, AMOUNT = ABS(MTFTOCASHJV),
	   FLAG = 'CASH',
	   GLCODE = @GLCODE,
	   VNO = CONVERT(VARCHAR(12),''),
	   ACNAME = CONVERT(VARCHAR(200),''),
	   PROCESSDATE=@PROCESSDATE,
	   DRCR = (CASE WHEN MTFTOCASHJV < 0 THEN 'D' ELSE 'C' END)
	FROM TBL_PRODUCT_LED_ADJUST
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND MTFTOCASHJV <> 0

	INSERT INTO   #JVDATA
	SELECT SAUDA_DATE = @SAUDA_DATE, 
	   PARTY_CODE=CLTCODE, AMOUNT = ABS(MTFTOFOJV),
	   FLAG = 'CASH',
	   GLCODE = @GLCODE,
	   VNO = CONVERT(VARCHAR(12),''),
	   ACNAME = CONVERT(VARCHAR(200),''),
	   PROCESSDATE=@PROCESSDATE,
	   DRCR = (CASE WHEN MTFTOFOJV < 0 THEN 'D' ELSE 'C' END)
	FROM TBL_PRODUCT_LED_ADJUST
	WHERE SAUDA_DATE = @SAUDA_DATE	
	AND MTFTOFOJV <> 0	
	
	INSERT INTO   #JVDATA
	SELECT SAUDA_DATE = @SAUDA_DATE, 
	   PARTY_CODE=CLTCODE, AMOUNT = ABS(MTFTOFOJV),
	   FLAG = 'FO',
	   GLCODE = @GLCODE,
	   VNO = CONVERT(VARCHAR(12),''),
	   ACNAME = CONVERT(VARCHAR(200),''),
	   PROCESSDATE=@PROCESSDATE,
	   DRCR = (CASE WHEN MTFTOFOJV < 0 THEN 'C' ELSE 'D' END)
	FROM TBL_PRODUCT_LED_ADJUST
	WHERE SAUDA_DATE = @SAUDA_DATE	
	AND MTFTOFOJV <> 0	
	
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT SAUDA_DATE,PARTY_CODE,
	AMOUNT = ABS(SUM(CASE WHEN DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END)),
	FLAG,GLCODE,VNO,ACNAME,PROCESSDATE,
	DRCR=(CASE WHEN SUM(CASE WHEN DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END) > 0 
			   THEN 'C'
			   ELSE 'D'
		  END) 
	FROM #JVDATA
	GROUP BY SAUDA_DATE, PARTY_CODE, FLAG, GLCODE,VNO,ACNAME,PROCESSDATE
	HAVING SUM(CASE WHEN DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END) <> 0

	TRUNCATE TABLE #JVDATA 
	INSERT INTO #JVDATA
	SELECT * FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE
	
	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
 
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT
			
	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA
	
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG + ' SEGMENT'
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, 
		DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), 
		AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG + ' SEGMENT'
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	--EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_BKP_20250409
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST_BKP_20250409]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
 
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/

UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA 
	WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA SET                
CASHLEDADJ = TBL_MTF_DATA.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA.PARTY_CODE = #EXCESSMAR.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND CASHLEDADJ <> 0 

	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND FOLEDBALADJ <> 0 
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
	
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_BKUP_05SEP2025
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
 
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/


UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0


UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA 
	WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA SET                
CASHLEDADJ = TBL_MTF_DATA.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA.PARTY_CODE = #EXCESSMAR.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND CASHLEDADJ <> 0 

	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND FOLEDBALADJ <> 0 
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
	
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_NEW
-- --------------------------------------------------

-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST_NEW]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

SET NOCOUNT ON 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ				NUMERIC(18,4),
		@SDTCUR				VARCHAR(11),
		@LDTCUR				VARCHAR(11)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
	
SELECT PARTY_CODE, 
	   MTF_REQ   = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL),
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, POAHOLDING_APP = POAHOLDING_MTF,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,4),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,4),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,4),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,4),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,4),0), 
	   POAADJ =  CONVERT(NUMERIC(18,4),0)
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF

SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0),
MARKEDQTY=0
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

UPDATE #MTFADJDATA SET MARKEDQTY = RequestedQuantity
FROM MSAJAG.DBO.MTF_RMS_REQUEST_CLT MTF_RMS_REQUEST_CLT
WHERE PARTY_CODE = ClientCode
AND #MTFADJDATA.ISIN = MTF_RMS_REQUEST_CLT.ISIN 
AND HOLDFLAG = 'POA'

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)


SET @MTFCUR = CURSOR FOR
SELECT PARTY_CODE, MTF_REQ = ABS(MTF_REQ), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE > 0 AND CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 AND CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 AND CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 AND CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 AND FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) ELSE 0 END),
	   POAHOLDING_APP
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 AND POAHOLDING > 0
ORDER BY PARTY_CODE
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (MARKEDQTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((MARKEDQTY - ADJQTY)*CL_RATE-(MARKEDQTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (MARKEDQTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR
 
UPDATE #MARREQ SET 
		POAADJ = POAAMT,
		POAHOLDING_APP = POAHOLDING_APP - POAAMT,
		MTF_REQ = MTF_REQ + POAAMT,
		POAHOLDING = POAHOLDING - POAAMT
FROM (SELECT PARTY_CODE, 
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT PARTY_CODE, MTF_REQ = ABS(MTF_REQ), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE > 0 AND CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 AND CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 AND CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 AND CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 AND FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) ELSE 0 END),
	   POAHOLDING_APP=POAHOLDING_APP
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    (MTF_REQ) < 0 
ORDER BY PARTY_CODE
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.FNMIN(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'BEN'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 					 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))

					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.FNMIN(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					SET @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.FNMIN(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					SET @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR
 
UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG = 'BEN' THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)
	
	EXEC angeldemat.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM MSAJAG.DBO.MTF_DELDATA
		
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)

CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
(
	SNO
)
 
	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE = 904  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR

	SELECT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = #MARREQ.CASHLEDADJ,
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'C'
	INTO #JVDATA 
	FROM #MARREQ
	WHERE CASHLEDADJ > 0 

	INSERT INTO #JVDATA 
	SELECT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = #MARREQ.FOLEDBALADJ,
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'C'
	FROM #MARREQ
	WHERE FOLEDBALADJ > 0 
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND VTYP <> (CASE WHEN VDT LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY CLTCODE     
	 HAVING SUM(AMOUNT) <> 0     
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
 
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA
	
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC angelfo.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	EXEC angeldemat.MSAJAG.DBO.PROC_MTF_SHIFTING
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_NEWMTF
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST_NEWMTF]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

	/*--- ADDED NEW CONDITION FOR NEW MTF ----*/
	
	EXEC PROC_PRODUCT_TDAY_ALLOC  @SAUDA_DATE,'','ZZZZZZZ'

	/*--- ADDED NEW CONDITION FOR NEW MTF ----*/

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA_BUY
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA_BUY.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
 
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/


UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0


UPDATE TBL_MTF_DATA_BUY SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA_BUY.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA_BUY.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA_BUY          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA_BUY.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA_BUY WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA_BUY 
	WHERE TBL_MTF_DATA_BUY.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA_BUY.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA_BUY SET                
CASHLEDADJ = TBL_MTF_DATA_BUY.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA_BUY.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA_BUY.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA_BUY.PARTY_CODE = #EXCESSMAR.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10),
	@PROCESSDATE	DATETIME

	SET		@PROCESSDATE = GETDATE()

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	/*
	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	*/
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA_BUY.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA_BUY.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA_BUY
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND CASHLEDADJ <> 0
	AND 1=2

	ALTER TABLE #JVDATA
	ALTER CoLumn FLAG VARCHAR(6)



	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA_BUY.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA_BUY.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA_BUY
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND FOLEDBALADJ <> 0 
	AND 1=2
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A   
	 WHERE 1=2
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA_BUY WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A 
	 WHERE 1=2
	 GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	 

	 	/*--- ADDED NEW CONDITION FOR NEW MTF ---*/

	SELECT	PARTY_CODE,
			CASH_ADJ = ROUND(MAX(CASE WHEN CASHLEDADJ > 0 THEN CASHLEDADJ ELSE 0 END + CASE WHEN FOLEDBALADJ > 0 THEN FOLEDBALADJ ELSE 0 END),2),
			MTOM_LOSS = ROUND(SUM(MTOM_LOSS),2),
			PAYIN_AMT = CONVERT(NUMERIC(18,4),0), --CASE WHEN (MAX(CASHLEDADJ+FOLEDBALADJ)-SUM(MTOM_LOSS)) > 0 THEN MAX(CASHLEDADJ+FOLEDBALADJ)-SUM(MTOM_LOSS) ELSE 0 END,
			MARGIN_REQ = CONVERT(NUMERIC(18,4),0),
			PREV_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),
			REMARK = (
			CASE 
				WHEN MAX(CASHLEDADJ) > 0 AND MAX(FOLEDBALADJ) > 0 THEN 'CASHFO'
				WHEN MAX(CASHLEDADJ) > 0 AND MAX(FOLEDBALADJ) = 0 THEN 'CASH'
				WHEN MAX(CASHLEDADJ) = 0 AND MAX(FOLEDBALADJ) > 0 THEN 'FO'
				ELSE ''
			END),
			SAUDA_DATE = @SAUDA_DATE,
			FLAG = CONVERT(VARCHAR(20),'PAYIN_RB_D')
	INTO	#PAYIN
	FROM	TBL_MTF_DATA M(NOLOCK)
	WHERE	SAUDA_DATE = @SAUDA_DATE 
	GROUP BY
			PARTY_CODE
	HAVING	MAX(CASE WHEN CASHLEDADJ > 0 THEN CASHLEDADJ ELSE 0 END + CASE WHEN FOLEDBALADJ > 0 THEN FOLEDBALADJ ELSE 0 END) > 0


	UPDATE	#PAYIN
	SET		MARGIN_REQ = ISNULL(A.MARGIN_REQ,0)
	FROM	(
			SELECT	PARTY_CODE, MARGIN_REQ = SUM(MARGIN_REQ)
			FROM	TBL_MTF_DATA_BUY M(NOLOCK)
			WHERE	SAUDA_DATE = @SAUDA_DATE 
			GROUP BY PARTY_CODE
			) A
	WHERE	A.PARTY_CODE =  #PAYIN.PARTY_CODE

	
	--INSERT INTO #JVDATA 
	--SELECT SAUDA_DATE = @SAUDA_DATE, 
	--	   PARTY_CODE, AMOUNT = MTOM_LOSS,
	--	   FLAG = 'MTM',
	--	   GLCODE = @GLCODE,
	--	   VNO = CONVERT(VARCHAR(12),''),
	--	   ACNAME = CONVERT(VARCHAR(200),''),
	--	   PROCESSDATE=@PROCESSDATE,
	--	   DRCR = 'D'
	--FROM   #PAYIN
	----WHERE  PAYIN_AMT > 0


	DECLARE	@PRE_SAUDADATE	VARCHAR(11)

	SELECT	@PRE_SAUDADATE = LEFT(MAX(SAUDA_DATE),11)
	FROM	TBL_MTF_DATA M(NOLOCK)
	WHERE	SAUDA_DATE < @SAUDA_DATE 

	
	CREATE	TABLE #MTM_PRE
		(
		SAUDA_DATE	DATETIME,
		PARTY_CODE	VARCHAR(20),
		AMOUNT		NUMERIC(18,4),
		FLAG		VARCHAR(20),
		GLCODE		VARCHAR(20),
		VNO			VARCHAR(12),
		ACNAME		VARCHAR(200),
		PROCESSDATE DATETIME,
		DRCR		CHAR(1),
		CASH_ADJ	NUMERIC(18,4)
		)


	SELECT * INTO #PAYIN_PREV FROM #PAYIN WHERE 1 = 2

	--IF (SELECT COUNT(1) FROM MTF_MTM_LEDGER WHERE VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59') = 0
	
	IF ( SELECT COUNT(1) FROM LEDGER WHERE VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59' AND VTYP = 67 ) = 0
	BEGIN

			SELECT	CLTCODE, CASH_VAMT = SUM(CASH_VAMT), MTM_VAMT = SUM(MTM_VAMT), PREV_MTOM_LOSS = CONVERT(NUMERIC(18,4),0)
			INTO	#REV_LEDCASH
			FROM	(
					SELECT	CLTCODE, CASH_VAMT = SUM(L.VAMT), MTM_VAMT = SUM(0)
					FROM	LEDGER L WITH (NOLOCK)
					WHERE	VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59'
							AND CHECKEDBY='MTF PROCESS' AND DRCR='C'
					GROUP BY
							CLTCODE

					UNION

					SELECT	PARTY_CODE, CASH_VAMT = SUM(0), MTM_VAMT = SUM(MTOM_LOSS)
					FROM	TBL_MTF_DATA M WITH (NOLOCK)
					WHERE	SAUDA_DATE BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59'
					GROUP BY
							PARTY_CODE
					HAVING	SUM(MTOM_LOSS) > 0
					) A
			GROUP BY CLTCODE
			HAVING	SUM(CASH_VAMT) > 0


			UPDATE	#REV_LEDCASH
			SET		PREV_MTOM_LOSS = PRADNYA.DBO.FNMIN(CASH_VAMT,MTM_VAMT)


			INSERT	INTO #PAYIN_PREV
			SELECT	PARTY_CODE = CLTCODE,
					CASH_ADJ = SUM(CASH_VAMT),
					MTOM_LOSS = SUM(0),
					PAYIN_AMT = CONVERT(NUMERIC(18,4),0),
					MARGIN_REQ = CONVERT(NUMERIC(18,4),0),
					PREV_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),
					REMARK = 'OB_C',
					SAUDA_DATE = @PRE_SAUDADATE,
					FLAG = 'PAYIN_OB_C'
			FROM	#REV_LEDCASH M(NOLOCK)
			GROUP BY
					CLTCODE
			HAVING	SUM(CASH_VAMT) > 0			


			INSERT	INTO #PAYIN_PREV
			SELECT	PARTY_CODE = CLTCODE,
					CASH_ADJ = SUM(PREV_MTOM_LOSS),
					MTOM_LOSS = SUM(0),
					PAYIN_AMT = CONVERT(NUMERIC(18,4),0),
					MARGIN_REQ = CONVERT(NUMERIC(18,4),0),
					PREV_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),
					REMARK = 'OB_D',
					SAUDA_DATE = @PRE_SAUDADATE,
					FLAG = 'PAYIN_OB_D'
			FROM	#REV_LEDCASH M(NOLOCK)
			GROUP BY
					CLTCODE
			HAVING	SUM(PREV_MTOM_LOSS) > 0 


			INSERT	INTO #PAYIN_PREV
			SELECT	PARTY_CODE = CLTCODE,
					CASH_ADJ = SUM(PREV_MTOM_LOSS),
					MTOM_LOSS = SUM(0),
					PAYIN_AMT = CONVERT(NUMERIC(18,4),0),
					MARGIN_REQ = CONVERT(NUMERIC(18,4),0),
					PREV_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),
					REMARK = 'OB_MTM',
					SAUDA_DATE = @PRE_SAUDADATE,
					FLAG = 'MTM_OB_C'
			FROM	#REV_LEDCASH M(NOLOCK)
			GROUP BY
					CLTCODE
			HAVING	SUM(PREV_MTOM_LOSS) > 0 

			
			INSERT	INTO #PAYIN_PREV
			SELECT	PARTY_CODE = CLTCODE,
					CASH_ADJ = SUM(PREV_MTOM_LOSS),
					MTOM_LOSS = SUM(0),
					PAYIN_AMT = CONVERT(NUMERIC(18,4),0),
					MARGIN_REQ = CONVERT(NUMERIC(18,4),0),
					PREV_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),
					REMARK = 'OB_MTM',
					SAUDA_DATE = @SAUDA_DATE,
					FLAG = 'MTMREV_OB_D'
			FROM	#REV_LEDCASH M(NOLOCK)
			GROUP BY
					CLTCODE
			HAVING	SUM(PREV_MTOM_LOSS) > 0


			--INSERT	INTO #MTM_PRE
			--SELECT	SAUDA_DATE = @SAUDA_DATE, 
			--		PARTY_CODE = CLTCODE, 
			--		AMOUNT = SUM(PREV_MTOM_LOSS),
			--		FLAG = 'MTMREV_RB_D',
			--		GLCODE = @GLCODE,
			--		VNO = CONVERT(VARCHAR(12),''),
			--		ACNAME = CONVERT(VARCHAR(200),''),
			--		PROCESSDATE=@PROCESSDATE,
			--		DRCR = 'D',
			--		CASH_ADJ = SUM(PREV_MTOM_LOSS)
			--FROM	#REV_LEDCASH M(NOLOCK)
			--GROUP BY
			--		CLTCODE
			--HAVING	SUM(PREV_MTOM_LOSS) > 0

	END
	ELSE
	BEGIN

			INSERT	INTO #MTM_PRE
			SELECT	SAUDA_DATE = @SAUDA_DATE, 
					PARTY_CODE = CLTCODE, 
					AMOUNT = SUM(VAMT),
					FLAG = 'MTM REV',
					GLCODE = @GLCODE,
					VNO = CONVERT(VARCHAR(12),''),
					ACNAME = CONVERT(VARCHAR(200),''),
					PROCESSDATE=@PROCESSDATE,
					DRCR = 'D',
					CASH_ADJ = SUM(VAMT)
			FROM	LEDGER M WITH (NOLOCK)
			WHERE	VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59'
					AND (NARRATION LIKE '%BEING THE T DAY MTM TRF FROM CASH COLL LEDGER' 
					OR NARRATION LIKE '%MTF MTM') 
					AND DRCR='C'
					AND CHECKEDBY = 'MTF PROCESS'
					AND VTYP = '67'
			GROUP BY
					CLTCODE
	
	END

	--SELECT '#MTM_PRE-1',* FROM #MTM_PRE WHERE PARTY_CODE='600A3810'
	--SELECT '##PAYIN_PREV',* FROM #PAYIN_PREV WHERE PARTY_CODE='600A3810'
	
	/*
	UPDATE	#PAYIN
	SET		PREV_MTOM_LOSS = ISNULL(A.PREV_MTOM_LOSS,0)
	FROM	(
			SELECT	PARTY_CODE,
					PREV_MTOM_LOSS = (
					CASE 
						WHEN SUM(AMOUNT) > SUM(CASH_ADJ) THEN SUM(CASH_ADJ) 
						ELSE SUM(AMOUNT) 
					END)
			FROM	#MTM_PRE 
			GROUP BY
					PARTY_CODE
			) A
	WHERE	A.PARTY_CODE = #PAYIN.PARTY_CODE  
	*/


	IF (SELECT COUNT(1) FROM #PAYIN_PREV) > 0
	BEGIN
		UPDATE	#PAYIN
		SET		PREV_MTOM_LOSS = ROUND(ISNULL(A.CASH_ADJ,0),2)
		FROM	#PAYIN_PREV A
		WHERE	A.PARTY_CODE = #PAYIN.PARTY_CODE  
				AND A.FLAG = 'MTMREV_OB_D'
	END
	ELSE
	BEGIN
		UPDATE	#PAYIN
		SET		PREV_MTOM_LOSS = ROUND(ISNULL(A.AMOUNT,0),2)
		FROM	#MTM_PRE A
		WHERE	A.PARTY_CODE = #PAYIN.PARTY_CODE
	END


	UPDATE	#MTM_PRE
	SET		AMOUNT = ISNULL(PREV_MTOM_LOSS,AMOUNT)
	FROM	#PAYIN
	WHERE	#PAYIN.PARTY_CODE = #MTM_PRE.PARTY_CODE
 

	--UPDATE	#PAYIN
	--SET		MTOM_LOSS = (CASH_ADJ+PREV_MTOM_LOSS-MTOM_LOSS)
	--WHERE	(CASH_ADJ+PREV_MTOM_LOSS-MTOM_LOSS) > 0

	--SELECT '#MTM_PRE-2',* FROM #MTM_PRE WHERE PARTY_CODE='600A3810'
	--SELECT '#PAYIN',* FROM #PAYIN WHERE PARTY_CODE='600A3810'

	UPDATE	#PAYIN
	SET		MTOM_LOSS = PRADNYA.DBO.FNMIN((CASH_ADJ+PREV_MTOM_LOSS),MTOM_LOSS)
	WHERE	((CASH_ADJ+PREV_MTOM_LOSS)+MTOM_LOSS) > 0


	INSERT INTO #JVDATA 
	SELECT SAUDA_DATE = SAUDA_DATE, 
		   PARTY_CODE, 
		   AMOUNT = MTOM_LOSS,
		   FLAG = 'MTM',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'D'
	FROM   #PAYIN

	/*--- CRUCIAL PAYIN CALCULATION ---*/

	SELECT	PARTY_CODE=CLTCODE, NARRATION='', AMOUNT=SUM(VAMT), DRCR='D'
	INTO	#INTREST_ADJ_PAYIN FROM LEDGER WHERE VDT = @SAUDA_DATE AND VTYP IN ('6','8') 
			AND NARRATION LIKE 'Interest%'
			AND RIGHT(RTRIM(LTRIM(CLTCODE)),4) NOT IN ('CGST','SGST','IGST')
	GROUP BY CLTCODE


	UPDATE	#PAYIN
	SET		PAYIN_AMT = ((CASH_ADJ - MTOM_LOSS) + PREV_MTOM_LOSS)
	WHERE	((CASH_ADJ - MTOM_LOSS) + PREV_MTOM_LOSS) > 0


	UPDATE	#PAYIN
	SET		PAYIN_AMT = PAYIN_AMT - ISNULL(AMOUNT,0)
	FROM	#INTREST_ADJ_PAYIN P
	WHERE	P.PARTY_CODE = #PAYIN.PARTY_CODE
			AND ISNULL(AMOUNT,0) > 0 
			AND PAYIN_AMT > 0


	--SELECT 'NEW ING - #PAYIN -1', * FROM #PAYIN WHERE PARTY_CODE='600A3810'

	INSERT INTO #JVDATA 
	SELECT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, 
		   AMOUNT = PRADNYA.DBO.FNMIN(PAYIN_AMT,MARGIN_REQ),
		   FLAG = 'PAYIN',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = 'D'
	FROM   #PAYIN
	WHERE  PRADNYA.DBO.FNMIN(PAYIN_AMT,MARGIN_REQ) > 0 

	--SELECT '#PAYIN', * FROM #PAYIN WHERE PARTY_CODE='600A3810'
	--SELECT 'NEW ING - #PAYIN-2', * FROM #PAYIN WHERE PARTY_CODE='600A3810'

	/*
	SELECT	SAUDA_DATE = @SAUDA_DATE, 
			PARTY_CODE = CLTCODE, 
			AMOUNT = SUM(VAMT),
			FLAG = 'MTM REV',
			GLCODE = @GLCODE,
			VNO = CONVERT(VARCHAR(12),''),
			ACNAME = CONVERT(VARCHAR(200),''),
			PROCESSDATE=@PROCESSDATE,
			DRCR = 'D'
	INTO	#MTM_PRE
	FROM	MTF_MTM_LEDGER M(NOLOCK)
	WHERE	VDT BETWEEN @PRE_SAUDADATE AND @PRE_SAUDADATE + ' 23:59'
	GROUP BY
			CLTCODE
	HAVING	SUM(VAMT) > 0
	*/

	--SELECT '#JVDATA',* FROM #JVDATA WHERE PARTY_CODE ='100A026'
	--SELECT '#PAYIN',* FROM #PAYIN WHERE PARTY_CODE ='100A026'

	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA where 1=2

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)	

	ALTER TABLE #MTM_PRE
	ADD SNO	INT	IDENTITY(1,1)

	ALTER TABLE #PAYIN_PREV
	ADD SNO		INT	IDENTITY(1,1),
		VNO		VARCHAR(12),
		ACNAME	VARCHAR(200),
		GLCODE	VARCHAR(20)


	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT,
			@EDT		VARCHAR(11)

	SELECT	@EDT = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
	WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT	INTO #VNO 
		EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT	@VNO = VNO FROM #VNO

		UPDATE	#JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#JVDATA SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#JVDATA.PARTY_CODE = A.CLTCODE

		UPDATE	#MTM_PRE SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#MTM_PRE SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#MTM_PRE.PARTY_CODE = A.CLTCODE

		UPDATE	#PAYIN_PREV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#PAYIN_PREV SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#PAYIN_PREV.PARTY_CODE = A.CLTCODE

		UPDATE	#PAYIN_PREV SET GLCODE = @GLCODE
		

		--INSERT INTO LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE ' + FLAG  + ' SEGMENT'
		--FROM #JVDATA

		--INSERT INTO LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE ' + FLAG + ' SEGMENT'
		--FROM #JVDATA J, ACMAST A
		--WHERE J.GLCODE = A.CLTCODE

		--INSERT INTO MTF_CASH_COLL_LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE ' + FLAG  + ' SEGMENT'
		--FROM #JVDATA

		--INSERT INTO MTF_CASH_COLL_LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE ' + FLAG + ' SEGMENT'
		--FROM #JVDATA J, ACMAST A
		--WHERE J.GLCODE = A.CLTCODE

			
		------------------------------------ FRIST TIME MTF ---------------------------------------------

		---- MTF_CASH_COLL_LEDGER -------------------------
		/*--- COMMENTED ON DATE : 10/06/2025 [ FOLLOWING LOGIC IS FOR OPENING MTF CASH COLL LEDGER BASE ON MTF LEDGER CR ENTRY ] ------*/
		/*
		INSERT INTO LEDGER
		SELECT '6', VNO, SAUDA_DATE, LNO=1, ACNAME, DRCR='C', AMOUNT=ROUND(CASH_ADJ,2), SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '1.BEING THE OPENING BALANCE JV FOR CASH COLL'
		FROM #PAYIN_PREV
		WHERE FLAG = 'PAYIN_OB_C'
		AND CASH_ADJ <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, SAUDA_DATE, LNO=1, A.ACNAME, DRCR='D', AMOUNT=ROUND(CASH_ADJ,2), SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '1.BEING THE OPENING BALANCE JV FOR CASH COLL'
		FROM #PAYIN_PREV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'PAYIN_OB_C'
		AND CASH_ADJ <> 0
		*/
		/*--- COMMENTED ON DATE : 10/06/2025 [ FOLLOWING LOGIC IS FOR OPENING MTF CASH COLL LEDGER BASE ON MTF LEDGER CR ENTRY ] ------*/


		INSERT INTO LEDGER
		SELECT '6', VNO, SAUDA_DATE, LNO=1, ACNAME, DRCR='D', AMOUNT=ROUND(CASH_ADJ,2), SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '2.BEING THE OPENING BALANCE JV TRF TO MTM'
		FROM #PAYIN_PREV
		WHERE FLAG = 'PAYIN_OB_D'
		AND CASH_ADJ <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, SAUDA_DATE, LNO=1, A.ACNAME, DRCR='C', AMOUNT=ROUND(CASH_ADJ,2), SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '02', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '2.BEING THE OPENING BALANCE JV TRF TO MTM'
		FROM #PAYIN_PREV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'PAYIN_OB_D'
		AND CASH_ADJ <> 0


		---- MTF_MTM_LEDGER -------------------------
		
		INSERT INTO LEDGER
		SELECT '67', VNO, SAUDA_DATE, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(CASH_ADJ,2), SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '3.BEING THE OPENING BALANCE JV TRF FROM CASH COLL'
		FROM #PAYIN_PREV
		WHERE FLAG = 'MTM_OB_C'
		AND CASH_ADJ <> 0

		INSERT INTO LEDGER
		SELECT '67', VNO, SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(CASH_ADJ,2), SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '3.BEING THE OPENING BALANCE JV TRF FROM CASH COLL'
		FROM #PAYIN_PREV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'MTM_OB_C'
		AND CASH_ADJ <> 0		


		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ROUND(CASH_ADJ,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '4.BEING THE OPENING BALANCE JV TRF TO CASH COLL'
		FROM #PAYIN_PREV
		WHERE FLAG = 'MTMREV_OB_D'
		AND CASH_ADJ <> 0

		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ROUND(CASH_ADJ,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '4.BEING THE OPENING BALANCE JV TRF TO CASH COLL'
		FROM #PAYIN_PREV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'MTMREV_OB_D'
		AND CASH_ADJ <> 0		

		----- MTF_CASH_COLL_LEDGER -------------

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(CASH_ADJ,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '5.BEING THE OPENING BALANCE JV TRF FROM MTM'
		FROM #PAYIN_PREV
		WHERE FLAG = 'MTMREV_OB_D'
		AND CASH_ADJ <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(CASH_ADJ,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '5.BEING THE OPENING BALANCE JV TRF FROM MTM'
		FROM #PAYIN_PREV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'MTMREV_OB_D'
		AND CASH_ADJ <> 0		


		------------------------------------ FRIST TIME MTF ---------------------------------------------


		------------------------------------ MTF INTREST ADJ ENTRY ---------------------------------------------

		SELECT	PARTY_CODE=CLTCODE, NARRATION='', AMOUNT=SUM(VAMT), DRCR='D'
		INTO	#INTREST_ADJ FROM LEDGER WHERE VDT = @SAUDA_DATE AND VTYP IN ('6','8') 
				AND NARRATION LIKE 'Interest%'
				AND RIGHT(RTRIM(LTRIM(CLTCODE)),4) NOT IN ('CGST','SGST','IGST')
		GROUP BY CLTCODE



		ALTER TABLE #INTREST_ADJ
		ADD			SNO		INT	IDENTITY(1,1),
					VNO		VARCHAR(12),
					ACNAME	VARCHAR(200),
					GLCODE	VARCHAR(20)

		UPDATE	#INTREST_ADJ SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#INTREST_ADJ SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#INTREST_ADJ.PARTY_CODE = A.CLTCODE

		UPDATE	#INTREST_ADJ SET GLCODE = @GLCODE

		--SELECT	'INSTREST', * FROM #INTREST_ADJ
		--WHERE	PARTY_CODE = '600A6479'


		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '6.INTEREST ADJUSTMENT'
		FROM #INTREST_ADJ
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '6.INTEREST ADJUSTMENT'
		FROM #INTREST_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0


		INSERT INTO LEDGER
		SELECT '8', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR=(CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '6.INTEREST ADJUSTMENT'
		FROM #INTREST_ADJ
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '8', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '6.INTEREST ADJUSTMENT'
		FROM #INTREST_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

		------------------------------------ MTF INTREST ADJ ENTRY ---------------------------------------------

		
		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '6.BEING THE T DAY MTM TRF TO MTM LEDGER'
		FROM #JVDATA
		WHERE FLAG = 'MTM'
		AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '6.BEING THE T DAY MTM TRF TO MTM LEDGER'
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'MTM'
		AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '7.MTF ' + FLAG
		FROM #MTM_PRE
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '7.MTF ' + FLAG
		FROM #MTM_PRE J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

		
		----- MTF_MTM_LEDGER -------------
		
		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '8.BEING THE T DAY MTM TRF FROM CASH COLL LEDGER'
		FROM #JVDATA
		WHERE FLAG = 'MTM'
		AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '8.BEING THE T DAY MTM TRF FROM CASH COLL LEDGER'
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'MTM'
		AND AMOUNT <> 0		
		
		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '9.MTF ' + FLAG
		FROM #MTM_PRE
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '9.MTF ' + FLAG
		FROM #MTM_PRE J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0


		----- MTF_CASH_COLL_LEDGER -------------


		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR, AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '10.MTF ' + FLAG
		FROM #JVDATA
		WHERE FLAG = 'PAYIN'
		AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '10.MTF ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'PAYIN'
		AND AMOUNT <> 0


		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '11.MTF ' + FLAG
		FROM #JVDATA
		WHERE FLAG = 'PAYIN' 
		AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '11.MTF ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND FLAG = 'PAYIN'
		AND AMOUNT <> 0

		--SELECT 'NEW ING-6',* FROM LEDGER WHERE VDT = @SAUDA_DATE AND CLTCODE='AI4783'
		--SELECT 'NEW ING-7',* FROM LEDGER WHERE VDT = @SAUDA_DATE AND CLTCODE='AI4783' AND VTYP='66'

		/*----- EXCESS MTM REV ON T DAY ------*/

		SELECT	PARTY_CODE, ACNAME, GLCODE=@GLCODE, AMOUNT= ABS(SUM(AMOUNT))
		INTO	#EXCESS_MTM_REV
		FROM	(
				SELECT	PARTY_CODE = CLTCODE, ACNAME, AMOUNT=SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) 
				FROM	LEDGER M(NOLOCK)
				WHERE	VDT = @SAUDA_DATE AND VTYP = 67
				GROUP BY 
						CLTCODE, ACNAME
				HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0
				) A
		WHERE	NOT EXISTS (SELECT PARTY_CODE FROM #JVDATA WHERE FLAG = 'PAYIN' AND AMOUNT <> 0 AND #JVDATA.PARTY_CODE = A.PARTY_CODE)
				AND 1 = 2
		GROUP BY
				PARTY_CODE, ACNAME

		--SELECT	PARTY_CODE, ACNAME, GLCODE, AMOUNT= ABS(SUM(AMOUNT))
		--INTO	#EXCESS_MTM_REV
		--FROM	(
		--		SELECT	PARTY_CODE, ACNAME, GLCODE, AMOUNT=SUM(CASE WHEN DRCR='D' THEN -ABS(AMOUNT) ELSE ABS(AMOUNT) END) 
		--		FROM #JVDATA WHERE FLAG = 'MTM' GROUP BY PARTY_CODE, ACNAME, GLCODE
		--		UNION 
		--		SELECT PARTY_CODE, ACNAME, GLCODE, AMOUNT=SUM(CASE WHEN DRCR='D' THEN -ABS(AMOUNT) ELSE ABS(AMOUNT) END) 
		--		FROM #MTM_PRE GROUP BY PARTY_CODE, ACNAME, GLCODE
		--		) A
		--WHERE	NOT EXISTS (SELECT PARTY_CODE FROM #JVDATA WHERE FLAG = 'PAYIN' AND AMOUNT <> 0 AND #JVDATA.PARTY_CODE = A.PARTY_CODE)
		--GROUP BY
		--		PARTY_CODE, ACNAME, GLCODE

		ALTER TABLE #EXCESS_MTM_REV
		ADD SNO	INT	IDENTITY(1,1),
			VNO	VARCHAR(12)

		UPDATE	#EXCESS_MTM_REV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)

		----- MTF_MTM_LEDGER -------------

		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '12.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV 
		WHERE	AMOUNT <> 0

		
		INSERT INTO LEDGER
		SELECT	'67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '12.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV J, ACMAST A
		WHERE	J.GLCODE = A.CLTCODE
				AND AMOUNT <> 0	

		----- MTF_CASH_COLL_LEDGER -------------

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '13.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV 
		WHERE	AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT	'6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '13.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV J, ACMAST A
		WHERE	J.GLCODE = A.CLTCODE
				AND AMOUNT <> 0


		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '14.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV 
		WHERE	AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT	'6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '14.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV J, ACMAST A
		WHERE	J.GLCODE = A.CLTCODE
				AND AMOUNT <> 0


		/* ---- COMMENTED ON 09/06/2025 FOR REVERSAL ENTRY OF CASH COLL [ FOLLOWING LOGIC IS FOR TRANSFERING FROM MTF CASH COLL LEDGER TO MTF LEDGER ] ------ */
		/*
		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'C', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '15.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV 
		WHERE	AMOUNT <> 0

		
		INSERT INTO LEDGER
		SELECT	'6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'D', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '15.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV J, ACMAST A
		WHERE	J.GLCODE = A.CLTCODE
				AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = 'D', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '16.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV 
		WHERE	AMOUNT <> 0

		
		INSERT INTO LEDGER
		SELECT	'6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = 'C', AMOUNT=ROUND(AMOUNT,2), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
				GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '16.MTF EXCESS MTM REV'
		FROM	#EXCESS_MTM_REV J, ACMAST A
		WHERE	J.GLCODE = A.CLTCODE
				AND AMOUNT <> 0
		*/
		/* ---- COMMENTED ON 09/06/2025 FOR REVERSAL ENTRY OF CASH COLL ------ */

		DELETE	FROM MTF_JVDATA
		WHERE	SAUDA_DATE = @SAUDA_DATE

		INSERT	INTO MTF_JVDATA
		SELECT	@SAUDA_DATE,
				PARTY_CODE,
				AMOUNT,
				FLAG='CASH',
				GLCODE,
				VNO,
				ACNAME,
				PROCESSDATE = GETDATE(),
				DRCR='D'
		FROM	#EXCESS_MTM_REV

		--SELECT 'MTF_JVDATA',* FROM MTF_JVDATA WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE IN ('600M7016')

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'MTM-TDAY-REV'
		EXEC ACCOUNTFO.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'MTM-TDAY-REV'

		/*----- EXCESS MTM REV ON T DAY ------*/


		--INSERT INTO MTF_CASH_COLL_LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR=(CASE WHEN DRCR='D' THEN 'C' ELSE 'D' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE FRESH BUY' + FLAG  + ' SEGMENT'
		--FROM #JVDATA

		--INSERT INTO MTF_CASH_COLL_LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'C' ELSE 'D' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE FRESH BUY' + FLAG + ' SEGMENT'
		--FROM #JVDATA J, ACMAST A
		--WHERE J.GLCODE = A.CLTCODE

		--INSERT INTO MTF_CASH_PAYIN_LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE FRESH BUY' + FLAG  + ' SEGMENT'
		--FROM #JVDATA

		--INSERT INTO MTF_CASH_PAYIN_LEDGER
		--SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM NSE FOR FRESH BUY ' + FLAG + ' SEGMENT'
		--FROM #JVDATA J, ACMAST A
		--WHERE J.GLCODE = A.CLTCODE

		--EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		--EXEC ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	
		DROP TABLE #MTM_PRE
		DROP TABLE #PAYIN
		DROP TABLE #JVDATA
		DROP TABLE #EXCESS_MTM_REV

	END
	/*--- ADDED NEW CONDITION FOR NEW MTF ---*/
		--EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		--EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	
	
	--EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING


	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_ORG_20250425
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST_ORG_20250425]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
 
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/

UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA 
	WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA SET                
CASHLEDADJ = TBL_MTF_DATA.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA.PARTY_CODE = #EXCESSMAR.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND CASHLEDADJ <> 0 

	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND FOLEDBALADJ <> 0 
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
	
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_Rollback_20250409
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST_Rollback_20250409]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
 
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/


UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ + FOBALANCE-FONONCASHADJ)   
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0


UPDATE TBL_MTF_DATA SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA 
	WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA SET                
CASHLEDADJ = TBL_MTF_DATA.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA.PARTY_CODE = #EXCESSMAR.PARTY_CODE

IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND CASHLEDADJ <> 0 

	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND FOLEDBALADJ <> 0 
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
	
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PFADJUST_TEST
-- --------------------------------------------------





-- EXEC PROC_PRODUCT_PFADJUST 'JUL 11 2017', 1
CREATE PROC [dbo].[PROC_PRODUCT_PFADJUST_TEST]
(
	@SAUDA_DATE		VARCHAR(11),
	@FLAG			INT = 0 
)
AS

set nocount on 

DECLARE 
		@PARTY_CODE			VARCHAR(10),
		@MTF_REQ			NUMERIC(18,4),
		@MTFCUR				CURSOR,
		@DEBITCUR			CURSOR,
		@CMDEBITHOLD		NUMERIC(18,4),
		@AMT				NUMERIC(18,4),
		@QTY				INT,
		@CL_RATE			NUMERIC(18,4),
		@NEWQTY				INT,
		@ISIN				VARCHAR(12),
		@HAIRCUT			NUMERIC(18,4),
		@SNO				NUMERIC(18,0),
		@HOLDFLAG			VARCHAR(20),
		@CMNONCASHBOOK		NUMERIC(18,4),
		@CMLEDBAL			NUMERIC(18,4),
		@CMCASHCOLLATERAL	NUMERIC(18,4),
		@FONONCASHBOOK		NUMERIC(18,4),
		@FOLEDBAL			NUMERIC(18,4),
		@FOCASHCOLLATERAL	NUMERIC(18,4),
		@POAHOLDING			NUMERIC(18,4),
		@NEWREQ			NUMERIC(18,4),
			@SDTCUR		VARCHAR(11),
			@LDTCUR		VARCHAR(11),
			@FOMARGIN	NUMERIC(18,2)

	SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR
	FROM PARAMETER WHERE @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
 
SELECT PARTY_CODE, 
	   NETAMT = SUM(NETAMT),
	   MTF_REQ   = CONVERT(NUMERIC(18,2),SUM(-MTOM_LOSS-MARGIN_REQ)+(MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   +MTFLEDBAL+SUM(NETAMT))		,
	   CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,
	   FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,
	   CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,
	   MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,
		FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, 
		POAHOLDING_APP = POAHOLDING_MTF,
		--POAHOLDING_APP = 0,
	   CASHDEBITADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHNONCASHADJ  = CONVERT(NUMERIC(18,2),0),
	   FONONCASHADJ = CONVERT(NUMERIC(18,2),0), 
	   CASHLEDADJ =  CONVERT(NUMERIC(18,2),0),
	   FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0), 
	   POAADJ =  CONVERT(NUMERIC(18,2),0) 
INTO #MARREQ
FROM TBL_MTF_DATA_TEST
WHERE SAUDA_DATE = @SAUDA_DATE  AND PARTY_CODE='CP5006' 
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA_TEST.PARTY_CODE)
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF 

CREATE CLUSTERED INDEX IDXPARTY ON #MARREQ
(
	PARTY_CODE
)
SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=0,ADJAMT=CONVERT(NUMERIC(18,4),0)
INTO #MTFADJDATA
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE  
AND QTY > 0 AND HAIRCUT < 100  
AND FOGFLAG = 1 AND CL_RATE > 0 
AND PARTY_CODE='CP5006'

ALTER TABLE #MTFADJDATA
ADD SNO INT IDENTITY(1,1)

CREATE CLUSTERED INDEX SNO ON #MTFADJDATA
(
	SNO
)

CREATE NONCLUSTERED INDEX PARTY ON #MTFADJDATA
(
	PARTY_CODE,
	ISIN
)
 
/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
and (FOBALANCE - FONONCASHADJ)> 0 	

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 
*/

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET CMBALANCE = CMBALANCE - CASHLEDADJ, MTF_REQ = MTF_REQ + CASHLEDADJ, CMLEDBAL = CMLEDBAL - CASHLEDADJ
WHERE CASHLEDADJ > 0 

UPDATE #MARREQ SET FOBALANCE = FOBALANCE - FOLEDBALADJ, MTF_REQ = MTF_REQ + FOLEDBALADJ, FOLEDBAL = FOLEDBAL - FOLEDBALADJ
WHERE FOLEDBALADJ > 0 

SELECT PARTY_CODE, --MTF_REQ = ABS(MTF_REQ), 
	   MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END),
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMBALANCE+FOBALANCE > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN CMBALANCE+FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,CMBALANCE+FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND CMBALANCE+FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,CMBALANCE+FOBALANCE) else 0 end),
	   POAHOLDING_APP,FOMARGIN
	   /*
SELECT PARTY_CODE, MTF_REQ = (CASE WHEN ABS(MTF_REQ) >= (CMBALANCE + FOBALANCE + POAHOLDING) THEN (CMBALANCE + FOBALANCE + POAHOLDING) ELSE ABS(MTF_REQ) END), 
	   CMDEBITHOLD = (CASE WHEN CMBALANCE+ FOBALANCE+ POAHOLDING > 0 and CMDEBITHOLD_APP > 0 THEN PRADNYA.DBO.FNMIN(CMDEBITHOLD_APP,CMBALANCE+ FOBALANCE+ POAHOLDING) ELSE 0 END),
	   CMNONCASHBOOK = (CASE WHEN CMBALANCE > 0 and CMNONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(CMNONCASHCOLLATERAL_APP,CMBALANCE) ELSE 0 END),
	   CMLEDBAL = (CASE WHEN CMLEDBAL > 0 and CMBALANCE > 0 THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE) ELSE 0 END),
	   CMCASHCOLLATERAL = (CASE WHEN CMLEDBAL > 0 and CMCASHCOLLATERAL > 0 THEN PRADNYA.DBO.FNMIN(CMCASHCOLLATERAL,CMBALANCE) ELSE 0 END),
	   FONONCASHBOOK = (CASE WHEN FOBALANCE > 0 and FONONCASHCOLLATERAL_APP > 0 THEN PRADNYA.DBO.FNMIN(FONONCASHCOLLATERAL_APP,FOBALANCE) ELSE 0 END),
	   FOLEDBAL = (CASE WHEN FOLEDBAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE) ELSE 0 END),
	   FOCASHCOLLATERAL = (CASE WHEN FOCASHCOLLATERAL > 0 AND FOBALANCE > 0 THEN PRADNYA.DBO.FNMIN(FOCASHCOLLATERAL,FOBALANCE) else 0 end),
	   POAHOLDING_APP*/
	   INTO #MTFREQ
FROM   #MARREQ
WHERE  (CMBALANCE + FOBALANCE + POAHOLDING) > 0
AND    MTF_REQ < 0 
ORDER BY PARTY_CODE

SET @MTFCUR = CURSOR FOR
SELECT * FROM #MTFREQ
OPEN @MTFCUR
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
WHILE @@FETCH_STATUS = 0 
BEGIN 
	IF @CMDEBITHOLD > 0 
	BEGIN		
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMDEBITHOLD)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG IN ('BEN','EPN')
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN						 
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @NEWREQ = @NEWREQ - @AMT 
					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @CMDEBITHOLD = @CMDEBITHOLD - @AMT	
					SET @AMT = 0 				 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY >  @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @CMDEBITHOLD = @CMDEBITHOLD - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)	
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)					 
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @CMNONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN
		SET @NEWREQ = PRADNYA.DBO.fnMin(@MTF_REQ, @CMNONCASHBOOK)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'CMCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	
	IF @FONONCASHBOOK > 0 AND @MTF_REQ > 0 
	BEGIN		
		set @NEWREQ = PRADNYA.dbo.fnMin(@FONONCASHBOOK,@MTF_REQ)
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'FOCOLL'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @NEWREQ > 0 
			BEGIN
				IF @AMT <= @NEWREQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = 0 
					SET @MTF_REQ = @MTF_REQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ - (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100) 
				END
				ELSE
				BEGIN
					IF @FOMARGIN > 0 
					BEGIN
						SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					ELSE
					BEGIN
						SET @NEWQTY = CEILING(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					END
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					set @NEWREQ = @NEWREQ  - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END

	IF @POAHOLDING > 0 AND @MTF_REQ > 0 
	BEGIN		
		SET @DEBITCUR = CURSOR FOR
			SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT, 
			AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG
			FROM #MTFADJDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'POA'
			AND CL_RATE > 0 
			ORDER BY 6 DESC, HAIRCUT ASC, CL_RATE DESC, 3 DESC
		OPEN @DEBITCUR
		FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @MTF_REQ > 0 
			BEGIN
				IF @AMT <= @MTF_REQ
				BEGIN
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @QTY, 
							ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @MTF_REQ = @MTF_REQ - @AMT
					SET @AMT = 0 
				END
				ELSE
				BEGIN
					SET @NEWQTY = CEILING(@MTF_REQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))
					IF @NEWQTY > @QTY 
					BEGIN
						SET @NEWQTY = @QTY 
					END
					UPDATE #MTFADJDATA 
						SET ADJQTY = ADJQTY + @NEWQTY, 
							ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					WHERE SNO = @SNO

					SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)
					SET @MTF_REQ = 0
				END
			END
			FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG
		END
	END
	 
	FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ, @CMDEBITHOLD, @CMNONCASHBOOK, @CMLEDBAL, @CMCASHCOLLATERAL,
							 @FONONCASHBOOK, @FOLEDBAL, @FOCASHCOLLATERAL, @POAHOLDING, @FOMARGIN
END
CLOSE @MTFCUR
DEALLOCATE @MTFCUR

UPDATE #MARREQ SET 
		CASHDEBITADJ = DEBIAMT,
		CASHNONCASHADJ = CMNONCASH,
		FONONCASHADJ = FONONCASH,
		POAADJ = POAAMT
FROM (SELECT PARTY_CODE, 
			 DEBIAMT = SUM(CASE WHEN HOLDFLAG in ('BEN','EPN') THEN ADJAMT ELSE 0 END),
			 CMNONCASH = SUM(CASE WHEN HOLDFLAG = 'CMCOLL' THEN ADJAMT ELSE 0 END),
			 FONONCASH = SUM(CASE WHEN HOLDFLAG = 'FOCOLL' THEN ADJAMT ELSE 0 END),
			 POAAMT = SUM(CASE WHEN HOLDFLAG = 'POA' THEN ADJAMT ELSE 0 END) 
	  FROM #MTFADJDATA
	  GROUP BY PARTY_CODE) A
WHERE A.PARTY_CODE = #MARREQ.PARTY_CODE

/*
UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) > PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ ) 
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ )
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ) 
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,FOBALANCE-FONONCASHADJ)
									   ELSE ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 	
*/

-- commented on 26-11-2019 to adjust margin required with available cash in mtf */
/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 
*/

/*
UPDATE #MARREQ SET MTF_REQ = MTF_REQ + (CASE WHEN (NETAMT + MTFLEDBAL) > 0 THEN (NETAMT + MTFLEDBAL) ELSE 0 END)
WHERE (NETAMT + MTFLEDBAL) > 0 AND MTF_REQ < 0 

UPDATE #MARREQ SET CASHLEDADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))  
									   ELSE PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   CMLEDBAL > 0  	AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ) > 0 	
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(CMLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0

UPDATE #MARREQ SET FOLEDBALADJ = (CASE WHEN ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) > 
PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   THEN PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ))
									   ELSE PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,ABS(MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ)))
								  END)
WHERE (MTF_REQ + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + POAADJ + CASHLEDADJ) < 0 
AND   FOLEDBAL > 0  AND (CMBALANCE+FOBALANCE+POAHOLDING) > 0 
AND (FOBALANCE - FONONCASHADJ)> 0 
AND (CMLEDBAL+FOLEDBAL-CASHLEDADJ) > 0 	 AND MTF_REQ < 0 
AND PRADNYA.DBO.FNMIN(FOLEDBAL,PRADNYA.DBO.FNMIN(CMLEDBAL+FOLEDBAL-CASHLEDADJ,CMBALANCE-CASHDEBITADJ - CASHNONCASHADJ - CASHLEDADJ+ FOBALANCE-FONONCASHADJ)) > 0
*/

UPDATE TBL_MTF_DATA_TEST SET 
CASHDEBITADJ = #MARREQ.CASHDEBITADJ,
CASHNONCASHADJ = #MARREQ.CASHNONCASHADJ,
FONONCASHADJ = #MARREQ.FONONCASHADJ,
CASHLEDADJ = #MARREQ.CASHLEDADJ,
FOLEDBALADJ = #MARREQ.FOLEDBALADJ,
POAADJ = #MARREQ.POAADJ
FROM #MARREQ 
WHERE TBL_MTF_DATA_TEST.SAUDA_DATE = @SAUDA_DATE 
AND TBL_MTF_DATA_TEST.PARTY_CODE = #MARREQ.PARTY_CODE

SELECT PARTY_CODE,    
NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ,    
MTFCASHCOLL = SUM(NETAMT)+MTFLEDBAL,    
MTFNONCASH = MTFNONCASHCOLLATERAL,    
FOBALANCE=FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,    
POAADJ = CONVERT(NUMERIC(18,2),0),      
FOLEDBALADJ  = CONVERT(NUMERIC(18,2),0)       
INTO #EXCESSMAR    
FROM TBL_MTF_DATA_TEST          
WHERE SAUDA_DATE = @SAUDA_DATE -- AND 1=2
AND NOT EXISTS (SELECT PARTY_CODE FROM TBL_MTF_EXCEPTION 
				WHERE @SAUDA_DATE BETWEEN EFF_FROM AND EFF_TO
				AND TBL_MTF_EXCEPTION.PARTY_CODE = TBL_MTF_DATA_TEST.PARTY_CODE)   
GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,          
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,          
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,           
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,          
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF    
HAVING (SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)    
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ) > 0      


CREATE CLUSTERED INDEX IDXPARTY ON #EXCESSMAR
(
	PARTY_CODE
)

UPDATE #EXCESSMAR SET  FOLEDBALADJ = -(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        NET_MTF_REQ = NET_MTF_REQ - (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        FOBALANCE = FOBALANCE + (CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END),    
        MTFCASHCOLL = MTFCASHCOLL-(CASE WHEN NET_MTF_REQ >= MTFCASHCOLL THEN MTFCASHCOLL ELSE NET_MTF_REQ END)    
WHERE  MTFCASHCOLL > 0     

SET @MTFCUR = CURSOR FOR          
SELECT PARTY_CODE, MTF_REQ = NET_MTF_REQ,           
    MTFNONCASH,     
    FOBALANCE = NET_MTF_REQ         
FROM   #EXCESSMAR          
WHERE  NET_MTF_REQ > 0     
--AND    FOBALANCE < 0    
AND    MTFNONCASH > 0          
AND 1 = 2 -- ADDED ON 27/05/2020 AS PER THE REQUEST FROM ANGEL TO KEEP EXCESS IN MTF ONLY.
ORDER BY PARTY_CODE          
OPEN @MTFCUR          
FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SET @NEWREQ = PRADNYA.DBO.fnMin(@FONONCASHBOOK, @FOLEDBAL)           
 IF @FONONCASHBOOK > 0 AND @NEWREQ > 0           
 BEGIN            
  SET @DEBITCUR = CURSOR FOR          
   SELECT SNO, ISIN, QTY = (QTY - ADJQTY), CL_RATE, HAIRCUT,           
   AMT = ((QTY - ADJQTY)*CL_RATE-(QTY - ADJQTY)*CL_RATE*HAIRCUT/100), HOLDFLAG          
   FROM #MTFADJDATA          
   WHERE PARTY_CODE = @PARTY_CODE          
   AND (QTY - ADJQTY) > 0 AND HAIRCUT < 100 AND HOLDFLAG = 'MTFCOLL'          
   AND CL_RATE > 0           
   ORDER BY HAIRCUT ASC, CL_RATE DESC, 3 DESC          
  OPEN @DEBITCUR          
  FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  WHILE @@FETCH_STATUS = 0           
  BEGIN             
             
   IF @NEWREQ > 0           
   BEGIN          
    IF @AMT <= @NEWREQ          
    BEGIN          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @QTY,           
       ADJAMT = ADJAMT + (@QTY*@CL_RATE - @QTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
               
     SET @NEWREQ = @NEWREQ - @AMT           
     SET @MTF_REQ = @MTF_REQ - @AMT          
     SET @AMT = 0           
    END          
    ELSE          
    BEGIN          
     SET @NEWQTY = FLOOR(@NEWREQ / (@CL_RATE - @CL_RATE*@HAIRCUT/100))          
          
     UPDATE #MTFADJDATA           
      SET ADJQTY = ADJQTY + @NEWQTY,           
       ADJAMT = ADJAMT + (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     WHERE SNO = @SNO          
          
     SET @AMT = @AMT - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     set @NEWREQ = @NEWREQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
     SET @MTF_REQ = @MTF_REQ - (@NEWQTY*@CL_RATE - @NEWQTY*@CL_RATE*@HAIRCUT/100)          
    END          
   END          
   FETCH NEXT FROM @DEBITCUR INTO @SNO, @ISIN, @QTY, @CL_RATE, @HAIRCUT, @AMT, @HOLDFLAG          
  END          
 END          
      
 FETCH NEXT FROM @MTFCUR INTO @PARTY_CODE, @MTF_REQ,        
        @FONONCASHBOOK, @FOLEDBAL      
END          
CLOSE @MTFCUR          
DEALLOCATE @MTFCUR      

IF (SELECT ISNULL(COUNT(1),0) FROM TBL_MTF_DATA_TEST WHERE SAUDA_DATE = @SAUDA_DATE) > 0
BEGIN
	/*
	UPDATE #MTFADJDATA           
	SET ADJQTY = QTY  
	WHERE PARTY_CODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA_TEST 
	WHERE TBL_MTF_DATA_TEST.SAUDA_DATE = @SAUDA_DATE AND TBL_MTF_DATA_TEST.PARTY_CODE = #MTFADJDATA.PARTY_CODE)
	AND HOLDFLAG = 'MTFCOLL'
	*/
	INSERT INTO #MTFADJDATA
	SELECT PARTY_CODE,ISIN, QTY, CL_RATE, HAIRCUT,HOLDFLAG,ADJQTY=QTY,ADJAMT=CONVERT(NUMERIC(18,4),0)
	FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE  
	AND QTY > 0 AND (HAIRCUT = 100 OR CL_RATE = 0)
	AND HOLDFLAG = 'MTFCOLL' AND ISIN NOT LIKE 'INX%'
END

UPDATE #EXCESSMAR SET              
  POAADJ = -POAAMT     
FROM (SELECT PARTY_CODE,                
    POAAMT = SUM(CASE WHEN HOLDFLAG = 'MTFCOLL' THEN ADJAMT ELSE 0 END)           
   FROM #MTFADJDATA          
   GROUP BY PARTY_CODE) A          
WHERE A.PARTY_CODE = #EXCESSMAR.PARTY_CODE       
    
UPDATE TBL_MTF_DATA_TEST SET                
CASHLEDADJ = TBL_MTF_DATA_TEST.CASHLEDADJ + #EXCESSMAR.FOLEDBALADJ,          
POAADJ = TBL_MTF_DATA_TEST.POAADJ + #EXCESSMAR.POAADJ          
FROM #EXCESSMAR           
WHERE TBL_MTF_DATA_TEST.SAUDA_DATE = @SAUDA_DATE           
AND TBL_MTF_DATA_TEST.PARTY_CODE = #EXCESSMAR.PARTY_CODE


RETURN


IF @FLAG = 1
BEGIN
	DECLARE @GLCODE	VARCHAR(10)

	SELECT @GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

	DROP TABLE MTF_DELDATA

	CREATE TABLE MTF_DELDATA
	(
		SNO			NUMERIC(18,0)	IDENTITY(1,1),
		ORGSNO		NUMERIC(18,0),
		TRTYPE		INT,
		PARTY_CODE	VARCHAR(10),
		ISIN		VARCHAR(12),
		QTY			INT,
		HOLDFLAG	VARCHAR(50),
		RECTYPE		VARCHAR(10),
		BDPTYPE		VARCHAR(4),
		BDPID		VARCHAR(8),
		BCLTDPID	VARCHAR(16)
	)

	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'NSE', BDPTYPE, BDPID, BCLTDPID 
	FROM [192.168.100.246].MSAJAG.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].MSAJAG.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = D.SNO, TRTYPE, PARTY_CODE, ISIN = CERTNO, QTY,  
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							ELSE 'BEN'
					   END),
		   RECTYPE = 'BSE', BDPTYPE, BDPID, BCLTDPID  
	FROM [192.168.100.246].BSEDB.DBO.DELTRANS D WITH(NOLOCK), [192.168.100.246].BSEDB.DBO.DELIVERYDP DP WITH(NOLOCK)
	WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
					  WHERE P.PARTY_CODE = D.PARTY_CODE
						AND CERTNO = ISIN AND ADJQTY > 0 )
	AND   D.BDPID = DP.DPID
	AND   D.BCLTDPID = DP.DPCLTNO
	AND   DP.EXCHANGE NOT IN ('MCX','NCX','MTF')   
	AND TRTYPE = 904
	AND   DP.DESCRIPTION NOT LIKE '%POOL%'
	AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
	*/
	

	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_HOLD

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID 
	FROM ANGELDEMAT.MSAJAG.DBO.MTF_DELDATA
	
	DELETE FROM MTF_DELDATA
	WHERE NOT EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = MTF_DELDATA.PARTY_CODE AND MTF_DELDATA.ISIN = P.ISIN AND ADJQTY > 0) 
	/*
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE=904, PARTY_CODE, ISIN, QTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),   
		   HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
		   RECTYPE = 'FOCOLL', BDPTTPE = B_DP_TYPE, BDPID = B_BANKDPID, BCLTDPID = B_DP_ACC_CODE
	FROM MSAJAG.DBO.C_SECURITIESMST D         
	WHERE   
		ACTIVE = 1   
		AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
		AND SEGMENT <> 'MTF'          
		AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
		AND PARTY_CODE <> 'BROKER' 	
	AND   EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	GROUP BY   
		PARTY_CODE,   
		ISIN,
		SEGMENT,
		B_DP_TYPE, 
		B_BANKDPID, 
		B_DP_ACC_CODE          
	HAVING   
		SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
	*/
	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 904, PARTY_CODE, 
	ISIN, QTY=FREEBAL, HOLDFLAG = 'POA',
	RECTYPE = 'POA', BDPTTPE = (CASE WHEN DPID LIKE 'IN%' THEN 'NSDL' ELSE 'CDSL' END), BDPID = DPID, BCLTDPID = CLTDPID
	FROM DELCDSLBALANCE D
	WHERE EXISTS (SELECT PARTY_CODE FROM #MTFADJDATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE AND D.ISIN = P.ISIN AND ADJQTY > 0)
	 
	CREATE CLUSTERED INDEX SNO ON MTF_DELDATA
	(
		SNO
	)
	
	CREATE INDEX IDX_PARTY ON MTF_DELDATA
	(
		PARTY_CODE,
		ISIN,
		HOLDFLAG
	)

	DECLARE @ADJCUR		CURSOR, 
			@DELCUR		CURSOR, 
			@CERTNO		VARCHAR(12),
			@DELQTY		INT,
			@PROCESSDATE	DATETIME

	SET @PROCESSDATE = GETDATE()

	SET @ADJCUR = CURSOR FOR
		SELECT PARTY_CODE, ISIN, QTY = SUM(ADJQTY), HOLDFLAG 
		FROM #MTFADJDATA
		WHERE ADJQTY > 0 AND HOLDFLAG <> 'EPN'
		GROUP BY PARTY_CODE, ISIN, HOLDFLAG
		ORDER BY PARTY_CODE, ISIN, HOLDFLAG
	OPEN @ADJCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		SET @DELCUR = CURSOR FOR
			SELECT SNO, QTY 
			FROM MTF_DELDATA
			WHERE PARTY_CODE = @PARTY_CODE
			AND ISIN = @ISIN AND HOLDFLAG = @HOLDFLAG
			AND QTY > 0 AND TRTYPE IN (904,909)  
			ORDER BY QTY DESC
		OPEN @DELCUR
		FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		WHILE @@FETCH_STATUS = 0
		BEGIN 
			IF @QTY > 0 --AND @@FETCH_STATUS = 0
			BEGIN
				IF @QTY >= @DELQTY
				BEGIN
					UPDATE MTF_DELDATA SET TRTYPE = 1
					WHERE SNO = @SNO
					SET @QTY = @QTY - @DELQTY
				END
				ELSE
				BEGIN
					INSERT INTO MTF_DELDATA
					SELECT 		
						ORGSNO, TRTYPE, PARTY_CODE, 
						ISIN, QTY = @DELQTY - @QTY, HOLDFLAG, RECTYPE, BDPTYPE, BDPID, BCLTDPID
					FROM MTF_DELDATA
					WHERE SNO = @SNO

					UPDATE MTF_DELDATA SET TRTYPE = 1, QTY = @QTY 
					WHERE SNO = @SNO

					SET @QTY = 0
				END
			END

			FETCH NEXT FROM @DELCUR INTO @SNO, @DELQTY 
		END
		CLOSE @DELCUR
		DEALLOCATE @DELCUR
		FETCH NEXT FROM @ADJCUR INTO @PARTY_CODE, @ISIN, @QTY, @HOLDFLAG
	END
	CLOSE @ADJCUR
	DEALLOCATE @ADJCUR
	
	DELETE FROM TBL_MTF_MARKING
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_MTF_MARKING
	SELECT SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,ISIN,QTY=SUM(QTY),HOLDFLAG, RUNDATE=GETDATE()
	FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')
	AND TRTYPE = 1
	GROUP BY PARTY_CODE,ISIN,HOLDFLAG

	INSERT INTO MTF_DELDATA
	SELECT ORGSNO = 0, TRTYPE = 1, PARTY_CODE, ISIN, ADJQTY, HOLDFLAG, RECTYPE = HOLDFLAG, '', '', ''
	FROM #MTFADJDATA
	WHERE HOLDFLAG = 'EPN' AND ADJQTY > 0 

	DELETE FROM MTF_DELDATA
	WHERE HOLDFLAG NOT IN ('POA','EPN')

	iNSERT INTO MTF_DELDATA_LOG 
	SELECT SAUDA_DATE=@SAUDA_DATE,ORGSNO,TRTYPE,PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID,PROCESS_DATE=GETDaTE()
	FROM MTF_DELDATA
	
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA_TEST.CASHLEDADJ),
		   FLAG = 'CASH',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA_TEST.CASHLEDADJ > 0 THEN 'C' ELSE 'D' END)
	INTO #JVDATA 
	FROM TBL_MTF_DATA_TEST
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND CASHLEDADJ <> 0 

	INSERT INTO #JVDATA 
	SELECT DISTINCT SAUDA_DATE = @SAUDA_DATE, 
		   PARTY_CODE, AMOUNT = ABS(TBL_MTF_DATA_TEST.FOLEDBALADJ),
		   FLAG = 'FO',
		   GLCODE = @GLCODE,
		   VNO = CONVERT(VARCHAR(12),''),
		   ACNAME = CONVERT(VARCHAR(200),''),
		   PROCESSDATE=@PROCESSDATE,
		   DRCR = (CASE WHEN TBL_MTF_DATA_TEST.FOLEDBALADJ > 0 THEN 'C' ELSE 'D' END)
	FROM TBL_MTF_DATA_TEST
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND FOLEDBALADJ <> 0 
	   
	 INSERT INTO #JVDATA    
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND vtyp <> (CASE WHEN vdt LIKE @SAUDA_DATE + '%' THEN '35' ELSE '' END)    
	 GROUP BY CLTCODE     
	 UNION ALL    
	 SELECT PARTY_CODE, AMOUNT=SUM(NETAMT) FROM TBL_PRODUCT_POSITION    
	 WHERE SAUDA_DATE <= @SAUDA_DATE    
	 AND ADJUST_DATE = @SAUDA_DATE    
	 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59')    
	 AND SELL_BUY = 1     
	 GROUP BY PARTY_CODE ) A    
	 GROUP BY cltcode     
	 HAVING SUM(AMOUNT) <> 0     

	 INSERT INTO #JVDATA  
	 SELECT SAUDA_DATE = @SAUDA_DATE, CLTCODE, AMOUNT = ABS(SUM(AMOUNT)),     
	 FLAG = 'CASH', GLCODE = @GLCODE,     
	 VNO = CONVERT(VARCHAR(12),''),    
		ACNAME = CONVERT(VARCHAR(200),''),    
		PROCESSDATE=@PROCESSDATE,    
	 DRCR = (CASE WHEN SUM(AMOUNT) > 0 THEN 'D' ELSE 'C' END) FROM (    
	 SELECT CLTCODE, AMOUNT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) FROM LEDGER     
	 WHERE VDT >= @SDTCUR    
	 AND VDT <= @LDTCUR  + ' 23:59:59'  
	 AND VDT <= @SAUDA_DATE  + ' 23:59:59'  
	 AND CLTCODE IN (SELECT PARTY_CODE FROM TBLCLIENTMARGIN WHERE TO_DATE > @SAUDA_DATE + ' 23:59:59') 
	 AND CLTCODE NOT IN (SELECT PARTY_CODE FROM TBL_MTF_DATA_TEST WHERE SAUDA_DATE = @SAUDA_DATE)
	 GROUP BY CLTCODE    ) A GROUP BY CLTCODE
	 HAVING SUM(AMOUNT) <>0 
	     
	DELETE FROM MTF_JVDATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO MTF_JVDATA
	SELECT * 
	FROM #JVDATA

	ALTER TABLE #JVDATA
	ADD SNO	INT	IDENTITY(1,1)
	
	DECLARE @VNO		VARCHAR(12),
			@RECCNT		INT

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JVDATA 
	IF @RECCNT > 0 
	BEGIN
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO

		UPDATE #JVDATA SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE #JVDATA SET ACNAME = A.LONGNAME 
		FROM ACMAST A
		WHERE #JVDATA.PARTY_CODE = A.CLTCODE

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT, @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'MTF JV FROM ' + FLAG
		FROM #JVDATA J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
		EXEC ANGELFO.ACCOUNTFO.DBO.PROC_MTF_JV_DATA @SAUDA_DATE
	END
	
	EXEC ANGELDEMAT.MSAJAG.DBO.PROC_MTF_SHIFTING
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PROCESS
-- --------------------------------------------------
  
CREATE PROC [dbo].[PROC_PRODUCT_PROCESS](  
           @SAUDA_DATE DATETIME,  
           @FORPARTY VARCHAR(10) = '' )  
AS  
  
SET NOCOUNT ON  
    
DECLARE @PROCESSFLAG INT,  
  @CHKFLAG INT,  
  @PROVPROCESSFLAG INT  
  
DECLARE @POSDATE VARCHAR(11)  
  
SELECT @POSDATE=ISNULL(MAX(SAUDA_DATE),'APR  1 2000') FROM TBL_PRODUCT_POSITION   
  
SET @CHKFLAG = 1  
  
SELECT @CHKFLAG = (CASE WHEN CONVERT(DATETIME,@SAUDA_DATE) >= CONVERT(DATETIME,@POSDATE) THEN  1 ELSE 0 END)  
  
SELECT @CHKFLAG  
  
IF @CHKFLAG = 0   
BEGIN  
 RETURN  
END  
  
SELECT @PROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_LOG with(nolock)    
WHERE FUNDING_DATE = @SAUDA_DATE    
  
SELECT @PROVPROCESSFLAG = ISNULL(COUNT(1),0) FROM TBL_MTF_PROV_LOG  
WHERE FUNDING_DATE = @SAUDA_DATE  
  
IF @PROCESSFLAG > 0 OR @PROVPROCESSFLAG > 0   
BEGIN  
 DELETE FROM TBL_PRODUCT_POSITION  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND SETT_NO = '2000000'   
 AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
END  
ELSE  
BEGIN  
 DELETE FROM TBL_PRODUCT_POSITION  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
  
 INSERT INTO TBL_PRODUCT_POSITION  
 SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,  
     SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,  
 PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE,TRADE_NO='',ORDER_NO=''  
 FROM TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
 AND QTY > 0   
END  
  
INSERT INTO TBL_PRODUCT_POSITION  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',  
    SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY,MKTAMT=0,NETAMT=0,CL_RATE=0,  
    PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',  
    TRANSTYPE,PROCESSDATE=GETDATE(),TRADE_NO='',ORDER_NO=''  
FROM TBL_PRODUCT_POS_ADJUST  
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11)   
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
AND QTY > 0   
  
INSERT INTO TBL_PRODUCT_POSITION  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',  
    SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY=SUM(QTY),MKTAMT=0,NETAMT=0,CL_RATE=0,  
    PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',  
    TRANSTYPE,PROCESSDATE=GETDATE(),TRADE_NO='',ORDER_NO=''  
FROM TBL_PRODUCT_POS_ADJUST_LED  
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11)   
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
AND QTY > 0   
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE  
  
INSERT INTO TBL_PRODUCT_POSITION  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',  
    SCRIP_CD,SERIES,BSECODE,SELL_BUY=1,ISIN,QTY=SUM(QTY),MKTAMT=SUM(NETAMT),NETAMT=SUM(NETAMT),CL_RATE,  
    PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',  
    TRANSTYPE,PROCESSDATE=GETDATE(),TRADE_NO='',ORDER_NO=''  
FROM TBL_PRODUCT_POS_ADJUST_BUY  
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11)   
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
AND QTY > 0   
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,CL_RATE,TRANSTYPE  
  
UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = 'DEC 31 2049 23:59'  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND ADJUST_DATE >= @SAUDA_DATE  
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
  
UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = 'DEC 31 2049 23:59'  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE <= @SAUDA_DATE  
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
  
DECLARE @SELLCUR CURSOR,  
  @BUYCUR  CURSOR,  
  @SELL_SNO NUMERIC(18,0),   
  @BUY_SNO NUMERIC(18,0),  
  @PARTY_CODE VARCHAR(10),   
  @SCRIP_CD VARCHAR(12),   
  @SERIES  VARCHAR(3),   
  @BSECODE VARCHAR(6),   
  @ISIN  VARCHAR(12),   
  @SELL_QTY INT,  
  @BUY_QTY INT,  
  @BUY_SAUDA_DATE DATETIME,  
  @SETT_TYPE VARCHAR(2),  
  @SETT_NO VARCHAR(7),  
  @TRANSTYPE VARCHAR(5)  
  
TRUNCATE TABLE TBL_PRODUCT_POSITION_CHECK  
INSERT INTO TBL_PRODUCT_POSITION_CHECK  
SELECT *, UPDFLAG=0 FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
  
SELECT PARTY_CODE, ISIN,   
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END),   
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)  
INTO #SQOFF  
FROM TBL_PRODUCT_POSITION_CHECK P1  
WHERE  SAUDA_DATE = @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
AND Sett_No <> '2000000'  
AND SETT_TYPE NOT IN('C','W')  
GROUP BY PARTY_CODE, ISIN   
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)  
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)  
  
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1  
FROM #SQOFF   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE  
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN   
AND Sett_No <> '2000000'  
  
SELECT DISTINCT PARTY_CODE, ISIN   
INTO #BUYPARTY FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))  
WHERE  SAUDA_DATE = @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND SELL_BUY = 1 AND Sett_No <> '2000000'  
AND SETT_TYPE NOT IN('C','W') AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
  
CREATE INDEX #S ON #BUYPARTY (PARTY_CODE,ISIN)  
  
  
SELECT SNO, SETT_NO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY   
INTO #POSDATA  
 FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND ADJUST_DATE = 'DEC 31 2049 23:59'  
 AND Sell_Buy = 2 AND QTY > 0 AND Sett_No <> '2000000'  
 AND exists (SELECT PARTY_CODE FROM #BUYPARTY P1    
 WHERE P.PARTY_CODE = P1.PARTY_CODE  
 AND P.ISIN = P1.ISIN  )   
  
 CREATE INDEX #S ON #POSDATA (SETT_NO,SNO)  
  
   
SET @SELLCUR = CURSOR FOR  
 SELECT * FROM #POSDATA  
 ORDER BY SETT_NO, SNO  
OPEN @SELLCUR  
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY  
WHILE @@FETCH_STATUS = 0  
BEGIN   
 SET @BUYCUR = CURSOR FOR  
 SELECT SNO, QTY, SAUDA_DATE  
 FROM  TBL_PRODUCT_POSITION_CHECK  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND ADJUST_DATE = 'DEC 31 2049 23:59'  
 AND Sell_Buy = 1  
 AND PARTY_CODE = @PARTY_CODE   
 AND ISIN = @ISIN   
 AND QTY > 0   
 AND Sett_No <> '2000000'  
 ORDER BY SAUDA_DATE  
 OPEN @BUYCUR  
 FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE  
 WHILE @@FETCH_STATUS = 0   
 BEGIN  
  IF @SELL_QTY > 0 AND @BUY_QTY > 0   
  BEGIN   
   IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0   
   BEGIN   
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1  
    WHERE SNO = @BUY_SNO   
  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1  
    WHERE SNO = @SELL_SNO   
  
    SET @BUY_QTY = 0  
    SET @SELL_QTY = 0  
   END  
   ELSE   
   BEGIN  
    IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0   
    BEGIN    
     UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1  
     WHERE SNO = @BUY_SNO   
  
     INSERT INTO TBL_PRODUCT_POSITION_CHECK  
     SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
     QTY=@BUY_QTY,  
     MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),  
     NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),  
     CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,  
     TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO, UPDFLAG = 1  
     FROM TBL_PRODUCT_POSITION_CHECK  
     WHERE SNO = @SELL_SNO   
       
     UPDATE TBL_PRODUCT_POSITION_CHECK SET   
     QTY=QTY-@BUY_QTY,  
     MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),  
     NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1  
     WHERE SNO = @SELL_SNO   
   
     SET @SELL_QTY = @SELL_QTY - @BUY_QTY  
     SET @BUY_QTY = 0  
    END  
    ELSE   
    BEGIN  
     IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY  
     BEGIN   
      UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1  
      WHERE SNO = @SELL_SNO  
  
      INSERT INTO TBL_PRODUCT_POSITION_CHECK  
      SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
      QTY=@SELL_QTY,  
      MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),  
      NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),  
      CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,  
      TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO, UPDFLAG =1  
      FROM TBL_PRODUCT_POSITION_CHECK  
      WHERE SNO = @BUY_SNO   
  
      UPDATE TBL_PRODUCT_POSITION_CHECK SET   
      QTY=QTY-@SELL_QTY,  
      MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),  
      NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1  
      WHERE SNO = @BUY_SNO   
  
      SET @BUY_QTY = @BUY_QTY - @SELL_QTY  
      SET @SELL_QTY = 0   
     END  
    END  
   END  
  END  
  FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE  
 END  
 FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY  
END  
CLOSE @SELLCUR  
DEALLOCATE @SELLCUR  
/*  
DELETE FROM TBL_PRODUCT_POSITION_CHECK   
WHERE SAUDA_DATE = @SAUDA_DATE   
AND SAUDA_DATE = ADJUST_DATE   
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
*/  
  
SELECT PARTY_CODE, ISIN,   
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END),   
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)  
INTO #SQOFF1  
FROM TBL_PRODUCT_POSITION_CHECK P1  
WHERE  SAUDA_DATE = @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND Sell_Buy = 2 AND QTY > 0   
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
GROUP BY PARTY_CODE, ISIN    
  
INSERT INTO #SQOFF1  
SELECT PARTY_CODE, ISIN,   
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END),   
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)  
FROM TBL_PRODUCT_POSITION_CHECK P1  
WHERE  SAUDA_DATE < @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND Sell_Buy = 1 AND QTY > 0   
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
GROUP BY PARTY_CODE, ISIN    
  
SELECT PARTY_CODE, ISIN, PQTY = SUM(PQTY), SQTY = SUM(SQTY)   
INTO #SQOFF2  
FROM #SQOFF1  
GROUP BY PARTY_CODE, ISIN   
HAVING SUM(PQTY) = SUM(SQTY)  
  
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE  
FROM #SQOFF2   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND Sell_Buy = 2  
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE  
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN  
  
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE  
FROM #SQOFF2   
WHERE SAUDA_DATE < @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND Sell_Buy = 1  
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE  
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN  
  
SELECT DISTINCT PARTY_CODE, ISIN  
INTO #BUYPARTYNEW FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))  
WHERE  SAUDA_DATE < @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND SELL_BUY = 1  
  
 CREATE INDEX #S ON #BUYPARTYNEW (PARTY_CODE,ISIN)  
  
SELECT SNO, SETT_NO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY  
INTO #POSDATANEW  
 FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND ADJUST_DATE = 'DEC 31 2049 23:59'  
 AND Sell_Buy = 2 AND QTY > 0   
 AND exists (SELECT PARTY_CODE FROM #BUYPARTYNEW P1    
 WHERE P.PARTY_CODE = P1.PARTY_CODE  
 AND P.ISIN = P1.ISIN)   
  
  
  CREATE INDEX #S ON #POSDATANEW (SETT_NO,SNO)  
  
   
SET @SELLCUR = CURSOR FOR  
 /*SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY  
 FROM  TBL_PRODUCT_POSITION_CHECK p  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND ADJUST_DATE = 'DEC 31 2049 23:59'   
 AND Sell_Buy = 2 AND QTY > 0   
 AND exists (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1  
 WHERE  SAUDA_DATE < @SAUDA_DATE  
 AND ADJUST_DATE > @SAUDA_DATE  
 AND SELL_BUY = 1  
 AND P.ISIN = P1.ISIN   
 AND P.PARTY_CODE = P1.PARTY_CODE)*/  
 select * from #POSDATANEW  
 ORDER BY SETT_NO, SNO  
OPEN @SELLCUR  
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @BUYCUR = CURSOR FOR  
 SELECT SNO, QTY, SAUDA_DATE  
 FROM  TBL_PRODUCT_POSITION_CHECK  
 WHERE SAUDA_DATE < @SAUDA_DATE  
 AND ADJUST_DATE = 'DEC 31 2049 23:59'  
 AND Sell_Buy = 1  
 AND PARTY_CODE = @PARTY_CODE   
 AND ISIN = @ISIN   
 AND QTY > 0   
 ORDER BY SAUDA_DATE  
 OPEN @BUYCUR  
 FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE  
 WHILE @@FETCH_STATUS = 0   
 BEGIN  
  IF @SELL_QTY > 0 AND @BUY_QTY > 0   
  BEGIN   
   IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0   
   BEGIN   
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1  
    WHERE SNO = @BUY_SNO   
  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1  
    WHERE SNO = @SELL_SNO   
  
    SET @BUY_QTY = 0  
    SET @SELL_QTY = 0  
   END  
   ELSE   
   BEGIN  
    IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0   
    BEGIN    
     UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1  
     WHERE SNO = @BUY_SNO   
  
     INSERT INTO TBL_PRODUCT_POSITION_CHECK  
     SELECT 0, SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
     QTY=@BUY_QTY,  
     MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),  
     NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),  
     CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,  
     TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO, UPDFLAG = 1  
     FROM TBL_PRODUCT_POSITION_CHECK  
     WHERE SNO = @SELL_SNO   
       
     UPDATE TBL_PRODUCT_POSITION_CHECK SET   
     QTY=QTY-@BUY_QTY,  
     MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),  
     NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1  
     WHERE SNO = @SELL_SNO   
   
     SET @SELL_QTY = @SELL_QTY - @BUY_QTY  
     SET @BUY_QTY = 0  
    END  
    ELSE   
    BEGIN  
     IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY  
     BEGIN   
      UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1  
      WHERE SNO = @SELL_SNO  
  
      INSERT INTO TBL_PRODUCT_POSITION_CHECK  
      SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
      QTY=@SELL_QTY,  
      MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),  
      NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),  
      CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,  
      TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO,UPDFLAG = 1  
      FROM TBL_PRODUCT_POSITION_CHECK  
      WHERE SNO = @BUY_SNO   
  
      UPDATE TBL_PRODUCT_POSITION_CHECK SET   
      QTY=QTY-@SELL_QTY,  
      MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),  
      NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1  
      WHERE SNO = @BUY_SNO   
  
      SET @BUY_QTY = @BUY_QTY - @SELL_QTY  
      SET @SELL_QTY = 0   
     END  
    END  
   END  
  END  
  FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE  
 END  
 FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY  
END  
CLOSE @SELLCUR  
DEALLOCATE @SELLCUR  
  
/*  
SELECT PARTY_CODE, ISIN,   
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END),   
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)  
INTO #SQOFF  
FROM TBL_PRODUCT_POSITION_CHECK P1  
WHERE  SAUDA_DATE <= @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
GROUP BY PARTY_CODE, ISIN   
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)  
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)  
  
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE  
FROM #SQOFF   
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE  
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN  
  
SET @SELLCUR = CURSOR FOR  
 SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY  
 FROM TBL_PRODUCT_POSITION_CHECK P  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND SELL_BUY = 2   
 AND ADJUST_DATE = 'DEC 31 2049 23:59'  
 AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
 AND QTY > 0   
 AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1  
 WHERE  SAUDA_DATE <= @SAUDA_DATE  
 AND ADJUST_DATE > @SAUDA_DATE  
 AND SELL_BUY = 1  
 AND P.ISIN = P1.ISIN   
 AND P.PARTY_CODE = P1.PARTY_CODE)  
 ORDER BY SNO  
OPEN @SELLCUR  
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY  
WHILE @@FETCH_STATUS = 0  
BEGIN    
 SET @BUYCUR = CURSOR FOR  
 SELECT SNO, QTY, SAUDA_DATE, SETT_NO, SETT_TYPE  
 FROM  TBL_PRODUCT_POSITION_CHECK  
 WHERE SAUDA_DATE <= @SAUDA_DATE  
 AND SELL_BUY = 1  
 AND PARTY_CODE = @PARTY_CODE  
 AND ISIN = @ISIN   
 AND ADJUST_DATE = 'DEC 31 2049 23:59'  
 AND QTY > 0  
 ORDER BY SAUDA_DATE, SETT_NO, SETT_TYPE, QTY  
 OPEN @BUYCUR  
 FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE  
 WHILE @@FETCH_STATUS = 0   
 BEGIN    
  IF @SELL_QTY > 0   
  BEGIN   
   IF @SELL_QTY = @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0   
   BEGIN  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE  
    WHERE SNO = @BUY_SNO   
  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE  
    WHERE SNO = @SELL_SNO   
  
    SET @BUY_QTY = 0  
    SET @SELL_QTY = 0  
   END  
   ELSE IF @SELL_QTY > @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0   
   BEGIN  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE  
    WHERE SNO = @BUY_SNO   
  
    INSERT INTO TBL_PRODUCT_POSITION_CHECK  
    SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,  
    SELL_BUY,ISIN,  
    QTY=@BUY_QTY,  
    MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),  
    NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),  
    CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,  
    TRANSTYPE,PROCESSDATE  
    FROM TBL_PRODUCT_POSITION_CHECK  
    WHERE SNO = @SELL_SNO   
  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET   
    QTY=QTY-@BUY_QTY,  
    MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),  
    NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2)  
    WHERE SNO = @SELL_SNO   
  
    SET @SELL_QTY = @SELL_QTY - @BUY_QTY  
    SET @BUY_QTY = 0  
   END  
  
   ELSE IF @SELL_QTY < @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0   
   BEGIN  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE  
    WHERE SNO = @SELL_SNO  
  
    INSERT INTO TBL_PRODUCT_POSITION_CHECK  
    SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,  
    SELL_BUY,ISIN,  
    QTY=@SELL_QTY,  
    MKTAMT=ROUND((MKTAMT/QTY)*(@SELL_QTY),2),  
    NETAMT=ROUND((NETAMT/QTY)*(@SELL_QTY),2),  
    CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,  
    TRANSTYPE,PROCESSDATE  
    FROM TBL_PRODUCT_POSITION_CHECK  
    WHERE SNO = @BUY_SNO   
  
    UPDATE TBL_PRODUCT_POSITION_CHECK SET   
    QTY=QTY-@SELL_QTY,  
    MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*(@SELL_QTY),2),  
    NETAMT=NETAMT-ROUND((NETAMT/QTY)*(@SELL_QTY),2)  
    WHERE SNO = @BUY_SNO   
  
    SET @BUY_QTY = @BUY_QTY - @SELL_QTY  
    SET @SELL_QTY = 0   
       
   END  
  END  
  FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE  
 END  
 FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY  
END  
CLOSE @SELLCUR  
DEALLOCATE @SELLCUR  
*/  
  
DELETE FROM TBL_PRODUCT_POSITION_CHECK  
WHERE SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 2 AND ADJUST_DATE > SAUDA_DATE  
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
   
SELECT PARTY_CODE INTO #CL_PARTY FROM TBLCLIENTMARGIN  
WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59'  
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)  
  
INSERT INTO TBL_PRODUCT_POSITION_CHECK  
SELECT 0, @SAUDA_DATE, SETT_NO = '2000000', SETT_TYPE = SETT_TYPE,  
PARTY_CODE, PRODUCT_CODE, SCRIP_CD, SERIES, BSECODE, SELL_BUY = 2, ISIN,  
QTY = SUM(QTY), MKTAMT = 0, NETAMT = 0, CL_RATE = 0, PAYIN_DATE = @SAUDA_DATE,  
ADJUST_DATE = @SAUDA_DATE, TRANSTYPE, PROCESSDATE = GETDATE(),TRADE_NO,ORDER_NO, UPDFLAG = 1  
FROM TBL_PRODUCT_POSITION_CHECK  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND SELL_BUY = 1  
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)  
GROUP BY SETT_TYPE, PARTY_CODE, PRODUCT_CODE,   
   SCRIP_CD, SERIES, BSECODE, SELL_BUY, ISIN, TRANSTYPE,TRADE_NO,ORDER_NO  
     
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
AND SELL_BUY = 1  
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)  
  
DELETE FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE <= @SAUDA_DATE  
AND ADJUST_DATE > @SAUDA_DATE  
  
INSERT INTO TBL_PRODUCT_POSITION  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,  
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,  
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO   
FROM TBL_PRODUCT_POSITION_CHECK  
  
IF @PROCESSFLAG = 0 AND @PROVPROCESSFLAG = 0   
BEGIN  
 EXEC PROC_MTF_CHECK @SAUDA_DATE  
END  
ELSE  
BEGIN  
 IF @PROCESSFLAG = 0 AND @PROVPROCESSFLAG = 1   
 BEGIN  
  CREATE TABLE #OPTCHECK   
  (  
   PARTY_CODE VARCHAR(11),  
   CERTNO VARCHAR(12)  
  )  
  INSERT INTO #OPTCHECK  
  EXEC MSAJAGDEMAT.DBO.PROC_MTF_OTP_CHECK @SAUDA_DATE, 0   
    
  CREATE INDEX #PARTY ON #OPTCHECK(PARTY_CODE,CERTNO)    
  
  IF (SELECT ISNULL(COUNT(1),0) FROM #OPTCHECK) > 0   
  BEGIN  
   DELETE FROM TBL_PRODUCT_POSITION  
   WHERE SAUDA_DATE = @SAUDA_DATE  
   AND Sett_No <> '2000000'  
   AND Sell_Buy = 1 AND ADJUST_DATE > @SAUDA_DATE  
   AND ISIN NOT IN (SELECT CERTNO FROM #OPTCHECK   
   WHERE #OPTCHECK.PARTY_CODE = TBL_PRODUCT_POSITION.PARTY_CODE  
   AND #OPTCHECK.CERTNO = TBL_PRODUCT_POSITION.ISIN)  
  
   EXEC MSAJAGDEMAT.DBO.PROC_MTF_OTP_CHECK @SAUDA_DATE, 1   
  END  
  DROP TABLE #OPTCHECK  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PROCESS_15072019
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_PRODUCT_PROCESS](
           @SAUDA_DATE DATETIME,
           @FORPARTY VARCHAR(10) = '' )
AS

SET NOCOUNT ON
  
DELETE FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE 
FROM TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY,MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY=SUM(QTY),MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST_LED
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=1,ISIN,QTY=SUM(QTY),MKTAMT=SUM(CL_RATE),NETAMT=SUM(NETAMT),CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST_BUY
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,CL_RATE,TRANSTYPE

UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = 'DEC 31 2049 23:59'
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

DECLARE @SELLCUR	CURSOR,
		@BUYCUR		CURSOR,
		@SELL_SNO	NUMERIC(18,0), 
		@BUY_SNO	NUMERIC(18,0),
		@PARTY_CODE	VARCHAR(10), 
		@SCRIP_CD	VARCHAR(12), 
		@SERIES		VARCHAR(3), 
		@BSECODE	VARCHAR(6), 
		@ISIN		VARCHAR(12), 
		@SELL_QTY	INT,
		@BUY_QTY	INT,
		@BUY_SAUDA_DATE	DATETIME,
		@SETT_TYPE	VARCHAR(2),
		@SETT_NO	VARCHAR(7),
		@TRANSTYPE	VARCHAR(5)

TRUNCATE TABLE TBL_PRODUCT_POSITION_CHECK
INSERT INTO TBL_PRODUCT_POSITION_CHECK
SELECT *, UPDFLAG=0 FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE

SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END),
TRANSTYPE
INTO #SQOFF
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND Sett_No <> '2000000'
GROUP BY PARTY_CODE, ISIN, TRANSTYPE 
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
FROM #SQOFF 
WHERE SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN
AND TBL_PRODUCT_POSITION_CHECK.TRANSTYPE = #SQOFF.TRANSTYPE 
AND Sett_No <> '2000000'

SELECT DISTINCT PARTY_CODE, ISIN, TRANSTYPE
INTO #BUYPARTY FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1 AND Sett_No <> '2000000'

SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, TRANSTYPE
INTO #POSDATA
	FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 2 AND QTY > 0 AND Sett_No <> '2000000'
	AND exists (SELECT PARTY_CODE FROM #BUYPARTY P1  
	WHERE P.PARTY_CODE = P1.PARTY_CODE
	AND P.ISIN = P1.ISIN 
	AND P.TRANSTYPE = P1.TRANSTYPE) 
	
SET @SELLCUR = CURSOR FOR
	SELECT * FROM #POSDATA
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY, @TRANSTYPE
WHILE @@FETCH_STATUS = 0
BEGIN 
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND QTY > 0 AND TRANSTYPE = @TRANSTYPE
	AND Sett_No <> '2000000'
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION_CHECK
					SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE, UPDFLAG = 1
					FROM TBL_PRODUCT_POSITION_CHECK
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION_CHECK SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION_CHECK
						SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE, UPDFLAG =1
						FROM TBL_PRODUCT_POSITION_CHECK
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION_CHECK SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY, @TRANSTYPE
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

DELETE FROM TBL_PRODUCT_POSITION_CHECK 
WHERE SAUDA_DATE = @SAUDA_DATE 
AND SAUDA_DATE = ADJUST_DATE 

SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF1
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 2 AND QTY > 0 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN  

INSERT INTO #SQOFF1
SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 1 AND QTY > 0 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN  

SELECT PARTY_CODE, ISIN, PQTY = SUM(PQTY), SQTY = SUM(SQTY) 
INTO #SQOFF2
FROM #SQOFF1
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(PQTY) = SUM(SQTY)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF2 
WHERE SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 2
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF2 
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 1
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN

SELECT DISTINCT PARTY_CODE, ISIN
INTO #BUYPARTYNEW FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))
WHERE  SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1

SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
INTO #POSDATANEW
	FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 2 AND QTY > 0 
	AND exists (SELECT PARTY_CODE FROM #BUYPARTYNEW P1  
	WHERE P.PARTY_CODE = P1.PARTY_CODE
	AND P.ISIN = P1.ISIN) 
	
SET @SELLCUR = CURSOR FOR
	/*SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM  TBL_PRODUCT_POSITION_CHECK p
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59' 
	AND Sell_Buy = 2 AND QTY > 0 
	AND exists (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1
	WHERE  SAUDA_DATE < @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)*/
	select * from #POSDATANEW
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE < @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND QTY > 0 
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION_CHECK
					SELECT 0, SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE, UPDFLAG = 1
					FROM TBL_PRODUCT_POSITION_CHECK
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION_CHECK SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION_CHECK
						SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE, UPDFLAG = 1
						FROM TBL_PRODUCT_POSITION_CHECK
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION_CHECK SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

/*
SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF 
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN

SET @SELLCUR = CURSOR FOR
	SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM TBL_PRODUCT_POSITION_CHECK P
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 2 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
	AND QTY > 0 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1
	WHERE  SAUDA_DATE <= @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN  
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE, SETT_NO, SETT_TYPE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1
	AND PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND QTY > 0
	ORDER BY SAUDA_DATE, SETT_NO, SETT_TYPE, QTY
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	WHILE @@FETCH_STATUS = 0 
	BEGIN  
		IF @SELL_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE IF @SELL_QTY > @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				INSERT INTO TBL_PRODUCT_POSITION_CHECK
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@BUY_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION_CHECK
				WHERE SNO = @SELL_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET 
				QTY=QTY-@BUY_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2)
				WHERE SNO = @SELL_SNO 

				SET @SELL_QTY = @SELL_QTY - @BUY_QTY
				SET @BUY_QTY = 0
			END

			ELSE IF @SELL_QTY < @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO

				INSERT INTO TBL_PRODUCT_POSITION_CHECK
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@SELL_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=ROUND((NETAMT/QTY)*(@SELL_QTY),2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION_CHECK
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET 
				QTY=QTY-@SELL_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*(@SELL_QTY),2)
				WHERE SNO = @BUY_SNO 

				SET @BUY_QTY = @BUY_QTY - @SELL_QTY
				SET @SELL_QTY = 0 
				 
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR
*/

DELETE FROM TBL_PRODUCT_POSITION_CHECK
WHERE SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 2 AND ADJUST_DATE > SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
 
SELECT PARTY_CODE INTO #CL_PARTY FROM TBLCLIENTMARGIN
WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION_CHECK
SELECT 0, @SAUDA_DATE, SETT_NO = '2000000', SETT_TYPE = SETT_TYPE,
PARTY_CODE, PRODUCT_CODE, SCRIP_CD, SERIES, BSECODE, SELL_BUY = 2, ISIN,
QTY = SUM(QTY), MKTAMT = 0, NETAMT = 0, CL_RATE = 0, PAYIN_DATE = @SAUDA_DATE,
ADJUST_DATE = @SAUDA_DATE, TRANSTYPE, PROCESSDATE = GETDATE(), UPDFLAG = 1
FROM TBL_PRODUCT_POSITION_CHECK
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)
GROUP BY SETT_TYPE, PARTY_CODE, PRODUCT_CODE, 
		 SCRIP_CD, SERIES, BSECODE, SELL_BUY, ISIN, TRANSTYPE
		 
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)

DELETE FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE 
FROM TBL_PRODUCT_POSITION_CHECK

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PROCESS_BAK_110220
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_PRODUCT_PROCESS_BAK_110220](
           @SAUDA_DATE DATETIME,
           @FORPARTY VARCHAR(10) = '' )
AS

SET NOCOUNT ON
  
DELETE FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE,TRADE_NO='',ORDER_NO=''
FROM TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY,MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE(),TRADE_NO='',ORDER_NO=''
FROM TBL_PRODUCT_POS_ADJUST
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY=SUM(QTY),MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE(),TRADE_NO='',ORDER_NO=''
FROM TBL_PRODUCT_POS_ADJUST_LED
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=1,ISIN,QTY=SUM(QTY),MKTAMT=SUM(NETAMT),NETAMT=SUM(NETAMT),CL_RATE,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE(),TRADE_NO='',ORDER_NO=''
FROM TBL_PRODUCT_POS_ADJUST_BUY
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,CL_RATE,TRANSTYPE

UPDATE TBL_PRODUCT_POSITION SET ADJUST_DATE = 'DEC 31 2049 23:59'
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

DECLARE @SELLCUR	CURSOR,
		@BUYCUR		CURSOR,
		@SELL_SNO	NUMERIC(18,0), 
		@BUY_SNO	NUMERIC(18,0),
		@PARTY_CODE	VARCHAR(10), 
		@SCRIP_CD	VARCHAR(12), 
		@SERIES		VARCHAR(3), 
		@BSECODE	VARCHAR(6), 
		@ISIN		VARCHAR(12), 
		@SELL_QTY	INT,
		@BUY_QTY	INT,
		@BUY_SAUDA_DATE	DATETIME,
		@SETT_TYPE	VARCHAR(2),
		@SETT_NO	VARCHAR(7),
		@TRANSTYPE	VARCHAR(5)

TRUNCATE TABLE TBL_PRODUCT_POSITION_CHECK
INSERT INTO TBL_PRODUCT_POSITION_CHECK
SELECT *, UPDFLAG=0 FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND Sett_No <> '2000000'
AND SETT_TYPE NOT IN('C','W')
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
FROM #SQOFF 
WHERE SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN 
AND Sett_No <> '2000000'

SELECT DISTINCT PARTY_CODE, ISIN 
INTO #BUYPARTY FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1 AND Sett_No <> '2000000'
AND SETT_TYPE NOT IN('C','W') AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

SELECT SNO, SETT_NO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY 
INTO #POSDATA
	FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 2 AND QTY > 0 AND Sett_No <> '2000000'
	AND exists (SELECT PARTY_CODE FROM #BUYPARTY P1  
	WHERE P.PARTY_CODE = P1.PARTY_CODE
	AND P.ISIN = P1.ISIN  ) 
	
SET @SELLCUR = CURSOR FOR
	SELECT * FROM #POSDATA
	ORDER BY SETT_NO, SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN 
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND QTY > 0 
	AND Sett_No <> '2000000'
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION_CHECK
					SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO, UPDFLAG = 1
					FROM TBL_PRODUCT_POSITION_CHECK
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION_CHECK SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION_CHECK
						SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO, UPDFLAG =1
						FROM TBL_PRODUCT_POSITION_CHECK
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION_CHECK SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR
/*
DELETE FROM TBL_PRODUCT_POSITION_CHECK 
WHERE SAUDA_DATE = @SAUDA_DATE 
AND SAUDA_DATE = ADJUST_DATE 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
*/

SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF1
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 2 AND QTY > 0 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN  

INSERT INTO #SQOFF1
SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 1 AND QTY > 0 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN  

SELECT PARTY_CODE, ISIN, PQTY = SUM(PQTY), SQTY = SUM(SQTY) 
INTO #SQOFF2
FROM #SQOFF1
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(PQTY) = SUM(SQTY)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF2 
WHERE SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 2
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF2 
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 1
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN

SELECT DISTINCT PARTY_CODE, ISIN
INTO #BUYPARTYNEW FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))
WHERE  SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1

SELECT SNO, SETT_NO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
INTO #POSDATANEW
	FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 2 AND QTY > 0 
	AND exists (SELECT PARTY_CODE FROM #BUYPARTYNEW P1  
	WHERE P.PARTY_CODE = P1.PARTY_CODE
	AND P.ISIN = P1.ISIN) 
	
SET @SELLCUR = CURSOR FOR
	/*SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM  TBL_PRODUCT_POSITION_CHECK p
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59' 
	AND Sell_Buy = 2 AND QTY > 0 
	AND exists (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1
	WHERE  SAUDA_DATE < @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)*/
	select * from #POSDATANEW
	ORDER BY SETT_NO, SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE < @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND QTY > 0 
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION_CHECK
					SELECT 0, SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO, UPDFLAG = 1
					FROM TBL_PRODUCT_POSITION_CHECK
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION_CHECK SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION_CHECK
						SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO,UPDFLAG = 1
						FROM TBL_PRODUCT_POSITION_CHECK
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION_CHECK SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @SETT_NO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

/*
SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF 
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN

SET @SELLCUR = CURSOR FOR
	SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM TBL_PRODUCT_POSITION_CHECK P
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 2 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
	AND QTY > 0 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1
	WHERE  SAUDA_DATE <= @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN  
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE, SETT_NO, SETT_TYPE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1
	AND PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND QTY > 0
	ORDER BY SAUDA_DATE, SETT_NO, SETT_TYPE, QTY
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	WHILE @@FETCH_STATUS = 0 
	BEGIN  
		IF @SELL_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE IF @SELL_QTY > @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				INSERT INTO TBL_PRODUCT_POSITION_CHECK
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@BUY_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION_CHECK
				WHERE SNO = @SELL_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET 
				QTY=QTY-@BUY_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2)
				WHERE SNO = @SELL_SNO 

				SET @SELL_QTY = @SELL_QTY - @BUY_QTY
				SET @BUY_QTY = 0
			END

			ELSE IF @SELL_QTY < @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO

				INSERT INTO TBL_PRODUCT_POSITION_CHECK
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@SELL_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=ROUND((NETAMT/QTY)*(@SELL_QTY),2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION_CHECK
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET 
				QTY=QTY-@SELL_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*(@SELL_QTY),2)
				WHERE SNO = @BUY_SNO 

				SET @BUY_QTY = @BUY_QTY - @SELL_QTY
				SET @SELL_QTY = 0 
				 
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR
*/

DELETE FROM TBL_PRODUCT_POSITION_CHECK
WHERE SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 2 AND ADJUST_DATE > SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
 
SELECT PARTY_CODE INTO #CL_PARTY FROM TBLCLIENTMARGIN
WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION_CHECK
SELECT 0, @SAUDA_DATE, SETT_NO = '2000000', SETT_TYPE = SETT_TYPE,
PARTY_CODE, PRODUCT_CODE, SCRIP_CD, SERIES, BSECODE, SELL_BUY = 2, ISIN,
QTY = SUM(QTY), MKTAMT = 0, NETAMT = 0, CL_RATE = 0, PAYIN_DATE = @SAUDA_DATE,
ADJUST_DATE = @SAUDA_DATE, TRANSTYPE, PROCESSDATE = GETDATE(),TRADE_NO,ORDER_NO, UPDFLAG = 1
FROM TBL_PRODUCT_POSITION_CHECK
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)
GROUP BY SETT_TYPE, PARTY_CODE, PRODUCT_CODE, 
		 SCRIP_CD, SERIES, BSECODE, SELL_BUY, ISIN, TRANSTYPE,TRADE_NO,ORDER_NO
		 
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)

DELETE FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE

INSERT INTO TBL_PRODUCT_POSITION
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE,TRADE_NO,ORDER_NO 
FROM TBL_PRODUCT_POSITION_CHECK

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_PROCESS_TEST
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_PRODUCT_PROCESS_TEST](
           @SAUDA_DATE DATETIME,
           @FORPARTY VARCHAR(10) = '' )
AS

SET NOCOUNT ON
  
DELETE FROM TBL_PRODUCT_POSITION_TEST
WHERE SAUDA_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION_TEST
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE 
FROM TBL_PRODUCT_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION_TEST
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY,MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 

INSERT INTO TBL_PRODUCT_POSITION_TEST
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=2,ISIN,QTY=SUM(QTY),MKTAMT=0,NETAMT=0,CL_RATE=0,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST_LED
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,TRANSTYPE

INSERT INTO TBL_PRODUCT_POSITION_TEST
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE='MTF',
	   SCRIP_CD,SERIES,BSECODE,SELL_BUY=1,ISIN,QTY=SUM(QTY),MKTAMT=SUM(NETAMT),NETAMT=SUM(NETAMT),CL_RATE,
	   PAYIN_DATE=SAUDA_DATE,ADJUST_DATE='DEC 31 2049 23:59',
	   TRANSTYPE,PROCESSDATE=GETDATE()
FROM TBL_PRODUCT_POS_ADJUST_BUY
WHERE LEFT(SAUDA_DATE,11) = LEFT(@SAUDA_DATE,11) 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND QTY > 0 
GROUP BY SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,CL_RATE,TRANSTYPE

UPDATE TBL_PRODUCT_POSITION_TEST SET ADJUST_DATE = 'DEC 31 2049 23:59'
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE >= @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

DECLARE @SELLCUR	CURSOR,
		@BUYCUR		CURSOR,
		@SELL_SNO	NUMERIC(18,0), 
		@BUY_SNO	NUMERIC(18,0),
		@PARTY_CODE	VARCHAR(10), 
		@SCRIP_CD	VARCHAR(12), 
		@SERIES		VARCHAR(3), 
		@BSECODE	VARCHAR(6), 
		@ISIN		VARCHAR(12), 
		@SELL_QTY	INT,
		@BUY_QTY	INT,
		@BUY_SAUDA_DATE	DATETIME,
		@SETT_TYPE	VARCHAR(2),
		@SETT_NO	VARCHAR(7),
		@TRANSTYPE	VARCHAR(5)

TRUNCATE TABLE TBL_PRODUCT_POSITION_CHECK
INSERT INTO TBL_PRODUCT_POSITION_CHECK
SELECT *, UPDFLAG=0 FROM TBL_PRODUCT_POSITION_TEST
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE

SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END),
TRANSTYPE
INTO #SQOFF
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
AND Sett_No <> '2000000'
GROUP BY PARTY_CODE, ISIN, TRANSTYPE 
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
FROM #SQOFF 
WHERE SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN
AND TBL_PRODUCT_POSITION_CHECK.TRANSTYPE = #SQOFF.TRANSTYPE 
AND Sett_No <> '2000000'

SELECT DISTINCT PARTY_CODE, ISIN, TRANSTYPE
INTO #BUYPARTY FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1 AND Sett_No <> '2000000'

SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, TRANSTYPE
INTO #POSDATA
	FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 2 AND QTY > 0 AND Sett_No <> '2000000'
	AND exists (SELECT PARTY_CODE FROM #BUYPARTY P1  
	WHERE P.PARTY_CODE = P1.PARTY_CODE
	AND P.ISIN = P1.ISIN 
	AND P.TRANSTYPE = P1.TRANSTYPE) 
	
SET @SELLCUR = CURSOR FOR
	SELECT * FROM #POSDATA
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY, @TRANSTYPE
WHILE @@FETCH_STATUS = 0
BEGIN 
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND QTY > 0 AND TRANSTYPE = @TRANSTYPE
	AND Sett_No <> '2000000'
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION_CHECK
					SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE, UPDFLAG = 1
					FROM TBL_PRODUCT_POSITION_CHECK
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION_CHECK SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION_CHECK
						SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE, UPDFLAG =1
						FROM TBL_PRODUCT_POSITION_CHECK
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION_CHECK SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY, @TRANSTYPE
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

DELETE FROM TBL_PRODUCT_POSITION_CHECK 
WHERE SAUDA_DATE = @SAUDA_DATE 
AND SAUDA_DATE = ADJUST_DATE 

SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF1
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 2 AND QTY > 0 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN  

INSERT INTO #SQOFF1
SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 1 AND QTY > 0 
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN  

SELECT PARTY_CODE, ISIN, PQTY = SUM(PQTY), SQTY = SUM(SQTY) 
INTO #SQOFF2
FROM #SQOFF1
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(PQTY) = SUM(SQTY)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF2 
WHERE SAUDA_DATE = @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 2
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF2 
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND Sell_Buy = 1
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF2.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF2.ISIN

SELECT DISTINCT PARTY_CODE, ISIN
INTO #BUYPARTYNEW FROM TBL_PRODUCT_POSITION_CHECK P1 with(index(idx_party))
WHERE  SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1

SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
INTO #POSDATANEW
	FROM  TBL_PRODUCT_POSITION_CHECK p with(index(idx_party))
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 2 AND QTY > 0 
	AND exists (SELECT PARTY_CODE FROM #BUYPARTYNEW P1  
	WHERE P.PARTY_CODE = P1.PARTY_CODE
	AND P.ISIN = P1.ISIN) 
	
SET @SELLCUR = CURSOR FOR
	/*SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM  TBL_PRODUCT_POSITION_CHECK p
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59' 
	AND Sell_Buy = 2 AND QTY > 0 
	AND exists (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1
	WHERE  SAUDA_DATE < @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)*/
	select * from #POSDATANEW
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE < @SAUDA_DATE
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND Sell_Buy = 1
	AND PARTY_CODE = @PARTY_CODE 
	AND ISIN = @ISIN 
	AND QTY > 0 
	ORDER BY SAUDA_DATE
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	WHILE @@FETCH_STATUS = 0 
	BEGIN
		IF @SELL_QTY > 0 AND @BUY_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
			BEGIN 
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE 
			BEGIN
				IF @SELL_QTY > @BUY_QTY AND @SELL_QTY > 0 AND @BUY_QTY > 0 
				BEGIN  
					UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE, UPDFLAG = 1
					WHERE SNO = @BUY_SNO 

					INSERT INTO TBL_PRODUCT_POSITION_CHECK
					SELECT 0, SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
					QTY=@BUY_QTY,
					MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
					CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
					TRANSTYPE,PROCESSDATE, UPDFLAG = 1
					FROM TBL_PRODUCT_POSITION_CHECK
					WHERE SNO = @SELL_SNO 
					
					UPDATE TBL_PRODUCT_POSITION_CHECK SET 
					QTY=QTY-@BUY_QTY,
					MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
					NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2), UPDFLAG = 1
					WHERE SNO = @SELL_SNO 
 
					SET @SELL_QTY = @SELL_QTY - @BUY_QTY
					SET @BUY_QTY = 0
				END
				ELSE 
				BEGIN
					IF @SELL_QTY > 0 AND @BUY_QTY > 0 AND @SELL_QTY < @BUY_QTY
					BEGIN 
						UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE, UPDFLAG = 1
						WHERE SNO = @SELL_SNO

						INSERT INTO TBL_PRODUCT_POSITION_CHECK
						SELECT 0,SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
						QTY=@SELL_QTY,
						MKTAMT=ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=ROUND((NETAMT/QTY)*@SELL_QTY,2),
						CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
						TRANSTYPE,PROCESSDATE, UPDFLAG = 1
						FROM TBL_PRODUCT_POSITION_CHECK
						WHERE SNO = @BUY_SNO 

						UPDATE TBL_PRODUCT_POSITION_CHECK SET 
						QTY=QTY-@SELL_QTY,
						MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@SELL_QTY,2),
						NETAMT=NETAMT-ROUND((NETAMT/QTY)*@SELL_QTY,2), UPDFLAG = 1
						WHERE SNO = @BUY_SNO 

						SET @BUY_QTY = @BUY_QTY - @SELL_QTY
						SET @SELL_QTY = 0 
					END
				END
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR

/*
SELECT PARTY_CODE, ISIN, 
PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END), 
SQTY = SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)
INTO #SQOFF
FROM TBL_PRODUCT_POSITION_CHECK P1
WHERE  SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
GROUP BY PARTY_CODE, ISIN 
HAVING SUM(CASE WHEN SELL_BUY = 1 THEN QTY ELSE 0 END)
= SUM(CASE WHEN SELL_BUY = 2 THEN QTY ELSE 0 END)

UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
FROM #SQOFF 
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND TBL_PRODUCT_POSITION_CHECK.PARTY_CODE = #SQOFF.PARTY_CODE
AND TBL_PRODUCT_POSITION_CHECK.ISIN = #SQOFF.ISIN

SET @SELLCUR = CURSOR FOR
	SELECT SNO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY
	FROM TBL_PRODUCT_POSITION_CHECK P
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND SELL_BUY = 2 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
	AND QTY > 0 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM TBL_PRODUCT_POSITION_CHECK P1
	WHERE  SAUDA_DATE <= @SAUDA_DATE
	AND ADJUST_DATE > @SAUDA_DATE
	AND SELL_BUY = 1
	AND P.ISIN = P1.ISIN 
	AND P.PARTY_CODE = P1.PARTY_CODE)
	ORDER BY SNO
OPEN @SELLCUR
FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
WHILE @@FETCH_STATUS = 0
BEGIN  
	SET @BUYCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE, SETT_NO, SETT_TYPE
	FROM  TBL_PRODUCT_POSITION_CHECK
	WHERE SAUDA_DATE <= @SAUDA_DATE
	AND SELL_BUY = 1
	AND PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN 
	AND ADJUST_DATE = 'DEC 31 2049 23:59'
	AND QTY > 0
	ORDER BY SAUDA_DATE, SETT_NO, SETT_TYPE, QTY
	OPEN @BUYCUR
	FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	WHILE @@FETCH_STATUS = 0 
	BEGIN  
		IF @SELL_QTY > 0 
		BEGIN 
			IF @SELL_QTY = @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO 

				SET @BUY_QTY = 0
				SET @SELL_QTY = 0
			END
			ELSE IF @SELL_QTY > @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
				WHERE SNO = @BUY_SNO 

				INSERT INTO TBL_PRODUCT_POSITION_CHECK
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@BUY_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=ROUND((NETAMT/QTY)*@BUY_QTY,2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@BUY_SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION_CHECK
				WHERE SNO = @SELL_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET 
				QTY=QTY-@BUY_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*@BUY_QTY,2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*@BUY_QTY,2)
				WHERE SNO = @SELL_SNO 

				SET @SELL_QTY = @SELL_QTY - @BUY_QTY
				SET @BUY_QTY = 0
			END

			ELSE IF @SELL_QTY < @BUY_QTY AND @BUY_QTY > 0 AND @SELL_QTY > 0 
			BEGIN
				UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @BUY_SAUDA_DATE
				WHERE SNO = @SELL_SNO

				INSERT INTO TBL_PRODUCT_POSITION_CHECK
				SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
				SELL_BUY,ISIN,
				QTY=@SELL_QTY,
				MKTAMT=ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=ROUND((NETAMT/QTY)*(@SELL_QTY),2),
				CL_RATE,PAYIN_DATE,ADJUST_DATE=@SAUDA_DATE,
				TRANSTYPE,PROCESSDATE
				FROM TBL_PRODUCT_POSITION_CHECK
				WHERE SNO = @BUY_SNO 

				UPDATE TBL_PRODUCT_POSITION_CHECK SET 
				QTY=QTY-@SELL_QTY,
				MKTAMT=MKTAMT-ROUND((MKTAMT/QTY)*(@SELL_QTY),2),
				NETAMT=NETAMT-ROUND((NETAMT/QTY)*(@SELL_QTY),2)
				WHERE SNO = @BUY_SNO 

				SET @BUY_QTY = @BUY_QTY - @SELL_QTY
				SET @SELL_QTY = 0 
				 
			END
		END
		FETCH NEXT FROM @BUYCUR INTO @BUY_SNO, @BUY_QTY, @BUY_SAUDA_DATE, @SETT_NO, @SETT_TYPE
	END
	FETCH NEXT FROM @SELLCUR INTO @SELL_SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELL_QTY
END
CLOSE @SELLCUR
DEALLOCATE @SELLCUR
*/

DELETE FROM TBL_PRODUCT_POSITION_CHECK
WHERE SAUDA_DATE = @SAUDA_DATE AND SELL_BUY = 2 AND ADJUST_DATE > SAUDA_DATE
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)
 
SELECT PARTY_CODE INTO #CL_PARTY FROM TBLCLIENTMARGIN
WHERE TO_DATE <= @SAUDA_DATE + ' 23:59:59'
AND PARTY_CODE = (CASE WHEN @FORPARTY = '' THEN PARTY_CODE ELSE @FORPARTY END)

INSERT INTO TBL_PRODUCT_POSITION_CHECK
SELECT 0, @SAUDA_DATE, SETT_NO = '2000000', SETT_TYPE = SETT_TYPE,
PARTY_CODE, PRODUCT_CODE, SCRIP_CD, SERIES, BSECODE, SELL_BUY = 2, ISIN,
QTY = SUM(QTY), MKTAMT = 0, NETAMT = 0, CL_RATE = 0, PAYIN_DATE = @SAUDA_DATE,
ADJUST_DATE = @SAUDA_DATE, TRANSTYPE, PROCESSDATE = GETDATE(), UPDFLAG = 1
FROM TBL_PRODUCT_POSITION_CHECK
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)
GROUP BY SETT_TYPE, PARTY_CODE, PRODUCT_CODE, 
		 SCRIP_CD, SERIES, BSECODE, SELL_BUY, ISIN, TRANSTYPE
		 
UPDATE TBL_PRODUCT_POSITION_CHECK SET ADJUST_DATE = @SAUDA_DATE
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE
AND SELL_BUY = 1
AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CL_PARTY)

/*
DELETE FROM TBL_PRODUCT_POSITION_TEST
WHERE SAUDA_DATE <= @SAUDA_DATE
AND ADJUST_DATE > @SAUDA_DATE

INSERT INTO TBL_PRODUCT_POSITION_TEST
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,
       SELL_BUY,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,
PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE 
FROM TBL_PRODUCT_POSITION_CHECK
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_REQSHORT_ADJUST
-- --------------------------------------------------




CREATE Proc [dbo].[PROC_PRODUCT_REQSHORT_ADJUST] (@SAUDA_DATE VARCHAR(11) ) 
AS  
	SET NOCOUNT ON 

	return

--  EXEC PROC_PRODUCT_REQSHORT_ADJUST 'JUL 10 2017'
    DECLARE @PAYIN_DATE VARCHAR(11),
			@SDTCUR	DATETIME,
			@LDTCUR	DATETIME,
			@NONFNO	INT,
			@FNO	INT

	SELECT @NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER
	WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT  PARTY_CODE, AMOUNT = SUM(NETAMT), SANC_LIM = CONVERT(NUMERIC(18,0),0),
			MARG_REQ_SHORT = CONVERT(NUMERIC(18,2),0), NETAMT = SUM(NETAMT)
	INTO #B_PFVALUE
	FROM  TBL_PRODUCT_POSITION 
    WHERE  SAUDA_DATE <= @SAUDA_DATE 
           AND ADJUST_DATE > @SAUDA_DATE 
           AND SELL_BUY = 1
	GROUP BY PARTY_CODE

/*NET_MTF_REQ = SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ*/

	UPDATE #B_PFVALUE SET SANC_LIM = SANCTIONED_AMT
	FROM TBLCLIENTMARGIN P
	WHERE P.PARTY_CODE = #B_PFVALUE.PARTY_CODE
	AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

	DELETE FROM #B_PFVALUE
	WHERE (SANC_LIM = -1)

	INSERT INTO TBL_MTF_DATA_LOG
	SELECT SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,MARGIN_REQ,MTOM_LOSS,
		   FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_MTF,
		   CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,FOCASHEQCOLLATERAL,
		   FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
		   CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ, RUNDATE=GETDATE() 
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE
	 
	SELECT  PARTY_CODE,SHORTFALL=SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ
	INTO #SHORT
	FROM TBL_MTF_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE
	GROUP BY PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,
	   CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,
	   CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,	
	   POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,
		CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF
	HAVING SUM(NETAMT-MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
				   + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ < 0

	UPDATE #B_PFVALUE SET MARG_REQ_SHORT = SHORTFALL
	FROM #SHORT
	WHERE #SHORT.PARTY_CODE = #B_PFVALUE.PARTY_CODE
 
	DELETE FROM #B_PFVALUE
	WHERE MARG_REQ_SHORT >= 0
/*
	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 
	AND SELL_BUY = 1 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM #B_PFVALUE
					   WHERE #B_PFVALUE.PARTY_CODE = TBL_PRODUCT_POSITION.PARTY_CODE)

	return
*/						   
	SELECT *, HAIRCUT = CONVERT(NUMERIC(18,4),0)
	INTO #MARSHORT
	FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 
	AND SELL_BUY = 1 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM #B_PFVALUE
					   WHERE #B_PFVALUE.PARTY_CODE = TBL_PRODUCT_POSITION.PARTY_CODE)
	
	UPDATE #MARSHORT SET CL_RATE = CURR_CL_RATE, HAIRCUT = C.HAIRCUT
	FROM TBL_MTF_DATA C
	WHERE C.SAUDA_DATE = @SAUDA_DATE
	AND C.PARTY_CODE = #MARSHORT.PARTY_CODE
	AND C.ISIN = #MARSHORT.ISIN
 
	DECLARE @PFCUR		CURSOR,
			@PARTY_CODE	VARCHAR(10),
			@AMOUNT		NUMERIC(18,4),
			@BUYCUR		CURSOR,
			@SNO		INT,
			@ISIN		VARCHAR(12),
			@QTY		INT,
			@NETAMT		NUMERIC(18,4),
			@ADJRATE	NUMERIC(18,4),
			@ADJQTY		INT

	SET @PFCUR = CURSOR FOR
	SELECT PARTY_CODE, AMOUNT = ABS(MARG_REQ_SHORT)
	FROM #B_PFVALUE
	ORDER BY PARTY_CODE
	OPEN @PFCUR
	FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	WHILE @@FETCH_STATUS = 0
	BEGIN
		SET @BUYCUR = CURSOR FOR
		SELECT SNO, ISIN, QTY, NETAMT = (MKTAMT*HAIRCUT/100 
			 + (CASE WHEN (MKTAMT - QTY*CL_RATE) > 0 THEN (MKTAMT - QTY*CL_RATE) ELSE 0 END)) 
		 FROM #MARSHORT
		WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE = @PARTY_CODE
		AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 
		ORDER BY NETAMT DESC
		OPEN @BUYCUR
		FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @AMOUNT > 0 
			BEGIN
				IF @AMOUNT >= @NETAMT
				BEGIN
					UPDATE #MARSHORT SET QTY = 0, NETAMT = 0, MKTAMT = 0 
					WHERE SNO = @SNO

					SET @AMOUNT = @AMOUNT - @NETAMT
				END	
				ELSE
				BEGIN
					
					SET @ADJRATE = @NETAMT / @QTY
					SET @ADJQTY = ceiling(@AMOUNT / @ADJRATE)
					set @ADJQTY = @QTY - @ADJQTY
					
					select @NETAMT, @QTY, @ADJRATE, @ADJQTY
					
					UPDATE #MARSHORT SET QTY = @ADJQTY, MKTAMT = @ADJQTY * (MKTAMT / @QTY),
					NETAMT = @ADJQTY * (NETAMT / @QTY)
					WHERE SNO = @SNO

					SET @AMOUNT = 0
				END	
			END
			FETCH NEXT FROM @BUYCUR INTO @SNO, @ISIN, @QTY, @NETAMT
		END
		CLOSE @BUYCUR
		DEALLOCATE @BUYCUR

		FETCH NEXT FROM @PFCUR INTO @PARTY_CODE, @AMOUNT
	END
	CLOSE @PFCUR
	DEALLOCATE @PFCUR
 
	DELETE FROM #MARSHORT
	WHERE SAUDA_DATE = @SAUDA_DATE AND QTY = 0

	DELETE FROM TBL_PRODUCT_POSITION
	WHERE SAUDA_DATE = @SAUDA_DATE 
	AND ADJUST_DATE > @SAUDA_DATE AND QTY > 0 
	AND SELL_BUY = 1 
	AND PARTY_CODE IN (SELECT PARTY_CODE FROM #B_PFVALUE
					   WHERE #B_PFVALUE.PARTY_CODE = TBL_PRODUCT_POSITION.PARTY_CODE)

	INSERT INTO TBL_PRODUCT_POSITION
	SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,QTY,MKTAMT,
	NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE
	FROM #MARSHORT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_SALE_ADJUST
-- --------------------------------------------------








  
CREATE PROC [dbo].[PROC_PRODUCT_SALE_ADJUST](  
           @SAUDA_DATE DATETIME)  
AS  
    
-- EXEC PROC_PRODUCT_SALE_ADJUST 'AUG  1 2017'  
  
SET NOCOUNT ON   
DECLARE @PAYINCUR   CURSOR,  
  @SNO    NUMERIC(18,0),  
  @PARTY_CODE   VARCHAR(10),  
  @SCRIP_CD   VARCHAR(12),  
  @SERIES    VARCHAR(3),  
  @BSECODE   VARCHAR(6),  
  @ISIN    VARCHAR(12),  
  @SELLQTY   INT,  
  @PAYIN_DATE   DATETIME,  
  @TRANSTYPE   VARCHAR(10),  
  @BUYADJ    CURSOR,  
  @SETT_NO   VARCHAR(7),  
  @BTSTQTY   INT,  
  @B_START_DATE  DATETIME,  
  @B_PAYIN_DATE  DATETIME,  
  @MTFQTY    INT,  
  @SETT_TYPE   VARCHAR(2),  
     @HOLDFLAG   VARCHAR(50)    
  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
INTO #S_MTFPOS  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
  
  
CREATE INDEX #SPAR ON #S_MTFPOS  
(PARTY_CODE,SCRIP_CD,SERIES,BSECODE)  
  
  
INSERT INTO #S_MTFPOS  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
FROM TBL_PRODUCT_DATA S  
WHERE  SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 1   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))   
  
SELECT * INTO #S_TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND SNO NOT IN (SELECT SNO FROM #S_TBL_PRODUCT_DATA)  
  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES= CONVERT(VARCHAR(3),D.SERIES),   
BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,   
ORGQTY = QTY,   
HOLDFLAG = '2 BTST POSTION'  
INTO #S_BTST  
FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.SCRIP_CD = D.SCRIP_CD  
    AND P.SERIES = D.SERIES)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
INSERT INTO #S_BTST  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  
ORGQTY = QTY,  HOLDFLAG = '2 BTST POSTION'   
FROM  BSEDB.DBO.DELIVERYCLT D,  BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.BSECODE = D.SCRIP_CD)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
UPDATE #S_BTST SET QTY = QTY - BTSTQTY FROM (  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, BTSTQTY = SUM(QTY)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE   
AND SELL_BUY = 1   
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) A  
WHERE #S_BTST.SETT_NO = A.SETT_NO   
 AND #S_BTST.SETT_TYPE = A.SETT_TYPE  
 AND #S_BTST.PARTY_CODE = A.PARTY_CODE  
 AND ((#S_BTST.SCRIP_CD = A.SCRIP_CD  
 AND #S_BTST.SERIES = A.SERIES)  
 OR (#S_BTST.BSECODE = A.BSECODE))  
  
--DELETE FROM #S_BTST WHERE QTY <= 0    
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE  
   FROM #S_BTST D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ((D.SCRIP_CD = @SCRIP_CD  
   AND   D.SERIES = @SERIES)  
   OR (D.BSECODE = @BSECODE))  
   AND QTY > 0   
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
DELETE FROM #S_TBL_PRODUCT_DATA  
WHERE QTY = 0   
  
  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''),   
QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
INTO #S_IST  
FROM  MSAJAGDEMAT.DBO.DELTRANS D,  MSAJAGDEMAT.DBO.SETT_MST S,  MSAJAGDEMAT.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2    
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM  BSEDB.DBO.DELTRANS D,  MSAJAGDEMAT.DBO.SETT_MST S,  BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE  
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM  MSAJAGDEMAT.DBO.DELTRANS D,  BSEDB.DBO.SETT_MST S,  MSAJAGDEMAT.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE,CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM  BSEDB.DBO.DELTRANS D,  BSEDB.DBO.SETT_MST S,   
 BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES,   
BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM  MSAJAGDEMAT.DBO.DELTRANS D,  MSAJAGDEMAT.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE   
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM  MSAJAG.DBO.DELIVERYDP DP  
       UNION   
       SELECT DPCLTNO FROM  BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),  
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,   
HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM  BSEDB.DBO.DELTRANS D,  BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM  MSAJAG.DBO.DELIVERYDP DP   
       UNION   
       SELECT DPCLTNO FROM  BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  


/*--- ADDED NEW CONDITION FOR NEW MTF (FOR COLL FROM M QTY) ---*/

INSERT	INTO #S_IST
SELECT	SETT_NO = CONVERT(VARCHAR(10),'MMQTY'), SETT_TYPE = CONVERT(VARCHAR(3),''), 
		PARTY_CODE, SCRIP_CD, SERIES, BSECODE = CONVERT(VARCHAR(10),''), 
		QTY = MAX(COLL_QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049', 
		ISIN, HOLDFLAG = 'MMQTY', 
		ORGQTY = MAX(COLL_QTY)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC D (NOLOCK)
WHERE	PAYIN_DATE = @SAUDA_DATE
		AND SAUDA_DATE = ( SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC D1 (NOLOCK) WHERE PAYIN_DATE = @SAUDA_DATE AND D.PARTY_CODE = D1.PARTY_CODE AND D.ISIN = D1.ISIN )
		AND COLL_QTY > 0 
		AND	EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P (NOLOCK)
					WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE
					)
GROUP BY
		SAUDA_DATE, SETT_NO, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN

/*--- ADDED NEW CONDITION FOR NEW MTF ----*/

  
SELECT *, ORGFLAG = HOLDFLAG INTO #V_IST FROM #S_IST   
WHERE 1 = 2    
  
/*--- ADDED NEW CONDITION FOR NEW MTF ( UPDATED/ALTER EXISTING CONDITION FOR TAKING COLL FROM M QTY ) ----*/


INSERT INTO #V_IST   
SELECT SETT_NO =(CASE WHEN HOLDFLAG = 'MMQTY' THEN 'MMQTY' ELSE 'VIRTUAL' END), SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '',SERIES = '', BSECODE = '',   
QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN, HOLDFLAG = 'MTFCOLL',   
ORGQTY = SUM(QTY), ORGFLAG = HOLDFLAG   
FROM  TBL_MTF_MARKING  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG<>'MTFCOLL'  
GROUP BY PARTY_CODE, ISIN, HOLDFLAG   
  
/*--- ADDED NEW CONDITION FOR NEW MTF ----*/

INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,SERIES,   
BSECODE = '', QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
           WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM  MSAJAGDEMAT.DBO.DELTRANS D,  MSAJAGDEMAT.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT,DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = LEFT(SCRIP_CD,6), QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
        WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
        WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM  BSEDB.DBO.DELTRANS D,  BSEDB.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT, DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END),   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE NOT IN ('MCX','NCX','MTF')     
    AND SEGMENT <> 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN,  
 SEGMENT            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0      
  
 /*  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = 'MTFCOLL',   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE = 'MTF'     
    AND SEGMENT = 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
 */  
  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
INTO #S_ISTDATA FROM #S_IST WHERE SETT_NO <> 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
UPDATE #S_ISTDATA SET QTY = #S_ISTDATA.QTY - #V_IST.QTY   
FROM #V_IST  
WHERE #V_IST.Party_Code = #S_ISTDATA.Party_Code   
AND #V_IST.ISIN = #S_ISTDATA.ISIN    
AND #V_IST.ORGFLAG = #S_ISTDATA.HOLDFLAG  
  
DELETE FROM #S_ISTDATA  
WHERE QTY <= 0   
  
INSERT INTO #S_ISTDATA  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
FROM #V_IST --WHERE SETT_NO = 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
CREATE CLUSTERED INDEX SETT ON #S_ISTDATA  
(  
 SETT_NO, SETT_TYPE, PARTY_CODE  
)  
  
DROP TABLE #S_IST  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,SETT_NO, SETT_TYPE, PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE,   
          @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT  QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'  
   AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO  @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0       
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY,   
     NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0   
  
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO,  @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'     
   AND SETT_NO = '' AND SETT_TYPE = ''  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  

----CHANGE DONE UNDER SRE_32204  
----IF @SAUDA_DATE = LEFT(GETDATE(),11) or @SAUDA_DATE = 'DEC 13 2024'
BEGIN  
 DELETE FROM TBL_PRODUCT_HOLD_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0 
 FROM #S_ISTDATA  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0    
 FROM #S_BTST  
END  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_DATA  
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
    QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE   
FROM #S_TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE AND EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_HOLD_DATA  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,  
    QTY,PAYIN_DATE,@SAUDA_DATE,ORGQTY=QTY,HOLDFLAG = 'OPEN SELL POSITION', CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
FROM #S_TBL_PRODUCT_DATA S  
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_SALE_ADJUST_BKP_16DEC2024_SRE_32204
-- --------------------------------------------------








  
CREATE PROC [dbo].[PROC_PRODUCT_SALE_ADJUST_BKP_16DEC2024_SRE_32204](  
           @SAUDA_DATE DATETIME)  
AS  
    
-- EXEC PROC_PRODUCT_SALE_ADJUST 'AUG  1 2017'  
  
SET NOCOUNT ON   
DECLARE @PAYINCUR   CURSOR,  
  @SNO    NUMERIC(18,0),  
  @PARTY_CODE   VARCHAR(10),  
  @SCRIP_CD   VARCHAR(12),  
  @SERIES    VARCHAR(3),  
  @BSECODE   VARCHAR(6),  
  @ISIN    VARCHAR(12),  
  @SELLQTY   INT,  
  @PAYIN_DATE   DATETIME,  
  @TRANSTYPE   VARCHAR(10),  
  @BUYADJ    CURSOR,  
  @SETT_NO   VARCHAR(7),  
  @BTSTQTY   INT,  
  @B_START_DATE  DATETIME,  
  @B_PAYIN_DATE  DATETIME,  
  @MTFQTY    INT,  
  @SETT_TYPE   VARCHAR(2),  
     @HOLDFLAG   VARCHAR(50)    
  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
INTO #S_MTFPOS  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
  
  
CREATE INDEX #SPAR ON #S_MTFPOS  
(PARTY_CODE,SCRIP_CD,SERIES,BSECODE)  
  
  
INSERT INTO #S_MTFPOS  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
FROM TBL_PRODUCT_DATA S  
WHERE  SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 1   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))   
  
SELECT * INTO #S_TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND SNO NOT IN (SELECT SNO FROM #S_TBL_PRODUCT_DATA)  
  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES= CONVERT(VARCHAR(3),D.SERIES),   
BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,   
ORGQTY = QTY,   
HOLDFLAG = '2 BTST POSTION'  
INTO #S_BTST  
FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.SCRIP_CD = D.SCRIP_CD  
    AND P.SERIES = D.SERIES)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
INSERT INTO #S_BTST  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  
ORGQTY = QTY,  HOLDFLAG = '2 BTST POSTION'   
FROM ANGELDEMAT.BSEDB.DBO.DELIVERYCLT D, ANGELDEMAT.BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.BSECODE = D.SCRIP_CD)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
UPDATE #S_BTST SET QTY = QTY - BTSTQTY FROM (  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, BTSTQTY = SUM(QTY)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE   
AND SELL_BUY = 1   
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) A  
WHERE #S_BTST.SETT_NO = A.SETT_NO   
 AND #S_BTST.SETT_TYPE = A.SETT_TYPE  
 AND #S_BTST.PARTY_CODE = A.PARTY_CODE  
 AND ((#S_BTST.SCRIP_CD = A.SCRIP_CD  
 AND #S_BTST.SERIES = A.SERIES)  
 OR (#S_BTST.BSECODE = A.BSECODE))  
  
--DELETE FROM #S_BTST WHERE QTY <= 0    
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE  
   FROM #S_BTST D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ((D.SCRIP_CD = @SCRIP_CD  
   AND   D.SERIES = @SERIES)  
   OR (D.BSECODE = @BSECODE))  
   AND QTY > 0   
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
DELETE FROM #S_TBL_PRODUCT_DATA  
WHERE QTY = 0   
  
  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''),   
QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
INTO #S_IST  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2    
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE  
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE,CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S,   
ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES,   
BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE   
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
       UNION   
       SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),  
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,   
HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP   
       UNION   
       SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
SELECT *, ORGFLAG = HOLDFLAG INTO #V_IST FROM #S_IST   
WHERE 1 = 2    
  
INSERT INTO #V_IST   
SELECT SETT_NO = 'VIRTUAL', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '',SERIES = '', BSECODE = '',   
QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN, HOLDFLAG = 'MTFCOLL',   
ORGQTY = SUM(QTY), ORGFLAG = HOLDFLAG   
FROM  TBL_MTF_MARKING  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG<>'MTFCOLL'  
GROUP BY PARTY_CODE, ISIN, HOLDFLAG   
  
INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,SERIES,   
BSECODE = '', QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
           WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT,DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = LEFT(SCRIP_CD,6), QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
        WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
        WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT, DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END),   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE NOT IN ('MCX','NCX','MTF')     
    AND SEGMENT <> 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN,  
 SEGMENT            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0      
  
 /*  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = 'MTFCOLL',   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE = 'MTF'     
    AND SEGMENT = 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
 */  
  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
INTO #S_ISTDATA FROM #S_IST WHERE SETT_NO <> 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
UPDATE #S_ISTDATA SET QTY = #S_ISTDATA.QTY - #V_IST.QTY   
FROM #V_IST  
WHERE #V_IST.Party_Code = #S_ISTDATA.Party_Code   
AND #V_IST.ISIN = #S_ISTDATA.ISIN    
AND #V_IST.ORGFLAG = #S_ISTDATA.HOLDFLAG  
  
DELETE FROM #S_ISTDATA  
WHERE QTY <= 0   
  
INSERT INTO #S_ISTDATA  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
FROM #V_IST --WHERE SETT_NO = 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
CREATE CLUSTERED INDEX SETT ON #S_ISTDATA  
(  
 SETT_NO, SETT_TYPE, PARTY_CODE  
)  
  
DROP TABLE #S_IST  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,SETT_NO, SETT_TYPE, PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE,   
          @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT  QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'  
   AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO  @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0       
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY,   
     NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0   
  
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO,  @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'     
   AND SETT_NO = '' AND SETT_TYPE = ''  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
IF @SAUDA_DATE = LEFT(GETDATE(),11) or @SAUDA_DATE = 'DEC 13 2024'
BEGIN  
 DELETE FROM TBL_PRODUCT_HOLD_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0 
 FROM #S_ISTDATA  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0    
 FROM #S_BTST  
END  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_DATA  
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
    QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE   
FROM #S_TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE AND EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_HOLD_DATA  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,  
    QTY,PAYIN_DATE,@SAUDA_DATE,ORGQTY=QTY,HOLDFLAG = 'OPEN SELL POSITION', CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
FROM #S_TBL_PRODUCT_DATA S  
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_SALE_ADJUST_BKP_30JAN2024
-- --------------------------------------------------

  
CREATE PROC [dbo].[PROC_PRODUCT_SALE_ADJUST_BKP_30JAN2024](  
           @SAUDA_DATE DATETIME)  
AS  
    
-- EXEC PROC_PRODUCT_SALE_ADJUST 'AUG  1 2017'  
  
SET NOCOUNT ON   
DECLARE @PAYINCUR   CURSOR,  
  @SNO    NUMERIC(18,0),  
  @PARTY_CODE   VARCHAR(10),  
  @SCRIP_CD   VARCHAR(12),  
  @SERIES    VARCHAR(3),  
  @BSECODE   VARCHAR(6),  
  @ISIN    VARCHAR(12),  
  @SELLQTY   INT,  
  @PAYIN_DATE   DATETIME,  
  @TRANSTYPE   VARCHAR(10),  
  @BUYADJ    CURSOR,  
  @SETT_NO   VARCHAR(7),  
  @BTSTQTY   INT,  
  @B_START_DATE  DATETIME,  
  @B_PAYIN_DATE  DATETIME,  
  @MTFQTY    INT,  
  @SETT_TYPE   VARCHAR(2),  
     @HOLDFLAG   VARCHAR(50)    
  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
INTO #S_MTFPOS  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
  
  
CREATE INDEX #SPAR ON #S_MTFPOS  
(PARTY_CODE,SCRIP_CD,SERIES,BSECODE)  
  
  
INSERT INTO #S_MTFPOS  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
FROM TBL_PRODUCT_DATA S  
WHERE  SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 1   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))   
  
SELECT * INTO #S_TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND SNO NOT IN (SELECT SNO FROM #S_TBL_PRODUCT_DATA)  
  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES= CONVERT(VARCHAR(3),D.SERIES),   
BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,   
ORGQTY = QTY,   
HOLDFLAG = '2 BTST POSTION'  
INTO #S_BTST  
FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.SCRIP_CD = D.SCRIP_CD  
    AND P.SERIES = D.SERIES)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
INSERT INTO #S_BTST  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  
ORGQTY = QTY,  HOLDFLAG = '2 BTST POSTION'   
FROM ANGELDEMAT.BSEDB.DBO.DELIVERYCLT D, ANGELDEMAT.BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.BSECODE = D.SCRIP_CD)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
UPDATE #S_BTST SET QTY = QTY - BTSTQTY FROM (  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, BTSTQTY = SUM(QTY)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE   
AND SELL_BUY = 1   
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) A  
WHERE #S_BTST.SETT_NO = A.SETT_NO   
 AND #S_BTST.SETT_TYPE = A.SETT_TYPE  
 AND #S_BTST.PARTY_CODE = A.PARTY_CODE  
 AND ((#S_BTST.SCRIP_CD = A.SCRIP_CD  
 AND #S_BTST.SERIES = A.SERIES)  
 OR (#S_BTST.BSECODE = A.BSECODE))  
  
--DELETE FROM #S_BTST WHERE QTY <= 0    
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE  
   FROM #S_BTST D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ((D.SCRIP_CD = @SCRIP_CD  
   AND   D.SERIES = @SERIES)  
   OR (D.BSECODE = @BSECODE))  
   AND QTY > 0   
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
DELETE FROM #S_TBL_PRODUCT_DATA  
WHERE QTY = 0   
  
  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''),   
QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
INTO #S_IST  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2    
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE  
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE,CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S,   
ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES,   
BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE   
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
       UNION   
       SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,   
HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP   
       UNION   
       SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
SELECT *, ORGFLAG = HOLDFLAG INTO #V_IST FROM #S_IST   
WHERE 1 = 2    
  
INSERT INTO #V_IST   
SELECT SETT_NO = 'VIRTUAL', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '',SERIES = '', BSECODE = '',   
QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN, HOLDFLAG = 'MTFCOLL',   
ORGQTY = SUM(QTY), ORGFLAG = HOLDFLAG   
FROM  TBL_MTF_MARKING  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG<>'MTFCOLL'  
GROUP BY PARTY_CODE, ISIN, HOLDFLAG   
  
INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,SERIES,   
BSECODE = '', QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
           WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT,DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = LEFT(SCRIP_CD,6), QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
        WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
        WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT, DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END),   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE NOT IN ('MCX','NCX','MTF')     
    AND SEGMENT <> 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN,  
 SEGMENT            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0      
  
 /*  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = 'MTFCOLL',   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE = 'MTF'     
    AND SEGMENT = 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
 */  
  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
INTO #S_ISTDATA FROM #S_IST WHERE SETT_NO <> 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
UPDATE #S_ISTDATA SET QTY = #S_ISTDATA.QTY - #V_IST.QTY   
FROM #V_IST  
WHERE #V_IST.Party_Code = #S_ISTDATA.Party_Code   
AND #V_IST.ISIN = #S_ISTDATA.ISIN    
AND #V_IST.ORGFLAG = #S_ISTDATA.HOLDFLAG  
  
DELETE FROM #S_ISTDATA  
WHERE QTY <= 0   
  
INSERT INTO #S_ISTDATA  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
FROM #V_IST --WHERE SETT_NO = 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
CREATE CLUSTERED INDEX SETT ON #S_ISTDATA  
(  
 SETT_NO, SETT_TYPE, PARTY_CODE  
)  
  
DROP TABLE #S_IST  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,SETT_NO, SETT_TYPE, PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE,   
          @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT  QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'  
   AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO  @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0       
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY,   
     NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0   
  
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO,  @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'     
   AND SETT_NO = '' AND SETT_TYPE = ''  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
IF @SAUDA_DATE = LEFT(GETDATE(),11) or @SAUDA_DATE = 'JAN 29 2024'  
BEGIN  
 DELETE FROM TBL_PRODUCT_HOLD_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0   
 FROM #S_ISTDATA  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0    
 FROM #S_BTST  
END  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_DATA  
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
    QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE   
FROM #S_TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE AND EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_HOLD_DATA  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,  
    QTY,PAYIN_DATE,@SAUDA_DATE,ORGQTY=QTY,HOLDFLAG = 'OPEN SELL POSITION', CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
FROM #S_TBL_PRODUCT_DATA S  
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_SALE_ADJUST_BKUP_05SEP2025
-- --------------------------------------------------








  
CREATE PROC [dbo].[PROC_PRODUCT_SALE_ADJUST](  
           @SAUDA_DATE DATETIME)  
AS  
    
-- EXEC PROC_PRODUCT_SALE_ADJUST 'AUG  1 2017'  
  
SET NOCOUNT ON   
DECLARE @PAYINCUR   CURSOR,  
  @SNO    NUMERIC(18,0),  
  @PARTY_CODE   VARCHAR(10),  
  @SCRIP_CD   VARCHAR(12),  
  @SERIES    VARCHAR(3),  
  @BSECODE   VARCHAR(6),  
  @ISIN    VARCHAR(12),  
  @SELLQTY   INT,  
  @PAYIN_DATE   DATETIME,  
  @TRANSTYPE   VARCHAR(10),  
  @BUYADJ    CURSOR,  
  @SETT_NO   VARCHAR(7),  
  @BTSTQTY   INT,  
  @B_START_DATE  DATETIME,  
  @B_PAYIN_DATE  DATETIME,  
  @MTFQTY    INT,  
  @SETT_TYPE   VARCHAR(2),  
     @HOLDFLAG   VARCHAR(50)    
  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
INTO #S_MTFPOS  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
  
  
CREATE INDEX #SPAR ON #S_MTFPOS  
(PARTY_CODE,SCRIP_CD,SERIES,BSECODE)  
  
  
INSERT INTO #S_MTFPOS  
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE   
FROM TBL_PRODUCT_DATA S  
WHERE  SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 1   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))   
  
SELECT * INTO #S_TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE)))  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND SNO NOT IN (SELECT SNO FROM #S_TBL_PRODUCT_DATA)  
  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES= CONVERT(VARCHAR(3),D.SERIES),   
BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,   
ORGQTY = QTY,   
HOLDFLAG = '2 BTST POSTION'  
INTO #S_BTST  
FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.SCRIP_CD = D.SCRIP_CD  
    AND P.SERIES = D.SERIES)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
INSERT INTO #S_BTST  
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,  
ORGQTY = QTY,  HOLDFLAG = '2 BTST POSTION'   
FROM ANGELDEMAT.BSEDB.DBO.DELIVERYCLT D, ANGELDEMAT.BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   INOUT = 'O'  
AND   D.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P  
     WHERE P.PARTY_CODE = D.PARTY_CODE  
    AND P.BSECODE = D.SCRIP_CD)  
AND S.START_DATE < @SAUDA_DATE  
AND S.SEC_PAYIN > @SAUDA_DATE  
AND 1 = 2   
  
UPDATE #S_BTST SET QTY = QTY - BTSTQTY FROM (  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, BTSTQTY = SUM(QTY)  
FROM TBL_PRODUCT_POSITION  
WHERE SAUDA_DATE < @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE   
AND SELL_BUY = 1   
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) A  
WHERE #S_BTST.SETT_NO = A.SETT_NO   
 AND #S_BTST.SETT_TYPE = A.SETT_TYPE  
 AND #S_BTST.PARTY_CODE = A.PARTY_CODE  
 AND ((#S_BTST.SCRIP_CD = A.SCRIP_CD  
 AND #S_BTST.SERIES = A.SERIES)  
 OR (#S_BTST.BSECODE = A.BSECODE))  
  
--DELETE FROM #S_BTST WHERE QTY <= 0    
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE  
   FROM #S_BTST D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ((D.SCRIP_CD = @SCRIP_CD  
   AND   D.SERIES = @SERIES)  
   OR (D.BSECODE = @BSECODE))  
   AND QTY > 0   
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_BTST SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND ((SCRIP_CD = @SCRIP_CD  
       AND   SERIES = @SERIES)  
         OR (BSECODE = @BSECODE))  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
DELETE FROM #S_TBL_PRODUCT_DATA  
WHERE QTY = 0   
  
  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''),   
QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
INTO #S_IST  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2    
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE  
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE,CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,  
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S,   
ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE S.SETT_NO = D.ISETT_NO  
AND   S.SETT_TYPE = D.ISETT_TYPE   
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'  
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES,   
BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,  
ISIN = CERTNO, HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('N', 'W')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE   
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
       UNION   
       SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
INSERT INTO #S_IST  
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),  
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,   
HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S  
WHERE S.SETT_NO = D.SETT_NO  
AND   S.SETT_TYPE = D.SETT_TYPE   
AND   DRCR = 'C' AND FILLER2 = 1    
AND   S.SETT_TYPE IN ('D', 'C')  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   S.START_DATE <= @SAUDA_DATE  
AND   S.SEC_PAYIN > @SAUDA_DATE  
AND   SHARETYPE <> 'AUCTION'  
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP   
       UNION   
       SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )  
AND   TRTYPE <> 907  
AND 1 = 2   
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO  
  
SELECT *, ORGFLAG = HOLDFLAG INTO #V_IST FROM #S_IST   
WHERE 1 = 2    
  
INSERT INTO #V_IST   
SELECT SETT_NO = 'VIRTUAL', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '',SERIES = '', BSECODE = '',   
QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN, HOLDFLAG = 'MTFCOLL',   
ORGQTY = SUM(QTY), ORGFLAG = HOLDFLAG   
FROM  TBL_MTF_MARKING  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG<>'MTFCOLL'  
GROUP BY PARTY_CODE, ISIN, HOLDFLAG   
  
INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,SERIES,   
BSECODE = '', QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
           WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT,DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''),   
SERIES = CONVERT(VARCHAR(3),''),   
BSECODE = LEFT(SCRIP_CD,6), QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'  
           WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'  
        WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'  
        WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'  
        ELSE 'BEN'  
         END),   
ORGQTY = SUM(QTY)  
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP  
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'  
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P  
      WHERE P.PARTY_CODE = D.PARTY_CODE  
     AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
AND   D.BDPID = DP.DPID  
AND   D.BCLTDPID = DP.DPCLTNO  
--AND   DP.EXCHANGE <> 'MTF'  
AND   DP.DESCRIPTION NOT LIKE '%POOL%'  
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'  
AND TrType IN (904,1002,909)  
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)  
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT, DESCRIPTION  
  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END),   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE NOT IN ('MCX','NCX','MTF')     
    AND SEGMENT <> 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN,  
 SEGMENT            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0      
  
 /*  
INSERT INTO #S_IST  
SELECT     
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,     
    SERIES, BSECODE = '',   
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),      
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049',   
 ISIN, HOLDFLAG = 'MTFCOLL',   
 ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)      
FROM     
    MSAJAG.DBO.C_SECURITIESMST D           
WHERE     
    ACTIVE = 1     
    AND EXCHANGE = 'MTF'     
    AND SEGMENT = 'MTF'            
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'           
    AND PARTY_CODE <> 'BROKER'    
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
    WHERE P.PARTY_CODE = D.PARTY_CODE )       
GROUP BY     
    PARTY_CODE,     
    SCRIP_CD,     
    SERIES,     
    ISIN            
HAVING     
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0  
 */  
  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
INTO #S_ISTDATA FROM #S_IST WHERE SETT_NO <> 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
UPDATE #S_ISTDATA SET QTY = #S_ISTDATA.QTY - #V_IST.QTY   
FROM #V_IST  
WHERE #V_IST.Party_Code = #S_ISTDATA.Party_Code   
AND #V_IST.ISIN = #S_ISTDATA.ISIN    
AND #V_IST.ORGFLAG = #S_ISTDATA.HOLDFLAG  
  
DELETE FROM #S_ISTDATA  
WHERE QTY <= 0   
  
INSERT INTO #S_ISTDATA  
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '',   
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG  
FROM #V_IST --WHERE SETT_NO = 'VIRTUAL'  
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG  
  
CREATE CLUSTERED INDEX SETT ON #S_ISTDATA  
(  
 SETT_NO, SETT_TYPE, PARTY_CODE  
)  
  
DROP TABLE #S_IST  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,SETT_NO, SETT_TYPE, PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE,   
          @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT  QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'  
   AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO  @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0       
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY,   
     NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0   
  
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO,  @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  
  
SET @PAYINCUR = CURSOR FOR  
 SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE  
 FROM #S_TBL_PRODUCT_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND PRODUCT_CODE = 'MTF'  
 AND SELL_BUY = 2   
 AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
 AND 1 = 2   
 ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE  
OPEN @PAYINCUR  
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 --SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE   
 IF @SELLQTY > 0   
 BEGIN  
  SET @BUYADJ = CURSOR FOR  
   SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE, HOLDFLAG  
   FROM #S_ISTDATA D  
   WHERE D.PARTY_CODE = @PARTY_CODE  
   AND   ISIN = @ISIN  
   AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'     
   AND SETT_NO = '' AND SETT_TYPE = ''  
   ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG  
  OPEN @BUYADJ  
  FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   IF @SELLQTY > 0   
   BEGIN  
    IF @BTSTQTY >= @SELLQTY  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
  
     SET @SELLQTY = 0  
    END  
    ELSE  
    BEGIN  
     UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY  
     WHERE SNO = @SNO  
  
     UPDATE #S_ISTDATA SET QTY = 0  
     WHERE SETT_NO = @SETT_NO  
       AND SETT_TYPE = @SETT_TYPE  
       AND PARTY_CODE = @PARTY_CODE  
       AND   ISIN = @ISIN  
       AND HOLDFLAG = @HOLDFLAG  
       AND QTY > 0  
     
     SET @SELLQTY = @SELLQTY - @BTSTQTY  
    END  
   END  
   FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG  
  END  
 END  
 FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE  
END  
CLOSE @PAYINCUR  
DEALLOCATE @PAYINCUR  

----CHANGE DONE UNDER SRE_32204  
----IF @SAUDA_DATE = LEFT(GETDATE(),11) or @SAUDA_DATE = 'DEC 13 2024'
BEGIN  
 DELETE FROM TBL_PRODUCT_HOLD_DATA  
 WHERE SAUDA_DATE = @SAUDA_DATE  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0 
 FROM #S_ISTDATA  
  
 INSERT INTO TBL_PRODUCT_HOLD_DATA   
 SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *,   
 CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0    
 FROM #S_BTST  
END  
  
DELETE FROM TBL_PRODUCT_DATA   
WHERE SAUDA_DATE = @SAUDA_DATE  
AND PRODUCT_CODE = 'MTF'  
AND SELL_BUY = 2   
AND TRANSTYPE IN ('TRNSE', 'TRBSE')  
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_DATA  
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,  
    QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE   
FROM #S_TBL_PRODUCT_DATA S  
WHERE SAUDA_DATE = @SAUDA_DATE AND EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2   
  
INSERT INTO TBL_PRODUCT_HOLD_DATA  
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,  
    QTY,PAYIN_DATE,@SAUDA_DATE,ORGQTY=QTY,HOLDFLAG = 'OPEN SELL POSITION', CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
FROM #S_TBL_PRODUCT_DATA S  
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P  
     WHERE P.PARTY_CODE = S.PARTY_CODE  
    AND ((P.SCRIP_CD = S.SCRIP_CD  
    AND P.SERIES = S.SERIES)  
    OR (P.BSECODE = S.BSECODE))  
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN))   
AND QTY > 0   
AND 1 = 2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_SALE_ADJUST_BKUP_25Nov2022
-- --------------------------------------------------

Create PROC [dbo].[PROC_PRODUCT_SALE_ADJUST_BKUP_25Nov2022](
           @SAUDA_DATE DATETIME)
AS
  
-- EXEC PROC_PRODUCT_SALE_ADJUST 'AUG  1 2017'

SET NOCOUNT ON 
DECLARE @PAYINCUR			CURSOR,
		@SNO				NUMERIC(18,0),
		@PARTY_CODE			VARCHAR(10),
		@SCRIP_CD			VARCHAR(12),
		@SERIES				VARCHAR(3),
		@BSECODE			VARCHAR(6),
		@ISIN				VARCHAR(12),
		@SELLQTY			INT,
		@PAYIN_DATE			DATETIME,
		@TRANSTYPE			VARCHAR(10),
		@BUYADJ				CURSOR,
		@SETT_NO			VARCHAR(7),
		@BTSTQTY			INT,
		@B_START_DATE		DATETIME,
		@B_PAYIN_DATE		DATETIME,
		@MTFQTY				INT,
		@SETT_TYPE			VARCHAR(2),
	    @HOLDFLAG			VARCHAR(50)		

SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE 
INTO #S_MTFPOS
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE AND ADJUST_DATE >= @SAUDA_DATE
AND SELL_BUY = 1 


CREATE INDEX #SPAR ON #S_MTFPOS
(PARTY_CODE,SCRIP_CD,SERIES,BSECODE)


INSERT INTO #S_MTFPOS
SELECT DISTINCT PARTY_CODE, SCRIP_CD, SERIES, BSECODE 
FROM TBL_PRODUCT_DATA S
WHERE  SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND SELL_BUY = 1 
AND TRANSTYPE IN ('TRNSE', 'TRBSE')
AND NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P
			  WHERE P.PARTY_CODE = S.PARTY_CODE
				AND ((P.SCRIP_CD = S.SCRIP_CD
				AND P.SERIES = S.SERIES)
				OR (P.BSECODE = S.BSECODE))) 

SELECT * INTO #S_TBL_PRODUCT_DATA FROM TBL_PRODUCT_DATA S
WHERE SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND SELL_BUY = 2 
AND TRANSTYPE IN ('TRNSE', 'TRBSE')
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P
			  WHERE P.PARTY_CODE = S.PARTY_CODE
				AND ((P.SCRIP_CD = S.SCRIP_CD
				AND P.SERIES = S.SERIES)
				OR (P.BSECODE = S.BSECODE)))

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND SELL_BUY = 2 
AND TRANSTYPE IN ('TRNSE', 'TRBSE')
AND SNO NOT IN (SELECT SNO FROM #S_TBL_PRODUCT_DATA)

SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES= CONVERT(VARCHAR(3),D.SERIES), 
BSECODE = CONVERT(VARCHAR(6),''),ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE, 
ORGQTY = QTY, 
HOLDFLAG = '2 BTST POSTION'
INTO #S_BTST
FROM MSAJAG.DBO.DELIVERYCLT D, MSAJAG.DBO.SETT_MST S
WHERE S.SETT_NO = D.SETT_NO
AND   S.SETT_TYPE = D.SETT_TYPE 
AND   INOUT = 'O'
AND	  D.SETT_TYPE IN ('N', 'W')
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE
				AND P.SCRIP_CD = D.SCRIP_CD
				AND P.SERIES = D.SERIES)
AND S.START_DATE < @SAUDA_DATE
AND	S.SEC_PAYIN > @SAUDA_DATE
AND 1 = 2 

INSERT INTO #S_BTST
SELECT D.SETT_NO, D.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
BSECODE = SCRIP_CD, ISIN = CONVERT(VARCHAR(12),''), QTY, SEC_PAYIN, START_DATE,
ORGQTY = QTY,  HOLDFLAG = '2 BTST POSTION' 
FROM ANGELDEMAT.BSEDB.DBO.DELIVERYCLT D, ANGELDEMAT.BSEDB.DBO.SETT_MST S
WHERE S.SETT_NO = D.SETT_NO
AND   S.SETT_TYPE = D.SETT_TYPE 
AND	  INOUT = 'O'
AND	  D.SETT_TYPE IN ('D', 'C')
AND   EXISTS (SELECT PARTY_CODE FROM #S_TBL_PRODUCT_DATA P
			  WHERE P.PARTY_CODE = D.PARTY_CODE
				AND P.BSECODE = D.SCRIP_CD)
AND S.START_DATE < @SAUDA_DATE
AND	S.SEC_PAYIN > @SAUDA_DATE
AND 1 = 2 

UPDATE #S_BTST SET QTY = QTY - BTSTQTY FROM (
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE, BTSTQTY = SUM(QTY)
FROM TBL_PRODUCT_POSITION
WHERE SAUDA_DATE < @SAUDA_DATE AND PAYIN_DATE > @SAUDA_DATE 
AND SELL_BUY = 1 
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD, SERIES, BSECODE ) A
WHERE #S_BTST.SETT_NO = A.SETT_NO 
	AND #S_BTST.SETT_TYPE = A.SETT_TYPE
	AND #S_BTST.PARTY_CODE = A.PARTY_CODE
	AND ((#S_BTST.SCRIP_CD = A.SCRIP_CD
	AND #S_BTST.SERIES = A.SERIES)
	OR (#S_BTST.BSECODE = A.BSECODE))

--DELETE FROM #S_BTST WHERE QTY <= 0  

SET @PAYINCUR = CURSOR FOR
	SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE
	FROM #S_TBL_PRODUCT_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND PRODUCT_CODE = 'MTF'
	AND SELL_BUY = 2 
	AND TRANSTYPE IN ('TRNSE', 'TRBSE')
	ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE
OPEN @PAYINCUR
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE
WHILE @@FETCH_STATUS = 0 
BEGIN
	--SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE	
	IF @SELLQTY > 0 
	BEGIN
		SET @BUYADJ = CURSOR FOR
			SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE
			FROM #S_BTST D
			WHERE D.PARTY_CODE = @PARTY_CODE
			AND   ((D.SCRIP_CD = @SCRIP_CD
			AND   D.SERIES = @SERIES)
			OR (D.BSECODE = @BSECODE))
			AND QTY > 0 
			ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE
		OPEN @BUYADJ
		FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE
		WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @SELLQTY > 0 
			BEGIN
				IF @BTSTQTY >= @SELLQTY
				BEGIN
					UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0
					WHERE SNO = @SNO

					UPDATE #S_BTST SET QTY = QTY - @SELLQTY
					WHERE SETT_NO = @SETT_NO
					  AND SETT_TYPE = @SETT_TYPE
					  AND PARTY_CODE = @PARTY_CODE
					  AND ((SCRIP_CD = @SCRIP_CD
					  AND   SERIES = @SERIES)
					    OR (BSECODE = @BSECODE))
					  AND QTY > 0

					SET @SELLQTY = 0
				END
				ELSE
				BEGIN
					UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY
					WHERE SNO = @SNO

					UPDATE #S_BTST SET QTY = 0
					WHERE SETT_NO = @SETT_NO
					  AND SETT_TYPE = @SETT_TYPE
					  AND PARTY_CODE = @PARTY_CODE
					  AND ((SCRIP_CD = @SCRIP_CD
					  AND   SERIES = @SERIES)
					    OR (BSECODE = @BSECODE))
					  AND QTY > 0
			
					SET @SELLQTY = @SELLQTY - @BTSTQTY
				END
			END
			FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE
		END
	END
	FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE
END
CLOSE @PAYINCUR
DEALLOCATE @PAYINCUR

DELETE FROM #S_TBL_PRODUCT_DATA
WHERE QTY = 0 


SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''), 
QTY = SUM(QTY), SEC_PAYIN, START_DATE,
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)
INTO #S_IST
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP
WHERE S.SETT_NO = D.ISETT_NO
AND   S.SETT_TYPE = D.ISETT_TYPE 
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'
AND	  S.SETT_TYPE IN ('N', 'W')
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   S.START_DATE <= @SAUDA_DATE
AND	  S.SEC_PAYIN > @SAUDA_DATE
AND   D.BDPID = DP.DPID
AND   D.BCLTDPID = DP.DPCLTNO
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)
AND   DP.DESCRIPTION NOT LIKE '%POOL%'
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
AND 1 = 2  
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO

INSERT INTO #S_IST
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR(3),''), 
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP
WHERE S.SETT_NO = D.ISETT_NO
AND   S.SETT_TYPE = D.ISETT_TYPE 
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'
AND	  S.SETT_TYPE IN ('N', 'W')
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   S.START_DATE <= @SAUDA_DATE
AND	  S.SEC_PAYIN > @SAUDA_DATE
AND   D.BDPID = DP.DPID
AND   D.BCLTDPID = DP.DPCLTNO
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)
AND   DP.DESCRIPTION NOT LIKE '%POOL%'
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
AND 1 = 2 
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO

INSERT INTO #S_IST
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,
ISIN = CERTNO, HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP
WHERE S.SETT_NO = D.ISETT_NO
AND   S.SETT_TYPE = D.ISETT_TYPE 
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'
AND	  S.SETT_TYPE IN ('D', 'C')
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   S.START_DATE <= @SAUDA_DATE
AND	  S.SEC_PAYIN > @SAUDA_DATE
AND   D.BDPID = DP.DPID
AND   D.BCLTDPID = DP.DPCLTNO
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)
AND   DP.DESCRIPTION NOT LIKE '%POOL%'
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
AND 1 = 2 
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE,CERTNO

INSERT INTO #S_IST
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), 
SERIES = CONVERT(VARCHAR(3),''), 
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO,
HOLDFLAG = 'PAY-IN GIVEN', ORGQTY = SUM(QTY)
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S, 
ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP
WHERE S.SETT_NO = D.ISETT_NO
AND   S.SETT_TYPE = D.ISETT_TYPE 
AND   DRCR = 'D' AND FILLER2 = 1 AND DELIVERED <> '0'
AND	  S.SETT_TYPE IN ('D', 'C')
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   S.START_DATE <= @SAUDA_DATE
AND	  S.SEC_PAYIN > @SAUDA_DATE
AND   D.BDPID = DP.DPID
AND   D.BCLTDPID = DP.DPCLTNO
AND   DP.EXCHANGE <> (CASE WHEN ACCOUNTTYPE = 'BEN' AND DP.EXCHANGE = 'MTF' THEN 'MTF' ELSE '' END)
AND   DP.DESCRIPTION NOT LIKE '%POOL%'
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
AND 1 = 2 
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO

INSERT INTO #S_IST
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, 
BSECODE = CONVERT(VARCHAR(6),''), QTY = SUM(QTY), SEC_PAYIN, START_DATE,
ISIN = CERTNO, HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.SETT_MST S
WHERE S.SETT_NO = D.SETT_NO
AND   S.SETT_TYPE = D.SETT_TYPE 
AND   DRCR = 'C' AND FILLER2 = 1  
AND	  S.SETT_TYPE IN ('N', 'W')
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   S.START_DATE <= @SAUDA_DATE
AND	  S.SEC_PAYIN > @SAUDA_DATE 
AND   SHARETYPE <> 'AUCTION'
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP
					  UNION 
					  SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )
AND   TRTYPE <> 907
AND 1 = 2 
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO

INSERT INTO #S_IST
SELECT S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), 
SERIES = CONVERT(VARCHAR(3),''), 
BSECODE = SCRIP_CD, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ISIN = CERTNO, 
HOLDFLAG = 'PAY-IN REC', ORGQTY = SUM(QTY)
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.SETT_MST S
WHERE S.SETT_NO = D.SETT_NO
AND   S.SETT_TYPE = D.SETT_TYPE 
AND   DRCR = 'C' AND FILLER2 = 1  
AND	  S.SETT_TYPE IN ('D', 'C')
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   S.START_DATE <= @SAUDA_DATE
AND	  S.SEC_PAYIN > @SAUDA_DATE
AND   SHARETYPE <> 'AUCTION'
AND   CLTDPID NOT IN (SELECT DPCLTNO FROM ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP 
					  UNION 
					  SELECT DPCLTNO FROM ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP )
AND   TRTYPE <> 907
AND 1 = 2 
GROUP BY S.SETT_NO, S.SETT_TYPE, PARTY_CODE, SCRIP_CD, D.SERIES, SEC_PAYIN, START_DATE, CERTNO

SELECT *, ORGFLAG = HOLDFLAG INTO #V_IST FROM #S_IST 
WHERE 1 = 2  

INSERT INTO #V_IST 
SELECT SETT_NO = 'VIRTUAL', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = '',SERIES = '', BSECODE = '', 
QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049', 
ISIN, HOLDFLAG = 'MTFCOLL', 
ORGQTY = SUM(QTY), ORGFLAG = HOLDFLAG 
FROM  TBL_MTF_MARKING
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG<>'MTFCOLL'
GROUP BY PARTY_CODE, ISIN, HOLDFLAG 

INSERT INTO #S_IST
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,SERIES, 
BSECODE = '', QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049', 
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							    WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
							    WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'
							    WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'
								ELSE 'BEN'
						   END), 
ORGQTY = SUM(QTY)
FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   D.BDPID = DP.DPID
AND   D.BCLTDPID = DP.DPCLTNO
--AND   DP.EXCHANGE <> 'MTF'
AND   DP.DESCRIPTION NOT LIKE '%POOL%'
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
AND TrType IN (904,1002,909)
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT,DESCRIPTION

INSERT INTO #S_IST
SELECT SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD = CONVERT(VARCHAR(12),''), 
SERIES = CONVERT(VARCHAR(3),''), 
BSECODE = LEFT(SCRIP_CD,6), QTY = SUM(QTY), SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049', 
ISIN = CERTNO, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL'
							    WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'MAR' THEN 'CMCOLL'
								WHEN SEGMENT = 'MTF' AND ACCOUNTTYPE = 'MAR' THEN 'MTFCOLL'
								WHEN SEGMENT = 'CAPITAL' AND ACCOUNTTYPE = 'BEN' AND DESCRIPTION LIKE '%CUSA%' THEN 'BEN_C'
								ELSE 'BEN'
						   END), 
ORGQTY = SUM(QTY)
FROM ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP
WHERE DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'
AND   EXISTS (SELECT PARTY_CODE FROM TBLCLIENTMARGIN P
				  WHERE P.PARTY_CODE = D.PARTY_CODE
					AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)
AND   D.BDPID = DP.DPID
AND   D.BCLTDPID = DP.DPCLTNO
--AND   DP.EXCHANGE <> 'MTF'
AND   DP.DESCRIPTION NOT LIKE '%POOL%'
AND   DP.DESCRIPTION NOT LIKE '%PRINC%'
AND TrType IN (904,1002,909)
AND DP.EXCHANGE = (CASE WHEN DP.EXCHANGE = 'MTF' AND DP.ACCOUNTTYPE = 'BEN' THEN '' ELSE DP.EXCHANGE END)
GROUP BY PARTY_CODE, SCRIP_CD, D.SERIES, CERTNO, ACCOUNTTYPE, SEGMENT, DESCRIPTION

INSERT INTO #S_IST
SELECT   
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,   
    SERIES, BSECODE = '', 
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),    
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049', 
	ISIN, HOLDFLAG = (CASE WHEN SEGMENT = 'FUTURES' THEN 'FOCOLL' ELSE 'CMCOLL' END), 
	ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)    
FROM   
    MSAJAG.DBO.C_SECURITIESMST D         
WHERE   
    ACTIVE = 1   
    AND EXCHANGE NOT IN ('MCX','NCX','MTF')   
    AND SEGMENT <> 'MTF'          
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
    AND PARTY_CODE <> 'BROKER' 	
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P
		  WHERE P.PARTY_CODE = D.PARTY_CODE )     
GROUP BY   
    PARTY_CODE,   
    SCRIP_CD,   
    SERIES,   
    ISIN,
	SEGMENT          
HAVING   
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0    

	/*
INSERT INTO #S_IST
SELECT   
    SETT_NO = '', SETT_TYPE = '', PARTY_CODE, SCRIP_CD,   
    SERIES, BSECODE = '', 
    BALQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END),    
    SEC_PAYIN = 'DEC 31 2049', START_DATE = 'DEC 31 2049', 
	ISIN, HOLDFLAG = 'MTFCOLL', 
	ORGQTY = SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END)    
FROM   
    MSAJAG.DBO.C_SECURITIESMST D         
WHERE   
    ACTIVE = 1   
    AND EXCHANGE = 'MTF'   
    AND SEGMENT = 'MTF'          
    AND EFFDATE <= @SAUDA_DATE + ' 23:59:59'         
    AND PARTY_CODE <> 'BROKER' 	
AND   EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P
		  WHERE P.PARTY_CODE = D.PARTY_CODE )     
GROUP BY   
    PARTY_CODE,   
    SCRIP_CD,   
    SERIES,   
    ISIN          
HAVING   
    SUM(CASE WHEN DRCR = 'D' THEN -QTY ELSE QTY END) <> 0
	*/

SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '', 
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG
INTO #S_ISTDATA FROM #S_IST WHERE SETT_NO <> 'VIRTUAL'
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG

UPDATE #S_ISTDATA SET QTY = #S_ISTDATA.QTY - #V_IST.QTY 
FROM #V_IST
WHERE #V_IST.Party_Code = #S_ISTDATA.Party_Code 
AND #V_IST.ISIN = #S_ISTDATA.ISIN  
AND #V_IST.ORGFLAG = #S_ISTDATA.HOLDFLAG

DELETE FROM #S_ISTDATA
WHERE QTY <= 0 

INSERT INTO #S_ISTDATA
SELECT SETT_NO, SETT_TYPE, PARTY_CODE, SCRIP_CD = '', SERIES = '', BSECODE = '', 
ISIN, QTY = SUM(QTY), SEC_PAYIN, START_DATE, ORGQTY = SUM(ORGQTY), HOLDFLAG
FROM #V_IST --WHERE SETT_NO = 'VIRTUAL'
GROUP BY SETT_NO, SETT_TYPE, PARTY_CODE, ISIN, SEC_PAYIN, START_DATE, HOLDFLAG

CREATE CLUSTERED INDEX SETT ON #S_ISTDATA
(
	SETT_NO, SETT_TYPE, PARTY_CODE
)

DROP TABLE #S_IST

SET @PAYINCUR = CURSOR FOR
	SELECT SNO,SETT_NO, SETT_TYPE, PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE
	FROM #S_TBL_PRODUCT_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND PRODUCT_CODE = 'MTF'
	AND SELL_BUY = 2 
	AND TRANSTYPE IN ('TRNSE', 'TRBSE')
	AND 1 = 2 
	ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE
OPEN @PAYINCUR
FETCH NEXT FROM @PAYINCUR INTO @SNO, @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, 
							   @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE
WHILE @@FETCH_STATUS = 0 
BEGIN
	--SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE	
	IF @SELLQTY > 0 
	BEGIN
		SET @BUYADJ = CURSOR FOR
			SELECT  QTY, SEC_PAYIN, START_DATE, HOLDFLAG
			FROM #S_ISTDATA D
			WHERE D.PARTY_CODE = @PARTY_CODE
			AND   ISIN = @ISIN
			AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'
			AND SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE
			ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG
		OPEN @BUYADJ
		FETCH NEXT FROM @BUYADJ INTO  @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @SELLQTY > 0 
			BEGIN
				IF @BTSTQTY >= @SELLQTY
				BEGIN
					UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0
					WHERE SNO = @SNO

					UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY
					WHERE SETT_NO = @SETT_NO
					  AND SETT_TYPE = @SETT_TYPE
					  AND PARTY_CODE = @PARTY_CODE
					  AND   ISIN = @ISIN
					  AND HOLDFLAG = @HOLDFLAG
					  AND QTY > 0 				

					SET @SELLQTY = 0
				END
				ELSE
				BEGIN
					UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, 
					NETAMT = NETAMT / @BTSTQTY
					WHERE SNO = @SNO

					UPDATE #S_ISTDATA SET QTY = 0
					WHERE SETT_NO = @SETT_NO
					  AND SETT_TYPE = @SETT_TYPE
					  AND PARTY_CODE = @PARTY_CODE
					  AND   ISIN = @ISIN
					  AND HOLDFLAG = @HOLDFLAG
					  AND QTY > 0 

					SET @SELLQTY = @SELLQTY - @BTSTQTY
				END
			END
			FETCH NEXT FROM @BUYADJ INTO @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG
		END
	END
	FETCH NEXT FROM @PAYINCUR INTO @SNO,  @SETT_NO, @SETT_TYPE, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE
END
CLOSE @PAYINCUR
DEALLOCATE @PAYINCUR

SET @PAYINCUR = CURSOR FOR
	SELECT SNO,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,PAYIN_DATE,TRANSTYPE
	FROM #S_TBL_PRODUCT_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND PRODUCT_CODE = 'MTF'
	AND SELL_BUY = 2 
	AND TRANSTYPE IN ('TRNSE', 'TRBSE')
	AND 1 = 2 
	ORDER BY PAYIN_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE
OPEN @PAYINCUR
FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE
WHILE @@FETCH_STATUS = 0 
BEGIN
	--SELECT @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE	
	IF @SELLQTY > 0 
	BEGIN
		SET @BUYADJ = CURSOR FOR
			SELECT D.SETT_NO, D.SETT_TYPE, QTY, SEC_PAYIN, START_DATE, HOLDFLAG
			FROM #S_ISTDATA D
			WHERE D.PARTY_CODE = @PARTY_CODE
			AND   ISIN = @ISIN
			AND QTY > 0 AND HOLDFLAG <> 'FOCOLL'			
			AND SETT_NO = '' AND SETT_TYPE = ''
			ORDER BY SEC_PAYIN, START_DATE, SETT_NO, SETT_TYPE, HOLDFLAG
		OPEN @BUYADJ
		FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG
		WHILE @@FETCH_STATUS = 0
		BEGIN
			IF @SELLQTY > 0 
			BEGIN
				IF @BTSTQTY >= @SELLQTY
				BEGIN
					UPDATE #S_TBL_PRODUCT_DATA SET QTY = 0
					WHERE SNO = @SNO

					UPDATE #S_ISTDATA SET QTY = QTY - @SELLQTY
					WHERE SETT_NO = @SETT_NO
					  AND SETT_TYPE = @SETT_TYPE
					  AND PARTY_CODE = @PARTY_CODE
					  AND   ISIN = @ISIN
					  AND HOLDFLAG = @HOLDFLAG
					  AND QTY > 0

					SET @SELLQTY = 0
				END
				ELSE
				BEGIN
					UPDATE #S_TBL_PRODUCT_DATA SET QTY = QTY - @BTSTQTY, MKTAMT = MKTAMT / @BTSTQTY, NETAMT = NETAMT / @BTSTQTY
					WHERE SNO = @SNO

					UPDATE #S_ISTDATA SET QTY = 0
					WHERE SETT_NO = @SETT_NO
					  AND SETT_TYPE = @SETT_TYPE
					  AND PARTY_CODE = @PARTY_CODE
					  AND   ISIN = @ISIN
					  AND HOLDFLAG = @HOLDFLAG
					  AND QTY > 0
			
					SET @SELLQTY = @SELLQTY - @BTSTQTY
				END
			END
			FETCH NEXT FROM @BUYADJ INTO @SETT_NO, @SETT_TYPE, @BTSTQTY, @B_PAYIN_DATE, @B_START_DATE, @HOLDFLAG
		END
	END
	FETCH NEXT FROM @PAYINCUR INTO @SNO, @PARTY_CODE, @SCRIP_CD, @SERIES, @BSECODE, @ISIN, @SELLQTY, @PAYIN_DATE, @TRANSTYPE
END
CLOSE @PAYINCUR
DEALLOCATE @PAYINCUR

IF @SAUDA_DATE = LEFT(GETDATE(),11) or @SAUDA_DATE = 'NOV 22 2022'
BEGIN
	DELETE FROM TBL_PRODUCT_HOLD_DATA
	WHERE SAUDA_DATE = @SAUDA_DATE

	INSERT INTO TBL_PRODUCT_HOLD_DATA 
	SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *, 
	CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0 
	FROM #S_ISTDATA

	INSERT INTO TBL_PRODUCT_HOLD_DATA 
	SELECT SAUDA_DATE=CONVERT(DATETIME, @SAUDA_DATE), *, 
	CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0  
	FROM #S_BTST
END

DELETE FROM TBL_PRODUCT_DATA 
WHERE SAUDA_DATE = @SAUDA_DATE
AND PRODUCT_CODE = 'MTF'
AND SELL_BUY = 2 
AND TRANSTYPE IN ('TRNSE', 'TRBSE')
AND 1 = 2 

INSERT INTO TBL_PRODUCT_DATA
SELECT SAUDA_DATE,Sett_No,Sett_Type,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,ISIN,
	   QTY,MKTAMT,NETAMT,CL_RATE,PAYIN_DATE,ADJUST_DATE,TRANSTYPE,PROCESSDATE 
FROM #S_TBL_PRODUCT_DATA S
WHERE SAUDA_DATE = @SAUDA_DATE AND EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P
			  WHERE P.PARTY_CODE = S.PARTY_CODE
				AND ((P.SCRIP_CD = S.SCRIP_CD
				AND P.SERIES = S.SERIES)
				OR (P.BSECODE = S.BSECODE))
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN)) 
AND QTY > 0 
AND 1 = 2 

INSERT INTO TBL_PRODUCT_HOLD_DATA
SELECT SAUDA_DATE,SETT_NO,SETT_TYPE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,
	   QTY,PAYIN_DATE,@SAUDA_DATE,ORGQTY=QTY,HOLDFLAG = 'OPEN SELL POSITION', CL_RATE = 0, HAIRCUT = 0, FOGFLAG = 0, MTFHAIRCUT = 0
FROM #S_TBL_PRODUCT_DATA S
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #S_MTFPOS P
			  WHERE P.PARTY_CODE = S.PARTY_CODE
				AND ((P.SCRIP_CD = S.SCRIP_CD
				AND P.SERIES = S.SERIES)
				OR (P.BSECODE = S.BSECODE))
AND EXISTS (SELECT ISIN FROM TBLSCRIPMARGIN WHERE SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE AND S.ISIN = TBLSCRIPMARGIN.ISIN)) 
AND QTY > 0 
AND 1 = 2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_SHORTAGE
-- --------------------------------------------------

CREATE PROC PROC_PRODUCT_SHORTAGE
(
	@START_DATE VARCHAR(11)
)
AS

EXEC ANGELDEMAT.MSAJAG.DBO.PROC_PRODUCT_SHORTAGE @START_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_TDAY_ALLOC
-- --------------------------------------------------






/*
BEGIN TRAN
--EXEC PROC_PRODUCT_TDAY_ALLOC 'JAN 31 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  1 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  3 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  4 2025','','ZZZZZZZ'
EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  5 2025','','ZZZZZZZ'
EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  6 2025','','ZZZZZZZ'

SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC(NOLOCK) WHERE PARTY_CODE='AM0753' AND SCRIP_CD='GOODLUCK'
ROLLBACK
*/


CREATE	PROC [dbo].[PROC_PRODUCT_TDAY_ALLOC]
		(
		@SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20) = '',
		@TOPARTY	VARCHAR(20) = 'ZZZZZZ'
		)

		AS

DECLARE @SDTCUR		DATETIME,
		@LDTCUR		DATETIME,
		@EDT		VARCHAR(11),
		@PREVDATE	VARCHAR(11),
		@PROPOR_ALLOC_FLAG	INT

SET		@PROPOR_ALLOC_FLAG = 1

/*
DECLARE @SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)

SET		@SAUDA_DATE = 'JAN 31 2025'
SET		@FROMPARTY	= 'AF7259'
SET		@TOPARTY	= 'AF7259'
---IN('AA8143','AA8559')		'AF7259'
*/

SELECT	@EDT = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'

SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR      


SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017')        
FROM VW_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE

SELECT * INTO #MTR_RTP FROM TBL_MTR_REPORTING WHERE 1=2

ALTER TABLE #MTR_RTP
ALTER COLUMN BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN NETAMOUNT NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_NETAMOUNT NUMERIC(18,4)

IF (SELECT COUNT(1) FROM TBL_MTR_REPORTING WHERE SAUDA_DATE = @PREVDATE) > 0
BEGIN
	
	INSERT	INTO #MTR_RTP
	SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,
			M_BODQTY,M_BODVALUE,M_FRESHBQTY,M_FRESHBUY,M_FRESHSQTY,M_FRESHSELL,M_NETQTY,M_NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @PREVDATE

END
ELSE
BEGIN

	INSERT	INTO #MTR_RTP (SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE)
	SELECT	SAUDA_DATE=@PREVDATE,PARTY_CODE,SCRIP_CD,SERIES,
			BODQTY = SUM(QTY),      
			BODVALUE = SUM(MKTAMT),
			FRESHBQTY = 0,            
			FRESHBUY = 0,            
			FRESHSQTY = 0,      
			FRESHSELL = 0, 
			NETQTY = SUM(QTY),
			NETAMOUNT = SUM(MKTAMT),
			TRANSTYPE,
			SAUDA_DATE=@PREVDATE,
			ISIN,BSECODE
	FROM	VW_PRODUCT_POSITION
	WHERE	SAUDA_DATE <= @PREVDATE       
			AND ADJUST_DATE > @PREVDATE      
			AND SELL_BUY = 1
	GROUP BY
			PARTY_CODE,SCRIP_CD,SERIES,
			TRANSTYPE,ISIN,BSECODE
	HAVING	SUM(QTY) > 0 AND SUM(MKTAMT) > 0
END


SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE = CONVERT(NUMERIC(18,4),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,4),SUM(MKTAMT) ),      
FRESHSQTY = 0,
FRESHSELL = CONVERT(NUMERIC(18,4),0),
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
INTO #DATA      
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 


INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,4),SUM(MKTAMT)),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 

---------------------------------------------------------------------------------------------------------------------------------------------

SELECT	*,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		M_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0),
		SELL_BUY = CONVERT(INT,1),
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TBL_MTF_DATA_BUY 
FROM	TBL_MTF_DATA_BUY(NOLOCK) 
WHERE	SAUDA_DATE = @SAUDA_DATE
		AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY


INSERT	INTO #TBL_MTF_DATA_BUY
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,
		MARGIN_REQ,MTOM_LOSS,FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,
		CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
		FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
		CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ,ORG_HAIRCUT,ORG_MARGIN_REQ,SETT_NO,PAYIN_DATE,EXCHANGE,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		M_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0),
		SELL_BUY = CONVERT(INT,1),
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
FROM	TBL_MTF_DATA_BUY T(NOLOCK) 
WHERE	SAUDA_DATE = @SAUDA_DATE
		AND SAUDA_DATE = PAYIN_DATE
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = T.PARTY_CODE
					AND P.SCRIP_CD = T.SCRIP_CD
					AND P.ISIN = T.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)
		AND 1 = 2


UPDATE	#TBL_MTF_DATA_BUY 
SET		PAYIN_AMT = ISNULL(D.VAMT,0)
FROM	(
		SELECT	CLTCODE,
				VAMT = SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),
				VDT
		FROM	LEDGER P(NOLOCK)
		WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
				AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
				AND P.VTYP = '66'
				AND P.EDT BETWEEN @EDT AND @EDT + ' 23:59:59'
				--AND P.CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN P.CLTCODE ELSE @PARTY_CODE END)
				AND P.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
				AND P.NARRATION LIKE '%MTF PAYIN'
		GROUP BY
				CLTCODE,
				VDT
		HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0
		) D
WHERE	D.CLTCODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND D.VDT = #TBL_MTF_DATA_BUY.SAUDA_DATE



/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = ISNULL(T.M_QTY,0),
		NF_QTY = ISNULL(T.NF_QTY,0)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
					AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
					AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)

UPDATE	#TBL_MTF_DATA_BUY
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

UPDATE	#TBL_MTF_DATA_BUY
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND #TBL_MTF_DATA_BUY.CORP_AFTER_QTY <> 0

UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT	'#TBL_MTF_DATA_BUY-1',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE ='AHMAJ125' AND SCRIP_CD='TRITURBINE'

---------------------------------------------------------------------------------------------------------------------------------------------

DECLARE @ADJCUR		CURSOR, 
		@DELCUR		CURSOR, 
		@PARTYCODE	VARCHAR(20),
		@PAYIN_AMT	NUMERIC(18,4),
		@MKTAMT		NUMERIC(18,4),
		@MARGIN_REQ	NUMERIC(18,4),
		@SNO		INT,
		@MAMT		NUMERIC(18,4),
		@SAUDA_DATE_PAYIN	DATETIME,
		@PRO_PER	NUMERIC(18,2)


--	SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
--			PRO_PER =  (
--			CASE 
--				WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
--				ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
--			END)
--	FROM #TBL_MTF_DATA_BUY
--	WHERE PAYIN_AMT > 0 AND PARTY_CODE='HYDSBV101'
--	GROUP BY PARTY_CODE, SAUDA_DATE
--	ORDER BY PARTY_CODE, SAUDA_DATE


--SELECT SNO, MKTAMT, MARGIN_REQ = (CASE WHEN @PROPOR_ALLOC_FLAG = 1 THEN (MARGIN_REQ/@PRO_PER*100) ELSE MARGIN_REQ END)
--		FROM #TBL_MTF_DATA_BUY
--		WHERE 1=1
--		AND PARTY_CODE = 'HYDSBV101'
--		AND MKTAMT > 0 AND MARGIN_REQ > 0
--		ORDER BY PARTY_CODE, SCRIP_CD, SERIES


SET @ADJCUR = CURSOR FOR
	SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
			PRO_PER =  (
			CASE 
				WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
				ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
			END)
	FROM #TBL_MTF_DATA_BUY
	WHERE PAYIN_AMT > 0
	GROUP BY PARTY_CODE, SAUDA_DATE
	ORDER BY PARTY_CODE, SAUDA_DATE
OPEN @ADJCUR
FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
WHILE @@FETCH_STATUS = 0
BEGIN 

	SET @DELCUR = CURSOR FOR
		SELECT SNO, MKTAMT, MARGIN_REQ = (CASE WHEN @PROPOR_ALLOC_FLAG = 1 THEN (MARGIN_REQ/100*@PRO_PER) ELSE MARGIN_REQ END)
		FROM #TBL_MTF_DATA_BUY
		WHERE SAUDA_DATE = @SAUDA_DATE_PAYIN 
		AND PARTY_CODE = @PARTYCODE
		AND MKTAMT > 0 AND MARGIN_REQ > 0
		ORDER BY PARTY_CODE, SCRIP_CD, SERIES
	OPEN @DELCUR
	FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		IF @PAYIN_AMT > 0 --AND @@FETCH_STATUS = 0
		BEGIN
			IF @PROPOR_ALLOC_FLAG = 1 
			BEGIN
				SET		@MAMT = 0
				
				--IF @PARTYCODE ='HYDSBV101'
				--BEGIN
				--	SELECT @MARGIN_REQ
				--	SELECT M_PRICE = ROUND((MKTAMT/QTY),4), M_QTY = FLOOR((@MARGIN_REQ/ROUND((MKTAMT/QTY),4)))
				--	FROM  #TBL_MTF_DATA_BUY
				--	WHERE SNO = @SNO
				--END

				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

			END
			ELSE
			BEGIN			

				IF @PAYIN_AMT >= @MARGIN_REQ 
				--IF PRADNYA.DBO.FNMIN(@PAYIN_AMT,@MARGIN_REQ)
				BEGIN
				
					SET		@MAMT = 0
				
					UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
					WHERE	SNO = @SNO

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
							@MAMT = (M_PRICE*M_QTY)
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		NF_QTY = (QTY-M_QTY),
							NF_AMT = M_PRICE*(QTY-M_QTY)
					WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

					SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT

					--SELECT	SRNO = @SNO, PAYIN_AMT=@PAYIN_AMT, M_AMT = @MAMT, PAYIN_BALANCE = (@PAYIN_AMT - @MAMT)
					--SET @PAYIN_AMT = @PAYIN_AMT - @MARGIN_REQ

				END
				ELSE
				BEGIN

					UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @PAYIN_AMT
					WHERE	SNO = @SNO

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
							@MAMT = (M_PRICE*M_QTY)
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		NF_QTY = (QTY-M_QTY),
							NF_AMT = M_PRICE*(QTY-M_QTY)
					WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0
				
					SET @PAYIN_AMT = 0

				END
			END
		END

		FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ 
	END
	
	CLOSE @DELCUR
	DEALLOCATE @DELCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
END
CLOSE @ADJCUR
DEALLOCATE @ADJCUR

--SELECT	'#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE ='AHMAJ125' AND SCRIP_CD='TRITURBINE'

--SELECT MAX(SAUDA_DATE),SCRIP_CD,QTY=SUM(QTY) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
--						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = 'AM0753'
--						AND T.SCRIP_CD = 'GOODLUCK'
--GROUP BY SCRIP_CD

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE <= @SAUDA_DATE + ' 23:59' AND PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'
--SELECT	'#TBL_MTF_DATA_BUY-2',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'


UPDATE	#TBL_MTF_DATA_BUY
SET		QTY = #TBL_MTF_DATA_BUY.QTY + ISNULL(T.QTY,#TBL_MTF_DATA_BUY.QTY),
		MKTAMT = #TBL_MTF_DATA_BUY.MKTAMT + ISNULL(T.MKTAMT,#TBL_MTF_DATA_BUY.MKTAMT),
		NETAMT = #TBL_MTF_DATA_BUY.NETAMT + ISNULL(T.NETAMT,#TBL_MTF_DATA_BUY.NETAMT),
		M_QTY = #TBL_MTF_DATA_BUY.M_QTY + ISNULL(T.M_QTY,#TBL_MTF_DATA_BUY.M_QTY),
		M_AMT = #TBL_MTF_DATA_BUY.M_AMT + ISNULL(T.M_AMT,#TBL_MTF_DATA_BUY.M_AMT),
		NF_QTY = #TBL_MTF_DATA_BUY.NF_QTY + ISNULL(T.NF_QTY,#TBL_MTF_DATA_BUY.NF_QTY),
		NF_AMT = #TBL_MTF_DATA_BUY.NF_AMT + ISNULL(T.NF_AMT,#TBL_MTF_DATA_BUY.NF_AMT)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND NOT EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
					AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
					AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)

--UPDATE	#TBL_MTF_DATA_BUY 
--SET		NF_QTY = (QTY-M_QTY),
--		NF_AMT = M_PRICE*(QTY-M_QTY)
--WHERE	M_QTY > 0


DELETE	FROM TBL_MTF_DATA_BUY_TDAY_ALLOC
WHERE	SAUDA_DATE = @SAUDA_DATE
		--AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND SELL_BUY = 1

--SELECT	'#TBL_MTF_DATA_BUY-22222',(CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END),* FROM #TBL_MTF_DATA_BUY 
--WHERE	PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

--SELECT COUNT(1) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE = @SAUDA_DATE

INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
		M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE, NF_QTY,NF_AMT,SELL_BUY,
		COLL_QTY = (CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END),
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#TBL_MTF_DATA_BUY 
WHERE	(CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END) > 0

--SELECT COUNT(1) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE = @SAUDA_DATE

--SELECT	'#TBL_MTF_DATA_BUY-3',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'

--RETURN

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC 
--WHERE	SAUDA_DATE = @SAUDA_DATE
--		AND PAYIN_DATE = @EDT
--		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY

--SELECT * FROM #DATA WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = 0,      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(M_QTY), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_QTY ELSE 0 END),
M_FRESHBUY = SUM(M_AMT), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_AMT ELSE 0 END),
M_FRESHSQTY = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_QTY ELSE 0 END),
M_FRESHSELL = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_AMT ELSE 0 END),
M_NETQTY = SUM(NF_QTY),
M_NETAMOUNT = SUM(NF_AMT),
EXCHANGE = P.EXCHANGE,--= 'TRNSE', --TRANSTYPE
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO
,BSECODE
FROM #TBL_MTF_DATA_BUY P (NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER (NOLOCK)      
WHERE 1 = 1 --SAUDA_DATE = @PREV_SAUDA_DATE       
--AND ADJUST_DATE = @SAUDA_DATE      
--AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, ISNULL(P.ISIN,''),P.EXCHANGE,BSECODE --,SETT_NO --, TRANSTYPE      
--HAVING SUM(NF_QTY) > 0 AND SUM(NF_AMT) > 0 


INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,4),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,4),0),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(ISNULL(M_FRESHBQTY,0)),
M_FRESHBUY = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_FRESHBUY,0))),
M_FRESHSQTY = SUM(ISNULL(M_FRESHSQTY,0)),
M_FRESHSELL = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_FRESHSELL,0))),
M_NETQTY = SUM(ISNULL(M_NETQTY,0)),
M_NETAMOUNT = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))),
EXCHANGE = ISNULL(EXCHANGE,'TRNSE'),
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO =''
,BSECODE
FROM #MTR_RTP P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, EXCHANGE, ISNULL(P.ISIN,''),BSECODE
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 

--SELECT '#MTR_RTP',* FROM #MTR_RTP WHERE PARTY_CODE IN ('MCV0087') AND SCRIP_CD='TATAMOTORS' ORDER BY PARTY_CODE, SCRIP_CD, SERIES
--SELECT '#DATA',* FROM #DATA WHERE PARTY_CODE IN ('MCV0087') AND SCRIP_CD='TATAMOTORS' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.MULTIISIN M(NOLOCK)
WHERE	M.SCRIP_CD = #DATA.SCRIP_CD
		AND M.SERIES = #DATA.SERIES
		AND M.VALID = 1
		AND ISNULL(#DATA.ISIN,'') = ''

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M(NOLOCK)
WHERE	M.NSE_SCRIP_CD = #DATA.SCRIP_CD
		AND M.NSE_SERIES = #DATA.SERIES
		AND @PREVDATE BETWEEN FROM_DATE AND TO_DATE
		AND ISNULL(#DATA.ISIN,'') = ''


UPDATE	#DATA
SET		BSECODE = ISNULL(M.SCRIP_CD,'')
FROM	BSEDB.DBO.MULTIISIN M(NOLOCK)
WHERE	M.ISIN = #DATA.ISIN
		AND M.VALID = 1
		AND ISNULL(#DATA.BSECODE,'') = ''

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

ALTER	TABLE #DATA
ADD		CORP_BEFORE_QTY NUMERIC(18,4),
		CORP_AFTER_QTY	NUMERIC(18,4)

UPDATE	#DATA
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')
		AND #DATA.M_FRESHBQTY > 0

UPDATE	#DATA
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND #DATA.CORP_AFTER_QTY <> 0
		AND #DATA.M_FRESHBQTY > 0

UPDATE	#DATA
SET		M_FRESHBQTY = M_FRESHBQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		M_NETQTY = M_NETQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)
		AND M_FRESHBQTY > 0
		AND BODQTY > 0

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT	'#DATA',* FROM #DATA WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'

SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES, PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
M_BODQTY = SUM(M_BODQTY),
M_BODVALUE = SUM(M_BODVALUE),
M_FRESHBQTY = SUM(M_FRESHBQTY),
M_FRESHBUY = SUM(M_FRESHBUY),
M_FRESHSQTY = SUM(M_FRESHSQTY),
M_FRESHSELL = SUM(M_FRESHSELL),
M_NETQTY = SUM(M_NETQTY),--SUM(M_BODQTY) + SUM(M_FRESHBQTY) - SUM(M_FRESHSQTY),
M_NETAMOUNT = SUM(M_NETAMOUNT), --SUM(M_BODVALUE + M_FRESHBUY - M_FRESHSELL),
EXCHANGE,
ISIN,
--M_PRICE = (CASE WHEN SUM(ISNULL(M_NETQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))/SUM(ISNULL(M_NETQTY,0))) ELSE 0 END)--,
M_PRICE = (CASE WHEN SUM(ISNULL(M_FRESHBQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),SUM(M_FRESHBUY)/SUM(M_FRESHBQTY)) ELSE 0 END)
--SETT_NO
,BSECODE,
CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO #DATAFINAL      
FROM #DATA  
--WHERE FRESHSQTY > 0
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, SERIES, PARTY_CODE, EXCHANGE, ISIN, BSECODE --, SETT_NO  

ALTER TABLE #DATAFINAL
ADD	SRNO INT IDENTITY(1,1)

UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

UPDATE #DATAFINAL SET M_NETAMOUNT = 0
WHERE M_NETQTY = 0

--SELECT '#DATAFINAL',((NETQTY)-(M_FRESHBQTY+M_NETQTY)),* FROM #DATAFINAL WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT '#DATAFINAL',((NETQTY)-(M_FRESHBQTY+M_NETQTY)),* FROM #DATAFINAL WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT	'#DATAFINAL',* FROM #DATAFINAL WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'


SELECT	SAUDA_DATE = @SAUDA_DATE,
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		BSECODE,
		ISIN,
		BODQTY,
		BODVALUE,
		QTY = BODQTY+FRESHBQTY-FRESHSQTY,--FRESHSQTY, --(BODQTY),--SUM(FRESHSQTY),
		FRESHBQTY,
		FRESHSQTY,
		MKTAMT = (FRESHSELL),
		NETAMT = (FRESHSELL),
		SETT_NO = '',
		PAYIN_DATE = CONVERT(DATETIME,''),
		EXCHANGE,
		PAYIN_AMT=0,
		PAYIN_AMT_BAL=0,
		CLOSE_QTY = ABS((NETQTY)-(M_FRESHBQTY+M_NETQTY)),
		CLOSE_PRICE = CONVERT(NUMERIC(18,4),0),
		CLOSE_AMT = CONVERT(NUMERIC(18,4),0),
		CLOSE_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY=0,
		NF_AMT=0,
		SELL_BUY = (CASE WHEN ((NETQTY)-((M_FRESHBQTY+M_NETQTY))) < 0 THEN 2 ELSE 1 END),
		M_FRESHBQTY = (M_FRESHBQTY),
		M_FRESHBUY,
		M_NETQTY = (M_NETQTY),
		M_PRICE,
		M_NETQTY_NEW = 0,
		M_FRESHBQTY_NEW = 0,
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0),
		NETAMOUNT,
		NETQTY,
		FRESHSELL,
		M_NETAMOUNT
INTO	#CLOSEPOS
FROM	#DATAFINAL P (NOLOCK)
WHERE	FRESHSQTY > 0
--WHERE	((NETQTY)-(M_FRESHBQTY+M_NETQTY)) < 0

/*
GROUP BY
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		BSECODE,
		ISIN,
		--SETT_NO,
		--PAYIN_DATE,
		EXCHANGE
HAVING	ABS(SUM(NETQTY)-SUM(M_FRESHBQTY+M_NETQTY)) < 0
*/
--SELECT * FROM #DATAFINAL WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'
--SELECT	'#CLOSEPOS-0',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'
--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE = 'JUL  9 2025' AND PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'

--SELECT * FROM #CLOSEPOS WHERE PARTY_CODE='AHMAJ125' AND SCRIP_CD='TRITURBINE'

UPDATE	#CLOSEPOS
SET		QTY = ABS(#CLOSEPOS.BODQTY + #CLOSEPOS.FRESHBQTY - ISNULL(#CLOSEPOS.FRESHSQTY,0)),
		MKTAMT = ABS(#CLOSEPOS.BODVALUE - ISNULL(#CLOSEPOS.MKTAMT,0)),
		NETAMT = ABS(#CLOSEPOS.BODVALUE - ISNULL(#CLOSEPOS.NETAMT,0)),
		CLOSE_QTY = ABS(#CLOSEPOS.M_FRESHBQTY - ISNULL(T.M_QTY,0)), -- - ISNULL(#CLOSEPOS.CLOSE_QTY,0),
		CLOSE_AMT = ABS(#CLOSEPOS.M_FRESHBUY - ISNULL(T.M_AMT,0)), --- ISNULL(#CLOSEPOS.CLOSE_AMT,0)
		M_FRESHBQTY = ABS(ISNULL(T.M_QTY,0) - #CLOSEPOS.M_FRESHBQTY),
		M_FRESHBUY = ABS(ISNULL(T.M_AMT,0) - #CLOSEPOS.M_FRESHBUY),		
		M_NETQTY = ABS(ISNULL(T.NF_QTY,0) - #CLOSEPOS.M_NETQTY),
		M_NETAMOUNT = ABS(ISNULL(T.NF_AMT,0) - #CLOSEPOS.M_NETAMOUNT)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	--T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE < @SAUDA_DATE )
		T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T1(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T1.PARTY_CODE = T.PARTY_CODE
						AND T1.ISIN = T.ISIN
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		--AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND T.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND T.ISIN = #CLOSEPOS.ISIN
		AND NOT EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #CLOSEPOS.PARTY_CODE
					AND P.SCRIP_CD = #CLOSEPOS.SCRIP_CD
					AND P.ISIN = #CLOSEPOS.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)

--SELECT	'#CLOSEPOS-1',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

UPDATE	#CLOSEPOS 
SET		M_PRICE = ROUND(M_FRESHBUY/M_FRESHBQTY,4)


UPDATE	#CLOSEPOS 
SET		PAYIN_DATE = ISNULL(LEFT(SM.FUNDS_PAYIN,11),'')
FROM	MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	SM.START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
		AND SM.SETT_TYPE = 'N'

--SELECT 'AFTER-ALLOC',* FROM #CLOSEPOS WHERE PARTY_CODE='AHMAJ125' AND SCRIP_CD='TRITURBINE'


IF @PROPOR_ALLOC_FLAG = 1
BEGIN
	/*
	DECLARE @NONFNO		INT,
			@FNO		INT

	SELECT	@NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER(NOLOCK)
	WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V(NOLOCK), 
	MSAJAG.DBO.VARCONTROL C(NOLOCK)
	WHERE C.RECDATE >= @SAUDA_DATE aND c.REcDATE <= @SAUDA_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES NOT IN ('BO')
	AND ISIN IN (SELECT DISTINCT ISIN FROM #CLOSEPOS)

	SELECT V.* INTO  #BSE_VAR FROM BSEDB.DBO.VARDETAIL V(NOLOCK)
	WHERE V.FDATE >= @SAUDA_DATE aND v.FDATE <= @SAUDA_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #CLOSEPOS)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )
	*/

	ALTER	TABLE #CLOSEPOS
	ADD		MARGIN_REQ	NUMERIC(18,4),
			HAIRCUT		NUMERIC(18,4),
			PRO_M_QTY	INT,
			PRO_PRICE	NUMERIC(18,4),
			BAL_NET_QTY	INT,
			PRO_ALLOC_PER	NUMERIC(18,4)

	UPDATE	#CLOSEPOS 
	SET		MARGIN_REQ	= 0,
			HAIRCUT		= 0,
			PRO_M_QTY	= 0,
			PRO_PRICE	= 0,
			BAL_NET_QTY = 0,
			PRO_ALLOC_PER = 0


	UPDATE	#CLOSEPOS
	SET		PRO_ALLOC_PER = ROUND(M_FRESHBUY/(M_FRESHBUY+M_NETAMOUNT)*100,2)
	WHERE	M_FRESHBUY > 0 AND (M_FRESHBUY+M_NETAMOUNT) > 0

	UPDATE	#CLOSEPOS
	SET		MARGIN_REQ = ((FRESHSQTY*M_PRICE)/100*PRO_ALLOC_PER),
			PRO_PRICE = ROUND(M_PRICE,4)
	WHERE	FRESHSELL > 0 AND PRO_ALLOC_PER > 0

	UPDATE	#CLOSEPOS
	SET		PRO_M_QTY = FLOOR((MARGIN_REQ/PRO_PRICE)) 
	WHERE	PRO_PRICE > 0 AND MARGIN_REQ > 0

	UPDATE	#CLOSEPOS
	SET		BAL_NET_QTY = (FRESHSQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND FRESHSQTY > 0

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY = (M_FRESHBQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND M_FRESHBQTY > 0

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN (M_FRESHBQTY - PRO_M_QTY) >= 0 THEN (M_FRESHBQTY - PRO_M_QTY) 
				ELSE M_FRESHBQTY 
			END)

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = M_NETQTY - BAL_NET_QTY
	WHERE	(M_NETQTY - BAL_NET_QTY) >= 0

	
	UPDATE	#CLOSEPOS 
	SET		CLOSE_QTY = M_FRESHBQTY_NEW
	WHERE	M_FRESHBQTY_NEW >= 0		

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN M_NETQTY_NEW >= 0 THEN M_NETQTY_NEW ELSE M_NETQTY END),
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW >= 0 THEN M_FRESHBQTY_NEW ELSE M_FRESHBQTY END)

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = M_NETQTY_NEW,
			NF_AMT = M_PRICE*M_NETQTY_NEW,
			CLOSE_PRICE = M_PRICE
	WHERE	M_NETQTY_NEW > 0

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = 0,
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW + NF_QTY > 0 THEN M_FRESHBQTY_NEW + NF_QTY ELSE 0 END)
	WHERE	NF_QTY < 0

	UPDATE	#CLOSEPOS SET SELL_BUY = 2 WHERE CLOSE_QTY < 0 
	
END
ELSE
BEGIN
	
	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN (M_NETQTY - CLOSE_QTY) <= 0 THEN 0 ELSE (M_NETQTY - CLOSE_QTY) END)

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN M_NETQTY_NEW = 0 THEN 
				CASE WHEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) > 0 THEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) ELSE 0 END 
				ELSE M_FRESHBQTY 
			END)

	UPDATE	#CLOSEPOS 
	SET		CLOSE_QTY = M_FRESHBQTY_NEW
	WHERE	M_FRESHBQTY_NEW > 0		

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN M_NETQTY_NEW > 0 THEN M_NETQTY_NEW ELSE M_NETQTY END),
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW > 0 THEN M_FRESHBQTY_NEW ELSE M_FRESHBQTY END)

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = (QTY-CLOSE_QTY),
				NF_AMT = (CLOSE_AMT/CLOSE_QTY)*(QTY-CLOSE_QTY),
			CLOSE_PRICE = (CLOSE_AMT/CLOSE_QTY)
	WHERE	CLOSE_QTY > 0

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = 0,
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW + NF_QTY > 0 THEN M_FRESHBQTY_NEW + NF_QTY ELSE 0 END)
	WHERE	NF_QTY < 0

	UPDATE	#CLOSEPOS SET SELL_BUY = 2 WHERE CLOSE_QTY < 0 

END

--SELECT	'#DATAFINAL-3',* FROM #DATAFINAL WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT	'#CLOSEPOS-2',* FROM #CLOSEPOS WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'

--SELECT	'#DATAFINAL-3',* FROM #DATAFINAL WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 
--SELECT	'#CLOSEPOS-3',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

------------------------------------------------------------------------------

DECLARE	@PAYINDATE	VARCHAR(11)
SELECT	@PAYINDATE = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'

--SELECT '#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT * FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 


/** --- CARRY FORWORD POSITION ---*/

SELECT	SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,SCRIP_CD,T.SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,T.SETT_NO,PAYIN_DATE=@PAYINDATE,T.EXCHANGE,PAYIN_AMT,
		PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE,NF_QTY,NF_AMT,SELL_BUY,COLL_QTY,PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM',
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TDAY_ALLOC_CA
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE 
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND T.SELL_BUY = 1
		AND NOT EXISTS (SELECT PARTY_CODE FROM #TBL_MTF_DATA_BUY 
						WHERE T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN 
						AND (CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END) > 0
						)
		AND NOT EXISTS (SELECT PARTY_CODE FROM #CLOSEPOS 
						WHERE T.PARTY_CODE = #CLOSEPOS.PARTY_CODE
						AND T.SCRIP_CD = #CLOSEPOS.SCRIP_CD
						AND T.ISIN = #CLOSEPOS.ISIN
						)

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT '#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT	'#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'
--SELECT	'#CLOSEPOS-4',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

UPDATE	#TDAY_ALLOC_CA
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TDAY_ALLOC_CA.PARTY_CODE
		AND P.SCRIP_CD = #TDAY_ALLOC_CA.SCRIP_CD
		AND P.ISIN = #TDAY_ALLOC_CA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

UPDATE	#TDAY_ALLOC_CA
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TDAY_ALLOC_CA.PARTY_CODE
		AND P.SCRIP_CD = #TDAY_ALLOC_CA.SCRIP_CD
		AND P.ISIN = #TDAY_ALLOC_CA.ISIN
		AND #TDAY_ALLOC_CA.CORP_AFTER_QTY <> 0

UPDATE	#TDAY_ALLOC_CA
SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		COLL_QTY = COLL_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 --- **/

--SELECT '#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT * FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 

INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,
		PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE,NF_QTY,NF_AMT,SELL_BUY,COLL_QTY,PROCESS_ON, PROCESS_BY
FROM	#TDAY_ALLOC_CA


DELETE	FROM TBL_MTF_DATA_BUY_TDAY_ALLOC
WHERE	SAUDA_DATE = @SAUDA_DATE
		--AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND SELL_BUY = 2


INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
		M_QTY = M_FRESHBQTY_NEW,
		M_PRICE = CLOSE_PRICE,
		M_AMT = M_FRESHBQTY_NEW*CLOSE_PRICE,
		M_ALLOC_BALANCE = (QTY-CLOSE_QTY)*CLOSE_PRICE,
		NF_QTY,NF_AMT,SELL_BUY,
		--COLL_QTY = (CASE WHEN NF_QTY < 0 THEN CLOSE_QTY+NF_QTY ELSE CLOSE_QTY END),
		COLL_QTY = M_FRESHBQTY_NEW,
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#CLOSEPOS 
WHERE	M_FRESHBQTY_NEW >= 0


--SELECT	'#CLOSEPOS-BEFORE',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'
--SELECT	'TDAY_ALLOC-BEFORE',* FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

/*-- FOR BTST CASE COLL QTY WILL BE DEDUCTED ---*/

UPDATE	TBL_MTF_DATA_BUY_TDAY_ALLOC
SET		COLL_QTY = COLL_QTY - M_FRESHBQTY_NEW
FROM	#CLOSEPOS
WHERE	TBL_MTF_DATA_BUY_TDAY_ALLOC.PAYIN_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.ISIN = #CLOSEPOS.ISIN
		AND M_FRESHBQTY_NEW > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SELL_BUY = 1
		AND #CLOSEPOS.NF_QTY = 0


UPDATE	TBL_MTF_DATA_BUY_TDAY_ALLOC
SET		COLL_QTY = 0 --COLL_QTY - ABS(CLOSE_QTY)
FROM	#CLOSEPOS
WHERE	TBL_MTF_DATA_BUY_TDAY_ALLOC.PAYIN_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.ISIN = #CLOSEPOS.ISIN
		AND ABS(CLOSE_QTY) > 0
		AND #CLOSEPOS.QTY = 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SELL_BUY = 1
		AND #CLOSEPOS.NF_QTY = 0


UPDATE	TBL_PRODUCT_HOLD_DATA
SET		QTY = TBL_PRODUCT_HOLD_DATA.QTY - M_FRESHBQTY_NEW
FROM	#CLOSEPOS
WHERE	TBL_PRODUCT_HOLD_DATA.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_PRODUCT_HOLD_DATA.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_PRODUCT_HOLD_DATA.ISIN = #CLOSEPOS.ISIN
		AND M_FRESHBQTY_NEW > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_PRODUCT_HOLD_DATA.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0


UPDATE	TBL_PRODUCT_HOLD_DATA
SET		QTY = 0 --TBL_PRODUCT_HOLD_DATA.QTY - ABS(CLOSE_QTY)
FROM	#CLOSEPOS
WHERE	TBL_PRODUCT_HOLD_DATA.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_PRODUCT_HOLD_DATA.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_PRODUCT_HOLD_DATA.ISIN = #CLOSEPOS.ISIN
		AND ABS(CLOSE_QTY) > 0
		AND #CLOSEPOS.QTY = 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_PRODUCT_HOLD_DATA.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0

--UPDATE	TBL_PRODUCT_HOLD_DATA
--SET		QTY = TBL_PRODUCT_HOLD_DATA.QTY - CLOSE_QTY
--FROM	#CLOSEPOS
--WHERE	TBL_PRODUCT_HOLD_DATA.SAUDA_DATE BETWEEN @PREVDATE AND @PREVDATE + ' 23:59'
--		AND TBL_PRODUCT_HOLD_DATA.PARTY_CODE = #CLOSEPOS.PARTY_CODE
--		AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = #CLOSEPOS.SCRIP_CD
--		AND TBL_PRODUCT_HOLD_DATA.ISIN = #CLOSEPOS.ISIN
--		AND CLOSE_QTY > 0
--		AND #CLOSEPOS.SELL_BUY = 2
--		AND TBL_PRODUCT_HOLD_DATA.QTY > 0

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT * FROM TBL_PRODUCT_HOLD_DATA WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT * FROM TBL_MTF_MARKING WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT * FROM #CLOSEPOS WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'

UPDATE	TBL_MTF_MARKING
SET		QTY = TBL_MTF_MARKING.QTY - M_FRESHBQTY_NEW
FROM	#CLOSEPOS
WHERE	TBL_MTF_MARKING.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_MARKING.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_MARKING.ISIN = #CLOSEPOS.ISIN
		AND M_FRESHBQTY_NEW > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_MARKING.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0

UPDATE	TBL_MTF_MARKING
SET		QTY = 0 --TBL_MTF_MARKING.QTY - ABS(CLOSE_QTY)
FROM	#CLOSEPOS
WHERE	TBL_MTF_MARKING.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_MARKING.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_MARKING.ISIN = #CLOSEPOS.ISIN
		AND ABS(CLOSE_QTY) > 0
		AND #CLOSEPOS.QTY = 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_MARKING.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0

/*-- FOR BTST CASE COLL QTY WILL BE DEDUCTED ---*/

DROP TABLE #TBL_MTF_DATA_BUY
DROP TABLE #CLOSEPOS
DROP TABLE #TDAY_ALLOC_CA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_TDAY_ALLOC_26SEP2025
-- --------------------------------------------------






/*
BEGIN TRAN
--EXEC PROC_PRODUCT_TDAY_ALLOC 'JAN 31 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  1 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  3 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  4 2025','','ZZZZZZZ'
EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  5 2025','','ZZZZZZZ'
EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  6 2025','','ZZZZZZZ'

SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC(NOLOCK) WHERE PARTY_CODE='AM0753' AND SCRIP_CD='GOODLUCK'
ROLLBACK
*/


CREATE	PROC [dbo].[PROC_PRODUCT_TDAY_ALLOC]
		(
		@SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20) = '',
		@TOPARTY	VARCHAR(20) = 'ZZZZZZ'
		)

		AS

DECLARE @SDTCUR		DATETIME,
		@LDTCUR		DATETIME,
		@EDT		VARCHAR(11),
		@PREVDATE	VARCHAR(11),
		@PROPOR_ALLOC_FLAG	INT

SET		@PROPOR_ALLOC_FLAG = 1

/*
DECLARE @SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)

SET		@SAUDA_DATE = 'JAN 31 2025'
SET		@FROMPARTY	= 'AF7259'
SET		@TOPARTY	= 'AF7259'
---IN('AA8143','AA8559')		'AF7259'
*/

SELECT	@EDT = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'

SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR      


SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017')        
FROM VW_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE

SELECT * INTO #MTR_RTP FROM TBL_MTR_REPORTING WHERE 1=2

ALTER TABLE #MTR_RTP
ALTER COLUMN BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN NETAMOUNT NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_NETAMOUNT NUMERIC(18,4)

IF (SELECT COUNT(1) FROM TBL_MTR_REPORTING WHERE SAUDA_DATE = @PREVDATE) > 0
BEGIN
	
	INSERT	INTO #MTR_RTP
	SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,
			M_BODQTY,M_BODVALUE,M_FRESHBQTY,M_FRESHBUY,M_FRESHSQTY,M_FRESHSELL,M_NETQTY,M_NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @PREVDATE

END
ELSE
BEGIN

	INSERT	INTO #MTR_RTP (SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE)
	SELECT	SAUDA_DATE=@PREVDATE,PARTY_CODE,SCRIP_CD,SERIES,
			BODQTY = SUM(QTY),      
			BODVALUE = SUM(MKTAMT),
			FRESHBQTY = 0,            
			FRESHBUY = 0,            
			FRESHSQTY = 0,      
			FRESHSELL = 0, 
			NETQTY = SUM(QTY),
			NETAMOUNT = SUM(MKTAMT),
			TRANSTYPE,
			SAUDA_DATE=@PREVDATE,
			ISIN,BSECODE
	FROM	VW_PRODUCT_POSITION
	WHERE	SAUDA_DATE <= @PREVDATE       
			AND ADJUST_DATE > @PREVDATE      
			AND SELL_BUY = 1
	GROUP BY
			PARTY_CODE,SCRIP_CD,SERIES,
			TRANSTYPE,ISIN,BSECODE
	HAVING	SUM(QTY) > 0 AND SUM(MKTAMT) > 0
END


SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE = CONVERT(NUMERIC(18,4),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,4),SUM(MKTAMT) ),      
FRESHSQTY = 0,
FRESHSELL = CONVERT(NUMERIC(18,4),0),
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
INTO #DATA      
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 


INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,4),SUM(MKTAMT)),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 

---------------------------------------------------------------------------------------------------------------------------------------------

SELECT	*,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		M_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0),
		SELL_BUY = CONVERT(INT,1),
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TBL_MTF_DATA_BUY 
FROM	TBL_MTF_DATA_BUY(NOLOCK) 
WHERE	SAUDA_DATE = @SAUDA_DATE
		AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY


INSERT	INTO #TBL_MTF_DATA_BUY
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,CL_RATE,CURR_CL_RATE,HAIRCUT,
		MARGIN_REQ,MTOM_LOSS,FOMARGIN,CMLEDBAL,MTFLEDBAL,FOLEDBAL,CMCASHEQCOLLATERAL,CMCASHCOLLATERAL,CMNONCASHCOLLATERAL,
		CMNONCASHCOLLATERAL_MTF,CMDEBITHOLD,CMDEBITHOLD_MTF,CMOPENPOS,MTFCASHEQCOLLATERAL,MTFCASHCOLLATERAL,MTFNONCASHCOLLATERAL,
		FOCASHEQCOLLATERAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_MTF,NET_AVL_FUND,POAHOLDING,POAHOLDING_MTF,SELLSHORT,
		CASHDEBITADJ,CASHNONCASHADJ,FONONCASHADJ,CASHLEDADJ,FOLEDBALADJ,POAADJ,ORG_HAIRCUT,ORG_MARGIN_REQ,SETT_NO,PAYIN_DATE,EXCHANGE,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		M_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0),
		SELL_BUY = CONVERT(INT,1),
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
FROM	TBL_MTF_DATA_BUY T(NOLOCK) 
WHERE	SAUDA_DATE = @SAUDA_DATE
		AND SAUDA_DATE = PAYIN_DATE
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = T.PARTY_CODE
					AND P.SCRIP_CD = T.SCRIP_CD
					AND P.ISIN = T.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)
		AND 1 = 2


UPDATE	#TBL_MTF_DATA_BUY 
SET		PAYIN_AMT = ISNULL(D.VAMT,0)
FROM	(
		SELECT	CLTCODE,
				VAMT = SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),
				VDT
		FROM	LEDGER P(NOLOCK)
		WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
				AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
				AND P.VTYP = '66'
				AND P.EDT BETWEEN @EDT AND @EDT + ' 23:59:59'
				--AND P.CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN P.CLTCODE ELSE @PARTY_CODE END)
				AND P.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
				AND P.NARRATION LIKE '%MTF PAYIN'
		GROUP BY
				CLTCODE,
				VDT
		HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0
		) D
WHERE	D.CLTCODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND D.VDT = #TBL_MTF_DATA_BUY.SAUDA_DATE



/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = ISNULL(T.M_QTY,0),
		NF_QTY = ISNULL(T.NF_QTY,0)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
					AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
					AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)

UPDATE	#TBL_MTF_DATA_BUY
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

UPDATE	#TBL_MTF_DATA_BUY
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND #TBL_MTF_DATA_BUY.CORP_AFTER_QTY <> 0

UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT	'#TBL_MTF_DATA_BUY-1',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE ='AHMAJ125' AND SCRIP_CD='TRITURBINE'

---------------------------------------------------------------------------------------------------------------------------------------------

DECLARE @ADJCUR		CURSOR, 
		@DELCUR		CURSOR, 
		@PARTYCODE	VARCHAR(20),
		@PAYIN_AMT	NUMERIC(18,4),
		@MKTAMT		NUMERIC(18,4),
		@MARGIN_REQ	NUMERIC(18,4),
		@SNO		INT,
		@MAMT		NUMERIC(18,4),
		@SAUDA_DATE_PAYIN	DATETIME,
		@PRO_PER	NUMERIC(18,2)


--	SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
--			PRO_PER =  (
--			CASE 
--				WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
--				ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
--			END)
--	FROM #TBL_MTF_DATA_BUY
--	WHERE PAYIN_AMT > 0 AND PARTY_CODE='HYDSBV101'
--	GROUP BY PARTY_CODE, SAUDA_DATE
--	ORDER BY PARTY_CODE, SAUDA_DATE


--SELECT SNO, MKTAMT, MARGIN_REQ = (CASE WHEN @PROPOR_ALLOC_FLAG = 1 THEN (MARGIN_REQ/@PRO_PER*100) ELSE MARGIN_REQ END)
--		FROM #TBL_MTF_DATA_BUY
--		WHERE 1=1
--		AND PARTY_CODE = 'HYDSBV101'
--		AND MKTAMT > 0 AND MARGIN_REQ > 0
--		ORDER BY PARTY_CODE, SCRIP_CD, SERIES


SET @ADJCUR = CURSOR FOR
	SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
			PRO_PER =  (
			CASE 
				WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
				ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
			END)
	FROM #TBL_MTF_DATA_BUY
	WHERE PAYIN_AMT > 0
	GROUP BY PARTY_CODE, SAUDA_DATE
	ORDER BY PARTY_CODE, SAUDA_DATE
OPEN @ADJCUR
FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
WHILE @@FETCH_STATUS = 0
BEGIN 

	SET @DELCUR = CURSOR FOR
		SELECT SNO, MKTAMT, MARGIN_REQ = (CASE WHEN @PROPOR_ALLOC_FLAG = 1 THEN (MARGIN_REQ/100*@PRO_PER) ELSE MARGIN_REQ END)
		FROM #TBL_MTF_DATA_BUY
		WHERE SAUDA_DATE = @SAUDA_DATE_PAYIN 
		AND PARTY_CODE = @PARTYCODE
		AND MKTAMT > 0 AND MARGIN_REQ > 0
		ORDER BY PARTY_CODE, SCRIP_CD, SERIES
	OPEN @DELCUR
	FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		IF @PAYIN_AMT > 0 --AND @@FETCH_STATUS = 0
		BEGIN
			IF @PROPOR_ALLOC_FLAG = 1 
			BEGIN
				SET		@MAMT = 0
				
				--IF @PARTYCODE ='HYDSBV101'
				--BEGIN
				--	SELECT @MARGIN_REQ
				--	SELECT M_PRICE = ROUND((MKTAMT/QTY),4), M_QTY = FLOOR((@MARGIN_REQ/ROUND((MKTAMT/QTY),4)))
				--	FROM  #TBL_MTF_DATA_BUY
				--	WHERE SNO = @SNO
				--END

				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

			END
			ELSE
			BEGIN			

				IF @PAYIN_AMT >= @MARGIN_REQ 
				--IF PRADNYA.DBO.FNMIN(@PAYIN_AMT,@MARGIN_REQ)
				BEGIN
				
					SET		@MAMT = 0
				
					UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
					WHERE	SNO = @SNO

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
							@MAMT = (M_PRICE*M_QTY)
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		NF_QTY = (QTY-M_QTY),
							NF_AMT = M_PRICE*(QTY-M_QTY)
					WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

					SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT

					--SELECT	SRNO = @SNO, PAYIN_AMT=@PAYIN_AMT, M_AMT = @MAMT, PAYIN_BALANCE = (@PAYIN_AMT - @MAMT)
					--SET @PAYIN_AMT = @PAYIN_AMT - @MARGIN_REQ

				END
				ELSE
				BEGIN

					UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @PAYIN_AMT
					WHERE	SNO = @SNO

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
							@MAMT = (M_PRICE*M_QTY)
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		NF_QTY = (QTY-M_QTY),
							NF_AMT = M_PRICE*(QTY-M_QTY)
					WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0
				
					SET @PAYIN_AMT = 0

				END
			END
		END

		FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ 
	END
	
	CLOSE @DELCUR
	DEALLOCATE @DELCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
END
CLOSE @ADJCUR
DEALLOCATE @ADJCUR

--SELECT	'#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE ='AHMAJ125' AND SCRIP_CD='TRITURBINE'

--SELECT MAX(SAUDA_DATE),SCRIP_CD,QTY=SUM(QTY) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
--						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = 'AM0753'
--						AND T.SCRIP_CD = 'GOODLUCK'
--GROUP BY SCRIP_CD

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE <= @SAUDA_DATE + ' 23:59' AND PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'
--SELECT	'#TBL_MTF_DATA_BUY-2',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'


UPDATE	#TBL_MTF_DATA_BUY
SET		QTY = #TBL_MTF_DATA_BUY.QTY + ISNULL(T.QTY,#TBL_MTF_DATA_BUY.QTY),
		MKTAMT = #TBL_MTF_DATA_BUY.MKTAMT + ISNULL(T.MKTAMT,#TBL_MTF_DATA_BUY.MKTAMT),
		NETAMT = #TBL_MTF_DATA_BUY.NETAMT + ISNULL(T.NETAMT,#TBL_MTF_DATA_BUY.NETAMT),
		M_QTY = #TBL_MTF_DATA_BUY.M_QTY + ISNULL(T.M_QTY,#TBL_MTF_DATA_BUY.M_QTY),
		M_AMT = #TBL_MTF_DATA_BUY.M_AMT + ISNULL(T.M_AMT,#TBL_MTF_DATA_BUY.M_AMT),
		NF_QTY = #TBL_MTF_DATA_BUY.NF_QTY + ISNULL(T.NF_QTY,#TBL_MTF_DATA_BUY.NF_QTY),
		NF_AMT = #TBL_MTF_DATA_BUY.NF_AMT + ISNULL(T.NF_AMT,#TBL_MTF_DATA_BUY.NF_AMT)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND NOT EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
					AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
					AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)

--UPDATE	#TBL_MTF_DATA_BUY 
--SET		NF_QTY = (QTY-M_QTY),
--		NF_AMT = M_PRICE*(QTY-M_QTY)
--WHERE	M_QTY > 0


DELETE	FROM TBL_MTF_DATA_BUY_TDAY_ALLOC
WHERE	SAUDA_DATE = @SAUDA_DATE
		--AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND SELL_BUY = 1

--SELECT	'#TBL_MTF_DATA_BUY-22222',(CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END),* FROM #TBL_MTF_DATA_BUY 
--WHERE	PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

--SELECT COUNT(1) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE = @SAUDA_DATE

INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
		M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE, NF_QTY,NF_AMT,SELL_BUY,
		COLL_QTY = (CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END),
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#TBL_MTF_DATA_BUY 
WHERE	(CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END) > 0

--SELECT COUNT(1) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE = @SAUDA_DATE

--SELECT	'#TBL_MTF_DATA_BUY-3',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'

--RETURN

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC 
--WHERE	SAUDA_DATE = @SAUDA_DATE
--		AND PAYIN_DATE = @EDT
--		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY

--SELECT * FROM #DATA WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = 0,      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(M_QTY), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_QTY ELSE 0 END),
M_FRESHBUY = SUM(M_AMT), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_AMT ELSE 0 END),
M_FRESHSQTY = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_QTY ELSE 0 END),
M_FRESHSELL = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_AMT ELSE 0 END),
M_NETQTY = SUM(NF_QTY),
M_NETAMOUNT = SUM(NF_AMT),
EXCHANGE = P.EXCHANGE,--= 'TRNSE', --TRANSTYPE
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO
,BSECODE
FROM #TBL_MTF_DATA_BUY P (NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER (NOLOCK)      
WHERE 1 = 1 --SAUDA_DATE = @PREV_SAUDA_DATE       
--AND ADJUST_DATE = @SAUDA_DATE      
--AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, ISNULL(P.ISIN,''),P.EXCHANGE,BSECODE --,SETT_NO --, TRANSTYPE      
--HAVING SUM(NF_QTY) > 0 AND SUM(NF_AMT) > 0 


INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,4),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,4),0),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(ISNULL(M_FRESHBQTY,0)),
M_FRESHBUY = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_FRESHBUY,0))),
M_FRESHSQTY = SUM(ISNULL(M_FRESHSQTY,0)),
M_FRESHSELL = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_FRESHSELL,0))),
M_NETQTY = SUM(ISNULL(M_NETQTY,0)),
M_NETAMOUNT = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))),
EXCHANGE = ISNULL(EXCHANGE,'TRNSE'),
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO =''
,BSECODE
FROM #MTR_RTP P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, EXCHANGE, ISNULL(P.ISIN,''),BSECODE
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 

--SELECT '#MTR_RTP',* FROM #MTR_RTP WHERE PARTY_CODE IN ('MCV0087') AND SCRIP_CD='TATAMOTORS' ORDER BY PARTY_CODE, SCRIP_CD, SERIES
--SELECT '#DATA',* FROM #DATA WHERE PARTY_CODE IN ('MCV0087') AND SCRIP_CD='TATAMOTORS' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.MULTIISIN M(NOLOCK)
WHERE	M.SCRIP_CD = #DATA.SCRIP_CD
		AND M.SERIES = #DATA.SERIES
		AND M.VALID = 1
		AND ISNULL(#DATA.ISIN,'') = ''

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M(NOLOCK)
WHERE	M.NSE_SCRIP_CD = #DATA.SCRIP_CD
		AND M.NSE_SERIES = #DATA.SERIES
		AND @PREVDATE BETWEEN FROM_DATE AND TO_DATE
		AND ISNULL(#DATA.ISIN,'') = ''


UPDATE	#DATA
SET		BSECODE = ISNULL(M.SCRIP_CD,'')
FROM	BSEDB.DBO.MULTIISIN M(NOLOCK)
WHERE	M.ISIN = #DATA.ISIN
		AND M.VALID = 1
		AND ISNULL(#DATA.BSECODE,'') = ''

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

ALTER	TABLE #DATA
ADD		CORP_BEFORE_QTY NUMERIC(18,4),
		CORP_AFTER_QTY	NUMERIC(18,4)

UPDATE	#DATA
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')
		AND #DATA.M_FRESHBQTY > 0

UPDATE	#DATA
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND #DATA.CORP_AFTER_QTY <> 0
		AND #DATA.M_FRESHBQTY > 0

UPDATE	#DATA
SET		M_FRESHBQTY = M_FRESHBQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		M_NETQTY = M_NETQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)
		AND M_FRESHBQTY > 0
		AND BODQTY > 0

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT	'#DATA',* FROM #DATA WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'

SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES, PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
M_BODQTY = SUM(M_BODQTY),
M_BODVALUE = SUM(M_BODVALUE),
M_FRESHBQTY = SUM(M_FRESHBQTY),
M_FRESHBUY = SUM(M_FRESHBUY),
M_FRESHSQTY = SUM(M_FRESHSQTY),
M_FRESHSELL = SUM(M_FRESHSELL),
M_NETQTY = SUM(M_NETQTY),--SUM(M_BODQTY) + SUM(M_FRESHBQTY) - SUM(M_FRESHSQTY),
M_NETAMOUNT = SUM(M_NETAMOUNT), --SUM(M_BODVALUE + M_FRESHBUY - M_FRESHSELL),
EXCHANGE,
ISIN,
--M_PRICE = (CASE WHEN SUM(ISNULL(M_NETQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))/SUM(ISNULL(M_NETQTY,0))) ELSE 0 END)--,
M_PRICE = (CASE WHEN SUM(ISNULL(M_FRESHBQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),SUM(M_FRESHBUY)/SUM(M_FRESHBQTY)) ELSE 0 END)
--SETT_NO
,BSECODE,
CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO #DATAFINAL      
FROM #DATA  
--WHERE FRESHSQTY > 0
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, SERIES, PARTY_CODE, EXCHANGE, ISIN, BSECODE --, SETT_NO  

ALTER TABLE #DATAFINAL
ADD	SRNO INT IDENTITY(1,1)

UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

UPDATE #DATAFINAL SET M_NETAMOUNT = 0
WHERE M_NETQTY = 0

--SELECT '#DATAFINAL',((NETQTY)-(M_FRESHBQTY+M_NETQTY)),* FROM #DATAFINAL WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT '#DATAFINAL',((NETQTY)-(M_FRESHBQTY+M_NETQTY)),* FROM #DATAFINAL WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT	'#DATAFINAL',* FROM #DATAFINAL WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'


SELECT	SAUDA_DATE = @SAUDA_DATE,
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		BSECODE,
		ISIN,
		BODQTY,
		BODVALUE,
		QTY = BODQTY+FRESHBQTY-FRESHSQTY,--FRESHSQTY, --(BODQTY),--SUM(FRESHSQTY),
		FRESHBQTY,
		FRESHSQTY,
		MKTAMT = (FRESHSELL),
		NETAMT = (FRESHSELL),
		SETT_NO = '',
		PAYIN_DATE = CONVERT(DATETIME,''),
		EXCHANGE,
		PAYIN_AMT=0,
		PAYIN_AMT_BAL=0,
		CLOSE_QTY = ABS((NETQTY)-(M_FRESHBQTY+M_NETQTY)),
		CLOSE_PRICE = CONVERT(NUMERIC(18,4),0),
		CLOSE_AMT = CONVERT(NUMERIC(18,4),0),
		CLOSE_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY=0,
		NF_AMT=0,
		SELL_BUY = (CASE WHEN ((NETQTY)-((M_FRESHBQTY+M_NETQTY))) < 0 THEN 2 ELSE 1 END),
		M_FRESHBQTY = (M_FRESHBQTY),
		M_FRESHBUY,
		M_NETQTY = (M_NETQTY),
		M_PRICE,
		M_NETQTY_NEW = 0,
		M_FRESHBQTY_NEW = 0,
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0),
		NETAMOUNT,
		NETQTY,
		FRESHSELL,
		M_NETAMOUNT
INTO	#CLOSEPOS
FROM	#DATAFINAL P (NOLOCK)
WHERE	FRESHSQTY > 0
--WHERE	((NETQTY)-(M_FRESHBQTY+M_NETQTY)) < 0

/*
GROUP BY
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		BSECODE,
		ISIN,
		--SETT_NO,
		--PAYIN_DATE,
		EXCHANGE
HAVING	ABS(SUM(NETQTY)-SUM(M_FRESHBQTY+M_NETQTY)) < 0
*/
--SELECT * FROM #DATAFINAL WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'
--SELECT	'#CLOSEPOS-0',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'
--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE = 'JUL  9 2025' AND PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'

--SELECT * FROM #CLOSEPOS WHERE PARTY_CODE='AHMAJ125' AND SCRIP_CD='TRITURBINE'

UPDATE	#CLOSEPOS
SET		QTY = ABS(#CLOSEPOS.BODQTY + #CLOSEPOS.FRESHBQTY - ISNULL(#CLOSEPOS.FRESHSQTY,0)),
		MKTAMT = ABS(#CLOSEPOS.BODVALUE - ISNULL(#CLOSEPOS.MKTAMT,0)),
		NETAMT = ABS(#CLOSEPOS.BODVALUE - ISNULL(#CLOSEPOS.NETAMT,0)),
		CLOSE_QTY = ABS(#CLOSEPOS.M_FRESHBQTY - ISNULL(T.M_QTY,0)), -- - ISNULL(#CLOSEPOS.CLOSE_QTY,0),
		CLOSE_AMT = ABS(#CLOSEPOS.M_FRESHBUY - ISNULL(T.M_AMT,0)), --- ISNULL(#CLOSEPOS.CLOSE_AMT,0)
		M_FRESHBQTY = ABS(ISNULL(T.M_QTY,0) - #CLOSEPOS.M_FRESHBQTY),
		M_FRESHBUY = ABS(ISNULL(T.M_AMT,0) - #CLOSEPOS.M_FRESHBUY),		
		M_NETQTY = ABS(ISNULL(T.NF_QTY,0) - #CLOSEPOS.M_NETQTY),
		M_NETAMOUNT = ABS(ISNULL(T.NF_AMT,0) - #CLOSEPOS.M_NETAMOUNT)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	--T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE < @SAUDA_DATE )
		T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T1(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T1.PARTY_CODE = T.PARTY_CODE
						AND T1.ISIN = T.ISIN
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		--AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND T.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND T.ISIN = #CLOSEPOS.ISIN
		AND NOT EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #CLOSEPOS.PARTY_CODE
					AND P.SCRIP_CD = #CLOSEPOS.SCRIP_CD
					AND P.ISIN = #CLOSEPOS.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)

--SELECT	'#CLOSEPOS-1',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

UPDATE	#CLOSEPOS 
SET		M_PRICE = ROUND(M_FRESHBUY/M_FRESHBQTY,4)


UPDATE	#CLOSEPOS 
SET		PAYIN_DATE = ISNULL(LEFT(SM.FUNDS_PAYIN,11),'')
FROM	MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	SM.START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
		AND SM.SETT_TYPE = 'N'

--SELECT 'AFTER-ALLOC',* FROM #CLOSEPOS WHERE PARTY_CODE='AHMAJ125' AND SCRIP_CD='TRITURBINE'


IF @PROPOR_ALLOC_FLAG = 1
BEGIN
	/*
	DECLARE @NONFNO		INT,
			@FNO		INT

	SELECT	@NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER(NOLOCK)
	WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V(NOLOCK), 
	MSAJAG.DBO.VARCONTROL C(NOLOCK)
	WHERE C.RECDATE >= @SAUDA_DATE aND c.REcDATE <= @SAUDA_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES NOT IN ('BO')
	AND ISIN IN (SELECT DISTINCT ISIN FROM #CLOSEPOS)

	SELECT V.* INTO  #BSE_VAR FROM BSEDB.DBO.VARDETAIL V(NOLOCK)
	WHERE V.FDATE >= @SAUDA_DATE aND v.FDATE <= @SAUDA_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #CLOSEPOS)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )
	*/

	ALTER	TABLE #CLOSEPOS
	ADD		MARGIN_REQ	NUMERIC(18,4),
			HAIRCUT		NUMERIC(18,4),
			PRO_M_QTY	INT,
			PRO_PRICE	NUMERIC(18,4),
			BAL_NET_QTY	INT,
			PRO_ALLOC_PER	NUMERIC(18,4)

	UPDATE	#CLOSEPOS 
	SET		MARGIN_REQ	= 0,
			HAIRCUT		= 0,
			PRO_M_QTY	= 0,
			PRO_PRICE	= 0,
			BAL_NET_QTY = 0,
			PRO_ALLOC_PER = 0


	UPDATE	#CLOSEPOS
	SET		PRO_ALLOC_PER = ROUND(M_FRESHBUY/(M_FRESHBUY+M_NETAMOUNT)*100,2)
	WHERE	M_FRESHBUY > 0 AND (M_FRESHBUY+M_NETAMOUNT) > 0

	UPDATE	#CLOSEPOS
	SET		MARGIN_REQ = ((FRESHSQTY*M_PRICE)/100*PRO_ALLOC_PER),
			PRO_PRICE = ROUND(M_PRICE,4)
	WHERE	FRESHSELL > 0 AND PRO_ALLOC_PER > 0

	UPDATE	#CLOSEPOS
	SET		PRO_M_QTY = FLOOR((MARGIN_REQ/PRO_PRICE)) 
	WHERE	PRO_PRICE > 0 AND MARGIN_REQ > 0

	UPDATE	#CLOSEPOS
	SET		BAL_NET_QTY = (FRESHSQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND FRESHSQTY > 0

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY = (M_FRESHBQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND M_FRESHBQTY > 0

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN (M_FRESHBQTY - PRO_M_QTY) >= 0 THEN (M_FRESHBQTY - PRO_M_QTY) 
				ELSE M_FRESHBQTY 
			END)

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = M_NETQTY - BAL_NET_QTY
	WHERE	(M_NETQTY - BAL_NET_QTY) >= 0

	
	UPDATE	#CLOSEPOS 
	SET		CLOSE_QTY = M_FRESHBQTY_NEW
	WHERE	M_FRESHBQTY_NEW >= 0		

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN M_NETQTY_NEW >= 0 THEN M_NETQTY_NEW ELSE M_NETQTY END),
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW >= 0 THEN M_FRESHBQTY_NEW ELSE M_FRESHBQTY END)

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = M_NETQTY_NEW,
			NF_AMT = M_PRICE*M_NETQTY_NEW,
			CLOSE_PRICE = M_PRICE
	WHERE	M_NETQTY_NEW > 0

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = 0,
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW + NF_QTY > 0 THEN M_FRESHBQTY_NEW + NF_QTY ELSE 0 END)
	WHERE	NF_QTY < 0

	UPDATE	#CLOSEPOS SET SELL_BUY = 2 WHERE CLOSE_QTY < 0 
	
END
ELSE
BEGIN
	
	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN (M_NETQTY - CLOSE_QTY) <= 0 THEN 0 ELSE (M_NETQTY - CLOSE_QTY) END)

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN M_NETQTY_NEW = 0 THEN 
				CASE WHEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) > 0 THEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) ELSE 0 END 
				ELSE M_FRESHBQTY 
			END)

	UPDATE	#CLOSEPOS 
	SET		CLOSE_QTY = M_FRESHBQTY_NEW
	WHERE	M_FRESHBQTY_NEW > 0		

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN M_NETQTY_NEW > 0 THEN M_NETQTY_NEW ELSE M_NETQTY END),
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW > 0 THEN M_FRESHBQTY_NEW ELSE M_FRESHBQTY END)

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = (QTY-CLOSE_QTY),
				NF_AMT = (CLOSE_AMT/CLOSE_QTY)*(QTY-CLOSE_QTY),
			CLOSE_PRICE = (CLOSE_AMT/CLOSE_QTY)
	WHERE	CLOSE_QTY > 0

	UPDATE	#CLOSEPOS 
	SET		NF_QTY = 0,
			M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW + NF_QTY > 0 THEN M_FRESHBQTY_NEW + NF_QTY ELSE 0 END)
	WHERE	NF_QTY < 0

	UPDATE	#CLOSEPOS SET SELL_BUY = 2 WHERE CLOSE_QTY < 0 

END

--SELECT	'#DATAFINAL-3',* FROM #DATAFINAL WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT	'#CLOSEPOS-2',* FROM #CLOSEPOS WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'

--SELECT	'#DATAFINAL-3',* FROM #DATAFINAL WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 
--SELECT	'#CLOSEPOS-3',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

------------------------------------------------------------------------------

DECLARE	@PAYINDATE	VARCHAR(11)
SELECT	@PAYINDATE = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'

--SELECT '#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT * FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 


/** --- CARRY FORWORD POSITION ---*/

SELECT	SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,SCRIP_CD,T.SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,T.SETT_NO,PAYIN_DATE=@PAYINDATE,T.EXCHANGE,PAYIN_AMT,
		PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE,NF_QTY,NF_AMT,SELL_BUY,COLL_QTY,PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM',
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TDAY_ALLOC_CA
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE 
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND T.SELL_BUY = 1
		AND NOT EXISTS (SELECT PARTY_CODE FROM #TBL_MTF_DATA_BUY 
						WHERE T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN 
						AND (CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END) > 0
						)
		AND NOT EXISTS (SELECT PARTY_CODE FROM #CLOSEPOS 
						WHERE T.PARTY_CODE = #CLOSEPOS.PARTY_CODE
						AND T.SCRIP_CD = #CLOSEPOS.SCRIP_CD
						AND T.ISIN = #CLOSEPOS.ISIN
						)

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT '#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT	'#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'
--SELECT	'#CLOSEPOS-4',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

UPDATE	#TDAY_ALLOC_CA
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TDAY_ALLOC_CA.PARTY_CODE
		AND P.SCRIP_CD = #TDAY_ALLOC_CA.SCRIP_CD
		AND P.ISIN = #TDAY_ALLOC_CA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

UPDATE	#TDAY_ALLOC_CA
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TDAY_ALLOC_CA.PARTY_CODE
		AND P.SCRIP_CD = #TDAY_ALLOC_CA.SCRIP_CD
		AND P.ISIN = #TDAY_ALLOC_CA.ISIN
		AND #TDAY_ALLOC_CA.CORP_AFTER_QTY <> 0

UPDATE	#TDAY_ALLOC_CA
SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		COLL_QTY = COLL_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 --- **/

--SELECT '#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT * FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 

INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,
		PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE,NF_QTY,NF_AMT,SELL_BUY,COLL_QTY,PROCESS_ON, PROCESS_BY
FROM	#TDAY_ALLOC_CA


DELETE	FROM TBL_MTF_DATA_BUY_TDAY_ALLOC
WHERE	SAUDA_DATE = @SAUDA_DATE
		--AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND SELL_BUY = 2


INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
		M_QTY = M_FRESHBQTY_NEW,
		M_PRICE = CLOSE_PRICE,
		M_AMT = M_FRESHBQTY_NEW*CLOSE_PRICE,
		M_ALLOC_BALANCE = (QTY-CLOSE_QTY)*CLOSE_PRICE,
		NF_QTY,NF_AMT,SELL_BUY,
		--COLL_QTY = (CASE WHEN NF_QTY < 0 THEN CLOSE_QTY+NF_QTY ELSE CLOSE_QTY END),
		COLL_QTY = M_FRESHBQTY_NEW,
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#CLOSEPOS 
WHERE	M_FRESHBQTY_NEW >= 0


--SELECT	'#CLOSEPOS-BEFORE',* FROM #CLOSEPOS WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'
--SELECT	'TDAY_ALLOC-BEFORE',* FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE PARTY_CODE='600J332' AND SCRIP_CD='GMRAIRPORT'

/*-- FOR BTST CASE COLL QTY WILL BE DEDUCTED ---*/

UPDATE	TBL_MTF_DATA_BUY_TDAY_ALLOC
SET		COLL_QTY = COLL_QTY - M_FRESHBQTY_NEW
FROM	#CLOSEPOS
WHERE	TBL_MTF_DATA_BUY_TDAY_ALLOC.PAYIN_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.ISIN = #CLOSEPOS.ISIN
		AND M_FRESHBQTY_NEW > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SELL_BUY = 1
		AND #CLOSEPOS.NF_QTY = 0


UPDATE	TBL_MTF_DATA_BUY_TDAY_ALLOC
SET		COLL_QTY = 0 --COLL_QTY - ABS(CLOSE_QTY)
FROM	#CLOSEPOS
WHERE	TBL_MTF_DATA_BUY_TDAY_ALLOC.PAYIN_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.ISIN = #CLOSEPOS.ISIN
		AND ABS(CLOSE_QTY) > 0
		AND #CLOSEPOS.QTY = 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SELL_BUY = 1
		AND #CLOSEPOS.NF_QTY = 0


UPDATE	TBL_PRODUCT_HOLD_DATA
SET		QTY = TBL_PRODUCT_HOLD_DATA.QTY - M_FRESHBQTY_NEW
FROM	#CLOSEPOS
WHERE	TBL_PRODUCT_HOLD_DATA.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_PRODUCT_HOLD_DATA.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_PRODUCT_HOLD_DATA.ISIN = #CLOSEPOS.ISIN
		AND M_FRESHBQTY_NEW > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_PRODUCT_HOLD_DATA.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0


UPDATE	TBL_PRODUCT_HOLD_DATA
SET		QTY = 0 --TBL_PRODUCT_HOLD_DATA.QTY - ABS(CLOSE_QTY)
FROM	#CLOSEPOS
WHERE	TBL_PRODUCT_HOLD_DATA.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_PRODUCT_HOLD_DATA.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_PRODUCT_HOLD_DATA.ISIN = #CLOSEPOS.ISIN
		AND ABS(CLOSE_QTY) > 0
		AND #CLOSEPOS.QTY = 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_PRODUCT_HOLD_DATA.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0

--UPDATE	TBL_PRODUCT_HOLD_DATA
--SET		QTY = TBL_PRODUCT_HOLD_DATA.QTY - CLOSE_QTY
--FROM	#CLOSEPOS
--WHERE	TBL_PRODUCT_HOLD_DATA.SAUDA_DATE BETWEEN @PREVDATE AND @PREVDATE + ' 23:59'
--		AND TBL_PRODUCT_HOLD_DATA.PARTY_CODE = #CLOSEPOS.PARTY_CODE
--		AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = #CLOSEPOS.SCRIP_CD
--		AND TBL_PRODUCT_HOLD_DATA.ISIN = #CLOSEPOS.ISIN
--		AND CLOSE_QTY > 0
--		AND #CLOSEPOS.SELL_BUY = 2
--		AND TBL_PRODUCT_HOLD_DATA.QTY > 0

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT * FROM TBL_PRODUCT_HOLD_DATA WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT * FROM TBL_MTF_MARKING WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'
--SELECT * FROM #CLOSEPOS WHERE PARTY_CODE='600R3023' AND SCRIP_CD='IRCTC'

UPDATE	TBL_MTF_MARKING
SET		QTY = TBL_MTF_MARKING.QTY - M_FRESHBQTY_NEW
FROM	#CLOSEPOS
WHERE	TBL_MTF_MARKING.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_MARKING.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_MARKING.ISIN = #CLOSEPOS.ISIN
		AND M_FRESHBQTY_NEW > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_MARKING.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0

UPDATE	TBL_MTF_MARKING
SET		QTY = 0 --TBL_MTF_MARKING.QTY - ABS(CLOSE_QTY)
FROM	#CLOSEPOS
WHERE	TBL_MTF_MARKING.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_MARKING.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_MARKING.ISIN = #CLOSEPOS.ISIN
		AND ABS(CLOSE_QTY) > 0
		AND #CLOSEPOS.QTY = 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_MARKING.QTY > 0
		AND #CLOSEPOS.NF_QTY = 0

/*-- FOR BTST CASE COLL QTY WILL BE DEDUCTED ---*/

DROP TABLE #TBL_MTF_DATA_BUY
DROP TABLE #CLOSEPOS
DROP TABLE #TDAY_ALLOC_CA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_PRODUCT_TDAY_ALLOC_BKUP_08SEP2025
-- --------------------------------------------------


/*
BEGIN TRAN
--EXEC PROC_PRODUCT_TDAY_ALLOC 'JAN 31 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  1 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  3 2025','','ZZZZZZZ'
--EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  4 2025','','ZZZZZZZ'
EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  5 2025','','ZZZZZZZ'
EXEC PROC_PRODUCT_TDAY_ALLOC 'FEB  6 2025','','ZZZZZZZ'

SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC(NOLOCK) WHERE PARTY_CODE='AM0753' AND SCRIP_CD='GOODLUCK'
ROLLBACK
*/


CREATE	PROC [dbo].[PROC_PRODUCT_TDAY_ALLOC]
		(
		@SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20) = '',
		@TOPARTY	VARCHAR(20) = 'ZZZZZZ'
		)

		AS

DECLARE @SDTCUR		DATETIME,
		@LDTCUR		DATETIME,
		@EDT		VARCHAR(11),
		@PREVDATE	VARCHAR(11)

/*
DECLARE @SAUDA_DATE	VARCHAR(11),
		@FROMPARTY	VARCHAR(20),
		@TOPARTY	VARCHAR(20)

SET		@SAUDA_DATE = 'JAN 31 2025'
SET		@FROMPARTY	= 'AF7259'
SET		@TOPARTY	= 'AF7259'
*/

SELECT	@EDT = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'

SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR      


SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017')        
FROM VW_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE

SELECT * INTO #MTR_RTP FROM TBL_MTR_REPORTING WHERE 1=2

IF (SELECT COUNT(1) FROM TBL_MTR_REPORTING WHERE SAUDA_DATE = @PREVDATE) > 0
BEGIN
	
	INSERT	INTO #MTR_RTP
	SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,
			M_BODQTY,M_BODVALUE,M_FRESHBQTY,M_FRESHBUY,M_FRESHSQTY,M_FRESHSELL,M_NETQTY,M_NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @PREVDATE

END
ELSE
BEGIN

	INSERT	INTO #MTR_RTP (SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE)
	SELECT	SAUDA_DATE=@PREVDATE,PARTY_CODE,SCRIP_CD,SERIES,
			BODQTY = SUM(QTY),      
			BODVALUE = SUM(MKTAMT),
			FRESHBQTY = 0,            
			FRESHBUY = 0,            
			FRESHSQTY = 0,      
			FRESHSELL = CONVERT(NUMERIC(18,2),0), 
			NETQTY = SUM(QTY),
			NETAMOUNT = SUM(MKTAMT),
			TRANSTYPE,
			SAUDA_DATE=@PREVDATE,
			ISIN,BSECODE
	FROM	VW_PRODUCT_POSITION
	WHERE	SAUDA_DATE <= @PREVDATE       
			AND ADJUST_DATE > @PREVDATE      
			AND SELL_BUY = 1
	GROUP BY
			PARTY_CODE,SCRIP_CD,SERIES,
			TRANSTYPE,ISIN,BSECODE
	HAVING	SUM(QTY) > 0 AND SUM(MKTAMT) > 0
END


SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(MKTAMT) ),      
FRESHSQTY = 0,
FRESHSELL = CONVERT(NUMERIC(18,2),0),
NETAMOUNT = CONVERT(NUMERIC(18,2),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,2),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,2),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,2),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,2),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
INTO #DATA      
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 


INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(MKTAMT)),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,2),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,2),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,2),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,2),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 

---------------------------------------------------------------------------------------------------------------------------------------------

SELECT	*,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		M_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0),
		SELL_BUY = CONVERT(INT,1),
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TBL_MTF_DATA_BUY 
FROM	TBL_MTF_DATA_BUY(NOLOCK) 
WHERE	SAUDA_DATE = @SAUDA_DATE
		AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY



UPDATE	#TBL_MTF_DATA_BUY 
SET		PAYIN_AMT = ISNULL(D.VAMT,0)
FROM	(
		SELECT	CLTCODE,
				VAMT = SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),
				VDT
		FROM	LEDGER P(NOLOCK)
		WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
				AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
				AND P.VTYP = '66'
				AND P.EDT BETWEEN @EDT AND @EDT + ' 23:59:59'
				--AND P.CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN P.CLTCODE ELSE @PARTY_CODE END)
				AND P.CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
				AND P.NARRATION LIKE '%MTF PAYIN'
		GROUP BY
				CLTCODE,
				VDT
		HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0
		) D
WHERE	D.CLTCODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND D.VDT = #TBL_MTF_DATA_BUY.SAUDA_DATE



/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = ISNULL(T.M_QTY,0),
		NF_QTY = ISNULL(T.NF_QTY,0)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
					AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
					AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)

UPDATE	#TBL_MTF_DATA_BUY
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

UPDATE	#TBL_MTF_DATA_BUY
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND #TBL_MTF_DATA_BUY.CORP_AFTER_QTY <> 0

UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT	'#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'

---------------------------------------------------------------------------------------------------------------------------------------------

DECLARE @ADJCUR		CURSOR, 
		@DELCUR		CURSOR, 
		@PARTYCODE	VARCHAR(20),
		@PAYIN_AMT	NUMERIC(18,4),
		@MKTAMT		NUMERIC(18,4),
		@MARGIN_REQ	NUMERIC(18,4),
		@SNO		INT,
		@MAMT		NUMERIC(18,4),
		@SAUDA_DATE_PAYIN	DATETIME

SET @ADJCUR = CURSOR FOR
	SELECT PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE
	FROM #TBL_MTF_DATA_BUY
	WHERE PAYIN_AMT > 0
	GROUP BY PARTY_CODE, SAUDA_DATE
	ORDER BY PARTY_CODE, SAUDA_DATE
OPEN @ADJCUR
FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN
WHILE @@FETCH_STATUS = 0
BEGIN 

	SET @DELCUR = CURSOR FOR
		SELECT SNO, MKTAMT, MARGIN_REQ 
		FROM #TBL_MTF_DATA_BUY
		WHERE SAUDA_DATE = @SAUDA_DATE_PAYIN 
		AND PARTY_CODE = @PARTYCODE
		AND MKTAMT > 0 AND MARGIN_REQ > 0
		ORDER BY PARTY_CODE, SCRIP_CD, SERIES
	OPEN @DELCUR
	FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		IF @PAYIN_AMT > 0 --AND @@FETCH_STATUS = 0
		BEGIN
			IF @PAYIN_AMT >= @MARGIN_REQ 
			--IF PRADNYA.DBO.FNMIN(@PAYIN_AMT,@MARGIN_REQ)
			BEGIN
				
				SET		@MAMT = 0
				
				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

				SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT

				--SELECT	SRNO = @SNO, PAYIN_AMT=@PAYIN_AMT, M_AMT = @MAMT, PAYIN_BALANCE = (@PAYIN_AMT - @MAMT)
				--SET @PAYIN_AMT = @PAYIN_AMT - @MARGIN_REQ

			END
			ELSE
			BEGIN

				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @PAYIN_AMT
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0
				
				SET @PAYIN_AMT = 0

			END
		END

		FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ 
	END
	
	CLOSE @DELCUR
	DEALLOCATE @DELCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN
END
CLOSE @ADJCUR
DEALLOCATE @ADJCUR

--SELECT	'#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'

--SELECT MAX(SAUDA_DATE),SCRIP_CD,QTY=SUM(QTY) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
--						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = 'AM0753'
--						AND T.SCRIP_CD = 'GOODLUCK'
--GROUP BY SCRIP_CD

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE <= @SAUDA_DATE + ' 23:59' AND PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'


UPDATE	#TBL_MTF_DATA_BUY
SET		QTY = #TBL_MTF_DATA_BUY.QTY + ISNULL(T.QTY,#TBL_MTF_DATA_BUY.QTY),
		MKTAMT = #TBL_MTF_DATA_BUY.MKTAMT + ISNULL(T.MKTAMT,#TBL_MTF_DATA_BUY.MKTAMT),
		NETAMT = #TBL_MTF_DATA_BUY.NETAMT + ISNULL(T.NETAMT,#TBL_MTF_DATA_BUY.NETAMT),
		M_QTY = #TBL_MTF_DATA_BUY.M_QTY + ISNULL(T.M_QTY,#TBL_MTF_DATA_BUY.M_QTY),
		M_AMT = #TBL_MTF_DATA_BUY.M_AMT + ISNULL(T.M_AMT,#TBL_MTF_DATA_BUY.M_AMT),
		NF_QTY = #TBL_MTF_DATA_BUY.NF_QTY + ISNULL(T.NF_QTY,#TBL_MTF_DATA_BUY.NF_QTY),
		NF_AMT = #TBL_MTF_DATA_BUY.NF_AMT + ISNULL(T.NF_AMT,#TBL_MTF_DATA_BUY.NF_AMT)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN


--UPDATE	#TBL_MTF_DATA_BUY 
--SET		NF_QTY = (QTY-M_QTY),
--		NF_AMT = M_PRICE*(QTY-M_QTY)
--WHERE	M_QTY > 0


DELETE	FROM TBL_MTF_DATA_BUY_TDAY_ALLOC
WHERE	SAUDA_DATE = @SAUDA_DATE
		AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND SELL_BUY = 1

--SELECT	'#TBL_MTF_DATA_BUY-22222',(CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END),* FROM #TBL_MTF_DATA_BUY 
--WHERE	PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
		M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE, NF_QTY,NF_AMT,SELL_BUY,
		COLL_QTY = (CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END),
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#TBL_MTF_DATA_BUY 
WHERE	(CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END) > 0


--RETURN

--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC 
--WHERE	SAUDA_DATE = @SAUDA_DATE
--		AND PAYIN_DATE = @EDT
--		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY

--SELECT * FROM #DATA WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = 0,      
NETAMOUNT = CONVERT(NUMERIC(18,2),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,2),0),
M_FRESHBQTY = SUM(M_QTY), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_QTY ELSE 0 END),
M_FRESHBUY = SUM(M_AMT), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_AMT ELSE 0 END),
M_FRESHSQTY = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_QTY ELSE 0 END),
M_FRESHSELL = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_AMT ELSE 0 END),
M_NETQTY = SUM(NF_QTY),
M_NETAMOUNT = SUM(NF_AMT),
EXCHANGE = P.EXCHANGE,--= 'TRNSE', --TRANSTYPE
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO
,BSECODE
FROM #TBL_MTF_DATA_BUY P (NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER (NOLOCK)      
WHERE 1 = 1 --SAUDA_DATE = @PREV_SAUDA_DATE       
--AND ADJUST_DATE = @SAUDA_DATE      
--AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, ISNULL(P.ISIN,''),P.EXCHANGE,BSECODE --,SETT_NO --, TRANSTYPE      
--HAVING SUM(NF_QTY) > 0 AND SUM(NF_AMT) > 0 


INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,2),0),
M_FRESHBQTY = SUM(ISNULL(M_FRESHBQTY,0)),
M_FRESHBUY = CONVERT(NUMERIC(18,2),SUM(ISNULL(M_FRESHBUY,0))),
M_FRESHSQTY = SUM(ISNULL(M_FRESHSQTY,0)),
M_FRESHSELL = CONVERT(NUMERIC(18,2),SUM(ISNULL(M_FRESHSELL,0))),
M_NETQTY = SUM(ISNULL(M_NETQTY,0)),
M_NETAMOUNT = CONVERT(NUMERIC(18,2),SUM(ISNULL(M_NETAMOUNT,0))),
EXCHANGE = ISNULL(EXCHANGE,'TRNSE'),
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO =''
,BSECODE
FROM #MTR_RTP P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, EXCHANGE, ISNULL(P.ISIN,''),BSECODE
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 

--SELECT '#MTR_RTP',* FROM #MTR_RTP WHERE PARTY_CODE IN ('MCV0087') AND SCRIP_CD='TATAMOTORS' ORDER BY PARTY_CODE, SCRIP_CD, SERIES
--SELECT '#DATA',* FROM #DATA WHERE PARTY_CODE IN ('MCV0087') AND SCRIP_CD='TATAMOTORS' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.MULTIISIN M(NOLOCK)
WHERE	M.SCRIP_CD = #DATA.SCRIP_CD
		AND M.SERIES = #DATA.SERIES
		AND M.VALID = 1
		AND ISNULL(#DATA.ISIN,'') = ''

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M(NOLOCK)
WHERE	M.NSE_SCRIP_CD = #DATA.SCRIP_CD
		AND M.NSE_SERIES = #DATA.SERIES
		AND @PREVDATE BETWEEN FROM_DATE AND TO_DATE
		AND ISNULL(#DATA.ISIN,'') = ''


UPDATE	#DATA
SET		BSECODE = ISNULL(M.SCRIP_CD,'')
FROM	BSEDB.DBO.MULTIISIN M(NOLOCK)
WHERE	M.ISIN = #DATA.ISIN
		AND M.VALID = 1
		AND ISNULL(#DATA.BSECODE,'') = ''


SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES, PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
M_BODQTY = SUM(M_BODQTY),
M_BODVALUE = SUM(M_BODVALUE),
M_FRESHBQTY = SUM(M_FRESHBQTY),
M_FRESHBUY = SUM(M_FRESHBUY),
M_FRESHSQTY = SUM(M_FRESHSQTY),
M_FRESHSELL = SUM(M_FRESHSELL),
M_NETQTY = SUM(M_NETQTY),--SUM(M_BODQTY) + SUM(M_FRESHBQTY) - SUM(M_FRESHSQTY),
M_NETAMOUNT = SUM(M_NETAMOUNT), --SUM(M_BODVALUE + M_FRESHBUY - M_FRESHSELL),
EXCHANGE,
ISIN,
M_PRICE = (CASE WHEN SUM(ISNULL(M_NETQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))/SUM(ISNULL(M_NETQTY,0))) ELSE 0 END)--,
--SETT_NO
,BSECODE,
CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO #DATAFINAL      
FROM #DATA  
--WHERE FRESHSQTY > 0
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, SERIES, PARTY_CODE, EXCHANGE, ISIN, BSECODE --, SETT_NO  

ALTER TABLE #DATAFINAL
ADD	SRNO INT IDENTITY(1,1)

UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

UPDATE #DATAFINAL SET M_NETAMOUNT = 0
WHERE M_NETQTY = 0

--SELECT '#DATAFINAL',((NETQTY)-(M_FRESHBQTY+M_NETQTY)),* FROM #DATAFINAL WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT '#DATAFINAL',((NETQTY)-(M_FRESHBQTY+M_NETQTY)),* FROM #DATAFINAL WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 	

SELECT	SAUDA_DATE = @SAUDA_DATE,
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		BSECODE,
		ISIN,
		QTY = FRESHSQTY, --(BODQTY),--SUM(FRESHSQTY),
		FRESHSQTY,
		MKTAMT = (FRESHSELL),
		NETAMT = (FRESHSELL),
		SETT_NO = '',
		PAYIN_DATE = CONVERT(DATETIME,''),
		EXCHANGE,
		PAYIN_AMT=0,
		PAYIN_AMT_BAL=0,
		CLOSE_QTY = ABS((NETQTY)-(M_FRESHBQTY+M_NETQTY)),
		CLOSE_PRICE = CONVERT(NUMERIC(18,4),0),
		CLOSE_AMT = CONVERT(NUMERIC(18,4),0),
		CLOSE_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY=0,
		NF_AMT=0,
		SELL_BUY = (CASE WHEN ((NETQTY)-((M_FRESHBQTY+M_NETQTY))) > 0 THEN 1 ELSE 2 END),
		M_FRESHBQTY = (M_FRESHBQTY),
		M_NETQTY = (M_NETQTY),
		M_PRICE,
		M_NETQTY_NEW = 0,
		M_FRESHBQTY_NEW = 0
INTO	#CLOSEPOS
FROM	#DATAFINAL P (NOLOCK)
WHERE	FRESHSQTY > 0
--WHERE	((NETQTY)-(M_FRESHBQTY+M_NETQTY)) < 0

/*
GROUP BY
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		BSECODE,
		ISIN,
		--SETT_NO,
		--PAYIN_DATE,
		EXCHANGE
HAVING	ABS(SUM(NETQTY)-SUM(M_FRESHBQTY+M_NETQTY)) < 0
*/
--SELECT * FROM #DATAFINAL WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'
--SELECT	'#CLOSEPOS-1',* FROM #CLOSEPOS WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'
--SELECT * FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE = 'JUL  4 2025' AND PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA'

UPDATE	#CLOSEPOS
SET		QTY = ABS(T.QTY - ISNULL(#CLOSEPOS.FRESHSQTY,0)),
		MKTAMT = T.MKTAMT - ISNULL(#CLOSEPOS.MKTAMT,0),
		NETAMT = T.NETAMT - ISNULL(#CLOSEPOS.NETAMT,0),
		CLOSE_QTY = T.M_QTY - ISNULL(#CLOSEPOS.CLOSE_QTY,0),
		CLOSE_AMT = T.M_AMT - ISNULL(#CLOSEPOS.CLOSE_AMT,0)
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	--T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC WHERE SAUDA_DATE < @SAUDA_DATE )
		T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #CLOSEPOS.PARTY_CODE
						AND T.ISIN = #CLOSEPOS.ISIN
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		--AND T.SELL_BUY = 1
		AND T.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND T.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND T.ISIN = #CLOSEPOS.ISIN

--SELECT	'#CLOSEPOS-2',* FROM #CLOSEPOS WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'

UPDATE	#CLOSEPOS 
SET		PAYIN_DATE = ISNULL(LEFT(SM.FUNDS_PAYIN,11),'')
FROM	MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	SM.START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
		AND SM.SETT_TYPE = 'N'

UPDATE	#CLOSEPOS
SET		M_NETQTY_NEW = (CASE WHEN (M_NETQTY - CLOSE_QTY) <= 0 THEN 0 ELSE (M_NETQTY - CLOSE_QTY) END)

UPDATE	#CLOSEPOS
SET		M_FRESHBQTY_NEW = (
		CASE 
			WHEN M_NETQTY_NEW = 0 THEN 
			CASE WHEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) > 0 THEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) ELSE 0 END 
			ELSE M_FRESHBQTY 
		END)

UPDATE	#CLOSEPOS 
SET		CLOSE_QTY = M_FRESHBQTY_NEW
WHERE	M_FRESHBQTY_NEW > 0		

UPDATE	#CLOSEPOS
SET		M_NETQTY_NEW = (CASE WHEN M_NETQTY_NEW > 0 THEN M_NETQTY_NEW ELSE M_NETQTY END),
		M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW > 0 THEN M_FRESHBQTY_NEW ELSE M_FRESHBQTY END)

UPDATE	#CLOSEPOS 
SET		NF_QTY = (QTY-CLOSE_QTY),
		NF_AMT = CLOSE_PRICE*(QTY-CLOSE_QTY),
		CLOSE_PRICE = (CLOSE_AMT/CLOSE_QTY)
WHERE	CLOSE_QTY > 0

UPDATE	#CLOSEPOS 
SET		NF_QTY = 0,
		M_FRESHBQTY_NEW = (CASE WHEN M_FRESHBQTY_NEW + NF_QTY > 0 THEN M_FRESHBQTY_NEW + NF_QTY ELSE 0 END)
WHERE	NF_QTY < 0

--SELECT	'#DATAFINAL-3',* FROM #DATAFINAL WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT	'#CLOSEPOS-3',* FROM #CLOSEPOS WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'

--SELECT	'#DATAFINAL-3',* FROM #DATAFINAL WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 
--SELECT	'#CLOSEPOS-3',* FROM #CLOSEPOS WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 

------------------------------------------------------------------------------

DECLARE	@PAYINDATE	VARCHAR(11)
SELECT	@PAYINDATE = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'

--SELECT '#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT * FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 


/** --- CARRY FORWORD POSITION ---*/

SELECT	SAUDA_DATE=@SAUDA_DATE,PARTY_CODE,SCRIP_CD,T.SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,T.SETT_NO,PAYIN_DATE=@PAYINDATE,T.EXCHANGE,PAYIN_AMT,
		PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE,NF_QTY,NF_AMT,SELL_BUY,COLL_QTY,PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM',
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TDAY_ALLOC_CA
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK)
WHERE	T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTF_DATA_BUY_TDAY_ALLOC T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE 
						)
		AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND T.SELL_BUY = 1
		AND NOT EXISTS (SELECT PARTY_CODE FROM #TBL_MTF_DATA_BUY 
						WHERE T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN 
						AND (CASE WHEN NF_QTY < 0 THEN M_QTY+NF_QTY ELSE M_QTY END) > 0
						)
		AND NOT EXISTS (SELECT PARTY_CODE FROM #CLOSEPOS 
						WHERE T.PARTY_CODE = #CLOSEPOS.PARTY_CODE
						AND T.SCRIP_CD = #CLOSEPOS.SCRIP_CD
						AND T.ISIN = #CLOSEPOS.ISIN
						)

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--SELECT '#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT * FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 

UPDATE	#TDAY_ALLOC_CA
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TDAY_ALLOC_CA.PARTY_CODE
		AND P.SCRIP_CD = #TDAY_ALLOC_CA.SCRIP_CD
		AND P.ISIN = #TDAY_ALLOC_CA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

UPDATE	#TDAY_ALLOC_CA
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #TDAY_ALLOC_CA.PARTY_CODE
		AND P.SCRIP_CD = #TDAY_ALLOC_CA.SCRIP_CD
		AND P.ISIN = #TDAY_ALLOC_CA.ISIN
		AND #TDAY_ALLOC_CA.CORP_AFTER_QTY <> 0

UPDATE	#TDAY_ALLOC_CA
SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		COLL_QTY = COLL_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 --- **/

--SELECT '#TDAY_ALLOC_CA',* FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'
--SELECT * FROM #TDAY_ALLOC_CA WHERE PARTY_CODE='600S14059' AND SCRIP_CD='BDL' 

INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,
		PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,M_ALLOC_BALANCE,NF_QTY,NF_AMT,SELL_BUY,COLL_QTY,PROCESS_ON, PROCESS_BY
FROM	#TDAY_ALLOC_CA


DELETE	FROM TBL_MTF_DATA_BUY_TDAY_ALLOC
WHERE	SAUDA_DATE = @SAUDA_DATE
		AND PAYIN_DATE = @EDT
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND SELL_BUY = 2

--SELECT	'#CLOSEPOS-4',* FROM #CLOSEPOS WHERE PARTY_CODE='AD4768' AND SCRIP_CD='ITDCEM'

INSERT	INTO TBL_MTF_DATA_BUY_TDAY_ALLOC
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,
		M_QTY = M_FRESHBQTY_NEW,
		M_PRICE = CLOSE_PRICE,
		M_AMT = M_FRESHBQTY_NEW*CLOSE_PRICE,
		M_ALLOC_BALANCE = (QTY-CLOSE_QTY)*CLOSE_PRICE,
		NF_QTY,NF_AMT,SELL_BUY,
		--COLL_QTY = (CASE WHEN NF_QTY < 0 THEN CLOSE_QTY+NF_QTY ELSE CLOSE_QTY END),
		COLL_QTY = M_FRESHBQTY_NEW,
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#CLOSEPOS 
WHERE	CLOSE_QTY > 0

/*-- FOR BTST CASE COLL QTY WILL BE DEDUCTED ---*/

UPDATE	TBL_MTF_DATA_BUY_TDAY_ALLOC
SET		COLL_QTY = COLL_QTY - CLOSE_QTY
FROM	#CLOSEPOS
WHERE	TBL_MTF_DATA_BUY_TDAY_ALLOC.PAYIN_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.ISIN = #CLOSEPOS.ISIN
		AND CLOSE_QTY > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_MTF_DATA_BUY_TDAY_ALLOC.SELL_BUY = 1

--SELECT * FROM TBL_PRODUCT_HOLD_DATA WHERE SAUDA_DATE BETWEEN 'JUL  1 2025' AND 'JUL  2 2025 23:59' AND  party_code='AD4768' and scrip_cd='ITDCEM'

UPDATE	TBL_PRODUCT_HOLD_DATA
SET		QTY = TBL_PRODUCT_HOLD_DATA.QTY - CLOSE_QTY
FROM	#CLOSEPOS
WHERE	TBL_PRODUCT_HOLD_DATA.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND TBL_PRODUCT_HOLD_DATA.PARTY_CODE = #CLOSEPOS.PARTY_CODE
		AND TBL_PRODUCT_HOLD_DATA.SCRIP_CD = #CLOSEPOS.SCRIP_CD
		AND TBL_PRODUCT_HOLD_DATA.ISIN = #CLOSEPOS.ISIN
		AND CLOSE_QTY > 0
		AND #CLOSEPOS.SELL_BUY = 2
		AND TBL_PRODUCT_HOLD_DATA.QTY > 0

--SELECT * FROM TBL_PRODUCT_HOLD_DATA WHERE SAUDA_DATE BETWEEN 'JUL  1 2025' AND 'JUL  2 2025 23:59' AND  party_code='AD4768' and scrip_cd='ITDCEM'
--SELECT * FROM #CLOSEPOS WHERE party_code='AD4768' and scrip_cd='ITDCEM'

/*-- FOR BTST CASE COLL QTY WILL BE DEDUCTED ---*/

DROP TABLE #TBL_MTF_DATA_BUY
DROP TABLE #CLOSEPOS
DROP TABLE #TDAY_ALLOC_CA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TEST
-- --------------------------------------------------
CREATE PROC PROC_TEST (
	@SAUDA_DATE VARCHAR(11)
)
AS
 -- exec PROC_TEST 'aug 23 2021'
DECLARE 
		@GLCODE		VARCHAR(10),
		@VNO		VARCHAR(12),
		@NSECASHVNO		VARCHAR(12),
		@BSECASHVNO		VARCHAR(12),
		@SDTCUR		VARCHAR(11),
		@LDTCUR		VARCHAR(11),
		@PAYIN_DATE	DATETIME,
		@FROMDATE	VARCHAR(11),
		@CLEARINGCODE	VARCHAR(10),
		@SETT_NO		VARCHAR(7),
		@SETT_TYPE		VARCHAR(2)
		
SELECT @PAYIN_DATE = MAX(SEC_PAYIN) FROM MSAJAG.DBO.SETT_MST WHERE START_DATE <= @SAUDA_DATE AND SETT_TYPE = 'N'
SET @VNO = ''
SET @CLEARINGCODE = ''
SET @SETT_NO = ''
SELECT *, MT_LIQUIDATE = 0
INTO #MT_LIQUID 
FROM TBL_PRODUCT_POSITION P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE 

CREATE CLUSTERED INDEX IDX_SNO ON #MT_LIQUID
(	
	SNO
)
CREATE NONCLUSTERED INDEX IDX_PARTY ON #MT_LIQUID
(	
	PARTY_CODE,
	ISIN,
	SAUDA_DATE
)


DECLARE @PARTY_CODE VARCHAR(10),
		@ISIN		VARCHAR(12),
		@QTY		INT,
		@MTCUR		CURSOR,
		@POSQTY		INT,
		@POSCUR		CURSOR,
		@POSDATE	DATETIME,
		@SNO		NUMERIC(18,0)

SET @MTCUR = CURSOR FOR
SELECT PARTY_CODE, ISIN, QTY = SUM(QTY) FROM TBL_PRODUCT_POSITION P1
WHERE P1.SAUDA_DATE = @SAUDA_DATE	
AND P1.SELL_BUY = 2 AND P1.SETT_NO = '2000000'
GROUP BY PARTY_CODE, ISIN
ORDER BY PARTY_CODE, ISIN
OPEN @MTCUR
FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
WHILE @@FETCH_STATUS = 0
BEGIN
	SET @POSCUR = CURSOR FOR
	SELECT SNO, QTY, SAUDA_DATE FROM #MT_LIQUID
	WHERE PARTY_CODE = @PARTY_CODE
	AND ISIN = @ISIN
	ORDER BY SAUDA_DATE 
	OPEN @POSCUR
	FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	WHILE @@FETCH_STATUS = 0
	BEGIN
		IF @POSQTY >= @QTY
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @QTY 
			WHERE SNO = @SNO 
			SET @QTY = 0
		END
		ELSE
		BEGIN
			UPDATE #MT_LIQUID SET MT_LIQUIDATE = @POSQTY 
			WHERE SNO = @SNO 
			SET @QTY = @QTY - @POSQTY
		END
		IF @QTY <= 0 
		BEGIN
			BREAK
		END
		FETCH NEXT FROM @POSCUR INTO @SNO, @POSQTY, @POSDATE
	END
	CLOSE @POSCUR
	DEALLOCATE @POSCUR
	FETCH NEXT FROM @MTCUR INTO @PARTY_CODE, @ISIN, @QTY
END
CLOSE @MTCUR
DEALLOCATE @MTCUR

SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END), 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END),VNO = @VNO
INTO #BILL
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END)
HAVING (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM(NETAMT)-SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE 0 END) > 0 

SELECT * FROM #BILL WHERE PARTY_CODE='K158892'
INSERT INTO #BILL
SELECT PARTY_CODE, AMOUNT = (CASE WHEN SUM(QTY) <> SUM(MT_LIQUIDATE) THEN SUM((NETAMT/QTY)*MT_LIQUIDATE) ELSE SUM(NETAMT) END) , 
NARRATION = CONVERT(VARCHAR(100),'Reversed against sale of MTF shares dated ' + @SAUDA_DATE),DRCR = 'C',
PAYIN_DATE=(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END),VNO = @VNO
FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
AND MT_LIQUIDATE > 0 
GROUP BY PARTY_CODE,(CASE WHEN PAYIN_DATE > @PAYIN_DATE THEN PAYIN_DATE ELSE @PAYIN_DATE END)

SELECT * FROM #BILL WHERE PARTY_CODE='K158892'
select * FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE  
and PARTY_CODE='K158892'

select * FROM #MT_LIQUID P
WHERE SAUDA_DATE <= @SAUDA_DATE
AND SELL_BUY = 1 
AND ADJUST_DATE = @SAUDA_DATE
AND MT_LIQUIDATE > 0  
and PARTY_CODE='K158892'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[RPT_ACC_TRIALBALANCE]      
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */      
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */      
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */      
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */      
@OPENENTRYFLAG INT,      
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */      
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */      
      
AS      
  
DECLARE    
@@COSTCODE AS VARCHAR(3)  
  
      
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2      
    
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2      
    
    
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN  
  IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
         GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
         GROUP BY L.CLTCODE  
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'      
         AND EDT < @CURRYRSTDATE        
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM((CASE WHEN VDT < @STDATE and VTYP <> 18 THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)+
		         (CASE WHEN VDT <= @STDATE and VTYP = 18 THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END))     
        FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'       
        GROUP BY L.CLTCODE      
       END      
      ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM((CASE WHEN VDT < @STDATE and VTYP <> 18 THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)+
		         (CASE WHEN VDT <= @STDATE and VTYP = 18 THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)) 
        FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
        GROUP BY L.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
   
  
/*  -- FOR BRANCH SELECTION --  */    
IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN  
 SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )    
 IF @BALANCE='NORMAL'      
    IF @SORTBYDATE = 'VDT'      
     BEGIN         
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,    
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)      
      FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'        
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
   AND COSTCODE = @@COSTCODE  
      GROUP BY L.CLTCODE      
     END      
    ELSE     
      BEGIN      
       INSERT INTO #TEMPLEDGER      
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0       
       FROM        
        (         
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18        
      AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
     GROUP BY L.CLTCODE        
    
         UNION ALL        
    
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)     
         FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18        
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
    
         UNION ALL        
    
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)    
         FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE  
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
         AND COSTCODE = @@COSTCODE  
         GROUP BY L.CLTCODE         
        ) T        
        GROUP BY CLTCODE         
      END      
   ELSE    
      IF @SORTBYDATE = 'VDT'      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'  
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
       END      
     ELSE      
       BEGIN      
        INSERT INTO #TEMPLEDGER      
        SELECT L2.CLTCODE ,      
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),       
        CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),       
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)      
        FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'       
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
        AND COSTCODE = @@COSTCODE  
        GROUP BY L2.CLTCODE      
      END       
    
IF  @VIEWOPTION = 'PARTYWISE'       
 BEGIN      
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)    
 END      
ELSE      
 IF @VIEWOPTION = 'GL'      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END      
 ELSE      
  BEGIN      
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT     
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)    
  END     
    
IF @VIEWOPTION = 'GL'      
 BEGIN    
   INSERT INTO #TEMPLEDGERFINAL    
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4     
 END    
END   
/* ---------------------------- */    
  
  
IF @FLAG = 'CODEWISE'      
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE    
 END    
ELSE    
 BEGIN    
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGAFILE
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BSE_MGAFILE]    
(    
 @SAUDA_DATE VARCHAR(11)    
)    
AS    
    
-- EXEC RPT_BSE_MGAFILE 'AUG 10 2017'    
    
DECLARE @FILEDATE VARCHAR(6),    
  @PREVDATE VARCHAR(11)    
    
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')    
    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM     
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    
    
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),    
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN,   
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = SUM(QTY),      
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHSQTY = 0,   
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)     
INTO #DATA    
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER     
WHERE SAUDA_DATE = @SAUDA_DATE     
AND ADJUST_DATE >= @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'  
GROUP BY MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
    
INSERT INTO #DATA    
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),    
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN ,   
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)     
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER     
WHERE SAUDA_DATE <= @SAUDA_DATE     
AND ADJUST_DATE = @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE' 
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN     
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0    
    
INSERT INTO #DATA     
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),    
MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN ,   
BODQTY = SUM(QTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)      
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER     
WHERE SAUDA_DATE <= @PREVDATE     
AND ADJUST_DATE > @PREVDATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN     
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0   
  
SELECT SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN ,       
BODQTY = SUM(BODQTY),        
BODVALUE = SUM(BODVALUE),           
FRESHBQTY = SUM(FRESHBQTY),        
FRESHBUY = SUM(FRESHBUY),         
FRESHSQTY = SUM(FRESHSQTY),        
FRESHSELL = SUM(FRESHSELL),           
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),         
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)        
INTO #DATAFINAL          
FROM #DATA           
GROUP BY SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN   
HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0

/*  
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0       
          THEN FRESHBQTY - FRESHSQTY      
          ELSE 0      
           END),      
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0       
          THEN FRESHBUY - FRESHSELL      
          ELSE 0      
           END),      
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0       
          THEN FRESHSQTY - FRESHBQTY      
          ELSE 0      
           END),      
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0       
          THEN FRESHSELL - FRESHBUY      
          ELSE 0      
           END)      
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0       
*/      
DELETE FROM #DATAFINAL      
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0  

  
  
CREATE Index #code on #datafinal  
(bsecode )  
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE  
  
--DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE from bse_grp1)  
  
    
SELECT FILENAME = 'MGA' + @FILEDATE + '.CSV',    
SAUDA_DATE, MEMBERCODE, BSECODE, BODVALUE = SUM(BODVALUE),     
FRESHBUY = SUM(FRESHBUY), FRESHSELL = SUM(FRESHSELL),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
FROM #DATAFINAL      
WHERE ISNULL(BSECODE,'') <>''    
AND BSECODE NOT IN ('777777','800252','800258','999932')  
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved)   
GROUP BY SAUDA_DATE, MEMBERCODE, BSECODE     
order by bsecode    
    
DROP TABLE #DATA    
    
  --SELECT * FROM TBLSCRIPMARGIN WHERE TO_DATE > GETDATE()   AND BSECODE IN ('500024')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGAFILE_30082018_BAK
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BSE_MGAFILE_30082018_BAK]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
-- EXEC RPT_BSE_MGAFILE 'AUG 10 2017'  
  
DECLARE @FILEDATE VARCHAR(6),  
  @PREVDATE VARCHAR(11)  
  
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')  
  
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),  
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN, 
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)   
INTO #DATA  
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER   
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')  
GROUP BY MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),  
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN , 
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)   
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER   
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')  
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN   
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
  
INSERT INTO #DATA   
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),  
MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN , 
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER   
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')  
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN   
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

SELECT SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN ,     
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN  
/*
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
*/    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 
  
SELECT FILENAME = 'MGA' + @FILEDATE + '.CSV',  
SAUDA_DATE, MEMBERCODE, BSECODE, BODVALUE = SUM(BODVALUE),   
FRESHBUY = SUM(FRESHBUY), FRESHSELL = SUM(FRESHSELL),   
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)  
FROM #DATAFINAL    
WHERE ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932')
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved) 
GROUP BY SAUDA_DATE, MEMBERCODE, BSECODE   
order by bsecode  
  
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGAFILE_BAK_15012024
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BSE_MGAFILE_BAK_15012014]    
(    
 @SAUDA_DATE VARCHAR(11)    
)    
AS    
    
-- EXEC RPT_BSE_MGAFILE 'AUG 10 2017'    
    
DECLARE @FILEDATE VARCHAR(6),    
  @PREVDATE VARCHAR(11)    
    
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')    
    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM     
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    
    
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),    
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN,   
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = SUM(QTY),      
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHSQTY = 0,   
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)     
INTO #DATA    
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER     
WHERE SAUDA_DATE = @SAUDA_DATE     
AND ADJUST_DATE >= @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'  
GROUP BY MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
    
INSERT INTO #DATA    
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),    
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN ,   
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)     
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER     
WHERE SAUDA_DATE <= @SAUDA_DATE     
AND ADJUST_DATE = @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE' 
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN     
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0    
    
INSERT INTO #DATA     
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),    
MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN ,   
BODQTY = SUM(QTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)      
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER     
WHERE SAUDA_DATE <= @PREVDATE     
AND ADJUST_DATE > @PREVDATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN     
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0   
  
SELECT SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN ,       
BODQTY = SUM(BODQTY),        
BODVALUE = SUM(BODVALUE),           
FRESHBQTY = SUM(FRESHBQTY),        
FRESHBUY = SUM(FRESHBUY),         
FRESHSQTY = SUM(FRESHSQTY),        
FRESHSELL = SUM(FRESHSELL),           
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),         
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)        
INTO #DATAFINAL          
FROM #DATA           
GROUP BY SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN   
HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0

/*  
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0       
          THEN FRESHBQTY - FRESHSQTY      
          ELSE 0      
           END),      
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0       
          THEN FRESHBUY - FRESHSELL      
          ELSE 0      
           END),      
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0       
          THEN FRESHSQTY - FRESHBQTY      
          ELSE 0      
           END),      
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0       
          THEN FRESHSELL - FRESHBUY      
          ELSE 0      
           END)      
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0       
*/      
DELETE FROM #DATAFINAL      
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0  

  
  
CREATE Index #code on #datafinal  
(bsecode )  
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE  
  
DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE from bse_grp1)  
  
    
SELECT FILENAME = 'MGA' + @FILEDATE + '.CSV',    
SAUDA_DATE, MEMBERCODE, BSECODE, BODVALUE = SUM(BODVALUE),     
FRESHBUY = SUM(FRESHBUY), FRESHSELL = SUM(FRESHSELL),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
FROM #DATAFINAL      
WHERE ISNULL(BSECODE,'') <>''    
AND BSECODE NOT IN ('777777','800252','800258','999932')  
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved)   
GROUP BY SAUDA_DATE, MEMBERCODE, BSECODE     
order by bsecode    
    
DROP TABLE #DATA    
    
  --SELECT * FROM TBLSCRIPMARGIN WHERE TO_DATE > GETDATE()   AND BSECODE IN ('500024')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGAFILE_BKUP_25Nov2022
-- --------------------------------------------------
Create PROC [dbo].[RPT_BSE_MGAFILE_BKUP_25Nov2022]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
-- EXEC RPT_BSE_MGAFILE 'AUG 10 2017'  
  
DECLARE @FILEDATE VARCHAR(6),  
  @PREVDATE VARCHAR(11)  
  
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')  
  
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),  
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN, 
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)   
INTO #DATA  
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER   
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')  
GROUP BY MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),  
MEMBERCODE, P.PARTY_CODE,BSECODE, ISIN , 
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)   
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER   
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')  
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN   
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
  
INSERT INTO #DATA   
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),  
MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN , 
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM TBL_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER   
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')  
GROUP BY MEMBERCODE, P.PARTY_CODE, BSECODE, ISIN   
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

SELECT SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN ,     
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY SAUDA_DATE,MEMBERCODE, PARTY_CODE, BSECODE, ISIN  
/*
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
*/    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 


CREATE Index #code on #datafinal
(bsecode )
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE

DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE from bse_grp1)

  
SELECT FILENAME = 'MGA' + @FILEDATE + '.CSV',  
SAUDA_DATE, MEMBERCODE, BSECODE, BODVALUE = SUM(BODVALUE),   
FRESHBUY = SUM(FRESHBUY), FRESHSELL = SUM(FRESHSELL),   
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)  
FROM #DATAFINAL    
WHERE ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932')
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved) 
GROUP BY SAUDA_DATE, MEMBERCODE, BSECODE   
order by bsecode  
  
DROP TABLE #DATA  
  
  --SELECT * FROM TBLSCRIPMARGIN WHERE TO_DATE > GETDATE()   AND BSECODE IN ('500024')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGFILE
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BSE_MGFILE]    
(    
 @SAUDA_DATE VARCHAR(11)    
)    
AS    
    
-- EXEC RPT_BSE_MGFILE 'AUG 10 2017'    
    
DECLARE @FILEDATE VARCHAR(6),    
  @PREVDATE VARCHAR(11)    ,@MEMBERCODE VARCHAR(10)  
    
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')    
  
SET @MEMBERCODE =(SELECT MEMBERCODE FROM ANGELBSECM.BSEDB_AB.DBO.OWNER    )  
  
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM     
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    
    
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',     
ISIN,  BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = (CASE WHEN TRANSTYPE='TRBSE' THEN 'BSE' ELSE 'NSE' END),    
MAPPING_NO = '0',  
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = SUM(QTY),      
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHSQTY = 0,   
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
INTO #DATA    
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANGELBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE = @SAUDA_DATE     
AND ADJUST_DATE >= @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN,  BSECODE, TRANSTYPE    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
  
INSERT INTO #DATA    
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',     
ISIN,  BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = (CASE WHEN TRANSTYPE='TRBSE' THEN 'BSE' ELSE 'NSE' END),    
MAPPING_NO = '0',  
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)   
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANGELBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE <= @SAUDA_DATE     
AND ADJUST_DATE = @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'  
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN,  BSECODE, TRANSTYPE    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
    
INSERT INTO #DATA    
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',     
ISIN,  BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = (CASE WHEN TRANSTYPE='TRBSE' THEN 'BSE' ELSE 'NSE' END),    
MAPPING_NO = '0',  
BODQTY = SUM(QTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANGELBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE <= @PREVDATE     
AND ADJUST_DATE > @PREVDATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE' 
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN,  BSECODE, TRANSTYPE    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
    
  
SELECT MEMBERCODE=@MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'C',     
ISIN,  BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = 'BSE',    
MAPPING_NO = '0',   
BODQTY = 0,   
BODVALUE = 0,  
FRESHBQTY = SUM(QTY),          
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(CL_RATE*QTY - CL_RATE*QTY*HAIRCUT/100) / 100000),          
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  INTO #TEMP   
FROM TBL_PRODUCT_HOLD_DATA P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)---, ANGELBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE = @SAUDA_DATE     
AND HOLDFLAG = 'MTFCOLL'    
AND C.CL_CODE = P.PARTY_CODE    
GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN,  BSECODE, SETT_TYPE   
  
CREATE INDEX ISIN ON  #TEMP  
(ISIN)  
  
INSERT INTO #DATA    
SELECT * FROM #TEMP WHERE ISIN IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)    
  
   
  
SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED,   
ISIN,  BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO,   
BODQTY = SUM(BODQTY),        
BODVALUE = SUM(BODVALUE),           
FRESHBQTY = SUM(FRESHBQTY),        
FRESHBUY = SUM(FRESHBUY),         
FRESHSQTY = SUM(FRESHSQTY),        
FRESHSELL = SUM(FRESHSELL),           
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),         
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)        
INTO #DATAFINAL          
FROM #DATA           
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED,   
ISIN,  BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO  
  
  
UPDATE #DATA SET BSECODE = M.SCRIP_CD   
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M  
WHERE #DATA.ISIN = M.ISIN  
AND VALID = 1   
     
DELETE FROM #DATAFINAL      
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0   
    
  
    
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME    
FROM ANGELBSECM.BSEDB_AB.DBO.SCRIP1 S1, ANGELBSECM.BSEDB_AB.DBO.SCRIP2 S2    
WHERE S1.CO_CODE = S2.CO_CODE    
AND S1.SERIES = S2.SERIES    
AND S2.BSECODE = #DATAFINAL.BSECODE    
  
CREATE INDEX #CODE ON #DATAFINAL  
(BSECODE )  
--SELECT BSECODE INTO #BSEC FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
  
--DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE FROM BSE_GRP1)  
    
SELECT   FILENAME = 'MG' + @FILEDATE + '.CSV',     
MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD,   
PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'AAAAA9999A' ELSE PAN_GIR_NO END),   
FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO,     
QTY = SUM(BODQTY + FRESHBQTY - FRESHSQTY), NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''    
AND BSECODE NOT IN ('777777','800252','800258','999932')  
AND BSECODE NOT IN (SELECT * FROM BSEMTFUNAPPOVED)   
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO    
HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0  
ORDER BY PARTY_CODE, BSECODE    
    
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGFILE_BAK_15012024
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BSE_MGFILE_BAK_15012024]    
(    
 @SAUDA_DATE VARCHAR(11)    
)    
AS    
    
-- EXEC RPT_BSE_MGFILE 'AUG 10 2017'    
    
DECLARE @FILEDATE VARCHAR(6),    
  @PREVDATE VARCHAR(11)    ,@MEMBERCODE VARCHAR(10)  
    
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')    
  
SET @MEMBERCODE =(SELECT MEMBERCODE FROM AngelBSECM.BSEDB_AB.DBO.OWNER    )  
  
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM     
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    
    
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',     
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = (CASE WHEN TRANSTYPE='TRBSE' THEN 'BSE' ELSE 'NSE' END),    
MAPPING_NO = '0',  
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = SUM(QTY),      
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHSQTY = 0,   
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
INTO #DATA    
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE = @SAUDA_DATE     
AND ADJUST_DATE >= @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, TRANSTYPE    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
  
INSERT INTO #DATA    
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',     
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = (CASE WHEN TRANSTYPE='TRBSE' THEN 'BSE' ELSE 'NSE' END),    
MAPPING_NO = '0',  
BODQTY = 0,   
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)   
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE <= @SAUDA_DATE     
AND ADJUST_DATE = @SAUDA_DATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE'  
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, TRANSTYPE    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
    
INSERT INTO #DATA    
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',     
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = (CASE WHEN TRANSTYPE='TRBSE' THEN 'BSE' ELSE 'NSE' END),    
MAPPING_NO = '0',  
BODQTY = SUM(QTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),    
FRESHBQTY = 0,          
FRESHBUY = 0,          
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), AngelBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE <= @PREVDATE     
AND ADJUST_DATE > @PREVDATE    
AND SELL_BUY = 1     
AND C.CL_CODE = P.PARTY_CODE    
AND TRANSTYPE='TRBSE' 
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, TRANSTYPE    
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0  
    
  
SELECT MEMBERCODE=@MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'C',     
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),     
EXCHANGE = 'BSE',    
MAPPING_NO = '0',   
BODQTY = 0,   
BODVALUE = 0,  
FRESHBQTY = SUM(QTY),          
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(CL_RATE*QTY - CL_RATE*QTY*HAIRCUT/100) / 100000),          
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),    
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  INTO #TEMP   
FROM TBL_PRODUCT_HOLD_DATA P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)---, AngelBSECM.BSEDB_AB.DBO.OWNER      
WHERE SAUDA_DATE = @SAUDA_DATE     
AND HOLDFLAG = 'MTFCOLL'    
AND C.CL_CODE = P.PARTY_CODE    
GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE   
  
CREATE INDEX ISIN ON  #TEMP  
(ISIN)  
  
INSERT INTO #DATA    
SELECT * FROM #TEMP WHERE ISIN IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)    
  
   
  
SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED,   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO,   
BODQTY = SUM(BODQTY),        
BODVALUE = SUM(BODVALUE),           
FRESHBQTY = SUM(FRESHBQTY),        
FRESHBUY = SUM(FRESHBUY),         
FRESHSQTY = SUM(FRESHSQTY),        
FRESHSELL = SUM(FRESHSELL),           
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),         
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)        
INTO #DATAFINAL          
FROM #DATA           
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED,   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO  
  
UPDATE #DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES   
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M  
WHERE #DATA.ISIN = M.ISIN  
AND VALID = 1   
  
UPDATE #DATA SET BSECODE = M.SCRIP_CD   
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M  
WHERE #DATA.ISIN = M.ISIN  
AND VALID = 1   
/*  
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0       
          THEN FRESHBQTY - FRESHSQTY      
          ELSE 0      
           END),      
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0       
          THEN FRESHBUY - FRESHSELL      
          ELSE 0      
           END),      
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0       
          THEN FRESHSQTY - FRESHBQTY      
          ELSE 0      
           END),      
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0       
          THEN FRESHSELL - FRESHBUY      
          ELSE 0      
           END)      
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0       
*/      
DELETE FROM #DATAFINAL      
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0   
    
  
    
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME    
FROM AngelBSECM.BSEDB_AB.DBO.SCRIP1 S1, AngelBSECM.BSEDB_AB.DBO.SCRIP2 S2    
WHERE S1.CO_CODE = S2.CO_CODE    
AND S1.SERIES = S2.SERIES    
AND S2.BSECODE = #DATAFINAL.BSECODE    
  
  
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME    
FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2    
WHERE S1.CO_CODE = S2.CO_CODE    
AND S1.SERIES = S2.SERIES    
AND S2.SCRIP_CD = #DATAFINAL.SCRIP_CD    
AND S2.SERIES = #DATAFINAL.SERIES    
AND #DATAFINAL.SCRIP_NAME = ''    
  
CREATE Index #code on #datafinal  
(bsecode )  
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE  
  
DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE from bse_grp1)  
    
SELECT FILENAME = 'MG' + @FILEDATE + '.CSV',     
MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD,   
PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'AAAAA9999A' ELSE pan_gir_no END),   
FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO,     
QTY = SUM(BODQTY + FRESHBQTY - FRESHSQTY), NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''    
AND BSECODE NOT IN ('777777','800252','800258','999932')  
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved)   
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO    
HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0  
ORDER BY PARTY_CODE, BSECODE    
    
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGFILE_BAK_30082018
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BSE_MGFILE_BAK_30082018]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
-- EXEC RPT_BSE_MGFILE 'AUG 10 2017'  
  
DECLARE @FILEDATE VARCHAR(6),  
  @PREVDATE VARCHAR(11)    
  
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')  


SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #DATA  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')   
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0

INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'C',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = 'BSE',  
MAPPING_NO = '0', 
BODQTY = 0, 
BODVALUE = 0,
FRESHBQTY = SUM(QTY),        
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(CL_RATE*QTY - CL_RATE*QTY*HAIRCUT/100) / 100000),        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_HOLD_DATA P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG = 'MTFCOLL'  
AND C.CL_CODE = P.PARTY_CODE  
AND ISIN IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  

SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO, 
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO

UPDATE #DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 

UPDATE #DATA SET BSECODE = M.SCRIP_CD 
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 
/*
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
*/    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 
  

  
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM ANAND.BSEDB_AB.DBO.SCRIP1 S1, ANAND.BSEDB_AB.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.BSECODE = #DATAFINAL.BSECODE  


UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.SCRIP_CD = #DATAFINAL.SCRIP_CD  
AND S2.SERIES = #DATAFINAL.SERIES  
AND #DATAFINAL.SCRIP_NAME = ''  


  
SELECT FILENAME = 'MG' + @FILEDATE + '.CSV',   
MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, 
PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'AAAAA9999A' ELSE pan_gir_no END), 
FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO,   
QTY = SUM(BODQTY + FRESHBQTY - FRESHSQTY), NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)  
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932')
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved) 
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO  
HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0
ORDER BY PARTY_CODE, BSECODE  
  
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGFILE_BAK_30082018_1
-- --------------------------------------------------
create PROC [dbo].[RPT_BSE_MGFILE_BAK_30082018_1]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
-- EXEC RPT_BSE_MGFILE 'AUG 10 2017'  
  
DECLARE @FILEDATE VARCHAR(6),  
  @PREVDATE VARCHAR(11)    
  
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')  


SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #DATA  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')   
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0

INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'C',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = 'BSE',  
MAPPING_NO = '0', 
BODQTY = 0, 
BODVALUE = 0,
FRESHBQTY = SUM(QTY),        
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(CL_RATE*QTY - CL_RATE*QTY*HAIRCUT/100) / 100000),        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_HOLD_DATA P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG = 'MTFCOLL'  
AND C.CL_CODE = P.PARTY_CODE  
AND ISIN IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  

SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO, 
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO

UPDATE #DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 

UPDATE #DATA SET BSECODE = M.SCRIP_CD 
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 
/*
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
*/    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 
  

  
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM ANAND.BSEDB_AB.DBO.SCRIP1 S1, ANAND.BSEDB_AB.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.BSECODE = #DATAFINAL.BSECODE  


UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.SCRIP_CD = #DATAFINAL.SCRIP_CD  
AND S2.SERIES = #DATAFINAL.SERIES  
AND #DATAFINAL.SCRIP_NAME = ''  

CREATE Index #code on #datafinal
(bsecode )
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE

DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE from bse_grp1)
  
SELECT FILENAME = 'MG' + @FILEDATE + '.CSV',   
MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, 
PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'AAAAA9999A' ELSE pan_gir_no END), 
FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO,   
QTY = SUM(BODQTY + FRESHBQTY - FRESHSQTY), NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)  
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932')
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved) 
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO  
HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0
ORDER BY PARTY_CODE, BSECODE  
  
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGFILE_BKUP_25Nov2022
-- --------------------------------------------------
Create PROC [dbo].[RPT_BSE_MGFILE_BKUP_25Nov2022]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
-- EXEC RPT_BSE_MGFILE 'AUG 10 2017'  
  
DECLARE @FILEDATE VARCHAR(6),  
  @PREVDATE VARCHAR(11)    ,@MEMBERCODE VARCHAR(10)
  
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')  

SET @MEMBERCODE =(SELECT MEMBERCODE FROM ANAND.BSEDB_AB.DBO.OWNER    )

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #DATA  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')   
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0

INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  

SELECT MEMBERCODE=@MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'C',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = 'BSE',  
MAPPING_NO = '0', 
BODQTY = 0, 
BODVALUE = 0,
FRESHBQTY = SUM(QTY),        
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(CL_RATE*QTY - CL_RATE*QTY*HAIRCUT/100) / 100000),        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  INTO #TEMP 
FROM TBL_PRODUCT_HOLD_DATA P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)---, ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG = 'MTFCOLL'  
AND C.CL_CODE = P.PARTY_CODE  
GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE 

CREATE INDEX ISIN ON  #TEMP
(ISIN)

INSERT INTO #DATA  
SELECT * FROM #TEMP WHERE ISIN IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  

 

SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO, 
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO

UPDATE #DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 

UPDATE #DATA SET BSECODE = M.SCRIP_CD 
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 
/*
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
*/    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 
  

  
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM ANAND.BSEDB_AB.DBO.SCRIP1 S1, ANAND.BSEDB_AB.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.BSECODE = #DATAFINAL.BSECODE  


UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.SCRIP_CD = #DATAFINAL.SCRIP_CD  
AND S2.SERIES = #DATAFINAL.SERIES  
AND #DATAFINAL.SCRIP_NAME = ''  

CREATE Index #code on #datafinal
(bsecode )
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE

DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE from bse_grp1)
  
SELECT FILENAME = 'MG' + @FILEDATE + '.CSV',   
MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, 
PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'AAAAA9999A' ELSE pan_gir_no END), 
FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO,   
QTY = SUM(BODQTY + FRESHBQTY - FRESHSQTY), NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)  
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932')
and BSECODE NOT IN (SELECT * FROM bsemtfunappoved) 
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO  
HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0
ORDER BY PARTY_CODE, BSECODE  
  
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGFILE_New
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BSE_MGFILE_New]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
-- EXEC RPT_BSE_MGFILE 'AUG 10 2017'  
  
DECLARE @FILEDATE VARCHAR(6),  
  @PREVDATE VARCHAR(11)    ,@MEMBERCODE VARCHAR(10)
  
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')  

SET @MEMBERCODE =(SELECT MEMBERCODE FROM ANAND.BSEDB_AB.DBO.OWNER    )

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #DATA  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')   
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0

INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  

 

SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO, 
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO

UPDATE #DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 

UPDATE #DATA SET BSECODE = M.SCRIP_CD 
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 
/*
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
*/    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 
  

  
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM ANAND.BSEDB_AB.DBO.SCRIP1 S1, ANAND.BSEDB_AB.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.BSECODE = #DATAFINAL.BSECODE  


UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.SCRIP_CD = #DATAFINAL.SCRIP_CD  
AND S2.SERIES = #DATAFINAL.SERIES  
AND #DATAFINAL.SCRIP_NAME = ''  

CREATE INDEX #CODE ON #DATAFINAL
(BSECODE )
--SELECT BSECODE INTO #BSEC FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE

DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE FROM BSE_GRP1)
  
  DELETE FROM TBL_BSE_REPORTING WHERE SAUDA_DATE=@SAUDA_DATE

INSERT INTO TBL_BSE_REPORTING

SELECT  
SAUDA_DATE=@SAUDA_DATE, PARTY_CODE, 
 BSECODE,'', 
   BODQTY=SUM(BODQTY) ,BODVALUE=SUM(BODVALUE), FRESHBQTY=SUM(FRESHBQTY) , FRESHBUY=SUM(FRESHBUY), FRESHSQTY=SUM(FRESHSQTY),
   FRESHSELL=SUM(FRESHSELL),
QTY = SUM(BODQTY + FRESHBQTY - FRESHSQTY), NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)  ,GETDATE()
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932')
AND BSECODE NOT IN (SELECT * FROM BSEMTFUNAPPOVED) 
And FLAG_FUNDED = 'F'
GROUP BY  PARTY_CODE, BSECODE 
  
 


DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BSE_MGFILE_TEST
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_BSE_MGFILE_TEST]  
(  
 @SAUDA_DATE VARCHAR(11)  
)  
AS  
  
-- EXEC RPT_BSE_MGFILE 'AUG 10 2017'  
  
DECLARE @FILEDATE VARCHAR(6),  
  @PREVDATE VARCHAR(11)    ,@MEMBERCODE VARCHAR(10)
  
SET @FILEDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),3),'/','')  

SET @MEMBERCODE =(SELECT MEMBERCODE FROM ANAND.BSEDB_AB.DBO.OWNER    )

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM   
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE  
  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = SUM(QTY),    
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHSQTY = 0, 
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
INTO #DATA  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND ADJUST_DATE >= @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')   
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0

INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = 0, 
BODVALUE =CONVERT(NUMERIC(18,2),0),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),  
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0) 
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @SAUDA_DATE   
AND ADJUST_DATE = @SAUDA_DATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
INSERT INTO #DATA  
SELECT MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'F',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = (CASE WHEN SETT_TYPE IN ('AD', 'D', 'C') THEN 'BSE' ELSE 'NSE' END),  
MAPPING_NO = '0',
BODQTY = SUM(QTY),  
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) / 100000),  
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_PRODUCT_POSITION P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE <= @PREVDATE   
AND ADJUST_DATE > @PREVDATE  
AND SELL_BUY = 1   
AND C.CL_CODE = P.PARTY_CODE  
AND SETT_TYPE IN ('AD', 'D', 'C')    
GROUP BY MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE  
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0
  
--SELECT * FROM #DATA WHERE PARTY_CODE='PINY1008'
--RETURN


SELECT MEMBERCODE=@MEMBERCODE, P.PARTY_CODE, C.LONG_NAME, CAT_HOLD = 'NP', PAN_GIR_NO, FLAG_FUNDED = 'C',   
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME = CONVERT(VARCHAR(100), ''),   
EXCHANGE = 'BSE',  
MAPPING_NO = '0', 
BODQTY = 0, 
BODVALUE = 0,
FRESHBQTY = SUM(QTY),        
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(CL_RATE*QTY - CL_RATE*QTY*HAIRCUT/100) / 100000),        
FRESHSQTY = 0,  
FRESHSELL = CONVERT(NUMERIC(18,2),0),  
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  INTO #TEMP 
FROM TBL_PRODUCT_HOLD_DATA P WITH(NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)---, ANAND.BSEDB_AB.DBO.OWNER    
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG = 'MTFCOLL'  
AND C.CL_CODE = P.PARTY_CODE  
GROUP BY  P.PARTY_CODE, C.LONG_NAME, PAN_GIR_NO, ISIN, SCRIP_CD, SERIES, BSECODE, SETT_TYPE 

CREATE INDEX ISIN ON  #TEMP
(ISIN)

INSERT INTO #DATA  
SELECT * FROM #TEMP WHERE ISIN IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE)  



SELECT MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO, 
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA         
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, 
ISIN, SCRIP_CD, SERIES, BSECODE, SCRIP_NAME, EXCHANGE, MAPPING_NO


 



UPDATE #DATA SET SCRIP_CD = M.SCRIP_CD, SERIES = M.SERIES 
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 

UPDATE #DATA SET BSECODE = M.SCRIP_CD 
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M
WHERE #DATA.ISIN = M.ISIN
AND VALID = 1 
/*
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
*/    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0 
  
  SELECT * FROM #DATAFINAL WHERE PARTY_CODE='PINY1008'
RETURN
  
UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM ANAND.BSEDB_AB.DBO.SCRIP1 S1, ANAND.BSEDB_AB.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.BSECODE = #DATAFINAL.BSECODE  


UPDATE #DATAFINAL SET SCRIP_NAME = S1.LONG_NAME  
FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.SCRIP_CD = #DATAFINAL.SCRIP_CD  
AND S2.SERIES = #DATAFINAL.SERIES  
AND #DATAFINAL.SCRIP_NAME = ''  

CREATE INDEX #code ON #datafinal
(bsecode )
--SELECT BSECODE into #bsec FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN from_date AND TO_DATE

DELETE FROM #DATAFINAL    WHERE BSECODE NOT IN (SELECT BSECODE FROM bse_grp1)


  
SELECT    
MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, 
PAN_GIR_NO = (CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN 'AAAAA9999A' ELSE pan_gir_no END), 
FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO,   
QTY = SUM(BODQTY + FRESHBQTY - FRESHSQTY), NETAMT = SUM(BODVALUE + FRESHBUY - FRESHSELL)  
FROM #DATAFINAL WHERE EXCHANGE ='BSE' AND ISNULL(BSECODE,'') <>''  
AND BSECODE NOT IN ('777777','800252','800258','999932')
AND BSECODE NOT IN (SELECT * FROM bsemtfunappoved) 
AND PARTY_CODE='PINY1008'
GROUP BY MEMBERCODE, PARTY_CODE, LONG_NAME, CAT_HOLD, PAN_GIR_NO, FLAG_FUNDED, BSECODE,SCRIP_NAME, EXCHANGE, MAPPING_NO  

--HAVING SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0 AND SUM(BODQTY + FRESHBQTY - FRESHSQTY) > 0

ORDER BY PARTY_CODE, BSECODE  
  
DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENT_SCRIP_DETAIL
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_CLIENT_SCRIP_DETAIL]                   
(                  
@STATUSID	VARCHAR(25),                  
@STATUSNAME VARCHAR(50),                  
@FROMCODE	VARCHAR(10),                  
@TOCODE		VARCHAR(10),                  
@SAUDA_DATE VARCHAR(11),      
@RPTBY		VARCHAR(1) = 'D'      
)                  
                  
AS                  
      
-- EXEC RPT_CLIENT_SCRIP_DETAIL 'BROKER' , 'BROKER' , 'C69696' , 'C69696', 'SEP 29 2017'        
SELECT @TOCODE = (CASE WHEN @TOCODE = '' AND @FROMCODE <> '' THEN @FROMCODE             
      WHEN @TOCODE = '' AND @FROMCODE = '' THEN 'ZZZZZZZZZZ'            
      ELSE @TOCODE END)             
                
                          
SELECT              
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),        
PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),            
SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), MARKETVALUE=SUM(MKTAMT), NETVALUE = SUM(NETAMT),             
CL_RATE = CURR_CL_RATE,            
HAIRCUT,            
MTOM_LOSS=SUM(MTOM_LOSS),             
MARG_REQ = SUM(MARGIN_REQ),          
FIN_MARG_REQ = SUM(MARGIN_REQ) - SUM(MTOM_LOSS),             
FLAG='POSITION',       
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),      
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),             
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),        
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
TOT_MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL,        
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),        
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),      
MTFLEDBAL          
INTO #DATA            
FROM TBL_MTF_DATA T, MSAJAG.DBO.CLIENT1 C1            
WHERE SAUDA_DATE = @SAUDA_DATE             
AND C1.CL_CODE = PARTY_CODE            
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE            
AND @STATUSNAME =                      
                  (CASE                      
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                      
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                      
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                      
                  ELSE                      
                        'BROKER'                      
                  END)                
AND QTY > 0 AND NETAMT > 0          
GROUP BY PARTY_CODE, LONG_NAME,            
SCRIP_CD, SERIES, BSECODE, ISIN,CURR_CL_RATE,HAIRCUT,MTFNONCASHCOLLATERAL,MTFLEDBAL          
  
  
SELECT PARTY_CODE, LEDBAL = SUM(LEDBAL)   
INTO #LEDBAL  
FROM (  
SELECT PARTY_CODE, LEDBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)  
FROM LEDGER L, PARAMETER P, TBLCLIENTMARGIN T  
WHERE T.PARTY_CODE = L.CLTCODE   
AND @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR   
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
AND VDT BETWEEN SDTCUR AND LDTCUR   
AND VDT <= @SAUDA_DATE + ' 23:59:59'  
AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #DATA)  
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE  
GROUP BY PARTY_CODE   
UNION ALL  
SELECT PARTY_CODE, LEDBAL = 0  
FROM TBLCLIENTMARGIN  
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE  
AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #DATA)  
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE ) A  
GROUP BY PARTY_CODE  
  
INSERT INTO #DATA   
SELECT CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),    
PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),        
SCRIP_CD = '', SERIES = '', BSECODE = '', ISIN = '', QTY=0, MARKETVALUE=0, NETVALUE = 0,         
CL_RATE = 0,        
HAIRCUT = 0,        
MTOM_LOSS=0,         
MARG_REQ = 0,      
FIN_MARG_REQ = 0,         
FLAG='POSITION',   
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),  
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),         
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),      
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),    
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),    
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),    
TOT_MTFNONCASHCOLLATERAL = 0,    
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),    
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),  
MTFLEDBAL = LEDBAL     
FROM #LEDBAL , MSAJAG.DBO.CLIENT1 C1   
WHERE #LEDBAL.PARTY_CODE = C1.CL_CODE   
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE        
AND @STATUSNAME =                  
                  (CASE                  
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                  
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                  
                  ELSE                  
                        'BROKER'                  
                  END)      
      
INSERT INTO  #DATA      
SELECT             
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),      
PARTY_CODE,LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),SCRIP_CD,SERIES,BSECODE,ISIN,      
QTY=SUM(QTY),      
MARKETVALUE=SUM(QTY*CL_RATE), NETVALUE = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),      
CL_RATE,HAIRCUT,MTOM_LOSS=0,      
MARG_REQ = CONVERT(NUMERIC(18,4),0),          
FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
FLAG='COLL',       
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),      
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),             
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),        
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
TOT_MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),        
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),      
MTFLEDBAL  = CONVERT(NUMERIC(18,4),0)         
FROM TBL_PRODUCT_HOLD_DATA T, MSAJAG.DBO.CLIENT1 C1            
WHERE SAUDA_DATE = @SAUDA_DATE             
AND C1.CL_CODE = PARTY_CODE            
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE            
AND @STATUSNAME =                      
     (CASE                      
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                      
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                      
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                      
                  ELSE                      
                        'BROKER'                      
                  END)            
AND HOLDFLAG = 'MTFCOLL'      
GROUP BY PARTY_CODE,LONG_NAME, SCRIP_CD,SERIES,BSECODE,ISIN,CL_RATE,HAIRCUT      
      
UPDATE #DATA SET TOT_FUND_AMT = T.TOT_FUND_AMT, TOT_MTOM_LOSS = T.TOT_MTOM_LOSS,      
TOT_MARG_REQ = T.TOT_MARG_REQ, TOT_FIN_MARG_REQ = T.TOT_FIN_MARG_REQ,      
TOT_MTFCASHCOLLATERAL = T.TOT_FUND_AMT + T.MTFLEDBAL,       
TOT_AVAL_COLL_MTF = T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL,      
TOT_EXCESS_SHORT = - T.TOT_FIN_MARG_REQ + (T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL),      
MTFLEDBAL = T.MTFLEDBAL      
FROM (SELECT PARTY_CODE,  TOT_FUND_AMT = SUM(NETVALUE), TOT_MTOM_LOSS = SUM(MTOM_LOSS),      
       TOT_MARG_REQ = SUM(MARG_REQ), TOT_FIN_MARG_REQ = SUM(FIN_MARG_REQ),      
       MTFLEDBAL      
   FROM #DATA WHERE FLAG = 'POSITION'      
   GROUP BY PARTY_CODE,MTFLEDBAL ) T      
WHERE T.PARTY_CODE = #DATA.PARTY_CODE            
            
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM angeldemat.MSAJAG.DBO.SCRIP1 S1, angeldemat.MSAJAG.DBO.SCRIP2 S2                        
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                        
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES                        
                        
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM angeldemat.BSEDB.DBO.SCRIP1 S1, angeldemat.BSEDB.DBO.SCRIP2 S2                        
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                        
AND S2.BSECODE = #DATA.BSECODE                       
AND SCRIP_NAME = ''                 
/*      
SELECT PARTY_CODE, BSECODE, ISIN, QTY = SUM(QTY)      
FROM #DATA WHERE EXCHANGE = 'BSE'      
GROUP BY  PARTY_CODE, BSECODE, ISIN      
      
RETURN    */         

ALTER TABLE #DATA ADD 
	COMPANYHEADER1 VARCHAR(MAX),
	COMPANYHEADER2 VARCHAR(MAX),
	COMPANYHEADER3 VARCHAR(MAX),
	COMPANYHEADER4 VARCHAR(MAX),
	COMPANYHEADER5 VARCHAR(MAX),
	COMPANYHEADER6 VARCHAR(MAX),
	COMPANYHEADER7 VARCHAR(MAX)

UPDATE	#DATA
SET		COMPANYHEADER1 = 'Corporate Office: '+ Addr1 +' '+ Addr2 +' '+ City +' - '+ Zip + '(India)',
		COMPANYHEADER2 = 'Visit us at: '+ WEBSITE_ID +'  Phone No: '+ PHONE +' Fax: '+ FAX +' Email: '+ EMAIL,
		COMPANYHEADER3 = COMMONMEMBERNAME,
		COMPANYHEADER4 = 'SEBI Regn.No.(BSE/NSE/MSE): '+ COMMONSEBINO +', CIN. No.: '+ CIN,
		COMPANYHEADER5 = 'SEBI Investment Advisers: '+ SEBI_INV_ADV_NO +' | SEBI Research Analyst: '+ SEBI_RES_ANLY_NO,
		COMPANYHEADER6 = BR_CMDPID,
		COMPANYHEADER7 = ''
FROM	MSAJAG.DBO.OWNER


UPDATE #DATA SET PARTY_CODE = UPPER(LTRIM(RTRIM(PARTY_CODE)))

SELECT 
	PROCESSDATE,PARTY_CODE,LONG_NAME,SCRIP_NAME,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,      
	TRADE_VALUE=MARKETVALUE,FUNDED_VALUE=NETVALUE,CL_RATE,MARKET_VALUE=CL_RATE*QTY,HAIRCUT,      
	MARG_REQ=-MARG_REQ,MTOM_LOSS=-MTOM_LOSS,FIN_MARG_REQ=-FIN_MARG_REQ,      
	FLAG,       
	MTFLEDBAL,      
	TOT_FUND_AMT,      
	TOT_MTOM_LOSS=-TOT_MTOM_LOSS,             
	TOT_MARG_REQ=-TOT_MARG_REQ,          
	TOT_FIN_MARG_REQ=-TOT_FIN_MARG_REQ,        
	TOT_MTFCASHCOLLATERAL,        
	TOT_MTFCASHEQCOLLATERAL,        
	TOT_MTFNONCASHCOLLATERAL,        
	TOT_AVAL_COLL_MTF,        
	TOT_EXCESS_SHORT,      
	OPENDAY='-',
	FILENAME='MTF_'+PARTY_CODE+'_'+CONVERT(VARCHAR,CONVERT(DATETIME,PROCESSDATE,103),112),
	COMPANYHEADER1 = ISNULL(COMPANYHEADER1,''),
	COMPANYHEADER2 = ISNULL(COMPANYHEADER2,''),
	COMPANYHEADER3 = ISNULL(COMPANYHEADER3,''),
	COMPANYHEADER4 = ISNULL(COMPANYHEADER4,''),
	COMPANYHEADER5 = ISNULL(COMPANYHEADER5,''),
	COMPANYHEADER6 = ISNULL(COMPANYHEADER6,''),
	COMPANYHEADER7 = ISNULL(COMPANYHEADER7,'')
FROM #DATA  
WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #DATA
				     WHERE ABS(MTFLEDBAL) > 0 OR ABS(TOT_FUND_AMT) > 0 
						   OR ABS(TOT_AVAL_COLL_MTF) > 0 OR ABS(TOT_FIN_MARG_REQ) > 0 
						   OR ABS(TOT_MTFCASHCOLLATERAL) > 0 OR ABS(TOT_EXCESS_SHORT) > 0)                      
ORDER BY 
	PARTY_CODE, 
	FLAG DESC, 
	SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENT_SCRIP_DETAIL_NEWMTF
-- --------------------------------------------------




CREATE PROC [dbo].[RPT_CLIENT_SCRIP_DETAIL_NEWMTF]                   
(                  
@STATUSID	VARCHAR(25),                  
@STATUSNAME VARCHAR(50),                  
@FROMCODE	VARCHAR(10),                  
@TOCODE		VARCHAR(10),                  
@SAUDA_DATE VARCHAR(11),      
@RPTBY		VARCHAR(1) = 'D'      
)                  
                  
AS	                  
	IF(CHARINDEX('/',@SAUDA_DATE)>1)
	BEGIN
		SELECT @SAUDA_DATE=CONVERT(VARCHAR(11),CONVERT(DATETIME,@SAUDA_DATE,103),109)
	END	

-- EXEC RPT_CLIENT_SCRIP_DETAIL_NEWMTF 'BROKER' , 'BROKER' , 'AF7259' , 'AF7259', 'JUL  1 2025'   

SELECT @TOCODE = (CASE WHEN @TOCODE = '' AND @FROMCODE <> '' THEN @FROMCODE             
      WHEN @TOCODE = '' AND @FROMCODE = '' THEN 'ZZZZZZZZZZ'            
      ELSE @TOCODE END)             
 

SELECT DISTINCT PARTY_CODE INTO #PARTY FROM TBLCLIENTMARGIN (NOLOCK)
WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE 
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE

CREATE NONCLUSTERED INDEX PARTY ON #PARTY
( PARTY_CODE )
                          
SELECT              
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),        
PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),            
SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), MARKETVALUE=SUM(MKTAMT), NETVALUE = SUM(NETAMT),             
CL_RATE = CURR_CL_RATE,            
HAIRCUT,            
MTOM_LOSS=SUM(MTOM_LOSS),             
MARG_REQ = SUM(MARGIN_REQ),          
FIN_MARG_REQ = SUM(MARGIN_REQ) + SUM(MTOM_LOSS),             
FLAG=CONVERT(VARCHAR(30),'POSITION'),       
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),      
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),             
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),        
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
TOT_MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL,        
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),        
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),      
MTFLEDBAL,
MTF_CASH_COLL_LEDGER = CONVERT(NUMERIC(18,4),0),
MTF_CASH_PAYIN_LEDGER = CONVERT(NUMERIC(18,4),0),
MTF_MTM_LEDGER = CONVERT(NUMERIC(18,4),0),
MAINTENANCE_MARGIN_QUANTITY = CONVERT(NUMERIC(20,0),0),
MAINTENANCE_MARGIN_VALUE = CONVERT(NUMERIC(18,4),0),
NET_QUANTITY = CONVERT(NUMERIC(20,0),0),
NET_AMOUNT = CONVERT(NUMERIC(18,4),0),
MAINTENANCE_COLL_QUANTITY = CONVERT(NUMERIC(20,0),0),
TOTAL_COLL_VALUE = CONVERT(NUMERIC(18,4),0)
INTO #DATA            
FROM TBL_MTF_DATA T (NOLOCK), MSAJAG.DBO.CLIENT1 C1 (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE             
AND C1.CL_CODE = PARTY_CODE            
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE            
AND @STATUSNAME =                      
                  (CASE                      
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                      
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                      
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                      
                  ELSE                      
                        'BROKER'                      
                  END)                
AND QTY > 0 AND NETAMT > 0          
GROUP BY PARTY_CODE, LONG_NAME,            
SCRIP_CD, SERIES, BSECODE, ISIN,CURR_CL_RATE,HAIRCUT,MTFNONCASHCOLLATERAL,MTFLEDBAL          

CREATE NONCLUSTERED INDEX PARTY1 ON #DATA
( PARTY_CODE ) 

SELECT PARTY_CODE, LEDBAL = SUM(LEDBAL)   
INTO #LEDBAL  
FROM (  
	SELECT PARTY_CODE, LEDBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)  
	FROM LEDGER L (NOLOCK), PARAMETER P (NOLOCK), #PARTY T (NOLOCK)  
	WHERE T.PARTY_CODE = L.CLTCODE   
	AND @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR   
	AND VDT BETWEEN SDTCUR AND LDTCUR   
	AND VDT <= @SAUDA_DATE + ' 23:59:59'  
	AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE  
	AND NOT EXISTS (SELECT PARTY_CODE FROM #DATA WHERE #DATA.PARTY_CODE = L.CLTCODE)  
	GROUP BY PARTY_CODE   
	UNION ALL  
	SELECT PARTY_CODE, LEDBAL = 0  
	FROM #PARTY (NOLOCK)  
	WHERE  PARTY_CODE BETWEEN @FROMCODE AND @TOCODE
	AND NOT EXISTS (SELECT PARTY_CODE FROM #DATA WHERE #DATA.PARTY_CODE = #PARTY.PARTY_CODE)    
	) A  
GROUP BY PARTY_CODE 


INSERT INTO #DATA   
SELECT CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),    
PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),        
SCRIP_CD = '', SERIES = '', BSECODE = '', ISIN = '', QTY=0, MARKETVALUE=0, NETVALUE = 0,         
CL_RATE = 0,        
HAIRCUT = 0,        
MTOM_LOSS=0,         
MARG_REQ = 0,      
FIN_MARG_REQ = 0,         
FLAG= CONVERT(VARCHAR(30),'POSITION'),   
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),  
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),         
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),      
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),    
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),    
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),    
TOT_MTFNONCASHCOLLATERAL = 0,    
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),    
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),  
MTFLEDBAL = LEDBAL,
MTF_CASH_COLL_LEDGER = CONVERT(NUMERIC(18,4),0),
MTF_CASH_PAYIN_LEDGER = CONVERT(NUMERIC(18,4),0),
MTF_MTM_LEDGER = CONVERT(NUMERIC(18,4),0),
MAINTENANCE_MARGIN_QUANTITY = CONVERT(NUMERIC(20,0),0),
MAINTENANCE_MARGIN_VALUE = CONVERT(NUMERIC(18,4),0),
NET_QUANTITY = CONVERT(NUMERIC(20,0),0),
NET_AMOUNT = CONVERT(NUMERIC(18,4),0),
MAINTENANCE_COLL_QUANTITY = CONVERT(NUMERIC(20,0),0),
TOTAL_COLL_VALUE = CONVERT(NUMERIC(18,4),0)
FROM #LEDBAL , MSAJAG.DBO.CLIENT1 C1 (NOLOCK)
WHERE #LEDBAL.PARTY_CODE = C1.CL_CODE   
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE        
AND @STATUSNAME =                  
                  (CASE                  
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                  
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                  
                  ELSE                  
                        'BROKER'                  
                  END)


SELECT	PARTY_CODE, 
		MTF_CASH_COLL_LEDGER	= ISNULL(SUM(A.MTF_CASH_COLL_LEDGER),0),
		MTF_CASH_PAYIN_LEDGER	= ISNULL(SUM(A.MTF_CASH_PAYIN_LEDGER),0),
		MTF_MTM_LEDGER			= ISNULL(SUM(A.MTF_MTM_LEDGER),0)
INTO	#LEDBAL_NEW  
FROM	(  
		SELECT	PARTY_CODE, 
				MTF_CASH_COLL_LEDGER = SUM(CASE WHEN VTYP ='6' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END),
				MTF_CASH_PAYIN_LEDGER = SUM(CASE WHEN VTYP ='66' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END),
				MTF_MTM_LEDGER = SUM(CASE WHEN VTYP ='67' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)
		FROM	LEDGER L (NOLOCK), 
				PARAMETER P (NOLOCK), 
				#PARTY T (NOLOCK)  
		WHERE	T.PARTY_CODE = L.CLTCODE   
				AND T.PARTY_CODE BETWEEN @FROMCODE AND @TOCODE 
				AND @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR   
				AND VDT BETWEEN SDTCUR AND LDTCUR   
				AND VDT <= @SAUDA_DATE + ' 23:59:59'  
				AND NOT EXISTS (SELECT PARTY_CODE FROM #DATA WHERE #DATA.PARTY_CODE = T.PARTY_CODE)
				AND VTYP IN ('6','66','67')
		GROUP BY PARTY_CODE  
		UNION ALL  
		SELECT	PARTY_CODE, 
				MTF_CASH_COLL_LEDGER = 0,
				MTF_CASH_PAYIN_LEDGER = 0,
				MTF_MTM_LEDGER = 0
		FROM	#PARTY (NOLOCK) 
		WHERE	PARTY_CODE BETWEEN @FROMCODE AND @TOCODE
				AND NOT EXISTS (SELECT PARTY_CODE FROM #DATA WHERE #DATA.PARTY_CODE = #PARTY.PARTY_CODE)
		) A  
GROUP BY PARTY_CODE  


UPDATE	#DATA
SET		MTF_CASH_COLL_LEDGER	= ISNULL(#LEDBAL_NEW.MTF_CASH_COLL_LEDGER,0),
		MTF_CASH_PAYIN_LEDGER	= ISNULL(#LEDBAL_NEW.MTF_CASH_PAYIN_LEDGER,0),
		MTF_MTM_LEDGER			= ISNULL(#LEDBAL_NEW.MTF_MTM_LEDGER,0)
FROM	#LEDBAL_NEW
WHERE	#LEDBAL_NEW.PARTY_CODE = #DATA.PARTY_CODE
		AND FLAG = 'POSITION'

/*
INSERT	INTO #DATA   
SELECT	CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),    
		PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),        
		SCRIP_CD = '', SERIES = '', BSECODE = '', ISIN = '', QTY=0, MARKETVALUE=0, NETVALUE = 0,         
		CL_RATE = 0,        
		HAIRCUT = 0,        
		MTOM_LOSS=0,         
		MARG_REQ = 0,      
		FIN_MARG_REQ = 0,         
		FLAG='POSITION_MMQTY',   
		TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),  
		TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),         
		TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),      
		TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),    
		TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),    
		TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),    
		TOT_MTFNONCASHCOLLATERAL = 0,    
		TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),    
		TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),  
		MTFLEDBAL = CONVERT(NUMERIC(18,4),0),
		MTF_CASH_COLL_LEDGER = ISNULL(MTF_CASH_COLL_LEDGER,0),
		MTF_CASH_PAYIN_LEDGER = ISNULL(MTF_CASH_PAYIN_LEDGER,0),
		MTF_MTM_LEDGER = ISNULL(MTF_MTM_LEDGER,0),
		MAINTENANCE_MARGIN_QUANTITY = CONVERT(NUMERIC(20,0),0),
		MAINTENANCE_MARGIN_VALUE = CONVERT(NUMERIC(18,4),0),
		NET_QUANTITY = CONVERT(NUMERIC(20,0),0),
		NET_AMOUNT = CONVERT(NUMERIC(18,4),0),
		MAINTENANCE_COLL_QUANTITY = CONVERT(NUMERIC(20,0),0),
		TOTAL_COLL_VALUE = CONVERT(NUMERIC(18,4),0)
FROM	#LEDBAL_NEW , MSAJAG.DBO.CLIENT1 C1 (NOLOCK)   
WHERE	#LEDBAL_NEW.PARTY_CODE = C1.CL_CODE   
		AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE        
		AND @STATUSNAME =(
		CASE                  
			WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                  
			WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                  
			WHEN @STATUSID = 'TRADER' THEN C1.TRADER                  
			WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                  
			WHEN @STATUSID = 'AREA' THEN C1.AREA                  
			WHEN @STATUSID = 'REGION' THEN C1.REGION                  
			WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                  
			ELSE 'BROKER'                  
		END)      
*/
      

INSERT	INTO #DATA      
SELECT	PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),      
		PARTY_CODE,LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),SCRIP_CD,SERIES,BSECODE,ISIN,      
		QTY=SUM(QTY),      
		MARKETVALUE=SUM(QTY*CL_RATE), NETVALUE = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),      
		CL_RATE,HAIRCUT,MTOM_LOSS=0,      
		MARG_REQ = CONVERT(NUMERIC(18,4),0),          
		FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
		FLAG='COLL',       
		TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),      
		TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),             
		TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
		TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),        
		TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
		TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
		TOT_MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),        
		TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),        
		TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),      
		MTFLEDBAL  = CONVERT(NUMERIC(18,4),0),
		MTF_CASH_COLL_LEDGER = CONVERT(NUMERIC(18,4),0),
		MTF_CASH_PAYIN_LEDGER = CONVERT(NUMERIC(18,4),0),
		MTF_MTM_LEDGER = CONVERT(NUMERIC(18,4),0),
		MAINTENANCE_MARGIN_QUANTITY = CONVERT(NUMERIC(20,0),0),
		MAINTENANCE_MARGIN_VALUE = CONVERT(NUMERIC(18,4),0),
		NET_QUANTITY = CONVERT(NUMERIC(20,0),0),
		NET_AMOUNT = CONVERT(NUMERIC(18,4),0),
		MAINTENANCE_COLL_QUANTITY = CONVERT(NUMERIC(20,0),0),
		TOTAL_COLL_VALUE = CONVERT(NUMERIC(18,4),0)
FROM	TBL_PRODUCT_HOLD_DATA T (NOLOCK), MSAJAG.DBO.CLIENT1 C1 (NOLOCK)            
WHERE	SAUDA_DATE = @SAUDA_DATE             
		AND C1.CL_CODE = PARTY_CODE            
		AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE            
		AND @STATUSNAME = (
		CASE                      
			WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
			WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
			WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
			WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
			WHEN @STATUSID = 'AREA' THEN C1.AREA                      
			WHEN @STATUSID = 'REGION' THEN C1.REGION                      
			WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                      
			ELSE 'BROKER'                      
		END)            
		AND HOLDFLAG = 'MTFCOLL'      
GROUP BY PARTY_CODE,LONG_NAME, SCRIP_CD,SERIES,BSECODE,ISIN,CL_RATE,HAIRCUT      


   
SELECT	PARTY_CODE,LONG_NAME, SCRIP_CD,SERIES,BSECODE,ISIN, 
		MAINTENANCE_MARGIN_QUANTITY = SUM(M_QTY),
		MAINTENANCE_MARGIN_VALUE = SUM(M_AMT),
		NET_QUANTITY = SUM(NF_QTY),
		NET_AMOUNT = SUM(NF_AMT),
		MAINTENANCE_COLL_QUANTITY = SUM(COLL_QTY),
		TOTAL_COLL_VALUE = SUM(COLL_QTY*M_PRICE)
INTO	#MMQTY
FROM	TBL_MTF_DATA_BUY_TDAY_ALLOC T (NOLOCK), MSAJAG.DBO.CLIENT1 C1 (NOLOCK)            
WHERE	SAUDA_DATE = @SAUDA_DATE             
		AND C1.CL_CODE = PARTY_CODE            
		AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE            
		AND @STATUSNAME = (
		CASE                      
			WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                      
			WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                      
			WHEN @STATUSID = 'TRADER' THEN C1.TRADER                      
			WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                      
			WHEN @STATUSID = 'AREA' THEN C1.AREA                      
			WHEN @STATUSID = 'REGION' THEN C1.REGION                      
			WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                      
			ELSE 'BROKER'                      
		END)            
		AND M_QTY > 0
GROUP BY 
		PARTY_CODE,LONG_NAME, SCRIP_CD,SERIES,BSECODE,ISIN


UPDATE	#DATA 
SET		MAINTENANCE_MARGIN_QUANTITY = #MMQTY.MAINTENANCE_MARGIN_QUANTITY,
		MAINTENANCE_MARGIN_VALUE = #MMQTY.MAINTENANCE_MARGIN_VALUE,
		NET_QUANTITY = #MMQTY.NET_QUANTITY,
		NET_AMOUNT = #MMQTY.NET_AMOUNT 
FROM	#MMQTY  		
WHERE	#MMQTY.PARTY_CODE = #DATA.PARTY_CODE
		AND #MMQTY.SCRIP_CD = #DATA.SCRIP_CD
		AND #MMQTY.ISIN = #DATA.ISIN
		AND FLAG='COLL'


UPDATE	#DATA 
SET		TOT_FUND_AMT = T.TOT_FUND_AMT, TOT_MTOM_LOSS = T.TOT_MTOM_LOSS,      
		TOT_MARG_REQ = T.TOT_MARG_REQ, TOT_FIN_MARG_REQ = T.TOT_FIN_MARG_REQ,      
		TOT_MTFCASHCOLLATERAL = T.TOT_FUND_AMT + T.MTFLEDBAL,       
		TOT_AVAL_COLL_MTF = T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL,      
		TOT_EXCESS_SHORT = - T.TOT_FIN_MARG_REQ + (T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL),      
		MTFLEDBAL = T.MTFLEDBAL      
FROM	(
		SELECT PARTY_CODE,  TOT_FUND_AMT = SUM(NETVALUE), TOT_MTOM_LOSS = SUM(MTOM_LOSS),      
			TOT_MARG_REQ = SUM(MARG_REQ), TOT_FIN_MARG_REQ = SUM(FIN_MARG_REQ),      
			MTFLEDBAL      
		FROM #DATA WHERE FLAG = 'POSITION'      
		GROUP BY PARTY_CODE,MTFLEDBAL 
		) T      
WHERE T.PARTY_CODE = #DATA.PARTY_CODE            



--UPDATE #DATA SET TOT_FUND_AMT = T.TOT_FUND_AMT, TOT_MTOM_LOSS = T.TOT_MTOM_LOSS,      
--TOT_MARG_REQ = T.TOT_MARG_REQ, TOT_FIN_MARG_REQ = T.TOT_FIN_MARG_REQ,      
--TOT_MTFCASHCOLLATERAL = T.TOT_FUND_AMT + T.MTFLEDBAL,       
--TOT_AVAL_COLL_MTF = T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL,      
--TOT_EXCESS_SHORT = - T.TOT_FIN_MARG_REQ + (T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL),      
--MTFLEDBAL = T.MTFLEDBAL      
--FROM (SELECT PARTY_CODE,  TOT_FUND_AMT = SUM(NETVALUE), TOT_MTOM_LOSS = SUM(MTOM_LOSS),      
--       TOT_MARG_REQ = SUM(MARG_REQ), TOT_FIN_MARG_REQ = SUM(FIN_MARG_REQ),      
--       MTFLEDBAL      
--   FROM #DATA WHERE FLAG = 'POSITION'      
--   GROUP BY PARTY_CODE,MTFLEDBAL ) T      
--WHERE T.PARTY_CODE = #DATA.PARTY_CODE            


UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1 (NOLOCK), MSAJAG.DBO.SCRIP2 S2 (NOLOCK)                        
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                        
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES                        
                        
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM BSEDB.DBO.SCRIP1 S1 (NOLOCK), BSEDB.DBO.SCRIP2 S2 (NOLOCK)                        
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                        
AND S2.BSECODE = #DATA.BSECODE                       
AND SCRIP_NAME = ''                 
/*      
SELECT PARTY_CODE, BSECODE, ISIN, QTY = SUM(QTY)      
FROM #DATA WHERE EXCHANGE = 'BSE'      
GROUP BY  PARTY_CODE, BSECODE, ISIN      
      
RETURN    */         

ALTER TABLE #DATA ADD 
	COMPANYHEADER1 VARCHAR(8000),
	COMPANYHEADER2 VARCHAR(8000),
	COMPANYHEADER3 VARCHAR(8000),
	COMPANYHEADER4 VARCHAR(8000),
	COMPANYHEADER5 VARCHAR(8000),
	COMPANYHEADER6 VARCHAR(8000),
	COMPANYHEADER7 VARCHAR(8000)

UPDATE	#DATA
SET		COMPANYHEADER1 = 'Corporate Office: '+ Addr1 +' '+ Addr2 +' '+ City +' - '+ Zip + '(India)',
		COMPANYHEADER2 = 'Visit us at: '+ WEBSITE_ID +'  Phone No: '+ PHONE +' Fax: '+ FAX +' Email: '+ EMAIL,
		--COMPANYHEADER3 = 'COMMONMEMBERNAME,
		COMPANYHEADER4 = 'SEBI Regn.No.(BSE/NSE/MSE): '+ COMMONSEBINO +', CIN. No.: '+ CIN,
		--COMPANYHEADER5 = 'SEBI Investment Advisers: '+ SEBI_INV_ADV_NO +' | SEBI Research Analyst: '+ SEBI_RES_ANLY_NO,
		COMPANYHEADER6 = BR_CMDPID,
		COMPANYHEADER7 = ''
FROM	MSAJAG.DBO.OWNER


UPDATE #DATA SET PARTY_CODE = UPPER(LTRIM(RTRIM(PARTY_CODE)))



SELECT 
	PROCESSDATE,PARTY_CODE,LONG_NAME,SCRIP_NAME,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,      
	TRADE_VALUE=MARKETVALUE,FUNDED_VALUE=NETVALUE,CL_RATE,MARKET_VALUE=CL_RATE*QTY,HAIRCUT,      
	MARG_REQ=-MARG_REQ,MTOM_LOSS=-MTOM_LOSS,FIN_MARG_REQ=-FIN_MARG_REQ,      
	FLAG,       
	MTFLEDBAL,      
	TOT_FUND_AMT,      
	TOT_MTOM_LOSS=-TOT_MTOM_LOSS,             
	TOT_MARG_REQ=-TOT_MARG_REQ,          
	TOT_FIN_MARG_REQ=-TOT_FIN_MARG_REQ,        
	TOT_MTFCASHCOLLATERAL,        
	TOT_MTFCASHEQCOLLATERAL,        
	TOT_MTFNONCASHCOLLATERAL,        
	TOT_AVAL_COLL_MTF,        
	TOT_EXCESS_SHORT,      
	OPENDAY='-',
	FILENAME='MTF_RPT_'+PARTY_CODE+'_'+CONVERT(VARCHAR,CONVERT(DATETIME,PROCESSDATE,103),112),
	COMPANYHEADER1 = ISNULL(COMPANYHEADER1,''),
	COMPANYHEADER2 = ISNULL(COMPANYHEADER2,''),
	COMPANYHEADER3 = ISNULL(COMPANYHEADER3,''),
	COMPANYHEADER4 = ISNULL(COMPANYHEADER4,''),
	COMPANYHEADER5 = ISNULL(COMPANYHEADER5,''),
	COMPANYHEADER6 = ISNULL(COMPANYHEADER6,''),
	COMPANYHEADER7 = ISNULL(COMPANYHEADER7,''),
	LTV=99.99,
	SANCTIONED_AMT=999.99,

	/*ADDED BY NEW MTF*/
	MTF_CASH_COLL_LEDGER,
	MTF_CASH_PAYIN_LEDGER,
	MTF_MTM_LEDGER,
	MAINTENANCE_MARGIN_QUANTITY,
	MAINTENANCE_MARGIN_VALUE,
	NET_QUANTITY,
	NET_AMOUNT,
	MAINTENANCE_COLL_QUANTITY,
	TOTAL_COLL_VALUE
	/*ADDED BY NEW MTF*/

FROM #DATA  
WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #DATA
				     WHERE ABS(MTFLEDBAL) > 0 OR ABS(TOT_FUND_AMT) > 0 
						   OR ABS(TOT_AVAL_COLL_MTF) > 0 OR ABS(TOT_FIN_MARG_REQ) > 0 
						   OR ABS(TOT_MTFCASHCOLLATERAL) > 0 OR ABS(TOT_EXCESS_SHORT) > 0)                      
ORDER BY 
	PARTY_CODE, 
	FLAG DESC, 
	SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENT_SCRIP_DETAIL_Test
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[RPT_CLIENT_SCRIP_DETAIL_Test]                     
(                    
@STATUSID VARCHAR(25),                    
@STATUSNAME VARCHAR(50),                    
@FROMCODE VARCHAR(10),                    
@TOCODE  VARCHAR(10),                    
@SAUDA_DATE VARCHAR(11),        
@RPTBY  VARCHAR(1) = 'D'        
)                    
                    
AS                    
        
-- EXEC RPT_CLIENT_SCRIP_DETAIL 'BROKER' , 'BROKER' , 'C69696' , 'C69696', 'SEP 29 2017'          
SELECT @TOCODE = (CASE WHEN @TOCODE = '' AND @FROMCODE <> '' THEN @FROMCODE               
      WHEN @TOCODE = '' AND @FROMCODE = '' THEN 'ZZZZZZZZZZ'              
      ELSE @TOCODE END)               
                  
                            
SELECT                
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),          
PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),              
SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), MARKETVALUE=SUM(MKTAMT), NETVALUE = SUM(NETAMT),               
CL_RATE = CURR_CL_RATE,              
HAIRCUT,              
MTOM_LOSS=SUM(MTOM_LOSS),               
MARG_REQ = SUM(MARGIN_REQ),            
FIN_MARG_REQ = SUM(MARGIN_REQ) + SUM(MTOM_LOSS),               
FLAG='POSITION',         
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),        
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),               
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),            
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),          
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),          
TOT_MTFNONCASHCOLLATERAL = MTFNONCASHCOLLATERAL,          
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),          
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),        
MTFLEDBAL            
INTO #DATA              
FROM TBL_MTF_DATA T, MSAJAG.DBO.CLIENT1 C1              
WHERE SAUDA_DATE = @SAUDA_DATE               
AND C1.CL_CODE = PARTY_CODE              
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE              
AND @STATUSNAME =                        
                  (CASE                        
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                        
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                        
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
                  ELSE                        
                        'BROKER'                        
                  END)                  
AND QTY > 0 AND NETAMT > 0            
GROUP BY PARTY_CODE, LONG_NAME,              
SCRIP_CD, SERIES, BSECODE, ISIN,CURR_CL_RATE,HAIRCUT,MTFNONCASHCOLLATERAL,MTFLEDBAL            
    
    
SELECT PARTY_CODE, LEDBAL = SUM(LEDBAL)     
INTO #LEDBAL    
FROM (    
SELECT PARTY_CODE, LEDBAL = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)    
FROM LEDGER L, PARAMETER P, TBLCLIENTMARGIN T    
WHERE T.PARTY_CODE = L.CLTCODE     
AND @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR     
AND @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE    
AND VDT BETWEEN SDTCUR AND LDTCUR     
AND VDT <= @SAUDA_DATE + ' 23:59:59'    
AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #DATA)    
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE    
GROUP BY PARTY_CODE     
UNION ALL    
SELECT PARTY_CODE, LEDBAL = 0    
FROM TBLCLIENTMARGIN    
WHERE  @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE    
AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #DATA)    
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE ) A    
GROUP BY PARTY_CODE    
    
INSERT INTO #DATA     
SELECT CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),      
PARTY_CODE, LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),          
SCRIP_CD = '', SERIES = '', BSECODE = '', ISIN = '', QTY=0, MARKETVALUE=0, NETVALUE = 0,           
CL_RATE = 0,          
HAIRCUT = 0,          
MTOM_LOSS=0,           
MARG_REQ = 0,        
FIN_MARG_REQ = 0,           
FLAG='POSITION',     
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),    
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),           
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),        
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),      
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),      
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),      
TOT_MTFNONCASHCOLLATERAL = 0,      
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),      
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),    
MTFLEDBAL = LEDBAL       
FROM #LEDBAL , MSAJAG.DBO.CLIENT1 C1     
WHERE #LEDBAL.PARTY_CODE = C1.CL_CODE     
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE          
AND @STATUSNAME =                    
                  (CASE                    
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                    
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                    
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                    
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                    
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                    
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                    
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                    
                  ELSE                    
                        'BROKER'                    
                  END)        
        
INSERT INTO  #DATA        
SELECT               
PROCESSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),        
PARTY_CODE,LONG_NAME, SCRIP_NAME = CONVERT(VARCHAR(100),''),SCRIP_CD,SERIES,BSECODE,ISIN,        
QTY=SUM(QTY),        
MARKETVALUE=SUM(QTY*CL_RATE), NETVALUE = SUM(QTY*CL_RATE - QTY*CL_RATE*HAIRCUT/100),        
CL_RATE,HAIRCUT,MTOM_LOSS=0,        
MARG_REQ = CONVERT(NUMERIC(18,4),0),            
FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),            
FLAG='COLL',         
TOT_FUND_AMT = CONVERT(NUMERIC(18,4),0),        
TOT_MTOM_LOSS = CONVERT(NUMERIC(18,4),0),               
TOT_MARG_REQ = CONVERT(NUMERIC(18,4),0),            
TOT_FIN_MARG_REQ = CONVERT(NUMERIC(18,4),0),          
TOT_MTFCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),          
TOT_MTFCASHEQCOLLATERAL = CONVERT(NUMERIC(18,4),0),          
TOT_MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,4),0),          
TOT_AVAL_COLL_MTF = CONVERT(NUMERIC(18,4),0),          
TOT_EXCESS_SHORT = CONVERT(NUMERIC(18,4),0),        
MTFLEDBAL  = CONVERT(NUMERIC(18,4),0)           
FROM TBL_PRODUCT_HOLD_DATA T, MSAJAG.DBO.CLIENT1 C1              
WHERE SAUDA_DATE = @SAUDA_DATE               
AND C1.CL_CODE = PARTY_CODE              
AND PARTY_CODE BETWEEN @FROMCODE AND @TOCODE              
AND @STATUSNAME =                        
     (CASE                        
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
                        WHEN @STATUSID = 'AREA' THEN C1.AREA                        
                        WHEN @STATUSID = 'REGION' THEN C1.REGION                        
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
                  ELSE                        
                        'BROKER'                        
                  END)              
AND HOLDFLAG = 'MTFCOLL'        
GROUP BY PARTY_CODE,LONG_NAME, SCRIP_CD,SERIES,BSECODE,ISIN,CL_RATE,HAIRCUT        
        
UPDATE #DATA SET TOT_FUND_AMT = T.TOT_FUND_AMT, TOT_MTOM_LOSS = T.TOT_MTOM_LOSS,        
TOT_MARG_REQ = T.TOT_MARG_REQ, TOT_FIN_MARG_REQ = T.TOT_FIN_MARG_REQ,        
TOT_MTFCASHCOLLATERAL = T.TOT_FUND_AMT + T.MTFLEDBAL,         
TOT_AVAL_COLL_MTF = T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL,        
TOT_EXCESS_SHORT = - T.TOT_FIN_MARG_REQ + (T.TOT_FUND_AMT + T.MTFLEDBAL + TOT_MTFNONCASHCOLLATERAL),        
MTFLEDBAL = T.MTFLEDBAL        
FROM (SELECT PARTY_CODE,  TOT_FUND_AMT = SUM(NETVALUE), TOT_MTOM_LOSS = SUM(MTOM_LOSS),        
       TOT_MARG_REQ = SUM(MARG_REQ), TOT_FIN_MARG_REQ = SUM(FIN_MARG_REQ),        
       MTFLEDBAL        
   FROM #DATA WHERE FLAG = 'POSITION'        
   GROUP BY PARTY_CODE,MTFLEDBAL ) T        
WHERE T.PARTY_CODE = #DATA.PARTY_CODE              
              
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM angeldemat.MSAJAG.DBO.SCRIP1 S1, angeldemat.MSAJAG.DBO.SCRIP2 S2                          
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                          
AND S2.SCRIP_CD = #DATA.SCRIP_CD AND S2.SERIES = #DATA.SERIES                          
                          
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM angeldemat.BSEDB.DBO.SCRIP1 S1, angeldemat.BSEDB.DBO.SCRIP2 S2                          
WHERE S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES                          
AND S2.BSECODE = #DATA.BSECODE                         
AND SCRIP_NAME = ''                   
/*        
SELECT PARTY_CODE, BSECODE, ISIN, QTY = SUM(QTY)        
FROM #DATA WHERE EXCHANGE = 'BSE'        
GROUP BY  PARTY_CODE, BSECODE, ISIN        
        
RETURN    */           
  
ALTER TABLE #DATA ADD   
 COMPANYHEADER1 VARCHAR(MAX),  
 COMPANYHEADER2 VARCHAR(MAX),  
 COMPANYHEADER3 VARCHAR(MAX),  
 COMPANYHEADER4 VARCHAR(MAX),  
 COMPANYHEADER5 VARCHAR(MAX),  
 COMPANYHEADER6 VARCHAR(MAX),  
 COMPANYHEADER7 VARCHAR(MAX)  
  
UPDATE #DATA  
SET  COMPANYHEADER1 = 'Corporate Office: '+ Addr1 +' '+ Addr2 +' '+ City +' - '+ Zip + '(India)',  
  COMPANYHEADER2 = 'Visit us at: '+ WEBSITE_ID +'  Phone No: '+ PHONE +' Fax: '+ FAX +' Email: '+ EMAIL,  
  COMPANYHEADER3 = COMMONMEMBERNAME,  
  COMPANYHEADER4 = 'SEBI Regn.No.(BSE/NSE/MSE): '+ COMMONSEBINO +', CIN. No.: '+ CIN,  
  COMPANYHEADER5 = 'SEBI Investment Advisers: '+ SEBI_INV_ADV_NO +' | SEBI Research Analyst: '+ SEBI_RES_ANLY_NO,  
  COMPANYHEADER6 = BR_CMDPID,  
  COMPANYHEADER7 = ''  
FROM MSAJAG.DBO.OWNER  
  
  
UPDATE #DATA SET PARTY_CODE = UPPER(LTRIM(RTRIM(PARTY_CODE)))  
  
SELECT   
 PROCESSDATE,PARTY_CODE,LONG_NAME,SCRIP_NAME,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,        
 TRADE_VALUE=MARKETVALUE,FUNDED_VALUE=NETVALUE,CL_RATE,MARKET_VALUE=CL_RATE*QTY,HAIRCUT,        
 MARG_REQ=-MARG_REQ,MTOM_LOSS=-MTOM_LOSS,FIN_MARG_REQ=-FIN_MARG_REQ,        
 FLAG,         
 MTFLEDBAL,        
 TOT_FUND_AMT,        
 TOT_MTOM_LOSS=-TOT_MTOM_LOSS,               
 TOT_MARG_REQ=-TOT_MARG_REQ,            
 TOT_FIN_MARG_REQ=-TOT_FIN_MARG_REQ,          
 TOT_MTFCASHCOLLATERAL,          
 TOT_MTFCASHEQCOLLATERAL,          
 TOT_MTFNONCASHCOLLATERAL,          
 TOT_AVAL_COLL_MTF,          
 TOT_EXCESS_SHORT,        
 OPENDAY='-',  
 FILENAME='MTF_'+PARTY_CODE+'_'+CONVERT(VARCHAR,CONVERT(DATETIME,PROCESSDATE,103),112),  
 COMPANYHEADER1 = ISNULL(COMPANYHEADER1,''),  
 COMPANYHEADER2 = ISNULL(COMPANYHEADER2,''),  
 COMPANYHEADER3 = ISNULL(COMPANYHEADER3,''),  
 COMPANYHEADER4 = ISNULL(COMPANYHEADER4,''),  
 COMPANYHEADER5 = ISNULL(COMPANYHEADER5,''),  
 COMPANYHEADER6 = ISNULL(COMPANYHEADER6,''),  
 COMPANYHEADER7 = ISNULL(COMPANYHEADER7,'')  
FROM #DATA    
WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #DATA  
         WHERE ABS(MTFLEDBAL) > 0 OR ABS(TOT_FUND_AMT) > 0   
         OR ABS(TOT_AVAL_COLL_MTF) > 0 OR ABS(TOT_FIN_MARG_REQ) > 0   
         OR ABS(TOT_MTFCASHCOLLATERAL) > 0 OR ABS(TOT_EXCESS_SHORT) > 0)                        
ORDER BY   
 PARTY_CODE,   
 FLAG DESC,   
 SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTMFUND
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_CLIENTMFUND]   
(        
 @STATUSID VARCHAR(50),        
 @STATUSNAME VARCHAR(50),        
 @FROMDATE VARCHAR(11),        
 @TODATE  VARCHAR(11),        
 @FROMPARTY VARCHAR(10),        
 @TOPARTY VARCHAR(10),        
 @FROMSCRIP VARCHAR(12)='',        
 @TOSCRIP VARCHAR(12)='',        
 @OPT VARCHAR(20)=''      
)       
AS  
  
SET @TOPARTY = (CASE WHEN @TOPARTY = '' THEN 'ZZZZZZZZZZ' ELSE @TOPARTY END)  
  
SELECT [CLIENT CODE] = CL_CODE, [CLIENT NAME]=LONG_NAME, 
[ENTRY DATE] = CONVERT(VARCHAR,ENTERED_DATE,103), [NETWORTH IN AMOUNT] = MARGIN_FUNDING, [DOCUMENT TYPE] = DOC_TYPE,   
[FY FOR DOCUMENT] = FY_DOC, [SANTIONED AMOUNT] = CONVERT(NUMERIC(18,0), SANCTIONED_AMT), [MAX PERMISSIBLE AMOUNT FOR SINGLE SCRIP] = MAX_AMT,  
[INTEREST %] = MARGIN_INTEREST, [MINIMUM COVER %] = MIN_COVER, [FROM DATE] = CONVERT(VARCHAR,FROM_DATE,103), [TO DATE] = CONVERT(VARCHAR,TO_DATE,103),   
[SPECIAL REMARKS]=REMARKS, [AUTO RMS SELLING] = AUTO_RMS,
[BRANCH_CD], [SUB_BROKER], [FAMILY]
FROM TBLCLIENTMARGIN T, MSAJAG.DBO.CLIENT1 C1  
WHERE C1.CL_CODE = T.PARTY_CODE  
AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
AND FROM_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
AND @STATUSNAME =  
                  (CASE  
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION  
                        WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE  
                  ELSE  
                        'BROKER'  
                  END)  
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FRESH_BUY_VALUE
-- --------------------------------------------------
CREATE PROCEDURE RPT_FRESH_BUY_VALUE (
@STATUSID VARCHAR(50),@STATUSNAME VARCHAR(50),
@FDATE VARCHAR(11),@TDATE VARCHAR(11),
@FROMPARTY VARCHAR (10),@TOPARTY VARCHAR (10),
@FROMSCRIP VARCHAR(50),@TOSCRIP VARCHAR(50),@OPT VARCHAR(11)
)

AS ---- EXEC RPT_FRESH_BUY_VALUE 'OCT 20 2021','OCT 31 2021'

SELECT [Trade Date]=SAUDA_DATE,[Fresh Buy Value in Rs.]=SUM(FRESHBUY) FROM dbo.TBL_NSE_REPORTING WITH (NOLOCK)
WHERE SAUDA_DATE BETWEEN @FDATE AND @TDATE + ' 23:59'
GROUP BY SAUDA_DATE
ORDER BY SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MTF_FUNDING_CLIENT
-- --------------------------------------------------


 
CREATE procedure [dbo].[RPT_MTF_FUNDING_CLIENT]       
as      
      
      
Begin      
      
declare @recordCount int  
DECLARE
    @tab char(1) = CHAR(9)
    
      
      
select @recordCount = isnull(count(*), 0)      
FROM MTFTRADE.DBO.TBL_MTF_DATA  
WHERE SAUDA_DATE = (SELECT MAX(SAUDA_DATE)FROM MTFTRADE.DBO.TBL_MTF_DATA ) 

      
      
       
   
      
      
      
IF (@recordCount > 0)      
begin      
      
      
      
EXEC msdb.dbo.sp_send_dbmail      
    @profile_name = 'CLASS AUTO PROCESS TEST Profile',      
    @recipients = 'suresh.bamanikar@MKTTECH.IN',      
    @query = 'SELECT  top 50 PARTY_CODE, SAUDA_DATE,LONG_NAME,  
    MTF_REQ   = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL),  
    CMBALANCE = CMOPENPOS+CMDEBITHOLD-SELLSHORT+CMCASHCOLLATERAL+CMCASHEQCOLLATERAL+CMNONCASHCOLLATERAL+CMLEDBAL,  
    FOBALANCE = FOLEDBAL+FOCASHCOLLATERAL+FOCASHEQCOLLATERAL+FONONCASHCOLLATERAL-FOMARGIN,  
    CMDEBITHOLD = CMDEBITHOLD,CMDEBITHOLD_APP = CMDEBITHOLD_MTF,  
    MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,  
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,CMNONCASHCOLLATERAL_APP=CMNONCASHCOLLATERAL_MTF,  
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FONONCASHCOLLATERAL_APP = FONONCASHCOLLATERAL_MTF,  
  FOCASHEQCOLLATERAL,FOMARGIN,POAHOLDING, POAHOLDING_APP = POAHOLDING_MTF,  
    CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,   
    NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)  
       + CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ  

FROM MTFTRADE.DBO.TBL_MTF_DATA M, MSAJAG.DBO.CLIENT1 C1  
WHERE SAUDA_DATE = (SELECT MAX(SAUDA_DATE)FROM MTFTRADE.DBO.TBL_MTF_DATA ) 
--AND PARTY_CODE BETWEEN ''0000'' AND ''ZZZZ''
AND C1.CL_CODE = PARTY_CODE  
        
GROUP BY PARTY_CODE,SAUDA_DATE,LONG_NAME,MTFLEDBAL,MTFCASHCOLLATERAL,MTFCASHEQCOLLATERAL,MTFNONCASHCOLLATERAL,  
    CMCASHCOLLATERAL,CMCASHEQCOLLATERAL,CMNONCASHCOLLATERAL,  
    CMLEDBAL,FOLEDBAL,FOCASHCOLLATERAL,FONONCASHCOLLATERAL,FOCASHEQCOLLATERAL,FOMARGIN,   
    POAHOLDING,CASHDEBITADJ, CASHNONCASHADJ, FONONCASHADJ, CASHLEDADJ, FOLEDBALADJ, POAADJ,  
  CMOPENPOS,CMDEBITHOLD,SELLSHORT,POAHOLDING_MTF,CMNONCASHCOLLATERAL_MTF,FONONCASHCOLLATERAL_MTF,CMDEBITHOLD_MTF' ,      
      
      @subject = 'MTF SUMMARY REPORT ',      
       @Body = 'MTF SUMMARY REPORT..... ' ,      
    @attach_query_result_as_file = 1 ,  
    @query_attachment_filename= 'Report.PDF' ,
    @query_result_separator= @tab ,
    @query_result_header = 1,
    @query_result_no_padding=1;
 
      
End      
else      
begin      
      
      EXEC msdb.dbo.sp_send_dbmail      
      @profile_name = 'CLASS AUTO PROCESS TEST Profile',      
       @recipients = 'suersh.bamanikar@MKTTECH.IN',       
            @BODY = 'No data returned ',       
            @subject = 'MTF SUMMARY REPORT'      
      
End      
End;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MTF_SUMMARY
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_MTF_SUMMARY] 
(
	@STATUSID	VARCHAR(50),
	@STATUSNAME	VARCHAR(50),
	@FROMDATE	VARCHAR(11),
	@TODATE	VARCHAR(11),
	@FROMPARTY	VARCHAR(10),
	@TOPARTY	VARCHAR(10)
)
AS

-- EXEC RPT_MTF_SUMMARY 'BROKER', 'BROKER', 'AUG 11 2017','AUG 11 2017', '0', 'ZZZZZZ'

set @fromdate = convert(datetime, @fromdate,103)
set @TODATE = convert(datetime, @TODATE,103)


SELECT M.* INTO #TBL_MTF_DATA
FROM TBL_MTF_DATA M, MSAJAG.DBO.CLIENT_DETAILS C1
WHERE SAUDA_DATE BETWEEN @FROMDATE AND @TODATE
AND m.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = m.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)  
	  
UPDATE #TBL_MTF_DATA SET MTOM_LOSS = -MTOM_LOSS
WHERE SAUDA_DATE > 'NOV 27 2019'

SELECT SAUDA_DATE, T.PARTY_CODE, PARTY_NAME=LONG_NAME,
BRANCH_cD,SUB_BROKER,
FUDEDVAL = SUM(NETAMT), 
MTOM = SUM(MTOM_LOSS), 
MARGIN_REQ = SUM(MARGIN_REQ),
MTFLEDBAL,  
AVALABLECASH = MTFLEDBAL + SUM(NETAMT),
COLLATERALBHC = CONVERT(NUMERIC(18,4),0),
COLLATERALAHC = CONVERT(NUMERIC(18,4),0),
MARGIN_SHORTFALL = CONVERT(NUMERIC(18,4),0)
INTO #DATA
FROM  #TBL_MTF_DATA T, MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)
WHERE SAUDA_DATE BETWEEN @FROMDATE AND @TODATE
AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = T.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)  
GROUP BY SAUDA_DATE, T.PARTY_CODE, LONG_NAME,
BRANCH_cD,SUB_BROKER, MTFLEDBAL

INSERT INTO #DATA
SELECT SAUDA_DATE, T.PARTY_CODE, PARTY_NAME=LONG_NAME,
BRANCH_cD,SUB_BROKER, 
FUDEDVAL =  CONVERT(NUMERIC(18,4),0),
MTOM =  CONVERT(NUMERIC(18,4),0),
MARGIN_REQ =  CONVERT(NUMERIC(18,4),0),
MTFLEDBAL = CONVERT(NUMERIC(18,4),0),  
AVALABLECASH =  CONVERT(NUMERIC(18,4),0),
COLLATERALBHC = SUM(QTY*CL_RATE),
COLLATERALAHC = SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100), 
MARGIN_SHORTFALL = CONVERT(NUMERIC(18,4),0)
FROM TBL_PRODUCT_HOLD_DATA T, MSAJAG.DBO.CLIENT_DETAILS C1 (NOLOCK)
WHERE SAUDA_DATE BETWEEN @FROMDATE AND @TODATE
AND HOLDFLAG = 'MTFCOLL'
AND T.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND C1.CL_CODE = T.PARTY_CODE
AND @STATUSNAME =                         
      (CASE                         
      WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD                        
      WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER                        
      WHEN @STATUSID = 'TRADER' THEN C1.TRADER                        
      WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                        
      WHEN @STATUSID = 'AREA' THEN C1.AREA                        
      WHEN @STATUSID = 'REGION' THEN C1.REGION                        
      WHEN @STATUSID = 'CLIENT' THEN C1.CL_CODE                        
      ELSE                         
      'BROKER'                        
      END)  
GROUP BY SAUDA_DATE,T.PARTY_CODE, LONG_NAME,
BRANCH_cD,SUB_BROKER

SELECT REPORTDATE=CONVERT(VARCHAR,SAUDA_DATE,103),
PARTY_CODE, PARTY_NAME,
BRANCH_cD,SUB_BROKER,
FUDEDVAL = SUM(FUDEDVAL),
MTOM = SUM(MTOM),
MARGIN_REQ=SUM(MARGIN_REQ),
FUDEDVALAFM = SUM(FUDEDVAL)+SUM(MTOM)-SUM(MARGIN_REQ),
MTFLEDBAL = SUM(MTFLEDBAL),
AVALABLECASH=SUM(AVALABLECASH),
COLLATERALBHC=SUM(COLLATERALBHC),
COLLATERALAHC=SUM(COLLATERALAHC),
MARGIN_SHORTFALL= SUM(MTOM)-SUM(MARGIN_REQ) + SUM(AVALABLECASH) + SUM(COLLATERALAHC),
ORDERBYDATE=SAUDA_DATE 
FROM #DATA 
GROUP BY PARTY_CODE, PARTY_NAME,
BRANCH_cD,SUB_BROKER,SAUDA_DATE
ORDER BY PARTY_CODE,ORDERBYDATE

DROP TABLE #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MTR_MTFFILE_NEW
-- --------------------------------------------------








CREATE PROC [dbo].[RPT_MTR_MTFFILE_NEW]      
(      
	@SAUDA_DATE VARCHAR(11),
	@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = ''      
)      
AS      

/*
DELETE FROM ASIANFILEBATCHNO WHERE fldFileDate LIKE 'JAN  8 2021%'
EXEC [RPT_MTR_MTFFILE_NEW] 'FEB  3 2025'  
*/
DECLARE @PREVDATE	VARCHAR(11),     
		@BATCHNO	INT,
		@SDTCUR		DATETIME,
		@LDTCUR		DATETIME,
		@NONFNO		INT,
		@FNO		INT,
		@EDT		DATETIME
      
SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR  

SELECT	@EDT = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND SETT_TYPE = 'N'

SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'    
AND FLDFILEDATE = @SAUDA_DATE  

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY,      
FRESHBUY,      
FRESHSQTY,    
FRESHSELL,
NETQTY,      
NETAMOUNT,
M_BODQTY,
M_BODVALUE,
M_FRESHBQTY,
M_FRESHBUY,
M_FRESHSQTY,
M_FRESHSELL,
M_NETQTY,
M_NETAMOUNT,
EXCHANGE,
ISIN 
INTO #NSERPT
FROM TBL_MTR_REPORTING P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0 
--and scrip_cd='LAURUSLABS'

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

	ALTER	TABLE #NSERPT
	ADD		VARMARGIN		NUMERIC(18,4),
			HAIRCUT			NUMERIC(18,4),
			EXPOSURE_AMT	NUMERIC(18,4),
			EXPOSURE_QTY	INT,
			CORP_QTY		INT


	UPDATE	#NSERPT
	SET		VARMARGIN = 0,
			HAIRCUT = 0,
			EXPOSURE_QTY = 0,
			CORP_QTY = 0

	SELECT	@NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER
	WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL C
	WHERE C.RECDATE >= @SAUDA_DATE aND c.REcDATE <= @SAUDA_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES NOT IN ('BO')
	AND ISIN IN (SELECT DISTINCT ISIN FROM #NSERPT)

	SELECT V.* INTO  #BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	WHERE V.FDATE >= @SAUDA_DATE aND v.FDATE <= @SAUDA_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #NSERPT)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )

    UPDATE	#NSERPT 
    SET		VARMARGIN = M.APPVAR,
			--HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.APPVAR + @FNO * SECSPECVAR ELSE M.APPVAR + @NONFNO * SECSPECVAR END)
			HAIRCUT = M.APPVAR + @NONFNO * SECSPECVAR
    FROM	#B_NSE_VAR M
    WHERE	M.ISIN = #NSERPT.ISIN 
	AND		HAIRCUT = 0

	UPDATE	#NSERPT 
	SET		VARMARGIN = M.MARGIN,
			--HAIRCUT = (CASE WHEN FOFLAG = 1 THEN M.MARGIN + 3 * ELM ELSE M.MARGIN + 5 * ELM END)
			HAIRCUT = M.MARGIN + @NONFNO * ELM
	FROM	#B_BSE_VAR M
	WHERE	M.ISIN = #NSERPT.ISIN 
	AND		HAIRCUT = 0

	/** --- NEW CHANGES DONE ON 09/07/2025 --- **/
	
	UPDATE	#NSERPT 
	SET		EXPOSURE_AMT = (M_FRESHBUY-(M_FRESHBUY/100*VARMARGIN))/HAIRCUT*100
	WHERE	M_FRESHBQTY > 0 AND M_FRESHBUY > 0
			

	UPDATE	#NSERPT 
	SET		EXPOSURE_QTY = FLOOR(EXPOSURE_AMT/(M_FRESHBUY/M_FRESHBQTY))
	WHERE	M_FRESHBQTY > 0 AND M_FRESHBUY > 0

	/** --- NEW CHANGES DONE ON 09/07/2025 --- **/


	/** --- NEW CHANGES DONE ON 12/07/2025 FOR CA PROCESS --- **/

	UPDATE	#NSERPT 
	SET		CORP_QTY = ISNULL(P.QTY,0)-(#NSERPT.BODQTY)
	FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
	WHERE	P.SAUDA_DATE = @SAUDA_DATE 
			AND P.PARTY_CODE = #NSERPT.PARTY_CODE
			AND P.SCRIP_CD = #NSERPT.SCRIP_CD
			AND P.ISIN = #NSERPT.ISIN
			AND ADDED_BY IN ('SPLIT','BONUS')
			AND ISNULL(P.QTY,0) > 0
			AND #NSERPT.BODQTY > 0

	/** --- NEW CHANGES DONE ON 09/07/2025 --- **/


INSERT INTO ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' 
+ CONVERT(VARCHAR,COUNT(1)) 
+',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMOUNT),2))) 
+',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(M_FRESHBUY),2)))
+',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMOUNT-M_FRESHBUY),2)))
FROM #NSERPT    
GROUP BY MEMBERCODE  
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMOUNT-M_FRESHBUY),2)))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + 
LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + 
LTRIM(RTRIM(UPPER(SERIES))) +',' +   
LTRIM(RTRIM(UPPER(ISIN))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(BODVALUE),2))) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(FRESHBUY),2))) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(FRESHSELL),2))) + ','  +     
CONVERT(VARCHAR,SUM(CORP_QTY)) + ',' + ---Corporate action Quantity
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(BODVALUE + FRESHBUY - FRESHSELL),2))) + ',' + 
CONVERT(VARCHAR,SUM(M_FRESHBQTY)) + ',' +
CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(M_FRESHBUY),2))) + ',' +
CONVERT(VARCHAR,SUM(NETQTY-M_FRESHBQTY)) + ',' +
--CONVERT(VARCHAR,SUM((CASE WHEN M_FRESHBQTY > 0 THEN (NETQTY-M_FRESHBQTY) ELSE 0 END))) + ',' +   
CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM((BODVALUE + FRESHBUY - FRESHSELL)-(M_FRESHBUY)),2))) + ',' +
--CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASE WHEN M_FRESHBQTY > 0 THEN (BODVALUE + FRESHBUY - FRESHSELL)-(M_FRESHBUY) ELSE 0 END),2))) + ',' +     
--CONVERT(VARCHAR,SUM((CASE WHEN M_FRESHBQTY > 0 THEN (NETQTY-M_FRESHBQTY) ELSE 0 END))) + ',' + 'N,'+ RIGHT(EXCHANGE,3)
--CONVERT(VARCHAR,SUM((CASE WHEN M_FRESHBQTY > 0 THEN (EXPOSURE_QTY) ELSE 0 END))) 
CONVERT(VARCHAR,PRADNYA.DBO.FNMIN(SUM(NETQTY-M_FRESHBQTY),SUM((CASE WHEN M_FRESHBQTY > 0 THEN (EXPOSURE_QTY) ELSE 0 END)))) 
+ ',' + 'N,'+ RIGHT(EXCHANGE,3)
FROM #NSERPT    
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO, RIGHT(EXCHANGE,3), LTRIM(RTRIM(UPPER(ISIN))) 

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD, SERIES, QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG = (CASE WHEN SERIES = 'BSE' OR SERIES = '' THEN 'BSE' ELSE 'NSE' END),
CASHCOLL = CONVERT(NUMERIC(18,2),0),
ISIN = ISNULL(H.ISIN,''),
CASH_EQV_FLAG = 0
INTO #HOLD
FROM TBL_PRODUCT_HOLD_DATA H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE  
AND   HOLDFLAG = 'MTFCOLL'
AND SETT_NO <> 'BSE'
AND h.pARTY_cODE iN ( SELECT PARTY_CODE FROM #NSERPT WHERE NETQTY > 0 )
AND   C.CL_CODE = H.PARTY_CODE
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES, ISNULL(H.ISIN,'')

DELETE FROM #HOLD WHERE SCRIP_CD=''

if convert(datetime,@sauda_date) = convert(datetime,'apr  2 2019')
begin
	TRUNCATE TABLE #HOLD
	INSERT INTO #HOLD
	SELECT H.PARTY_CODE, LONG_NAME, 
	PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
	SCRIP_CD, SERIES, QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
	CAT = 'N', EXCHG = (CASE WHEN SERIES = 'BSE' OR SERIES = '' THEN 'BSE' ELSE 'NSE' END),
	CASHCOLL = CONVERT(NUMERIC(18,2),0),
	ISIN = ISNULL(H.ISIN,'')
	FROM TBL_PRODUCT_HOLD_DATA_PROV H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
	WHERE SAUDA_DATE = @SAUDA_DATE   
	AND SETT_NO <> 'BSE'
	AND H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT WHERE NETQTY > 0 )
	AND   C.CL_CODE = H.PARTY_CODE
	GROUP BY H.PARTY_CODE, LONG_NAME, 
	PAN_GIR_NO, SCRIP_CD, SERIES, ISNULL(H.ISIN,'')
end

--UPDATE	#HOLD 
--SET		CASH_EQV_FLAG = 1
--FROM	MSAJAG..TBL_LIQUID_SCRIP S (NOLOCK)
--WHERE	LTRIM(RTRIM(S.ISIN)) = LTRIM(RTRIM(#HOLD.ISIN))
--		AND @SAUDA_DATE BETWEEN EFF_FROM_DATE AND EFF_TO_DATE 

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0 
								  THEN SUM(NETAMT) + MTFLEDBAL
								  ELSE 0
						     END),
				   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,2),0)
INTO #COLLCASH
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

INSERT INTO #COLLCASH
SELECT DISTINCT PARTY_CODE, CASHCOLL = 0, MTFNONCASHCOLLATERAL = 0 FROM #HOLD
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #COLLCASH WHERE #COLLCASH.PARTY_CODE = #HOLD.PARTY_CODE)

UPDATE #COLLCASH SET MTFNONCASHCOLLATERAL = NONCASH
FROM (SELECT PARTY_CODE, NONCASH = SUM(AMOUNT)
	  FROM #HOLD
	  GROUP BY PARTY_CODE) C
WHERE C.PARTY_CODE = #COLLCASH.PARTY_CODE

/*
UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE
*/


SELECT	PARTY_CODE, 
		CASHCOLL_AMT=CONVERT(NUMERIC(18,2),(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0 
				THEN SUM(NETAMT) + MTFLEDBAL
				ELSE 0
			END)),
		CASHPAYIN_AMT = CONVERT(NUMERIC(18,4),0),
		COLL_CASH_EQV_AMT = CONVERT(NUMERIC(18,4),0),
		COLL_CASH_NONEQV_AMT = CONVERT(NUMERIC(18,4),0)
INTO	#CASHCOLLBAL
FROM	TBL_MTF_DATA
WHERE	SAUDA_DATE = @SAUDA_DATE 
		AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY
		PARTY_CODE, MTFLEDBAL


--INSERT	INTO #CASHCOLLBAL
--SELECT	CLTCODE, 
--		CASHCOLL_AMT = CONVERT(NUMERIC(18,2),SUM(L.VAMT)),
--		CASHPAYIN_AMT = CONVERT(NUMERIC(18,2),0),
--		COLL_CASH_EQV_AMT = CONVERT(NUMERIC(18,2),0),
--		COLL_CASH_NONEQV_AMT = CONVERT(NUMERIC(18,2),0)
--FROM	MTF_CASH_COLL_LEDGER L(NOLOCK)
--WHERE	L.VDT BETWEEN @SDTCUR AND @LDTCUR 
--		AND L.VDT <= @PREVDATE + ' 23:59:59' 
--		AND DRCR = 'C'
--		AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
--GROUP BY
--		CLTCODE


--INSERT	INTO #CASHCOLLBAL
--SELECT	CLTCODE, 
--		CASHCOLL_AMT = CONVERT(NUMERIC(18,4),0),
--		CASHPAYIN_AMT = CONVERT(NUMERIC(18,4),SUM(CASE WHEN DRCR='C' THEN L.VAMT ELSE -L.VAMT END)),
--		COLL_CASH_EQV_AMT = CONVERT(NUMERIC(18,4),0),
--		COLL_CASH_NONEQV_AMT = CONVERT(NUMERIC(18,4),0)
--FROM	MTF_CASH_PAYIN_LEDGER L(NOLOCK)
--WHERE	L.VDT BETWEEN @SDTCUR AND @LDTCUR 
--		AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
--		AND L.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' 
--		AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
--		AND NARRATION = 'MTF PAYIN'
--GROUP BY
--		CLTCODE


INSERT	INTO #CASHCOLLBAL
SELECT	PARTY_CODE, 
		CASHCOLL_AMT = CONVERT(NUMERIC(18,4),0),
		CASHPAYIN_AMT = SUM(M_FRESHBUY),
		COLL_CASH_EQV_AMT = CONVERT(NUMERIC(18,4),0),
		COLL_CASH_NONEQV_AMT = CONVERT(NUMERIC(18,4),0)
FROM	TBL_MTR_REPORTING L(NOLOCK)
WHERE	SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' 
		AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)
		AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0
GROUP BY
		PARTY_CODE


--SELECT	CLTCODE, 
--		CASHCOLL_AMT = CONVERT(NUMERIC(18,4),0),
--		CASHPAYIN_AMT = CONVERT(NUMERIC(18,4),SUM(CASE WHEN DRCR='C' THEN L.VAMT ELSE -L.VAMT END)),
--		COLL_CASH_EQV_AMT = CONVERT(NUMERIC(18,4),0),
--		COLL_CASH_NONEQV_AMT = CONVERT(NUMERIC(18,4),0)
--FROM	MTF_CASH_PAYIN_LEDGER L(NOLOCK)
--WHERE	L.VDT BETWEEN @SDTCUR AND @LDTCUR 
--		AND L.VDT <= @SAUDA_DATE + ' 23:59:59' 
--		AND L.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' 
--		AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
--		AND NARRATION = 'MTF PAYIN'
--GROUP BY
--		CLTCODE


SELECT	PARTY_CODE,
		PAYIN_AMT = SUM(PAYIN_AMT)
INTO	#PAYIN_COLL
FROM	(
		SELECT	PARTY_CODE = CLTCODE, 
				PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0)
		FROM	LEDGER P(NOLOCK)
		WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
				AND P.VDT <= @SAUDA_DATE + ' 23:59' 
				AND P.VTYP = '66'
				AND P.EDT BETWEEN @SDTCUR AND @EDT + ' 23:59'
		GROUP BY
				CLTCODE

		UNION

		SELECT	PARTY_CODE = CLTCODE, 
				PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0)
		FROM	LEDGER P(NOLOCK)
		WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
				AND P.VDT <= @SAUDA_DATE + ' 23:59' 
				AND P.VTYP = '67'
				AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59'
		GROUP BY
				CLTCODE
		) A
GROUP BY
		PARTY_CODE


INSERT	INTO #CASHCOLLBAL
SELECT	PARTY_CODE, 
		CASHCOLL_AMT = CONVERT(NUMERIC(18,4),0),
		CASHPAYIN_AMT = CONVERT(NUMERIC(18,4),0),
		COLL_CASH_EQV_AMT = CONVERT(NUMERIC(18,4),SUM(CASE WHEN CASH_EQV_FLAG=1 THEN L.AMOUNT ELSE 0 END)),
		COLL_CASH_NONEQV_AMT = CONVERT(NUMERIC(18,4),SUM(CASE WHEN CASH_EQV_FLAG=0 THEN L.AMOUNT ELSE 0 END))
FROM	#HOLD L(NOLOCK)
GROUP BY
		PARTY_CODE


SELECT	PARTY_CODE, 
		CASHCOLL_AMT = SUM(CASHCOLL_AMT),
		CASHPAYIN_AMT = SUM(CASHPAYIN_AMT),
		COLL_CASH_EQV_AMT = SUM(COLL_CASH_EQV_AMT),
		COLL_CASH_NONEQV_AMT = SUM(COLL_CASH_NONEQV_AMT)
INTO	#CASHCOLLBAL_NEW
FROM	#CASHCOLLBAL
GROUP BY
		PARTY_CODE


UPDATE	#CASHCOLLBAL_NEW
SET		CASHCOLL_AMT = CASHCOLL_AMT + ISNULL(#PAYIN_COLL.PAYIN_AMT,0)
FROM	#PAYIN_COLL
WHERE	#CASHCOLLBAL_NEW.PARTY_CODE = #PAYIN_COLL.PARTY_CODE


--SELECT * FROM #CASHCOLLBAL_NEW WHERE PARTY_CODE='YNR0507'
--ORDER BY PARTY_CODE


INSERT	INTO #REPORT  
SELECT	DATA = '40' 
		+ ',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASHCOLL_AMT),2)))
		+ ',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(COLL_CASH_EQV_AMT),2)))
		+ ',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(COLL_CASH_NONEQV_AMT),2)))
FROM	#CASHCOLLBAL_NEW C(NOLOCK)


/*
INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(MTFNONCASHCOLLATERAL) 
	FROM   #COLLCASH
	GROUP BY PARTY_CODE, CASHCOLL
) A
*/

INSERT INTO #REPORT  
SELECT DATA = '50,' 
+ REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') 
+ ',' + PAN_GIR_NO 
+ ',' + SCRIP_CD 
+ ',' + SERIES 
+ ',' + LTRIM(RTRIM(UPPER(ISIN))) 
+ ',' + CONVERT(VARCHAR,QTY) 
+ ',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(AMOUNT,2)))
+ ',' + CAT 
+ ',' + EXCHG
FROM #HOLD


INSERT INTO #REPORT  
SELECT DATA = '60,' 
+ REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') 
+ ',' + PAN_GIR_NO 
+ ',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASHCOLL_AMT),2))) 
+ ',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASHPAYIN_AMT),2)))
+ ',' + CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(CASHCOLL_AMT-CASHPAYIN_AMT),2))) 
FROM	#CASHCOLLBAL_NEW C, MSAJAG..CLIENT_DETAILS CD(NOLOCK)
WHERE	C.PARTY_CODE = CD.CL_CODE
GROUP BY
		REPLACE(LTRIM(RTRIM(LONG_NAME)),',',''),
		PAN_GIR_NO
HAVING	SUM(CASHCOLL_AMT+CASHPAYIN_AMT) <> 0


INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
				+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
DATA = LTRIM(RTRIM((DATA))) FROM #REPORT    
ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE
-- --------------------------------------------------
  
CREATE PROC [dbo].[RPT_NSE_MTFFILE]        
(        
 @SAUDA_DATE VARCHAR(11),  
 @FLAG  INT = 0,  
 @party_code varchar(10) = ''        
)        
AS        
-- EXEC RPT_NSE_MTFFILE 'SEP  5 2017', 1      
DECLARE @PREVDATE VARCHAR(11),       
  @BATCHNO INT      
        
select @BATCHNO = 0      
      
select @BATCHNO = ISNULL(max(fldbatchno),0) from AsianFileBatchNo      
where fldfileno = 'MT'      
and fldfiledate = @SAUDA_DATE      
/*      
insert into asianfilebatchno      
select 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()      
      
SET @BATCHNO = @BATCHNO + 1      
*/      
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM         
VW_MTF_POSITION WHERE SAUDA_DATE < @SAUDA_DATE        
  
  
IF @FLAG = 1   
BEGIN  
        
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,      
BODQTY = 0,      
BODVALUE =CONVERT(NUMERIC(18,2),0),       
FRESHBQTY = SUM(QTY),       
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),        
FRESHSQTY = 0,      
FRESHSELL = CONVERT(NUMERIC(18,2),0),        
NETAMOUNT = CONVERT(NUMERIC(18,2),0)         
INTO #DATA        
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE SAUDA_DATE = @SAUDA_DATE         
AND ADJUST_DATE >= @SAUDA_DATE        
AND SELL_BUY = 1         
AND C.CL_CODE = P.PARTY_CODE        
AND TRANSTYPE = 'TRNSE'       
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)  
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES        
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0   
  
INSERT INTO #DATA        
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,       
BODQTY = 0,      
BODVALUE =CONVERT(NUMERIC(18,2),0),      
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),      
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT)),        
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE SAUDA_DATE <= @SAUDA_DATE         
AND ADJUST_DATE = @SAUDA_DATE        
AND SELL_BUY = 1         
AND C.CL_CODE = P.PARTY_CODE        
AND TRANSTYPE = 'TRNSE'    
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)  
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES        
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0   
  
/*        
INSERT INTO #DATA         
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,      
BODQTY = SUM(QTY),      
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),       
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,      
FRESHSELL = CONVERT(NUMERIC(18,2),0),        
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM VW_MTF_POSITION     
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE SAUDA_DATE < @SAUDA_DATE  
AND ADJUST_DATE >= @SAUDA_DATE       
AND SELL_BUY = 1         
AND C.CL_CODE = P.PARTY_CODE        
AND SETT_TYPE IN ('A', 'N', 'W')        
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)  
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES        
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0   
*/  
  
INSERT INTO #DATA         
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,      
BODQTY = SUM(NETQTY),      
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMOUNT) ),       
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,      
FRESHSELL = CONVERT(NUMERIC(18,2),0),        
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM TBL_NSE_REPORTING     
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE SAUDA_DATE = @PREVDATE  
AND C.CL_CODE = P.PARTY_CODE           
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)  
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES        
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0   
  
SELECT * INTO #VAR FROM MSAJAG.DBO.VarDetail   
WHERE DETAILKEY = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')  
  
UPDATE #DATA SET SERIES = V.SERIES FROM #VAR V  
WHERE V.SCRIP_CD = #DATA.SCRIP_CD  
AND V.SERIES IN ('EQ','BE','BZ')  
AND #DATA.SERIES IN ('EQ','BE','BZ')  
  
SELECT DISTINCT SCRIP_CD, SERIES=MAX(SERIES) INTO #SCRSER FROM #DATA  
GROUP BY SCRIP_CD   
  
UPDATE #DATA SET SERIES = S.SERIES FROM #SCRSER S  
WHERE #DATA.SCRIP_CD = S.SCRIP_CD  
  
SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES=MAX(SERIES), PARTY_CODE, LONG_NAME,      
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA       WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)  
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, PARTY_CODE    
  
UPDATE #DATAFINAL SET NETAMOUNT = 0  
WHERE NETQTY = 0   
  
/*  
SELECT * FROM #DATAFINAL  
  
UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0     
          THEN FRESHBQTY - FRESHSQTY    
          ELSE 0    
           END),    
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0     
          THEN FRESHBUY - FRESHSELL    
          ELSE 0    
           END),    
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0     
          THEN FRESHSQTY - FRESHBQTY    
          ELSE 0    
           END),    
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0     
          THEN FRESHSELL - FRESHBUY    
          ELSE 0    
           END)    
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0     
    
DELETE FROM #DATAFINAL    
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0    
*/    
  
 DELETE FROM TBL_NSE_REPORTING  
 WHERE SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE)  
 AND party_code = (case when @party_code = '' then party_code else @party_code end)  
  
 INSERT INTO TBL_NSE_REPORTING  
 SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),  
 PARTY_CODE, SCRIP_CD, SERIES,      
 BODQTY = SUM(BODQTY),      
 BODVALUE = SUM(BODVALUE),         
 FRESHBQTY = SUM(FRESHBQTY),      
 FRESHBUY = SUM(FRESHBUY),       
 FRESHSQTY = SUM(FRESHSQTY),      
 FRESHSELL = SUM(FRESHSELL),         
 NETQTY = SUM(NETQTY),      
 NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),  
 PROCESSDATE = GETDATE()    
 FROM #DATAFINAL        
 GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
 ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
   
 UPDATE  TBL_NSE_REPORTING SET FRESHSELL = FRESHSELL + NETAMOUNT, NETAMOUNT = 0  
 WHERE SAUDA_DATE = @SAUDA_DATE AND NETQTY = 0 AND NETAMOUNT <> 0  
   
END  
  
ELSE  
BEGIN                                       
 CREATE TABLE #REPORT      
 (      
  SNO INT IDENTITY(1,1),      
  DATA VARCHAR(5000)      
 )     
          
 SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),        
 MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,      
 BODQTY,      
 BODVALUE,       
 FRESHBQTY,        
 FRESHBUY,        
 FRESHSQTY,      
 FRESHSELL,  
 NETQTY,        
 NETAMOUNT  
 INTO #NSERPT  
 FROM TBL_NSE_REPORTING     
 P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND C.CL_CODE = P.PARTY_CODE           
 AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)   
 and (BODQTY + FRESHBQTY + FRESHSQTY) > 0  AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)  
  
 INSERT INTO #REPORT       
 SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +       
 REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +      
 + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))      
 FROM #NSERPT      
 GROUP BY MEMBERCODE       
      
 INSERT INTO #REPORT      
 SELECT DATA = '30,SELF,01,' +   
 CONVERT(VARCHAR,SUM(NETAMOUNT))      
 FROM #NSERPT     
 GROUP BY #NSERPT.MEMBERCODE     
      
 INSERT INTO #REPORT      
 SELECT DATA = '20,' + REPLACE(ltrim(rtrim(LONG_NAME)),',','') + ',' +       
 ltrim(rtrim(PARTY_CODE)) + ',' + LTRIM(rtrim(UPPER(SCRIP_CD))) +',' + ltrim(rtrim(UPPER(SERIES))) +',' +     
 CONVERT(VARCHAR,SUM(BODQTY)) + ',' +       
 CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +        
 CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +      
 CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +      
 CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +      
 CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +       
 CONVERT(VARCHAR,SUM(NETQTY)) + ',' +       
 CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL))       
 FROM #NSERPT      
 GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES      
    
 /*     
 SELECT PARTY_CODE, SCRIP_CD, SERIES,      
 BODQTY = SUM(BODQTY),      
 BODVALUE = SUM(BODVALUE),         
 FRESHBQTY = SUM(FRESHBQTY),      
 FRESHBUY = SUM(FRESHBUY),       
 FRESHSQTY = SUM(FRESHSQTY),      
 FRESHSELL = SUM(FRESHSELL),         
 NETQTY = SUM(NETQTY),      
 NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
 FROM #DATAFINAL      
 GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES     
 HAVING SUM(NETQTY) < 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) < 0    
 ORDER BY  PARTY_CODE, SCRIP_CD, SERIES     
    
 SELECT (SUM(BODVALUE + FRESHBUY - FRESHSELL)), SUM(NETQTY)    
 FROM   #DATAFINAL    
     
 SELECT PARTY_CODE, SCRIP_CD, SERIES,      
 BODQTY = SUM(BODQTY),      
 BODVALUE = SUM(BODVALUE),         
 FRESHBQTY = SUM(FRESHBQTY),      
 FRESHBUY = SUM(FRESHBUY),       
 FRESHSQTY = SUM(FRESHSQTY),      
 FRESHSELL = SUM(FRESHSELL),         
 NETQTY = SUM(NETQTY),      
 NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
 FROM #DATAFINAL      
 GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES     
 HAVING SUM(NETQTY) > 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0    
 ORDER BY  PARTY_CODE, SCRIP_CD, SERIES     
 RETURN    
 */    
   
    
 SELECT FILENAME = ltrim(rtrim('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')     
     + '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),      
 DATA = ltrim(rtrim(upper(data))) FROM #REPORT      
 ORDER BY SNO     
 /*      
 SELECT RECORDTYPE = '10', FILETYPE = 'MTR', MEMBERCODE,      
 BATCHDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''),      
 BATCHNO = '01',SUMCNT = 1,      
 DETAILCNT = COUNT(1),      
 AMOUNT = SUM(NETAMOUNT)      
 FROM #DATAFINAL      
 GROUP BY MEMBERCODE       
      
 SELECT RECORDTYPE = '20', COMPANY, LEN_CAT = '01',       
 AMOUNT = SUM(NETAMOUNT)      
 FROM #DATAFINAL, MSAJAG.DBO.OWNER       
 GROUP BY #DATAFINAL.MEMBERCODE,COMPANY      
      
 SELECT RECORDTYPE = '30', LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES,       
 BODQTY = SUM(BODQTY),      
 BODVALUE = SUM(BODVALUE),         
 FRESHBQTY = SUM(FRESHBQTY),      
 FRESHBUY = SUM(FRESHBUY),       
 FRESHSQTY = SUM(FRESHSQTY),      
 FRESHSELL = SUM(FRESHSELL),         
 NETQTY = SUM(NETQTY),      
 NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
 FROM #DATAFINAL      
 GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES      
 */      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_BAK_23112021
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_NSE_MTFFILE_BAK_23112021]      
(      
 @SAUDA_DATE VARCHAR(11),
 @FLAG		INT = 0,
 @party_code	varchar(10) = ''      
)      
AS      
-- EXEC RPT_NSE_MTFFILE 'SEP  5 2017', 1    
DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
select @BATCHNO = 0    
    
select @BATCHNO = ISNULL(max(fldbatchno),0) from AsianFileBatchNo    
where fldfileno = 'MT'    
and fldfiledate = @SAUDA_DATE    
/*    
insert into asianfilebatchno    
select 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
    
SET @BATCHNO = @BATCHNO + 1    
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
VW_MTF_POSITION WHERE SAUDA_DATE < @SAUDA_DATE      


IF @FLAG = 1 
BEGIN
      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)       
INTO #DATA      
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ( 'A', 'N', 'W')      
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT)),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ('A', 'N', 'W')      
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

/*      
INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(QTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM VW_MTF_POSITION   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE >= @SAUDA_DATE     
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ('A', 'N', 'W')      
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 
*/

INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 

SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES, PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
INTO #DATAFINAL      
FROM #DATA       WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, SERIES, PARTY_CODE  

UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

/*
SELECT * FROM #DATAFINAL

UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0   
          THEN FRESHBQTY - FRESHSQTY  
          ELSE 0  
           END),  
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0   
          THEN FRESHBUY - FRESHSELL  
          ELSE 0  
           END),  
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0   
          THEN FRESHSQTY - FRESHBQTY  
          ELSE 0  
           END),  
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0   
          THEN FRESHSELL - FRESHBUY  
          ELSE 0  
           END)  
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0   
  
DELETE FROM #DATAFINAL  
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0  
*/  

	DELETE FROM TBL_NSE_REPORTING
	WHERE SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE)
	AND party_code = (case when @party_code = '' then party_code else @party_code end)

	INSERT INTO TBL_NSE_REPORTING
	SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),
	PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
	PROCESSDATE = GETDATE()  
	FROM #DATAFINAL      
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES 
	
	UPDATE  TBL_NSE_REPORTING SET FRESHSELL = FRESHSELL + NETAMOUNT, NETAMOUNT = 0
	WHERE SAUDA_DATE = @SAUDA_DATE AND NETQTY = 0 AND NETAMOUNT <> 0
	
END

ELSE
BEGIN                                     
	CREATE TABLE #REPORT    
	(    
	 SNO INT IDENTITY(1,1),    
	 DATA VARCHAR(5000)    
	)   
        
	SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
	MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
	BODQTY,    
	BODVALUE,     
	FRESHBQTY,      
	FRESHBUY,      
	FRESHSQTY,    
	FRESHSELL,
	NETQTY,      
	NETAMOUNT
	INTO #NSERPT
	FROM TBL_NSE_REPORTING   
	P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND C.CL_CODE = P.PARTY_CODE         
	AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
	and (BODQTY + FRESHBQTY + FRESHSQTY) > 0  AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)

	INSERT INTO #REPORT     
	SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
	REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
	+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT    
	GROUP BY MEMBERCODE     
    
	INSERT INTO #REPORT    
	SELECT DATA = '30,SELF,01,' +     
	CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT   
	GROUP BY #NSERPT.MEMBERCODE   
    
	INSERT INTO #REPORT    
	SELECT DATA = '20,' + REPLACE(ltrim(rtrim(LONG_NAME)),',','') + ',' +     
	ltrim(rtrim(PARTY_CODE)) + ',' + LTRIM(rtrim(UPPER(SCRIP_CD))) +',' + ltrim(rtrim(UPPER(SERIES))) +',' +   
	CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
	CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
	CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL))     
	FROM #NSERPT    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
  
	/*   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) < 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) < 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
  
	SELECT (SUM(BODVALUE + FRESHBUY - FRESHSELL)), SUM(NETQTY)  
	FROM   #DATAFINAL  
   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) > 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
	RETURN  
	*/  
 
  
	SELECT FILENAME = ltrim(rtrim('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
					+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
	DATA = ltrim(rtrim(upper(data))) FROM #REPORT    
	ORDER BY SNO   
	/*    
	SELECT RECORDTYPE = '10', FILETYPE = 'MTR', MEMBERCODE,    
	BATCHDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''),    
	BATCHNO = '01',SUMCNT = 1,    
	DETAILCNT = COUNT(1),    
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE     
    
	SELECT RECORDTYPE = '20', COMPANY, LEN_CAT = '01',     
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL, MSAJAG.DBO.OWNER     
	GROUP BY #DATAFINAL.MEMBERCODE,COMPANY    
    
	SELECT RECORDTYPE = '30', LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES,     
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
	*/    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_bak_nov282019
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_NSE_MTFFILE]      
(      
 @SAUDA_DATE VARCHAR(11),
 @FLAG		INT = 0,
 @party_code	varchar(10) = ''      
)      
AS      
-- EXEC RPT_NSE_MTFFILE 'SEP  5 2017', 1    
DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
select @BATCHNO = 0    
    
select @BATCHNO = ISNULL(max(fldbatchno),0) from AsianFileBatchNo    
where fldfileno = 'MT'    
and fldfiledate = @SAUDA_DATE    
/*    
insert into asianfilebatchno    
select 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
    
SET @BATCHNO = @BATCHNO + 1    
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
VW_MTF_POSITION WHERE SAUDA_DATE < @SAUDA_DATE      


IF @FLAG = 1 
BEGIN
      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)       
INTO #DATA      
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ( 'A', 'N', 'W')      
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT)),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ('A', 'N', 'W')      
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

/*      
INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(QTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM VW_MTF_POSITION   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE >= @SAUDA_DATE     
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ('A', 'N', 'W')      
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 
*/

INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 

SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES, PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
INTO #DATAFINAL      
FROM #DATA       WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, SERIES, PARTY_CODE  

UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

/*
SELECT * FROM #DATAFINAL

UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0   
          THEN FRESHBQTY - FRESHSQTY  
          ELSE 0  
           END),  
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0   
          THEN FRESHBUY - FRESHSELL  
          ELSE 0  
           END),  
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0   
          THEN FRESHSQTY - FRESHBQTY  
          ELSE 0  
           END),  
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0   
          THEN FRESHSELL - FRESHBUY  
          ELSE 0  
           END)  
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0   
  
DELETE FROM #DATAFINAL  
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0  
*/  

	DELETE FROM TBL_NSE_REPORTING
	WHERE SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE)
	AND party_code = (case when @party_code = '' then party_code else @party_code end)

	INSERT INTO TBL_NSE_REPORTING
	SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),
	PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
	PROCESSDATE = GETDATE()  
	FROM #DATAFINAL      
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES 
	
	UPDATE  TBL_NSE_REPORTING SET FRESHSELL = FRESHSELL + NETAMOUNT, NETAMOUNT = 0
	WHERE SAUDA_DATE = @SAUDA_DATE AND NETQTY = 0 AND NETAMOUNT <> 0
	
END

ELSE
BEGIN                                     
	CREATE TABLE #REPORT    
	(    
	 SNO INT IDENTITY(1,1),    
	 DATA VARCHAR(5000)    
	)   
        
	SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
	MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
	BODQTY,    
	BODVALUE,     
	FRESHBQTY,      
	FRESHBUY,      
	FRESHSQTY,    
	FRESHSELL,
	NETQTY,      
	NETAMOUNT
	INTO #NSERPT
	FROM TBL_NSE_REPORTING   
	P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND C.CL_CODE = P.PARTY_CODE         
	AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
	and (BODQTY + FRESHBQTY + FRESHSQTY) > 0  AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)

	INSERT INTO #REPORT     
	SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
	REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
	+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT    
	GROUP BY MEMBERCODE     
    
	INSERT INTO #REPORT    
	SELECT DATA = '30,SELF,01,' +     
	CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT   
	GROUP BY #NSERPT.MEMBERCODE   
    
	INSERT INTO #REPORT    
	SELECT DATA = '20,' + REPLACE(ltrim(rtrim(LONG_NAME)),',','') + ',' +     
	ltrim(rtrim(PARTY_CODE)) + ',' + LTRIM(rtrim(UPPER(SCRIP_CD))) +',' + ltrim(rtrim(UPPER(SERIES))) +',' +   
	CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
	CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
	CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL))     
	FROM #NSERPT    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
  
	/*   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) < 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) < 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
  
	SELECT (SUM(BODVALUE + FRESHBUY - FRESHSELL)), SUM(NETQTY)  
	FROM   #DATAFINAL  
   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) > 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
	RETURN  
	*/  
 
  
	SELECT FILENAME = ltrim(rtrim('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
					+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
	DATA = ltrim(rtrim(upper(data))) FROM #REPORT    
	ORDER BY SNO   
	/*    
	SELECT RECORDTYPE = '10', FILETYPE = 'MTR', MEMBERCODE,    
	BATCHDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''),    
	BATCHNO = '01',SUMCNT = 1,    
	DETAILCNT = COUNT(1),    
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE     
    
	SELECT RECORDTYPE = '20', COMPANY, LEN_CAT = '01',     
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL, MSAJAG.DBO.OWNER     
	GROUP BY #DATAFINAL.MEMBERCODE,COMPANY    
    
	SELECT RECORDTYPE = '30', LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES,     
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
	*/    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_BKP_20221223
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_NSE_MTFFILE_BKP_20221223]        
(        
 @SAUDA_DATE VARCHAR(11),  
 @FLAG  INT = 0,  
 @party_code varchar(10) = ''        
)        
AS    

-- EXEC RPT_NSE_MTFFILE 'SEP  5 2017', 1      
DECLARE @PREVDATE VARCHAR(11),       
  @BATCHNO INT      
        
select @BATCHNO = 0      
      
select @BATCHNO = ISNULL(max(fldbatchno),0) from AsianFileBatchNo      
where fldfileno = 'MT'      
and fldfiledate = @SAUDA_DATE      
/*      
insert into asianfilebatchno      
select 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()      
      
SET @BATCHNO = @BATCHNO + 1      
*/      
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM         
VW_MTF_POSITION WHERE SAUDA_DATE < @SAUDA_DATE        
  
  
IF @FLAG = 1   
BEGIN  
        
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,      
BODQTY = 0,      
BODVALUE =CONVERT(NUMERIC(18,2),0),       
FRESHBQTY = SUM(QTY),       
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),        
FRESHSQTY = 0,      
FRESHSELL = CONVERT(NUMERIC(18,2),0),        
NETAMOUNT = CONVERT(NUMERIC(18,2),0)         
INTO #DATA        
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE SAUDA_DATE = @SAUDA_DATE         
AND ADJUST_DATE >= @SAUDA_DATE        
AND SELL_BUY = 1         
AND C.CL_CODE = P.PARTY_CODE        
AND TRANSTYPE = 'TRNSE'       
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)  
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES        
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0   
  
INSERT INTO #DATA        
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,       
BODQTY = 0,      
BODVALUE =CONVERT(NUMERIC(18,2),0),      
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = SUM(QTY),      
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT)),        
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE SAUDA_DATE <= @SAUDA_DATE         
AND ADJUST_DATE = @SAUDA_DATE        
AND SELL_BUY = 1         
AND C.CL_CODE = P.PARTY_CODE        
AND TRANSTYPE = 'TRNSE'    
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)  
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES        
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0   
   
INSERT INTO #DATA         
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,      
BODQTY = SUM(NETQTY),      
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMOUNT) ),       
FRESHBQTY = 0,        
FRESHBUY = 0,        
FRESHSQTY = 0,      
FRESHSELL = CONVERT(NUMERIC(18,2),0),        
NETAMOUNT = CONVERT(NUMERIC(18,2),0)    
FROM TBL_NSE_REPORTING     
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE SAUDA_DATE = @PREVDATE  
AND C.CL_CODE = P.PARTY_CODE           
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)  
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES        
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0   
  
SELECT * INTO #VAR FROM MSAJAG.DBO.VarDetail   
WHERE DETAILKEY = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')  
  
UPDATE #DATA SET SERIES = V.SERIES FROM #VAR V  
WHERE V.SCRIP_CD = #DATA.SCRIP_CD  
AND V.SERIES IN ('EQ','BE','BZ')  
AND #DATA.SERIES IN ('EQ','BE','BZ')  
  
SELECT DISTINCT SCRIP_CD, SERIES=MAX(SERIES) INTO #SCRSER FROM #DATA  
GROUP BY SCRIP_CD   
  
UPDATE #DATA SET SERIES = S.SERIES FROM #SCRSER S  
WHERE #DATA.SCRIP_CD = S.SCRIP_CD  

Select * from #DATA 
return ;
  
SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES=MAX(SERIES), PARTY_CODE, LONG_NAME,      
BODQTY = SUM(BODQTY),      
BODVALUE = SUM(BODVALUE),         
FRESHBQTY = SUM(FRESHBQTY),      
FRESHBUY = SUM(FRESHBUY),       
FRESHSQTY = SUM(FRESHSQTY),      
FRESHSELL = SUM(FRESHSELL),         
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),       
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)      
INTO #DATAFINAL        
FROM #DATA       WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)  
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, PARTY_CODE    
  
UPDATE #DATAFINAL SET NETAMOUNT = 0  
WHERE NETQTY = 0   
   
 DELETE FROM TBL_NSE_REPORTING  
 WHERE SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE)  
 AND party_code = (case when @party_code = '' then party_code else @party_code end)  
  
 INSERT INTO TBL_NSE_REPORTING  
 SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),  
 PARTY_CODE, SCRIP_CD, SERIES,      
 BODQTY = SUM(BODQTY),      
 BODVALUE = SUM(BODVALUE),         
 FRESHBQTY = SUM(FRESHBQTY),      
 FRESHBUY = SUM(FRESHBUY),       
 FRESHSQTY = SUM(FRESHSQTY),      
 FRESHSELL = SUM(FRESHSELL),         
 NETQTY = SUM(NETQTY),      
 NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),  
 PROCESSDATE = GETDATE()    
 FROM #DATAFINAL        
 GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
 ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
   
 UPDATE  TBL_NSE_REPORTING SET FRESHSELL = FRESHSELL + NETAMOUNT, NETAMOUNT = 0  
 WHERE SAUDA_DATE = @SAUDA_DATE AND NETQTY = 0 AND NETAMOUNT <> 0  
   
END  
  
ELSE  
BEGIN                                       
 CREATE TABLE #REPORT      
 (      
  SNO INT IDENTITY(1,1),      
  DATA VARCHAR(5000)      
 )     
          
 SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),        
 MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,      
 BODQTY,      
 BODVALUE,       
 FRESHBQTY,        
 FRESHBUY,        
 FRESHSQTY,      
 FRESHSELL,  
 NETQTY,        
 NETAMOUNT  
 INTO #NSERPT  
 FROM TBL_NSE_REPORTING     
 P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
 WHERE SAUDA_DATE = @SAUDA_DATE  
 AND C.CL_CODE = P.PARTY_CODE           
 AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)   
 and (BODQTY + FRESHBQTY + FRESHSQTY) > 0  AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)  
  
 INSERT INTO #REPORT       
 SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +       
 REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +      
 + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))      
 FROM #NSERPT      
 GROUP BY MEMBERCODE       
      
 INSERT INTO #REPORT      
 SELECT DATA = '30,SELF,01,' +   
 CONVERT(VARCHAR,SUM(NETAMOUNT))      
 FROM #NSERPT     
 GROUP BY #NSERPT.MEMBERCODE     
      
 INSERT INTO #REPORT      
 SELECT DATA = '20,' + REPLACE(ltrim(rtrim(LONG_NAME)),',','') + ',' +       
 ltrim(rtrim(PARTY_CODE)) + ',' + LTRIM(rtrim(UPPER(SCRIP_CD))) +',' + ltrim(rtrim(UPPER(SERIES))) +',' +     
 CONVERT(VARCHAR,SUM(BODQTY)) + ',' +       
 CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +        
 CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +      
 CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +      
 CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +      
 CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +       
 CONVERT(VARCHAR,SUM(NETQTY)) + ',' +       
 CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL))       
 FROM #NSERPT      
 GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES      
    
    
 SELECT FILENAME = ltrim(rtrim('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')     
     + '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),      
 DATA = ltrim(rtrim(upper(data))) FROM #REPORT      
 ORDER BY SNO     
       
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_BKUP_25Nov2022
-- --------------------------------------------------

Create PROC [dbo].[RPT_NSE_MTFFILE_BKUP_25Nov2022]      
(      
 @SAUDA_DATE VARCHAR(11),
 @FLAG		INT = 0,
 @party_code	varchar(10) = ''      
)      
AS      
-- EXEC RPT_NSE_MTFFILE 'SEP  5 2017', 1    
DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
select @BATCHNO = 0    
    
select @BATCHNO = ISNULL(max(fldbatchno),0) from AsianFileBatchNo    
where fldfileno = 'MT'    
and fldfiledate = @SAUDA_DATE    
/*    
insert into asianfilebatchno    
select 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
    
SET @BATCHNO = @BATCHNO + 1    
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
VW_MTF_POSITION WHERE SAUDA_DATE < @SAUDA_DATE      


IF @FLAG = 1 
BEGIN
      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)       
INTO #DATA      
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ( 'A', 'N', 'W')      
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,2),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,2),SUM(NETAMT)),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM VW_MTF_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ('A', 'N', 'W')      
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 

/*      
INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(QTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM VW_MTF_POSITION   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE < @SAUDA_DATE
AND ADJUST_DATE >= @SAUDA_DATE     
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
AND SETT_TYPE IN ('A', 'N', 'W')      
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(QTY) > 0 AND SUM(NETAMT) > 0 
*/

INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,2),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,2),0),      
NETAMOUNT = CONVERT(NUMERIC(18,2),0)  
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES      
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 

SELECT * INTO #VAR FROM MSAJAG.DBO.VarDetail 
WHERE DETAILKEY = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')

UPDATE #DATA SET SERIES = V.SERIES FROM #VAR V
WHERE V.SCRIP_CD = #DATA.SCRIP_CD
AND V.SERIES IN ('EQ','BE','BZ')
AND #DATA.SERIES IN ('EQ','BE','BZ')

SELECT DISTINCT SCRIP_CD, SERIES=MAX(SERIES) INTO #SCRSER FROM #DATA
GROUP BY SCRIP_CD 

UPDATE #DATA SET SERIES = S.SERIES FROM #SCRSER S
WHERE #DATA.SCRIP_CD = S.SCRIP_CD

SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES=MAX(SERIES), PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
INTO #DATAFINAL      
FROM #DATA       WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, PARTY_CODE  

UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

/*
SELECT * FROM #DATAFINAL

UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0   
          THEN FRESHBQTY - FRESHSQTY  
          ELSE 0  
           END),  
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0   
          THEN FRESHBUY - FRESHSELL  
          ELSE 0  
           END),  
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0   
          THEN FRESHSQTY - FRESHBQTY  
          ELSE 0  
           END),  
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0   
          THEN FRESHSELL - FRESHBUY  
          ELSE 0  
           END)  
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0   
  
DELETE FROM #DATAFINAL  
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0  
*/  

	DELETE FROM TBL_NSE_REPORTING
	WHERE SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE)
	AND party_code = (case when @party_code = '' then party_code else @party_code end)

	INSERT INTO TBL_NSE_REPORTING
	SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),
	PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
	PROCESSDATE = GETDATE()  
	FROM #DATAFINAL      
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES 
	
	UPDATE  TBL_NSE_REPORTING SET FRESHSELL = FRESHSELL + NETAMOUNT, NETAMOUNT = 0
	WHERE SAUDA_DATE = @SAUDA_DATE AND NETQTY = 0 AND NETAMOUNT <> 0
	
END

ELSE
BEGIN                                     
	CREATE TABLE #REPORT    
	(    
	 SNO INT IDENTITY(1,1),    
	 DATA VARCHAR(5000)    
	)   
        
	SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
	MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
	BODQTY,    
	BODVALUE,     
	FRESHBQTY,      
	FRESHBUY,      
	FRESHSQTY,    
	FRESHSELL,
	NETQTY,      
	NETAMOUNT
	INTO #NSERPT
	FROM TBL_NSE_REPORTING   
	P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND C.CL_CODE = P.PARTY_CODE         
	AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
	and (BODQTY + FRESHBQTY + FRESHSQTY) > 0  AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)

	INSERT INTO #REPORT     
	SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
	REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
	+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT    
	GROUP BY MEMBERCODE     
    
	INSERT INTO #REPORT    
	SELECT DATA = '30,SELF,01,' +     
	CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT   
	GROUP BY #NSERPT.MEMBERCODE   
    
	INSERT INTO #REPORT    
	SELECT DATA = '20,' + REPLACE(ltrim(rtrim(LONG_NAME)),',','') + ',' +     
	ltrim(rtrim(PARTY_CODE)) + ',' + LTRIM(rtrim(UPPER(SCRIP_CD))) +',' + ltrim(rtrim(UPPER(SERIES))) +',' +   
	CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
	CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
	CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL))     
	FROM #NSERPT    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
  
	/*   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) < 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) < 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
  
	SELECT (SUM(BODVALUE + FRESHBUY - FRESHSELL)), SUM(NETQTY)  
	FROM   #DATAFINAL  
   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) > 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
	RETURN  
	*/  
 
  
	SELECT FILENAME = ltrim(rtrim('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
					+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
	DATA = ltrim(rtrim(upper(data))) FROM #REPORT    
	ORDER BY SNO   
	/*    
	SELECT RECORDTYPE = '10', FILETYPE = 'MTR', MEMBERCODE,    
	BATCHDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''),    
	BATCHNO = '01',SUMCNT = 1,    
	DETAILCNT = COUNT(1),    
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE     
    
	SELECT RECORDTYPE = '20', COMPANY, LEN_CAT = '01',     
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL, MSAJAG.DBO.OWNER     
	GROUP BY #DATAFINAL.MEMBERCODE,COMPANY    
    
	SELECT RECORDTYPE = '30', LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES,     
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
	*/    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_NEW
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_NSE_MTFFILE_NEW]      
(      
	@SAUDA_DATE VARCHAR(11),
	@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = ''      
)      
AS      

-- EXEC RPT_NSE_MTFFILE_NEW 'JUN 30 2021'  

DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'    
AND FLDFILEDATE = @SAUDA_DATE    
/*    
   
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY,      
FRESHBUY,      
FRESHSQTY,    
FRESHSELL,
NETQTY,      
NETAMOUNT
INTO #NSERPT
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

SELECT * INTO #VAR FROM MSAJAG.DBO.VARDETAIL 
WHERE DETAILKEY = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')

UPDATE #NSERPT SET SERIES = V.SERIES FROM #VAR V
WHERE V.SCRIP_CD = #NSERPT.SCRIP_CD
AND V.SERIES IN ('EQ','BE','BZ')
AND #NSERPT.SERIES IN ('EQ','BE','BZ')

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

INSERT INTO ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT    
GROUP BY MEMBERCODE     
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
    
  
       
     
    
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' + 
'N,NSE'     
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO 

--select * from #REPORT
--return

CREATE INDEX #PARTY ON #NSERPT
( PARTY_CODE)


SELECT *, EXCHG = 'BSE' INTO #MTFCOLL
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG = 'MTFCOLL' 


create clustered index idx_isin on #MTFCOLL
(
	SAUDA_DATE, 
	isin
)
 

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and ISIN not IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and SCRIP_CD IN ('BALMRLIN','CHEVIOT','DIL','EPCIN','PIXTRANS','WESTLIFEDE','WPIL')



UPDATE #MTFCOLL SET EXCHG = 'NSE'
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'
AND D.DETAILKEY = C.DetailKey 
AND D.ISIN = #MTFCOLL.ISIN
AND D.SCRIP_CD = #MTFCOLL.SCRIP_CD ---

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN LEFT(SCRIP_CD,10) ELSE SCRIP_CD END), 
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG,
CASHCOLL = CONVERT(NUMERIC(18,2),0)
INTO #HOLD
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE 
AND   C.CL_CODE = H.PARTY_CODE
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R 
				     WHERE R.PARTY_CODE = H.PARTY_CODE)
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
--AND EXCHG = 'NSE'
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG

UPDATE #HOLD SET SERIES = V.SERIES FROM #VAR V
WHERE V.SCRIP_CD = #HOLD.SCRIP_CD
AND V.SERIES IN ('EQ','BE','BZ')
AND #HOLD.SERIES IN ('EQ','BE','BZ')

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0 
								  THEN SUM(NETAMT) + MTFLEDBAL
								  ELSE 0
						     END),
				   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,2),0)
INTO #COLLCASH
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

INSERT INTO #COLLCASH
SELECT DISTINCT PARTY_CODE, CASHCOLL = 0, MTFNONCASHCOLLATERAL = 0 FROM #HOLD
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #COLLCASH WHERE #COLLCASH.PARTY_CODE = #HOLD.PARTY_CODE)

UPDATE #COLLCASH SET MTFNONCASHCOLLATERAL = NONCASH
FROM (SELECT PARTY_CODE, NONCASH = SUM(AMOUNT)
	  FROM #HOLD
	  GROUP BY PARTY_CODE) C
WHERE C.PARTY_CODE = #COLLCASH.PARTY_CODE
/*
UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT) 
	FROM   #HOLD
	GROUP BY PARTY_CODE, CASHCOLL
) A
*/
        

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(MTFNONCASHCOLLATERAL) 
	FROM   #COLLCASH
	GROUP BY PARTY_CODE, CASHCOLL
) A
     

INSERT INTO #REPORT  
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)
		    + ',' + CAT + ',' + EXCHG
FROM #HOLD

UPDATE #REPORT SET DATA = UPPER(DATA)
UPDATE #REPORT SET DATA = ISNULL (DATA,'')


 

INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
				+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
DATA = LTRIM(RTRIM(DATA))
 FROM #REPORT 
ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_NEW_25022021
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_NSE_MTFFILE_NEW_25022021]      
(      
	@SAUDA_DATE VARCHAR(11),
	@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = ''      
)      
AS      

-- EXEC RPT_NSE_MTFFILE_NEW 'NOV 30 2017'  

DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'    
AND FLDFILEDATE = @SAUDA_DATE    
/*    
   
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY,      
FRESHBUY,      
FRESHSQTY,    
FRESHSELL,
NETQTY,      
NETAMOUNT
INTO #NSERPT
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

INSERT INTO ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT    
GROUP BY MEMBERCODE     
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
    
  
       
     
    
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' + 
'N,NSE'     
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO 

--select * from #REPORT WHERE DATA LIKE '%NULL%'
--return

CREATE INDEX #PARTY ON #NSERPT
( PARTY_CODE)


SELECT *, EXCHG = 'BSE' INTO #MTFCOLL
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG = 'MTFCOLL' 


create clustered index idx_isin on #MTFCOLL
(
	SAUDA_DATE, 
	isin
)
 

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and ISIN not IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and SCRIP_CD IN ('BALMRLIN','CHEVIOT','DIL','EPCIN','PIXTRANS','WESTLIFEDE','WPIL')



UPDATE #MTFCOLL SET EXCHG = 'NSE'
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'
AND D.DETAILKEY = C.DetailKey 
AND D.ISIN = #MTFCOLL.ISIN
AND D.SCRIP_CD = #MTFCOLL.SCRIP_CD ---

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN LEFT(SCRIP_CD,10) ELSE SCRIP_CD END), 
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG,
CASHCOLL = CONVERT(NUMERIC(18,2),0)
INTO #HOLD
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE 
AND   C.CL_CODE = H.PARTY_CODE
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R 
				     WHERE R.PARTY_CODE = H.PARTY_CODE)
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
--AND EXCHG = 'NSE'
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG


 

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN MTFLEDBAL - SUM(NETAMT) > 0 
								  THEN MTFLEDBAL - SUM(NETAMT)
								  ELSE 0
						     END)
INTO #COLLCASH
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE

--INSERT INTO #REPORT  
--SELECT DATA = '40,' 
--	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
--			             ISNULL(SUM(CASHCOLL),0))) = '0' 
--					THEN '0.00'
--					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
--			             ISNULL(SUM(CASHCOLL),0)))
--			   END) 
--			+ ',0.00,' 
--		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
--					THEN '0.00'
--					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
--			   END)
--FROM 
--(
--	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT) 
--	FROM   #HOLD
--	GROUP BY PARTY_CODE, CASHCOLL
--) A

        
    
      

INSERT INTO #REPORT  
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)
		    + ',' + CAT + ',' + EXCHG
FROM #HOLD

UPDATE #REPORT SET DATA = UPPER(DATA)
UPDATE #REPORT SET DATA = ISNULL (DATA,'')

DELETE FROM #REPORT WHERE DATA IS NULL


 

INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
				+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
DATA = LTRIM(RTRIM(DATA))
 FROM #REPORT    
ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_NEW_BAK
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_NSE_MTFFILE_NEW_BAK]      
(      
	@SAUDA_DATE VARCHAR(11),
	@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = ''      
)      
AS      

-- EXEC RPT_NSE_MTFFILE_NEW 'NOV 30 2017'  

DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'    
AND FLDFILEDATE = @SAUDA_DATE    
/*    
   
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY,      
FRESHBUY,      
FRESHSQTY,    
FRESHSELL,
NETQTY,      
NETAMOUNT
INTO #NSERPT
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

INSERT INTO ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT    
GROUP BY MEMBERCODE     
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' + 
'N,NSE'     
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO 

CREATE INDEX #PARTY ON #NSERPT
( PARTY_CODE)


SELECT *, EXCHG = 'BSE' INTO #MTFCOLL
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG = 'MTFCOLL' 


create clustered index idx_isin on #MTFCOLL
(
	SAUDA_DATE, 
	isin
)

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and ISIN not IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)

UPDATE #MTFCOLL SET EXCHG = 'NSE'
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'
AND D.DETAILKEY = C.DetailKey 
AND D.ISIN = #MTFCOLL.ISIN

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN BSECODE ELSE SCRIP_CD END), 
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG,
CASHCOLL = CONVERT(NUMERIC(18,2),0)
INTO #HOLD
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE 
AND   C.CL_CODE = H.PARTY_CODE
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R 
				     WHERE R.PARTY_CODE = H.PARTY_CODE)
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
--AND EXCHG = 'NSE'
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN MTFLEDBAL - SUM(NETAMT) > 0 
								  THEN MTFLEDBAL - SUM(NETAMT)
								  ELSE 0
						     END)
INTO #COLLCASH
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT) 
	FROM   #HOLD
	GROUP BY PARTY_CODE, CASHCOLL
) A

INSERT INTO #REPORT  
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)
		    + ',' + CAT + ',' + EXCHG
FROM #HOLD

UPDATE #REPORT SET DATA = UPPER(DATA)

INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
				+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
DATA = LTRIM(RTRIM(DATA)) FROM #REPORT    
ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_NEW_bak_18062019
-- --------------------------------------------------
create PROC [dbo].[RPT_NSE_MTFFILE_NEW_bak_18062019]      
(      
	@SAUDA_DATE VARCHAR(11),
	@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = ''      
)      
AS      

-- EXEC RPT_NSE_MTFFILE_NEW 'NOV 30 2017'  

DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'    
AND FLDFILEDATE = @SAUDA_DATE    
/*    
   
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY,      
FRESHBUY,      
FRESHSQTY,    
FRESHSELL,
NETQTY,      
NETAMOUNT
INTO #NSERPT
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

INSERT INTO ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT    
GROUP BY MEMBERCODE     
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' + 
'N,NSE'     
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO 

CREATE INDEX #PARTY ON #NSERPT
( PARTY_CODE)


SELECT *, EXCHG = 'BSE' INTO #MTFCOLL
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG = 'MTFCOLL' 


create clustered index idx_isin on #MTFCOLL
(
	SAUDA_DATE, 
	isin
)
 

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and ISIN not IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and SCRIP_CD IN ('BALMRLIN','CHEVIOT','DIL','EPCIN','PIXTRANS','WESTLIFEDE','WPIL')



UPDATE #MTFCOLL SET EXCHG = 'NSE'
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'
AND D.DETAILKEY = C.DetailKey 
AND D.ISIN = #MTFCOLL.ISIN

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN LEFT(SCRIP_CD,10) ELSE SCRIP_CD END), 
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG,
CASHCOLL = CONVERT(NUMERIC(18,2),0)
INTO #HOLD
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE 
AND   C.CL_CODE = H.PARTY_CODE
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R 
				     WHERE R.PARTY_CODE = H.PARTY_CODE)
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
--AND EXCHG = 'NSE'
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN MTFLEDBAL - SUM(NETAMT) > 0 
								  THEN MTFLEDBAL - SUM(NETAMT)
								  ELSE 0
						     END)
INTO #COLLCASH
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT) 
	FROM   #HOLD
	GROUP BY PARTY_CODE, CASHCOLL
) A

INSERT INTO #REPORT  
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)
		    + ',' + CAT + ',' + EXCHG
FROM #HOLD

UPDATE #REPORT SET DATA = UPPER(DATA)

INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
				+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
DATA = LTRIM(RTRIM(DATA))
 FROM #REPORT    
ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_NEW_BAK_23112021
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_NSE_MTFFILE_NEW_BAK_23112021]      
(      
	@SAUDA_DATE VARCHAR(11),
	@FLAG		INT = 0,
	@PARTY_CODE	VARCHAR(10) = ''      
)      
AS      

-- EXEC RPT_NSE_MTFFILE_NEW 'JUN 30 2021'  

DECLARE @PREVDATE VARCHAR(11),     
  @BATCHNO INT    
      
SELECT @BATCHNO = 0    
    
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE FLDFILENO = 'MT'    
AND FLDFILEDATE = @SAUDA_DATE    
/*    
   
*/    
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    

CREATE TABLE #REPORT    
(    
	SNO INT IDENTITY(1,1),    
	DATA VARCHAR(5000)    
)   

SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
BODQTY,    
BODVALUE,     
FRESHBQTY,      
FRESHBUY,      
FRESHSQTY,    
FRESHSELL,
NETQTY,      
NETAMOUNT
INTO #NSERPT
FROM TBL_NSE_REPORTING   
P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
AND (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

SELECT * INTO #VAR FROM MSAJAG.DBO.VARDETAIL 
WHERE DETAILKEY = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')

UPDATE #NSERPT SET SERIES = V.SERIES FROM #VAR V
WHERE V.SCRIP_CD = #NSERPT.SCRIP_CD
AND V.SERIES IN ('EQ','BE','BZ')
AND #NSERPT.SERIES IN ('EQ','BE','BZ')

IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0
BEGIN
	SELECT * FROM #REPORT
	RETURN
END

INSERT INTO ASIANFILEBATCHNO    
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
SET @BATCHNO = @BATCHNO + 1 
        
INSERT INTO #REPORT     
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT    
GROUP BY MEMBERCODE     
    
INSERT INTO #REPORT    
SELECT DATA = '30,SELF,01,' +     
CONVERT(VARCHAR,SUM(NETAMOUNT))    
FROM #NSERPT   
GROUP BY #NSERPT.MEMBERCODE   
    
    
  
       
     
    
INSERT INTO #REPORT    
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +     
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +   
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' + 
'N,NSE'     
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO 

--select * from #REPORT
--return

CREATE INDEX #PARTY ON #NSERPT
( PARTY_CODE)


SELECT *, EXCHG = 'BSE' INTO #MTFCOLL
FROM TBL_PRODUCT_HOLD_DATA
WHERE SAUDA_DATE = @SAUDA_DATE 
AND HOLDFLAG = 'MTFCOLL' 


create clustered index idx_isin on #MTFCOLL
(
	SAUDA_DATE, 
	isin
)
 

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and ISIN not IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)

delete from #MTFCOLL
WHERE SAUDA_DATE = @SAUDA_DATE 
and SCRIP_CD IN ('BALMRLIN','CHEVIOT','DIL','EPCIN','PIXTRANS','WESTLIFEDE','WPIL')



UPDATE #MTFCOLL SET EXCHG = 'NSE'
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'
AND D.DETAILKEY = C.DetailKey 
AND D.ISIN = #MTFCOLL.ISIN
AND D.SCRIP_CD = #MTFCOLL.SCRIP_CD ---

SELECT H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN LEFT(SCRIP_CD,10) ELSE SCRIP_CD END), 
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),
CAT = 'N', EXCHG,
CASHCOLL = CONVERT(NUMERIC(18,2),0)
INTO #HOLD
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE SAUDA_DATE = @SAUDA_DATE 
AND   C.CL_CODE = H.PARTY_CODE
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R 
				     WHERE R.PARTY_CODE = H.PARTY_CODE)
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)
--AND EXCHG = 'NSE'
GROUP BY H.PARTY_CODE, LONG_NAME, 
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG

UPDATE #HOLD SET SERIES = V.SERIES FROM #VAR V
WHERE V.SCRIP_CD = #HOLD.SCRIP_CD
AND V.SERIES IN ('EQ','BE','BZ')
AND #HOLD.SERIES IN ('EQ','BE','BZ')

SELECT PARTY_CODE, CASHCOLL=(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0 
								  THEN SUM(NETAMT) + MTFLEDBAL
								  ELSE 0
						     END),
				   MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,2),0)
INTO #COLLCASH
FROM TBL_MTF_DATA
WHERE SAUDA_DATE = @SAUDA_DATE
GROUP BY PARTY_CODE, MTFLEDBAL

INSERT INTO #COLLCASH
SELECT DISTINCT PARTY_CODE, CASHCOLL = 0, MTFNONCASHCOLLATERAL = 0 FROM #HOLD
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #COLLCASH WHERE #COLLCASH.PARTY_CODE = #HOLD.PARTY_CODE)

UPDATE #COLLCASH SET MTFNONCASHCOLLATERAL = NONCASH
FROM (SELECT PARTY_CODE, NONCASH = SUM(AMOUNT)
	  FROM #HOLD
	  GROUP BY PARTY_CODE) C
WHERE C.PARTY_CODE = #COLLCASH.PARTY_CODE
/*
UPDATE #HOLD SET CASHCOLL = C.CASHCOLL
FROM #COLLCASH C
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT) 
	FROM   #HOLD
	GROUP BY PARTY_CODE, CASHCOLL
) A
*/
        

INSERT INTO #REPORT  
SELECT DATA = '40,' 
	        + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0))) = '0' 
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2), 
			             ISNULL(SUM(CASHCOLL),0)))
			   END) 
			+ ',0.00,' 
		    + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'
					THEN '0.00'
					ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))
			   END)
FROM 
(
	SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(MTFNONCASHCOLLATERAL) 
	FROM   #COLLCASH
	GROUP BY PARTY_CODE, CASHCOLL
) A
     

INSERT INTO #REPORT  
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)
		    + ',' + CAT + ',' + EXCHG
FROM #HOLD

UPDATE #REPORT SET DATA = UPPER(DATA)
UPDATE #REPORT SET DATA = ISNULL (DATA,'')


 

INSERT INTO #REPORT
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'

SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
				+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
DATA = LTRIM(RTRIM(DATA))
 FROM #REPORT 
ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_NEWMTF
-- --------------------------------------------------







CREATE PROC [dbo].[RPT_NSE_MTFFILE_NEWMTF]      
(      
@SAUDA_DATE		VARCHAR(11),
@FLAG			INT = 0,
@PARTY_CODE		VARCHAR(10) = ''      
)      
AS      

--EXEC [RPT_NSE_MTFFILE_NEWMTF] 'JUL  7 2025', 1    

DECLARE @PREVDATE VARCHAR(11),     
		@BATCHNO	INT,
		@SDTCUR		DATETIME,
		@LDTCUR		DATETIME,
		@MTFFLAG	INT,
		@PROPOR_ALLOC_FLAG	INT
      
SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR      

SELECT	@BATCHNO = 0    
SELECT	@PROPOR_ALLOC_FLAG = 1
    
SELECT	@BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE	FLDFILENO = 'MT'    
		AND FLDFILEDATE = @SAUDA_DATE    
  
DECLARE	@VNO		VARCHAR(12),
		@RECCNT		INT,
		@EDT		VARCHAR(11)

SELECT	@EDT = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'


SELECT	@MTFFLAG = COUNT(1) FROM MTFTRADE..TBL_MTF_LOG WHERE FUNDING_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
VW_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    


SELECT * INTO #MTR_RTP FROM TBL_MTR_REPORTING WHERE 1=2

ALTER TABLE #MTR_RTP
ALTER COLUMN BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN NETAMOUNT NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_NETAMOUNT NUMERIC(18,4)

IF (SELECT COUNT(1) FROM TBL_MTR_REPORTING WHERE SAUDA_DATE = @PREVDATE) > 0
BEGIN
	
	INSERT	INTO #MTR_RTP
	SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,
			M_BODQTY,M_BODVALUE,M_FRESHBQTY,M_FRESHBUY,M_FRESHSQTY,M_FRESHSELL,M_NETQTY,M_NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE 
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @PREVDATE

END
ELSE
BEGIN

	INSERT	INTO #MTR_RTP (SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE)
	SELECT	SAUDA_DATE=@PREVDATE,PARTY_CODE,SCRIP_CD,SERIES,
			BODQTY = SUM(QTY),      
			BODVALUE = SUM(MKTAMT),
			FRESHBQTY = 0,            
			FRESHBUY = 0,            
			FRESHSQTY = 0,      
			FRESHSELL = 0, 
			NETQTY = SUM(QTY),
			NETAMOUNT = SUM(MKTAMT),
			TRANSTYPE,
			SAUDA_DATE=@PREVDATE,
			ISIN,BSECODE
	FROM	VW_PRODUCT_POSITION
	WHERE	SAUDA_DATE <= @PREVDATE       
			AND ADJUST_DATE > @PREVDATE      
			AND SELL_BUY = 1
	GROUP BY
			PARTY_CODE,SCRIP_CD,SERIES,
			TRANSTYPE,ISIN,BSECODE
	HAVING	SUM(QTY) > 0 AND SUM(MKTAMT) > 0

END

IF @FLAG = 1 
BEGIN

SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,4),ROUND(SUM(MKTAMT),4) ),      
FRESHSQTY = 0,
FRESHSELL = CONVERT(NUMERIC(18,4),0),
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
INTO #DATA      
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'') --,SETT_NO --, ISNULL(P.ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 


INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,4),ROUND(SUM(MKTAMT),4)),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE,BSECODE, ISNULL(ISIN,'') --,SETT_NO --, ISNULL(P.ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 

--- MAINTENANCE MARGIN ---

/*
SELECT	PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MKTAMT,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0)
INTO	#TBL_MTF_DATA_BUY_1
FROM	TBL_MTF_DATA_BUY(NOLOCK)
WHERE	SAUDA_DATE = @PREVDATE AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)

ALTER TABLE #TBL_MTF_DATA_BUY_1 
ADD SNO INT IDENTITY(1,1) 

INSERT	INTO #TBL_MTF_DATA_BUY_1
SELECT	P.PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY = -QTY, MKTAMT = -MKTAMT,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0)
FROM	VW_PRODUCT_POSITION P (NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE	SAUDA_DATE <= @SAUDA_DATE       
		AND ADJUST_DATE = @SAUDA_DATE      
		AND SELL_BUY = 1       
		AND C.CL_CODE = P.PARTY_CODE      
		--AND TRANSTYPE='TRNSE'
		AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
		AND EXISTS (SELECT PARTY_CODE FROM #TBL_MTF_DATA_BUY_1 T WHERE T.PARTY_CODE = P.PARTY_CODE
					AND T.ISIN = P.ISIN) 

SELECT '#TBL_MTF_DATA_BUY_1',* FROM #TBL_MTF_DATA_BUY_1 WHERE PARTY_CODE='AF2204'


SELECT	SNO = MAX(SNO), PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), MKTAMT=SUM(MKTAMT),
		PAYIN_AMT = SUM(PAYIN_AMT),
		PAYIN_AMT_BAL = SUM(PAYIN_AMT_BAL),
		M_QTY = 0,
		M_PRICE = 0,
		M_AMT = 0,
		NF_QTY = 0,
		NF_AMT = 0
INTO	#TBL_MTF_DATA_BUY 
FROM	TBL_MTF_DATA_BUY(NOLOCK) 
GROUP BY
		PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN

SELECT '#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AF2204'
*/

SELECT	*,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0), ---CONVERT(NUMERIC(18,2),0), ---CHANGES ON 04/09/2025
		M_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0),
		SELL_BUY = CONVERT(INT,1),
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TBL_MTF_DATA_BUY 
FROM	TBL_MTF_DATA_BUY(NOLOCK) 
WHERE	PAYIN_DATE = @SAUDA_DATE
		AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)


---- MTF_CASH_PAYIN_LEDGER ---------

UPDATE	#TBL_MTF_DATA_BUY 
SET		PAYIN_AMT = ISNULL(D.VAMT,0)
FROM	(
		SELECT	CLTCODE,
				VAMT = SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),
				VDT
		FROM	LEDGER P(NOLOCK)
		WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
				AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
				AND P.VTYP = '66'
				--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
				AND P.EDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE
				AND P.CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN P.CLTCODE ELSE @PARTY_CODE END)
				AND P.NARRATION LIKE '%MTF PAYIN'
		GROUP BY
				CLTCODE,
				VDT
		HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0
		) D
WHERE	D.CLTCODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND D.VDT = #TBL_MTF_DATA_BUY.SAUDA_DATE



DECLARE @ADJCUR		CURSOR, 
		@DELCUR		CURSOR, 
		@PARTYCODE	VARCHAR(20),
		@PAYIN_AMT	NUMERIC(18,4),
		@MKTAMT		NUMERIC(18,4),
		@MARGIN_REQ	NUMERIC(18,4),
		@SNO		INT,
		@MAMT		NUMERIC(18,4),
		@SAUDA_DATE_PAYIN	DATETIME,
		@PRO_PER	NUMERIC(18,2)

SET @ADJCUR = CURSOR FOR
	SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
			PRO_PER =  (
			CASE 
				WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
				ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
			END)
	FROM #TBL_MTF_DATA_BUY
	WHERE PAYIN_AMT > 0
	GROUP BY PARTY_CODE, SAUDA_DATE
	ORDER BY PARTY_CODE, SAUDA_DATE
OPEN @ADJCUR
FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
WHILE @@FETCH_STATUS = 0
BEGIN 
	
	SET @DELCUR = CURSOR FOR
		SELECT SNO, MKTAMT, MARGIN_REQ = (CASE WHEN @PROPOR_ALLOC_FLAG = 1 THEN (MARGIN_REQ/100*@PRO_PER) ELSE MARGIN_REQ END)
		FROM #TBL_MTF_DATA_BUY
		WHERE SAUDA_DATE = @SAUDA_DATE_PAYIN 
		AND PARTY_CODE = @PARTYCODE
		AND MKTAMT > 0 AND MARGIN_REQ > 0
		ORDER BY PARTY_CODE, SCRIP_CD, SERIES
	OPEN @DELCUR
	FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		IF @PAYIN_AMT > 0 --AND @@FETCH_STATUS = 0
		BEGIN
			IF @PROPOR_ALLOC_FLAG = 1 
			BEGIN
				SET		@MAMT = 0
				
				--IF @PARTYCODE ='AHMAJ125'
				--BEGIN
				--	SELECT @MARGIN_REQ
				--	SELECT M_PRICE = ROUND((MKTAMT/QTY),4), M_QTY = FLOOR((@MARGIN_REQ/ROUND((MKTAMT/QTY),4)))
				--	FROM  #TBL_MTF_DATA_BUY
				--	WHERE SNO = @SNO AND PARTY_CODE ='AHMAJ125' AND SCRIP_CD='TRITURBINE'
				--END


				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0				
			END
			ELSE
			BEGIN
				IF @PAYIN_AMT >= @MARGIN_REQ 
				--IF PRADNYA.DBO.FNMIN(@PAYIN_AMT,@MARGIN_REQ)
				BEGIN
					SET		@MAMT = 0
				
					UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
					WHERE	SNO = @SNO

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
							@MAMT = (M_PRICE*M_QTY)
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		NF_QTY = (QTY-M_QTY),
							NF_AMT = M_PRICE*(QTY-M_QTY)
					WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

					SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT

					--SELECT	SRNO = @SNO, PAYIN_AMT=@PAYIN_AMT, M_AMT = @MAMT, PAYIN_BALANCE = (@PAYIN_AMT - @MAMT)

					--SET @PAYIN_AMT = @PAYIN_AMT - @MARGIN_REQ

			END
			ELSE
			BEGIN

				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @PAYIN_AMT
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0
				
				SET @PAYIN_AMT = 0

			END
		END
		END

		FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ 
	END
	
	CLOSE @DELCUR
	DEALLOCATE @DELCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
END
CLOSE @ADJCUR
DEALLOCATE @ADJCUR

DELETE	FROM TBL_MTF_DATA_BUY_ALLOC_LOG
WHERE	SAUDA_DATE = @SAUDA_DATE

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--UPDATE	#TBL_MTF_DATA_BUY
--SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
--		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
--WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 --- **/

--SELECT '#TBL_MTF_DATA_BUY-3',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

INSERT	INTO TBL_MTF_DATA_BUY_ALLOC_LOG
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,
		M_ALLOC_BALANCE, NF_QTY,NF_AMT,SELL_BUY,
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#TBL_MTF_DATA_BUY 
WHERE	M_ALLOC_BALANCE > 0

--SELECT	'#TBL_MTF_DATA_BUY-4',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE IN ('AHMAJ125') AND SCRIP_CD='TRITURBINE' ORDER BY PARTY_CODE, SCRIP_CD, SERIES 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = 0,      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(M_QTY), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_QTY ELSE 0 END),
M_FRESHBUY = ROUND(SUM(M_AMT),2), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_AMT ELSE 0 END),
M_FRESHSQTY = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_QTY ELSE 0 END),
M_FRESHSELL = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_AMT ELSE 0 END),
M_NETQTY = SUM(NF_QTY),
M_NETAMOUNT = SUM(NF_AMT),
EXCHANGE = P.EXCHANGE,--= 'TRNSE', --TRANSTYPE
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO
,BSECODE
FROM #TBL_MTF_DATA_BUY P (NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER (NOLOCK)      
WHERE 1 = 1 --SAUDA_DATE = @PREV_SAUDA_DATE       
--AND ADJUST_DATE = @SAUDA_DATE      
--AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, ISNULL(P.ISIN,''),P.EXCHANGE,BSECODE --,SETT_NO --, TRANSTYPE      
HAVING (SUM(M_QTY) > 0 OR SUM(NF_QTY) > 0 )

--SELECT '#DATA-1',* FROM #DATA WHERE PARTY_CODE IN ('FU90106') AND SCRIP_CD='BDL'

INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,4),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,4),0),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(ISNULL(M_FRESHBQTY,0)),
M_FRESHBUY = CONVERT(NUMERIC(18,4),ROUND(SUM(ISNULL(M_FRESHBUY,0)),2)),
M_FRESHSQTY = SUM(ISNULL(M_FRESHSQTY,0)),
M_FRESHSELL = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_FRESHSELL,0))),
M_NETQTY = SUM(ISNULL(M_NETQTY,0)),
M_NETAMOUNT = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))),
EXCHANGE = ISNULL(EXCHANGE,'TRNSE'),
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO =''
,BSECODE
FROM #MTR_RTP P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, EXCHANGE, ISNULL(P.ISIN,''),BSECODE
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 


UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.MULTIISIN M(NOLOCK)
WHERE	M.SCRIP_CD = #DATA.SCRIP_CD
		AND M.SERIES = #DATA.SERIES
		AND M.VALID = 1
		AND ISNULL(#DATA.ISIN,'') = ''

/** --- NEW CHANGES DONE ON 09/07/2025 --- **/

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')--,
		--BSECODE = (CASE WHEN ISNULL(#DATA.BSECODE,'') = '' THEN ISNULL(M.BSECODE,'') ELSE ISNULL(#DATA.BSECODE,'') END)
FROM	MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M (NOLOCK)
WHERE	M.NSE_SCRIP_CD = #DATA.SCRIP_CD
		AND M.NSE_SERIES = #DATA.SERIES
		AND @PREVDATE BETWEEN FROM_DATE AND TO_DATE
		AND ISNULL(#DATA.ISIN,'') = ''

UPDATE	#DATA
SET		BSECODE = ISNULL(M.SCRIP_CD,#DATA.BSECODE)
FROM	BSEDB.DBO.MULTIISIN M(NOLOCK)
WHERE	M.ISIN = #DATA.ISIN
		AND M.VALID = 1
		AND ISNULL(#DATA.BSECODE,'') = ''

/** --- NEW CHANGES DONE ON 09/07/2025 --- **/

/** --- NEW CHANGES DONE ON 12/07/2025 FOR CA PROCESS --- **/

UPDATE	#DATA
SET		ISIN = ISNULL(P.ISIN,#DATA.ISIN)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN <> #DATA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

/** --- NEW CHANGES DONE ON 09/07/2025 --- **/

--SELECT '#DATA-1-NEWMTF',* FROM #DATA WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

ALTER	TABLE #DATA
ADD		CORP_BEFORE_QTY NUMERIC(18,4),
		CORP_AFTER_QTY	NUMERIC(18,4)

/*
UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = ISNULL(T.M_FRESHBQTY,0),
		NF_QTY = ISNULL(T.M_NETQTY,0)
FROM	TBL_MTR_REPORTING T(NOLOCK)
WHERE	#TBL_MTF_DATA_BUY.SAUDA_DATE = @SAUDA_DATE
		AND T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTR_REPORTING T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND T.M_FRESHBQTY > 0
		AND EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
					AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
					AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)
					*/

UPDATE	#DATA
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')
		AND #DATA.M_FRESHBQTY > 0


UPDATE	#DATA
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND #DATA.CORP_AFTER_QTY <> 0
		AND #DATA.M_FRESHBQTY > 0

UPDATE	#DATA
SET		M_FRESHBQTY = M_FRESHBQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		M_NETQTY = M_NETQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)
		AND M_FRESHBQTY > 0
		AND BODQTY > 0

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES, PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
M_BODQTY = SUM(M_BODQTY),
M_BODVALUE = SUM(M_BODVALUE),
M_FRESHBQTY = SUM(M_FRESHBQTY),
M_FRESHBUY = SUM(M_FRESHBUY),
M_FRESHSQTY = SUM(M_FRESHSQTY),
M_FRESHSELL = SUM(M_FRESHSELL),
M_NETQTY = SUM(M_NETQTY),--SUM(M_BODQTY) + SUM(M_FRESHBQTY) - SUM(M_FRESHSQTY),
M_NETAMOUNT = SUM(M_NETAMOUNT), --SUM(M_BODVALUE + M_FRESHBUY - M_FRESHSELL),
EXCHANGE,
ISIN,
--M_PRICE = (CASE WHEN SUM(ISNULL(M_NETQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))/SUM(ISNULL(M_NETQTY,0))) ELSE 0 END)--,
M_PRICE = (CASE WHEN SUM(ISNULL(M_FRESHBQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),ROUND(SUM(M_FRESHBUY)/SUM(M_FRESHBQTY),4)) ELSE 0 END)
--SETT_NO
,BSECODE
INTO #DATAFINAL      
FROM #DATA  
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, SERIES, PARTY_CODE, EXCHANGE, ISIN, BSECODE --, SETT_NO  

ALTER TABLE #DATAFINAL
ADD	SRNO INT IDENTITY(1,1)

--SELECT '#DATAFINAL-1',* FROM #DATAFINAL WHERE PARTY_CODE IN ('AA0895')


UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

UPDATE #DATAFINAL SET M_NETAMOUNT = 0
WHERE M_NETQTY = 0

DECLARE @GLCODE	VARCHAR(10)

SELECT	@GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

--------------------------------------------------------------------------------------------------

---- MTF_CASH_PAYIN_LEDGER --------------

SELECT	PARTY_CODE = CLTCODE, 
		PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0),
		PAYIN_ALLOCATED_AMT = CONVERT(NUMERIC(18,2),0),
		PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),0),
		ACNAME = P.ACNAME, 
		DRCR = 'D',
		VNO = CONVERT(VARCHAR(12),''),
		GLCODE = @GLCODE,
		VDT
INTO	#EXCESS_PAYIN_JV
FROM	LEDGER P(NOLOCK)
WHERE	---VDT = @PREVDATE 
		P.VDT BETWEEN @SDTCUR AND @LDTCUR
		AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
		AND P.VTYP = '66'
		--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
		AND P.EDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
		AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
		AND P.NARRATION LIKE '%MTF PAYIN'
GROUP BY
		CLTCODE, P.ACNAME, VDT

ALTER TABLE #EXCESS_PAYIN_JV
ADD SNO	INT	IDENTITY(1,1)
		
UPDATE	#EXCESS_PAYIN_JV
SET		PAYIN_ALLOCATED_AMT = ISNULL(A.M_FRESHBUY,0)
FROM	(
		SELECT	PARTY_CODE,
				M_FRESHBUY = ROUND(SUM(M_AMT),2),
				SAUDA_DATE
		FROM	#TBL_MTF_DATA_BUY D
		GROUP BY
				PARTY_CODE,
				SAUDA_DATE
		) A
WHERE	A.PARTY_CODE = #EXCESS_PAYIN_JV.PARTY_CODE
		AND A.SAUDA_DATE = #EXCESS_PAYIN_JV.VDT
					
--SELECT '#DATAFINAL', * FROM	#DATAFINAL D WHERE PARTY_CODE IN ('600M7016')

UPDATE	#EXCESS_PAYIN_JV SET PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),ROUND((PAYIN_AMT-PAYIN_ALLOCATED_AMT),2))
WHERE	(PAYIN_AMT-PAYIN_ALLOCATED_AMT) <> 0

--SELECT '#DATAFINAL_NEWMTF',* FROM #DATAFINAL WHERE party_code='AJ8050' ---AND ISIN='INE260D01016'

--------------------------------------------------------------------------------------------------

SELECT	SAUDA_DATE,
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		NETQTY,
		CLOSE_QTY = ABS(NETQTY-(M_FRESHBQTY+M_NETQTY)),
		M_FRESHBQTY,
		M_FRESHBUY,
		M_NETQTY,
		M_PRICE,
		M_NETQTY_NEW = 0,
		M_FRESHBQTY_NEW = 0,
		EXCHANGE,
		ISIN,
		SRNO,
		SETT_NO = CONVERT(VARCHAR(15),''),
		PAYIN_DATE = CONVERT(DATETIME,''),
		BSECODE,
		FRESHBQTY,
		FRESHBUY,
		FRESHSQTY,
		FRESHSELL,
		NETAMOUNT,
		M_NETAMOUNT
INTO	#CLOSEPOS
FROM	#DATAFINAL
WHERE	(NETQTY-(M_FRESHBQTY+M_NETQTY)) < 0


UPDATE	#CLOSEPOS 
SET		PAYIN_DATE = ISNULL(LEFT(SM.FUNDS_PAYIN,11),''),
		SETT_NO = ISNULL(SM.SETT_NO,'')
FROM	MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	SM.START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
		AND SM.SETT_TYPE = 'N'


--SELECT	'#CLOSEPOS-1-NEWMTF',* FROM #CLOSEPOS WHERE PARTY_CODE='AA2298' AND ISIN='INE260D01016'

IF @PROPOR_ALLOC_FLAG = 1
BEGIN
	/*
	DECLARE @NONFNO		INT,
			@FNO		INT

	SELECT	@NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER
	WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL C
	WHERE C.RECDATE >= @SAUDA_DATE aND c.REcDATE <= @SAUDA_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES NOT IN ('BO')
	AND ISIN IN (SELECT DISTINCT ISIN FROM #CLOSEPOS)

	SELECT V.* INTO  #BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	WHERE V.FDATE >= @SAUDA_DATE aND v.FDATE <= @SAUDA_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #CLOSEPOS)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )
	*/

	ALTER	TABLE #CLOSEPOS
	ADD		MARGIN_REQ	NUMERIC(18,4),
			HAIRCUT		NUMERIC(18,4),
			PRO_M_QTY	INT,
			PRO_PRICE	NUMERIC(18,4),
			BAL_NET_QTY	INT,
			PRO_ALLOC_PER	NUMERIC(18,4)

	UPDATE	#CLOSEPOS 
	SET		MARGIN_REQ	= 0,
			HAIRCUT		= 0,
			PRO_M_QTY	= 0,
			PRO_PRICE	= 0,
			BAL_NET_QTY = 0,
			PRO_ALLOC_PER = 0

 --   UPDATE	#CLOSEPOS 
 --   SET		HAIRCUT = M.APPVAR + @NONFNO * SECSPECVAR
 --   FROM	#B_NSE_VAR M
 --   WHERE	M.ISIN = #CLOSEPOS.ISIN 
	--AND		HAIRCUT = 0

	--UPDATE	#CLOSEPOS 
	--SET		HAIRCUT = M.MARGIN + @NONFNO * ELM
	--FROM	#B_BSE_VAR M
	--WHERE	M.ISIN = #CLOSEPOS.ISIN 
	--AND		HAIRCUT = 0

	
	UPDATE	#CLOSEPOS
	SET		PRO_ALLOC_PER = ROUND(M_FRESHBUY/(M_FRESHBUY+M_NETAMOUNT)*100,2)
	WHERE	M_FRESHBUY > 0 AND (M_FRESHBUY+M_NETAMOUNT) > 0

	UPDATE	#CLOSEPOS
	SET		MARGIN_REQ = ((FRESHSQTY*M_PRICE)/100*PRO_ALLOC_PER),
			PRO_PRICE = ROUND(M_PRICE,4)
	WHERE	FRESHSELL > 0 AND PRO_ALLOC_PER > 0

	UPDATE	#CLOSEPOS
	SET		PRO_M_QTY = FLOOR((MARGIN_REQ/PRO_PRICE)) 
	WHERE	PRO_PRICE > 0 AND MARGIN_REQ > 0

	UPDATE	#CLOSEPOS
	SET		BAL_NET_QTY = (FRESHSQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND FRESHSQTY > 0

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY = (M_FRESHBQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND M_FRESHBQTY > 0
		
	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN (M_FRESHBQTY - PRO_M_QTY) >= 0 THEN (M_FRESHBQTY - PRO_M_QTY) 
				ELSE M_FRESHBQTY 
			END)

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = M_NETQTY - BAL_NET_QTY
	WHERE	(M_NETQTY - BAL_NET_QTY) >= 0
	
END
ELSE
BEGIN
	
	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN (M_NETQTY - CLOSE_QTY) <= 0 THEN 0 ELSE (M_NETQTY - CLOSE_QTY) END)

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN M_NETQTY_NEW = 0 THEN 
				CASE WHEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) > 0 THEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) ELSE 0 END 
				ELSE M_FRESHBQTY 
			END)
END

UPDATE	#DATAFINAL 
SET		M_FRESHBQTY = M_FRESHBQTY_NEW,
		M_NETQTY = M_NETQTY_NEW,
		M_FRESHBUY = M_FRESHBQTY_NEW*#CLOSEPOS.M_PRICE,
		M_NETAMOUNT = M_NETQTY_NEW*#CLOSEPOS.M_PRICE
FROM	#CLOSEPOS
WHERE	#CLOSEPOS.PARTY_CODE = #DATAFINAL.PARTY_CODE
		AND #CLOSEPOS.SCRIP_CD = #DATAFINAL.SCRIP_CD
		AND #CLOSEPOS.ISIN = #DATAFINAL.ISIN
		AND #CLOSEPOS.EXCHANGE = #DATAFINAL.EXCHANGE
		AND #CLOSEPOS.SRNO = #DATAFINAL.SRNO

--SELECT '#DATAFINAL-2',* FROM #DATAFINAL WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'
--SELECT	'#DATAFINAL-2-NEWMTF',* FROM #DATAFINAL WHERE PARTY_CODE='AM7931' 
--SELECT	'#CLOSEPOS-2-NEWMTF',* FROM #CLOSEPOS WHERE PARTY_CODE='AM7931' 

INSERT	INTO TBL_MTF_DATA_BUY_ALLOC_LOG
SELECT	SAUDA_DATE=CONVERT(DATETIME,SAUDA_DATE,103),PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY=CLOSE_QTY,MKTAMT=0,NETAMT=0,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT=0,PAYIN_AMT_BAL=0,
		M_QTY=(M_FRESHBQTY-M_FRESHBQTY_NEW),
		M_PRICE,M_AMT=(M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE,
		M_ALLOC_BALANCE=(M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE, 
		NF_QTY=0,NF_AMT=0,SELL_BUY=2,
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#CLOSEPOS


SELECT	PARTY_CODE, 
		M_FRESHBQTY = SUM(M_FRESHBQTY_NEW),
		M_NETQTY = SUM(M_NETQTY_NEW),
		M_BALANCE_QTY = SUM(M_FRESHBQTY-M_FRESHBQTY_NEW),
		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(SUM((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE),2)),
		VNO = CONVERT(VARCHAR(12),''),
		ACNAME = CONVERT(VARCHAR(100),''),
		DRCR = 'D',
		GLCODE = @GLCODE,
		AMOUNT_ORG = CONVERT(NUMERIC(18,2),0),
		MARGIN_REQ = CONVERT(NUMERIC(18,2),0),
		MTOM_LOSS = CONVERT(NUMERIC(18,2),0)--,
		--SETT_NO
INTO	#DATAFINAL_JV 
FROM	#CLOSEPOS
WHERE	(M_FRESHBQTY-M_FRESHBQTY_NEW) > 0
		--AND (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END) > 0
GROUP BY
		PARTY_CODE

--select '#CLOSEPOS',(M_FRESHBQTY-M_FRESHBQTY_NEW),M_PRICE,(M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE,* from #CLOSEPOS where party_code='AJ8050' 

--SELECT '#DATAFINAL_JV',* FROM #DATAFINAL_JV WHERE PARTY_CODE='AA0895' 

--UPDATE	#DATAFINAL_JV
--SET		AMOUNT_ORG = ROUND(NETAMT,2)
--FROM	(
--		SELECT	PARTY_CODE, 
--				NETAMT = (CASHLEDADJ+FOLEDBALADJ)
--		FROM	TBL_MTF_DATA 
--		WHERE	SAUDA_DATE = @SAUDA_DATE
--		GROUP BY
--				PARTY_CODE,
--				CASHLEDADJ,
--				FOLEDBALADJ
--		HAVING (CASHLEDADJ+FOLEDBALADJ) < 0
--		) A
--WHERE	A.PARTY_CODE = #DATAFINAL_JV.PARTY_CODE


--UPDATE	#DATAFINAL_JV
--SET		AMOUNT = PRADNYA.DBO.FNMIN(AMOUNT,AMOUNT_ORG)


/*--- MARGIN REQUIRMENT ADJUSTMENT AGAINTS CASH BALANCE LOGIC 07/07/2025 ---*/
/*
UPDATE	#DATAFINAL_JV
SET		MARGIN_REQ	= ISNULL(A.TOT_MARGIN_REQ,0),
		MTOM_LOSS	= ISNULL(A.TOT_MTOM_LOSS,0)
FROM	(
		SELECT	PARTY_CODE,
				TOT_MARGIN_REQ = SUM(MARGIN_REQ),
				TOT_MTOM_LOSS = SUM(MTOM_LOSS)
		FROM	TBL_MTF_DATA_BUY(NOLOCK) 
		WHERE	SAUDA_DATE = @SAUDA_DATE
		GROUP BY
				PARTY_CODE
		HAVING SUM(MARGIN_REQ+MTOM_LOSS) > 0
		) A
WHERE	A.PARTY_CODE = #DATAFINAL_JV.PARTY_CODE
		AND #DATAFINAL_JV.AMOUNT > A.TOT_MARGIN_REQ
*/

--SELECT '#DATAFINAL_JV',* FROM #DATAFINAL_JV WHERE PARTY_CODE IN ('600B1285')


--SELECT	PARTY_CODE, 
--		M_FRESHBQTY = (
--		CASE 
--			WHEN (M_NETQTY + CLOSE_QTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY + CLOSE_QTY)) 
--			ELSE M_FRESHBQTY 
--		END),
--		M_NETQTY = (CASE WHEN (M_NETQTY + CLOSE_QTY) < 0 THEN 0 ELSE (M_NETQTY + CLOSE_QTY) END),
--		M_BALANCE_QTY = 0,
--		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((M_NETQTY - FRESHSQTY)*M_PRICE),2)),
--		VNO = CONVERT(VARCHAR(12),''),
--		ACNAME = CONVERT(VARCHAR(100),''),
--		DRCR = (CASE WHEN ((M_NETQTY - FRESHSQTY)*M_PRICE) > 0 THEN 'C' ELSE 'D' END),
--		GLCODE = @GLCODE
--INTO	#DATAFINAL_JV 
--FROM	#CLOSEPOS
--WHERE	(M_NETQTY - FRESHSQTY) < 0 AND M_NETQTY > 0
--		--AND (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END) > 0
		
--SELECT	'#DATAFINAL_JV',* FROM #DATAFINAL_JV --WHERE PARTY_CODE IN ('AI3654','AL0587','AC2370','AH1057')
--RETURN


--UPDATE	#DATAFINAL 
--SET		M_FRESHBQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END),
--		M_NETQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN 0 ELSE M_NETQTY END)
--WHERE	FRESHSQTY > 0 AND M_NETQTY > 0
--		--AND (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END) > 0

--UPDATE	#DATAFINAL 
--SET		M_FRESHBUY = M_FRESHBQTY*M_PRICE,
--		M_NETAMOUNT = M_NETQTY*M_PRICE
--WHERE	FRESHSQTY > 0 AND (M_FRESHBQTY > 0 OR M_NETQTY > 0)


--SELECT	M_NETQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN 0 ELSE M_NETQTY END),
--		M_FRESHBQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN M_FRESHBQTY + (M_NETQTY - FRESHSQTY) ELSE M_FRESHBQTY END),
--		*
--FROM	#DATAFINAL
--WHERE	FRESHSQTY > 0 AND PARTY_CODE='AF2204'


--SELECT '#DATAFINAL-2',* FROM #DATAFINAL WHERE PARTY_CODE IN ('AF7259')

/*
SELECT * FROM #DATAFINAL

UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0   
          THEN FRESHBQTY - FRESHSQTY  
          ELSE 0  
           END),  
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0   
          THEN FRESHBUY - FRESHSELL  
          ELSE 0  
           END),  
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0   
          THEN FRESHSQTY - FRESHBQTY  
          ELSE 0  
           END),  
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0   
          THEN FRESHSELL - FRESHBUY  
          ELSE 0  
           END)  
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0   
  
DELETE FROM #DATAFINAL  
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0  
*/  
	--SELECT * FROM #DATAFINAL WHERE PARTY_CODE IN ('FU90106') AND SCRIP_CD='BDL'

	DELETE FROM TBL_MTR_REPORTING
	WHERE SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE)
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)

	SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),
	PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
	M_BODQTY = SUM(M_BODQTY),
	M_BODVALUE = SUM(M_BODVALUE),
	M_FRESHBQTY = SUM(M_FRESHBQTY),
	M_FRESHBUY = SUM(M_FRESHBUY),
	M_FRESHSQTY = SUM(M_FRESHSQTY),
	M_FRESHSELL = SUM(M_FRESHSELL),
	M_NETQTY = SUM(M_NETQTY),
	M_NETAMOUNT = SUM(M_NETAMOUNT), --SUM(M_BODVALUE + M_FRESHBUY - M_FRESHSELL),
	EXCHANGE,
	PROCESSDATE = GETDATE(),
	ISIN,
	BSECODE
	INTO #DATAFINAL_NEW
	FROM #DATAFINAL      
	GROUP BY LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, EXCHANGE, ISIN, BSECODE  
	ORDER BY PARTY_CODE, SCRIP_CD, SERIES 
	
	UPDATE  #DATAFINAL_NEW SET FRESHSELL = FRESHSELL + NETAMOUNT, NETAMOUNT = 0
	WHERE	SAUDA_DATE = @SAUDA_DATE AND NETQTY = 0 AND NETAMOUNT <> 0

	UPDATE  #DATAFINAL_NEW SET M_FRESHBUY = ROUND((BODVALUE + FRESHBUY - FRESHSELL),2)
	WHERE	SAUDA_DATE = @SAUDA_DATE AND NETQTY = M_FRESHBQTY
	
	INSERT INTO TBL_MTR_REPORTING
	SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),
	PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY,    
	BODVALUE,       
	FRESHBQTY,    
	FRESHBUY,     
	FRESHSQTY,    
	FRESHSELL,       
	NETQTY,    
	NETAMOUNT,
	M_BODQTY,
	M_BODVALUE,
	M_FRESHBQTY,
	M_FRESHBUY,
	M_FRESHSQTY,
	M_FRESHSELL,
	M_NETQTY,
	M_NETAMOUNT,
	EXCHANGE,
	PROCESSDATE = GETDATE(),
	ISIN,
	BSECODE
	FROM #DATAFINAL_NEW      
	ORDER BY PARTY_CODE, SCRIP_CD, SERIES
	
	SELECT	PARTY_CODE,
			AMOUNT = SUM(M_FRESHBUY) - ROUND(SUM(BODVALUE + FRESHBUY - FRESHSELL),2),
			VNO = CONVERT(VARCHAR(12),''),
			ACNAME = CONVERT(VARCHAR(100),''),
			DRCR = (CASE WHEN (SUM(M_FRESHBUY) - ROUND(SUM(BODVALUE + FRESHBUY - FRESHSELL),2)) > 0 THEN 'D' ELSE 'C' END),
			GLCODE = @GLCODE
	INTO	#JV_SELLPAYIN_ADJ
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @SAUDA_DATE
			AND NETQTY = M_FRESHBQTY
	GROUP BY
			PARTY_CODE

	/*------ JV INSERT -------*/


	--SELECT	PARTY_CODE, 
	--		M_FRESHBQTY,
	--		M_NETQTY,
	--		M_BALANCE_QTY = (M_NETQTY - FRESHSQTY),
	--		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((M_NETQTY - FRESHSQTY)*M_PRICE),2)),
	--		VNO = CONVERT(VARCHAR(12),''),
	--		ACNAME = CONVERT(VARCHAR(100),''),
	--		DRCR = (CASE WHEN ((M_NETQTY - FRESHSQTY)*M_PRICE) > 0 THEN 'C' ELSE 'D' END),
	--		GLCODE = @GLCODE
	--INTO	#DATAFINAL_JV 
	--FROM	#DATAFINAL
	--WHERE	(M_NETQTY - FRESHSQTY) < 0
		
	--SELECT	'#DATAFINAL_JV',* FROM #DATAFINAL_JV WHERE PARTY_CODE IN ('AF7259')


	ALTER TABLE #DATAFINAL_JV
	ADD SNO	INT	IDENTITY(1,1)

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #DATAFINAL_JV 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN
		
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT	INTO #VNO 
		EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT	@VNO = VNO FROM #VNO

		UPDATE	#DATAFINAL_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#DATAFINAL_JV SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#DATAFINAL_JV.PARTY_CODE = A.CLTCODE

		
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/
		/*
		DELETE FROM MTF_CASH_COLL_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_COLL_LEDGER.CLTCODE AND AMOUNT <> 0)
		DELETE FROM MTF_CASH_PAYIN_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_PAYIN_LEDGER.CLTCODE AND AMOUNT <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		
		DELETE FROM MTF_CASH_COLL_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_COLL_LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		DELETE FROM MTF_CASH_PAYIN_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_PAYIN_LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		*/
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND VTYP = '6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND VTYP = '66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)

		/*---- MTF_CASH_COLL_LEDGER -----------*/

		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
		FROM #DATAFINAL_JV
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

		
		---- PAYIN JV (MARGIN_REQ) ----
		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR, AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '18.MTF PAYIN'
		FROM #DATAFINAL_JV
		WHERE MARGIN_REQ <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '18.MTF PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MARGIN_REQ <> 0
		
		/*
		--- TDAY MTM LOGICAL BUG EXTRA ENTRY ---
		---- MTM JV (MTOM_LOSS) ----
		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '19.MTF MTM'
		FROM #DATAFINAL_JV
		WHERE MTOM_LOSS <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '19.MTF MTM'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MTOM_LOSS <> 0
	

		---- MTM JV (MTOM_LOSS) ----
		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '20.MTF MTM'
		FROM #DATAFINAL_JV
		WHERE MTOM_LOSS <> 0

		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '20.MTF MTM'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MTOM_LOSS <> 0
		*/

		--INSERT INTO MTF_CASH_PAYIN_LEDGER
		--SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '25.MTF SELL PAYIN'
		--FROM #DATAFINAL_JV
		--WHERE AMOUNT <> 0

		--INSERT INTO MTF_CASH_PAYIN_LEDGER
		--SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '26.MTF SELL PAYIN'
		--FROM #DATAFINAL_JV J, ACMAST A
		--WHERE J.GLCODE = A.CLTCODE
		--AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
		FROM #DATAFINAL_JV
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

		---- PAYIN JV (MARGIN_REQ) ----
		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '22.MTF PAYIN'
		FROM #DATAFINAL_JV
		WHERE MARGIN_REQ <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '22.MTF PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MARGIN_REQ <> 0

	END

	--DROP TABLE #DATAFINAL_JV

	/*
	SELECT	PARTY_CODE = CLTCODE, 
			PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0),
			PAYIN_ALLOCATED_AMT = CONVERT(NUMERIC(18,2),0),
			PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),0),
			ACNAME = P.ACNAME, 
			DRCR = 'D',
			VNO = CONVERT(VARCHAR(12),''),
			GLCODE = @GLCODE
	INTO	#EXCESS_PAYIN_JV
	FROM	MTF_CASH_PAYIN_LEDGER P(NOLOCK)
	WHERE	---VDT = @PREVDATE 
			P.VDT BETWEEN @SDTCUR AND @LDTCUR
			AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
			--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
			AND P.EDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
			AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
			AND P.NARRATION='MTF PAYIN'
	GROUP BY
			CLTCODE, P.ACNAME

	ALTER TABLE #EXCESS_PAYIN_JV
	ADD SNO	INT	IDENTITY(1,1)
		
	UPDATE	#EXCESS_PAYIN_JV
	SET		PAYIN_ALLOCATED_AMT = ISNULL(A.M_FRESHBUY,0)
	FROM	(
			SELECT	PARTY_CODE,
					M_FRESHBUY = SUM(M_FRESHBUY)
			FROM	#DATAFINAL D
			GROUP BY
					PARTY_CODE
			) A
	WHERE	A.PARTY_CODE = #EXCESS_PAYIN_JV.PARTY_CODE
					
	--SELECT '#DATAFINAL', * FROM	#DATAFINAL D WHERE PARTY_CODE IN ('600M7016')

	--SELECT '#EXCESS_PAYIN_JV-1',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE IN ('600M7016')

	UPDATE	#EXCESS_PAYIN_JV SET PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),ROUND((PAYIN_AMT-PAYIN_ALLOCATED_AMT),2))
	WHERE	(PAYIN_AMT-PAYIN_ALLOCATED_AMT) <> 0

	SELECT '#EXCESS_PAYIN_JV-2',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE IN ('AF7259')
	*/

	
	/*---  SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE ---*/

	ALTER TABLE #JV_SELLPAYIN_ADJ
	ADD SNO	INT	IDENTITY(1,1)

	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JV_SELLPAYIN_ADJ 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN

		CREATE TABLE #VNO5
		(
			VNO	VARCHAR(12)
		)


		INSERT INTO #VNO5 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO5

		UPDATE	#JV_SELLPAYIN_ADJ SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#JV_SELLPAYIN_ADJ SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#JV_SELLPAYIN_ADJ.PARTY_CODE = A.CLTCODE

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ WHERE #JV_SELLPAYIN_ADJ.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ WHERE #JV_SELLPAYIN_ADJ.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)


		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'D'

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'D'
	

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'D'

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'D'




		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'C'

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'C'

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'C'

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'C'

	END

	/*---  SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE ---*/

	/*---  SELL PAYIN ROUNDING DIFF ADJUSTMENT ENTRY ---*/

	SELECT	PARTY_CODE
	INTO	#PARTY
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @SAUDA_DATE
	AND EXISTS (SELECT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = TBL_MTR_REPORTING.PARTY_CODE AND AMOUNT<>0) 
	GROUP BY
			PARTY_CODE
	HAVING	SUM(M_FRESHBQTY) = 0	
	
	SELECT	PARTY_CODE, 
			CASHCOLL_AMT=CONVERT(NUMERIC(18,2),(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0 
					THEN SUM(NETAMT) + MTFLEDBAL
					ELSE 0
				END))
	INTO	#JV_SELLPAYIN_ADJ_DIFF_1
	FROM	TBL_MTF_DATA T(NOLOCK)
	WHERE	SAUDA_DATE = @SAUDA_DATE
			AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = T.PARTY_CODE)
	GROUP BY
			PARTY_CODE, MTFLEDBAL

	UNION
	
	SELECT	PARTY_CODE,
			CASHCOLL_AMT = SUM(PAYIN_AMT)
	FROM	(
			SELECT	PARTY_CODE = CLTCODE, 
					PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0)
			FROM	LEDGER P(NOLOCK)
			WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
					AND P.VDT <= @SAUDA_DATE + ' 23:59' 
					AND P.VTYP = '66'
					AND P.EDT BETWEEN @SDTCUR AND @EDT + ' 23:59'
			GROUP BY
					CLTCODE

			UNION

			SELECT	PARTY_CODE = CLTCODE, 
					PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0)
			FROM	LEDGER P(NOLOCK)
			WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
					AND P.VDT <= @SAUDA_DATE + ' 23:59' 
					AND P.VTYP = '67'
					AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59'
			GROUP BY
					CLTCODE
			) A
	WHERE	EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = A.PARTY_CODE)
	GROUP BY
			PARTY_CODE

	--SELECT * FROM #JV_SELLPAYIN_ADJ_DIFF_1 WHERE PARTY_CODE='AA0895'

	SELECT	PARTY_CODE, 
			AMOUNT = SUM(CASHCOLL_AMT),
			DRCR = CASE WHEN SUM(CASHCOLL_AMT) > 0 THEN 'D' ELSE 'C' END,
			GLCODE = @GLCODE,
			ACNAME = CONVERT(VARCHAR(100),''),
			VNO	= CONVERT(VARCHAR(12),'')
	INTO	#JV_SELLPAYIN_ADJ_DIFF
	FROM	#JV_SELLPAYIN_ADJ_DIFF_1
	GROUP BY
			PARTY_CODE
	HAVING	SUM(CASHCOLL_AMT) < 0 

	--SELECT * FROM #JV_SELLPAYIN_ADJ_DIFF WHERE PARTY_CODE='AA0895'

	ALTER TABLE #JV_SELLPAYIN_ADJ_DIFF
	ADD SNO	INT	IDENTITY(1,1)

	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JV_SELLPAYIN_ADJ_DIFF

	IF @RECCNT > 0 AND @MTFFLAG >= 1
	BEGIN

		CREATE TABLE #VNO6
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO6 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO6

		UPDATE	#JV_SELLPAYIN_ADJ_DIFF SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#JV_SELLPAYIN_ADJ_DIFF SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#JV_SELLPAYIN_ADJ_DIFF.PARTY_CODE = A.CLTCODE

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN ROUNDING DIFF ADJ%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ_DIFF WHERE #JV_SELLPAYIN_ADJ_DIFF.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN ROUNDING DIFF ADJ%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ_DIFF WHERE #JV_SELLPAYIN_ADJ_DIFF.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ_DIFF
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ_DIFF J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0
	

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

	END

	/*---  SELL PAYIN ROUNDING DIFF ADJUSTMENT ENTRY ---*/



	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #EXCESS_PAYIN_JV 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN

		CREATE TABLE #VNO1
		(
			VNO	VARCHAR(12)
		)


		INSERT INTO #VNO1 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO1

		UPDATE	#EXCESS_PAYIN_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#EXCESS_PAYIN_JV SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#EXCESS_PAYIN_JV.PARTY_CODE = A.CLTCODE

		/*---- COMMENTED ON DATE : 09/06/2025 -------*/
		/*
		DELETE FROM MTF_CASH_COLL_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = MTF_CASH_COLL_LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		
		DELETE FROM MTF_CASH_PAYIN_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = MTF_CASH_PAYIN_LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		*/
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		
		--SELECT '#EXCESS_PAYIN_JV-3',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE IN ('AF7259','AJ7857')

		/*---- MTF_CASH_PAYIN_LEDGER ------*/

		INSERT INTO LEDGER
		SELECT '66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '23.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '23.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0
	
		/*---- MTF_CASH_COLL_LEDGER ------*/

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '24.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '24.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		/*
		EXCESS AVAILABLE CASH AMOUT AFTER PAYIN ALLOCATION IS STOPPED.. 

		INSERT INTO MTF_CASH_COLL_LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '31.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO MTF_CASH_COLL_LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '32.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0


		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '33.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '34.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '35.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '36.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		SELECT '#EXCESS_PAYIN_JV',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE='AF7259'

		DELETE	FROM MTF_JVDATA
		WHERE	SAUDA_DATE = @SAUDA_DATE

		INSERT	INTO MTF_JVDATA
		SELECT	@SAUDA_DATE,
				PARTY_CODE,
				PAYIN_EXCESS_AMT,
				FLAG='CASH',
				GLCODE,
				VNO,
				ACNAME,
				PROCESSDATE = GETDATE(),
				DRCR
		FROM	#EXCESS_PAYIN_JV

		--SELECT 'MTF_JVDATA',* FROM MTF_JVDATA WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE IN ('AF7259')

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'PAYIN-REV'
		EXEC ACCOUNTFO.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'PAYIN-REV'

		SELECT 'LEDGER-2',* FROM ACCOUNT..LEDGER WHERE CLTCODE='AF7259' AND VDT=@SAUDA_DATE
		*/	
	
	END
	

--------------------------------EXCESS CASH COLL REV JV FOR T+1 DAY (FULL & FINAL)------------------------------------------------

	SELECT	PARTY_CODE = CLTCODE, 
			PAYIN_AMT = CONVERT(NUMERIC(18,2),0),
			PAYIN_ALLOCATED_AMT = CONVERT(NUMERIC(18,2),0),
			PAYIN_EXCESS_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0),
			ACNAME = P.ACNAME, 
			DRCR = 'D',
			VNO = CONVERT(VARCHAR(12),''),
			GLCODE = @GLCODE
	INTO	#EXCESS_PAYIN_JV_T1D
	FROM	LEDGER P(NOLOCK)
	WHERE	---VDT = @PREVDATE 
			P.VDT BETWEEN @SDTCUR AND @LDTCUR
			--AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
			AND P.VDT = @SAUDA_DATE
			AND P.VTYP = '6'
			--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
			AND P.EDT BETWEEN @SAUDA_DATE AND @EDT + ' 23:59:59' --VDT = @PREVDATE 
			AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
	GROUP BY
			CLTCODE, P.ACNAME
	HAVING	ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0) > 0


	ALTER TABLE #EXCESS_PAYIN_JV_T1D
	ADD SNO	INT	IDENTITY(1,1)

	--SELECT '#EXCESS_PAYIN_JV_T1D',* FROM #EXCESS_PAYIN_JV_T1D WHERE PARTY_CODE IN ('AF7259')

	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #EXCESS_PAYIN_JV_T1D 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN

		CREATE TABLE #VNO2
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO2 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO2

		UPDATE	#EXCESS_PAYIN_JV_T1D SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#EXCESS_PAYIN_JV_T1D SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#EXCESS_PAYIN_JV_T1D.PARTY_CODE = A.CLTCODE

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF EXCESS CASH COLL REV JV' AND CHECKEDBY = 'MTF PROCESS' AND VTYP ='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV_T1D WHERE #EXCESS_PAYIN_JV_T1D.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF EXCESS CASH COLL REV JV FOR T+1 DAY' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV_T1D WHERE #EXCESS_PAYIN_JV_T1D.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		/* ---- MTF_CASH_COLL_LEDGER -------- */

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '25.MTF EXCESS CASH COLL REV JV'
		FROM #EXCESS_PAYIN_JV_T1D
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '25.MTF EXCESS CASH COLL REV JV'
		FROM #EXCESS_PAYIN_JV_T1D J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0


		/*---- COMMENTED ON DATE : 09/06/2025 [ FOLLOWING LOGIC IS FOR TRANSFERING FROM MTF CASH COLL LEDGER TO MTF LEDGER ] -------*/
		/*
		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '26.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '26.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '27.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '27.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0
		*/
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/

		
		--SELECT '#EXCESS_PAYIN_JV',* FROM #EXCESS_PAYIN_JV_T1D WHERE PARTY_CODE='AF7259'

		DELETE	FROM MTF_JVDATA
		WHERE	SAUDA_DATE = @SAUDA_DATE

		INSERT	INTO MTF_JVDATA (SAUDA_DATE,PARTY_CODE,AMOUNT,FLAG,GLCODE,VNO,ACNAME,PROCESSDATE,DRCR)
		SELECT	@SAUDA_DATE,
				PARTY_CODE,
				PAYIN_EXCESS_AMT,
				FLAG='CASH',
				GLCODE,
				VNO,
				ACNAME,
				PROCESSDATE = GETDATE(),
				DRCR
		FROM	#EXCESS_PAYIN_JV_T1D

		--SELECT 'MTF_JVDATA',* FROM MTF_JVDATA WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE IN ('AF7259')

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'CASH-T1DAY-REV'
		EXEC ACCOUNTFO.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'CASH-T1DAY-REV'

	END

--------------------------------EXCESS CASH COLL REV JV FOR T1 DAY (FULL & FINAL)------------------------------------------------


END

ELSE
BEGIN                                     
	CREATE TABLE #REPORT    
	(    
	 SNO INT IDENTITY(1,1),    
	 DATA VARCHAR(5000)    
	)   

	INSERT INTO ASIANFILEBATCHNO    
	SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
	SET @BATCHNO = @BATCHNO + 1 
        
	SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
	MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
	BODQTY,    
	BODVALUE,     
	FRESHBQTY,      
	FRESHBUY,      
	FRESHSQTY,    
	FRESHSELL,
	NETQTY,      
	NETAMOUNT
	INTO #NSERPT
	FROM TBL_MTR_REPORTING   
	P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND C.CL_CODE = P.PARTY_CODE         
	AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
	and (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

	INSERT INTO #REPORT     
	SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
	REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
	+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT    
	GROUP BY MEMBERCODE     
    
	INSERT INTO #REPORT    
	SELECT DATA = '30,SELF,01,' +     
	CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT   
	GROUP BY #NSERPT.MEMBERCODE   
    
	INSERT INTO #REPORT    
	SELECT DATA = '20,' + REPLACE(ltrim(rtrim(LONG_NAME)),',','') + ',' +     
	ltrim(rtrim(PARTY_CODE)) + ',' + LTRIM(rtrim(UPPER(SCRIP_CD))) +',' + ltrim(rtrim(UPPER(SERIES))) +',' +   
	CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
	CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
	CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL))     
	FROM #NSERPT    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
  
	/*   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) < 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) < 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
  
	SELECT (SUM(BODVALUE + FRESHBUY - FRESHSELL)), SUM(NETQTY)  
	FROM   #DATAFINAL  
   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) > 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
	RETURN  
	*/  
 
  
	SELECT FILENAME = ltrim(rtrim('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
					+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
	DATA = ltrim(rtrim(upper(data))) FROM #REPORT    
	ORDER BY SNO   
	/*    
	SELECT RECORDTYPE = '10', FILETYPE = 'MTR', MEMBERCODE,    
	BATCHDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''),    
	BATCHNO = '01',SUMCNT = 1,    
	DETAILCNT = COUNT(1),    
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE     
    
	SELECT RECORDTYPE = '20', COMPANY, LEN_CAT = '01',     
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL, MSAJAG.DBO.OWNER     
	GROUP BY #DATAFINAL.MEMBERCODE,COMPANY    
    
	SELECT RECORDTYPE = '30', LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES,     
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
	*/    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSE_MTFFILE_NEWMTF_BKUP_26SEP2025
-- --------------------------------------------------







CREATE PROC [dbo].[RPT_NSE_MTFFILE_NEWMTF]      
(      
@SAUDA_DATE		VARCHAR(11),
@FLAG			INT = 0,
@PARTY_CODE		VARCHAR(10) = ''      
)      
AS      

--EXEC [RPT_NSE_MTFFILE_NEWMTF] 'JUL  7 2025', 1    

DECLARE @PREVDATE VARCHAR(11),     
		@BATCHNO	INT,
		@SDTCUR		DATETIME,
		@LDTCUR		DATETIME,
		@MTFFLAG	INT,
		@PROPOR_ALLOC_FLAG	INT
      
SELECT	@SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER(NOLOCK) 
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR      

SELECT	@BATCHNO = 0    
SELECT	@PROPOR_ALLOC_FLAG = 1
    
SELECT	@BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO    
WHERE	FLDFILENO = 'MT'    
		AND FLDFILEDATE = @SAUDA_DATE    
  
DECLARE	@VNO		VARCHAR(12),
		@RECCNT		INT,
		@EDT		VARCHAR(11)

SELECT	@EDT = LEFT(FUNDS_PAYIN,11) FROM MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND SETT_TYPE = 'M'


SELECT	@MTFFLAG = COUNT(1) FROM MTFTRADE..TBL_MTF_LOG WHERE FUNDING_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'

SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM       
VW_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE    


SELECT * INTO #MTR_RTP FROM TBL_MTR_REPORTING WHERE 1=2

ALTER TABLE #MTR_RTP
ALTER COLUMN BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN NETAMOUNT NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_BODVALUE NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHBUY NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_FRESHSELL NUMERIC(18,4)
ALTER TABLE #MTR_RTP
ALTER COLUMN M_NETAMOUNT NUMERIC(18,4)

IF (SELECT COUNT(1) FROM TBL_MTR_REPORTING WHERE SAUDA_DATE = @PREVDATE) > 0
BEGIN
	
	INSERT	INTO #MTR_RTP
	SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,
			M_BODQTY,M_BODVALUE,M_FRESHBQTY,M_FRESHBUY,M_FRESHSQTY,M_FRESHSELL,M_NETQTY,M_NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE 
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @PREVDATE

END
ELSE
BEGIN

	INSERT	INTO #MTR_RTP (SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BODQTY,BODVALUE,FRESHBQTY,FRESHBUY,FRESHSQTY,FRESHSELL,NETQTY,NETAMOUNT,EXCHANGE,PROCESSDATE,ISIN,BSECODE)
	SELECT	SAUDA_DATE=@PREVDATE,PARTY_CODE,SCRIP_CD,SERIES,
			BODQTY = SUM(QTY),      
			BODVALUE = SUM(MKTAMT),
			FRESHBQTY = 0,            
			FRESHBUY = 0,            
			FRESHSQTY = 0,      
			FRESHSELL = 0, 
			NETQTY = SUM(QTY),
			NETAMOUNT = SUM(MKTAMT),
			TRANSTYPE,
			SAUDA_DATE=@PREVDATE,
			ISIN,BSECODE
	FROM	VW_PRODUCT_POSITION
	WHERE	SAUDA_DATE <= @PREVDATE       
			AND ADJUST_DATE > @PREVDATE      
			AND SELL_BUY = 1
	GROUP BY
			PARTY_CODE,SCRIP_CD,SERIES,
			TRANSTYPE,ISIN,BSECODE
	HAVING	SUM(QTY) > 0 AND SUM(MKTAMT) > 0

END

IF @FLAG = 1 
BEGIN

SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,    
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),     
FRESHBQTY = SUM(QTY),     
FRESHBUY = CONVERT(NUMERIC(18,4),ROUND(SUM(MKTAMT),4) ),      
FRESHSQTY = 0,
FRESHSELL = CONVERT(NUMERIC(18,4),0),
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
INTO #DATA      
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @SAUDA_DATE       
AND ADJUST_DATE >= @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE, BSECODE, ISNULL(ISIN,'') --,SETT_NO --, ISNULL(P.ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 


INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = SUM(QTY),    
FRESHSELL = CONVERT(NUMERIC(18,4),ROUND(SUM(MKTAMT),4)),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = 0,
M_FRESHBUY = CONVERT(NUMERIC(18,4),0),
M_FRESHSQTY = 0,
M_FRESHSELL = CONVERT(NUMERIC(18,4),0),
M_NETQTY = 0,
M_NETAMOUNT = CONVERT(NUMERIC(18,4),0),
EXCHANGE = TRANSTYPE,
ISIN = ISNULL(ISIN,'')
--SETT_NO
,BSECODE
FROM VW_PRODUCT_POSITION P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE <= @SAUDA_DATE       
AND ADJUST_DATE = @SAUDA_DATE      
AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, TRANSTYPE,BSECODE, ISNULL(ISIN,'') --,SETT_NO --, ISNULL(P.ISIN,'')
HAVING SUM(QTY) > 0 AND SUM(MKTAMT) > 0 

--- MAINTENANCE MARGIN ---

/*
SELECT	PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY, MKTAMT,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0)
INTO	#TBL_MTF_DATA_BUY_1
FROM	TBL_MTF_DATA_BUY(NOLOCK)
WHERE	SAUDA_DATE = @PREVDATE AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)

ALTER TABLE #TBL_MTF_DATA_BUY_1 
ADD SNO INT IDENTITY(1,1) 

INSERT	INTO #TBL_MTF_DATA_BUY_1
SELECT	P.PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY = -QTY, MKTAMT = -MKTAMT,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0),
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0)
FROM	VW_PRODUCT_POSITION P (NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)
WHERE	SAUDA_DATE <= @SAUDA_DATE       
		AND ADJUST_DATE = @SAUDA_DATE      
		AND SELL_BUY = 1       
		AND C.CL_CODE = P.PARTY_CODE      
		--AND TRANSTYPE='TRNSE'
		AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
		AND EXISTS (SELECT PARTY_CODE FROM #TBL_MTF_DATA_BUY_1 T WHERE T.PARTY_CODE = P.PARTY_CODE
					AND T.ISIN = P.ISIN) 

SELECT '#TBL_MTF_DATA_BUY_1',* FROM #TBL_MTF_DATA_BUY_1 WHERE PARTY_CODE='AF2204'


SELECT	SNO = MAX(SNO), PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, QTY=SUM(QTY), MKTAMT=SUM(MKTAMT),
		PAYIN_AMT = SUM(PAYIN_AMT),
		PAYIN_AMT_BAL = SUM(PAYIN_AMT_BAL),
		M_QTY = 0,
		M_PRICE = 0,
		M_AMT = 0,
		NF_QTY = 0,
		NF_AMT = 0
INTO	#TBL_MTF_DATA_BUY 
FROM	TBL_MTF_DATA_BUY(NOLOCK) 
GROUP BY
		PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN

SELECT '#TBL_MTF_DATA_BUY',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AF2204'
*/

SELECT	*,
		PAYIN_AMT=CONVERT(NUMERIC(18,4),0),
		PAYIN_AMT_BAL=CONVERT(NUMERIC(18,4),0),
		M_QTY = CONVERT(INT,0),
		M_PRICE = CONVERT(NUMERIC(18,4),0),
		M_AMT = CONVERT(NUMERIC(18,4),0), ---CONVERT(NUMERIC(18,2),0), ---CHANGES ON 04/09/2025
		M_ALLOC_BALANCE = CONVERT(NUMERIC(18,4),0), 
		NF_QTY = CONVERT(INT,0),
		NF_AMT = CONVERT(NUMERIC(18,4),0),
		SELL_BUY = CONVERT(INT,1),
		CORP_BEFORE_QTY = CONVERT(NUMERIC(18,4),0),
		CORP_AFTER_QTY = CONVERT(NUMERIC(18,4),0)
INTO	#TBL_MTF_DATA_BUY 
FROM	TBL_MTF_DATA_BUY(NOLOCK) 
WHERE	PAYIN_DATE = @SAUDA_DATE
		AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)


---- MTF_CASH_PAYIN_LEDGER ---------

UPDATE	#TBL_MTF_DATA_BUY 
SET		PAYIN_AMT = ISNULL(D.VAMT,0)
FROM	(
		SELECT	CLTCODE,
				VAMT = SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),
				VDT
		FROM	LEDGER P(NOLOCK)
		WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
				AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
				AND P.VTYP = '66'
				--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
				AND P.EDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE
				AND P.CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN P.CLTCODE ELSE @PARTY_CODE END)
				AND P.NARRATION LIKE '%MTF PAYIN'
		GROUP BY
				CLTCODE,
				VDT
		HAVING	SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END) > 0
		) D
WHERE	D.CLTCODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND D.VDT = #TBL_MTF_DATA_BUY.SAUDA_DATE



DECLARE @ADJCUR		CURSOR, 
		@DELCUR		CURSOR, 
		@PARTYCODE	VARCHAR(20),
		@PAYIN_AMT	NUMERIC(18,4),
		@MKTAMT		NUMERIC(18,4),
		@MARGIN_REQ	NUMERIC(18,4),
		@SNO		INT,
		@MAMT		NUMERIC(18,4),
		@SAUDA_DATE_PAYIN	DATETIME,
		@PRO_PER	NUMERIC(18,2)

SET @ADJCUR = CURSOR FOR
	SELECT	PARTY_CODE, PAYIN_AMT = MAX(PAYIN_AMT), SAUDA_DATE,
			PRO_PER =  (
			CASE 
				WHEN MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100 > 100 THEN 100 
				ELSE CONVERT(NUMERIC(18,2),ROUND(MAX(PAYIN_AMT)/SUM(MARGIN_REQ)*100,2)) 
			END)
	FROM #TBL_MTF_DATA_BUY
	WHERE PAYIN_AMT > 0
	GROUP BY PARTY_CODE, SAUDA_DATE
	ORDER BY PARTY_CODE, SAUDA_DATE
OPEN @ADJCUR
FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
WHILE @@FETCH_STATUS = 0
BEGIN 
	
	SET @DELCUR = CURSOR FOR
		SELECT SNO, MKTAMT, MARGIN_REQ = (CASE WHEN @PROPOR_ALLOC_FLAG = 1 THEN (MARGIN_REQ/100*@PRO_PER) ELSE MARGIN_REQ END)
		FROM #TBL_MTF_DATA_BUY
		WHERE SAUDA_DATE = @SAUDA_DATE_PAYIN 
		AND PARTY_CODE = @PARTYCODE
		AND MKTAMT > 0 AND MARGIN_REQ > 0
		ORDER BY PARTY_CODE, SCRIP_CD, SERIES
	OPEN @DELCUR
	FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ
	WHILE @@FETCH_STATUS = 0
	BEGIN 
		IF @PAYIN_AMT > 0 --AND @@FETCH_STATUS = 0
		BEGIN
			IF @PROPOR_ALLOC_FLAG = 1 
			BEGIN
				SET		@MAMT = 0
				
				--IF @PARTYCODE ='AHMAJ125'
				--BEGIN
				--	SELECT @MARGIN_REQ
				--	SELECT M_PRICE = ROUND((MKTAMT/QTY),4), M_QTY = FLOOR((@MARGIN_REQ/ROUND((MKTAMT/QTY),4)))
				--	FROM  #TBL_MTF_DATA_BUY
				--	WHERE SNO = @SNO AND PARTY_CODE ='AHMAJ125' AND SCRIP_CD='TRITURBINE'
				--END


				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0				
			END
			ELSE
			BEGIN
				IF @PAYIN_AMT >= @MARGIN_REQ 
				--IF PRADNYA.DBO.FNMIN(@PAYIN_AMT,@MARGIN_REQ)
				BEGIN
					SET		@MAMT = 0
				
					UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @MARGIN_REQ
					WHERE	SNO = @SNO

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
							--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
							M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
							@MAMT = (M_PRICE*M_QTY)
					WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

					UPDATE	#TBL_MTF_DATA_BUY 
					SET		NF_QTY = (QTY-M_QTY),
							NF_AMT = M_PRICE*(QTY-M_QTY)
					WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0

					SET		@PAYIN_AMT = @PAYIN_AMT - @MAMT

					--SELECT	SRNO = @SNO, PAYIN_AMT=@PAYIN_AMT, M_AMT = @MAMT, PAYIN_BALANCE = (@PAYIN_AMT - @MAMT)

					--SET @PAYIN_AMT = @PAYIN_AMT - @MARGIN_REQ

			END
			ELSE
			BEGIN

				UPDATE	#TBL_MTF_DATA_BUY SET PAYIN_AMT_BAL = @PAYIN_AMT
				WHERE	SNO = @SNO

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_PRICE = ROUND((MKTAMT/QTY),4)--,
						--M_QTY = CEILING((PAYIN_AMT/ROUND((MKTAMT/QTY),4)))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_QTY = M_QTY + FLOOR((PAYIN_AMT_BAL/M_PRICE))
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		M_AMT = M_AMT + (M_PRICE*M_QTY),
						M_ALLOC_BALANCE = M_ALLOC_BALANCE + @PAYIN_AMT - (M_PRICE*M_QTY),
						@MAMT = (M_PRICE*M_QTY)
				WHERE	SNO = @SNO AND PAYIN_AMT_BAL > 0

				UPDATE	#TBL_MTF_DATA_BUY 
				SET		NF_QTY = (QTY-M_QTY),
						NF_AMT = M_PRICE*(QTY-M_QTY)
				WHERE	SNO = @SNO AND M_QTY > 0 AND PAYIN_AMT_BAL > 0
				
				SET @PAYIN_AMT = 0

			END
		END
		END

		FETCH NEXT FROM @DELCUR INTO @SNO, @MKTAMT, @MARGIN_REQ 
	END
	
	CLOSE @DELCUR
	DEALLOCATE @DELCUR
	FETCH NEXT FROM @ADJCUR INTO @PARTYCODE, @PAYIN_AMT, @SAUDA_DATE_PAYIN, @PRO_PER
END
CLOSE @ADJCUR
DEALLOCATE @ADJCUR

DELETE	FROM TBL_MTF_DATA_BUY_ALLOC_LOG
WHERE	SAUDA_DATE = @SAUDA_DATE

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

--UPDATE	#TBL_MTF_DATA_BUY
--SET		M_QTY = M_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
--		NF_QTY = NF_QTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
--WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)

/** --- NEW CHANGES DONE ON 01/08/2025 --- **/

--SELECT '#TBL_MTF_DATA_BUY-3',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE='AF7259' AND SCRIP_CD='BANKINDIA' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

INSERT	INTO TBL_MTF_DATA_BUY_ALLOC_LOG
SELECT	SAUDA_DATE,PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY,MKTAMT,NETAMT,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT,PAYIN_AMT_BAL,M_QTY,M_PRICE,M_AMT,
		M_ALLOC_BALANCE, NF_QTY,NF_AMT,SELL_BUY,
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#TBL_MTF_DATA_BUY 
WHERE	M_ALLOC_BALANCE > 0

--SELECT	'#TBL_MTF_DATA_BUY-4',* FROM #TBL_MTF_DATA_BUY WHERE PARTY_CODE IN ('AHMAJ125') AND SCRIP_CD='TRITURBINE' ORDER BY PARTY_CODE, SCRIP_CD, SERIES 

INSERT INTO #DATA      
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE, LONG_NAME,     
BODQTY = 0,    
BODVALUE =CONVERT(NUMERIC(18,4),0),    
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = 0,      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(M_QTY), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_QTY ELSE 0 END),
M_FRESHBUY = ROUND(SUM(M_AMT),2), --SUM(CASE WHEN P.SELL_BUY = 1 THEN M_AMT ELSE 0 END),
M_FRESHSQTY = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_QTY ELSE 0 END),
M_FRESHSELL = 0, --SUM(CASE WHEN P.SELL_BUY = 2 THEN M_AMT ELSE 0 END),
M_NETQTY = SUM(NF_QTY),
M_NETAMOUNT = SUM(NF_AMT),
EXCHANGE = P.EXCHANGE,--= 'TRNSE', --TRANSTYPE
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO
,BSECODE
FROM #TBL_MTF_DATA_BUY P (NOLOCK), MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER (NOLOCK)      
WHERE 1 = 1 --SAUDA_DATE = @PREV_SAUDA_DATE       
--AND ADJUST_DATE = @SAUDA_DATE      
--AND SELL_BUY = 1       
AND C.CL_CODE = P.PARTY_CODE      
--AND TRANSTYPE='TRNSE'
and p.party_code = (case when @party_code = '' then p.party_code else @party_code end)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, ISNULL(P.ISIN,''),P.EXCHANGE,BSECODE --,SETT_NO --, TRANSTYPE      
HAVING (SUM(M_QTY) > 0 OR SUM(NF_QTY) > 0 )

--SELECT '#DATA-1',* FROM #DATA WHERE PARTY_CODE IN ('FU90106') AND SCRIP_CD='BDL'

INSERT INTO #DATA       
SELECT SAUDA_DATE=CONVERT(VARCHAR,CONVERT(DATETIME, @SAUDA_DATE),103),      
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
BODQTY = SUM(NETQTY),    
BODVALUE = CONVERT(NUMERIC(18,4),SUM(NETAMOUNT) ),     
FRESHBQTY = 0,      
FRESHBUY = 0,      
FRESHSQTY = 0,    
FRESHSELL = CONVERT(NUMERIC(18,4),0),      
NETAMOUNT = CONVERT(NUMERIC(18,4),0),
M_BODQTY = 0,
M_BODVALUE = CONVERT(NUMERIC(18,4),0),
M_FRESHBQTY = SUM(ISNULL(M_FRESHBQTY,0)),
M_FRESHBUY = CONVERT(NUMERIC(18,4),ROUND(SUM(ISNULL(M_FRESHBUY,0)),2)),
M_FRESHSQTY = SUM(ISNULL(M_FRESHSQTY,0)),
M_FRESHSELL = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_FRESHSELL,0))),
M_NETQTY = SUM(ISNULL(M_NETQTY,0)),
M_NETAMOUNT = CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))),
EXCHANGE = ISNULL(EXCHANGE,'TRNSE'),
ISIN = ISNULL(P.ISIN,'')--,
--SETT_NO =''
,BSECODE
FROM #MTR_RTP P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
WHERE SAUDA_DATE = @PREVDATE
AND C.CL_CODE = P.PARTY_CODE         
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)
GROUP BY MEMBERCODE, P.PARTY_CODE, LONG_NAME,SCRIP_CD, SERIES, EXCHANGE, ISNULL(P.ISIN,''),BSECODE
HAVING SUM(NETQTY) > 0 AND SUM(NETAMOUNT) > 0 


UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')
FROM	MSAJAG.DBO.MULTIISIN M(NOLOCK)
WHERE	M.SCRIP_CD = #DATA.SCRIP_CD
		AND M.SERIES = #DATA.SERIES
		AND M.VALID = 1
		AND ISNULL(#DATA.ISIN,'') = ''

/** --- NEW CHANGES DONE ON 09/07/2025 --- **/

UPDATE	#DATA
SET		ISIN = ISNULL(M.ISIN,'')--,
		--BSECODE = (CASE WHEN ISNULL(#DATA.BSECODE,'') = '' THEN ISNULL(M.BSECODE,'') ELSE ISNULL(#DATA.BSECODE,'') END)
FROM	MSAJAG.DBO.TBL_EXCHG_SCRIP_MAP M (NOLOCK)
WHERE	M.NSE_SCRIP_CD = #DATA.SCRIP_CD
		AND M.NSE_SERIES = #DATA.SERIES
		AND @PREVDATE BETWEEN FROM_DATE AND TO_DATE
		AND ISNULL(#DATA.ISIN,'') = ''

UPDATE	#DATA
SET		BSECODE = ISNULL(M.SCRIP_CD,#DATA.BSECODE)
FROM	BSEDB.DBO.MULTIISIN M(NOLOCK)
WHERE	M.ISIN = #DATA.ISIN
		AND M.VALID = 1
		AND ISNULL(#DATA.BSECODE,'') = ''

/** --- NEW CHANGES DONE ON 09/07/2025 --- **/

/** --- NEW CHANGES DONE ON 12/07/2025 FOR CA PROCESS --- **/

UPDATE	#DATA
SET		ISIN = ISNULL(P.ISIN,#DATA.ISIN)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN <> #DATA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')

/** --- NEW CHANGES DONE ON 09/07/2025 --- **/

--SELECT '#DATA-1-NEWMTF',* FROM #DATA WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO' ORDER BY PARTY_CODE, SCRIP_CD, SERIES

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

ALTER	TABLE #DATA
ADD		CORP_BEFORE_QTY NUMERIC(18,4),
		CORP_AFTER_QTY	NUMERIC(18,4)

/*
UPDATE	#TBL_MTF_DATA_BUY
SET		M_QTY = ISNULL(T.M_FRESHBQTY,0),
		NF_QTY = ISNULL(T.M_NETQTY,0)
FROM	TBL_MTR_REPORTING T(NOLOCK)
WHERE	#TBL_MTF_DATA_BUY.SAUDA_DATE = @SAUDA_DATE
		AND T.SAUDA_DATE = (SELECT MAX(SAUDA_DATE) FROM TBL_MTR_REPORTING T(NOLOCK) 
						WHERE SAUDA_DATE < @SAUDA_DATE AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
						AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
						)
		AND T.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
		AND T.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
		AND T.ISIN = #TBL_MTF_DATA_BUY.ISIN
		AND T.M_FRESHBQTY > 0
		AND EXISTS (SELECT	PARTY_CODE
					FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
					WHERE	P.SAUDA_DATE = @SAUDA_DATE
					AND P.PARTY_CODE = #TBL_MTF_DATA_BUY.PARTY_CODE
					AND P.SCRIP_CD = #TBL_MTF_DATA_BUY.SCRIP_CD
					AND P.ISIN = #TBL_MTF_DATA_BUY.ISIN
					AND ADDED_BY IN ('SPLIT','BONUS') 
					)
					*/

UPDATE	#DATA
SET		CORP_AFTER_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST_BUY P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND ADDED_BY IN ('SPLIT','BONUS')
		AND #DATA.M_FRESHBQTY > 0


UPDATE	#DATA
SET		CORP_BEFORE_QTY = ISNULL(P.QTY,0)
FROM	TBL_PRODUCT_POS_ADJUST P(NOLOCK)
WHERE	CONVERT(DATETIME,#DATA.SAUDA_DATE,103) = @SAUDA_DATE
		AND P.SAUDA_DATE = @SAUDA_DATE 
		AND P.PARTY_CODE = #DATA.PARTY_CODE
		AND P.SCRIP_CD = #DATA.SCRIP_CD
		AND P.ISIN = #DATA.ISIN
		AND #DATA.CORP_AFTER_QTY <> 0
		AND #DATA.M_FRESHBQTY > 0

UPDATE	#DATA
SET		M_FRESHBQTY = M_FRESHBQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0),
		M_NETQTY = M_NETQTY * ROUND((CORP_AFTER_QTY/CORP_BEFORE_QTY),0)
WHERE	(CORP_AFTER_QTY <> 0 AND CORP_BEFORE_QTY <> 0)
		AND M_FRESHBQTY > 0
		AND BODQTY > 0

/** --- NEW CHANGES DONE ON 01/08/2025 FOR CA PROCESS --- **/

SELECT SAUDA_DATE, MEMBERCODE, SCRIP_CD, SERIES, PARTY_CODE, LONG_NAME,    
BODQTY = SUM(BODQTY),    
BODVALUE = SUM(BODVALUE),       
FRESHBQTY = SUM(FRESHBQTY),    
FRESHBUY = SUM(FRESHBUY),     
FRESHSQTY = SUM(FRESHSQTY),    
FRESHSELL = SUM(FRESHSELL),       
NETQTY = SUM(BODQTY) + SUM(FRESHBQTY) - SUM(FRESHSQTY),     
NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
M_BODQTY = SUM(M_BODQTY),
M_BODVALUE = SUM(M_BODVALUE),
M_FRESHBQTY = SUM(M_FRESHBQTY),
M_FRESHBUY = SUM(M_FRESHBUY),
M_FRESHSQTY = SUM(M_FRESHSQTY),
M_FRESHSELL = SUM(M_FRESHSELL),
M_NETQTY = SUM(M_NETQTY),--SUM(M_BODQTY) + SUM(M_FRESHBQTY) - SUM(M_FRESHSQTY),
M_NETAMOUNT = SUM(M_NETAMOUNT), --SUM(M_BODVALUE + M_FRESHBUY - M_FRESHSELL),
EXCHANGE,
ISIN,
--M_PRICE = (CASE WHEN SUM(ISNULL(M_NETQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),SUM(ISNULL(M_NETAMOUNT,0))/SUM(ISNULL(M_NETQTY,0))) ELSE 0 END)--,
M_PRICE = (CASE WHEN SUM(ISNULL(M_FRESHBQTY,0)) > 0 THEN CONVERT(NUMERIC(18,4),ROUND(SUM(M_FRESHBUY)/SUM(M_FRESHBQTY),4)) ELSE 0 END)
--SETT_NO
,BSECODE
INTO #DATAFINAL      
FROM #DATA  
GROUP BY SAUDA_DATE, MEMBERCODE, LONG_NAME, SCRIP_CD, SERIES, PARTY_CODE, EXCHANGE, ISIN, BSECODE --, SETT_NO  

ALTER TABLE #DATAFINAL
ADD	SRNO INT IDENTITY(1,1)

--SELECT '#DATAFINAL-1',* FROM #DATAFINAL WHERE PARTY_CODE IN ('AA0895')


UPDATE #DATAFINAL SET NETAMOUNT = 0
WHERE NETQTY = 0 

UPDATE #DATAFINAL SET M_NETAMOUNT = 0
WHERE M_NETQTY = 0

DECLARE @GLCODE	VARCHAR(10)

SELECT	@GLCODE = ACCODE FROM VALANACCOUNT WHERE ACNAME = 'MTF JV CONTROL'

--------------------------------------------------------------------------------------------------

---- MTF_CASH_PAYIN_LEDGER --------------

SELECT	PARTY_CODE = CLTCODE, 
		PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0),
		PAYIN_ALLOCATED_AMT = CONVERT(NUMERIC(18,2),0),
		PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),0),
		ACNAME = P.ACNAME, 
		DRCR = 'D',
		VNO = CONVERT(VARCHAR(12),''),
		GLCODE = @GLCODE,
		VDT
INTO	#EXCESS_PAYIN_JV
FROM	LEDGER P(NOLOCK)
WHERE	---VDT = @PREVDATE 
		P.VDT BETWEEN @SDTCUR AND @LDTCUR
		AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
		AND P.VTYP = '66'
		--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
		AND P.EDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
		AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
		AND P.NARRATION LIKE '%MTF PAYIN'
GROUP BY
		CLTCODE, P.ACNAME, VDT

ALTER TABLE #EXCESS_PAYIN_JV
ADD SNO	INT	IDENTITY(1,1)
		
UPDATE	#EXCESS_PAYIN_JV
SET		PAYIN_ALLOCATED_AMT = ISNULL(A.M_FRESHBUY,0)
FROM	(
		SELECT	PARTY_CODE,
				M_FRESHBUY = ROUND(SUM(M_AMT),2),
				SAUDA_DATE
		FROM	#TBL_MTF_DATA_BUY D
		GROUP BY
				PARTY_CODE,
				SAUDA_DATE
		) A
WHERE	A.PARTY_CODE = #EXCESS_PAYIN_JV.PARTY_CODE
		AND A.SAUDA_DATE = #EXCESS_PAYIN_JV.VDT
					
--SELECT '#DATAFINAL', * FROM	#DATAFINAL D WHERE PARTY_CODE IN ('600M7016')

UPDATE	#EXCESS_PAYIN_JV SET PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),ROUND((PAYIN_AMT-PAYIN_ALLOCATED_AMT),2))
WHERE	(PAYIN_AMT-PAYIN_ALLOCATED_AMT) <> 0

--SELECT '#DATAFINAL_NEWMTF',* FROM #DATAFINAL WHERE party_code='AJ8050' ---AND ISIN='INE260D01016'

--------------------------------------------------------------------------------------------------

SELECT	SAUDA_DATE,
		PARTY_CODE,
		SCRIP_CD,
		SERIES,
		NETQTY,
		CLOSE_QTY = ABS(NETQTY-(M_FRESHBQTY+M_NETQTY)),
		M_FRESHBQTY,
		M_FRESHBUY,
		M_NETQTY,
		M_PRICE,
		M_NETQTY_NEW = 0,
		M_FRESHBQTY_NEW = 0,
		EXCHANGE,
		ISIN,
		SRNO,
		SETT_NO = CONVERT(VARCHAR(15),''),
		PAYIN_DATE = CONVERT(DATETIME,''),
		BSECODE,
		FRESHBQTY,
		FRESHBUY,
		FRESHSQTY,
		FRESHSELL,
		NETAMOUNT,
		M_NETAMOUNT
INTO	#CLOSEPOS
FROM	#DATAFINAL
WHERE	(NETQTY-(M_FRESHBQTY+M_NETQTY)) < 0


UPDATE	#CLOSEPOS 
SET		PAYIN_DATE = ISNULL(LEFT(SM.FUNDS_PAYIN,11),''),
		SETT_NO = ISNULL(SM.SETT_NO,'')
FROM	MSAJAG.DBO.SETT_MST SM(NOLOCK)
WHERE	SM.START_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'
		AND SM.SETT_TYPE = 'N'


--SELECT	'#CLOSEPOS-1-NEWMTF',* FROM #CLOSEPOS WHERE PARTY_CODE='AA2298' AND ISIN='INE260D01016'

IF @PROPOR_ALLOC_FLAG = 1
BEGIN
	/*
	DECLARE @NONFNO		INT,
			@FNO		INT

	SELECT	@NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER
	WHERE	@SAUDA_DATE BETWEEN FROMDATE AND TODATE

	SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
	MSAJAG.DBO.VARCONTROL C
	WHERE C.RECDATE >= @SAUDA_DATE aND c.REcDATE <= @SAUDA_DATE + ' 23:59'
	AND C.DETAILKEY = V.DETAILKEY
	AND SERIES NOT IN ('BO')
	AND ISIN IN (SELECT DISTINCT ISIN FROM #CLOSEPOS)

	SELECT V.* INTO  #BSE_VAR FROM BSEDB.DBO.VARDETAIL V
	WHERE V.FDATE >= @SAUDA_DATE aND v.FDATE <= @SAUDA_DATE + ' 23:59'

    SELECT V.* INTO #B_BSE_VAR FROM  #BSE_VAR V
	WHERE  ISIN IN (SELECT ISIN FROM #CLOSEPOS)

	CREATE INDEX #NISIN ON #B_NSE_VAR
	(ISIN )
	CREATE INDEX #BISIN ON #B_BSE_VAR
	(ISIN )
	*/

	ALTER	TABLE #CLOSEPOS
	ADD		MARGIN_REQ	NUMERIC(18,4),
			HAIRCUT		NUMERIC(18,4),
			PRO_M_QTY	INT,
			PRO_PRICE	NUMERIC(18,4),
			BAL_NET_QTY	INT,
			PRO_ALLOC_PER	NUMERIC(18,4)

	UPDATE	#CLOSEPOS 
	SET		MARGIN_REQ	= 0,
			HAIRCUT		= 0,
			PRO_M_QTY	= 0,
			PRO_PRICE	= 0,
			BAL_NET_QTY = 0,
			PRO_ALLOC_PER = 0

 --   UPDATE	#CLOSEPOS 
 --   SET		HAIRCUT = M.APPVAR + @NONFNO * SECSPECVAR
 --   FROM	#B_NSE_VAR M
 --   WHERE	M.ISIN = #CLOSEPOS.ISIN 
	--AND		HAIRCUT = 0

	--UPDATE	#CLOSEPOS 
	--SET		HAIRCUT = M.MARGIN + @NONFNO * ELM
	--FROM	#B_BSE_VAR M
	--WHERE	M.ISIN = #CLOSEPOS.ISIN 
	--AND		HAIRCUT = 0

	
	UPDATE	#CLOSEPOS
	SET		PRO_ALLOC_PER = ROUND(M_FRESHBUY/(M_FRESHBUY+M_NETAMOUNT)*100,2)
	WHERE	M_FRESHBUY > 0 AND (M_FRESHBUY+M_NETAMOUNT) > 0

	UPDATE	#CLOSEPOS
	SET		MARGIN_REQ = ((FRESHSQTY*M_PRICE)/100*PRO_ALLOC_PER),
			PRO_PRICE = ROUND(M_PRICE,4)
	WHERE	FRESHSELL > 0 AND PRO_ALLOC_PER > 0

	UPDATE	#CLOSEPOS
	SET		PRO_M_QTY = FLOOR((MARGIN_REQ/PRO_PRICE)) 
	WHERE	PRO_PRICE > 0 AND MARGIN_REQ > 0

	UPDATE	#CLOSEPOS
	SET		BAL_NET_QTY = (FRESHSQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND FRESHSQTY > 0

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY = (M_FRESHBQTY-PRO_M_QTY)
	WHERE	PRO_M_QTY > 0 AND M_FRESHBQTY > 0
		
	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN (M_FRESHBQTY - PRO_M_QTY) >= 0 THEN (M_FRESHBQTY - PRO_M_QTY) 
				ELSE M_FRESHBQTY 
			END)

	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = M_NETQTY - BAL_NET_QTY
	WHERE	(M_NETQTY - BAL_NET_QTY) >= 0
	
END
ELSE
BEGIN
	
	UPDATE	#CLOSEPOS
	SET		M_NETQTY_NEW = (CASE WHEN (M_NETQTY - CLOSE_QTY) <= 0 THEN 0 ELSE (M_NETQTY - CLOSE_QTY) END)

	UPDATE	#CLOSEPOS
	SET		M_FRESHBQTY_NEW = (
			CASE 
				WHEN M_NETQTY_NEW = 0 THEN 
				CASE WHEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) > 0 THEN (M_FRESHBQTY - ABS(M_NETQTY - CLOSE_QTY)) ELSE 0 END 
				ELSE M_FRESHBQTY 
			END)
END

UPDATE	#DATAFINAL 
SET		M_FRESHBQTY = M_FRESHBQTY_NEW,
		M_NETQTY = M_NETQTY_NEW,
		M_FRESHBUY = M_FRESHBQTY_NEW*#CLOSEPOS.M_PRICE,
		M_NETAMOUNT = M_NETQTY_NEW*#CLOSEPOS.M_PRICE
FROM	#CLOSEPOS
WHERE	#CLOSEPOS.PARTY_CODE = #DATAFINAL.PARTY_CODE
		AND #CLOSEPOS.SCRIP_CD = #DATAFINAL.SCRIP_CD
		AND #CLOSEPOS.ISIN = #DATAFINAL.ISIN
		AND #CLOSEPOS.EXCHANGE = #DATAFINAL.EXCHANGE
		AND #CLOSEPOS.SRNO = #DATAFINAL.SRNO

--SELECT '#DATAFINAL-2',* FROM #DATAFINAL WHERE PARTY_CODE='AM8223' AND SCRIP_CD='ROTO'
--SELECT	'#DATAFINAL-2-NEWMTF',* FROM #DATAFINAL WHERE PARTY_CODE='AM7931' 
--SELECT	'#CLOSEPOS-2-NEWMTF',* FROM #CLOSEPOS WHERE PARTY_CODE='AM7931' 

INSERT	INTO TBL_MTF_DATA_BUY_ALLOC_LOG
SELECT	SAUDA_DATE=CONVERT(DATETIME,SAUDA_DATE,103),PARTY_CODE,SCRIP_CD,SERIES,BSECODE,ISIN,QTY=CLOSE_QTY,MKTAMT=0,NETAMT=0,SETT_NO,PAYIN_DATE,EXCHANGE,PAYIN_AMT=0,PAYIN_AMT_BAL=0,
		M_QTY=(M_FRESHBQTY-M_FRESHBQTY_NEW),
		M_PRICE,M_AMT=(M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE,
		M_ALLOC_BALANCE=(M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE, 
		NF_QTY=0,NF_AMT=0,SELL_BUY=2,
		PROCESS_ON=GETDATE(), PROCESS_BY='SYSTEM'
FROM	#CLOSEPOS


SELECT	PARTY_CODE, 
		M_FRESHBQTY = SUM(M_FRESHBQTY_NEW),
		M_NETQTY = SUM(M_NETQTY_NEW),
		M_BALANCE_QTY = SUM(M_FRESHBQTY-M_FRESHBQTY_NEW),
		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(SUM((M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE),2)),
		VNO = CONVERT(VARCHAR(12),''),
		ACNAME = CONVERT(VARCHAR(100),''),
		DRCR = 'D',
		GLCODE = @GLCODE,
		AMOUNT_ORG = CONVERT(NUMERIC(18,2),0),
		MARGIN_REQ = CONVERT(NUMERIC(18,2),0),
		MTOM_LOSS = CONVERT(NUMERIC(18,2),0)--,
		--SETT_NO
INTO	#DATAFINAL_JV 
FROM	#CLOSEPOS
WHERE	(M_FRESHBQTY-M_FRESHBQTY_NEW) > 0
		--AND (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END) > 0
GROUP BY
		PARTY_CODE

--select '#CLOSEPOS',(M_FRESHBQTY-M_FRESHBQTY_NEW),M_PRICE,(M_FRESHBQTY-M_FRESHBQTY_NEW)*M_PRICE,* from #CLOSEPOS where party_code='AJ8050' 

--SELECT '#DATAFINAL_JV',* FROM #DATAFINAL_JV WHERE PARTY_CODE='AA0895' 

--UPDATE	#DATAFINAL_JV
--SET		AMOUNT_ORG = ROUND(NETAMT,2)
--FROM	(
--		SELECT	PARTY_CODE, 
--				NETAMT = (CASHLEDADJ+FOLEDBALADJ)
--		FROM	TBL_MTF_DATA 
--		WHERE	SAUDA_DATE = @SAUDA_DATE
--		GROUP BY
--				PARTY_CODE,
--				CASHLEDADJ,
--				FOLEDBALADJ
--		HAVING (CASHLEDADJ+FOLEDBALADJ) < 0
--		) A
--WHERE	A.PARTY_CODE = #DATAFINAL_JV.PARTY_CODE


--UPDATE	#DATAFINAL_JV
--SET		AMOUNT = PRADNYA.DBO.FNMIN(AMOUNT,AMOUNT_ORG)


/*--- MARGIN REQUIRMENT ADJUSTMENT AGAINTS CASH BALANCE LOGIC 07/07/2025 ---*/
/*
UPDATE	#DATAFINAL_JV
SET		MARGIN_REQ	= ISNULL(A.TOT_MARGIN_REQ,0),
		MTOM_LOSS	= ISNULL(A.TOT_MTOM_LOSS,0)
FROM	(
		SELECT	PARTY_CODE,
				TOT_MARGIN_REQ = SUM(MARGIN_REQ),
				TOT_MTOM_LOSS = SUM(MTOM_LOSS)
		FROM	TBL_MTF_DATA_BUY(NOLOCK) 
		WHERE	SAUDA_DATE = @SAUDA_DATE
		GROUP BY
				PARTY_CODE
		HAVING SUM(MARGIN_REQ+MTOM_LOSS) > 0
		) A
WHERE	A.PARTY_CODE = #DATAFINAL_JV.PARTY_CODE
		AND #DATAFINAL_JV.AMOUNT > A.TOT_MARGIN_REQ
*/

--SELECT '#DATAFINAL_JV',* FROM #DATAFINAL_JV WHERE PARTY_CODE IN ('600B1285')


--SELECT	PARTY_CODE, 
--		M_FRESHBQTY = (
--		CASE 
--			WHEN (M_NETQTY + CLOSE_QTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY + CLOSE_QTY)) 
--			ELSE M_FRESHBQTY 
--		END),
--		M_NETQTY = (CASE WHEN (M_NETQTY + CLOSE_QTY) < 0 THEN 0 ELSE (M_NETQTY + CLOSE_QTY) END),
--		M_BALANCE_QTY = 0,
--		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((M_NETQTY - FRESHSQTY)*M_PRICE),2)),
--		VNO = CONVERT(VARCHAR(12),''),
--		ACNAME = CONVERT(VARCHAR(100),''),
--		DRCR = (CASE WHEN ((M_NETQTY - FRESHSQTY)*M_PRICE) > 0 THEN 'C' ELSE 'D' END),
--		GLCODE = @GLCODE
--INTO	#DATAFINAL_JV 
--FROM	#CLOSEPOS
--WHERE	(M_NETQTY - FRESHSQTY) < 0 AND M_NETQTY > 0
--		--AND (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END) > 0
		
--SELECT	'#DATAFINAL_JV',* FROM #DATAFINAL_JV --WHERE PARTY_CODE IN ('AI3654','AL0587','AC2370','AH1057')
--RETURN


--UPDATE	#DATAFINAL 
--SET		M_FRESHBQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END),
--		M_NETQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN 0 ELSE M_NETQTY END)
--WHERE	FRESHSQTY > 0 AND M_NETQTY > 0
--		--AND (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN (M_FRESHBQTY + (M_NETQTY - FRESHSQTY)) ELSE M_FRESHBQTY END) > 0

--UPDATE	#DATAFINAL 
--SET		M_FRESHBUY = M_FRESHBQTY*M_PRICE,
--		M_NETAMOUNT = M_NETQTY*M_PRICE
--WHERE	FRESHSQTY > 0 AND (M_FRESHBQTY > 0 OR M_NETQTY > 0)


--SELECT	M_NETQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN 0 ELSE M_NETQTY END),
--		M_FRESHBQTY = (CASE WHEN (M_NETQTY - FRESHSQTY) < 0 THEN M_FRESHBQTY + (M_NETQTY - FRESHSQTY) ELSE M_FRESHBQTY END),
--		*
--FROM	#DATAFINAL
--WHERE	FRESHSQTY > 0 AND PARTY_CODE='AF2204'


--SELECT '#DATAFINAL-2',* FROM #DATAFINAL WHERE PARTY_CODE IN ('AF7259')

/*
SELECT * FROM #DATAFINAL

UPDATE #DATAFINAL SET FRESHBQTY = (CASE WHEN FRESHBQTY - FRESHSQTY >= 0   
          THEN FRESHBQTY - FRESHSQTY  
          ELSE 0  
           END),  
       FRESHBUY = (CASE WHEN FRESHBUY - FRESHSELL >= 0   
          THEN FRESHBUY - FRESHSELL  
          ELSE 0  
           END),  
       FRESHSQTY = (CASE WHEN FRESHSQTY - FRESHBQTY >= 0   
          THEN FRESHSQTY - FRESHBQTY  
          ELSE 0  
           END),  
       FRESHSELL = (CASE WHEN FRESHSELL - FRESHBUY >= 0   
          THEN FRESHSELL - FRESHBUY  
          ELSE 0  
           END)  
WHERE FRESHBQTY > 0 AND FRESHSQTY > 0   
  
DELETE FROM #DATAFINAL  
WHERE BODQTY = 0 AND FRESHBQTY = 0 AND FRESHSQTY = 0  
*/  
	--SELECT * FROM #DATAFINAL WHERE PARTY_CODE IN ('FU90106') AND SCRIP_CD='BDL'

	DELETE FROM TBL_MTR_REPORTING
	WHERE SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE)
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)

	SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),
	PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL),
	M_BODQTY = SUM(M_BODQTY),
	M_BODVALUE = SUM(M_BODVALUE),
	M_FRESHBQTY = SUM(M_FRESHBQTY),
	M_FRESHBUY = SUM(M_FRESHBUY),
	M_FRESHSQTY = SUM(M_FRESHSQTY),
	M_FRESHSELL = SUM(M_FRESHSELL),
	M_NETQTY = SUM(M_NETQTY),
	M_NETAMOUNT = SUM(M_NETAMOUNT), --SUM(M_BODVALUE + M_FRESHBUY - M_FRESHSELL),
	EXCHANGE,
	PROCESSDATE = GETDATE(),
	ISIN,
	BSECODE
	INTO #DATAFINAL_NEW
	FROM #DATAFINAL      
	GROUP BY LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, EXCHANGE, ISIN, BSECODE  
	ORDER BY PARTY_CODE, SCRIP_CD, SERIES 
	
	UPDATE  #DATAFINAL_NEW SET FRESHSELL = FRESHSELL + NETAMOUNT, NETAMOUNT = 0
	WHERE	SAUDA_DATE = @SAUDA_DATE AND NETQTY = 0 AND NETAMOUNT <> 0

	UPDATE  #DATAFINAL_NEW SET M_FRESHBUY = ROUND((BODVALUE + FRESHBUY - FRESHSELL),2)
	WHERE	SAUDA_DATE = @SAUDA_DATE AND NETQTY = M_FRESHBQTY
	
	INSERT INTO TBL_MTR_REPORTING
	SELECT SAUDA_DATE = CONVERT(DATETIME, @SAUDA_DATE),
	PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY,    
	BODVALUE,       
	FRESHBQTY,    
	FRESHBUY,     
	FRESHSQTY,    
	FRESHSELL,       
	NETQTY,    
	NETAMOUNT,
	M_BODQTY,
	M_BODVALUE,
	M_FRESHBQTY,
	M_FRESHBUY,
	M_FRESHSQTY,
	M_FRESHSELL,
	M_NETQTY,
	M_NETAMOUNT,
	EXCHANGE,
	PROCESSDATE = GETDATE(),
	ISIN,
	BSECODE
	FROM #DATAFINAL_NEW      
	ORDER BY PARTY_CODE, SCRIP_CD, SERIES
	
	SELECT	PARTY_CODE,
			AMOUNT = SUM(M_FRESHBUY) - ROUND(SUM(BODVALUE + FRESHBUY - FRESHSELL),2),
			VNO = CONVERT(VARCHAR(12),''),
			ACNAME = CONVERT(VARCHAR(100),''),
			DRCR = (CASE WHEN (SUM(M_FRESHBUY) - ROUND(SUM(BODVALUE + FRESHBUY - FRESHSELL),2)) > 0 THEN 'D' ELSE 'C' END),
			GLCODE = @GLCODE
	INTO	#JV_SELLPAYIN_ADJ
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @SAUDA_DATE
			AND NETQTY = M_FRESHBQTY
	GROUP BY
			PARTY_CODE

	/*------ JV INSERT -------*/


	--SELECT	PARTY_CODE, 
	--		M_FRESHBQTY,
	--		M_NETQTY,
	--		M_BALANCE_QTY = (M_NETQTY - FRESHSQTY),
	--		AMOUNT = CONVERT(NUMERIC(18,2),ROUND(((M_NETQTY - FRESHSQTY)*M_PRICE),2)),
	--		VNO = CONVERT(VARCHAR(12),''),
	--		ACNAME = CONVERT(VARCHAR(100),''),
	--		DRCR = (CASE WHEN ((M_NETQTY - FRESHSQTY)*M_PRICE) > 0 THEN 'C' ELSE 'D' END),
	--		GLCODE = @GLCODE
	--INTO	#DATAFINAL_JV 
	--FROM	#DATAFINAL
	--WHERE	(M_NETQTY - FRESHSQTY) < 0
		
	--SELECT	'#DATAFINAL_JV',* FROM #DATAFINAL_JV WHERE PARTY_CODE IN ('AF7259')


	ALTER TABLE #DATAFINAL_JV
	ADD SNO	INT	IDENTITY(1,1)

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #DATAFINAL_JV 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN
		
		CREATE TABLE #VNO
		(
			VNO	VARCHAR(12)
		)

		INSERT	INTO #VNO 
		EXEC	ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT	@VNO = VNO FROM #VNO

		UPDATE	#DATAFINAL_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#DATAFINAL_JV SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#DATAFINAL_JV.PARTY_CODE = A.CLTCODE

		
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/
		/*
		DELETE FROM MTF_CASH_COLL_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_COLL_LEDGER.CLTCODE AND AMOUNT <> 0)
		DELETE FROM MTF_CASH_PAYIN_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_PAYIN_LEDGER.CLTCODE AND AMOUNT <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		
		DELETE FROM MTF_CASH_COLL_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_COLL_LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		DELETE FROM MTF_CASH_PAYIN_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = MTF_CASH_PAYIN_LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		*/
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND VTYP = '66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF SELL PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)
		
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND VTYP = '6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND VTYP = '66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)
		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF PAYIN' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = LEDGER.CLTCODE AND MARGIN_REQ <> 0)

		/*---- MTF_CASH_COLL_LEDGER -----------*/

		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
		FROM #DATAFINAL_JV
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '17.MTF SELL PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

		
		---- PAYIN JV (MARGIN_REQ) ----
		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR, AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '18.MTF PAYIN'
		FROM #DATAFINAL_JV
		WHERE MARGIN_REQ <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '18.MTF PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MARGIN_REQ <> 0
		
		/*
		--- TDAY MTM LOGICAL BUG EXTRA ENTRY ---
		---- MTM JV (MTOM_LOSS) ----
		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '19.MTF MTM'
		FROM #DATAFINAL_JV
		WHERE MTOM_LOSS <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '19.MTF MTM'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MTOM_LOSS <> 0
	

		---- MTM JV (MTOM_LOSS) ----
		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '20.MTF MTM'
		FROM #DATAFINAL_JV
		WHERE MTOM_LOSS <> 0

		INSERT INTO LEDGER
		SELECT '67', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(MTOM_LOSS), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '20.MTF MTM'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MTOM_LOSS <> 0
		*/

		--INSERT INTO MTF_CASH_PAYIN_LEDGER
		--SELECT '6', VNO, @EDT, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '25.MTF SELL PAYIN'
		--FROM #DATAFINAL_JV
		--WHERE AMOUNT <> 0

		--INSERT INTO MTF_CASH_PAYIN_LEDGER
		--SELECT '6', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		--GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '26.MTF SELL PAYIN'
		--FROM #DATAFINAL_JV J, ACMAST A
		--WHERE J.GLCODE = A.CLTCODE
		--AND AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
		FROM #DATAFINAL_JV
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '21.MTF SELL PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

		---- PAYIN JV (MARGIN_REQ) ----
		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '22.MTF PAYIN'
		FROM #DATAFINAL_JV
		WHERE MARGIN_REQ <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @EDT, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(MARGIN_REQ), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '22.MTF PAYIN'
		FROM #DATAFINAL_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND MARGIN_REQ <> 0

	END

	--DROP TABLE #DATAFINAL_JV

	/*
	SELECT	PARTY_CODE = CLTCODE, 
			PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0),
			PAYIN_ALLOCATED_AMT = CONVERT(NUMERIC(18,2),0),
			PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),0),
			ACNAME = P.ACNAME, 
			DRCR = 'D',
			VNO = CONVERT(VARCHAR(12),''),
			GLCODE = @GLCODE
	INTO	#EXCESS_PAYIN_JV
	FROM	MTF_CASH_PAYIN_LEDGER P(NOLOCK)
	WHERE	---VDT = @PREVDATE 
			P.VDT BETWEEN @SDTCUR AND @LDTCUR
			AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
			--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
			AND P.EDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
			AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
			AND P.NARRATION='MTF PAYIN'
	GROUP BY
			CLTCODE, P.ACNAME

	ALTER TABLE #EXCESS_PAYIN_JV
	ADD SNO	INT	IDENTITY(1,1)
		
	UPDATE	#EXCESS_PAYIN_JV
	SET		PAYIN_ALLOCATED_AMT = ISNULL(A.M_FRESHBUY,0)
	FROM	(
			SELECT	PARTY_CODE,
					M_FRESHBUY = SUM(M_FRESHBUY)
			FROM	#DATAFINAL D
			GROUP BY
					PARTY_CODE
			) A
	WHERE	A.PARTY_CODE = #EXCESS_PAYIN_JV.PARTY_CODE
					
	--SELECT '#DATAFINAL', * FROM	#DATAFINAL D WHERE PARTY_CODE IN ('600M7016')

	--SELECT '#EXCESS_PAYIN_JV-1',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE IN ('600M7016')

	UPDATE	#EXCESS_PAYIN_JV SET PAYIN_EXCESS_AMT = CONVERT(NUMERIC(18,2),ROUND((PAYIN_AMT-PAYIN_ALLOCATED_AMT),2))
	WHERE	(PAYIN_AMT-PAYIN_ALLOCATED_AMT) <> 0

	SELECT '#EXCESS_PAYIN_JV-2',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE IN ('AF7259')
	*/

	
	/*---  SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE ---*/

	ALTER TABLE #JV_SELLPAYIN_ADJ
	ADD SNO	INT	IDENTITY(1,1)

	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JV_SELLPAYIN_ADJ 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN

		CREATE TABLE #VNO5
		(
			VNO	VARCHAR(12)
		)


		INSERT INTO #VNO5 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO5

		UPDATE	#JV_SELLPAYIN_ADJ SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#JV_SELLPAYIN_ADJ SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#JV_SELLPAYIN_ADJ.PARTY_CODE = A.CLTCODE

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ WHERE #JV_SELLPAYIN_ADJ.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ WHERE #JV_SELLPAYIN_ADJ.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)


		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'D'

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'D'
	

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'D'

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'D'




		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'C'

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'C'

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0 AND DRCR = 'C'

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0 AND DRCR = 'C'

	END

	/*---  SELL PAYIN CLOSING ADJ AMOUNT DIFF OF FIFO VS AVG RATE ---*/

	/*---  SELL PAYIN ROUNDING DIFF ADJUSTMENT ENTRY ---*/

	SELECT	PARTY_CODE
	INTO	#PARTY
	FROM	TBL_MTR_REPORTING
	WHERE	SAUDA_DATE = @SAUDA_DATE
	AND EXISTS (SELECT PARTY_CODE FROM #DATAFINAL_JV WHERE #DATAFINAL_JV.PARTY_CODE = TBL_MTR_REPORTING.PARTY_CODE AND AMOUNT<>0) 
	GROUP BY
			PARTY_CODE
	HAVING	SUM(M_FRESHBQTY) = 0	
	
	SELECT	PARTY_CODE, 
			CASHCOLL_AMT=CONVERT(NUMERIC(18,2),(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0 
					THEN SUM(NETAMT) + MTFLEDBAL
					ELSE 0
				END))
	INTO	#JV_SELLPAYIN_ADJ_DIFF_1
	FROM	TBL_MTF_DATA T(NOLOCK)
	WHERE	SAUDA_DATE = @SAUDA_DATE
			AND EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = T.PARTY_CODE)
	GROUP BY
			PARTY_CODE, MTFLEDBAL

	UNION
	
	SELECT	PARTY_CODE,
			CASHCOLL_AMT = SUM(PAYIN_AMT)
	FROM	(
			SELECT	PARTY_CODE = CLTCODE, 
					PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0)
			FROM	LEDGER P(NOLOCK)
			WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
					AND P.VDT <= @SAUDA_DATE + ' 23:59' 
					AND P.VTYP = '66'
					AND P.EDT BETWEEN @SDTCUR AND @EDT + ' 23:59'
			GROUP BY
					CLTCODE

			UNION

			SELECT	PARTY_CODE = CLTCODE, 
					PAYIN_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0)
			FROM	LEDGER P(NOLOCK)
			WHERE	P.VDT BETWEEN @SDTCUR AND @LDTCUR
					AND P.VDT <= @SAUDA_DATE + ' 23:59' 
					AND P.VTYP = '67'
					AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59'
			GROUP BY
					CLTCODE
			) A
	WHERE	EXISTS (SELECT PARTY_CODE FROM #PARTY WHERE #PARTY.PARTY_CODE = A.PARTY_CODE)
	GROUP BY
			PARTY_CODE

	--SELECT * FROM #JV_SELLPAYIN_ADJ_DIFF_1 WHERE PARTY_CODE='AA0895'

	SELECT	PARTY_CODE, 
			AMOUNT = SUM(CASHCOLL_AMT),
			DRCR = CASE WHEN SUM(CASHCOLL_AMT) > 0 THEN 'D' ELSE 'C' END,
			GLCODE = @GLCODE,
			ACNAME = CONVERT(VARCHAR(100),''),
			VNO	= CONVERT(VARCHAR(12),'')
	INTO	#JV_SELLPAYIN_ADJ_DIFF
	FROM	#JV_SELLPAYIN_ADJ_DIFF_1
	GROUP BY
			PARTY_CODE
	HAVING	SUM(CASHCOLL_AMT) < 0 

	--SELECT * FROM #JV_SELLPAYIN_ADJ_DIFF WHERE PARTY_CODE='AA0895'

	ALTER TABLE #JV_SELLPAYIN_ADJ_DIFF
	ADD SNO	INT	IDENTITY(1,1)

	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #JV_SELLPAYIN_ADJ_DIFF

	IF @RECCNT > 0 AND @MTFFLAG >= 1
	BEGIN

		CREATE TABLE #VNO6
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO6 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO6

		UPDATE	#JV_SELLPAYIN_ADJ_DIFF SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#JV_SELLPAYIN_ADJ_DIFF SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#JV_SELLPAYIN_ADJ_DIFF.PARTY_CODE = A.CLTCODE

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN ROUNDING DIFF ADJ%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ_DIFF WHERE #JV_SELLPAYIN_ADJ_DIFF.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%BEING THE SELL PAYIN ROUNDING DIFF ADJ%' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #JV_SELLPAYIN_ADJ_DIFF WHERE #JV_SELLPAYIN_ADJ_DIFF.PARTY_CODE = LEDGER.CLTCODE AND AMOUNT <> 0)

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ_DIFF
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT VTYP='66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ_DIFF J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0
	

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ
		WHERE AMOUNT <> 0

		INSERT INTO LEDGER
		SELECT VTYP='6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR, AMOUNT=ABS(AMOUNT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = 'BEING THE SELL PAYIN ROUNDING DIFF ADJ'
		FROM #JV_SELLPAYIN_ADJ J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND AMOUNT <> 0

	END

	/*---  SELL PAYIN ROUNDING DIFF ADJUSTMENT ENTRY ---*/



	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #EXCESS_PAYIN_JV 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN

		CREATE TABLE #VNO1
		(
			VNO	VARCHAR(12)
		)


		INSERT INTO #VNO1 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO1

		UPDATE	#EXCESS_PAYIN_JV SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#EXCESS_PAYIN_JV SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#EXCESS_PAYIN_JV.PARTY_CODE = A.CLTCODE

		/*---- COMMENTED ON DATE : 09/06/2025 -------*/
		/*
		DELETE FROM MTF_CASH_COLL_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = MTF_CASH_COLL_LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		
		DELETE FROM MTF_CASH_PAYIN_LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = MTF_CASH_PAYIN_LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		*/
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		
		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS' AND VTYP='66'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF CASH EXCESS REV AFTER PAYIN ALLOCATION' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV WHERE #EXCESS_PAYIN_JV.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)
		
		--SELECT '#EXCESS_PAYIN_JV-3',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE IN ('AF7259','AJ7857')

		/*---- MTF_CASH_PAYIN_LEDGER ------*/

		INSERT INTO LEDGER
		SELECT '66', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '23.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '66', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '23.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0
	
		/*---- MTF_CASH_COLL_LEDGER ------*/

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '24.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '24.MTF CASH EXCESS REV AFTER PAYIN ALLOCATION DATE:' + CONVERT(VARCHAR,VDT,103)
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		/*
		EXCESS AVAILABLE CASH AMOUT AFTER PAYIN ALLOCATION IS STOPPED.. 

		INSERT INTO MTF_CASH_COLL_LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '31.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO MTF_CASH_COLL_LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '32.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0


		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '33.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '34.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '35.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '36.MTF PAYIN EXCESS REV'
		FROM #EXCESS_PAYIN_JV J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		SELECT '#EXCESS_PAYIN_JV',* FROM #EXCESS_PAYIN_JV WHERE PARTY_CODE='AF7259'

		DELETE	FROM MTF_JVDATA
		WHERE	SAUDA_DATE = @SAUDA_DATE

		INSERT	INTO MTF_JVDATA
		SELECT	@SAUDA_DATE,
				PARTY_CODE,
				PAYIN_EXCESS_AMT,
				FLAG='CASH',
				GLCODE,
				VNO,
				ACNAME,
				PROCESSDATE = GETDATE(),
				DRCR
		FROM	#EXCESS_PAYIN_JV

		--SELECT 'MTF_JVDATA',* FROM MTF_JVDATA WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE IN ('AF7259')

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'PAYIN-REV'
		EXEC ACCOUNTFO.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'PAYIN-REV'

		SELECT 'LEDGER-2',* FROM ACCOUNT..LEDGER WHERE CLTCODE='AF7259' AND VDT=@SAUDA_DATE
		*/	
	
	END
	

--------------------------------EXCESS CASH COLL REV JV FOR T+1 DAY (FULL & FINAL)------------------------------------------------

	SELECT	PARTY_CODE = CLTCODE, 
			PAYIN_AMT = CONVERT(NUMERIC(18,2),0),
			PAYIN_ALLOCATED_AMT = CONVERT(NUMERIC(18,2),0),
			PAYIN_EXCESS_AMT = ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0),
			ACNAME = P.ACNAME, 
			DRCR = 'D',
			VNO = CONVERT(VARCHAR(12),''),
			GLCODE = @GLCODE
	INTO	#EXCESS_PAYIN_JV_T1D
	FROM	LEDGER P(NOLOCK)
	WHERE	---VDT = @PREVDATE 
			P.VDT BETWEEN @SDTCUR AND @LDTCUR
			--AND P.VDT <= @SAUDA_DATE + ' 23:59:59' 
			AND P.VDT = @SAUDA_DATE
			AND P.VTYP = '6'
			--AND P.EDT BETWEEN @SDTCUR AND @SAUDA_DATE + ' 23:59:59' --VDT = @PREVDATE 
			AND P.EDT BETWEEN @SAUDA_DATE AND @EDT + ' 23:59:59' --VDT = @PREVDATE 
			AND CLTCODE = (CASE WHEN @PARTY_CODE = '' THEN CLTCODE ELSE @PARTY_CODE END)
	GROUP BY
			CLTCODE, P.ACNAME
	HAVING	ISNULL(SUM(CASE WHEN DRCR='D' THEN -VAMT ELSE VAMT END),0) > 0


	ALTER TABLE #EXCESS_PAYIN_JV_T1D
	ADD SNO	INT	IDENTITY(1,1)

	--SELECT '#EXCESS_PAYIN_JV_T1D',* FROM #EXCESS_PAYIN_JV_T1D WHERE PARTY_CODE IN ('AF7259')

	SET @RECCNT = 0

	SELECT @RECCNT = ISNULL(COUNT(1),0) FROM #EXCESS_PAYIN_JV_T1D 
	IF @RECCNT > 0 AND @MTFFLAG = 0
	BEGIN

		CREATE TABLE #VNO2
		(
			VNO	VARCHAR(12)
		)

		INSERT INTO #VNO2 
		EXEC ACC_GENVNO @SAUDA_DATE, 6, '01', @SDTCUR, @LDTCUR, @RECCNT

		SELECT @VNO = VNO FROM #VNO2

		UPDATE	#EXCESS_PAYIN_JV_T1D SET VNO = CONVERT(VARCHAR,CONVERT(BIGINT,@VNO) + SNO - 1)
	
		UPDATE	#EXCESS_PAYIN_JV_T1D SET ACNAME = A.LONGNAME 
		FROM	ACMAST A
		WHERE	#EXCESS_PAYIN_JV_T1D.PARTY_CODE = A.CLTCODE

		DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF EXCESS CASH COLL REV JV' AND CHECKEDBY = 'MTF PROCESS' AND VTYP ='6'
		AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV_T1D WHERE #EXCESS_PAYIN_JV_T1D.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		--DELETE FROM LEDGER WHERE VDT BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59' AND NARRATION LIKE '%MTF EXCESS CASH COLL REV JV FOR T+1 DAY' AND CHECKEDBY = 'MTF PROCESS'
		--AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #EXCESS_PAYIN_JV_T1D WHERE #EXCESS_PAYIN_JV_T1D.PARTY_CODE = LEDGER.CLTCODE AND PAYIN_EXCESS_AMT <> 0)

		/* ---- MTF_CASH_COLL_LEDGER -------- */

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '25.MTF EXCESS CASH COLL REV JV'
		FROM #EXCESS_PAYIN_JV_T1D
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '25.MTF EXCESS CASH COLL REV JV'
		FROM #EXCESS_PAYIN_JV_T1D J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0


		/*---- COMMENTED ON DATE : 09/06/2025 [ FOLLOWING LOGIC IS FOR TRANSFERING FROM MTF CASH COLL LEDGER TO MTF LEDGER ] -------*/
		/*
		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR = (CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '26.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'D' ELSE 'C' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '26.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=1, ACNAME, DRCR, AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		PARTY_CODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '27.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D
		WHERE PAYIN_EXCESS_AMT <> 0

		INSERT INTO LEDGER
		SELECT '6', VNO, @SAUDA_DATE, LNO=2, A.ACNAME, DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), AMOUNT=ABS(PAYIN_EXCESS_AMT), @SAUDA_DATE, '', '', 0, 0, GETDATE(), 
		GLCODE, '01', 'MTF PROCESS', GETDATE(), 'MTF PROCESS', 0, NARRATION = '27.MTF EXCESS CASH COLL REV JV FOR T+1 DAY'
		FROM #EXCESS_PAYIN_JV_T1D J, ACMAST A
		WHERE J.GLCODE = A.CLTCODE
		AND PAYIN_EXCESS_AMT <> 0
		*/
		/*---- COMMENTED ON DATE : 09/06/2025 -------*/

		
		--SELECT '#EXCESS_PAYIN_JV',* FROM #EXCESS_PAYIN_JV_T1D WHERE PARTY_CODE='AF7259'

		DELETE	FROM MTF_JVDATA
		WHERE	SAUDA_DATE = @SAUDA_DATE

		INSERT	INTO MTF_JVDATA (SAUDA_DATE,PARTY_CODE,AMOUNT,FLAG,GLCODE,VNO,ACNAME,PROCESSDATE,DRCR)
		SELECT	@SAUDA_DATE,
				PARTY_CODE,
				PAYIN_EXCESS_AMT,
				FLAG='CASH',
				GLCODE,
				VNO,
				ACNAME,
				PROCESSDATE = GETDATE(),
				DRCR
		FROM	#EXCESS_PAYIN_JV_T1D

		--SELECT 'MTF_JVDATA',* FROM MTF_JVDATA WHERE SAUDA_DATE = @SAUDA_DATE AND PARTY_CODE IN ('AF7259')

		EXEC ACCOUNT.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'CASH-T1DAY-REV'
		EXEC ACCOUNTFO.DBO.PROC_MTF_JV_DATA_NEW @SAUDA_DATE,'CASH-T1DAY-REV'

	END

--------------------------------EXCESS CASH COLL REV JV FOR T1 DAY (FULL & FINAL)------------------------------------------------


END

ELSE
BEGIN                                     
	CREATE TABLE #REPORT    
	(    
	 SNO INT IDENTITY(1,1),    
	 DATA VARCHAR(5000)    
	)   

	INSERT INTO ASIANFILEBATCHNO    
	SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()    
	    
	SET @BATCHNO = @BATCHNO + 1 
        
	SELECT SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,103),      
	MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,    
	BODQTY,    
	BODVALUE,     
	FRESHBQTY,      
	FRESHBUY,      
	FRESHSQTY,    
	FRESHSELL,
	NETQTY,      
	NETAMOUNT
	INTO #NSERPT
	FROM TBL_MTR_REPORTING   
	P, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER       
	WHERE SAUDA_DATE = @SAUDA_DATE
	AND C.CL_CODE = P.PARTY_CODE         
	AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END) 
	and (BODQTY + FRESHBQTY + FRESHSQTY) > 0 

	INSERT INTO #REPORT     
	SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +     
	REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +    
	+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT    
	GROUP BY MEMBERCODE     
    
	INSERT INTO #REPORT    
	SELECT DATA = '30,SELF,01,' +     
	CONVERT(VARCHAR,SUM(NETAMOUNT))    
	FROM #NSERPT   
	GROUP BY #NSERPT.MEMBERCODE   
    
	INSERT INTO #REPORT    
	SELECT DATA = '20,' + REPLACE(ltrim(rtrim(LONG_NAME)),',','') + ',' +     
	ltrim(rtrim(PARTY_CODE)) + ',' + LTRIM(rtrim(UPPER(SCRIP_CD))) +',' + ltrim(rtrim(UPPER(SERIES))) +',' +   
	CONVERT(VARCHAR,SUM(BODQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +      
	CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +    
	CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +     
	CONVERT(VARCHAR,SUM(NETQTY)) + ',' +     
	CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL))     
	FROM #NSERPT    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
  
	/*   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) < 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) < 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
  
	SELECT (SUM(BODVALUE + FRESHBUY - FRESHSELL)), SUM(NETQTY)  
	FROM   #DATAFINAL  
   
	SELECT PARTY_CODE, SCRIP_CD, SERIES,    
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES   
	HAVING SUM(NETQTY) > 0 OR SUM(BODVALUE + FRESHBUY - FRESHSELL) > 0  
	ORDER BY  PARTY_CODE, SCRIP_CD, SERIES   
	RETURN  
	*/  
 
  
	SELECT FILENAME = ltrim(rtrim('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')   
					+ '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),    
	DATA = ltrim(rtrim(upper(data))) FROM #REPORT    
	ORDER BY SNO   
	/*    
	SELECT RECORDTYPE = '10', FILETYPE = 'MTR', MEMBERCODE,    
	BATCHDATE = REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/',''),    
	BATCHNO = '01',SUMCNT = 1,    
	DETAILCNT = COUNT(1),    
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE     
    
	SELECT RECORDTYPE = '20', COMPANY, LEN_CAT = '01',     
	AMOUNT = SUM(NETAMOUNT)    
	FROM #DATAFINAL, MSAJAG.DBO.OWNER     
	GROUP BY #DATAFINAL.MEMBERCODE,COMPANY    
    
	SELECT RECORDTYPE = '30', LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES,     
	BODQTY = SUM(BODQTY),    
	BODVALUE = SUM(BODVALUE),       
	FRESHBQTY = SUM(FRESHBQTY),    
	FRESHBUY = SUM(FRESHBUY),     
	FRESHSQTY = SUM(FRESHSQTY),    
	FRESHSELL = SUM(FRESHSELL),       
	NETQTY = SUM(NETQTY),    
	NETAMOUNT = SUM(BODVALUE + FRESHBUY - FRESHSELL)    
	FROM #DATAFINAL    
	GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES    
	*/    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PENDINGSLIP_DETAIL
-- --------------------------------------------------
--exec RPT_PENDINGSLIP_DETAIL 'Nov 29 2019'


CREATE PROC [dbo].[RPT_PENDINGSLIP_DETAIL]
(
	@REPORTDATE	VARCHAR(11)
)
AS
SELECT ISIN = CERTNO, QTY = SUM(QTY), TARGET=isnull(HOLDERNAME,''),SOURCE=BCLTDPID, FROMEXCHANGE='NSE' FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 1002
GROUP BY CertNo, HolderName, BCltDpId

UNION ALL
 
SELECT ISIN = CERTNO, QTY = SUM(QTY), TARGET='INVOKE',SOURCE=BCLTDPID, FROMEXCHANGE='NSE' FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 1003
GROUP BY CertNo, HolderName, BCltDpId
UNION ALL
SELECT ISIN = CERTNO, QTY = SUM(QTY), TARGET='UNPLEDGE',SOURCE=BCLTDPID, FROMEXCHANGE='NSE' FROM ANGELDEMAT.MSAJAG.DBO.DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 905
GROUP BY CertNo, HolderName, BCltDpId
UNION ALL
SELECT ISIN = CERTNO, QTY = SUM(QTY), TARGET=isnull(HOLDERNAME,''),SOURCE=BCLTDPID, FROMEXCHANGE='BSE' FROM ANGELDEMAT.BSEDB.DBO.DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 1002
GROUP BY CertNo, HolderName, BCltDpId

UNION ALL

SELECT ISIN = CERTNO, QTY = SUM(QTY), TARGET=isnull(BOID,''),SOURCE=PARTY_CODE, FROMEXCHANGE='POA' 
FROM ANGELDEMAT.MSAJAG.DBO.TBL_POA_COLL_DATA 
WHERE  DELIVERED = '0'  
GROUP BY CERTNO,PARTY_CODE, BOID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PENDINGSLIP_SUMMARY
-- --------------------------------------------------



CREATE PROC [dbo].[RPT_PENDINGSLIP_SUMMARY] 
(
	@REPORTDATE	VARCHAR(11)
)
AS
SELECT DISTINCT TARGET=isnull(HOLDERNAME,''),SOURCE=BCLTDPID, FROMEXCHANGE='NSE' FROM MSAJAG..DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 1002
UNION ALL
 
SELECT DISTINCT TARGET='INVOKE',SOURCE=BCLTDPID, FROMEXCHANGE='NSE' FROM MSAJAG..DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 1003
UNION ALL
SELECT DISTINCT TARGET='UNPLEDGE',SOURCE=BCLTDPID, FROMEXCHANGE='NSE' FROM MSAJAG..DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 905
UNION ALL
SELECT DISTINCT TARGET=isnull(HOLDERNAME,''),SOURCE=BCLTDPID, FROMEXCHANGE='BSE' FROM BSEDB..DELTRANS 
WHERE DRCR = 'D'
AND DELIVERED = '0' 
AND FILLER2 = 1 and TrType = 1002

UNION ALL

SELECT DISTINCT TARGET=isnull(BOID,''),SOURCE='POA', FROMEXCHANGE='POA' FROM msajag..TBL_POA_COLL_DATA 
WHERE  DELIVERED = '0'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_SCRIPMFUND
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_SCRIPMFUND]  
(        
 @STATUSID VARCHAR(50),        
 @STATUSNAME VARCHAR(50),        
 @FROMDATE VARCHAR(11),        
 @TODATE  VARCHAR(11),        
 @FROMPARTY VARCHAR(10),        
 @TOPARTY VARCHAR(10),        
 @FROMSCRIP VARCHAR(50)='',        
 @TOSCRIP VARCHAR(50)='',        
 @OPT VARCHAR(20)=''      
)       
AS  

-- EXEC RPT_SCRIPMFUND 'BROKER', 'BROKER', 'NOV 14 2018', 'NOV 14 2018', '0', 'ZZZ', 'INF', 'ING', ''

DECLARE @FNO	INT,
		@NONFNO	INT

SELECT @NONFNO = NONFNO, @FNO = FNO FROM TBL_MTF_MULTIPLIER
WHERE @FROMDATE BETWEEN FROMDATE AND TODATE

SET @TOSCRIP = (CASE WHEN @TOSCRIP = '' THEN 'ZZZZZZZZZZ' ELSE @TOSCRIP END)  
  
SELECT *, NSE_SYMBOL = CONVERT(VARCHAR(12),''), SERIES = CONVERT(VARCHAR,3),   
BSE_SYMBOL = CONVERT(VARCHAR(6),''), SCRIP_NAME = CONVERT(VARCHAR(50),''),
SECVAR = CONVERT(NUMERIC(18,2),0),
SPLVAR = CONVERT(NUMERIC(18,2),0),
FOLISTED = 0,
FINALHAIRCUT = CONVERT(NUMERIC(18,2),0),
VARDATE = CONVERT(VARCHAR(10),'')  
INTO #DATA FROM TBL_ISIN_LIMIT  
WHERE @FROMDATE BETWEEN FROMDATE AND TODATE 
ORDER BY SCRIP_NAME  
  
UPDATE #DATA SET NSE_SYMBOL = M.SCRIP_CD, SERIES = M.SERIES  
FROM ANGELDEMAT.MSAJAG.DBO.MULTIISIN M  
WHERE #DATA.ISIN = M.ISIN  
AND VALID = 1   
  
UPDATE #DATA SET BSE_SYMBOL = M.SCRIP_CD  
FROM ANGELDEMAT.BSEDB.DBO.MULTIISIN M  
WHERE #DATA.ISIN = M.ISIN  
AND VALID = 1   
  
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM MSAJAG.DBO.SCRIP1 S1, MSAJAG.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.SCRIP_CD = NSE_SYMBOL  
AND S2.SERIES = #DATA.SERIES  
  
UPDATE #DATA SET SCRIP_NAME = S1.LONG_NAME FROM AngelBSECM.BSEDB_AB.DBO.SCRIP1 S1, AngelBSECM.BSEDB_AB.DBO.SCRIP2 S2  
WHERE S1.CO_CODE = S2.CO_CODE  
AND S1.SERIES = S2.SERIES  
AND S2.SCRIP_CD = BSE_SYMBOL  
AND SCRIP_NAME = ''  

SELECT * INTO #DATAFINAL FROM #DATA  
WHERE SCRIP_NAME >= @FROMSCRIP AND SCRIP_NAME <= @TOSCRIP  
ORDER BY SCRIP_NAME  
  
UPDATE #DATAFINAL SET FOLISTED = 1 
FROM ANGELFO.NSEFO.DBO.FOSCRIP2 F
WHERE F.SYMBOL = #DATAFINAL.NSE_SYMBOL
AND F.INST_TYPE LIKE 'FUT%'
AND F.EXPIRYDATE >= @FROMDATE 

SELECT V.* INTO #B_NSE_VAR FROM MSAJAG.DBO.VARDETAIL V, 
MSAJAG.DBO.VARCONTROL C
WHERE C.RECDATE = (SELECT max(RECDATE) FROM MSAJAG.DBO.VARCONTROL WHERE RECDATE <= @FROMDATE)
AND C.DETAILKEY = V.DETAILKEY
AND SERIES IN ( 'EQ', 'BE', 'BZ' ) 
AND ISIN IN (SELECT ISIN FROM #DATAFINAL)

SELECT V.* INTO #B_BSE_VAR FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V
WHERE V.FDATE = (select MAX(FDATE) from AngelBSECM.BSEDB_AB.DBO.VARDETAIL where FDATE <= @FROMDATE)
AND ISIN IN (SELECT ISIN FROM #DATAFINAL)

UPDATE #DATAFINAL SET SECVAR = APPVAR, SPLVAR = SECSPECVAR,
FINALHAIRCUT = APPVAR + (CASE WHEN FOLISTED = 1 THEN SECSPECVAR * @FNO ELSE SECSPECVAR * @NONFNO END)
FROM #B_NSE_VAR
WHERE #DATAFINAL.ISIN = #B_NSE_VAR.ISIN

IF CONVERT(DATETIME,@FROMDATE) > CONVERT(DATETIME,'AUG 10 2017') 
BEGIN
	UPDATE #DATAFINAL SET SECVAR = MARGIN, SPLVAR = ELM,
	FINALHAIRCUT = MARGIN + (CASE WHEN FOLISTED = 1 THEN ELM * 3 ELSE ELM * 5 END)
	FROM #B_BSE_VAR
	WHERE #DATAFINAL.ISIN = #B_BSE_VAR.ISIN
	AND FINALHAIRCUT = 0 
END
ELSE
BEGIN
	UPDATE #DATAFINAL SET SECVAR = MARGIN, SPLVAR = 0,
	FINALHAIRCUT = MARGIN --+ (CASE WHEN FOLISTED = 1 THEN SECSPECVAR * 3 ELSE SECSPECVAR * 5 END)
	FROM #B_BSE_VAR
	WHERE #DATAFINAL.ISIN = #B_BSE_VAR.ISIN
	AND FINALHAIRCUT = 0 
END

UPDATE #DATAFINAL SET FINALHAIRCUT = (CASE WHEN FINALHAIRCUT > F.VARMARGIN THEN FINALHAIRCUT ELSE F.VARMARGIN END)
FROM MTF_ANGEL_Varmargin F 
WHERE @FROMDATE BETWEEN F.From_date AND F.end_date 
AND #DATAFINAL.ISIN=F.ISIN

ALTER TABLE  #DATAFINAL 
ADD SNO INT IDENTITY(1,1)

SELECT SNO, [ENTER DATE]=CONVERT(VARCHAR,ADDED_ON,103), ISIN, [Scrip Code - NSE] = NSE_SYMBOL, [Scrip Code - BSE] = BSE_SYMBOL,  
[Scrip Name] = SCRIP_NAME,-- [Permissible Quantity] = QTY_LIMIT, [Minimum Haircut %] = FUNDING_PER,  
[FROM DATE] = CONVERT(VARCHAR,FROMDATE,103), [TO DATE] = CONVERT(VARCHAR,TODATE,103),  
[Special Remarks] = REMARK,
SECVAR, SPLVAR, FOLISTED = (CASE WHEN FOLISTED = - 0 THEN 'NO' ELSE 'YES' END),
MULTIPLIER = (CASE WHEN FOLISTED = 1 THEN @FNO ELSE @NONFNO END),
--FINALHAIRCUT = (CASE WHEN FINALHAIRCUT > 100 THEN 100 ELSE FINALHAIRCUT END) --, VARDATE   --SRE 30980 Changed By Vaibhav Khedekar ---
FINALHAIRCUT = (CASE WHEN FINALHAIRCUT > 100 THEN 100 ELSE (CASE WHEN FOLISTED = 1  AND FINALHAIRCUT<25 THEN FINALHAIRCUT+2 Else FINALHAIRCUT END) END) --, VARDATE
FROM #DATAFINAL   
WHERE SCRIP_NAME >= @FROMSCRIP AND SCRIP_NAME <= @TOSCRIP  
ORDER BY SCRIP_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Searchinall
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[Searchinall] 
(@STRFIND AS VARCHAR(MAX))
AS



BEGIN
    SET NOCOUNT ON; 
    --TO FIND STRING IN ALL PROCEDURES        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) SP_NAME
              ,OBJECT_DEFINITION(OBJECT_ID) SP_DEFINITION
        FROM   SYS.PROCEDURES
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@STRFIND+'%'
    END 

    --TO FIND STRING IN ALL VIEWS        
    BEGIN
        SELECT OBJECT_NAME(OBJECT_ID) VIEW_NAME
              ,OBJECT_DEFINITION(OBJECT_ID) VIEW_DEFINITION
        FROM   SYS.VIEWS
        WHERE  OBJECT_DEFINITION(OBJECT_ID) LIKE '%'+@STRFIND+'%'
    END 

    --TO FIND STRING IN ALL FUNCTION        
    BEGIN
        SELECT ROUTINE_NAME           FUNCTION_NAME
              ,ROUTINE_DEFINITION     FUNCTION_DEFINITION
        FROM   INFORMATION_SCHEMA.ROUTINES
        WHERE  ROUTINE_DEFINITION LIKE '%'+@STRFIND+'%'
               AND ROUTINE_TYPE = 'FUNCTION'
        ORDER BY
               ROUTINE_NAME
    END

    --TO FIND STRING IN ALL TABLES OF DATABASE.    
    BEGIN
        SELECT T.NAME      AS TABLE_NAME
              ,C.NAME      AS COLUMN_NAME
        FROM   SYS.TABLES  AS T
               INNER JOIN SYS.COLUMNS C
                    ON  T.OBJECT_ID = C.OBJECT_ID
        WHERE  C.NAME LIKE '%'+@STRFIND+'%'
        ORDER BY
               TABLE_NAME
    END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_POdet
-- --------------------------------------------------

CREATE Procedure [dbo].[SEBI_POdet](@flag as varchar(10) = null)            
as            
            
Set nocount on                          
         


select distinct party_code into #aaa from MIS.sccs.dbo.sccs_clientmaster with(nolock)
          /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                                                                              
          and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                                              
          where sccs_settDate_last>=convert(varchar(11),getdate())                                                                              
          and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'            
          and exclude='N'
          
  
if @Flag='Daily'
Begin
	insert into #aaa
	select  distinct party_code from INTRANET.cms.dbo.sccs_clientmaster_provisional with(nolock) where
	SCCS_SettDate_Last =  DATEADD(DAY, 7 - DATEPART(WEEKDAY, GETDATE()), CAST(GETDATE() AS DATE)) and exclude='N'
end          
                      
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
          
            
 Truncate table SEBI_PO            
         
 insert into SEBI_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate and cltcode in (select party_code from #aaa)            
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update SEBI_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where SEBI_PO.cltcode=b.cltcode            
         
 update SEBI_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from SEBI_PO where cltcode like '98%' and VBAL < 0) b            
 where SEBI_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 --select       
 --CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 --into #b2B      
 --from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 --and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 --group by cltcode      
      
 --update SEBI_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where SEBI_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table SEBI_PO_NSEIPO          
 insert into SEBI_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from SEBI_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           


set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_POdet_For_FinancialYearEnd
-- --------------------------------------------------

create Procedure [dbo].[SEBI_POdet_For_FinancialYearEnd](@pcode as varchar(10) = null)            
as            
            
Set nocount on                          
         
            
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
            
IF @Pcode is null            
BEGIN            
            
 Truncate table SEBI_PO            
         
 insert into SEBI_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate             
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update SEBI_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where SEBI_PO.cltcode=b.cltcode            
         
 update SEBI_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from SEBI_PO where cltcode like '98%' and VBAL < 0) b            
 where SEBI_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 select       
 CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 into #b2B      
 from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 group by cltcode      
      
 update SEBI_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where SEBI_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table SEBI_PO_NSEIPO          
 insert into SEBI_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from SEBI_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           
END            

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_POdet_new
-- --------------------------------------------------
    
    
CREATE Procedure [dbo].[SEBI_POdet_new](@flag as varchar(10) = null)                
as                
                
Set nocount on                              
             
    
    
--select distinct party_code into #aaa from [196.1.115.167].sccs.dbo.sccs_clientmaster with(nolock)    
--          /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                                                                                  
--          and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                                                  
--          where sccs_settDate_last>=convert(varchar(11),getdate())                                                                                  
--          and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'                
--          and exclude='N'    
              
      
--if @Flag='Daily'    
--Begin    
-- insert into #aaa    
-- select  distinct party_code from [196.1.115.132].cms.dbo.sccs_clientmaster_provisional with(nolock) where    
-- SCCS_SettDate_Last =  DATEADD(DAY, 7 - DATEPART(WEEKDAY, GETDATE()), CAST(GETDATE() AS DATE)) and exclude='N'    
--end              
                          
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                 
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()                
              
               
 Truncate table SEBI_PO                
             
 insert into SEBI_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)                
 select Getdate(),CLTCODE,                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),                 
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */    
 UCV=0,    
 0,0                
 from ledger a with (nolock)                 
 where /*VDT>=@sdtcur*/ EDT>@ToDate and VDT <= @ToDate --and drcr='D' and cltcode in (select party_code from #aaa)                
 group by cltcode        
     
 --update  a set VBal=VBal-block_amt from SEBI_PO a, [tbl_07Apr2023] b where LTRIM(rtrim(a.Cltcode))=LTRIM(rtrim(b.party_code))    
     
 /* -- Not considered in MTF--*/        
 /*        
 update SEBI_PO set UNRecoCr=-b.UnRecoCr from                 
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b                
 where SEBI_PO.cltcode=b.cltcode                
             
 update SEBI_PO set OTherDr=b.Vbal from                
 (select substring(Cltcode,3,10) as Cltcode,VBAl from SEBI_PO where cltcode like '98%' and VBAL < 0) b                
 where SEBI_PO.cltcode=b.cltcode                
 */             
     
 /* Bill to Bill Client */          
 --select           
 --CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)          
 --into #b2B          
 --from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')          
 --and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')          
 --group by cltcode          
          
 --update SEBI_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where SEBI_PO.cltcode=b.cltcode          
 /* B2B End */          
     
 /*           
 truncate table SEBI_PO_NSEIPO              
 insert into SEBI_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)              
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr               
 from SEBI_PO               
 where cltcode like '6%' and ISNUMERIC(cltcode)=0              
   */            
               
    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_POdet_new_06Apr2023
-- --------------------------------------------------


CREATE Procedure [dbo].[SEBI_POdet_new_06Apr2023](@flag as varchar(10) = null)            
as            
            
Set nocount on                          
         


--select distinct party_code into #aaa from [196.1.115.167].sccs.dbo.sccs_clientmaster with(nolock)
--          /*where sccs_settDate_last>=convert(varchar(11),CONVERT(datetime,'1 jan 2011'))                                                                              
--          and sccs_settDate_last<convert(varchar(11),CONVERT(datetime,'16 jan 2011'))+' 23:59:59' */                                              
--          where sccs_settDate_last>=convert(varchar(11),getdate())                                                                              
--          and sccs_settDate_last<convert(varchar(11),getdate()+6)+' 23:59:59'            
--          and exclude='N'
          
  
--if @Flag='Daily'
--Begin
--	insert into #aaa
--	select  distinct party_code from [196.1.115.132].cms.dbo.sccs_clientmaster_provisional with(nolock) where
--	SCCS_SettDate_Last =  DATEADD(DAY, 7 - DATEPART(WEEKDAY, GETDATE()), CAST(GETDATE() AS DATE)) and exclude='N'
--end          
                      
declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'             
select @sdtcur=sdtcur from account.dbo.parameter with (nolock) where sdtcur <= GETDATE() and ldtcur >=GETDATE()            
          
            
 Truncate table SEBI_PO            
         
 insert into SEBI_PO(ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)            
 select Getdate(),CLTCODE,            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end),             
 /*UCV=sum(Case when edt > @Todate and Drcr='C' then -Vamt else 0 end),            */
 UCV=0,
 0,0            
 from ledger a with (nolock)             
 where VDT>=@sdtcur and VDT <= @ToDate-- and cltcode in (select party_code from #aaa)            
 group by cltcode            
 
 /* -- Not considered in MTF--*/    
 /*    
 update SEBI_PO set UNRecoCr=-b.UnRecoCr from             
 (select cltcode,SUM(Cramt) as UnRecoCr from BO_client_deposit_recno group by cltcode) b            
 where SEBI_PO.cltcode=b.cltcode            
         
 update SEBI_PO set OTherDr=b.Vbal from            
 (select substring(Cltcode,3,10) as Cltcode,VBAl from SEBI_PO where cltcode like '98%' and VBAL < 0) b            
 where SEBI_PO.cltcode=b.cltcode            
 */         
 
 /* Bill to Bill Client */      
 --select       
 --CLTCODE, B2Bamt=sum(case when drcr='D' then -VAMT else VAMT end)      
 --into #b2B      
 --from ledger where vtyp=15 and edt>=(CONVERT(varchar(11),getdate())) and edt<=(CONVERT(varchar(11),getdate())+' 23:59:59')      
 --and cltcode in (select partyCode from intranet.cms.dbo.tbl_manualbill_mark with (nolock) where payoutType='B')      
 --group by cltcode      
      
 --update SEBI_PO set vbal=b2bamt,UCV=0,UnRecoCr=0,OtherDr=0 from #b2B b where SEBI_PO.cltcode=b.cltcode      
 /* B2B End */      
 
 /*       
 truncate table SEBI_PO_NSEIPO          
 insert into SEBI_PO_NSEIPO (ProcessDateTime,Cltcode,VBal,UCV,UnRecoCr,OtherDr)          
 select ProcessDateTime,substring(Cltcode,2,10) as cltcode,VBal,UCV,UnRecoCr,OtherDr           
 from SEBI_PO           
 where cltcode like '6%' and ISNUMERIC(cltcode)=0          
   */        
           


set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
    
CREATE PROC SP @SPNAME VARCHAR(25)AS                 
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @SPNAME + '%' AND XTYPE='P' ORDER BY NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_generate_inserts
-- --------------------------------------------------
-- http://vyaskn.tripod.com/code.htm#inserts 
------------------------------------------------------------------------------------------------------------------------ 
--SET NOCOUNT ON 
--GO 
-- 
--PRINT 'Using Master database' 
--USE master 
--GO 
-- 
--PRINT 'Checking for the existence of this procedure' 
--IF (SELECT OBJECT_ID('sp_generate_inserts','P')) IS NOT NULL --means, the procedure already exists 
-- BEGIN 
-- PRINT 'Procedure already exists. So, dropping it' 
-- DROP PROC sp_generate_inserts 
-- END 
--GO 
-- 
----Turn system object marking on 
--EXEC master.dbo.sp_MS_upd_sysobj_category 1 
--GO 
CREATE PROC [dbo].[sp_generate_inserts] 
( 
@table_name varchar(776), -- The table/view for which the INSERT statements will be generated using the existing data 
@target_table varchar(776) = NULL, -- Use this parameter to specify a different table name into which the data will be inserted 
@include_column_list bit = 1, -- Use this parameter to include/ommit column list in the generated INSERT statement 
@from varchar(800) = NULL, -- Use this parameter to filter the rows based on a filter condition (using WHERE) 
@include_timestamp bit = 0, -- Specify 1 for this parameter, if you want to include the TIMESTAMP/ROWVERSION column's data in the INSERT statement 
@debug_mode bit = 0, -- If @debug_mode is set to 1, the SQL statements constructed by this procedure will be printed for later examination 
@owner varchar(64) = NULL, -- Use this parameter if you are not the owner of the table 
@ommit_images bit = 0, -- Use this parameter to generate INSERT statements by omitting the 'image' columns 
@ommit_identity bit = 0, -- Use this parameter to ommit the identity columns 
@top int = NULL, -- Use this parameter to generate INSERT statements only for the TOP n rows 
@cols_to_include varchar(8000) = NULL, -- List of columns to be included in the INSERT statement 
@cols_to_exclude varchar(8000) = NULL, -- List of columns to be excluded from the INSERT statement 
@disable_constraints bit = 0, -- When 1, disables foreign key constraints and enables them after the INSERT statements 
@ommit_computed_cols bit = 0 -- When 1, computed columns will not be included in the INSERT statement 
) 
AS 
BEGIN 
/*********************************************************************************************************** 
Procedure: sp_generate_inserts (Build 22) 
(Copyright  2002 Narayana Vyas Kondreddi. All rights reserved.) 
Purpose: To generate INSERT statements from existing data. 
These INSERTS can be executed to regenerate the data at some other location. 
This procedure is also useful to create a database setup, where in you can 
script your data along with your table definitions. 
Written by: Narayana Vyas Kondreddi 
http://vyaskn.tripod.com 
Acknowledgements: 
Divya Kalra -- For beta testing 
Mark Charsley -- For reporting a problem with scripting uniqueidentifier columns with NULL values 
Artur Zeygman -- For helping me simplify a bit of code for handling non-dbo owned tables 
Joris Laperre -- For reporting a regression bug in handling text/ntext columns 
Tested on: SQL Server 7.0 and SQL Server 2000 
Date created: January 17th 2001 21:52 GMT 
Date modified: May 1st 2002 19:50 GMT 
Email: vyaskn@hotmail.com 
NOTE: This procedure may not work with tables with too many columns. 
Results can be unpredictable with huge text columns or SQL Server 2000's sql_variant data types 
Whenever possible, Use @include_column_list parameter to ommit column list in the INSERT statement, for better results 
IMPORTANT: This procedure is not tested with internation data (Extended characters or Unicode). If needed 
you might want to convert the datatypes of character variables in this procedure to their respective unicode counterparts 
like nchar and nvarchar 
Example 1: To generate INSERT statements for table 'titles': 
EXEC sp_generate_inserts 'titles' 
Example 2: To ommit the column list in the INSERT statement: (Column list is included by default) 
IMPORTANT: If you have too many columns, you are advised to ommit column list, as shown below, 
to avoid erroneous results 
EXEC sp_generate_inserts 'titles', @include_column_list = 0 
Example 3: To generate INSERT statements for 'titlesCopy' table from 'titles' table: 
EXEC sp_generate_inserts 'titles', 'titlesCopy' 
Example 4: To generate INSERT statements for 'titles' table for only those titles 
which contain the word 'Computer' in them: 
NOTE: Do not complicate the FROM or WHERE clause here. It's assumed that you are good with T-SQL if you are using this parameter 
EXEC sp_generate_inserts 'titles', @from = "from titles where title like '%Computer%'" 
Example 5: To specify that you want to include TIMESTAMP column's data as well in the INSERT statement: 
(By default TIMESTAMP column's data is not scripted) 
EXEC sp_generate_inserts 'titles', @include_timestamp = 1 
Example 6: To print the debug information: 
EXEC sp_generate_inserts 'titles', @debug_mode = 1 
Example 7: If you are not the owner of the table, use @owner parameter to specify the owner name 
To use this option, you must have SELECT permissions on that table 
EXEC sp_generate_inserts Nickstable, @owner = 'Nick' 
Example 8: To generate INSERT statements for the rest of the columns excluding images 
When using this otion, DO NOT set @include_column_list parameter to 0. 
EXEC sp_generate_inserts imgtable, @ommit_images = 1 
Example 9: To generate INSERT statements excluding (ommiting) IDENTITY columns: 
(By default IDENTITY columns are included in the INSERT statement) 
EXEC sp_generate_inserts mytable, @ommit_identity = 1 
Example 10: To generate INSERT statements for the TOP 10 rows in the table: 
EXEC sp_generate_inserts mytable, @top = 10 
Example 11: To generate INSERT statements with only those columns you want: 
EXEC sp_generate_inserts titles, @cols_to_include = "'title','title_id','au_id'" 
Example 12: To generate INSERT statements by omitting certain columns: 
EXEC sp_generate_inserts titles, @cols_to_exclude = "'title','title_id','au_id'" 
Example 13: To avoid checking the foreign key constraints while loading data with INSERT statements: 
EXEC sp_generate_inserts titles, @disable_constraints = 1 
Example 14: To exclude computed columns from the INSERT statement: 
EXEC sp_generate_inserts MyTable, @ommit_computed_cols = 1 
***********************************************************************************************************/ 
SET NOCOUNT ON 
--Making sure user only uses either @cols_to_include or @cols_to_exclude 
IF ((@cols_to_include IS NOT NULL) AND (@cols_to_exclude IS NOT NULL)) 
BEGIN 
RAISERROR('Use either @cols_to_include or @cols_to_exclude. Do not use both the parameters at once',16,1) 
RETURN -1 --Failure. Reason: Both @cols_to_include and @cols_to_exclude parameters are specified 
END 
--Making sure the @cols_to_include and @cols_to_exclude parameters are receiving values in proper format 
IF ((@cols_to_include IS NOT NULL) AND (PATINDEX('''%''',@cols_to_include) = 0)) 
BEGIN 
RAISERROR('Invalid use of @cols_to_include property',16,1) 
PRINT 'Specify column names surrounded by single quotes and separated by commas' 
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_include = "''title_id'',''title''"' 
RETURN -1 --Failure. Reason: Invalid use of @cols_to_include property 
END 
IF ((@cols_to_exclude IS NOT NULL) AND (PATINDEX('''%''',@cols_to_exclude) = 0)) 
BEGIN 
RAISERROR('Invalid use of @cols_to_exclude property',16,1) 
PRINT 'Specify column names surrounded by single quotes and separated by commas' 
PRINT 'Eg: EXEC sp_generate_inserts titles, @cols_to_exclude = "''title_id'',''title''"' 
RETURN -1 --Failure. Reason: Invalid use of @cols_to_exclude property 
END 
--Checking to see if the database name is specified along wih the table name 
--Your database context should be local to the table for which you want to generate INSERT statements 
--specifying the database name is not allowed 
IF (PARSENAME(@table_name,3)) IS NOT NULL 
BEGIN 
RAISERROR('Do not specify the database name. Be in the required database and just specify the table name.',16,1) 
RETURN -1 --Failure. Reason: Database name is specified along with the table name, which is not allowed 
END 
--Checking for the existence of 'user table' or 'view' 
--This procedure is not written to work on system tables 
--To script the data in system tables, just create a view on the system tables and script the view instead 
IF @owner IS NULL 
BEGIN 
IF ((OBJECT_ID(@table_name,'U') IS NULL) AND (OBJECT_ID(@table_name,'V') IS NULL)) 
BEGIN 
RAISERROR('User table or view not found.',16,1) 
PRINT 'You may see this error, if you are not the owner of this table or view. In that case use @owner parameter to specify the owner name.' 
PRINT 'Make sure you have SELECT permission on that table or view.' 
RETURN -1 --Failure. Reason: There is no user table or view with this name 
END 
END 
ELSE 
BEGIN 
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @table_name AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @owner) 
BEGIN 
RAISERROR('User table or view not found.',16,1) 
PRINT 'You may see this error, if you are not the owner of this table. In that case use @owner parameter to specify the owner name.' 
PRINT 'Make sure you have SELECT permission on that table or view.' 
RETURN -1 --Failure. Reason: There is no user table or view with this name 
END 
END 
--Variable declarations 
DECLARE @Column_ID int, 
@Column_List varchar(8000), 
@Column_Name varchar(128), 
@Start_Insert varchar(786), 
@Data_Type varchar(128), 
@Actual_Values varchar(max), --This is the string that will be finally executed to generate INSERT statements 
@IDN varchar(128) --Will contain the IDENTITY column's name in the table 
--Variable Initialization 
SET @IDN = '' 
SET @Column_ID = 0 
SET @Column_Name = '' 
SET @Column_List = '' 
SET @Actual_Values = '' 
IF @owner IS NULL 
BEGIN 
SET @Start_Insert = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' 
END 
ELSE 
BEGIN 
SET @Start_Insert = 'INSERT ' + '[' + LTRIM(RTRIM(@owner)) + '].' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' 
END 
--To get the first column's ID 
SELECT @Column_ID = MIN(ORDINAL_POSITION) 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE TABLE_NAME = @table_name AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
--Loop through all the columns of the table, to get the column names and their data types 
WHILE @Column_ID IS NOT NULL 
BEGIN 
SELECT @Column_Name = QUOTENAME(COLUMN_NAME), 
@Data_Type = DATA_TYPE 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE ORDINAL_POSITION = @Column_ID AND 
TABLE_NAME = @table_name AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
IF @cols_to_include IS NOT NULL --Selecting only user specified columns 
BEGIN 
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_include) = 0 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
IF @cols_to_exclude IS NOT NULL --Selecting only user specified columns 
BEGIN 
IF CHARINDEX( '''' + SUBSTRING(@Column_Name,2,LEN(@Column_Name)-2) + '''',@cols_to_exclude) <> 0 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Making sure to output SET IDENTITY_INSERT ON/OFF in case the table has an IDENTITY column 
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsIdentity')) = 1 
BEGIN 
IF @ommit_identity = 0 --Determing whether to include or exclude the IDENTITY column 
SET @IDN = @Column_Name 
ELSE 
GOTO SKIP_LOOP 
END 
--Making sure whether to output computed columns or not 
IF @ommit_computed_cols = 1 
BEGIN 
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name),SUBSTRING(@Column_Name,2,LEN(@Column_Name) - 2),'IsComputed')) = 1 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Tables with columns of IMAGE data type are not supported for obvious reasons 
IF(@Data_Type in ('image')) 
BEGIN 
IF (@ommit_images = 0) 
BEGIN 
RAISERROR('Tables with image columns are not supported.',16,1) 
PRINT 'Use @ommit_images = 1 parameter to generate INSERTs for the rest of the columns.' 
PRINT 'DO NOT ommit Column List in the INSERT statements. If you ommit column list using @include_column_list=0, the generated INSERTs will fail.' 
RETURN -1 --Failure. Reason: There is a column with image data type 
END 
ELSE 
BEGIN 
GOTO SKIP_LOOP 
END 
END 
--Determining the data type of the column and depending on the data type, the VALUES part of 
--the INSERT statement is generated. Care is taken to handle columns with NULL values. Also 
--making sure, not to lose any data from flot, real, money, smallmomey, datetime columns 
SET @Actual_Values = @Actual_Values + 
CASE 
WHEN @Data_Type IN ('char','varchar','nchar','nvarchar') 
THEN 
'COALESCE('''''''' + REPLACE(RTRIM(' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('datetime','smalldatetime') 
THEN 
'COALESCE('''''''' + RTRIM(CONVERT(char,' + @Column_Name + ',109))+'''''''',''NULL'')' 
WHEN @Data_Type IN ('uniqueidentifier') 
THEN 
'COALESCE('''''''' + REPLACE(CONVERT(char(255),RTRIM(' + @Column_Name + ')),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('text','ntext') 
THEN 
'COALESCE('''''''' + REPLACE(CONVERT(char(8000),' + @Column_Name + '),'''''''','''''''''''')+'''''''',''NULL'')' 
WHEN @Data_Type IN ('binary','varbinary') 
THEN 
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')' 
WHEN @Data_Type IN ('timestamp','rowversion') 
THEN 
CASE 
WHEN @include_timestamp = 0 
THEN 
'''DEFAULT''' 
ELSE 
'COALESCE(RTRIM(CONVERT(char,' + 'CONVERT(int,' + @Column_Name + '))),''NULL'')' 
END 
WHEN @Data_Type IN ('float','real','money','smallmoney') 
THEN 
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ',2)' + ')),''NULL'')' 
ELSE 
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(char, ' + @Column_Name + ')' + ')),''NULL'')' 
END + '+' + ''',''' + ' + ' 
--Generating the column list for the INSERT statement 
SET @Column_List = @Column_List + @Column_Name + ',' 
SKIP_LOOP: --The label used in GOTO 
SELECT @Column_ID = MIN(ORDINAL_POSITION) 
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK) 
WHERE TABLE_NAME = @table_name AND 
ORDINAL_POSITION > @Column_ID AND 
(@owner IS NULL OR TABLE_SCHEMA = @owner) 
--Loop ends here! 
END 
--To get rid of the extra characters that got concatenated during the last run through the loop 
SET @Column_List = LEFT(@Column_List,len(@Column_List) - 1) 
SET @Actual_Values = LEFT(@Actual_Values,len(@Actual_Values) - 6) 
IF LTRIM(@Column_List) = '' 
BEGIN 
RAISERROR('No columns to select. There should at least be one column to generate the output',16,1) 
RETURN -1 --Failure. Reason: Looks like all the columns are ommitted using the @cols_to_exclude parameter 
END 
--Forming the final string that will be executed, to output the INSERT statements 
IF (@include_column_list <> 0) 
BEGIN 
SET @Actual_Values = 
'SELECT ' + 
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END + 
'''' + RTRIM(@Start_Insert) + 
' ''+' + '''(' + RTRIM(@Column_List) + '''+' + ''')''' + 
' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' + 
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)') 
END 
ELSE IF (@include_column_list = 0) 
BEGIN 
SET @Actual_Values = 
'SELECT ' + 
CASE WHEN @top IS NULL OR @top < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@top)) + ' ' END + 
'''' + RTRIM(@Start_Insert) + 
' '' +''VALUES(''+ ' + @Actual_Values + '+'')''' + ' ' + 
COALESCE(@from,' FROM ' + CASE WHEN @owner IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@owner)) + '].' END + '[' + rtrim(@table_name) + ']' + '(NOLOCK)') 
END 
--Determining whether to ouput any debug information 
IF @debug_mode =1 
BEGIN 
PRINT '/*****START OF DEBUG INFORMATION*****' 
PRINT 'Beginning of the INSERT statement:' 
PRINT @Start_Insert 
PRINT '' 
PRINT 'The column list:' 
PRINT @Column_List 
PRINT '' 
PRINT 'The SELECT statement executed to generate the INSERTs' 
PRINT @Actual_Values 
PRINT '' 
PRINT '*****END OF DEBUG INFORMATION*****/' 
PRINT '' 
END 
PRINT '--INSERTs generated by ''sp_generate_inserts'' stored procedure written by Vyas' 
PRINT '--Build number: 22' 
PRINT '--Problems/Suggestions? Contact Vyas @ vyaskn@hotmail.com' 
PRINT '--http://vyaskn.tripod.com' 
PRINT '' 
PRINT 'SET NOCOUNT ON' 
PRINT '' 
--Determining whether to print IDENTITY_INSERT or not 
IF (@IDN <> '') 
BEGIN 
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' ON' 
PRINT 'GO' 
PRINT '' 
END 
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL) 
BEGIN 
IF @owner IS NULL 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily' 
END 
ELSE 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' NOCHECK CONSTRAINT ALL' AS '--Code to disable constraints temporarily' 
END 
PRINT 'GO' 
END 
PRINT '' 
PRINT 'PRINT ''Inserting values into ' + '[' + RTRIM(COALESCE(@target_table,@table_name)) + ']' + '''' 
--All the hard work pays off here!!! You'll get your INSERT statements, when the next line executes! 
print @Actual_Values
EXEC (@Actual_Values) 
PRINT 'PRINT ''Done''' 
PRINT '' 
IF @disable_constraints = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + @table_name, 'U') IS NOT NULL) 
BEGIN 
IF @owner IS NULL 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints' 
END 
ELSE 
BEGIN 
SELECT 'ALTER TABLE ' + QUOTENAME(@owner) + '.' + QUOTENAME(COALESCE(@target_table, @table_name)) + ' CHECK CONSTRAINT ALL' AS '--Code to enable the previously disabled constraints' 
END 
PRINT 'GO' 
END 
PRINT '' 
IF (@IDN <> '') 
BEGIN 
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@owner,USER_NAME())) + '.' + QUOTENAME(@table_name) + ' OFF' 
PRINT 'GO' 
END 
PRINT 'SET NOCOUNT OFF' 
SET NOCOUNT OFF 
RETURN 0 --Success. We are done! 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpindexes
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_monitoring
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MTFText_FileGeneration
-- --------------------------------------------------
----exec [SP_MTFText_FileGeneration]   '12-10-2021'  
CREATE Proc [dbo].[SP_MTFText_FileGeneration]    
@SAUDA_DATE Varchar(11)  
as    
begin  
  
--Declare @SAUDA_DATE Varchar(11)  
--Set @SAUDA_DATE ='dec 10 2021'  
  
DECLARE @PREVDATE VARCHAR(11),@FLAG  INT = 0,  
 @PARTY_CODE VARCHAR(10) = '' ,       
  @BATCHNO INT      
        
SELECT @BATCHNO = 0      
      
SELECT @BATCHNO = ISNULL(MAX(FLDBATCHNO),0) FROM ASIANFILEBATCHNO      
WHERE FLDFILENO = 'MT'      
AND FLDFILEDATE = @SAUDA_DATE      
/*      
     
*/      
SELECT @PREVDATE = ISNULL(MAX(SAUDA_DATE),'APR  1 2017') FROM         
TBL_PRODUCT_POSITION WHERE SAUDA_DATE < @SAUDA_DATE      
  
CREATE TABLE #REPORT      
(      
 SNO INT IDENTITY(1,1),      
 DATA VARCHAR(5000)      
)     
  
SELECT SAUDA_DATE=CONVERT(VARCHAR,ReportingDate,103),        
MEMBERCODE, SCRIP_CD, SERIES, P.PARTY_CODE,LONG_NAME,   
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN P.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),  
BODQTY,      
BODVALUE,       
FRESHBQTY=DayBuyQty,        
FRESHBUY=DayBuyValue,        
FRESHSQTY=DaySellQty,      
FRESHSELL=DaySellValue,  
NETQTY=EodQty,        
NETAMOUNT= EodValue  
INTO #NSERPT  
FROM mimansa.clientservice.dbo.MtfExchangeFileData P With(NOLOCK)   
, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), MSAJAG.DBO.OWNER         
WHERE ReportingDate = @SAUDA_DATE  
AND C.CL_CODE = P.PARTY_CODE           
AND P.PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN P.PARTY_CODE ELSE @PARTY_CODE END)   
AND (BODQTY + DayBuyQty + DaySellQty) > 0   
  
IF (SELECT ISNULL(COUNT(1),0) FROM #NSERPT ) <= 0  
BEGIN  
 SELECT * FROM #REPORT  
 RETURN  
END  
  
INSERT INTO ASIANFILEBATCHNO      
SELECT 'MT', @BATCHNO, @SAUDA_DATE, GETDATE()      
       
SET @BATCHNO = @BATCHNO + 1   
          
INSERT INTO #REPORT       
SELECT DATA = '10,MTR,' + LTRIM(RTRIM(MEMBERCODE)) + ',' +       
REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','') + ',' +      
+ RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2) + ',1,' + CONVERT(VARCHAR,COUNT(1)) +',' + CONVERT(VARCHAR,SUM(NETAMOUNT))      
FROM #NSERPT      
GROUP BY MEMBERCODE       
      
INSERT INTO #REPORT      
SELECT DATA = '30,SELF,01,' +       
CONVERT(VARCHAR,SUM(NETAMOUNT))      
FROM #NSERPT     
GROUP BY #NSERPT.MEMBERCODE     
      
      
    
         
       
      
INSERT INTO #REPORT      
SELECT DATA = '20,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' +       
LTRIM(RTRIM(PAN_GIR_NO)) + ',' + LTRIM(RTRIM(UPPER(SCRIP_CD))) +',' + LTRIM(RTRIM(UPPER(SERIES))) +',' +     
CONVERT(VARCHAR,SUM(BODQTY)) + ',' +       
CONVERT(VARCHAR,SUM(BODVALUE)) + ',' +        
CONVERT(VARCHAR,SUM(FRESHBQTY)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHBUY)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHSQTY)) + ',' +      
CONVERT(VARCHAR,SUM(FRESHSELL)) + ','  +       
CONVERT(VARCHAR,SUM(NETQTY)) + ',' +       
CONVERT(VARCHAR,SUM(BODVALUE + FRESHBUY - FRESHSELL)) + ',' +   
'N,NSE'       
FROM #NSERPT     WHERE SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)  
GROUP BY MEMBERCODE,LONG_NAME, PARTY_CODE, SCRIP_CD, SERIES, PAN_GIR_NO   
  
--select * from #REPORT  
--return  
  
CREATE INDEX #PARTY ON #NSERPT  
( PARTY_CODE)  
  
  
SELECT *, EXCHG = 'BSE' INTO #MTFCOLL  
FROM TBL_PRODUCT_HOLD_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND HOLDFLAG = 'MTFCOLL'   
  
  
create clustered index idx_isin on #MTFCOLL  
(  
 SAUDA_DATE,   
 isin  
)  
   
  
delete from #MTFCOLL  
WHERE SAUDA_DATE = @SAUDA_DATE   
and ISIN not IN (SELECT ISIN FROM TBLSCRIPMARGIN WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE and #MTFCOLL.isin = TBLSCRIPMARGIN.isin)  
  
delete from #MTFCOLL  
WHERE SAUDA_DATE = @SAUDA_DATE   
and SCRIP_CD IN ('BALMRLIN','CHEVIOT','DIL','EPCIN','PIXTRANS','WESTLIFEDE','WPIL')  
  
  
  
UPDATE #MTFCOLL SET EXCHG = 'NSE'  
FROM MSAJAG.DBO.VARDETAIL D, MSAJAG.DBO.VARCONTROL C  
WHERE RECDATE >= @SAUDA_DATE AND RECDATE <= @SAUDA_DATE + ' 23:59'  
AND D.DETAILKEY = C.DetailKey   
AND D.ISIN = #MTFCOLL.ISIN  
AND D.SCRIP_CD = #MTFCOLL.SCRIP_CD ---  
  
SELECT H.PARTY_CODE, LONG_NAME,   
PAN_GIR_NO=(CASE WHEN ISNULL(PAN_GIR_NO,'') = '' THEN H.PARTY_CODE ELSE ISNULL(PAN_GIR_NO,'') END),  
SCRIP_CD = (CASE WHEN EXCHG = 'BSE' THEN LEFT(SCRIP_CD,10) ELSE SCRIP_CD END),   
SERIES = (CASE WHEN EXCHG = 'BSE' THEN 'EQ' ELSE SERIES END),  
QTY = SUM(QTY), AMOUNT = CONVERT(NUMERIC(18,2),SUM(QTY*CL_RATE-QTY*CL_RATE*HAIRCUT/100)),  
CAT = 'N', EXCHG,  
CASHCOLL = CONVERT(NUMERIC(18,2),0)  
INTO #HOLD  
FROM #MTFCOLL H, MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK)  
WHERE SAUDA_DATE = @SAUDA_DATE   
AND   C.CL_CODE = H.PARTY_CODE  
AND   H.PARTY_CODE IN (SELECT PARTY_CODE FROM #NSERPT R   
         WHERE R.PARTY_CODE = H.PARTY_CODE)  
AND   HOLDFLAG = 'MTFCOLL' AND SCRIP_CD NOT IN (SELECT * FROM nsemtunapporved)  
--AND EXCHG = 'NSE'  
GROUP BY H.PARTY_CODE, LONG_NAME,   
PAN_GIR_NO,SCRIP_CD, SERIES,BSECODE,EXCHG  
  
SELECT PARTY_CODE, CASHCOLL=(CASE WHEN SUM(NETAMT) + MTFLEDBAL > 0   
          THEN SUM(NETAMT) + MTFLEDBAL  
          ELSE 0  
           END),  
       MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,2),0)  
INTO #COLLCASH  
FROM TBL_MTF_DATA  
WHERE SAUDA_DATE = @SAUDA_DATE  
GROUP BY PARTY_CODE, MTFLEDBAL  
  
INSERT INTO #COLLCASH  
SELECT DISTINCT PARTY_CODE, CASHCOLL = 0, MTFNONCASHCOLLATERAL = 0 FROM #HOLD  
WHERE NOT EXISTS (SELECT PARTY_CODE FROM #COLLCASH WHERE #COLLCASH.PARTY_CODE = #HOLD.PARTY_CODE)  
  
UPDATE #COLLCASH SET MTFNONCASHCOLLATERAL = NONCASH  
FROM (SELECT PARTY_CODE, NONCASH = SUM(AMOUNT)  
   FROM #HOLD  
   GROUP BY PARTY_CODE) C  
WHERE C.PARTY_CODE = #COLLCASH.PARTY_CODE  
/*  
UPDATE #HOLD SET CASHCOLL = C.CASHCOLL  
FROM #COLLCASH C  
WHERE C.PARTY_CODE = #HOLD.PARTY_CODE  
  
INSERT INTO #REPORT    
SELECT DATA = '40,'   
         + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),   
                ISNULL(SUM(CASHCOLL),0))) = '0'   
     THEN '0.00'  
     ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),   
                ISNULL(SUM(CASHCOLL),0)))  
      END)   
   + ',0.00,'   
      + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'  
     THEN '0.00'  
     ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))  
      END)  
FROM   
(  
 SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(AMOUNT)   
 FROM   #HOLD  
 GROUP BY PARTY_CODE, CASHCOLL  
) A  
*/  
          
  
INSERT INTO #REPORT    
SELECT DATA = '40,'   
         + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),   
                ISNULL(SUM(CASHCOLL),0))) = '0'   
     THEN '0.00'  
     ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),   
                ISNULL(SUM(CASHCOLL),0)))  
      END)   
   + ',0.00,'   
      + (CASE WHEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL))) = '0'  
     THEN '0.00'  
     ELSE CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),SUM(MTFNONCASHCOLLATERAL)))  
      END)  
FROM   
(  
 SELECT PARTY_CODE, CASHCOLL, MTFNONCASHCOLLATERAL = SUM(MTFNONCASHCOLLATERAL)   
 FROM   #COLLCASH  
 GROUP BY PARTY_CODE, CASHCOLL  
) A  
       
  
INSERT INTO #REPORT    
SELECT DATA = '50,' + REPLACE(LTRIM(RTRIM(LONG_NAME)),',','') + ',' + PAN_GIR_NO + ',' + SCRIP_CD + ',' + SERIES + ',' + CONVERT(VARCHAR,QTY) + ',' + CONVERT(VARCHAR,AMOUNT)  
      + ',' + CAT + ',' + EXCHG  
FROM #HOLD  
  
UPDATE #REPORT SET DATA = UPPER(DATA)  
UPDATE #REPORT SET DATA = ISNULL (DATA,'')  
  
  
   
  
INSERT INTO #REPORT  
SELECT DATA = 'I hereby confirm that my exposure towards the margin trading facility has not exceeded the borrowed funds (if any) and 50% of my networth.'  
  
SELECT FILENAME = LTRIM(RTRIM('MTR_' + REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),103),'/','')     
    + '.T' + RIGHT('00' + CONVERT(VARCHAR,@BATCHNO),2))),      
DATA = LTRIM(RTRIM(DATA))  
 FROM #REPORT   
ORDER BY SNO     
  
  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Whoisactive
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Whoisactive_all
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_Whoisactive_series
-- --------------------------------------------------
/* encrypted or not available */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TBL
-- --------------------------------------------------
    
CREATE PROC TBL @TBLNAME VARCHAR(25)AS               
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @TBLNAME + '%' AND XTYPE='U' ORDER BY NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TO_CHK
-- --------------------------------------------------

CREATE PROC [dbo].[TO_CHK]    
(    
 @REPORT_DATE VARCHAR(11)    
)    
AS    
-- EXEC TO_CHK 'JUl 23 2020'    
DECLARE @PREV_DATE VARCHAR(11)    
    
SELECT @PREV_DATE = MAX(SAUDA_DATE) FROM TBL_MTF_DATA     
WHERE SAUDA_DATE < @REPORT_DATE     
    
SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN,     
T_1_DAY_POS=SUM(T_1_DAY_POS),    
T_DAY_POS=SUM(T_DAY_POS), HAIRCUT = MAX(HAIRCUT), CURR_CL_RATE = MAX(CURR_CL_RATE),    
T_1_DAY_AMT = SUM(CASE WHEN FLAG = 2 THEN NETAMT ELSE 0 END),    
T_DAY_AMT = SUM(CASE WHEN FLAG = 1 THEN NETAMT ELSE 0 END),    
MTFLEDBAL = MAX(MTFLEDBAL),    
MTFNONCASHCOLLATERAL = MAX(MTFNONCASHCOLLATERAL) ,    
MTFCASHCOLL = CONVERT(NUMERIC(18,4),0),    
MTOM_LOSS = MAX(CURR_CL_RATE)*SUM(T_1_DAY_POS) - SUM(CASE WHEN FLAG = 2 THEN NETAMT ELSE 0 END),    
MARGIN_REQ=CONVERT(NUMERIC(18,4),0)--SUM(CASE WHEN FLAG = 2 THEN NETAMT ELSE 0 END)*MAX(HAIRCUT) / 100    
    
INTO #MARGIN_ADJUST     
FROM (     
 SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, T_1_DAY_POS = 0, T_DAY_POS = QTY,  HAIRCUT, CURR_CL_RATE, FLAG = 1,    
 NETAMT, MTOM_LOSS, MTFNONCASHCOLLATERAL, MTFLEDBAL      
 FROM TBL_MTF_DATA     
 WHERE SAUDA_DATE = @REPORT_DATE    
 --AND PARTY_CODE = '101010019'    
 UNION ALL    
 SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, T_1_DAY_POS = QTY, T_DAY_POS = 0,      
 HAIRCUT = CONVERT(NUMERIC(18,2),0), CURR_CL_RATE = CONVERT(NUMERIC(18,2),0), FLAG = 2,     
 NETAMT, MTOM_LOSS = CONVERT(NUMERIC(18,2),0), MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,2),0),    
 MTFLEDBAL  = CONVERT(NUMERIC(18,2),0)    
 FROM TBL_MTF_DATA     
 WHERE SAUDA_DATE = @PREV_DATE    
 --AND PARTY_CODE = '101010019'    
) A    
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN    
--HAVING SUM(T_1_DAY_POS) <> SUM(T_DAY_POS)    
    
UPDATE #MARGIN_ADJUST SET T_1_DAY_POS = T_DAY_POS, T_1_DAY_AMT = T_DAY_AMT    
WHERE T_1_DAY_POS > T_DAY_POS    
      
UPDATE #MARGIN_ADJUST SET     
MARGIN_REQ = (CASE WHEN T_1_DAY_AMT > CURR_CL_RATE*T_1_DAY_POS THEN CURR_CL_RATE*T_1_DAY_POS*HAIRCUT / 100 ELSE T_1_DAY_AMT*HAIRCUT / 100 END),
MTOM_LOSS=T_DAY_AMT-CURR_CL_RATE*T_DAY_POS
    
--SELECT * FROM #MARGIN_ADJUST     
--WHERE PARTY_CODE = '1001344'    
    
UPDATE #MARGIN_ADJUST SET MTFCASHCOLL = T.NETAMT    
FROM (SELECT PARTY_CODE, NETAMT = SUM(NETAMT)+MTFLEDBAL     
   FROM TBL_MTF_DATA    
   WHERE SAUDA_DATE = @REPORT_DATE    
   GROUP BY PARTY_CODE,MTFLEDBAL    
   ) T    
WHERE #MARGIN_ADJUST.PARTY_CODE = T.PARTY_CODE    

/*    
UPDATE #MARGIN_ADJUST SET MTOM_LOSS = 0     
WHERE T_1_DAY_POS = 0     
*/

ALTER TABLE #MARGIN_ADJUST    
ADD VARMARGIN NUMERIC(18,2)    
    
ALTER TABLE #MARGIN_ADJUST    
ADD ELM NUMERIC(18,2)    
    
ALTER TABLE #MARGIN_ADJUST    
ADD TDAY_MARGIN_REQ NUMERIC(18,2)    
    
UPDATE #MARGIN_ADJUST SET VARMARGIN = 0, ELM = 0, TDAY_MARGIN_REQ = 0    
    
UPDATE #MARGIN_ADJUST SET VARMARGIN = D.APPVAR, ELM = SECSPECVAR    
FROM MSAJAG.dbo.VARDETAIL D, MSAJAG.dbo.VARCONTROL C     
WHERE C.RECDATE >= @REPORT_DATE AND C.RECDATE <= @REPORT_DATE + ' 23:59'    
AND C.DETAILKEY = D.DETAILKEY     
AND D.ISIN = #MARGIN_ADJUST.ISIN     
    
UPDATE #MARGIN_ADJUST SET VARMARGIN = MARGIN, ELM = V.ELM FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V     
WHERE Fdate = @REPORT_DATE AND V.ISIN = #MARGIN_ADJUST.ISIN     
    
UPDATE #MARGIN_ADJUST SET TDAY_MARGIN_REQ = (T_DAY_AMT - T_1_DAY_AMT) * (VARMARGIN+ELM) / 100    
 
SELECT PARTY_CODE, MARGIN_REQ = SUM(MARGIN_REQ),     
MTOM_LOSS = ABS(CASE WHEN SUM(MTOM_LOSS) < 0 THEN 0 ELSE SUM(MTOM_LOSS) END),    
EXCESS_COLL = MAX(MTFNONCASHCOLLATERAL) + MAX(MTFCASHCOLL) - SUM(MARGIN_REQ) - ABS(SUM(CASE WHEN MTOM_LOSS > 0 THEN 0 ELSE MTOM_LOSS END)),    
TDAY_MARGIN_REQ = SUM(TDAY_MARGIN_REQ)    
INTO #EXCESS_FINAL FROM #MARGIN_ADJUST     
GROUP BY PARTY_CODE     
HAVING  MAX(MTFNONCASHCOLLATERAL) + MAX(MTFCASHCOLL) - SUM(MARGIN_REQ) -  ABS(CASE WHEN SUM(MTOM_LOSS) < 0 THEN 0 ELSE SUM(MTOM_LOSS) END) > 0     
     
SELECT * FROM #MARGIN_ADJUST     
WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #EXCESS_FINAL)    
--AND PARTY_CODE = '1001344'    
ORDER BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE     
    
SELECT *,CASH_MARGIN_ADJUST = CONVERT(NUMERIC(18,2),PRADNYA.DBO.FNMIN(EXCESS_COLL,PRADNYA.DBO.FNMAX(0,TDAY_MARGIN_REQ+MTOM_LOSS)))     
FROM #EXCESS_FINAL    
--WHERE PARTY_CODE = '1001344'    
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TO_CHK_2DAY
-- --------------------------------------------------
CREATE PROC [dbo].[TO_CHK_2DAY]
(
	@REPORT_DATE VARCHAR(11),
	@FLAG	INT	= 0,
	@PARTY_CODE	VARCHAR(10)=''
)
AS
-- EXEC TO_CHK_2DAY 'JUL 28 2020', 0, 'A105956'
DECLARE @PREV_DATE VARCHAR(11)

SELECT @PREV_DATE = MAX(SAUDA_DATE) FROM TBL_MTF_DATA 
WHERE SAUDA_DATE < @REPORT_DATE 
SELECT @PREV_DATE = MAX(SAUDA_DATE) FROM TBL_MTF_DATA 
WHERE SAUDA_DATE < @PREV_DATE 

SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, 
T_1_DAY_POS=SUM(T_1_DAY_POS),
T_DAY_POS=SUM(T_DAY_POS), HAIRCUT = MAX(HAIRCUT), CURR_CL_RATE = MAX(CURR_CL_RATE),
T_1_DAY_AMT = SUM(CASE WHEN FLAG = 2 THEN NETAMT ELSE 0 END),
T_DAY_AMT = SUM(CASE WHEN FLAG = 1 THEN NETAMT ELSE 0 END),
MTFLEDBAL = MAX(MTFLEDBAL),
MTFNONCASHCOLLATERAL = MAX(MTFNONCASHCOLLATERAL) ,
MTFCASHCOLL = CONVERT(NUMERIC(18,4),0),
MTOM_LOSS = MAX(CURR_CL_RATE)*SUM(T_1_DAY_POS) - SUM(CASE WHEN FLAG = 2 THEN NETAMT ELSE 0 END),
MARGIN_REQ=CONVERT(NUMERIC(18,4),0)--SUM(CASE WHEN FLAG = 2 THEN NETAMT ELSE 0 END)*MAX(HAIRCUT) / 100

INTO #MARGIN_ADJUST 
FROM ( 
	SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, T_1_DAY_POS = 0, T_DAY_POS = QTY,  HAIRCUT, CURR_CL_RATE, FLAG = 1,
	NETAMT, MTOM_LOSS, MTFNONCASHCOLLATERAL, MTFLEDBAL  
	FROM TBL_MTF_DATA 
	WHERE SAUDA_DATE = @REPORT_DATE
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)
	UNION ALL
	SELECT PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, T_1_DAY_POS = QTY, T_DAY_POS = 0,  
	HAIRCUT = CONVERT(NUMERIC(18,2),0), CURR_CL_RATE = CONVERT(NUMERIC(18,2),0), FLAG = 2, 
	NETAMT, MTOM_LOSS = CONVERT(NUMERIC(18,2),0), MTFNONCASHCOLLATERAL = CONVERT(NUMERIC(18,2),0),
	MTFLEDBAL  = CONVERT(NUMERIC(18,2),0)
	FROM TBL_MTF_DATA 
	WHERE SAUDA_DATE = @PREV_DATE
	AND PARTY_CODE = (CASE WHEN @PARTY_CODE = '' THEN PARTY_CODE ELSE @PARTY_CODE END)
) A
GROUP BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN
--HAVING SUM(T_1_DAY_POS) <> SUM(T_DAY_POS)



UPDATE #MARGIN_ADJUST SET T_1_DAY_POS = T_DAY_POS, T_1_DAY_AMT = T_DAY_AMT
WHERE T_1_DAY_POS > T_DAY_POS
	 
UPDATE #MARGIN_ADJUST SET 
MARGIN_REQ = (CASE WHEN T_1_DAY_AMT > CURR_CL_RATE*T_1_DAY_POS THEN CURR_CL_RATE*T_1_DAY_POS*HAIRCUT / 100 ELSE T_1_DAY_AMT*HAIRCUT / 100 END),
MTOM_LOSS=T_DAY_AMT-CURR_CL_RATE*T_DAY_POS

UPDATE #MARGIN_ADJUST SET MTFCASHCOLL = T.NETAMT
FROM (SELECT PARTY_CODE, NETAMT = SUM(NETAMT)+MTFLEDBAL 
	  FROM TBL_MTF_DATA
	  WHERE SAUDA_DATE = @REPORT_DATE
	  GROUP BY PARTY_CODE,MTFLEDBAL
	  ) T
WHERE #MARGIN_ADJUST.PARTY_CODE = T.PARTY_CODE
 
ALTER TABLE #MARGIN_ADJUST
ADD VARMARGIN NUMERIC(18,2)

ALTER TABLE #MARGIN_ADJUST
ADD ELM NUMERIC(18,2)

ALTER TABLE #MARGIN_ADJUST
ADD TDAY_MARGIN_REQ NUMERIC(18,2)

UPDATE #MARGIN_ADJUST SET VARMARGIN = 0, ELM = 0, TDAY_MARGIN_REQ = 0

UPDATE #MARGIN_ADJUST SET VARMARGIN = D.APPVAR, ELM = SECSPECVAR
FROM MSAJAG.dbo.VARDETAIL D, MSAJAG.dbo.VARCONTROL C 
WHERE C.RECDATE >= @REPORT_DATE AND C.RECDATE <= @REPORT_DATE + ' 23:59'
AND C.DETAILKEY = D.DETAILKEY 
AND D.ISIN = #MARGIN_ADJUST.ISIN 

UPDATE #MARGIN_ADJUST SET VARMARGIN = MARGIN, ELM = V.ELM FROM AngelBSECM.BSEDB_AB.DBO.VARDETAIL V 
WHERE FDATE = @REPORT_DATE AND V.ISIN = #MARGIN_ADJUST.ISIN 

UPDATE #MARGIN_ADJUST SET TDAY_MARGIN_REQ = (T_DAY_AMT - T_1_DAY_AMT) * (VARMARGIN+ELM) / 100

SELECT PARTY_CODE, MARGIN_REQ = SUM(MARGIN_REQ), 
MTOM_LOSS = ABS((CASE WHEN SUM(CASE WHEN TDAY_MARGIN_REQ > 0 THEN MTOM_LOSS ELSE 0 END) < 0 THEN 0 ELSE SUM(CASE WHEN TDAY_MARGIN_REQ > 0 THEN MTOM_LOSS ELSE 0 END) END)),
EXCESS_COLL = MAX(MTFNONCASHCOLLATERAL) + MAX(MTFCASHCOLL) - SUM(MARGIN_REQ) - ABS((CASE WHEN SUM(CASE WHEN TDAY_MARGIN_REQ > 0 THEN MTOM_LOSS ELSE 0 END) < 0 THEN 0 ELSE SUM(CASE WHEN TDAY_MARGIN_REQ > 0 THEN MTOM_LOSS ELSE 0 END) END)),
TDAY_MARGIN_REQ = SUM(TDAY_MARGIN_REQ)
INTO #EXCESS_FINAL FROM #MARGIN_ADJUST 
GROUP BY PARTY_CODE 
HAVING  MAX(MTFNONCASHCOLLATERAL) + MAX(MTFCASHCOLL) - SUM(MARGIN_REQ) - ABS(SUM(CASE WHEN MTOM_LOSS > 0 THEN 0 ELSE MTOM_LOSS END)) > 0 

IF @FLAG = 0 
BEGIN
	SELECT * FROM #MARGIN_ADJUST 
	WHERE PARTY_CODE IN (SELECT PARTY_CODE FROM #EXCESS_FINAL)
	--AND PARTY_CODE = 'A105956' 
	ORDER BY PARTY_CODE, SCRIP_CD, SERIES, BSECODE 
END

SELECT *,CASH_MARGIN_ADJUST = CONVERT(NUMERIC(18,2),PRADNYA.DBO.FNMIN(EXCESS_COLL,PRADNYA.DBO.FNMAX(0,TDAY_MARGIN_REQ+MTOM_LOSS))) 
FROM #EXCESS_FINAL
--WHERE PARTY_CODE = 'A105956' 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TOCHECK
-- --------------------------------------------------

CREATE PROC [DBO].[TOCHECK] 
(
	@SAUDA_DATE	VARCHAR(11)
)
AS

SELECT *, NSEHOLD=0, BSEHOLD=0 
INTO #DATA
FROM (
SELECT
PARTY_CODE, SCRIP_CD, SERIES, BSECODE, ISIN, NSEPOSQTY, BSEPOSQTY, DIFFQTY,
ADJNSE = (CASE WHEN NSEPOOLQTY > ABS(DIFFQTY) THEN ABS(DIFFQTY) ELSE NSEPOOLQTY END),
ADJBSE = (CASE WHEN BSEPOOLQTY > ABS(DIFFQTY)-(CASE WHEN NSEPOOLQTY > ABS(DIFFQTY) THEN ABS(DIFFQTY) ELSE NSEPOOLQTY END) 
			   THEN ABS(DIFFQTY)-(CASE WHEN NSEPOOLQTY > ABS(DIFFQTY) THEN ABS(DIFFQTY) ELSE NSEPOOLQTY END) 
			   ELSE BSEPOOLQTY 
		  END)
FROM TBL_MTF_RECO
WHERE SAUDA_DATE = @SAUDA_DATE 
AND DIFFQTY <> 0 ) A
/*
UPDATE #DATA SET NSEHOLD = D.QTY 
FROM (SELECT PARTY_CODE, CERTNO, QTY = SUM(QTY) FROM 
	ANGELDEMAT.MSAJAG.DBO.DELTRANS D, ANGELDEMAT.MSAJAG.DBO.DELIVERYDP DP
	WHERE D.BDPTYPE = DP.DPTYPE AND D.BDPID = DP.DPID 
	AND D.BCLTDPID = DP.DPCLTNO
	AND DRCR = 'D' AND FILLER2 = 1 
	AND DELIVERED = '0' and TrType not in (907,1000)
	AND ACCOUNTTYPE = 'BEN' AND EXCHANGE <> 'MTF'
	GROUP BY PARTY_CODE, CERTNO) D
WHERE #DATA.PARTY_CODE = D.Party_Code 
AND #DATA.ISIN = D.CertNo

UPDATE #DATA SET BSEHOLD = D.QTY 
FROM (SELECT PARTY_CODE, CERTNO, QTY = SUM(QTY) FROM 
	ANGELDEMAT.BSEDB.DBO.DELTRANS D, ANGELDEMAT.BSEDB.DBO.DELIVERYDP DP
	WHERE D.BDPTYPE = DP.DPTYPE AND D.BDPID = DP.DPID 
	AND D.BCLTDPID = DP.DPCLTNO
	AND DRCR = 'D' AND FILLER2 = 1 
	AND DELIVERED = '0' and TrType not in (907,1000)
	AND ACCOUNTTYPE = 'BEN' AND EXCHANGE <> 'MTF'
	GROUP BY PARTY_CODE, CERTNO) D
WHERE #DATA.PARTY_CODE = D.Party_Code 
AND #DATA.ISIN = D.CertNo
		
*/
SELECT * FROM #DATA
where diffqty < 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTF_CTD_File_Generation
-- --------------------------------------------------
  
CREATE procedure [dbo].[USP_MTF_CTD_File_Generation]                 
as                    
BEGIN                    
 SET NOCOUNT ON         
BEGIN TRY        
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                                
  SELECT @emailto='paresh.natekar@angelbroking.com;darshit.kapadia@angelbroking.com;swapnils.tadge@angelbroking.com;csorm@angelbroking.com;Vishal@angelbroking.com;tushar.jorigal@angelbroking.com;anil.wandre@angelone.in;dashrath.mane@angelone.in;sushant.khandekar@angelone.in;himanshu.patil@angelone.in'       
  select @emailcc=''--'rahulc.shah@angelbroking.com'      
   select @emailbcc='neha.naiwar@angelbroking.com;pramod.jadhav@angelbroking.com'          
  
  truncate table tbl_MTF_CTD_file
select * into #final_party_MTF from mtf_ctd with(nolock)  where CAST(request_date as date)=CAST(GETDATE() as date)
and isnull(batchtime,'')='' and isfilegenerated=0
        
select a.party_code,c.scrip_cd as scrip,c.series,a.ISIN,a.qty,'12033200' as sourceDP,'1203320030135829' as Clientdp,b.bankid,b.cltdpid,  
'BTC' as cl_type  
 into #file_MTF from #final_party_MTF a 
left join ANGELDEMAT.msajag.dbo.multiisin c with(nolock) on a.isin=c.isin
left join  
msajag.dbo.client4 b with(nolock)  on a.party_code=b.cl_code   
 where  defdp=1 and Depository='CDSL'  
 
 insert into tbl_MTF_CTD_file
 SELECT  party_code,scrip,series,ISIN,qty as releasedQty,sourceDP,Clientdp,bankid,cltdpid,cl_type  from #file_MTF        
  
 if(select COUNT(1) from tbl_MTF_CTD_file)>0
 begin
    DECLARE @s VARCHAR(MAX) = ''                                        
   declare @FileName as varchar(100) = 'MTF_CTD'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                               
      declare @FilePath varchar(200) ='' /* '\\196.1.115.183\d$\upload\CMS_Test\'+@FileName  */                       
      select @FilePath='\\INHOUSELIVEAPP1-FS.angelone.in\upload1\'+@FileName          
                                     
      SET @s = 'exec MASTER.dbo.xp_cmdshell ' + ''''                                         
      SET @s = @s + 'bcp "select * from mtftrade.dbo.tbl_MTF_CTD_file" queryout '+ @FilePath + ' -c -t, -SABVSNSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                          
       
     
           
      SET @s = @s + ''''            
      EXEC(@s)   
          
                                       
SET @MESS='Dear All,<br><Br>Good Evening!!!<br><Br>Please refer the attached file for MTF CTD File.<Br><Br>'                                        
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(In-house system)'                                    
set @sub ='MTF Convert to Delivery(CTD) Release File'                       
                        
                          
 DECLARE @s1 varchar(500)                        
 SET @s1 = @FilePath                 
                          
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                    
 @RECIPIENTS =@emailto,                                    
 @COPY_RECIPIENTS = @emailcc,                                    
 @blind_copy_recipients=@emailbcc,                          
 @PROFILE_NAME = 'AngelBroking',                                    
 @BODY_FORMAT ='HTML',                                    
 @SUBJECT = @sub ,                                    
 @FILE_ATTACHMENTS =@s1,                                    
 @BODY =@MESS                            
 End           
  drop table #final_party_MTF  
  drop table #file_MTF 

--update mtf_ctd set batchtime=GETDATE(),isfilegenerated=1 where CAST(request_date as date)=CAST(GETDATE() as date)

update a set batchtime=GETDATE(),isfilegenerated=1 from mtf_ctd a join tbl_MTF_CTD_file b on a.party_code=b.party_code and
a.isin=b.ISIN  where CAST(request_date as date)=CAST(GETDATE() as date)

  END TRY                                    
BEGIN CATCH                                    
                                                                                               
  insert into Appln_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                
  select GETDATE(),'USP_MTF_CTD_File_Generation',ERROR_LINE(),ERROR_MESSAGE()                                                                
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                       
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                            
  RAISERROR (@ErrorMessage , 16, 1);                                                                                          
                                    
END CATCH                 
 SET NOCOUNT OFF;                   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MTF_ExceptionPartycode_File
-- --------------------------------------------------
    
CREATE procedure [dbo].[USP_MTF_ExceptionPartycode_File]                   
as                      
BEGIN                      
 SET NOCOUNT ON           
BEGIN TRY          
DECLARE @MESS AS VARCHAR(4000),@emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(100)                                  
  SELECT @emailto='rohan.shah@angelbroking.com;rahulc.shah@angelbroking.com;paresh.natekar@angelbroking.com'         
  select @emailcc=''--'rahulc.shah@angelbroking.com'        
   select @emailbcc='neha.naiwar@angelbroking.com;pramod.jadhav@angelbroking.com'            
    
  
select distinct * into ##party from mtf_ctd_exception with(nolock)   where CAST(request_date as date)=CAST(GETDATE() as date)         
    
 if(select COUNT(1) from ##party)>0  
 begin  
    DECLARE @s VARCHAR(MAX) = ''                                          
   declare @FileName as varchar(100) = 'Exception_Partycode'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                                                 
      declare @FilePath varchar(200) ='' /* '\\196.1.115.183\d$\upload\CMS_Test\'+@FileName  */                         
      select @FilePath='\\INHOUSELIVEAPP1-FS.angelone.in\upload1\'+@FileName            
                                       
      SET @s = 'exec MASTER.dbo.xp_cmdshell ' + ''''                                           
      SET @s = @s + 'bcp "select * from ##party" queryout '+ @FilePath + ' -c -t, -SABVSNSECM.angelone.in -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                                                                                            
         
       
             
      SET @s = @s + ''''              
      EXEC(@s)     
            
                                         
SET @MESS='Dear All,<br><Br>Good Evening!!!<br><Br>Please refer the attached file of exception clients.<Br><Br>'                                          
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(In-house system)'                                      
set @sub ='Exception Clients of MTF CTD'                         
                          
                            
 DECLARE @s1 varchar(500)                          
 SET @s1 = @FilePath                   
                            
 EXEC MSDB.DBO.SP_SEND_DBMAIL                                      
 @RECIPIENTS =@emailto,                                      
 @COPY_RECIPIENTS = @emailcc,                                      
 @blind_copy_recipients=@emailbcc,                            
 @PROFILE_NAME = 'AngelBroking',                                      
 @BODY_FORMAT ='HTML',                                      
 @SUBJECT = @sub ,                                      
 @FILE_ATTACHMENTS =@s1,                                      
 @BODY =@MESS                              
 End             
  drop table ##party    
  
  END TRY                                      
BEGIN CATCH                                      
                                                                                                 
  insert into Appln_ERROR(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                  
  select GETDATE(),'USP_MTF_CTD_File_Generation',ERROR_LINE(),ERROR_MESSAGE()                                                                  
                            
  DECLARE @ErrorMessage NVARCHAR(4000);                         
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
  RAISERROR (@ErrorMessage , 16, 1);                                                                                            
                                      
END CATCH                   
 SET NOCOUNT OFF;                     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_JVDRCRUPLOAD_RND
-- --------------------------------------------------
CREATE PROC [dbo].[V2_OFFLINE_JVDRCRUPLOAD_RND](                    
                    
  @UNAME     VARCHAR(25),                    
  @USERCAT   INT,                    
  @EXCHANGE  VARCHAR(3),                    
  @SEGMENT   VARCHAR(10),                    
  @IP_VDATE  VARCHAR(11),                    
  @RECOFLAG  CHAR(1) = 'N',                    
  @VTYP   SMALLINT                    
)                    
AS                    
set XACT_ABORT          on              
  SET NOCOUNT ON                   
/*                
begin tran                
exec V2_OFFLINE_JVDRCRUPLOAD_RND 'OFFLINE',1,'NSE','CAPITAL','oct 20 2010','N',8                
rollback                
SELECT TOP 1* FROM LEDGER2            
*/                 
                    
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                    
  DECLARE  @@STD_DATE        VARCHAR(11),                    
           @@LST_DATE        VARCHAR(11),                    
           @@BRANCHFLAG       AS TINYINT,                    
           @@VNOFLAG          AS TINYINT,                    
           @@VNOMETHOD       INT,                    
           @@ACNAME          CHAR(100),                    
           @@BOOKTYPE        CHAR(2),                    
           @@MICRNO          VARCHAR(10),                    
           @@DRCR            VARCHAR(1),                    
           @@VTYP            SMALLINT,                    
           @@BANK_CODE       VARCHAR(100),                    
           @@BACKDAYS        INT,                    
           @@BACKDATE        VARCHAR(11),                    
           @@BRNCOUNT        TINYINT,                    
           @@MonthlyVdt      VARCHAR(11),                    
           @@SERIAL_NO       INT,                    
           @@COSTCODECOUNT   TINYINT,                    
           @@COSTCODEUPDATES CURSOR,                    
           @@NEWVNO           AS VARCHAR(12),                    
           @@MAXCOUNT         AS INT,                    
           @@VDT              AS VARCHAR(11),                    
           @@BANKBRANCH       AS VARCHAR(10),                    
           @@BANKCOST         AS NUMERIC,                    
           @@LNOCUR           AS CURSOR,                    
           @@VNOCUR           AS CURSOR,                    
           @@LNOVNO           AS VARCHAR(12),                    
     @@FLD_AUTO    AS INT,                    
           @@MAXVNO           AS INT,                    
           @@L2CUR            AS CURSOR,                    
           @@L2VNO            AS VARCHAR(12),                    
           @@ERROR_COUNT      AS BIGINT,                    
           @@FILEEXISTS       AS INT,                    
           @@SQL              AS VARCHAR(2000),                    
           @ERRORCODE         AS INT,                    
           @MESSAGE           AS VARCHAR(200),                     
     @@VOUCHERNO    AS VARCHAR(12),                    
     @@SQLPARA    AS VARCHAR(5000),                        
     @@RECPAYTBLCOUNT BIGINT,                    
     @@ACCOUNTDB VARCHAR(20),                    
     @@SHAREDB VARCHAR(20),                       
     @@ACCOUNTSVR VARCHAR(20)                    
                    
                    
                    
 SET @@VTYP = @VTYP                    
 SET @@BOOKTYPE = '01'                     
          
                    
 SELECT  @@ACCOUNTSVR = ACCOUNTSERVER                    
 FROM PRADNYA.DBO.MULTICOMPANY (NOLOCK) WHERE PRIMARYSERVER = 1 AND EXCHANGE = @EXCHANGE                     
 AND SEGMENT = @SEGMENT ORDER BY EXCHANGE                     
                    
  BEGIN TRAN                    
  CREATE TABLE [#RECPAY_TABLE] (                    
    SERIAL_NO    INT   IDENTITY ( 1,1 ),                    
    SNO INT,                  
    EDATE        VARCHAR(20),                    
    VOUCHER_DATE VARCHAR(20),                    
    CLIENT_CODE  VARCHAR(50),                    
    AMOUNT       MONEY,                    
    DRCR         VARCHAR(1),                    
    NARRATION    VARCHAR(234),                    
    BANK_CODE    VARCHAR(10),                    
    BANK_NAME    VARCHAR(100),                    
    REF_NO       VARCHAR(15),                    
    BRANCHCODE   VARCHAR(20),                    
    BRANCH_NAME  VARCHAR(50),                  
    CHQ_MODE     VARCHAR(1),                    
    CHQ_DATE     VARCHAR(20),                    
    CHQ_NAME     VARCHAR(100),                    
    CL_MODE      VARCHAR(1),               
    FLD_AUTO     BIGINT,                    
    ENTEREDBY    VARCHAR(25),                    
    VDT          DATETIME   NULL,                    
    FYSTART      DATETIME   NULL,                    
    FYEND        DATETIME   NULL,                    
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                    
    EDT          DATETIME   NULL,                    
    DDDT         DATETIME   NULL,                    
    VNO          VARCHAR(12)   NULL,                    
    VTYP         SMALLINT   NULL,                    
    ACNAME       VARCHAR(100)   NULL,                    
    COSTCODE     SMALLINT   NULL,                    
    BANKCOST     SMALLINT   NULL,                  LNO          SMALLINT   NOT NULL   DEFAULT (0),                    
    BANKNAME     VARCHAR(100)   NULL,                    
    MICRNO       INT   NULL,                    
    BOOKTYPE     VARCHAR(2)   NULL,                    
    ACC_NO       VARCHAR(16),                    
 VOUCHERNO    VARCHAR(12)   NULL,            
 SRNO TINYINT )                  
  ON [PRIMARY]                    
                    
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                    
                    
                    
/*SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "                    
SET @@SQLPARA = @@SQLPARA + "              (SNO,EDATE, "                    
SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "                    
SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "                    
SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "                    
SET @@SQLPARA = @@SQLPARA + "          DRCR, "                    
SET @@SQLPARA = @@SQLPARA + "              NARRATION, "                    
SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "                    
SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "                    
SET @@SQLPARA = @@SQLPARA + "              REF_NO, "                    
SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "                    
SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "                    
SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "                    
SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "                    
SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "                    
SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "                    
SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "                    
SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "                    
SET @@SQLPARA = @@SQLPARA + "              VDT, "                    
SET @@SQLPARA = @@SQLPARA + "              EDT, "                    
SET @@SQLPARA = @@SQLPARA + "              DDDT, "                    
SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO) "                    
SET @@SQLPARA = @@SQLPARA + "  SELECT o.SNO,CONVERT(VARCHAR,EDATE,103), "                    
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE,103), "                    
SET @@SQLPARA = @@SQLPARA + "         O.CLTCODE, "                    
SET @@SQLPARA = @@SQLPARA + "         AMOUNT = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN O.DEBITAMT ELSE O.CREDITAMT END ELSE CASE WHEN CC.CREDITAMT = '' THEN CC.DEBITAMT ELSE CC.CREDITAMT END END) , "            
  
   
      
         
SET @@SQLPARA = @@SQLPARA + "         DRCR = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN 'D' ELSE 'C' END ELSE CASE WHEN CC.CREDITAMT = '' THEN 'D' ELSE 'C' END END), "                    
SET @@SQLPARA = @@SQLPARA + "         NARRATION, "                    
SET @@SQLPARA = @@SQLPARA + "         OPPCODE, "                    
SET @@SQLPARA = @@SQLPARA + "         OPPCODENAME, "                    
SET @@SQLPARA = @@SQLPARA + "         DDNO, "                    
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CASE WHEN CC.COSTCODE IS NOT NULL THEN CC.COSTCODE ELSE 'ALL' END), "                    
SET @@SQLPARA = @@SQLPARA + "         'ALL', "                    
SET @@SQLPARA = @@SQLPARA + "        CHEQUEMODE, "                    
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CHEQUEDATE,103), "                    
SET @@SQLPARA = @@SQLPARA + "         CHEQUENAME, "              SET @@SQLPARA = @@SQLPARA + "         CLEAR_MODE, "                    
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,O.FLDAUTO), "                     
SET @@SQLPARA = @@SQLPARA + "         O.ADDBY, "                    
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE), "                    
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,EDATE), "                    
SET @@SQLPARA = @@SQLPARA + "         CHEQUEDATE, "                    
SET @@SQLPARA = @@SQLPARA + "        TPACCOUNTNUMBER, CONVERT(VARCHAR,VOUCHERTYPE),VOUCHERNO "                    
IF @@ACCOUNTSVR <> @@SERVERNAME                    
 BEGIN                     
SET @@SQLPARA = @@SQLPARA + "  FROM   " + @@ACCOUNTSVR + ".ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "                    
SET @@SQLPARA = @@SQLPARA + "   LEFT OUTER JOIN "+ @@ACCOUNTSVR +".ACCOUNT.DBO.V2_OFFLINE_CC_ENTRIES CC "                    
SET @@SQLPARA = @@SQLPARA + "   ON "                    
SET @@SQLPARA = @@SQLPARA + "    O.FLDAUTO = CC.VOLE_REFNO "                    
END                    
ELSE                    
 BEGIN                    
SET @@SQLPARA = @@SQLPARA + " FROM   ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "                    
SET @@SQLPARA = @@SQLPARA + "   LEFT OUTER JOIN ACCOUNT.DBO.V2_OFFLINE_CC_ENTRIES CC "                    
SET @@SQLPARA = @@SQLPARA + "   ON "                    
SET @@SQLPARA = @@SQLPARA + "     O.FLDAUTO = CC.VOLE_REFNO "                    
END                    
SET @@SQLPARA = @@SQLPARA + "  WHERE  CONVERT(VARCHAR,VOUCHERTYPE) = '"+CONVERT(VARCHAR,@@VTYP)+"' "                     
SET @@SQLPARA = @@SQLPARA + "         AND EXCHANGE = '"+@EXCHANGE+"' "                    
SET @@SQLPARA = @@SQLPARA + "         AND SEGMENT = '"+@SEGMENT+"' "                    
SET @@SQLPARA = @@SQLPARA + "         AND CONVERT(VARCHAR,ISNULL(ROWSTATE,0)) = '0' "                    
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,VDATE) LIKE '"+@IP_VDATE+"' + '%' "                    
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,APPROVALFLAG) = '1' "                    
                    
EXEC(@@SQLPARA)   */            
            
 SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "                    
 SET @@SQLPARA = @@SQLPARA + "              (SNO,EDATE, "                    
 SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "                    
 SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "                    
 SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "                    
 SET @@SQLPARA = @@SQLPARA + "      DRCR, "                    
 SET @@SQLPARA = @@SQLPARA + "              NARRATION, "                    
 SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "                    
 SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "                    
 SET @@SQLPARA = @@SQLPARA + "              REF_NO, "                    
 SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "                    
 SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "                    
 SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "                    
 SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "                    
 SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "                    
 SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "                    
 SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "                    
 SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "                    
 SET @@SQLPARA = @@SQLPARA + "              VDT, "                    
 SET @@SQLPARA = @@SQLPARA + "              EDT, "                    
 SET @@SQLPARA = @@SQLPARA + "              DDDT, "                    
 SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO,SRNO) "             
 IF @@ACCOUNTSVR <> 'AngelBSECM'                    
  BEGIN                     
  SET @@SQLPARA = @@SQLPARA + "  EXEC AngelBSECM.ACCOUNT_AB.DBO.V2_OFFLINE_FILL_REC "+CONVERT(VARCHAR,@@VTYP)+",'"+@EXCHANGE+"', '"+@SEGMENT+"', '"+@IP_VDATE+"' "                
  END                    
 ELSE                    
  BEGIN                    
  SET @@SQLPARA = @@SQLPARA + " EXEC V2_OFFLINE_FILL_REC "+CONVERT(VARCHAR,@@VTYP)+",'"+@EXCHANGE+"', '"+@SEGMENT+"', '"+@IP_VDATE+"' "            
  END            
 PRINT @@SQLPARA            
 EXEC(@@SQLPARA)             
           
 SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                    
                    
 IF @@RECPAYTBLCOUNT = 0                    
 BEGIN                    
  COMMIT                    
  RETURN                    
 END                    
              
                    
                    
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                    
  FROM   #RECPAY_TABLE                    
                    
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                    
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                    
         @@BRANCHFLAG = BRANCHFLAG,                    
         @@VNOFLAG = VNOFLAG                    
  FROM   PARAMETER WITH(NOLOCK)                    
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                    
                    
  IF @@VNOFLAG <> 0                    
    BEGIN                    
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                    
      FROM   #RECPAY_TABLE                    
                    
      IF @@ERROR_COUNT > 1                    
        BEGIN                    
     DROP TABLE #RECPAY_TABLE                    
     ROLLBACK TRANSACTION                    
     SET @ERRORCODE = 1                    
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                    
     EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                    
     RETURN                    
        END                    
    END                    
                    
  IF @@BRANCHFLAG = 1                    
    BEGIN                    
   UPDATE #RECPAY_TABLE                    
      SET    BRANCHCODE = A.BRANCHCODE,                    
             FYSTART = P.SDTCUR,                    
             FYEND = P.LDTCUR,                    
             UPDFLAG = 'Y',                    
             ACNAME = A.LONGNAME,                    
             COSTCODE = C.COSTCODE,                    
             BANKNAME = '',                    
             BOOKTYPE = '01',                    
             MICRNO = '0'                    
      FROM   ACMAST A WITH(NOLOCK),                    
             PARAMETER P WITH(NOLOCK),                    
             COSTMAST C WITH(NOLOCK)                    
      WHERE  A.CLTCODE = CLIENT_CODE                    
             AND P.CURYEAR = 1                    
             AND A.ACCAT IN ('3','4','18')                    
             AND A.BRANCHCODE = COSTNAME                    
                    
   UPDATE #RECPAY_TABLE                    
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
        DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                    
             FYSTART = P.SDTCUR,                    
             FYEND = P.LDTCUR,                    
             UPDFLAG = 'Y',                    
             ACNAME = A.LONGNAME,                    
             COSTCODE = (SELECT TOP 1 COSTCODE                    
                         FROM   COSTMAST                
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                    
       BANKNAME = '',                    
             BOOKTYPE = '01',                    
             MICRNO = '0'                    
      FROM   ACMAST A WITH(NOLOCK),                    
             PARAMETER P WITH(NOLOCK)                    
      WHERE  A.CLTCODE = CLIENT_CODE                    
             AND P.CURYEAR = 1                    
             AND A.ACCAT IN ('3','4','18')                    
             AND A.BRANCHCODE = 'ALL'                    
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                    
                    
      UPDATE #RECPAY_TABLE                    
      SET    BRANCHCODE = 'HO',                    
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                    
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                    
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                    
             FYSTART = P.SDTCUR,                    
             FYEND = P.LDTCUR,                    
             UPDFLAG = 'Y',                    
             ACNAME = A.LONGNAME,                    
             COSTCODE = (SELECT TOP 1 COSTCODE                    
                         FROM   COSTMAST                    
             WHERE  COSTNAME = 'HO'),                    
             BANKNAME = '',                    
             BOOKTYPE = '01',                    
             MICRNO = ''                    
      FROM   ACMAST A WITH(NOLOCK),                    
             PARAMETER P WITH(NOLOCK)                    
      WHERE  A.CLTCODE = CLIENT_CODE                    
             AND P.CURYEAR = 1                    
             AND A.ACCAT IN ('3','4','18')                    
             AND A.BRANCHCODE = 'ALL'                    
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                    
    END                    
 ELSE                    
    BEGIN                    
      UPDATE #RECPAY_TABLE                    
      SET    FYSTART = @@STD_DATE,                    
             FYEND = @@LST_DATE + ' 23:59:59',                    
             UPDFLAG = 'Y',                    
             ACNAME = A.LONGNAME,                    
             BANKNAME = '',                    
             BOOKTYPE = '01',                    
             MICRNO = ''                    
      FROM   ACMAST A WITH(NOLOCK)                    
      WHERE  A.CLTCODE = CLIENT_CODE                 
             AND A.ACCAT IN ('3','4','18')                    
                    
    END                    
            
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                    
  SELECT @@ERROR_COUNT = COUNT(SERIAL_NO)                    
  FROM   #RECPAY_TABLE                    
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                    
                    
  IF @@ERROR_COUNT > 0                    
    BEGIN                    
    DROP TABLE #RECPAY_TABLE                    
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                    
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                    
    RETURN                    
    END                    
                    
  SET @@ERROR_COUNT = 0                    
                    
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                    
  SELECT @@ERROR_COUNT = COUNT(1)                    
  FROM   #RECPAY_TABLE                    
  WHERE  VDT > EDT                    
                    
  IF @@ERROR_COUNT > 0                    
    BEGIN                    
    DROP TABLE #RECPAY_TABLE                    
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                    
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                    
    RETURN                    
    END                    
                    
/*-----------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ----*/                     
   SELECT @@ERROR_COUNT = COUNT(1) FROM                    
 (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)                    
 FROM #RECPAY_TABLE                    
 HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A                    
                    
 IF @@ERROR_COUNT > 0                    
   BEGIN                    
   DROP TABLE #RECPAY_TABLE                    
   ROLLBACK TRAN                    
SET @ERRORCODE = 1                    
   SET @MESSAGE ='DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'                    
      EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                    
      RETURN                    
      END                            
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                    
  SELECT @@ERROR_COUNT = COUNT(1)                    
  FROM   (SELECT DISTINCT CLIENT_CODE                    
          FROM   #RECPAY_TABLE                    
          WHERE  UPDFLAG = 'N') A                    
                    
  IF @@ERROR_COUNT > 0                    
    BEGIN                    
    DROP TABLE #RECPAY_TABLE                    
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                    
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                    
    RETURN                    
    END                    
                    
  /*----------AUTO GENERATION OF VNO -------- */                    
 CREATE TABLE                      
    #BANK_VNO                      
    (                      
     VOUCHERNO VARCHAR(12),                  
  SNO INT,                      
     NEWSRNO INT IDENTITY (1, 1)                      
    )                      
                      
   INSERT INTO                      
    #BANK_VNO                      
   SELECT                      
    DISTINCT VOUCHERNO,SNO                      
   FROM                      
    #RECPAY_TABLE         
     ORDER BY          
   VOUCHERNO, SNO                       
                         
   SELECT TOP 1                      
    @@VDT = VDT                      
   FROM           
    #RECPAY_TABLE                      
                      
   SELECT                      
    @@STD_DATE = LEFT(SDTCUR, 11),                      
    @@LST_DATE = LEFT(LDTCUR, 11),                      
    @@VNOMETHOD = VNOFLAG                      
   FROM                      
    PARAMETER                      
   WHERE                      
    @@VDT BETWEEN SDTCUR AND LDTCUR                      
                      
   SELECT                      
    @@MAXCOUNT = COUNT(DISTINCT VOUCHERNO)                      
   FROM                      
    #RECPAY_TABLE                      
                      
   SELECT                      
    LASTVNO                      
   INTO #VNO                      
   FROM                      
    LASTVNO                      
   WHERE                      
    1 = 2                      
                      
   SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                      
                      
   INSERT INTO                      
    #VNO                      
   EXEC                       
    ACC_GENVNO_NEW                      
     @@VDT,                     
     @@VTYP,                      
     @@BOOKTYPE,                      
     @@STD_DATE,                      
     @@LST_DATE,                      
     @@MAXVNO                      
                      
   SELECT                      
    @@NEWVNO = LASTVNO                      
   FROM                      
    #VNO                      
                            
   UPDATE                      
    RP                      
   SET                       
    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))             
   FROM                      
    #RECPAY_TABLE RP,                      
    #BANK_VNO BV                      
   WHERE                      
      RP.VOUCHERNO = BV.VOUCHERNO                   
   AND RP.SNO = BV.SNO             
          
          
            
                 
   DROP TABLE #VNO                      
   DROP TABLE #BANK_VNO                         
                     
/* '-----------AUTO GENERATION OF LNO --------------*/                    
--bhrt               
            
UPDATE #RECPAY_TABLE SET LNO = LNO + (SELECT SUM(SRNO) FROM #RECPAY_TABLE L1           
WHERE #RECPAY_TABLE.VNO = L1.VNO AND #RECPAY_TABLE.SERIAL_NO <= L1.SERIAL_NO)           
          
             
                
  /*CREATE TABLE [#RECPAY_TABLE_LNO]                    
 (                    
  SNO VARCHAR(12) ,                    
  FLD_AUTO INT,                    
  LNO INT IDENTITY (1, 1) NOT NULL                    
 ) ON [PRIMARY]                    
           
 SET @@LNOCUR = CURSOR FOR                    
  SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE                    
 OPEN @@LNOCUR                    
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO                    
 WHILE @@FETCH_STATUS = 0                    
  BEGIN                    
                    
   INSERT INTO #RECPAY_TABLE_LNO                    
    (SNO, FLD_AUTO)                    
   SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE WHERE VOUCHERNO = @@LNOVNO                    
   UPDATE RP                    
    SET LNO = RL.LNO                    
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL                    
   WHERE RP.VOUCHERNO = RL.SNO AND RP.FLD_AUTO = RL.FLD_AUTO                    
   TRUNCATE TABLE #RECPAY_TABLE_LNO                    
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO                    
  END                    
 CLOSE @@LNOCUR                    
 DEALLOCATE @@LNOCUR                    
 DROP TABLE #RECPAY_TABLE_LNO     */               
                    
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                    
  CREATE TABLE #LEDGER (                    
    VTYP      SMALLINT,                    
    VNO       VARCHAR(12),                    
    EDT       DATETIME,                    
    LNO       SMALLINT,                    
    ACNAME    VARCHAR(100),                    
    DRCR      VARCHAR(1),                    
    VAMT      MONEY,                    
    VDT       DATETIME,                    
    VNO1      VARCHAR(12),                    
    REFNO     CHAR(12),                    
    BALAMT    MONEY,                    
    NODAYS    INT,                    
    CDT       DATETIME,                    
    CLTCODE   VARCHAR(10),                    
    BOOKTYPE  VARCHAR(2),                    
    ENTEREDBY VARCHAR(25),                    
    PDT       DATETIME,                    
    CHECKEDBY VARCHAR(25),                    
    ACTNODAYS INT,                    
    NARRATION VARCHAR(234),                 
      BRANCHCODE VARCHAR(10))          
                  
/*======CLIENT SIDE RECORD======*/            
          
                  
  INSERT INTO #LEDGER                    
             (VTYP,                    
              VNO,                    
              EDT,                    
              LNO,                    
              ACNAME,                    
              DRCR,                    
   VAMT,                
              VDT,                    
              VNO1,                    
              REFNO,                    
              BALAMT,                    
              NODAYS,                    
              CDT,                    
              CLTCODE,                    
              BOOKTYPE,                    
              ENTEREDBY,                    
              PDT,                    
              CHECKEDBY,                    
              ACTNODAYS,                    
              NARRATION,                   
 BRANCHCODE)        
  SELECT VTYP,                    
         VNO,                    
         EDT = (CASE                    
                  WHEN VTYP = @@VTYP       
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                    
                 ELSE EDT                    
                END),                    
         LNO,                    
         ACNAME,                    
         DRCR,                    
         VAMT = SUM(AMOUNT),                    
         VDT,                    
         VNO1 = VNO,                    
         REFNO = 0,                    
         BALAMT = SUM(AMOUNT),                    
         NODAYS = 0,                    
         CDT = GETDATE(),                    
         CLTCODE = CLIENT_CODE,                    
      BOOKTYPE = BOOKTYPE,                    
         ENTEREDBY = ENTEREDBY,                    
         PDT = GETDATE(),                    
         CHECKEDBY = @UNAME,                    
         ACTNODAYS = 0,                    
         NARRATION ,                   
BRANCHCODE         
  FROM   #RECPAY_TABLE                    
  GROUP BY                    
   VTYP,                    
      VNO,                    
         (CASE                    
                  WHEN VTYP = @@VTYP                    
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                    
                  ELSE EDT                    
                END),                    
         LNO,                    
         ACNAME,                    
         DRCR,                    
         VDT,                    
         CLIENT_CODE,                    
         BOOKTYPE,                    
         ENTEREDBY,                    
         NARRATION ,                   
               BRANCHCODE        
                    
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                    
  INSERT INTO LEDGER                    
 (VTYP,                    
              VNO,                    
              EDT,                    
              LNO,                    
              ACNAME,                    
              DRCR,                    
              VAMT,                    
              VDT,                    
              VNO1,                    
              REFNO,                    
              BALAMT,                    
              NODAYS,                    
              CDT,                    
              CLTCODE,                    
              BOOKTYPE,                    
              ENTEREDBY,                    
              PDT,                    
              CHECKEDBY,                    
              ACTNODAYS,                    
              NARRATION)                    
  SELECT   VTYP,                    
           VNO,                    
     EDT,                    
           LNO,           
           ACNAME,                    
           DRCR,                    
           VAMT,                    
           VDT,                    
           VNO1,                    
          REFNO,                    
           BALAMT,                    
           NODAYS,                    
           CDT,                    
           CLTCODE,                    
           BOOKTYPE,                    
           ENTEREDBY,                    
           PDT,                    
           CHECKEDBY,                    
           ACTNODAYS,                    
           NARRATION                    
  FROM     #LEDGER                    
  ORDER BY BOOKTYPE,                    
           VTYP,                    
           VNO,                    
           LNO                    
                    
  IF @@ERROR <> 0                    
    BEGIN                    
    DROP TABLE #LEDGER                    
    DROP TABLE #RECPAY_TABLE                    
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                    
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                    
    EXEC ACCOUNT.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME                    
    RETURN                    
    END                    
                    
                    
IF @@BRANCHFLAG = 1                      
    BEGIN               
              
 SELECT * INTO #LEDGER2 FROM LEDGER2 WHERE 1 = 2              
              
 INSERT INTO #LEDGER2              
 SELECT VTYP, VNO, LNO, DRCR, VAMT, COSTCODE, L.BOOKTYPE, L.CLTCODE              
 FROM #LEDGER L, COSTMAST C, ACMAST A WHERE               
 L.CLTCODE = A.CLTCODE AND C.COSTNAME = L.BRANCHCODE --CASE WHEN UPPER(A.BRANCHCODE) = 'ALL' THEN 'HO' ELSE A.BRANCHCODE END              
              
 INSERT INTO #LEDGER2              
 SELECT VTYPE, VNO, LNO, CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END, CAMT, COSTCODE, BOOKTYPE, 'HOCTRL'              
 FROM #LEDGER2 WHERE COSTCODE IN(SELECT COSTCODE FROM COSTMAST WHERE COSTNAME <> 'HO')              
    AND vno not in (SELECT VNO FROM #LEDGER2 GROUP BY VNO, COSTCODE HAVING COUNT(1) > 1)                     
 DECLARE @@COSTCODE INT              
              
 SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO'              
              
 INSERT INTO #LEDGER2              
 SELECT VTYPE, VNO, LNO, DRCR, CAMT, @@COSTCODE, BOOKTYPE, BRCONTROLAC              
 FROM #LEDGER2 L2, BRANCHACCOUNTS B, COSTMAST C              
 WHERE L2.COSTCODE = C.COSTCODE AND COSTNAME <> 'HO' AND CLTCODE <> 'HOCTRL'              
 AND COSTNAME = BRANCHNAME               
 AND vno not in (SELECT VNO FROM #LEDGER2 GROUP BY VNO, COSTCODE HAVING COUNT(1) > 1)                
              
 INSERT INTO LEDGER2 (VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE )                   
 SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE FROM #LEDGER2              
                    
      /*SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                      
                               FROM     #RECPAY_TABLE                      
                               ORDER BY VNO                      
      OPEN @@L2CUR                      
                      
      FETCH NEXT FROM @@L2CUR                      
      INTO @@L2VNO                                  
      WHILE @@FETCH_STATUS = 0                      
        BEGIN                      
          DELETE FROM TEMPLEDGER2                      
          WHERE       SESSIONID = '9999999999'                      
                    
  /*======CLIENT SIDE RECORD======*/                      
          INSERT INTO TEMPLEDGER2                      
          SELECT 'BRANCH',                      
                 C.COSTNAME,                      
                 AMOUNT,                      
                 VTYP,                      
                 VNO,                      
                 LNO,                      
                 DRCR,                      
                 '0',                      
                 BOOKTYPE,                      
                 '9999999999',                      
                 CLIENT_CODE,                      
                 'A',                      
                 '0'                      
    FROM   #RECPAY_TABLE RP,                      
                 COSTMAST C WITH(NOLOCK)                      
          WHERE  RP.COSTCODE = C.COSTCODE                      
                 AND VNO = @@L2VNO                      
                      
          EXEC INSERTTOLEDGER2                      
            '9999999999' ,                      
            @@L2VNO ,                      
            '1' ,                      
            '1' ,                      
            '1' ,                 
            'BROKER' ,                      
         'BROKER'                      
                      
  FETCH NEXT FROM @@L2CUR                      
          INTO @@L2VNO                      
        END                      
                    
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                      
      WHERE       SESSIONID = '9999999999'    */                  
 END                      
              
            
DROP TABLE #LEDGER              
                    
            
IF @@ACCOUNTSVR <> 'AngelBSECM'          
 BEGIN                     
 SET @@SQLPARA = " EXEC AngelBSECM.ACCOUNT_AB.DBO.V2_OFFLINE_REV_UPDATE '" + @@NEWVNO + "','" + @EXCHANGE + "','" + @SEGMENT + "' "            
 END                    
ELSE                    
 BEGIN                    
 SET @@SQLPARA = " EXEC V2_OFFLINE_REV_UPDATE '" + @@NEWVNO + "','" + @EXCHANGE + "','" + @SEGMENT + "' "            
END               
print @@SQLPARA                 
EXEC(@@SQLPARA)               
               
COMMIT TRAN                         
                        
DROP TABLE #RECPAY_TABLE                        
SET @ERRORCODE = 0                        
SET @MESSAGE = 'POSTED SUCCESSFULLY'                        
EXEC AngelBSECM.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME                        
                        
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_UPLOAD_PUTLOG
-- --------------------------------------------------

  
  
CREATE PROC [dbo].[V2_OFFLINE_UPLOAD_PUTLOG]  
(  
 @P_EXCHANGE VARCHAR(3),  
 @P_SEGMENT VARCHAR(10),  
 @P_VOUCHERTYPE SMALLINT,  
 @P_ERRORCODE INT,  
 @P_ERRORMSG VARCHAR(255),  
 @P_UPDATEBY VARCHAR(25)  
)  
AS  

BEGIN DISTRIBUTED TRANSACTION 

INSERT INTO AngelBSECM.ACCOUNT_AB.DBO.OFFLINE_UPLOAD_LOG  
(  
 OUL_EXCHANGE,  
 OUL_SEGMENT,  
 OUL_VOUCHERTYPE,  
 OUL_ERRORCODE,  
 OUL_ERRORMSG ,  
 OUL_UPDATEBY,  
 OUL_UPDATEDT  
)  
VALUES  
(  
 @P_EXCHANGE,  
 @P_SEGMENT,  
 @P_VOUCHERTYPE,  
 @P_ERRORCODE,  
 @P_ERRORMSG,  
 @P_UPDATEBY,  
 GETDATE()  
)

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VIJAY_MTF_DATA
-- --------------------------------------------------


CREATE PROC [dbo].[VIJAY_MTF_DATA]

AS

--SELECT CONVERT( DATE,CONVERT(VARCHAR(10),GETDATE(),103),103)



--DECLARE @FD  DATE

--SET @FD = GETDATE()

--PRINT @FD



--DECLARE @TD DATE

--SET @TD = CONVERT(VARCHAR(10),GETDATE(),103)

--PRINT @TD





--EXEC RPT_MTF_SUMMARY  @StatusId='broker', @StatusName='broker', @FromParty='A000000', @ToParty='ZZZZZZZ', @FromDate=@FD, @ToDate= @TD



--EXEC RPT_MTF_SUMMARY  @StatusId='broker', @StatusName='broker', @FromParty='A000000', @ToParty='ZZZZZZZ', @FromDate='18/12/2019', @ToDate= '19/12/2019'


--DECLARE @FD VARCHAR(11) = CONVERT(VARCHAR(11),GETDATE()-2,109)
--PRINT @FD
--DECLARE @TD VARCHAR(11) = CONVERT(VARCHAR(11),GETDATE()-2,109)
--PRINT @TD

--EXEC RPT_MTF_SUMMARY  @StatusId='broker', @StatusName='broker', @FromParty='A000000', @ToParty='ZZZZZZZ', @FromDate= @FD, @ToDate= @TD



DECLARE @SD DATE = GETDATE()
DECLARE @SAUDA_DATE DATE
DECLARE  @START DATETIME
SELECT  @START=RUNDATE FROM (
SELECT DISTINCT TOP 1  RUNDATE  FROM TBL_MTF_DATA_LOG
WHERE SAUDA_DATE = @SD ORDER BY RUNDATE  
) a ORDER BY RUNDATE

DECLARE  @END DATETIME
SELECT @END=RUNDATE FROM (
SELECT DISTINCT TOP 1  RUNDATE  FROM TBL_MTF_DATA_LOG
WHERE SAUDA_DATE = @SD ORDER BY RUNDATE  DESC)A

--;WITH A

--AS

--(

--SELECT

--*

-- FROM TBL_MTF_DATA_LOG

--WHERE SAUDA_DATE = '2019-12-12'

--AND  RUNDATE > @START

--AND   RUNDATE < @END

--and PARTY_CODE = 'C24216'

--)

--SELECT * FROM A ORDER BY RUNDATE

SET @SAUDA_DATE = @SD

;WITH A
AS
(
SELECT
SAUDA_DATE, PARTY_CODE,
SUM(MARGIN_REQ) MARGIN_REQ,
SUM(MTOM_LOSS) MTOM_LOSS,
SUM(FOMARGIN) FOMARGIN,
MAX(CMLEDBAL)CMLEDBAL,MAX(MTFLEDBAL)MTFLEDBAL,MAX(FOLEDBAL)FOLEDBAL,
MAX(CMCASHEQCOLLATERAL)CMCASHEQCOLLATERAL,MAX(CMCASHCOLLATERAL)CMCASHCOLLATERAL,MAX(CMNONCASHCOLLATERAL)CMNONCASHCOLLATERAL,
MAX(CMNONCASHCOLLATERAL_MTF)CMNONCASHCOLLATERAL_MTF,
MAX(CMDEBITHOLD)CMDEBITHOLD,MAX(CMDEBITHOLD_MTF)CMDEBITHOLD_MTF,MAX(CMOPENPOS)CMOPENPOS,MAX(MTFCASHEQCOLLATERAL)MTFCASHEQCOLLATERAL,
MAX(MTFCASHCOLLATERAL)MTFCASHCOLLATERAL,MAX(MTFNONCASHCOLLATERAL)MTFNONCASHCOLLATERAL,MAX(FOCASHEQCOLLATERAL)FOCASHEQCOLLATERAL,
MAX(FOCASHCOLLATERAL)FOCASHCOLLATERAL,
MAX(FONONCASHCOLLATERAL)FONONCASHCOLLATERAL,
MAX(FONONCASHCOLLATERAL_MTF)FONONCASHCOLLATERAL_MTF,MAX(NET_AVL_FUND)NET_AVL_FUND,MAX(POAHOLDING)POAHOLDING,
MAX(POAHOLDING_MTF)POAHOLDING_MTF,
MAX(SELLSHORT)SELLSHORT,MAX(CASHDEBITADJ)CASHDEBITADJ,MAX(CASHNONCASHADJ)CASHNONCASHADJ,MAX(FONONCASHADJ)FONONCASHADJ,
MAX(CASHLEDADJ)CASHLEDADJ,
MAX(FOLEDBALADJ)FOLEDBALADJ,MAX(POAADJ)POAADJ
 FROM TBL_MTF_DATA_LOG
WHERE SAUDA_DATE = @SAUDA_DATE
AND  RUNDATE > @START
AND   RUNDATE <= @END
--and PARTY_CODE = 'C24216'
GROUP BY SAUDA_DATE,PARTY_CODE
)
SELECT * FROM A --WHERE R =2



 

--WITH A

--AS

--(

--SELECT

--* ,ROW_NUMBER () OVER(PARTITION BY PARTY_CODE,RUNDATE ORDER BY SNO) AS R

-- FROM TBL_MTF_DATA_LOG

--WHERE SAUDA_DATE = '2019-12-12'

----AND  RUNDATE < '2019-12-12 20:35:36.060'

--and PARTY_CODE = 'A114307'

--)

--SELECT * FROM A ORDER BY RUNDATE

----SCRIP_CD

----SREINFRA  





--SELECT * FROM TBL_MTF_DATA_LOG WHERE PARTY_CODE = 'C24216' AND  SAUDA_DATE = '2019-12-12'


--PARTY_CODE	,ISIN,	QTY	HOLDFLAG,	RECTYPE,	BDPTYPE	,BDPID	,BCLTDPID
--ASWO1006	INE155A01022	1	FOCOLL	NSE	NSDL	IN301348	20016807


--select PARTY_CODE,ISIN,QTY,HOLDFLAG,RECTYPE,BDPTYPE,BDPID,BCLTDPID from MTF_DELDATA where TRTYPE =1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VIJAY_MTF_DATA_BACK
-- --------------------------------------------------


CREATE PROC [dbo].[VIJAY_MTF_DATA_BACK]
(
  @DATE DATE,
  @FROMPARTY_CODE VARCHAR(20),
  @TOPARTY_CODE VARCHAR(20)
)
AS

DECLARE @SAUDA_DATE DATE
DECLARE  @START DATETIME
SELECT  @START=RUNDATE FROM (
SELECT DISTINCT TOP 1  RUNDATE  FROM TBL_MTF_DATA_LOG
WHERE SAUDA_DATE = @Date ORDER BY RUNDATE  
) a ORDER BY RUNDATE


DECLARE  @END DATETIME
SELECT  @END = RUNDATE FROM(
SELECT DISTINCT TOP 1  RUNDATE
FROM (
SELECT DISTINCT TOP 2  RUNDATE  FROM TBL_MTF_DATA_LOG
WHERE SAUDA_DATE = @DATE ORDER BY RUNDATE  DESC
) a ORDER BY RUNDATE
)A


SET @SAUDA_DATE =  @Date


;WITH A
AS
(
SELECT
SAUDA_DATE, PARTY_CODE,
SUM(MARGIN_REQ) MARGIN_REQ,
SUM(MTOM_LOSS) MTOM_LOSS,
SUM(FOMARGIN) FOMARGIN,
MAX(CMLEDBAL)CMLEDBAL,MAX(MTFLEDBAL)MTFLEDBAL,MAX(FOLEDBAL)FOLEDBAL,
MAX(CMCASHEQCOLLATERAL)CMCASHEQCOLLATERAL,MAX(CMCASHCOLLATERAL)CMCASHCOLLATERAL,MAX(CMNONCASHCOLLATERAL)CMNONCASHCOLLATERAL,
MAX(CMNONCASHCOLLATERAL_MTF)CMNONCASHCOLLATERAL_MTF,
MAX(CMDEBITHOLD)CMDEBITHOLD,MAX(CMDEBITHOLD_MTF)CMDEBITHOLD_MTF,MAX(CMOPENPOS)CMOPENPOS,MAX(MTFCASHEQCOLLATERAL)MTFCASHEQCOLLATERAL,
MAX(MTFCASHCOLLATERAL)MTFCASHCOLLATERAL,MAX(MTFNONCASHCOLLATERAL)MTFNONCASHCOLLATERAL,MAX(FOCASHEQCOLLATERAL)FOCASHEQCOLLATERAL,
MAX(FOCASHCOLLATERAL)FOCASHCOLLATERAL,
MAX(FONONCASHCOLLATERAL)FONONCASHCOLLATERAL,
MAX(FONONCASHCOLLATERAL_MTF)FONONCASHCOLLATERAL_MTF,MAX(NET_AVL_FUND)NET_AVL_FUND,MAX(POAHOLDING)POAHOLDING,
MAX(POAHOLDING_MTF)POAHOLDING_MTF,
MAX(SELLSHORT)SELLSHORT,MAX(CASHDEBITADJ)CASHDEBITADJ,MAX(CASHNONCASHADJ)CASHNONCASHADJ,MAX(FONONCASHADJ)FONONCASHADJ,
MAX(CASHLEDADJ)CASHLEDADJ,
MAX(FOLEDBALADJ)FOLEDBALADJ,MAX(POAADJ)POAADJ
 FROM TBL_MTF_DATA_LOG
WHERE SAUDA_DATE = @SAUDA_DATE
AND  RUNDATE > @START
AND   RUNDATE < @END
AND PARTY_CODE BETWEEN @FromPARTY_CODE and @TOPARTY_CODE
--and PARTY_CODE = 'C24216'
GROUP BY SAUDA_DATE,PARTY_CODE
)
SELECT * FROM A --WHERE R =2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.voucher_effective_balance
-- --------------------------------------------------

--Exec voucher_effective_balance 'DEC  5 2017'

CREATE proc [dbo].[voucher_effective_balance] 
(  
@TODATE   VARCHAR (11)  
) 
AS BEGIN   

create table #CLIENTLOGIN1
(

	 [ENT_CODE]    [VARCHAR](25) NOT NULL,  
	 [PARTY_CODE]  [VARCHAR](10) NOT NULL 
 )

 INSERT INTO #CLIENTLOGIN1  
SELECT   PARTY_CODE, ENT_CODE 
FROM   MSAJAG..CLIENT_DETAILS C,   
CBO_TB_ENTITYMASTER E   
WHERE  PARTY_CODE IN ( select CLTCODE from OLDNEW)
--where ENT_CODE = PARTY_CODE
and ENT_CODE = PARTY_CODE
AND E.ENT_TYPE = 'CLIENT'   


----------go---------------------


  SELECT     
   PARTY_CODE,ENT_CODE,
   LEDBAL = SUM(VAMT),DRCR,BALFLAG = 1,LEDFLAG = 1     into #temp11
FROM     LEDGER L (NOLOCK),#CLIENTLOGIN1 M,PARAMETER P       
WHERE   @TODATE BETWEEN SDTCUR AND LDTCUR       
AND VDT >=SDTCUR AND VDT <= @TODATE  AND PARTY_CODE = CLTCODE       
GROUP BY DRCR,PARTY_CODE,ENT_CODE


  INSERT INTO #temp11     
 SELECT PARTY_CODE,ENT_CODE,LEDBAL = SUM(VAMT),DRCR,BALFLAG = 2,LEDFLAG = 1       
FROM     LEDGER L (NOLOCK),#CLIENTLOGIN1 M,PARAMETER P  
WHERE    VDT BETWEEN SDTCUR AND LDTCUR       
         AND PARTY_CODE = CLTCODE       
	GROUP BY DRCR ,party_code,ENT_CODE       


create table #data
	( seg varchar(10), 
	ENT_CODE varchar(20),
	LEDBAL money,
	CLTCODE varchar(20),
	BAL money)

insert #data (seg,ENT_CODE,LEDBAL)
 SELECT  'MTF' as seg ,ENT_CODE,       
LEDBAL = SUM(CASE  WHEN LEDFLAG = 1 AND BALFLAG = 1 THEN (CASE WHEN DRCR = 'D' THEN -LEDBAL       
ELSE LEDBAL END) ELSE 0 END)    FROM     #temp11      
GROUP BY ENT_CODE 


	

create table #temp
	(
	CL_CODE varchar(20),

	BAL_ money
	)
insert #temp (CL_CODE,BAL_)
exec effective_balance_new @TODATE

--delete from #temp where cl_code in (select ent_code from #data1) 

declare @VO int 
declare @eff int 
set @VO = (select count(1) from #data)
set @eff = (select count(1) from #temp)

--select @VO as count ,@eff as count
if @VO >= @eff

--select *  FROM #data a  left outer join  #temp b on a.ENT_CODE = b.CL_CODE order by  b.CL_CODE

--else

--select *  FROM #data a  right  outer  join  #temp b on a.ENT_CODE = b.CL_CODE order by  b.CL_CODE


update a set a.CLTCODE = b.CL_CODE,a.BAL =b.BAL_  FROM #data a  left outer join  #temp b on a.ENT_CODE = b.CL_CODE 

else 

select 'DATA NOT UPDATED.i.e. Voucher count is less than Effective code.'

--select *  FROM #data a  left outer join  #temp b on a.ENT_CODE = b.CL_CODE

--update a set a.CLTCODE = b.CL_CODE,a.BAL =b.BAL_ FROM #data a  left outer join  #temp b

--on a.ENT_CODE = b.CL_CODE

select seg as SEG,ENT_CODE as ENT_CODE_Voucher,ledbal,cltcode as  CLTCODE_effective,BAL   from #data
order by CLTCODE 


end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.voucher_effective_balance_07
-- --------------------------------------------------

create proc dbo.voucher_effective_balance_07 
(  
@TODATE   VARCHAR (11)  
) 
AS BEGIN   

create table #CLIENTLOGIN1
(

	 [ENT_CODE]    [VARCHAR](25) NOT NULL,  
	 [PARTY_CODE]  [VARCHAR](10) NOT NULL 
 )

 INSERT INTO #CLIENTLOGIN1  
SELECT   PARTY_CODE, ENT_CODE 
FROM   MSAJAG..CLIENT_DETAILS C,   
CBO_TB_ENTITYMASTER E   
WHERE  PARTY_CODE IN ( select CLTCODE from OLDNEW)
and ENT_CODE = PARTY_CODE
AND E.ENT_TYPE = 'CLIENT'   


----------go---------------------


  SELECT     
   PARTY_CODE,ENT_CODE,
   LEDBAL = SUM(VAMT),DRCR,BALFLAG = 1,LEDFLAG = 1     into #temp11
FROM     LEDGER L (NOLOCK),#CLIENTLOGIN1 M,PARAMETER P       
WHERE   @TODATE BETWEEN SDTCUR AND LDTCUR       
AND VDT >=SDTCUR AND VDT <= @TODATE  AND PARTY_CODE = CLTCODE       
GROUP BY DRCR,PARTY_CODE,ENT_CODE


  INSERT INTO #temp11     
 SELECT PARTY_CODE,ENT_CODE,LEDBAL = SUM(VAMT),DRCR,BALFLAG = 2,LEDFLAG = 1       
FROM     LEDGER L (NOLOCK),#CLIENTLOGIN1 M,PARAMETER P  
WHERE    VDT BETWEEN SDTCUR AND LDTCUR       
         AND PARTY_CODE = CLTCODE       
	GROUP BY DRCR ,party_code,ENT_CODE       


create table #data
	( seg varchar(10), 
	ENT_CODE varchar(20),
	LEDBAL money,
	CLTCODE varchar(20),
	BAL money)

insert #data (seg,ENT_CODE,LEDBAL)
 SELECT  'MTF' as seg ,ENT_CODE,       
LEDBAL = SUM(CASE  WHEN LEDFLAG = 1 AND BALFLAG = 1 THEN (CASE WHEN DRCR = 'D' THEN -LEDBAL       
ELSE LEDBAL END) ELSE 0 END)    FROM     #temp11      
GROUP BY ENT_CODE 


	

create table #temp
	(
	CL_CODE varchar(20),

	BAL_ money
	)
insert #temp (CL_CODE,BAL_)
exec effective_balance_new @TODATE

--delete from #temp where cl_code in (select ent_code from #data1) 

declare @VO int 
declare @eff int 
set @VO = (select count(1) from #data)
set @eff = (select count(1) from #temp)

--select @VO as count ,@eff as count
if @VO >= @eff

--select *  FROM #data a  left outer join  #temp b on a.ENT_CODE = b.CL_CODE order by  b.CL_CODE

--else

--select *  FROM #data a  right  outer  join  #temp b on a.ENT_CODE = b.CL_CODE order by  b.CL_CODE


update a set a.CLTCODE = b.CL_CODE,a.BAL =b.BAL_  FROM #data a  left outer join  #temp b on a.ENT_CODE = b.CL_CODE 

else 

select 'DATA NOT UPDATED.i.e. Voucher count is less than Effective code.'

--select *  FROM #data a  left outer join  #temp b on a.ENT_CODE = b.CL_CODE

--update a set a.CLTCODE = b.CL_CODE,a.BAL =b.BAL_ FROM #data a  left outer join  #temp b

--on a.ENT_CODE = b.CL_CODE

select seg as SEG,ENT_CODE as ENT_CODE_Voucher,ledbal,cltcode as  CLTCODE_effective,BAL   from #data
order by CLTCODE 


end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VW
-- --------------------------------------------------
      
CREATE PROC VW @VWNAME VARCHAR(25)AS                     
SELECT * FROM SYSOBJECTS WHERE NAME LIKE '%' + @VWNAME + '%' AND XTYPE='V' ORDER BY NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND
-- --------------------------------------------------


        
 /*            
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18            
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200804010001', '01', 'APR  1 2008', 'OPENING BALANCE'          
*/            
CREATE PROC [dbo].[YEAREND]            
 @SDTCUR VARCHAR(11),            
 @LDTCUR VARCHAR(11),            
 @VTYP SMALLINT,            
 @VNO VARCHAR(12),            
 @BOOKTYPE VARCHAR(2),            
 @VDT VARCHAR(11),            
 @MSG1 VARCHAR(234),          
 @PNL_CODE VARCHAR(10) = '99999'          
AS            
/*            
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'            
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'            
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'            
             
*/            
          
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
            
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE            
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE            
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE            
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE            
            
 CREATE TABLE #VDT            
 (            
  CLTCODE VARCHAR(10),            
  ACNAME VARCHAR(100),            
  DRCR VARCHAR(1),            
  BALANCE MONEY            
 )            
            
 INSERT INTO #VDT            
  (CLTCODE, ACNAME, DRCR, BALANCE)            
 SELECT            
  A.CLTCODE,            
  ACNAME = ISNULL(A.LONGNAME, ''),            
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,            
  VAMT = ROUND(ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END)),2)            
 FROM            
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE            
 WHERE            
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'            
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')            
  AND L.CLTCODE <> @PNL_CODE            
 GROUP BY            
  A.CLTCODE,            
  A.LONGNAME            
            
            
 CREATE TABLE #EDT            
 (            
  CLTCODE VARCHAR(10),            
  BALANCE MONEY            
 )            
            
 INSERT INTO #EDT            
  (CLTCODE, BALANCE)            
 SELECT            
  A.CLTCODE,            
  BALANCE = ROUND(SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END),2)            
 FROM            
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE            
 WHERE            
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'            
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')            
  AND L.CLTCODE <> @PNL_CODE            
 GROUP BY            
  A.CLTCODE            
            
            
 CREATE TABLE #LEDGER            
 (            
  VTYP SMALLINT,            
  VNO VARCHAR(12),            
  EDT DATETIME,            
  LNO INT IDENTITY(1,1),            
  ACNAME VARCHAR(100),            
  DRCR CHAR(1),            
  VAMT MONEY,            
  VDT DATETIME,            
  VNO1 VARCHAR(12),            
  REFNO CHAR(12),            
  BALAMT MONEY,            
  NODAYS INT,            
  CDT DATETIME,            
  CLTCODE VARCHAR(10),            
  BOOKTYPE VARCHAR(2),            
  ENTEREDBY VARCHAR(25),            
  PDT DATETIME,            
  CHECKEDBY VARCHAR(25),            
  ACTNODAYS INT,            
  NARRATION VARCHAR(234)            
 )            
            
INSERT INTO #LEDGER            
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)            
SELECT            
 VTYP = @VTYP,            
 VNO = @VNO,            
 EDT = @VDT,            
 ACNAME = V.ACNAME,            
 DRCR = V.DRCR,            
 VAMT = V.BALANCE,            
 VDT = @VDT,            
 VNO1 = @VNO,            
 REFNO = '',            
 BALAMT = ISNULL(E.BALANCE, 0),            
 NODAYS = 0,            
 CDT = GETDATE(),            
 V.CLTCODE,            
 BOOKTYPE = @BOOKTYPE,            
 ENTEREDBY = 'SYSTEM',            
 PDT = GETDATE(),            
 CHECKEDBY = 'SYSTEM',            
 ACTNODAYS = 0,            
 NARRATION = @MSG1            
FROM            
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE            
            
            
CREATE TABLE #PANDL            
(            
 VDTBAL MONEY,            
 EDTBAL MONEY            
)            
INSERT INTO #PANDL SELECT VDTBAL = ROUND(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),2), EDTBAL = ROUND((SUM(BALAMT)),2) FROM #LEDGER            
            
INSERT INTO #LEDGER            
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)            
SELECT            
 VTYP = @VTYP,            
 VNO = @VNO,            
 EDT = @VDT,            
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),            
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,            
 VAMT = ABS(VDTBAL),            
 VDT = @VDT,            
 VNO1 = @VNO,            
 REFNO = '',            
 BALAMT = EDTBAL,            
 NODAYS = 0,            
 CDT = GETDATE(),            
 A.CLTCODE,            
 BOOKTYPE = @BOOKTYPE,            
 ENTEREDBY = 'SYSTEM',            
 PDT = GETDATE(),            
 CHECKEDBY = 'SYSTEM',            
 ACTNODAYS = 0,            
 NARRATION = @MSG1            
FROM            
 #PANDL,            
 ACMAST A            
WHERE            
 A.CLTCODE = @PNL_CODE            
            
            
            
DROP TABLE #VDT            
DROP TABLE #EDT            
DROP TABLE #PANDL            
            
CREATE TABLE #MVDT            
(            
 PARTY_CODE VARCHAR(10),            
 MCLTCODE VARCHAR(10),            
 EXCHANGE VARCHAR(3),            
 SEGMENT VARCHAR(20),            
 DRCR VARCHAR(1),            
 AMOUNT MONEY            
)            
            
INSERT INTO #MVDT            
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)            
SELECT            
 PARTY_CODE,            
 MCLTCODE,            
 EXCHANGE,            
 SEGMENT,            
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,            
 AMOUNT = ROUND(SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END),2)            
FROM            
 MARGINLEDGER            
WHERE            
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'            
GROUP BY            
 PARTY_CODE,            
 MCLTCODE,            
 EXCHANGE,            
 SEGMENT            
            
CREATE TABLE #MEDT            
(            
 PARTY_CODE VARCHAR(10),            
 MCLTCODE VARCHAR(10),            
 EXCHANGE VARCHAR(3),            
 SEGMENT VARCHAR(20),            
 AMOUNT MONEY            
)            
            
INSERT INTO #MEDT            
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)            
SELECT            
 M.PARTY_CODE,            
 M.MCLTCODE,            
 M.EXCHANGE,            
 M.SEGMENT,            
 AMOUNT = ROUND(SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END),2)            
FROM            
 MARGINLEDGER M,            
 LEDGER L            
WHERE            
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO            
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'            
GROUP BY            
 M.PARTY_CODE,            
 M.MCLTCODE,            
 M.EXCHANGE,            
 M.SEGMENT            
            
CREATE TABLE #MARGINLEDGER            
(            
 VTYP SMALLINT,            
 VNO VARCHAR(12),            
 LNO INT,            
 DRCR VARCHAR(1),            
 VDT DATETIME,            
 AMOUNT MONEY,            
 PARTY_CODE VARCHAR(10),            
 EXCHANGE VARCHAR(3),            
 SEGMENT VARCHAR(20),            
 SETT_NO MONEY,            
 SETT_TYPE VARCHAR(3),            
 BOOKTYPE VARCHAR(2),            
 MCLTCODE VARCHAR(10)            
)            
            
INSERT INTO #MARGINLEDGER            
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)            
SELECT            
 VTYP = @VTYP,            
 VNO = @VNO,            
 DRCR = V.DRCR,            
 VDT = @VDT,            
 AMOUNT = ABS(V.AMOUNT),            
 PARTY_CODE = V.PARTY_CODE,            
 EXCHANGE = V.EXCHANGE,            
 SEGMENT = V.SEGMENT,            
 SETT_NO = ISNULL(E.AMOUNT, 0),            
 SETT_TYPE = '',            
 BOOKTYPE = @BOOKTYPE,            
 MCLTCODE = V.MCLTCODE            
FROM            
 #MVDT V LEFT OUTER JOIN #MEDT E ON            
  V.PARTY_CODE = E.PARTY_CODE            
  AND V.MCLTCODE = E.MCLTCODE            
  AND V.EXCHANGE = E.EXCHANGE            
  AND V.SEGMENT = E.SEGMENT            
            
UPDATE            
 H            
SET            
 LNO = L.LNO            
FROM            
 #MARGINLEDGER H,            
 #LEDGER L            
WHERE            
 H.MCLTCODE = L.CLTCODE            
            
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE            
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M            
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE            
DECLARE @ISDIFF INT            
SET @ISDIFF = 0            
SELECT            
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L            
WHERE            
 M.MCLTCODE = L.CLTCODE            
 AND M.BALANCE <> L.BALANCE            
            
/*IF @ISDIFF <> 0            
 BEGIN            
  DROP TABLE #LEDGER            
  DROP TABLE #MARGINLEDGER            
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'            
 END            
ELSE            
 BEGIN  */          
  INSERT INTO LEDGER SELECT * FROM #LEDGER            
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER            
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER            
  ---EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE            
  DROP TABLE #LEDGER            
  DROP TABLE #MARGINLEDGER            
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'            
-- END

GO

-- --------------------------------------------------
-- TABLE dbo._#cl
-- --------------------------------------------------
CREATE TABLE [dbo].[_#cl]
(
    [cl_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.A123
-- --------------------------------------------------
CREATE TABLE [dbo].[A123]
(
    [NAME] VARCHAR(50) NULL,
    [PAN_GI] VARCHAR(50) NULL,
    [SCRIP_CD] VARCHAR(50) NULL,
    [SERIES] VARCHAR(50) NULL,
    [QTY] VARCHAR(50) NULL,
    [AMOUNT] VARCHAR(50) NULL,
    [CL_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Appln_ERROR
-- --------------------------------------------------
CREATE TABLE [dbo].[Appln_ERROR]
(
    [ErrID] INT IDENTITY(1,1) NOT NULL,
    [ErrTime] DATETIME NULL,
    [ErrObject] VARCHAR(8000) NULL,
    [ErrLine] INT NULL,
    [ErrMessage] VARCHAR(8000) NULL,
    [ApplnName] VARCHAR(100) NULL,
    [DBname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AsianFileBatchNo
-- --------------------------------------------------
CREATE TABLE [dbo].[AsianFileBatchNo]
(
    [FldFileNo] VARCHAR(2) NULL,
    [fldBatchNo] INT NULL,
    [fldFileDate] DATETIME NULL,
    [fldSystemDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AsianFileType
-- --------------------------------------------------
CREATE TABLE [dbo].[AsianFileType]
(
    [fldFileNo] VARCHAR(2) NOT NULL,
    [fldFileType] VARCHAR(50) NULL,
    [fldFileName] VARCHAR(10) NULL,
    [fldProcName] VARCHAR(200) NULL,
    [FLDFILEHEADER] INT NULL,
    [FLDFILEFOOTER] INT NULL,
    [fldFileFor] VARCHAR(20) NULL,
    [fldFileSeperator] VARCHAR(1) NULL,
    [fldFEILDHEADER] INT NULL,
    [fldROUNDING] INT NULL,
    [fldFileFormat] VARCHAR(5) NULL,
    [FLDPARAMETER] INT NOT NULL,
    [fldFixedHeader] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.autoclosure_clients
-- --------------------------------------------------
CREATE TABLE [dbo].[autoclosure_clients]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [date] DATETIME NULL DEFAULT (getdate()),
    [party_code] VARCHAR(25) NULL DEFAULT NULL,
    [auto_closure] VARCHAR(10) NULL DEFAULT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_COALINDIA
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_COALINDIA]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_DIFF
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_DIFF]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [DIFFQTY] NUMERIC(38, 3) NULL,
    [EXEQTY] INT NOT NULL,
    [NONBOOK] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_OTHERSINGLE
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_OTHERSINGLE]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_POS_17072021
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_POS_17072021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_RBLBANK
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_RBLBANK]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_TBL_PRODUCT_POS_ADJUST_BUY_DEC17219
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_TBL_PRODUCT_POS_ADJUST_BUY_DEC17219]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL,
    [NETAMT] NUMERIC(18, 4) NULL,
    [cl_rate] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_TBL_PRODUCT_POS_ADJUST_BUY_sep24219
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_TBL_PRODUCT_POS_ADJUST_BUY_sep24219]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL,
    [NETAMT] NUMERIC(18, 4) NULL,
    [cl_rate] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_TBL_PRODUCT_POS_ADJUST_DEC172019
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_TBL_PRODUCT_POS_ADJUST_DEC172019]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_TBL_PRODUCT_POS_ADJUST_DEC17219
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_TBL_PRODUCT_POS_ADJUST_DEC17219]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_TBL_PRODUCT_POS_ADJUST_DEC18219
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_TBL_PRODUCT_POS_ADJUST_DEC18219]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_TBL_PRODUCT_POS_ADJUST_sep242019
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_TBL_PRODUCT_POS_ADJUST_sep242019]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_TBL_PRODUCT_POSITION_sep242019
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_TBL_PRODUCT_POSITION_sep242019]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_TRIDENT
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_TRIDENT]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAL4
-- --------------------------------------------------
CREATE TABLE [dbo].[BAL4]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BookType
-- --------------------------------------------------
CREATE TABLE [dbo].[BookType]
(
    [vtyp] INT NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchaccounts
-- --------------------------------------------------
CREATE TABLE [dbo].[branchaccounts]
(
    [BranchName] VARCHAR(10) NOT NULL,
    [BrControlAc] VARCHAR(10) NOT NULL,
    [MainControlAc] VARCHAR(10) NOT NULL,
    [DefaultAc] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchwiseclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[branchwiseclbal]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [costcode] INT NULL,
    [balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSE_DELIVERYCLT_MTF
-- --------------------------------------------------
CREATE TABLE [dbo].[BSE_DELIVERYCLT_MTF]
(
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(6) NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [INOUT] VARCHAR(1) NOT NULL,
    [QTY] INT NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [PARTIPANTCODE] VARCHAR(15) NULL,
    [I_ISIN] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bse_grp1
-- --------------------------------------------------
CREATE TABLE [dbo].[bse_grp1]
(
    [bsecode] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BSE_MTF
-- --------------------------------------------------
CREATE TABLE [dbo].[BSE_MTF]
(
    [SAUDA_DATE] DATETIME NULL,
    [NETAMT] NUMERIC(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsemtfunappoved
-- --------------------------------------------------
CREATE TABLE [dbo].[bsemtfunappoved]
(
    [bsecode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bsesauda
-- --------------------------------------------------
CREATE TABLE [dbo].[bsesauda]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [CAT_HOLD] VARCHAR(2) NOT NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [FLAG_FUNDED] VARCHAR(1) NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [EXCHANGE] VARCHAR(3) NOT NULL,
    [MAPPING_NO] VARCHAR(1) NOT NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CASH_MARGIN_AVAILABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[CASH_MARGIN_AVAILABLE]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [MTF_FUNDING_ALL] MONEY NULL,
    [MTF_LEDGER] NUMERIC(18, 4) NULL,
    [MTF_CASH_MARGIN] NUMERIC(20, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cl_list_rcs
-- --------------------------------------------------
CREATE TABLE [dbo].[cl_list_rcs]
(
    [Party Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cl_list_rcsA
-- --------------------------------------------------
CREATE TABLE [dbo].[cl_list_rcsA]
(
    [Party Code] VARCHAR(50) NULL,
    [NETQTY] VARCHAR(50) NULL,
    [Scrip Cd] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [IsIn] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.COSTMAST
-- --------------------------------------------------
CREATE TABLE [dbo].[COSTMAST]
(
    [COSTNAME] CHAR(35) NOT NULL,
    [COSTCODE] SMALLINT NOT NULL,
    [CATCODE] SMALLINT NULL,
    [grpcode] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delcdslbalance
-- --------------------------------------------------
CREATE TABLE [dbo].[Delcdslbalance]
(
    [Party_Code] VARCHAR(10) NULL,
    [Dpid] VARCHAR(8) NOT NULL,
    [Cltdpid] VARCHAR(16) NOT NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(12) NOT NULL,
    [Freebal] NUMERIC(18, 3) NULL,
    [Currbal] NUMERIC(18, 3) NULL,
    [Freezebal] NUMERIC(18, 3) NULL,
    [Lockinbal] NUMERIC(18, 3) NULL,
    [Pledgebal] NUMERIC(18, 3) NULL,
    [Dpvbal] NUMERIC(18, 3) NULL,
    [Dpcbal] NUMERIC(18, 3) NULL,
    [Rpcbal] VARCHAR(20) NULL,
    [Elimbal] NUMERIC(18, 3) NULL,
    [Earmarkbal] NUMERIC(18, 3) NULL,
    [Remlockbal] NUMERIC(18, 3) NULL,
    [Totalbalance] NUMERIC(18, 3) NULL,
    [Trdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deltrans_Bse_bak_17022020
-- --------------------------------------------------
CREATE TABLE [dbo].[deltrans_Bse_bak_17022020]
(
    [SNo] NUMERIC(18, 0) NOT NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_type] VARCHAR(2) NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [Qty] NUMERIC(18, 0) NOT NULL,
    [FromNo] VARCHAR(16) NULL,
    [ToNo] VARCHAR(16) NULL,
    [CertNo] VARCHAR(16) NULL,
    [FolioNo] VARCHAR(16) NULL,
    [HolderName] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NULL,
    [DrCr] CHAR(1) NULL,
    [Delivered] CHAR(1) NULL,
    [OrgQty] NUMERIC(18, 0) NULL,
    [DpType] VARCHAR(10) NULL,
    [DpId] VARCHAR(16) NULL,
    [CltDpId] VARCHAR(16) NULL,
    [BranchCd] VARCHAR(10) NULL,
    [PartipantCode] VARCHAR(10) NULL,
    [SlipNo] NUMERIC(18, 0) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [ISett_No] VARCHAR(7) NULL,
    [ISett_Type] VARCHAR(2) NULL,
    [ShareType] VARCHAR(8) NULL,
    [TransDate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [BDpType] VARCHAR(10) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltDpId] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FILEDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[FILEDATA]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PROGID] VARCHAR(16) NULL,
    [FILE_DATA] VARCHAR(MAX) NULL,
    [UploadDateTime] DATETIME NULL,
    [UploadBy] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_CLIENT_MASTER]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [SESSION_ID] VARCHAR(500) NOT NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_CLIENT_MASTER_PARENT
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_CLIENT_MASTER_PARENT]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [PARENT_CODE] VARCHAR(10) NULL,
    [PARENT_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [SESSION_ID] VARCHAR(500) NOT NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESSCODE] VARCHAR(10) NULL,
    [PROCESSNAME] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [FORMULANAME] VARCHAR(MAX) NULL,
    [COMPAREWITH] VARCHAR(20) NULL,
    [COMPARISON] VARCHAR(10) NULL,
    [TR_TYPE] TINYINT NULL,
    [DBTYPE] VARCHAR(30) NULL,
    [ADDITIONAL_PARAMETERS] VARCHAR(1000) NULL,
    [FORMULA_FIELDS] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[grpmast]
(
    [grpname] VARCHAR(60) NULL,
    [grpmain] VARCHAR(13) NULL,
    [grpcode] VARCHAR(13) NULL,
    [vtyp] FLOAT NULL,
    [dispdetail] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.holding_comparison
-- --------------------------------------------------
CREATE TABLE [dbo].[holding_comparison]
(
    [party_code] VARCHAR(10) NOT NULL,
    [isin] VARCHAR(12) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [funding_qty] INT NULL,
    [cdsl_qty] INT NULL,
    [nsdl_qty] INT NULL,
    [payin] INT NULL,
    [payout] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastvno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastvno]
(
    [vtyp] SMALLINT NULL,
    [booktype] VARCHAR(2) NULL,
    [vdt] SMALLDATETIME NULL,
    [lastvno] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_02092022
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_02092022]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_030320
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_030320]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_1506
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_1506]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_18062019
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_18062019]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_2211
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_2211]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_24062022
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_24062022]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_account_bak_17022020
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_account_bak_17022020]
(
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_BAK_04032020
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_BAK_04032020]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_bak_17022020
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_bak_17022020]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_bak_20220902_1
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_bak_20220902_1]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_BRANCHBREAKUP
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_BRANCHBREAKUP]
(
    [VNO] VARCHAR(12) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] CHAR(2) NULL,
    [LNO] INT NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CAMT] MONEY NULL,
    [COSTCODE] SMALLINT NULL,
    [DRCR] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_MARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_MARGIN]
(
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_narration_07012020
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_narration_07012020]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NOT NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NOT NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(50) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(20) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER2
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER2]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL,
    [cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER3
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER3]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.m0912
-- --------------------------------------------------
CREATE TABLE [dbo].[m0912]
(
    [Pan] VARCHAR(50) NULL,
    [Scrip] VARCHAR(50) NULL,
    [sereis] VARCHAR(50) NULL,
    [qty] INT NULL,
    [value] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MarginLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[MarginLedger]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [mcltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_09072021
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_09072021]
(
    [Id_type] VARCHAR(20) NULL,
    [Name] VARCHAR(100) NULL,
    [pan_no] VARCHAR(13) NULL,
    [Scrip_Cd] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [Open_qty] INT NULL,
    [open_volume] MONEY NULL,
    [buy_qty] INT NULL,
    [buy_volume] MONEY NULL,
    [sell_qty] INT NULL,
    [sell_volume] MONEY NULL,
    [close_qty] INT NULL,
    [close_volume] MONEY NULL,
    [ind] VARCHAR(5) NULL,
    [exchange] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_13072021_NSEreport
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_13072021_NSEreport]
(
    [SAUDA_DATE] VARCHAR(30) NULL,
    [MEMBERCODE] VARCHAR(15) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [PAN_GIR_NO] VARCHAR(50) NOT NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_ANGEL_Varmargin
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_ANGEL_Varmargin]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [ISIN] VARCHAR(16) NULL,
    [NSE_Symbol] VARCHAR(11) NULL,
    [BSE_Symbol] VARCHAR(11) NULL,
    [Scrip_name] VARCHAR(60) NULL,
    [VarMargin] DECIMAL(18, 4) NULL,
    [From_date] DATETIME NULL,
    [end_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_BILL_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_BILL_DETAIL]
(
    [BILLDATE] VARCHAR(11) NULL,
    [VNO] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_CASH_COLL_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_CASH_COLL_LEDGER]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [SRNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_CASH_PAYIN_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_CASH_PAYIN_LEDGER]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [SRNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_CLIENT_ACTIVATION_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_CLIENT_ACTIVATION_LOG]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [clientcode] VARCHAR(50) NULL,
    [requestedby] VARCHAR(50) NULL,
    [requestedon] DATETIME NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_ctd
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_ctd]
(
    [party_code] VARCHAR(40) NOT NULL,
    [request_id] DECIMAL(20, 0) NOT NULL,
    [isin] VARCHAR(20) NOT NULL,
    [symbol] VARCHAR(30) NULL,
    [qty] INT NULL,
    [remark] VARCHAR(50) NULL,
    [amount] DECIMAL(15, 3) NULL,
    [request_date] DATE NOT NULL,
    [sauda_date] DATETIME NOT NULL,
    [batchtime] VARCHAR(40) NULL,
    [isfilegenerated] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_ctd_auto_release
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_ctd_auto_release]
(
    [Party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(20) NULL,
    [isin] VARCHAR(20) NULL,
    [sauda_date] DATETIME NULL,
    [released_date] DATETIME NULL,
    [auto_closure_released_qty] INT NULL,
    [mtf_loan_released_value] NUMERIC(18, 2) NULL,
    [mtf_margin_released_value] NUMERIC(18, 2) NULL,
    [net_broking_ledger_debit_amount] NUMERIC(18, 2) NULL,
    [mtf_qty] INT NULL,
    [mtf_value] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_ctd_exception
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_ctd_exception]
(
    [party_code] NVARCHAR(MAX) NULL,
    [amount] DECIMAL(25, 3) NULL,
    [request_date] DATE NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_ctd_status
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_ctd_status]
(
    [processdate] DATE NULL,
    [recordcount] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_ctd14052024
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_ctd14052024]
(
    [party_code] VARCHAR(40) NOT NULL,
    [request_id] DECIMAL(20, 0) NOT NULL,
    [isin] VARCHAR(20) NOT NULL,
    [symbol] VARCHAR(30) NULL,
    [qty] INT NULL,
    [remark] VARCHAR(50) NULL,
    [amount] DECIMAL(15, 3) NULL,
    [request_date] DATE NOT NULL,
    [sauda_date] DATETIME NOT NULL,
    [batchtime] VARCHAR(40) NULL,
    [isfilegenerated] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_DELDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_DELDATA]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ORGSNO] NUMERIC(18, 0) NULL,
    [TRTYPE] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RECTYPE] VARCHAR(10) NULL,
    [BDPTYPE] VARCHAR(4) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_DELDATA_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_DELDATA_LOG]
(
    [SAUDA_DATE] DATETIME NOT NULL,
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ORGSNO] NUMERIC(18, 0) NULL,
    [TRTYPE] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RECTYPE] VARCHAR(10) NULL,
    [BDPTYPE] VARCHAR(4) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [PROCESS_DATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_DELDATA_PROV
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_DELDATA_PROV]
(
    [SAUDA_DATE] DATETIME NOT NULL,
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [ORGSNO] NUMERIC(18, 0) NULL,
    [TRTYPE] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RECTYPE] VARCHAR(10) NULL,
    [BDPTYPE] VARCHAR(4) NULL,
    [BDPID] VARCHAR(8) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [PROCESS_DATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_DIFF
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_DIFF]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [POSQTY] INT NULL,
    [HOLDQTY] INT NOT NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [sereis] VARCHAR(12) NULL,
    [bsecode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_HOLD
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_HOLD]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(15) NULL,
    [ISIN] VARCHAR(20) NULL,
    [SERIES] VARCHAR(25) NULL,
    [QTY] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_JVDATA
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_JVDATA]
(
    [SAUDA_DATE] VARCHAR(11) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NULL,
    [FLAG] VARCHAR(4) NOT NULL,
    [GLCODE] VARCHAR(10) NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(200) NULL,
    [PROCESSDATE] DATETIME NULL,
    [DRCR] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_JVDATA_new
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_JVDATA_new]
(
    [SAUDA_DATE] VARCHAR(11) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NULL,
    [FLAG] VARCHAR(4) NOT NULL,
    [GLCODE] VARCHAR(10) NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(200) NULL,
    [PROCESSDATE] DATETIME NULL,
    [DRCR] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_JVDATA_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_JVDATA_TEST]
(
    [SAUDA_DATE] VARCHAR(11) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [AMOUNT] NUMERIC(18, 4) NULL,
    [FLAG] VARCHAR(4) NOT NULL,
    [GLCODE] VARCHAR(10) NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(200) NULL,
    [PROCESSDATE] DATETIME NULL,
    [DRCR] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_MOV
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_MOV]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [ISIN] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [QTY] INT NULL,
    [NETAMT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_MTM_LEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_MTM_LEDGER]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [SRNO] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_PURCHASE_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_PURCHASE_DATA]
(
    [TRADEDATE] DATETIME NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(10) NULL,
    [SERIES] VARCHAR(5) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [SELL_BUY] INT NULL,
    [ISIN] VARCHAR(16) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [Valid] INT NULL,
    [DUMMY1] VARCHAR(10) NULL,
    [DUMMY2] VARCHAR(10) NULL,
    [DUMMY3] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_reco_2910
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_reco_2910]
(
    [Party_Code] VARCHAR(50) NULL,
    [Scrip_Cd] VARCHAR(50) NULL,
    [Bse Code] VARCHAR(50) NULL,
    [IsIn] VARCHAR(50) NULL,
    [Nse_pos] VARCHAR(50) NULL,
    [BSE_Pos] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_SAUDA
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_SAUDA]
(
    [sauda_date] DATETIME NULL,
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [isin] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [AMT] MONEY NULL,
    [sdate] DATETIME NULL,
    [pcode] VARCHAR(10) NULL,
    [Scd] VARCHAR(12) NULL,
    [sisin] VARCHAR(12) NULL,
    [sqty] INT NULL,
    [samt] MONEY NULL,
    [tqty] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_SQUP_DETAILS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_SQUP_DETAILS_LOG]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(15) NULL,
    [SERIES] VARCHAR(25) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SQQTY] INT NULL,
    [processdate] DATETIME NOT NULL,
    [UPD_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTFDIFF
-- --------------------------------------------------
CREATE TABLE [dbo].[MTFDIFF]
(
    [PARTY_CODE] VARCHAR(11) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [QTY] INT NULL,
    [BODVALNEW] NUMERIC(18, 2) NULL,
    [BODVALOLF] NUMERIC(18, 2) NULL,
    [DIFF] NUMERIC(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtfreport
-- --------------------------------------------------
CREATE TABLE [dbo].[mtfreport]
(
    [Party] NVARCHAR(255) NULL,
    [scrip] NVARCHAR(255) NULL,
    [series] NVARCHAR(255) NULL,
    [PQTY] FLOAT NULL,
    [PVALUE] FLOAT NULL,
    [FBQTY] FLOAT NULL,
    [FBVALUE] FLOAT NULL,
    [SQTY] FLOAT NULL,
    [SVALUE] FLOAT NULL,
    [CLQTY] FLOAT NULL,
    [CLVALUE] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTR_09072021
-- --------------------------------------------------
CREATE TABLE [dbo].[MTR_09072021]
(
    [Column 0] VARCHAR(50) NULL,
    [Column 1] VARCHAR(50) NULL,
    [Column 2] VARCHAR(50) NULL,
    [Column 3] VARCHAR(50) NULL,
    [Column 4] VARCHAR(50) NULL,
    [Column 5] VARCHAR(50) NULL,
    [Column 6] VARCHAR(50) NULL,
    [Column 7] VARCHAR(50) NULL,
    [Column 8] VARCHAR(50) NULL,
    [Column 9] VARCHAR(50) NULL,
    [Column 10] VARCHAR(50) NULL,
    [Column 11] VARCHAR(50) NULL,
    [Column 12] VARCHAR(50) NULL,
    [Column 13] VARCHAR(50) NULL,
    [Column 14] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTICOMPANY
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTICOMPANY]
(
    [BrokerId] VARCHAR(6) NOT NULL,
    [CompanyName] VARCHAR(100) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [MemberType] VARCHAR(3) NOT NULL,
    [MemberCode] VARCHAR(15) NOT NULL,
    [ShareDb] VARCHAR(20) NOT NULL,
    [ShareServer] VARCHAR(15) NOT NULL,
    [ShareIP] VARCHAR(15) NULL,
    [AccountDb] VARCHAR(20) NOT NULL,
    [AccountServer] VARCHAR(15) NOT NULL,
    [AccountIP] VARCHAR(15) NULL,
    [DefaultDb] VARCHAR(20) NOT NULL,
    [DefaultDbServer] VARCHAR(15) NOT NULL,
    [DefaultDbIP] VARCHAR(15) NULL,
    [DefaultClient] INT NULL,
    [PANGIR_No] VARCHAR(30) NULL,
    [primaryServer] VARCHAR(10) NULL,
    [Filler2] VARCHAR(10) NULL,
    [dbusername] VARCHAR(25) NULL,
    [dbPASSWORD] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIISIN_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIISIN_NEW]
(
    [Scrip_cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Valid] INT NULL,
    [EFF_FROM] DATETIME NOT NULL,
    [EFF_TO] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.N47817_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[N47817_TEST]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(15) NULL,
    [SERIES] VARCHAR(25) NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SQQTY] INT NULL,
    [processdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCMS_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[NCMS_PO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSE_DELIVERYCLT_MTF
-- --------------------------------------------------
CREATE TABLE [dbo].[NSE_DELIVERYCLT_MTF]
(
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [INOUT] VARCHAR(1) NOT NULL,
    [QTY] INT NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [PARTIPANTCODE] VARCHAR(15) NULL,
    [I_ISIN] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSE_Mtf_Report_New
-- --------------------------------------------------
CREATE TABLE [dbo].[NSE_Mtf_Report_New]
(
    [Srn] BIGINT NOT NULL,
    [NextDate] BIGINT NULL,
    [NextCash] BIGINT NULL,
    [ReportingDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [ExchangeSegment] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(10) NULL,
    [SERIES] VARCHAR(4) NULL,
    [BODQty] INT NULL,
    [BodValue] MONEY NULL,
    [DayBuyQty] INT NULL,
    [DayBuyValue] MONEY NULL,
    [DaySellQty] INT NULL,
    [DaySellValue] MONEY NULL,
    [EodQty] INT NULL,
    [EodValue] MONEY NULL,
    [EodAdjustValue] MONEY NULL,
    [EodCashCollateralDiff] MONEY NULL,
    [AdjBuyCash] MONEY NULL,
    [AdjSellCash] MONEY NULL,
    [ADJCashCollateral] MONEY NULL,
    [MtFLedgerBalance] MONEY NULL,
    [YesterdayCashCollateral] MONEY NULL,
    [CashCollateral] MONEY NULL,
    [PleadgedFlag] VARCHAR(10) NULL,
    [ClientAmount] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NSEFinal_report_13072021
-- --------------------------------------------------
CREATE TABLE [dbo].[NSEFinal_report_13072021]
(
    [SAUDA_DATE] VARCHAR(30) NULL,
    [MEMBERCODE] VARCHAR(15) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [PAN_GIR_NO] VARCHAR(50) NOT NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nsemtunapporved
-- --------------------------------------------------
CREATE TABLE [dbo].[nsemtunapporved]
(
    [scrip_cd] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OLDNEW
-- --------------------------------------------------
CREATE TABLE [dbo].[OLDNEW]
(
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OWNER_BKP_20220404
-- --------------------------------------------------
CREATE TABLE [dbo].[OWNER_BKP_20220404]
(
    [Company] VARCHAR(80) NOT NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(50) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(20) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [Style] INT NULL,
    [ExchangeCode] VARCHAR(3) NULL,
    [BrokerSebiRegNo] VARCHAR(15) NULL,
    [CounterPart] VARCHAR(15) NULL,
    [CP_SebiRegNo] VARCHAR(15) NULL,
    [state] VARCHAR(50) NULL,
    [panno] VARCHAR(50) NULL,
    [AutoGenPartyCode] INT NULL,
    [Fax] VARCHAR(25) NULL,
    [KRA_TYPE] VARCHAR(4) NULL,
    [POS_CODE] VARCHAR(15) NULL,
    [EMAIL] VARCHAR(50) NULL,
    [WEBSITE_ID] VARCHAR(100) NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(100) NULL,
    [COMPLIANCE_PHONE] VARCHAR(15) NULL,
    [SERVICES_TAXNO] VARCHAR(30) NULL,
    [CIN] VARCHAR(30) NULL,
    [COMMONSEBINO] VARCHAR(300) NULL,
    [COMMONMEMBERCODE] VARCHAR(300) NULL,
    [LOGO_FILE_PATH] VARCHAR(8000) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [SERVICE_DESCRIPTION] VARCHAR(100) NULL,
    [ACCOUNT_SERVICE_NO] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner_BKUP_22Nov2022
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner_BKUP_22Nov2022]
(
    [Company] VARCHAR(80) NOT NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(50) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(20) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [Style] INT NULL,
    [ExchangeCode] VARCHAR(3) NULL,
    [BrokerSebiRegNo] VARCHAR(15) NULL,
    [CounterPart] VARCHAR(15) NULL,
    [CP_SebiRegNo] VARCHAR(15) NULL,
    [state] VARCHAR(50) NULL,
    [panno] VARCHAR(50) NULL,
    [AutoGenPartyCode] INT NULL,
    [Fax] VARCHAR(25) NULL,
    [KRA_TYPE] VARCHAR(4) NULL,
    [POS_CODE] VARCHAR(15) NULL,
    [EMAIL] VARCHAR(50) NULL,
    [WEBSITE_ID] VARCHAR(100) NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(100) NULL,
    [COMPLIANCE_PHONE] VARCHAR(15) NULL,
    [SERVICES_TAXNO] VARCHAR(30) NULL,
    [CIN] VARCHAR(30) NULL,
    [COMMONSEBINO] VARCHAR(300) NULL,
    [COMMONMEMBERCODE] VARCHAR(300) NULL,
    [LOGO_FILE_PATH] VARCHAR(8000) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [SERVICE_DESCRIPTION] VARCHAR(100) NULL,
    [ACCOUNT_SERVICE_NO] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OWNER1
-- --------------------------------------------------
CREATE TABLE [dbo].[OWNER1]
(
    [Company] VARCHAR(80) NOT NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(50) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(20) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [Style] INT NULL,
    [ExchangeCode] VARCHAR(3) NULL,
    [BrokerSebiRegNo] VARCHAR(15) NULL,
    [CounterPart] VARCHAR(15) NULL,
    [CP_SebiRegNo] VARCHAR(15) NULL,
    [state] VARCHAR(50) NULL,
    [panno] VARCHAR(50) NULL,
    [AutoGenPartyCode] INT NULL,
    [Fax] VARCHAR(25) NULL,
    [KRA_TYPE] VARCHAR(4) NULL,
    [POS_CODE] VARCHAR(15) NULL,
    [EMAIL] VARCHAR(50) NULL,
    [WEBSITE_ID] VARCHAR(100) NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(100) NULL,
    [COMPLIANCE_PHONE] VARCHAR(15) NULL,
    [SERVICES_TAXNO] VARCHAR(30) NULL,
    [CIN] VARCHAR(30) NULL,
    [COMMONSEBINO] VARCHAR(300) NULL,
    [COMMONMEMBERCODE] VARCHAR(300) NULL,
    [LOGO_FILE_PATH] VARCHAR(8000) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [SERVICE_DESCRIPTION] VARCHAR(100) NULL,
    [ACCOUNT_SERVICE_NO] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.post
-- --------------------------------------------------
CREATE TABLE [dbo].[post]
(
    [party_code] VARCHAR(10) NOT NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(2) NULL,
    [bsecode] VARCHAR(6) NULL,
    [isin] VARCHAR(12) NULL,
    [cl_rate] NUMERIC(18, 4) NULL,
    [qty] INT NULL,
    [holdqty] INT NULL,
    [posqty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_mtf_awl
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_mtf_awl]
(
    [PAN] VARCHAR(50) NULL,
    [Scrip NAme] VARCHAR(50) NULL,
    [Concat] VARCHAR(50) NULL,
    [EOD Val] VARCHAR(50) NULL,
    [BOD Val] VARCHAR(50) NULL,
    [Diff] VARCHAR(50) NULL,
    [party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_mtf_cli_list
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_mtf_cli_list]
(
    [Party_code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_mtf_isin
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_mtf_isin]
(
    [scrip_cd] VARCHAR(12) NULL,
    [isin] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rcs_mtf_pos_2610
-- --------------------------------------------------
CREATE TABLE [dbo].[rcs_mtf_pos_2610]
(
    [Party_Code] VARCHAR(50) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [Series] VARCHAR(50) NULL,
    [BSE_code] VARCHAR(50) NULL,
    [IsIn] VARCHAR(50) NULL,
    [CLTDP] VARCHAR(50) NULL,
    [NSEPOS] VARCHAR(50) NULL,
    [BSEPOS] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBI_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBI_PO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SSSRS_MTF
-- --------------------------------------------------
CREATE TABLE [dbo].[SSSRS_MTF]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BALANCE] MONEY NULL,
    [EXCHANGE] VARCHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t_day
-- --------------------------------------------------
CREATE TABLE [dbo].[t_day]
(
    [Cltcode] VARCHAR(10) NOT NULL,
    [bal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_APP_DOCUMENTS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_APP_DOCUMENTS]
(
    [DOC_DESC] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_BSE_REPORTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_BSE_REPORTING]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Checking_MTFForCUSA
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Checking_MTFForCUSA]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [MTF_REQ] NUMERIC(38, 4) NULL,
    [CMBALANCE] NUMERIC(24, 4) NULL,
    [FOBALANCE] NUMERIC(22, 4) NULL,
    [CMDEBITHOLD] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD_APP] NUMERIC(18, 4) NULL,
    [MTFLEDBAL] NUMERIC(18, 4) NULL,
    [MTFCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL_APP] NUMERIC(18, 4) NULL,
    [CMLEDBAL] NUMERIC(18, 4) NULL,
    [FOLEDBAL] NUMERIC(18, 4) NULL,
    [FOCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL_APP] NUMERIC(18, 4) NULL,
    [FOCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOMARGIN] NUMERIC(18, 4) NULL,
    [POAHOLDING] NUMERIC(18, 4) NULL,
    [POAHOLDING_APP] NUMERIC(18, 4) NULL,
    [CASHDEBITADJ] NUMERIC(18, 4) NULL,
    [CASHNONCASHADJ] NUMERIC(18, 4) NULL,
    [FONONCASHADJ] NUMERIC(18, 4) NULL,
    [CASHLEDADJ] NUMERIC(18, 4) NULL,
    [FOLEDBALADJ] NUMERIC(18, 4) NULL,
    [POAADJ] NUMERIC(18, 4) NULL,
    [NET_MTF_REQ] NUMERIC(38, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLASS_IMPORT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLASS_IMPORT]
(
    [FLDFILENO] VARCHAR(2) NOT NULL,
    [FLDFILETYPE] VARCHAR(50) NULL,
    [FLDFILENAME] VARCHAR(10) NULL,
    [FLDPROCNAME] VARCHAR(50) NOT NULL,
    [FLDFILEFOR] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_D
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_D]
(
    [SAUDA_DATE] VARCHAR(11) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [OPENBUY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NULL,
    [ADDED_BY] VARCHAR(7) NOT NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_GENERIC_REPORT_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_GENERIC_REPORT_SETTING]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [RPT_NAME] VARCHAR(50) NULL,
    [RPT_NAME_DESC] VARCHAR(150) NULL,
    [RPT_FILENAME] VARCHAR(100) NULL,
    [RPT_FILE_GROUP] VARCHAR(20) NULL,
    [RPT_SEPARATOR] CHAR(1) NULL,
    [RPT_PROC_NAME] VARCHAR(50) NULL,
    [NO_OF_PARAMETER] VARCHAR(20) NULL,
    [FLDSELECTION] VARCHAR(100) NULL,
    [RPT_COMPANY_HEADER] INT NULL,
    [RPT_COLUMN_HEADER] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_LED_OTHER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_LED_OTHER]
(
    [VAMT] NUMERIC(18, 4) NULL,
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_manualsqof_mtf
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_manualsqof_mtf]
(
    [ID] BIGINT NULL,
    [DENSEID] BIGINT NULL,
    [party_code] VARCHAR(20) NULL,
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(100) NULL,
    [series] VARCHAR(10) NULL,
    [qty] INT NULL,
    [Cl_rate] MONEY NULL,
    [total] MONEY NULL,
    [exchange] VARCHAR(20) NULL,
    [sett_no] VARCHAR(20) NULL,
    [NET_DEBIT] DECIMAL(18, 2) NULL,
    [NET_DEBIT_ADJ] MONEY NULL,
    [SqQty] INT NULL,
    [CashSqup] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MTF_CTD_file
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MTF_CTD_file]
(
    [party_code] VARCHAR(10) NULL,
    [scrip] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [ISIN] VARCHAR(20) NULL,
    [releasedQty] INT NULL,
    [sourceDP] VARCHAR(8) NOT NULL,
    [Clientdp] VARCHAR(16) NOT NULL,
    [bankid] VARCHAR(8) NULL,
    [cltdpid] VARCHAR(20) NULL,
    [cl_type] VARCHAR(3) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_DATA]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [CURR_CL_RATE] NUMERIC(18, 4) NULL,
    [HAIRCUT] NUMERIC(18, 4) NULL,
    [MARGIN_REQ] NUMERIC(18, 4) NULL,
    [MTOM_LOSS] NUMERIC(18, 4) NULL,
    [FOMARGIN] NUMERIC(18, 4) NULL,
    [CMLEDBAL] NUMERIC(18, 4) NULL,
    [MTFLEDBAL] NUMERIC(18, 4) NULL,
    [FOLEDBAL] NUMERIC(18, 4) NULL,
    [CMCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD_MTF] NUMERIC(18, 4) NULL,
    [CMOPENPOS] NUMERIC(18, 4) NULL,
    [MTFCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [NET_AVL_FUND] NUMERIC(18, 4) NULL,
    [POAHOLDING] NUMERIC(18, 4) NULL,
    [POAHOLDING_MTF] NUMERIC(18, 4) NULL,
    [SELLSHORT] NUMERIC(18, 4) NULL,
    [CASHDEBITADJ] NUMERIC(18, 4) NULL,
    [CASHNONCASHADJ] NUMERIC(18, 4) NULL,
    [FONONCASHADJ] NUMERIC(18, 4) NULL,
    [CASHLEDADJ] NUMERIC(18, 4) NULL,
    [FOLEDBALADJ] NUMERIC(18, 4) NULL,
    [POAADJ] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_DATA_15
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_DATA_15]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [CURR_CL_RATE] NUMERIC(18, 4) NULL,
    [HAIRCUT] NUMERIC(18, 4) NULL,
    [MARGIN_REQ] NUMERIC(18, 4) NULL,
    [MTOM_LOSS] NUMERIC(18, 4) NULL,
    [FOMARGIN] NUMERIC(18, 4) NULL,
    [CMLEDBAL] NUMERIC(18, 4) NULL,
    [MTFLEDBAL] NUMERIC(18, 4) NULL,
    [FOLEDBAL] NUMERIC(18, 4) NULL,
    [CMCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD_MTF] NUMERIC(18, 4) NULL,
    [CMOPENPOS] NUMERIC(18, 4) NULL,
    [MTFCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [NET_AVL_FUND] NUMERIC(18, 4) NULL,
    [POAHOLDING] NUMERIC(18, 4) NULL,
    [POAHOLDING_MTF] NUMERIC(18, 4) NULL,
    [SELLSHORT] NUMERIC(18, 4) NULL,
    [CASHDEBITADJ] NUMERIC(18, 4) NULL,
    [CASHNONCASHADJ] NUMERIC(18, 4) NULL,
    [FONONCASHADJ] NUMERIC(18, 4) NULL,
    [CASHLEDADJ] NUMERIC(18, 4) NULL,
    [FOLEDBALADJ] NUMERIC(18, 4) NULL,
    [POAADJ] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_DATA_BUY
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_DATA_BUY]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [CURR_CL_RATE] NUMERIC(18, 4) NULL,
    [HAIRCUT] NUMERIC(18, 4) NULL,
    [MARGIN_REQ] NUMERIC(18, 4) NULL,
    [MTOM_LOSS] NUMERIC(18, 4) NULL,
    [FOMARGIN] NUMERIC(18, 4) NULL,
    [CMLEDBAL] NUMERIC(18, 4) NULL,
    [MTFLEDBAL] NUMERIC(18, 4) NULL,
    [FOLEDBAL] NUMERIC(18, 4) NULL,
    [CMCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD_MTF] NUMERIC(18, 4) NULL,
    [CMOPENPOS] NUMERIC(18, 4) NULL,
    [MTFCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [NET_AVL_FUND] NUMERIC(18, 4) NULL,
    [POAHOLDING] NUMERIC(18, 4) NULL,
    [POAHOLDING_MTF] NUMERIC(18, 4) NULL,
    [SELLSHORT] NUMERIC(18, 4) NULL,
    [CASHDEBITADJ] NUMERIC(18, 4) NULL,
    [CASHNONCASHADJ] NUMERIC(18, 4) NULL,
    [FONONCASHADJ] NUMERIC(18, 4) NULL,
    [CASHLEDADJ] NUMERIC(18, 4) NULL,
    [FOLEDBALADJ] NUMERIC(18, 4) NULL,
    [POAADJ] NUMERIC(18, 4) NULL,
    [ORG_HAIRCUT] NUMERIC(18, 4) NULL,
    [ORG_MARGIN_REQ] NUMERIC(18, 4) NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [PAYIN_DATE] DATETIME NULL,
    [EXCHANGE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_DATA_BUY_ALLOC_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_DATA_BUY_ALLOC_LOG]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [SCRIP_CD] VARCHAR(30) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(15) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [PAYIN_DATE] DATETIME NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [PAYIN_AMT] NUMERIC(18, 4) NULL,
    [PAYIN_AMT_BAL] NUMERIC(18, 4) NULL,
    [M_QTY] INT NULL,
    [M_PRICE] NUMERIC(18, 4) NULL,
    [M_AMT] NUMERIC(18, 4) NULL,
    [M_ALLOC_BALANCE] NUMERIC(18, 4) NULL,
    [NF_QTY] INT NULL,
    [NF_AMT] NUMERIC(18, 4) NULL,
    [SELL_BUY] INT NULL,
    [PROCESS_ON] DATETIME NULL,
    [PROCESS_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_DATA_BUY_TDAY_ALLOC
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_DATA_BUY_TDAY_ALLOC]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NOT NULL,
    [SCRIP_CD] VARCHAR(30) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(15) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [SETT_NO] VARCHAR(10) NULL,
    [PAYIN_DATE] DATETIME NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [PAYIN_AMT] NUMERIC(18, 4) NULL,
    [PAYIN_AMT_BAL] NUMERIC(18, 4) NULL,
    [M_QTY] INT NULL,
    [M_PRICE] NUMERIC(18, 4) NULL,
    [M_AMT] NUMERIC(18, 4) NULL,
    [M_ALLOC_BALANCE] NUMERIC(18, 4) NULL,
    [NF_QTY] INT NULL,
    [NF_AMT] NUMERIC(18, 4) NULL,
    [SELL_BUY] INT NULL,
    [COLL_QTY] INT NULL,
    [PROCESS_ON] DATETIME NULL,
    [PROCESS_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_DATA_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_DATA_LOG]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [CURR_CL_RATE] NUMERIC(18, 4) NULL,
    [HAIRCUT] NUMERIC(18, 4) NULL,
    [MARGIN_REQ] NUMERIC(18, 4) NULL,
    [MTOM_LOSS] NUMERIC(18, 4) NULL,
    [FOMARGIN] NUMERIC(18, 4) NULL,
    [CMLEDBAL] NUMERIC(18, 4) NULL,
    [MTFLEDBAL] NUMERIC(18, 4) NULL,
    [FOLEDBAL] NUMERIC(18, 4) NULL,
    [CMCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD_MTF] NUMERIC(18, 4) NULL,
    [CMOPENPOS] NUMERIC(18, 4) NULL,
    [MTFCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [NET_AVL_FUND] NUMERIC(18, 4) NULL,
    [POAHOLDING] NUMERIC(18, 4) NULL,
    [POAHOLDING_MTF] NUMERIC(18, 4) NULL,
    [SELLSHORT] NUMERIC(18, 4) NULL,
    [CASHDEBITADJ] NUMERIC(18, 4) NULL,
    [CASHNONCASHADJ] NUMERIC(18, 4) NULL,
    [FONONCASHADJ] NUMERIC(18, 4) NULL,
    [CASHLEDADJ] NUMERIC(18, 4) NULL,
    [FOLEDBALADJ] NUMERIC(18, 4) NULL,
    [POAADJ] NUMERIC(18, 4) NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_DATA_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_DATA_TEST]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [CURR_CL_RATE] NUMERIC(18, 4) NULL,
    [HAIRCUT] NUMERIC(18, 4) NULL,
    [MARGIN_REQ] NUMERIC(18, 4) NULL,
    [MTOM_LOSS] NUMERIC(18, 4) NULL,
    [FOMARGIN] NUMERIC(18, 4) NULL,
    [CMLEDBAL] NUMERIC(18, 4) NULL,
    [MTFLEDBAL] NUMERIC(18, 4) NULL,
    [FOLEDBAL] NUMERIC(18, 4) NULL,
    [CMCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [CMNONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD] NUMERIC(18, 4) NULL,
    [CMDEBITHOLD_MTF] NUMERIC(18, 4) NULL,
    [CMOPENPOS] NUMERIC(18, 4) NULL,
    [MTFCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [MTFNONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHEQCOLLATERAL] NUMERIC(18, 4) NULL,
    [FOCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL] NUMERIC(18, 4) NULL,
    [FONONCASHCOLLATERAL_MTF] NUMERIC(18, 4) NULL,
    [NET_AVL_FUND] NUMERIC(18, 4) NULL,
    [POAHOLDING] NUMERIC(18, 4) NULL,
    [POAHOLDING_MTF] NUMERIC(18, 4) NULL,
    [SELLSHORT] NUMERIC(18, 4) NULL,
    [CASHDEBITADJ] NUMERIC(18, 4) NULL,
    [CASHNONCASHADJ] NUMERIC(18, 4) NULL,
    [FONONCASHADJ] NUMERIC(18, 4) NULL,
    [CASHLEDADJ] NUMERIC(18, 4) NULL,
    [FOLEDBALADJ] NUMERIC(18, 4) NULL,
    [POAADJ] NUMERIC(18, 4) NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_EXCEPTION
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_EXCEPTION]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [EFF_FROM] DATETIME NULL,
    [EFF_TO] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_LOG]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FUNDING_DATE] DATETIME NULL,
    [PROCESS_START_DATE] DATETIME NULL,
    [PROCESS_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_mtf_log_0907
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_mtf_log_0907]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FUNDING_DATE] DATETIME NULL,
    [PROCESS_START_DATE] DATETIME NULL,
    [PROCESS_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_LOG_24062022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_LOG_24062022]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FUNDING_DATE] DATETIME NULL,
    [PROCESS_START_DATE] DATETIME NULL,
    [PROCESS_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_mtf_log_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_mtf_log_bak]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FUNDING_DATE] DATETIME NULL,
    [PROCESS_START_DATE] DATETIME NULL,
    [PROCESS_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_MARKING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_MARKING]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_mtf_marking_1509
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_mtf_marking_1509]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_mtf_marking_20220902
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_mtf_marking_20220902]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_MARKING_2211
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_MARKING_2211]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_MARKING_24062022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_MARKING_24062022]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_MARKING_SSRS_REPORT
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_MARKING_SSRS_REPORT]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [HOLDFLAG] VARCHAR(50) NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_MULTIPLIER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_MULTIPLIER]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [NONFNO] INT NULL,
    [FNO] INT NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL,
    [MTFCOLLVAR] INT NULL,
    [ADHOC_MARGIN] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_ORDER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_ORDER]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [UPLOAD_BY] VARCHAR(50) NULL,
    [UPLOAD_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_PROV_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_PROV_LOG]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FUNDING_DATE] DATETIME NULL,
    [PROCESS_START_DATE] DATETIME NULL,
    [PROCESS_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_RECO
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_RECO]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(12) NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [ISIN] VARCHAR(12) NULL,
    [CLTDPID] VARCHAR(17) NULL,
    [D_FLAG] VARCHAR(1) NULL,
    [NSEPOSQTY] INT NULL,
    [BSEPOSQTY] INT NULL,
    [FUTPAYINQTY] NUMERIC(38, 3) NULL,
    [FUTPAYOUTQTY] NUMERIC(38, 3) NULL,
    [NSEPOOLQTY] NUMERIC(38, 3) NULL,
    [BSEPOOLQTY] NUMERIC(38, 3) NULL,
    [DIFFQTY] NUMERIC(38, 3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTF_RECO_29072019
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTF_RECO_29072019]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(12) NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [ISIN] VARCHAR(12) NULL,
    [CLTDPID] VARCHAR(17) NULL,
    [D_FLAG] VARCHAR(1) NULL,
    [NSEPOSQTY] INT NULL,
    [BSEPOSQTY] INT NULL,
    [FUTPAYINQTY] NUMERIC(38, 3) NULL,
    [FUTPAYOUTQTY] NUMERIC(38, 3) NULL,
    [NSEPOOLQTY] NUMERIC(38, 3) NULL,
    [BSEPOOLQTY] NUMERIC(38, 3) NULL,
    [DIFFQTY] NUMERIC(38, 3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MTF_Shortage
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MTF_Shortage]
(
    [party_code] VARCHAR(10) NOT NULL,
    [MTFLEDBAL] NUMERIC(18, 4) NULL,
    [netledger] MONEY NULL,
    [Final_bal] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MTFHolding_Sqoff
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MTFHolding_Sqoff]
(
    [ORGBUYDATE] VARCHAR(20) NULL,
    [PROCESSDATE] VARCHAR(20) NULL,
    [EXCHANGE] VARCHAR(20) NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(5) NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [SCRIP_NAME] VARCHAR(100) NULL,
    [SCRIP_CD] VARCHAR(100) NULL,
    [SERIES] VARCHAR(10) NULL,
    [BSECODE] VARCHAR(20) NULL,
    [ISIN] VARCHAR(20) NULL,
    [QTY] INT NULL,
    [MARKETVALUE] MONEY NULL,
    [NETVALUE] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [MTOMLOSS] MONEY NULL,
    [MARG_REQ] MONEY NULL,
    [TOTAL_REQ] MONEY NULL,
    [OPENDAY] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTFREJECTCODE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTFREJECTCODE]
(
    [SAUDA_DATE] VARCHAR(11) NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [VDTLEDBAL] MONEY NULL,
    [RUNDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTR_OPEN_BALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTR_OPEN_BALANCE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [M_BODQTY] INT NULL,
    [M_BODVALUE] NUMERIC(38, 2) NULL,
    [M_FRESHBQTY] INT NULL,
    [M_FRESHBUY] NUMERIC(38, 2) NULL,
    [M_FRESHSQTY] INT NULL,
    [M_FRESHSELL] NUMERIC(38, 2) NULL,
    [M_NETQTY] INT NULL,
    [M_NETAMOUNT] NUMERIC(38, 2) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [ISIN] VARCHAR(15) NULL,
    [BSECODE] VARCHAR(10) NULL,
    [MARGIN_REQ] NUMERIC(20, 4) NULL,
    [PAYIN_AMT] NUMERIC(20, 4) NULL,
    [MTM_AMT] NUMERIC(20, 4) NULL,
    [PAYIN_AMT_BAL] NUMERIC(20, 4) NULL,
    [M_QTY] INT NULL,
    [M_PRICE] NUMERIC(20, 4) NULL,
    [M_AMT] NUMERIC(20, 4) NULL,
    [M_ALLOC_BALANCE] NUMERIC(20, 4) NULL,
    [NF_QTY] INT NULL,
    [NF_AMT] NUMERIC(20, 4) NULL,
    [COLL_QTY] INT NULL,
    [HAIRCUT] NUMERIC(20, 4) NULL,
    [PRO_PER] NUMERIC(20, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MTR_REPORTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MTR_REPORTING]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [M_BODQTY] INT NULL,
    [M_BODVALUE] NUMERIC(38, 2) NULL,
    [M_FRESHBQTY] INT NULL,
    [M_FRESHBUY] NUMERIC(38, 2) NULL,
    [M_FRESHSQTY] INT NULL,
    [M_FRESHSELL] NUMERIC(38, 2) NULL,
    [M_NETQTY] INT NULL,
    [M_NETAMOUNT] NUMERIC(38, 2) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [ISIN] VARCHAR(15) NULL,
    [BSECODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NSE_REPORTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NSE_REPORTING]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NSE_REPORTING_03122019
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NSE_REPORTING_03122019]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NSE_REPORTING_06122019
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NSE_REPORTING_06122019]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NSE_REPORTING_09DEC2019
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NSE_REPORTING_09DEC2019]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NSE_REPORTING_12122019
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NSE_REPORTING_12122019]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_NSE_REPORTING_15
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_NSE_REPORTING_15]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BODQTY] INT NULL,
    [BODVALUE] NUMERIC(38, 2) NULL,
    [FRESHBQTY] INT NULL,
    [FRESHBUY] NUMERIC(38, 2) NULL,
    [FRESHSQTY] INT NULL,
    [FRESHSELL] NUMERIC(38, 2) NULL,
    [NETQTY] INT NULL,
    [NETAMOUNT] NUMERIC(38, 2) NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_DATA]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_DATA_04032020_new
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_DATA_04032020_new]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_DATA_18062018
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_DATA_18062018]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_DATA_BK
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_DATA_BK]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_HOLD_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_HOLD_DATA]
(
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] CHAR(7) NOT NULL,
    [SETT_TYPE] CHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(16) NULL,
    [QTY] NUMERIC(38, 0) NULL,
    [SEC_PAYIN] DATETIME NULL,
    [START_DATE] DATETIME NULL,
    [ORGQTY] NUMERIC(38, 0) NULL,
    [HOLDFLAG] VARCHAR(20) NULL,
    [CL_RATE] NUMERIC(18, 4) NULL,
    [HAIRCUT] NUMERIC(18, 4) NULL,
    [FOGFLAG] INT NULL,
    [MTFHAIRCUT] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_HOLD_DATA_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_HOLD_DATA_HIST]
(
    [SRNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] CHAR(7) NOT NULL,
    [SETT_TYPE] CHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(16) NULL,
    [QTY] NUMERIC(38, 0) NULL,
    [SEC_PAYIN] DATETIME NULL,
    [START_DATE] DATETIME NULL,
    [ORGQTY] NUMERIC(38, 0) NULL,
    [HOLDFLAG] VARCHAR(20) NULL,
    [CL_RATE] NUMERIC(18, 4) NULL,
    [HAIRCUT] NUMERIC(18, 4) NULL,
    [FOGFLAG] INT NULL,
    [MTFHAIRCUT] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_LED_ADJUST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_LED_ADJUST]
(
    [SAUDA_DATE] DATETIME NOT NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [AMOUNT] MONEY NULL,
    [FOAMOUNT] NUMERIC(38, 4) NULL,
    [MTFAMOUNT] NUMERIC(38, 4) NULL,
    [MTFCASHAMOUNT] NUMERIC(38, 4) NULL,
    [INTERNALAMOUNT] NUMERIC(38, 4) NULL,
    [ADJAMT] NUMERIC(18, 4) NULL,
    [MTFTOCASHJV] NUMERIC(18, 4) NULL,
    [MTFTOFOJV] NUMERIC(18, 4) NULL,
    [MTFNONCASHADJ] NUMERIC(18, 4) NULL,
    [PROCESS_DATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POS_ADJUST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POS_ADJUST]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POS_ADJUST_07012021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POS_ADJUST_07012021]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_product_pos_adjust_2701
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_product_pos_adjust_2701]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POS_ADJUST_BAK_05022019_Renamed_By_DBA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POS_ADJUST_BAK_05022019_Renamed_By_DBA]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POS_ADJUST_BKP_09MAR2023
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POS_ADJUST_BKP_09MAR2023]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POS_ADJUST_BUY
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POS_ADJUST_BUY]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL,
    [NETAMT] NUMERIC(18, 4) NULL,
    [cl_rate] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POS_ADJUST_LED
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POS_ADJUST_LED]
(
    [SAUDA_DATE] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(2) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NOT NULL,
    [NETAMT] NUMERIC(18, 4) NULL,
    [MTFVAR] NUMERIC(18, 4) NULL,
    [CL_RATE] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_04032020
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_04032020]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_04032020_2
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_04032020_2]
(
    [SNO] INT NOT NULL,
    [SAUDA_DATE] SMALLDATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] SMALLDATETIME NULL,
    [ADJUST_DATE] SMALLDATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] SMALLDATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_04032020_new
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_04032020_new]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_BAK_04032020_OLD
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_BAK_04032020_OLD]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_BAK_3007
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_BAK_3007]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_CHECK
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_CHECK]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [ORGSNO] BIGINT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [trade_no] VARCHAR(20) NULL,
    [order_no] VARCHAR(20) NULL,
    [UPDFLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_CHECK_04032020_new
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_CHECK_04032020_new]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [ORGSNO] INT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [trade_no] VARCHAR(20) NULL,
    [order_no] VARCHAR(20) NULL,
    [UPDFLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_CHECK_Bak_04022022
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_CHECK_Bak_04022022]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [ORGSNO] INT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [trade_no] VARCHAR(20) NULL,
    [order_no] VARCHAR(20) NULL,
    [UPDFLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_CHECK_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_CHECK_TEMP]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [ORGSNO] INT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [trade_no] VARCHAR(20) NULL,
    [order_no] VARCHAR(20) NULL,
    [UPDFLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_DoNotDelete_12042025
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_DoNotDelete_12042025]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_HDFC
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_HDFC]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_IRCTC_30102021
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_IRCTC_30102021]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_IRCTC_30102021_sauda_Date
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_IRCTC_30102021_sauda_Date]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_LAURUSLABS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_LAURUSLABS]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_TEST]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_PRODUCT_POSITION_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_PRODUCT_POSITION_TMP]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [SAUDA_DATE] DATETIME NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_Type] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [PRODUCT_CODE] VARCHAR(20) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [Sell_Buy] INT NOT NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [MKTAMT] MONEY NULL,
    [NETAMT] MONEY NULL,
    [CL_RATE] MONEY NULL,
    [PAYIN_DATE] DATETIME NULL,
    [ADJUST_DATE] DATETIME NOT NULL,
    [TRANSTYPE] VARCHAR(5) NOT NULL,
    [PROCESSDATE] DATETIME NOT NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [Order_No] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblClientMargin
-- --------------------------------------------------
CREATE TABLE [dbo].[TblClientMargin]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Margin_Funding] NUMERIC(18, 0) NOT NULL,
    [Margin_interest] NUMERIC(18, 4) NULL,
    [Sanctioned_Amt] NUMERIC(18, 0) NOT NULL,
    [Max_Amt] NUMERIC(18, 0) NOT NULL,
    [Min_Cover] NUMERIC(18, 0) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL,
    [Entered_By] VARCHAR(50) NOT NULL,
    [Entered_Date] DATETIME NOT NULL,
    [Auto_Rms] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(100) NULL,
    [DOC_TYPE] VARCHAR(200) NULL,
    [FY_DOC] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblClientMargin_Maker_Checker
-- --------------------------------------------------
CREATE TABLE [dbo].[TblClientMargin_Maker_Checker]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Margin_Funding] NUMERIC(18, 0) NOT NULL,
    [Margin_interest] NUMERIC(18, 4) NULL,
    [Sanctioned_Amt] NUMERIC(18, 0) NOT NULL,
    [Max_Amt] NUMERIC(18, 0) NOT NULL,
    [Min_Cover] NUMERIC(18, 0) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL,
    [Entered_By] VARCHAR(50) NOT NULL,
    [Entered_Date] DATETIME NOT NULL,
    [Auto_Rms] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(100) NULL,
    [DOC_TYPE] VARCHAR(200) NULL,
    [FY_DOC] VARCHAR(10) NULL,
    [RecStatus] VARCHAR(1) NULL,
    [RecType] VARCHAR(10) NULL,
    [RecClose] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblClientMargin_Maker_Checker_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TblClientMargin_Maker_Checker_LOG]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Margin_Funding] NUMERIC(18, 0) NOT NULL,
    [Margin_interest] NUMERIC(18, 4) NULL,
    [Sanctioned_Amt] NUMERIC(18, 0) NOT NULL,
    [Max_Amt] NUMERIC(18, 0) NOT NULL,
    [Min_Cover] NUMERIC(18, 0) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL,
    [Entered_By] VARCHAR(50) NOT NULL,
    [Entered_Date] DATETIME NOT NULL,
    [Auto_Rms] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(100) NULL,
    [DOC_TYPE] VARCHAR(200) NULL,
    [FY_DOC] VARCHAR(10) NULL,
    [RecStatus] VARCHAR(1) NULL,
    [RecType] VARCHAR(10) NULL,
    [RecClose] VARCHAR(1) NULL,
    [APPROVED_BY] VARCHAR(50) NULL,
    [APPROVED_ON] DATETIME NULL,
    [APP_REMARKS] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TblClientMargin_New
-- --------------------------------------------------
CREATE TABLE [dbo].[TblClientMargin_New]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Margin_Funding] NUMERIC(18, 0) NOT NULL,
    [Margin_interest] NUMERIC(18, 4) NULL,
    [Sanctioned_Amt] NUMERIC(18, 0) NOT NULL,
    [Max_Amt] NUMERIC(18, 0) NOT NULL,
    [Min_Cover] NUMERIC(18, 0) NOT NULL,
    [From_Date] DATETIME NOT NULL,
    [To_Date] DATETIME NOT NULL,
    [Entered_By] VARCHAR(50) NOT NULL,
    [Entered_Date] DATETIME NOT NULL,
    [Auto_Rms] VARCHAR(10) NULL,
    [REMARKS] VARCHAR(100) NULL,
    [DOC_TYPE] VARCHAR(200) NULL,
    [FY_DOC] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLSCRIPMARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLSCRIPMARGIN]
(
    [scrip_cd] VARCHAR(12) NULL,
    [from_date] DATETIME NULL,
    [to_date] DATETIME NULL,
    [entered_by] VARCHAR(50) NULL,
    [entered_date] DATETIME NOT NULL,
    [Series] VARCHAR(3) NULL,
    [BseCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_Group] VARCHAR(2) NULL,
    [FUND_PER] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLSCRIPMARGIN_BKP_20220308_CADILAHC_TO_ZYDUSLIFE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLSCRIPMARGIN_BKP_20220308_CADILAHC_TO_ZYDUSLIFE]
(
    [scrip_cd] VARCHAR(12) NULL,
    [from_date] DATETIME NULL,
    [to_date] DATETIME NULL,
    [entered_by] VARCHAR(50) NULL,
    [entered_date] DATETIME NOT NULL,
    [Series] VARCHAR(3) NULL,
    [BseCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_Group] VARCHAR(2) NULL,
    [FUND_PER] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLSCRIPMARGIN_BKP_20221206_LTI_TO_LTIM
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLSCRIPMARGIN_BKP_20221206_LTI_TO_LTIM]
(
    [scrip_cd] VARCHAR(12) NULL,
    [from_date] DATETIME NULL,
    [to_date] DATETIME NULL,
    [entered_by] VARCHAR(50) NULL,
    [entered_date] DATETIME NOT NULL,
    [Series] VARCHAR(3) NULL,
    [BseCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_Group] VARCHAR(2) NULL,
    [FUND_PER] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLSCRIPMARGIN_BKP_20230313_CLNINDIA_TO_HEUBACHIND
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLSCRIPMARGIN_BKP_20230313_CLNINDIA_TO_HEUBACHIND]
(
    [scrip_cd] VARCHAR(12) NULL,
    [from_date] DATETIME NULL,
    [to_date] DATETIME NULL,
    [entered_by] VARCHAR(50) NULL,
    [entered_date] DATETIME NOT NULL,
    [Series] VARCHAR(3) NULL,
    [BseCode] VARCHAR(50) NULL,
    [ISIN] VARCHAR(20) NULL,
    [Scrip_Group] VARCHAR(2) NULL,
    [FUND_PER] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMPLEDGER2
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMPLEDGER2]
(
    [category] VARCHAR(20) NULL,
    [branch] VARCHAR(25) NULL,
    [paidamt] MONEY NULL,
    [vtype] VARCHAR(2) NULL,
    [vno] VARCHAR(25) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [costcode] INT NULL,
    [booktype] CHAR(2) NULL,
    [sessionid] VARCHAR(15) NULL,
    [party_code] VARCHAR(25) NULL,
    [costflag] CHAR(1) NULL,
    [rowid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temposnew
-- --------------------------------------------------
CREATE TABLE [dbo].[temposnew]
(
    [party_code] VARCHAR(10) NOT NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [bsecode] VARCHAR(6) NULL,
    [isin] VARCHAR(12) NULL,
    [qty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMP_S
-- --------------------------------------------------
CREATE TABLE [dbo].[TMP_S]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [L1_SRNO] VARCHAR(5) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [VDT] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL,
    [EDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [LNO] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMPPOS
-- --------------------------------------------------
CREATE TABLE [dbo].[TMPPOS]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL,
    [QTYOPEN] INT NULL,
    [closeqty] INT NULL,
    [closeamt] NUMERIC(18, 4) NULL,
    [CUROPENQTY] INT NULL,
    [CUROPENAMT] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmpposdata
-- --------------------------------------------------
CREATE TABLE [dbo].[tmpposdata]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [BSECODE] VARCHAR(6) NULL,
    [ISIN] VARCHAR(12) NULL,
    [QTY] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMPPOSNEW
-- --------------------------------------------------
CREATE TABLE [dbo].[TMPPOSNEW]
(
    [party_code] VARCHAR(10) NULL,
    [isin] VARCHAR(12) NULL,
    [qtyclose] INT NULL,
    [qtyopen] INT NULL,
    [qty] INT NULL,
    [amount] NUMERIC(18, 4) NULL,
    [newamount] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Unpleadge_PO
-- --------------------------------------------------
CREATE TABLE [dbo].[Unpleadge_PO]
(
    [ProcessDateTime] DATETIME NULL,
    [Cltcode] VARCHAR(10) NULL,
    [VBal] MONEY NULL,
    [UCV] MONEY NULL,
    [UnRecoCr] MONEY NULL,
    [OtherDr] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_UPLOADED_FILES]
(
    [u_sno] INT IDENTITY(1,1) NOT NULL,
    [u_filename] VARCHAR(500) NULL,
    [u_pathname] VARCHAR(500) NULL,
    [u_records] INT NULL,
    [u_status] VARCHAR(2) NULL,
    [u_date] DATETIME NULL,
    [u_uname] VARCHAR(60) NULL,
    [u_module] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.valanaccount
-- --------------------------------------------------
CREATE TABLE [dbo].[valanaccount]
(
    [AcCode] VARCHAR(10) NULL,
    [AcName] VARCHAR(50) NULL,
    [Reversed] INT NULL,
    [RevCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.tr_mtf_ctd_status
-- --------------------------------------------------

CREATE TRIGGER [dbo].[tr_mtf_ctd_status] on
[dbo].[mtf_ctd_status] AFTER INSERT
as
Begin
	if exists(select * from inserted where cast(processdate as date)=CAST(GETDATE() as date) and recordcount>0)
	begin
		--insert into MTF_test_12dec2023(processdate,recordcnt)
		--select GETDATE(),1200

		  declare @StatusJob varchar(20)                               
		  set @StatusJob=''             
		  exec dbo.Get_JoBStatus 'MTF CTD File',@StatusJob  output                               
		  print @StatusJob                      
                      
                      
		  if(@StatusJob='In Progress')                                
		   print 'job is already running'                            
		  else                        
		   EXEC msdb.dbo.sp_start_job N'MTF CTD File' 
		 
	end

end

GO

-- --------------------------------------------------
-- VIEW dbo.acmast
-- --------------------------------------------------



CREATE  VIEW [dbo].[acmast]  

AS  

SELECT * FROM ACCOUNT.DBO.ACMAST(NOLOCK)  

--UNION ALL

--SELECT   * FROM ACCOUNT_AB.DBO.ACMAST B (NOLOCK) 

--WHERE NOT EXISTS (SELECT CLTCODE FROM ACCOUNT.DBO.ACMAST N (NOLOCK) 

--				  WHERE N.CLTCODE = B.CLTCODE)

GO

-- --------------------------------------------------
-- VIEW dbo.acmast_M
-- --------------------------------------------------



CREATE  VIEW [dbo].[acmast_M]  

AS  

SELECT * FROM ACCOUNT.DBO.ACMAST(NOLOCK)  

--UNION ALL

--SELECT   * FROM AngelBSECM.ACCOUNT_AB.DBO.ACMAST B (NOLOCK) 

--WHERE NOT EXISTS (SELECT CLTCODE FROM ACCOUNT.DBO.ACMAST N (NOLOCK) 

--				  WHERE N.CLTCODE = B.CLTCODE)

GO

-- --------------------------------------------------
-- VIEW dbo.AUDIT_MARGIN_VIEW
-- --------------------------------------------------


CREATE VIEW [dbo].[AUDIT_MARGIN_VIEW]

AS

SELECT PARTY_CODE,MARGIN_DATE as MDATE,MARGIN=CASE WHEN MTOM < 0 THEN ABS(MTOM) ELSE 0 END + VARAMT FROM MSAJAG.DBO.TBL_MG02

GO

-- --------------------------------------------------
-- VIEW dbo.BILLPOSTED
-- --------------------------------------------------
CREATE VIEW BILLPOSTED
AS
SELECT * FROM ACCOUNT..BILLPOSTED WHERE 1 = 2

GO

-- --------------------------------------------------
-- VIEW dbo.CBO_TB_ENTITYMASTER
-- --------------------------------------------------

CREATE VIEW [dbo].[CBO_TB_ENTITYMASTER]
AS

SELECT ENT_CODE = CL_CODE, ENT_NAME = LONG_NAME, ENT_TYPE = 'CLIENT'
FROM MSAJAG.DBO.CLIENT1 C1, TBLCLIENTMARGIN C
WHERE C.PARTY_CODE = C1.CL_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.MTF_Avilable_Cash
-- --------------------------------------------------
CREATE View MTF_Avilable_Cash    
as    
select party_code, Available_Cash_bal=sum(netamt) +max(MtfLedbal),Sum(Margin_req) Margin_req,sauda_date     
from TBL_MTF_DATA (Nolock) where sauda_Date =(select max(sauda_date) from TBL_MTF_DATA (Nolock))      
group by party_code,sauda_date

GO

-- --------------------------------------------------
-- VIEW dbo.MTF_CASH_BILL
-- --------------------------------------------------
CREATE VIEW [MTF_CASH_BILL]
AS 
SELECT * 
FROM LEDGER 
WHERE VTYP = 35

GO

-- --------------------------------------------------
-- VIEW dbo.MTF_CASH_JV
-- --------------------------------------------------
CREATE VIEW [MTF_CASH_JV]
AS 
SELECT * 
FROM LEDGER 
WHERE VTYP = 8

GO

-- --------------------------------------------------
-- VIEW dbo.mtf_SQUP_DETAILS
-- --------------------------------------------------

CREATE VIEW [dbo].[mtf_SQUP_DETAILS]    
AS    
---select * FROM N47817_TEST  WITH (NOLOCK)  
SELECT *  FROM [CSOKYC-6].General.DBO.vw_mtf_ageing_scripwise WITH (NOLOCK)  
---where party_code = 'ANUH1034'

GO

-- --------------------------------------------------
-- VIEW dbo.MTF_STATUS
-- --------------------------------------------------
CREATE VIEW MTF_STATUS 
AS
SELECT Party_Code,FROM_DATE,MTFSTATUS =(CASE WHEN To_Date > GETDATE() THEN 'Y' ELSE 'N' END)
FROM TblClientMargin

GO

-- --------------------------------------------------
-- VIEW dbo.OWNER
-- --------------------------------------------------
CREATE VIEW [dbo].[OWNER]
AS
SELECT * FROM MSAJAG.DBO.OWNER

GO

-- --------------------------------------------------
-- VIEW dbo.parameter
-- --------------------------------------------------
CREATE view [dbo].[parameter]
as
select * from account.dbo.parameter

GO

-- --------------------------------------------------
-- VIEW dbo.TBL_ISIN_LIMIT
-- --------------------------------------------------
CREATE VIEW [dbo].[TBL_ISIN_LIMIT]
AS

SELECT ISIN,FROMDATE=FROM_DATE,TODATE=TO_DATE,QTY_LIMIT=0,FUNDING_PER=FUND_PER,REMARK='',ADDED_BY=entered_by,ADDED_ON=entered_date
FROM TBLSCRIPMARGIN

GO

-- --------------------------------------------------
-- VIEW dbo.vmast
-- --------------------------------------------------

CREATE view [dbo].[vmast]

as

select * from account.dbo.vmast
union all
select vtype = 35, 'MTF BILL', 'BILL', 'N', ''
WHERE 35 NOT IN (SELECT VTYPE FROM account.dbo.vmast)

GO

-- --------------------------------------------------
-- VIEW dbo.VW_MTF_POSITION
-- --------------------------------------------------
CREATE VIEW VW_MTF_POSITION
AS

SELECT SAUDA_DATE,SETT_tYPE = (CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END), PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,
ISIN,QTY=SUM(QTY),MKTAMT=SUM(MKTAMT),NETAMT=SUM(NETAMT),ADJUST_DATE,TRANSTYPE 
from TBL_PRODUCT_POSITION 
WHERE SAUDA_DATE < 'AUG  9 2017'
group by SAUDA_DATE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,
ISIN,ADJUST_DATE,TRANSTYPE 

UNION ALL

SELECT SAUDA_DATE,SETT_tYPE = (CASE WHEN TRANSTYPE = 'TRNSE' THEN 'N' ELSE 'D' END), PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,
ISIN,QTY=SUM(QTY),MKTAMT=SUM(MKTAMT),NETAMT=CONVERT(NUMERIC(18,4),ROUND(SUM(NETAMT),2)),ADJUST_DATE,TRANSTYPE
from TBL_PRODUCT_POSITION 
WHERE SAUDA_DATE >='AUG  9 2017'
group by SAUDA_DATE,PARTY_CODE,PRODUCT_CODE,SCRIP_CD,SERIES,BSECODE,Sell_Buy,
ISIN,ADJUST_DATE,TRANSTYPE

GO

-- --------------------------------------------------
-- VIEW dbo.VW_PRODUCT_POSITION
-- --------------------------------------------------

CREATE VIEW [dbo].[VW_PRODUCT_POSITION]  
AS  
SELECT     SAUDA_DATE, Sett_No, Sett_Type, PARTY_CODE, PRODUCT_CODE, SCRIP_CD, 
		   SERIES=(CASE WHEN SERIES IN ('BE','EQ','BZ') THEN 'EQ' ELSE SERIES END), 
		   BSECODE, Sell_Buy, ISIN, SUM(QTY) AS QTY, SUM(MKTAMT) AS MKTAMT, SUM(NETAMT) AS NETAMT,   
                      ADJUST_DATE, TRANSTYPE  
FROM         dbo.TBL_PRODUCT_POSITION 
GROUP BY SAUDA_DATE, Sett_No, Sett_Type, PARTY_CODE, PRODUCT_CODE, SCRIP_CD, SERIES, BSECODE, 
Sell_Buy, ISIN, ADJUST_DATE, TRANSTYPE

GO

-- --------------------------------------------------
-- VIEW dbo.VW_WEEKLY_MARGIN
-- --------------------------------------------------




CREATE VIEW [dbo].[VW_WEEKLY_MARGIN]
AS
	SELECT PARTY_CODE, MARGINDATE = SAUDA_DATE, MARGIN_AMOUNT = SUM(-MARGIN_REQ) + SUm (-MTOM_LOSS)
	FROM TBL_MTF_DATA
	GROUP BY PARTY_CODE, SAUDA_DATE

GO

