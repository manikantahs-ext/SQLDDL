-- DDL Export
-- Server: 10.253.78.163
-- Database: HelpDesk
-- Exported: 2026-02-05T12:29:58.794013

USE HelpDesk;
GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.function_AddBreak
-- --------------------------------------------------
CREATE function dbo.[function_AddBreak] --('suggestion','complaint_table')     
(      
 @Column VARCHAR(30),    
 @tablename VARCHAR(30)     
)      
RETURNS @output TABLE(data VARCHAR(256))      
BEGIN      
declare @string VARCHAR(1000)  
--declare @Column VARCHAR(1000)
--declare @tablename VARCHAR(1000)
--set @Column='B'
--set @tablename ='A'
declare @callre VARCHAR(1000)

select top 1 @callre= suggestion from complaint_table 
--print @string  
 declare @str as varchar(1000)    
    DECLARE @start INT, @end INT      
    
 set @str = ''    
     
    set @start = 0    
 set @end = (select len(@string)/3)    
      
    WHILE @start < LEN(@string) + 1 BEGIN      
        IF @end = 0       
            SET @end = LEN(@string) + 1      
      
  set @str = @str+'  '+SUBSTRING(@callre, @start, @end)    
       
      
        SET @start = @end + @start              
    END     
    
 INSERT INTO @output(data)       
        VALUES(@str)      
     
    RETURN      
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.function_string_to_table
-- --------------------------------------------------

CREATE FUNCTION [dbo].[function_string_to_table]
(
    @string VARCHAR(1000),
    @delimiter CHAR(1)
)
RETURNS @output TABLE(data VARCHAR(256))
BEGIN

    DECLARE @start INT, @end INT
    SELECT @start = 1, @end = CHARINDEX(@delimiter, @string)

    WHILE @start < LEN(@string) + 1 BEGIN
        IF @end = 0 
            SET @end = LEN(@string) + 1
        INSERT INTO @output(data) 
        VALUES(SUBSTRING(@string, @start, @end - @start))
        SET @start = @end + 1
        SET @end = CHARINDEX(@delimiter, @string, @start)
    END
    RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FX_DIRTextFileUpload
-- --------------------------------------------------
CREATE FUNCTION FX_DIRTextFileUpload(@date datetime)    
RETURNS varchar(500)     
AS    
begin     
    DECLARE @Var varchar(500)    
 DECLARE @Variable  varchar(500)    
 DECLARE @Variable1  varchar(700)    
    declare @count varchar(50)    
    set @count= (Select Count(branch+' - '+manager) from tbl_DIRTextFileUpload(nolock)     
where Fld_UploadTime = convert(datetime,convert(varchar(11),@date,103),103) and     
branch+manager+folder+[date]+time+ampm+filesize+filename not in    
(select branch+manager+folder+[date]+time+ampm+filesize+filename     
from tbl_DIRTextFileUpload(nolock) where Fld_UploadTime = convert(datetime,convert(varchar(11),@date-1,103),103) and     
manager in (select manager from tbl_DIRTextFileUpload(nolock)     
where Fld_UploadTime = convert(datetime,convert(varchar(11),@date-1,103),103))))    
    
--print @count    
    --select @count= count(branch+' - '+manager) from tbl_DIRTextFileUpload where Fld_UploadTime =convert(varchar(11),getdate(),103) and branch+manager+folder+[date]+time+ampm+filesize+filename not in(select branch+manager+folder+[date]+time+ampm+filesize+filename from tbl_DIRTextFileUpload where Fld_UploadTime = convert(varchar(11),getdate()-1,103)) and manager in (select manager from tbl_DIRTextFileUpload where Fld_UploadTime = convert(varchar(11),getdate()-1,103))     
    if @count <> 0    
begin    
 DECLARE ConRecords CURSOR     
 FOR     
Select distinct branch+' - '+manager from tbl_DIRTextFileUpload(nolock)     
where Fld_UploadTime = convert(datetime,convert(varchar(11),@date,103),103) and     
branch+manager+folder+[date]+time+ampm+filesize+filename not in    
(select branch+manager+folder+[date]+time+ampm+filesize+filename     
from tbl_DIRTextFileUpload(nolock) where Fld_UploadTime = convert(datetime,convert(varchar(11),@date-1,103),103) and     
manager in (select manager from tbl_DIRTextFileUpload(nolock)     
where Fld_UploadTime = convert(datetime,convert(varchar(11),@date-1,103),103)))    
    
    OPEN ConRecords      
 FETCH NEXT FROM ConRecords INTO @Variable     
 set @Variable1 = @Variable    
 WHILE @@FETCH_STATUS <> -1    
 BEGIN     
 FETCH NEXT FROM ConRecords INTO @Variable     
 set @Variable1 = @Variable1+','+@Variable    
 END     
 CLOSE ConRecords     
 DEALLOCATE ConRecords    
 select @var=left(@Variable1,len(@Variable1)-6)    
    --select @var= manager from tbl_DIRTextFileUpload where fld_srno='1'    
     
end    
return @var    
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.fx_SumTwoValues
-- --------------------------------------------------
CREATE FUNCTION fx_SumTwoValues
( @Val1 int, @Val2 int )
RETURNS int
AS
BEGIN
  RETURN (@Val1+@Val2)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Get_Check
-- --------------------------------------------------
CREATE function Get_Check(@AssetCode as varchar(50))    
 RETURNS int     
 As    
 BEGIN    
 Declare @val int;  
    
 Select @val = count(1) from tbl_itassetsdata(nolock) where Fld_AssetTag = @AssetCode  
    
 RETURN @val;    
 END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetDays
-- --------------------------------------------------

CREATE FUNCTION [dbo].[GetDays]
(@Start datetime, 
@Stop datetime)  

RETURNS TABLE AS RETURN  
WITH Numbers (N) AS 
(  
SELECT 1 UNION ALL  
SELECT 1 + N FROM Numbers  
WHERE N < DATEDIFF(day,@Start,@Stop)+1  
)  
SELECT DATEADD(day,N-1,@Start) Date FROM Numbers

GO

-- --------------------------------------------------
-- FUNCTION dbo.Value
-- --------------------------------------------------
CREATE Function Value(@ipfrom varchar(15),@ipto varchar(15))   
RETURNS TABLE  
AS  
RETURN (select a,b,c from   
(select substring(right(@ipfrom,4),charindex('.',right(@ipfrom,4))+1,3) as A,substring(@ipfrom,1,len(@ipfrom)-charindex('.',reverse(@ipfrom)))+'.' as c) x  
left outer join  
(select substring(right(@ipto,4),charindex('.',right(@ipto,4))+1,3) as b ) y on x.a = x.a  
)

GO

-- --------------------------------------------------
-- INDEX dbo.department_master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Dept_ID] ON [dbo].[department_master] ([Dept_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.OphelpdeskTAT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_stat_flag] ON [dbo].[OphelpdeskTAT] ([stat_flag], [complaint_id], [OpTAT], [tat])

GO

-- --------------------------------------------------
-- INDEX dbo.query_type
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Idx_fld_srno] ON [dbo].[query_type] ([Fld_Srno])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_complaint
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idx_cmpid_status] ON [dbo].[tbl_complaint] ([Status]) INCLUDE ([Sr_Num], [Dept_ID], [Complaint_ID], [Query_Type], [Subject], [Access_code], [Complaint_Date], [Fld_EntryBy], [clt_subdetl])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_complaint
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_Fld_Entry] ON [dbo].[tbl_complaint] ([Sr_Num])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_complaint
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_sr_num] ON [dbo].[tbl_complaint] ([Sr_Num], [Complaint_ID], [Subject])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_dept_mapping
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_Fld_EmpID] ON [dbo].[tbl_dept_mapping] ([Fld_EmpID], [Fld_DeptID])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_hr_complaint_master_new
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IX_fld_complaint_date] ON [dbo].[tbl_hr_complaint_master_new] ([Fld_Complaint_date])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_hr_complaint_master_new
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Fld_Complaint_No] ON [dbo].[tbl_hr_complaint_master_new] ([Fld_Complaint_No])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_hr_complaint_master_new
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Fld_Emp_Code] ON [dbo].[tbl_hr_complaint_master_new] ([Fld_Emp_Code], [Fld_Status])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_IT_Br_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_brCode] ON [dbo].[Tbl_IT_Br_Master] ([Br_Tag], [Br_Region])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_ITRequestMaster
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [tx_RqMaster] ON [dbo].[tbl_ITRequestMaster] ([Fld_RequestId], [Fld_AssetType])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_ITRequestType
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_RqType] ON [dbo].[tbl_ITRequestType] ([Fld_Id], [Fld_RequestName], [Fld_RequestStatus])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_ups_count_details
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_Fld_Branch_Code] ON [dbo].[tbl_ups_count_details] ([Fld_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_ups_count_details
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_Fld_Date] ON [dbo].[tbl_ups_count_details] ([Fld_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_ups_count_details
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ix_fld_srno] ON [dbo].[tbl_ups_count_details] ([Fld_SrNo])

GO

-- --------------------------------------------------
-- INDEX dbo.Terminal_Brok_Loss
-- --------------------------------------------------
CREATE CLUSTERED INDEX [ind_sauda_date] ON [dbo].[Terminal_Brok_Loss] ([Sauda_date])

GO

-- --------------------------------------------------
-- INDEX dbo.terminals
-- --------------------------------------------------
CREATE CLUSTERED INDEX [server] ON [dbo].[terminals] ([Server], [Segment])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Calendar
-- --------------------------------------------------
ALTER TABLE [dbo].[Calendar] ADD CONSTRAINT [PK_Calendar] PRIMARY KEY ([gc_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Cat_mast
-- --------------------------------------------------
ALTER TABLE [dbo].[Cat_mast] ADD CONSTRAINT [srno_pk] PRIMARY KEY ([sr_no])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CHAPTER
-- --------------------------------------------------
ALTER TABLE [dbo].[CHAPTER] ADD CONSTRAINT [PK__CHAPTER__7CC0C7244937B697] PRIMARY KEY ([BOOK_ISBN], [IDX])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.CONTACTS
-- --------------------------------------------------
ALTER TABLE [dbo].[CONTACTS] ADD CONSTRAINT [PK_CONTACTS] PRIMARY KEY ([OCS_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Journal
-- --------------------------------------------------
ALTER TABLE [dbo].[Journal] ADD CONSTRAINT [PK_Journal] PRIMARY KEY ([gc_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.MailAttachment
-- --------------------------------------------------
ALTER TABLE [dbo].[MailAttachment] ADD CONSTRAINT [PK_MailAttachment] PRIMARY KEY ([gc_parent_guid], [gc_attach_number])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Notes
-- --------------------------------------------------
ALTER TABLE [dbo].[Notes] ADD CONSTRAINT [PK_Notes] PRIMARY KEY ([gc_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.QA_Att_title_master
-- --------------------------------------------------
ALTER TABLE [dbo].[QA_Att_title_master] ADD CONSTRAINT [PK_QA_Att_title_master] PRIMARY KEY ([Srno])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.QA_survey_ANS2
-- --------------------------------------------------
ALTER TABLE [dbo].[QA_survey_ANS2] ADD CONSTRAINT [PK_QA_survey_ANS2] PRIMARY KEY ([Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__5BE43DA0] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tasks
-- --------------------------------------------------
ALTER TABLE [dbo].[Tasks] ADD CONSTRAINT [PK_SampleTasks] PRIMARY KEY ([gc_guid])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_AOTD
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_AOTD] ADD CONSTRAINT [PK_tbl_AOTD] PRIMARY KEY ([Fld_ComplainNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_HR_CatMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_HR_CatMaster] ADD CONSTRAINT [PK__tbl_HR_CatMaster__04BA9F53] PRIMARY KEY ([FldCatId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_HR_CatSubCategory
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_HR_CatSubCategory] ADD CONSTRAINT [PK__tbl_HR_CatSubCat__16D94F8E] PRIMARY KEY ([FldCatSubCategoryId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_HR_SolutionMaster_old
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_HR_SolutionMaster_old] ADD CONSTRAINT [PK__tbl_HR_SolutionM__0D4FE554] PRIMARY KEY ([FldSolutionId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_HR_SubCategorySubject
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_HR_SubCategorySubject] ADD CONSTRAINT [PK__tbl_HR_SubCatego__1308BEAA] PRIMARY KEY ([FldSubCatSubjectId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_HR_SubCatMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_HR_SubCatMaster] ADD CONSTRAINT [PK__tbl_HR_SubCatMas__07970BFE] PRIMARY KEY ([FldSubCatId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_HR_SubjectMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_HR_SubjectMaster] ADD CONSTRAINT [PK__tbl_HR_SubjectMa__0A7378A9] PRIMARY KEY ([FldSubjectId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_HR_SubjectSolution
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_HR_SubjectSolution] ADD CONSTRAINT [PK__tbl_HR_SubjectSo__102C51FF] PRIMARY KEY ([FldSSId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_it_AngelGroupofCompaniesMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_it_AngelGroupofCompaniesMaster] ADD CONSTRAINT [PK_tbl_it_AngelGroupofCompaniesMaster] PRIMARY KEY ([CompId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_IT_Assetmaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_IT_Assetmaster] ADD CONSTRAINT [PK_tbl_IT_Assetmaster] PRIMARY KEY ([Fld_AssetID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_IT_AssignToDeptMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_IT_AssignToDeptMaster] ADD CONSTRAINT [PK_tbl_IT_AssignToDeptMaster] PRIMARY KEY ([Fld_AssignToDeptId])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_IT_BrMerger_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_IT_BrMerger_Master] ADD CONSTRAINT [PK_Tbl_IT_BrMerger_Master] PRIMARY KEY ([Sr_No])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_ITRequestType
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_ITRequestType] ADD CONSTRAINT [PK__tbl_ITRequestTyp__5BED93EA] PRIMARY KEY ([Fld_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_ITStaff_OtherDetails
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_ITStaff_OtherDetails] ADD CONSTRAINT [PK_tbl_ITStaff_OtherDetails] PRIMARY KEY ([ITSO_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Query_type
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Query_type] ADD CONSTRAINT [PK__tbl_Query_type__178D7CA5] PRIMARY KEY ([Fld_Sr_No])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_Request_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_Request_Master] ADD CONSTRAINT [PK_Tbl_Request_Master] PRIMARY KEY ([Fld_SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Sbs_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Sbs_Master] ADD CONSTRAINT [PK_tbl_SBS_New_Master] PRIMARY KEY ([Fld_Sbs_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_UPS_DailyMails
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_UPS_DailyMails] ADD CONSTRAINT [PK_tbl_UPS_DailyMails] PRIMARY KEY ([UPS_dailymail_ID1])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.altertable
-- --------------------------------------------------
create proc altertable
as
declare @id as varchar(5)
declare @str as varchar(2000)
select @id=max(fld_id) from odinchecklist_procedures(nolock)
set @str='alter table tbl_odin_checklist add ['+@id+'] varchar(255);alter table tbl_odin_checklist add ['+@id+'comment] varchar(255)'
--print @str
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Automation_Mail
-- --------------------------------------------------
/* Order Confirmation Report (Daily)*/  
  
CREATE Procedure [dbo].[Automation_Mail]                  
as  
                
Set nocount on    
Begin try  
IF (Not EXISTS (SELECT 1 FROM [MIDDLEWARE].HARMONY.DBO.HOLIMST   
    WHERE HDATE =  CONVERT(DATETIME,CONVERT(VARCHAR(10), GETDATE(), 112))  
 AND DATENAME(WEEKDAY,GETDATE()) <> 'SATURDAY'   
 AND DATENAME(WEEKDAY,GETDATE()) <> 'SUNDAY' ))                                         
BEGIN  
print 'inside'  
DECLARE @Emp_name as varchar(100),@emp_email as varchar(100),@cnt int                   
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(max),@MESS NVARCHAR(MAX)                              
    SELECT @emailto='rohit.ambosta@angelbroking.com'    
    --SELECT @emailto='prashant.patade@angelbroking.com'  
    Select @emailcc=' ketan@angelbroking.com;odinadmin@angelbroking.com;'  
    SELECT @emailbcc='sandeep.rai@angelbroking.com;prashant.patade@angelbroking.com'  
  declare @Count int,@CountEnd int,@Date as varchar(10), @BranchName as varchar(50),@CONTACTPERSON as varchar(50),  
   @CONFIRMATIONTIME as varchar(20),@STATUS as varchar(50),@REASON as varchar(500)  
               
  DECLARE @MessBody NVARCHAR(MAX),@MESS2 NVARCHAR(MAX)              
  DECLARE @xml NVARCHAR(MAX)                
   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0    
   set @cnt=1  
     
  
 -- select Fld_SrNo,Fld_Contact_person,Fld_Confimation_Time,Fld_Staus,Fld_Reason into #tbl_Order_Confirmation  
 --from tbl_Order_Confirmation  
          
             
    set @Data=''                  
    set @MessBody=''                            
    set @MESS2=''            
    set @Count=1                                      
        
     -- select top 10 * from tbl_Order_Confirmation order by Fld_UPD_Time Desc          
    select  row_number()over (order by a.Fld_SrNo) As Srno,a.Fld_SrNo,a.Fld_Contact_person,a.Fld_Upd_Time,a.Fld_Branch_id,  
    a.Fld_Confimation_Time,a.Fld_Staus,a.Fld_Reason,b.*  
    into #aa   
    from tbl_Order_Confirmation a inner join  Tbl_IT_Br_Master b ON a.Fld_Branch_id=b.Sr_No  
    where convert(varchar(12),Fld_UPD_Time,106)=CONVERT(varchar(12),getdate(),106)  
    --from tbl_Order_Confirmation       
   --drop table #aa  
    select * into #bb from #aa  
    select   @Count=count(*) from #bb   
    print @Count  
     SELECT @totctrOT=count(1) from #bb            
  print @totctrOT  
     
print @MESS    
    if(@Count=0)  
    Begin   
    print 'hi'  
     set @MESS2='<b>Note: Report not been updated by Odin Team.</b><br><br>'  
       set @MESS2=@MESS2+'Have a nice day ahead.'  
     set @sub ='Order Confirmation Report not updated as on ' + Convert(varchar(max),GETDATE())  
  
    print @MESS  
   --SET @MESS2='<Br><B>Equity</B> <Br><Br>'+ @MESS2 + @Data +'</Table>'   
    End  
    else  
    begin  
     SET @MESS2=                              
   '<Table border="1">                              
   <tr>                         
    <th> Date </th>                              
       <th> Branch Name </th>                              
       <th> CONTACT PERSON  </th>                              
       <th> CONFIRMATION TIME (24 Hrs)</th>      
       <th> STATUS </th>    
       <th> REASON</th>                                
   </tr>'    
   set @Data=''  
     WHILE @cnt <= @totctrOT                                
     BEGIN  
     print @cnt  
    SELECT @Date= CONVERT(VARCHAR(10), fld_upd_time, 103),@BranchName=Br_Name,@CONTACTPERSON=Fld_Contact_Person,@CONFIRMATIONTIME=Fld_Confimation_Time,@STATUS=Fld_Staus,  
    @REASON=Fld_Reason FROM #bb WHERE Srno=@cnt     
      
      ---SELECT convert(varchar(10),Fld_Upd_Time,120)  
      --@BranchName=Br_Name,@CONTACTPERSON=Fld_Contact_Person,  
      --@CONFIRMATIONTIME=Fld_Confimation_Time,@STATUS=Fld_Staus,  
    --@REASON=Fld_Reason   
    --FROM #bb -- WHERE Srno=@cnt      
    --convert(varchar(10),Fld_Upd_Time,120)  
                      
     
      set @Data=@Data+                             
     '<tr>         
     <td> '+ CONVERT(VARCHAR,@Date) +' </td>                            
     <td> '+ CONVERT(VARCHAR,@BranchName) +' </td>                            
     <td> '+ CONVERT(VARCHAR,@CONTACTPERSON) +' </td>                            
     <td> '+ CONVERT(VARCHAR,@CONFIRMATIONTIME) +' </td>                            
     <td> '+ CONVERT(VARCHAR,@STATUS) +' </td>   
     <td> '+ CONVERT(VARCHAR,@REASON) +' </td>   
       
       </tr>'             
      --print @Data    
          
      SET   @cnt=@cnt+1   
       
                                     
    END  
    --print @Data  
    SET @MESS2='<Br><B> Order Confirmation Report (Daily)</B> <Br><Br>'+ @MESS2 + @Data +'</Table>'                         
   
  set @sub ='Order Confirmation status at DAKC Datacenter during Market Opening Time as on ' + Convert(varchar(max),GETDATE())  
      
     
    End  
      
     
SET @MESS='Dear Sir,<br><Br>Greetings of the day!<Br><Br>' + @MESS2 +  '<Br><Br>'  
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(IT helpdesk)'                                
  
EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                
 @RECIPIENTS =@emailto,                                
 @COPY_RECIPIENTS = @emailcc,                                
 @blind_copy_recipients=@emailbcc,                      
 @PROFILE_NAME = 'AngelBroking',                                
 @BODY_FORMAT ='HTML',                                
 @SUBJECT = @sub ,                                
 --@FILE_ATTACHMENTS =@s,                                
 @BODY =@MESS   
END  
END TRY  
BEGIN catch  
  
  
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                
 @RECIPIENTS ='Prashant.patade@angelbroking.com',        
 @PROFILE_NAME = 'AngelBroking',                                
 @BODY_FORMAT ='HTML',                                
 @SUBJECT = @sub ,                                    
 @BODY =@MESS   
   
 drop table #aa  
 drop table #bb  
  
  END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Automation_Mail_02062018
-- --------------------------------------------------
/* Order Confirmation Report (Daily)*/

Create Procedure [dbo].[Automation_Mail_02062018]                
as
              
Set nocount on  
Begin try
IF (Not EXISTS (SELECT 1 FROM [196.1.115.239].HARMONY.DBO.HOLIMST 
				WHERE HDATE =  CONVERT(DATETIME,CONVERT(VARCHAR(10), GETDATE(), 112))
	AND DATENAME(WEEKDAY,GETDATE()) <> 'SATURDAY' 
	AND DATENAME(WEEKDAY,GETDATE()) <> 'SUNDAY' ))                                       
BEGIN
print 'inside'
DECLARE @Emp_name as varchar(100),@emp_email as varchar(100),@cnt int                 
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(max),@MESS NVARCHAR(MAX)                            
    SELECT @emailto='rohit.ambosta@angelbroking.com'  
    --SELECT @emailto='prashant.patade@angelbroking.com'
    Select @emailcc=' ketan@angelbroking.com;odinadmin@angelbroking.com;'
    SELECT @emailbcc='sandeep.rai@angelbroking.com;prashant.patade@angelbroking.com'
  declare @Count int,@CountEnd int,@Date as varchar(10), @BranchName as varchar(50),@CONTACTPERSON as varchar(50),
   @CONFIRMATIONTIME as varchar(20),@STATUS as varchar(50),@REASON as varchar(500)
             
  DECLARE @MessBody NVARCHAR(MAX),@MESS2 NVARCHAR(MAX)            
  DECLARE @xml NVARCHAR(MAX)              
   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0  
   set @cnt=1
   

	--	select Fld_SrNo,Fld_Contact_person,Fld_Confimation_Time,Fld_Staus,Fld_Reason into #tbl_Order_Confirmation
	--from tbl_Order_Confirmation
        
           
    set @Data=''                
    set @MessBody=''                          
    set @MESS2=''          
    set @Count=1                                    
      
     -- select top 10 * from tbl_Order_Confirmation order by Fld_UPD_Time Desc        
    select  row_number()over (order by a.Fld_SrNo) As Srno,a.Fld_SrNo,a.Fld_Contact_person,a.Fld_Upd_Time,a.Fld_Branch_id,
    a.Fld_Confimation_Time,a.Fld_Staus,a.Fld_Reason,b.*
    into #aa 
    from tbl_Order_Confirmation a inner join  Tbl_IT_Br_Master b ON a.Fld_Branch_id=b.Sr_No
    where convert(varchar(12),Fld_UPD_Time,106)=CONVERT(varchar(12),getdate(),106)
    --from tbl_Order_Confirmation     
   --drop table #aa
    select * into #bb from #aa
    select   @Count=count(*) from #bb 
    print @Count
     SELECT @totctrOT=count(1) from #bb          
  print @totctrOT
   
print @MESS  
    if(@Count=0)
    Begin 
    print 'hi'
     set @MESS2='<b>Note: Report not been updated by Odin Team.</b><br><br>'
       set @MESS2=@MESS2+'Have a nice day ahead.'
     set @sub ='Order Confirmation Report not updated as on ' + Convert(varchar(max),GETDATE())

    print @MESS
   --SET @MESS2='<Br><B>Equity</B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
    End
    else
    begin
     SET @MESS2=                            
   '<Table border="1">                            
   <tr>                       
    <th> Date </th>                            
       <th> Branch Name </th>                            
       <th> CONTACT PERSON  </th>                            
       <th> CONFIRMATION TIME (24 Hrs)</th>    
       <th> STATUS </th>  
       <th> REASON</th>                              
   </tr>'  
   set @Data=''
     WHILE @cnt <= @totctrOT                              
     BEGIN
     print @cnt
    SELECT @Date= CONVERT(VARCHAR(10), fld_upd_time, 103),@BranchName=Br_Name,@CONTACTPERSON=Fld_Contact_Person,@CONFIRMATIONTIME=Fld_Confimation_Time,@STATUS=Fld_Staus,
    @REASON=Fld_Reason FROM #bb WHERE Srno=@cnt   
    
      ---SELECT convert(varchar(10),Fld_Upd_Time,120)
      --@BranchName=Br_Name,@CONTACTPERSON=Fld_Contact_Person,
      --@CONFIRMATIONTIME=Fld_Confimation_Time,@STATUS=Fld_Staus,
    --@REASON=Fld_Reason 
    --FROM #bb -- WHERE Srno=@cnt    
    --convert(varchar(10),Fld_Upd_Time,120)
                    
	  
      set @Data=@Data+                           
     '<tr>                          
     <td> '+ CONVERT(VARCHAR,@Date) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@BranchName) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@CONTACTPERSON) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@CONFIRMATIONTIME) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@STATUS) +' </td> 
     <td> '+ CONVERT(VARCHAR,@REASON) +' </td> 
     
       </tr>'           
      --print @Data  
        
      SET   @cnt=@cnt+1 
     
                                   
    END
    --print @Data
    SET @MESS2='<Br><B> Order Confirmation Report (Daily)</B> <Br><Br>'+ @MESS2 + @Data +'</Table>'                       
 
  set @sub ='Order Confirmation status at DAKC Datacenter during Market Opening Time as on ' + Convert(varchar(max),GETDATE())
    
   
    End
    
   
SET @MESS='Dear Sir,<br><Br>Greetings of the day!<Br><Br>' + @MESS2 +  '<Br><Br>'
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(IT helpdesk)'                              

EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
 @RECIPIENTS =@emailto,                              
 @COPY_RECIPIENTS = @emailcc,                              
 @blind_copy_recipients=@emailbcc,                    
 @PROFILE_NAME = 'AngelBroking',                              
 @BODY_FORMAT ='HTML',                              
 @SUBJECT = @sub ,                              
 --@FILE_ATTACHMENTS =@s,                              
 @BODY =@MESS 
END
END TRY
BEGIN catch


 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
 @RECIPIENTS ='Prashant.patade@angelbroking.com',      
 @PROFILE_NAME = 'AngelBroking',                              
 @BODY_FORMAT ='HTML',                              
 @SUBJECT = @sub ,                                  
 @BODY =@MESS 
 
 drop table #aa
 drop table #bb

  END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.branches
-- --------------------------------------------------
create procedure branches
as
select a.br_name from tbl_wan_branch a
inner join tbl_wan_branch b
on a.id=b.id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_data_all
-- --------------------------------------------------
CREATE procedure complaint_data_all(@FromDate varchar(11),@ToDate varchar(11))      
as                      
set nocount on           
        
begin     
    
--drop table #file2  
select distinct month1 = datename(month,a.complaint_date) ,a.code,b.branch_cd as branch,c.zone into #file1 from complaint_table a        
join  intranet.risk.dbo.client_details b on a.code = b.party_code       
left outer join intranet.risk.dbo.zone c on b.branch_cd= c.branch_cd        
where a.complaint_date >= convert(datetime,@FromDate,103)  and a.complaint_date <= convert(datetime,@ToDate,103) and     
a.entered_through='HD'         
and a.entry_by like '%' and a.department like '%' and a.status like '%'         
and a.wrong_entry <> 'Y' and a.category in('Client', 'enquiry' , 'internal')     
  
select distinct month1 = datename(month,a.complaint_date),a.code ,b.branch_code as branch,c.zone into #file2 from complaint_table a       
join intranet.risk.dbo.subbrokers b on a.code = b.sub_broker       
left outer join intranet.risk.dbo.zone c on b.branch_code = c.branch_cd       
where a.complaint_date >= convert(datetime,@FromDate,103)  
and a.complaint_date <= convert(datetime,@ToDate,103) and     
a.entered_through='HD'         
and a.entry_by like '%' and a.department like '%' and a.status like '%'         
and a.wrong_entry <> 'Y' and a.code <> 'Null'  and c.zone <> 'Null'      
and a.category = 'Sub-broker'      
  
select distinct month1 = datename(month,a.complaint_date),a.code,b.branch as branch,c.zone into #file3 from complaint_table a      
join intranet.risk.dbo.branches b on a.code = b.branch_code      
left outer join intranet.risk.dbo.zone c on b.branch_code = c.branch_cd       
where a.complaint_date >= convert(datetime,@FromDate,103)   
and a.complaint_date <= convert(datetime,@ToDate,103) and     
 a.entered_through='HD'         
and a.entry_by like '%' and a.department like '%' and a.status like '%'         
and a.wrong_entry <> 'Y' and a.code <> 'Null'  and c.zone <> 'Null'      
and a.category = 'Branch'    
    
  
select *  into #file5 from  #file1 union select * from #file2 union select * from #file3 order by month1 desc     
    
alter table #file5    
add Srno int identity(1,1)     
    
select * INTO #file6 from #file5   
  
--SELECT * FROM #file6    
select Srno,month1,code,branch,zone from #file6    
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_MIS
-- --------------------------------------------------
  
CREATE procedure complaint_MIS(@FromDate varchar(11),@ToDate varchar(11),@usercode varchar(50))                  
as                        
set nocount on                  
               
              
declare @sum float   
             
              
--declare @FromDate varchar(11)                 
--declare @Todate varchar(11)                   
--set @FromDate='01/07/2008'                  
--set @ToDate =  '30/08/2008'    
        
if @usercode = 'All'              
begin                
select * into #temp_all from                 
(                
select TypeOfQuery = 'Calls' , count(*) as NoOfQueries from complaint_table where Complaint_date >= convert(datetime,@FromDate,103)  and Complaint_date <= convert(datetime,@ToDate,103) and entered_through='HD' and  entry_by like '%'       
and department like '%' and status like '%' and wrong_entry <> 'Y'  and category in('Client', 'enquiry' , 'internal','Sub-broker','Branch') union                  
select TypeOfQuery = 'Feedback',count(*) as NoOfQueries  from mail where gc_sentOn >= convert(datetime,@FromDate,103)  and gc_sentOn <= convert(datetime,@ToDate,103) union                  
select TypeOfQuery = 'Password Resets',count(*) as NoOfQueries from intranet.ctcl.dbo.bo_client_password  where GeneratedOn >= convert(datetime,@FromDate,103)   and  GeneratedOn <= convert(datetime,@ToDate,103) union    
select TypeOfQuery = 'Client Summary',count(*) as NoOfQueries from middleware.Mimansa.dbo.ClientQuestionAnswer where  QDate >= convert(datetime,@FromDate,103) and QDate <= convert(datetime,@ToDate,103) union           
select  TypeOfQuery = 'Password Verifications',count(distinct party_code) as NoOfQueries from intranet.misc.dbo.bo_passwordreset  where RequestDateTime >=  convert(datetime,'1/08/2008',103) and RequestDateTime <=  convert(datetime,'17/09/2008',103)    
)a                
              
                
              
--select TypeOfQuery='Total',Percentage = 100,NoOfQueries1 = sum(NoOfqueries) into #temp1 from #temp                 
              
--select  @sum = sum(NoOfqueries) from #temp                   
--print @sum              
select Typeofquery,Percentage=round(NoOfqueries*100/@sum,2),noofqueries into #temp2_all from #temp_all               
              
              
select typeofquery,noofqueries from #temp2_all --union select * from #temp1   
  
end  
  
  
  
if @usercode <> 'All'  
begin                      
select * into #temp from                       
(                      
select TypeOfQuery = 'Calls' , count(*) as NoOfQueries from complaint_table where Complaint_date >= convert(datetime,@FromDate,103)  and Complaint_date <= convert(datetime,@ToDate,103) and entered_through='HD' and  entry_by like '%'             
and department like '%' and status like '%' and entry_by = @usercode and wrong_entry <> 'Y'  and category in('Client', 'enquiry' , 'internal','Sub-broker','Branch') union                        
select TypeOfQuery = 'Feedback',count(*) as NoOfQueries  from mail a join request_map b on a.gc_guid = b.guid where gc_sentOn >= convert(datetime,@FromDate,103)  and gc_sentOn <= convert(datetime,@ToDate,103) and b.request_type = @usercode  union        
select TypeOfQuery = 'Password Resets',count(*) as NoOfQueries from intranet.ctcl.dbo.bo_client_password where GeneratedOn >= convert(datetime,@FromDate,103) and  GeneratedOn <= convert(datetime,@ToDate,103) and GeneratedBy= @usercode union       
select TypeOfQuery = 'Client Summary',count(*) as NoOfQueries from middleware.Mimansa.dbo.ClientQuestionAnswer where  QDate >= convert(datetime,@FromDate,103) and QDate <= convert(datetime,@ToDate,103) and executive = @usercode union        
select  TypeOfQuery = 'Password Verifications',count(distinct party_code) as NoOfQueries from intranet.misc.dbo.bo_passwordreset  where RequestDateTime >=  convert(datetime,'1/08/2008',103) and RequestDateTime <=  convert(datetime,'17/09/2008',103)     
and verified_by = @usercode     
    
)a                      
      
      
--select TypeOfQuery='Total',Percentage = 100,NoOfQueries1 = sum(NoOfqueries) into #temp1 from #temp                       
                    
--select  @sum = sum(NoOfqueries) from #temp                         
--print @sum                    
                    
                    
select Typeofquery,Percentage=round(NoOfqueries*100/@sum,2),noofqueries into #temp2 from #temp                     
select typeofquery,noofqueries from #temp2 --union select * from #temp1        
          
end  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_MIS_user
-- --------------------------------------------------
CREATE procedure complaint_MIS_user(@FromDate varchar(11),@ToDate varchar(11),@userCode varchar(50))                      
as                            
set nocount on                      
                   
                  
declare @sum float                  
                  
--declare @FromDate varchar(11)                     
--declare @Todate varchar(11)                       
--set @FromDate='01/07/2008'                      
--set @ToDate =  '30/08/2008'              
                    
begin                    
select * into #temp from                     
(                    
select TypeOfQuery = 'Calls' , count(*) as NoOfQueries from complaint_table where Complaint_date >= convert(datetime,@FromDate,103)  and Complaint_date <= convert(datetime,@ToDate,103) and entered_through='HD' and  entry_by like '%'           
and department like '%' and status like '%' and entry_by = @usercode and wrong_entry <> 'Y'  and category in('Client', 'enquiry' , 'internal','Sub-broker','Branch') union                      
select TypeOfQuery = 'Feedback',count(*) as NoOfQueries  from mail a join request_map b on a.gc_guid = b.guid where gc_sentOn >= convert(datetime,@FromDate,103)  and gc_sentOn <= convert(datetime,@ToDate,103) and b.request_type = @usercode  union      
select TypeOfQuery = 'Password Resets',count(*) as NoOfQueries from intranet.ctcl.dbo.bo_client_password where GeneratedOn >= convert(datetime,@FromDate,103) and  GeneratedOn <= convert(datetime,@ToDate,103) and GeneratedBy= @usercode union     
select TypeOfQuery = 'Client Summary',count(*) as NoOfQueries from middleware.Mimansa.dbo.ClientQuestionAnswer where  QDate >= convert(datetime,@FromDate,103) and QDate <= convert(datetime,@ToDate,103) and executive = @usercode union      
select  TypeOfQuery = 'Password Verifications',count(distinct party_code) as NoOfQueries from intranet.misc.dbo.bo_passwordreset  where RequestDateTime >=  convert(datetime,'1/08/2008',103) and RequestDateTime <=  convert(datetime,'17/09/2008',103)   
and verified_by = @usercode   
  
)a                    
end      
    
--select TypeOfQuery='Total',Percentage = 100,NoOfQueries1 = sum(NoOfqueries) into #temp1 from #temp                     
                  
--select  @sum = sum(NoOfqueries) from #temp                       
--print @sum                  
                  
                  
select Typeofquery,Percentage=round(NoOfqueries*100/@sum,2),noofqueries into #temp2 from #temp                   
                  
                  
select typeofquery,noofqueries from #temp2 --union select * from #temp1              
                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_MIS_userwise
-- --------------------------------------------------
CREATE procedure complaint_MIS_userwise(@FromDate varchar(12),@ToDate varchar(12),@link varchar(10))                            
as                                  
set nocount on                            
             
                      
declare @sum float                
            
if @link = 'C'           
begin               
select top 10 entry_by, count(*) as NoOfQueries into #temp1 from complaint_table               
where Complaint_date >= convert(datetime,@Fromdate,103)                
and Complaint_date <= convert(datetime,@ToDate,103) and entered_through='HD' and  entry_by like '%' and department like '%' and status like '%' and wrong_entry <> 'Y' and entry_by <> ''               
and category in('Client', 'enquiry' , 'internal','Sub-broker','Branch')              
group by entry_by         
        
select  entry_by,NoOfqueries from #temp1            
end         
      
      
if @link = 'F'           
begin               
select substring(c.emp_name,1,charindex(' ',ltrim(rtrim(c.emp_name)))) as entry_by ,count(*) as NoOfQueries  into #temp2 from request_map a       
join mail b on a.guid = b.gc_guid      
join intranet.risk.dbo.emp_info c on a.request_type = c.emp_no      
where b.gc_SentOn >= convert(datetime,@FromDate,103)  and b.gc_SentOn <=  convert(datetime,@ToDate,103)      
group by c.emp_name      
        
select  entry_by,NoOfqueries from #temp2            
end        
      
        
if @link = 'P'        
begin        
select substring(b.emp_name,1,charindex(' ',ltrim(rtrim(b.emp_name)))) as entry_by,count(*) as NoOfQueries into #temp3 from intranet.ctcl.dbo.bo_client_password  a       
join intranet.risk.dbo.emp_info b on a.generatedBy = b.emp_no      
where a.generatedOn >= convert(datetime,@FromDate,103) and       
a.generatedOn <= convert(datetime,@ToDate,103)      
group by b.emp_name       
      
select  entry_by,NoOfqueries from #temp3        
      
      
end       
      
        
if @link = 'S'        
begin        
select a.Executive,count(*) as NoOfQueries , substring(b.emp_name,1,charindex(' ',ltrim(rtrim(b.emp_name)))) as entry_by  into #temp4        
from middleware.Mimansa.dbo.ClientQuestionAnswer a join intranet.risk.dbo.emp_info b         
on a.executive = b.emp_no where QDate >= convert(datetime,@FromDate,103)         
and QDate <= convert(datetime,@ToDate,103) group by a.Executive,b.emp_name        
      
select  entry_by,NoOfqueries from #temp4        
end     
    
    
if @link = 'V'        
begin        
select substring(b.emp_name,1,charindex(' ',ltrim(rtrim(b.emp_name)))) as entry_by,count(*) as NoOfQueries into #temp5    
from intranet.misc.dbo.bo_passwordreset  a       
join intranet.risk.dbo.emp_info b on a.verified_by = b.emp_no      
where a.RequestDateTime >= convert(datetime,@FromDate,103) and       
a.RequestDateTime <= convert(datetime,@Todate,103)      
group by b.emp_name     
      
select  entry_by,NoOfqueries from #temp5      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_MIS_userwise_total
-- --------------------------------------------------
CREATE procedure complaint_MIS_userwise_total(@FromDate varchar(12),@ToDate varchar(12))                                
as                                      
set nocount on                                
                 
declare @sum float         
--declare @fromdate varchar(12)        
--declare @todate varchar(12)        
--        
--set @fromdate = '1/08/2008'        
--set @todate = '17/09/2008'                   
--               
begin            
         
select entry_by,NoOfQueries=sum(NoOfQueries) into #temp from                       
(                      
select a.emp_name as entry_by, count(*) as NoOfQueries from intranet.risk.dbo.emp_info a  join     
helpdeskn.dbo.complaint_table b on a.emp_no = b.entry_by where    
Complaint_date >= convert(datetime,@FromDate,103)  and Complaint_date <= convert(datetime,@ToDate,103)      
and wrong_entry <> 'Y'  group by a.emp_name union                        
        
select c.emp_name as entry_by ,count(*) as NoOfQueries from request_map a join mail b on a.guid = b.gc_guid  join intranet.risk.dbo.emp_info c on a.request_type = c.emp_no            
where b.gc_SentOn >= convert(datetime,@FromDate,103)  and b.gc_SentOn <=  convert(datetime,@ToDate,103)        
group by emp_name            
union        
        
select b.emp_name as entry_by,count(*) as NoOfQueries  from intranet.ctcl.dbo.bo_client_password  a join intranet.risk.dbo.emp_info b on a.generatedBy = b.emp_no            
where a.generatedOn >= convert(datetime,@FromDate,103) and             
a.generatedOn <= convert(datetime,@ToDate,103)          
group by emp_name          
union          
        
select b.emp_name as entry_by ,count(*) as NoOfQueries                
from middleware.Mimansa.dbo.ClientQuestionAnswer a join intranet.risk.dbo.emp_info b               
on a.executive = b.emp_no where QDate >= convert(datetime,@FromDate,103)               
and QDate <= convert(datetime,@ToDate,103)        
group by emp_name        
)a          
group by entry_by        
end         
        
    
select a.entry_by as emp,count(*) as total_calls   
into #calls   
from #temp a    
join intranet.risk.dbo.emp_info b on a.entry_by = b.emp_name  
join helpdeskn.dbo.complaint_table c    
on b.emp_no = c.entry_by     
where complaint_date >= convert(datetime,@FromDate,103)   and complaint_date <= convert(datetime,@ToDate,103)      
group by a.entry_by,a.NoOfQueries      
    
select a.entry_by as emp,count(*) as total_pwd         
into #1         
from #temp a join intranet.risk.dbo.emp_info b         
on a.entry_by = b.emp_name join intranet.ctcl.dbo.bo_client_password c         
on b.emp_no = c.generatedBy        
where c.generatedOn >=  convert(datetime,@FromDate,103) and c.generatedOn <= convert(datetime,@ToDate,103)        
group by a.entry_by,a.NoOfQueries        
        
        
select a.entry_by as emp,count(*) as total_cli        
into #2         
from #temp a join intranet.risk.dbo.emp_info b        
on a.entry_by = b.emp_name left outer join         
middleware.Mimansa.dbo.ClientQuestionAnswer c on b.emp_no = c.executive        
where c.QDate >= convert(datetime,@FromDate,103) and c.QDate <= convert(datetime,@ToDate,103)        
group by a.entry_by,a.NoOfQueries        
        
        
select a.entry_by as emp ,count(*) as total_feed   
into #3        
from #temp a join intranet.risk.dbo.emp_info b        
on a.entry_by = b.emp_name left outer join request_map c        
on b.emp_no = c.request_type join mail d        
on c.guid = d.gc_guid         
where d.gc_sentOn >=  convert(datetime,@FromDate,103) and d.gc_sentOn <= convert(datetime,@ToDate,103)         
group by a.entry_by        
        
         
select substring(a.entry_by,1,charindex(' ',ltrim(rtrim(a.entry_by)))) as entry_by ,a.NoOfQueries,isnull(e.total_calls,0) as 'Calls',isnull(b.total_pwd,0) as 'Password Resets',isnull(c.total_cli,0) as 'Client Summary',        
isnull(d.total_feed,0) as 'FeedBack'  into #last      
from #temp a left outer join #1 b        
on a.entry_by = b.emp left outer join #2 c        
on a.entry_by = c.emp left outer join #3 d        
on a.entry_by = d.emp  left outer join #calls e    
on a.entry_by = e.emp     
      
select * from  #last

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_MIS_zonewise
-- --------------------------------------------------
 
CREATE procedure complaint_MIS_zonewise(@FromDate varchar(11),@ToDate varchar(11))                    
as                          
set nocount on                    
                 
declare @sum float              
begin            
      
--select * from complaint_br  
        
select a.code,a.branch,c.zone into #filezone from complaint_br a             
left outer join intranet.risk.dbo.zone c            
on a.branch = c.branch_cd             
where complaint_date >= convert(datetime,@FromDate,103)          
and complaint_date <= convert(datetime,@ToDate,103) and          
 a.department like '%'              
and a.category in('Client', 'enquiry' , 'internal','Sub-broker','Branch')       
            
             
            
select * into #tempComplaints from            
(            
select Region = 'WEST',count(*) as NoOfComplaints from #filezone where zone = 'WEST'  union             
select Region = 'EAST',count(*) as NoOfComplaints from #filezone where zone = 'EAST' union            
select Region = 'NORTH',count(*) as NoOfComplaints from #filezone where zone = 'NORTH' union            
select Region = 'SOUTH',count(*) as NoOfComplaints from #filezone where zone = 'SOUTH'             
)a              
            
end            
--select * from #tempComplaints            
--drop table #tempComplaints            
            
--select Region='Total',Percentage = 100,NoOfComplaints = sum(NoOfComplaints) into #tempTotal from #tempComplaints                
          
            
--declare @sum float            
select  @sum = sum(NoOfComplaints) from #tempComplaints              
--print @sum            
            
select Region,NoOfComplaints into #tempFinal from #tempComplaints               
            
--select * from #tempFinal              
            
--select * from #tempTotal      
--union    
 select * from #tempFinal     
order by NoOfComplaints

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_MIS1
-- --------------------------------------------------
CREATE Procedure complaint_MIS1 (@opt varchar(3),@br varchar(8),@fdate as varchar(11),@tdate as varchar(11)) 
as            

select prod='avx',total=60,'',''
union       
select prod='sd',total=22,'',''
union
select prod='sdg',total=90,'',''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.complaint_userwise_clientsummary
-- --------------------------------------------------
CREATE procedure complaint_userwise_clientsummary(@FromDate varchar(12),@ToDate varchar(12))                      
as                            
set nocount on                      
       
                
declare @sum float          
      
begin    
                  
select  a.Executive,count(*) as NoOfQueries , b.emp_name as entry_by  into #temp1  
from middleware.Mimansa.dbo.ClientQuestionAnswer a join intranet.risk.dbo.emp_info b   
on a.executive = b.emp_no where QDate >= convert(datetime,@FromDate,103)   
and QDate <= convert(datetime,@ToDate,103) group by a.Executive,b.emp_name  
         
select  entry_by,NoOfqueries from #temp1      
                    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CRF_Automail_Database_Shrink _Report
-- --------------------------------------------------
--DROP TABLE #Y
--DROP TABLE #X

CREATE PROCEDURE [DBO].[CRF_AUTOMAIL_DATABASE_SHRINK _REPORT]                
AS
BEGIN
DECLARE @EMP_NAME AS VARCHAR(100),@EMP_EMAIL AS VARCHAR(100)                
DECLARE @EMAILTO AS VARCHAR(1000),@EMAILCC AS VARCHAR(1000),@EMAILBCC AS VARCHAR(1000),@SUB AS VARCHAR(MAX),@MESS NVARCHAR(MAX)                            
   -- SELECT @EMAILTO='ATUL.SASHITTAL@ANGELBROKING.COM'
     SELECT @EMAILTO='PRASHANT.PATADE@ANGELBROKING.COM'
    --SELECT @EMAILCC='ITHELPDESKAKRUTI@ANGELBROKING.COM;ODINADMIN@ANGELBROKING.COM'
   -- SELECT @EMAILBCC='SANDEEP.RAI@ANGELBROKING.COM;PRASHANT.PATADE@ANGELBROKING.COM'
    
    /*DHOKA */
  
  --if(DATENAME(DW, GETDATE())= 'Monday')
  --begin
       
  DECLARE @COUNT INT,@DATA1 NVARCHAR(MAX),@MESS1 NVARCHAR(MAX),@COUNTEND INT,@SERVER AS VARCHAR(50), 
		  @FLD_SERVER_ID AS VARCHAR(50),@MDF_LDF AS VARCHAR(50),@MDF_BQ AS VARCHAR(50),@MDF_AQ AS VARCHAR(50),
		  @FLD_MDF_COD AS VARCHAR(50),@FLD_MDF_FS AS VARCHAR(50),@FLD_MDF_AQ AS VARCHAR(50),@FLD_MDF_BQ AS VARCHAR(500),@FLD_MDF_DD AS VARCHAR(50),
		  @FLD_LDF_COD AS VARCHAR(50),@FLD_LDF_FS AS VARCHAR(50),@FLD_LDF_AQ AS VARCHAR(50),@FLD_LDF_BQ AS VARCHAR(50),
		  @FLD_ODIN_IP AS VARCHAR(50),@FLD_DB_LP AS VARCHAR(50),
		  @FLD_REMARK AS VARCHAR(50),@FLD_UPD_BY AS VARCHAR(50), @CNT INT,
		  @MESSBODY NVARCHAR(MAX),@MESS2 NVARCHAR(MAX),@XML NVARCHAR(MAX),@DATA NVARCHAR(MAX) ,  @TOTCTROT AS INT=0
 
		SET @DATA=''                
		SET @MESSBODY=''                          
		SET @MESS2=''          
		SET @COUNT=1   
		SET @CNT=1  
		
	SELECT DISTINCT FLD_SERVER_ID  
    INTO  #X
    FROM TBL_DB_SHRINK_DATA_NEW (NOLOCK)
    WHERE  FLD_UPD_DATE = DATEADD(d,DATEDIFF(d,0,getdate()),-6)  AND  FLD_SERVER_ID NOT IN ('37')
    
    --WHERE  FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000')  AND  FLD_SERVER_ID NOT IN ('37')
   
    --SELECT DATEADD(d,DATEDIFF(d,0,getdate()),-2)
    
     SELECT ROW_NUMBER()OVER (ORDER BY FLD_BRANCH_ID) AS SRNO,* INTO  #Y 
     FROM                                            
	 (  
     SELECT 'INTEGRATED ODIN(.MDF)' AS MDF_LDF,                                                                                                               
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_MDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERMDF,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_AQ,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_BQ,                                                                                                              
	FLD_MDF_COD,FLD_MDF_BQ,FLD_MDF_AQ,FLD_MDF_DD,FLD_MDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,                                                        
	FLD_REMARK,FLD_UPD_BY FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK) 
    WHERE FLD_SERVER_ID IN (SELECT * FROM #X) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID NOT IN ('37')  --@FLD_FDATE
    UNION                                            
	SELECT 'TRANSACTION LOG SPACE(.LDF)',                                                        
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_LDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERLDF,                              
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_AQ,                                 
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_BQ,                                                        
	FLD_LDF_COD,FLD_LDF_BQ,FLD_LDF_AQ,FLD_LDF_DD,FLD_LDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,FLD_REMARK,FLD_UPD_BY  FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK)
	 WHERE FLD_SERVER_ID IN (SELECT * FROM #X) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID NOT IN ('37')  
     )A                                         
	LEFT OUTER JOIN                                            
	(SELECT FLD_ID,FLD_SERVER,FLD_DB_IP,FLD_ODIN_IP FROM V_TBL_SERVER_MASTER(NOLOCK)) B                                                           
	ON A.FLD_SERVER_ID = B.FLD_ID                                                        
	LEFT OUTER JOIN                                                        
	(SELECT PERSON_NAME AS EMP_NAME,USERNAME  FROM INTRANET.RISK.DBO.USER_LOGIN)C                                                        
	ON A.FLD_UPD_BY = C.USERNAME                                               
	LEFT OUTER JOIN                                            
	(SELECT BR_TAG,BR_NAME FROM TBL_IT_BR_MASTER (NOLOCK)  WHERE BR_TYPE = 'DATACENTER' )D                                            
	ON A.FLD_BRANCH_ID = D.BR_TAG                                            
	ORDER BY FLD_BRANCH_ID     
  
    SELECT @COUNT=COUNT(*) FROM #Y --where FLD_Server='DAKC DIET CLIENT (48)'
    SELECT @TOTCTROT=COUNT(1) FROM #Y
    
     IF(@COUNT=0)
     BEGIN 
		 SET @MESS2='<B>NOTE:TCP COUNT HAS NOT BEEN UPDATED BY DAKC  BRANCH.</B><BR><BR>'
		 SET @MESS2=@MESS2+'HAVE A NICE DAY AHEAD.'
		 SET @SUB ='TCP ' + CONVERT(VARCHAR(MAX),GETDATE())
     END
     ELSE
     BEGIN
   
     SET @MESS2=                           
	   '<TABLE BORDER="1">                            
	   <TR>                       
			   <TH> SERVER </TH>              
			   <TH> ODIN IP</TH>                            
			   <TH> DATABASE IP </TH>                            
			   <TH> DATABASE</TH>    
			   <TH> BEFORE QUERY (GB)</TH>  
			   <TH>AFTER QUERY (GB)</TH> 
			   <TH>DISK DRIVE</TH>
			   <TH>CAPICITY OF DRIVE (GB)</TH>
			   <TH>FREE SPACE (GB)</TH>
			   <TH>REMARK</TH>     
			   <TH>ENTRY BY</TH>                         
		</TR>'  
     SET @DATA=''
     
				 WHILE @CNT <= @TOTCTROT                              
				 BEGIN
				 PRINT @CNT
				 SELECT @SERVER=FLD_SERVER,@FLD_MDF_COD=FLD_MDF_COD,@FLD_MDF_BQ=FLD_MDF_BQ,@FLD_MDF_AQ=FLD_MDF_AQ,@FLD_MDF_FS=FLD_MDF_FS,@FLD_MDF_DD=FLD_MDF_DD,
						@MDF_LDF=MDF_LDF,@MDF_BQ=MDF_BQ,@MDF_AQ=MDF_AQ,
						@FLD_ODIN_IP=FLD_ODIN_IP,@FLD_DB_LP=FLD_DB_IP,@FLD_REMARK=FLD_REMARK,@FLD_UPD_BY=EMP_NAME
				 FROM #Y 
				 WHERE SRNO=@CNT    
			                                
			     SET @DATA=@DATA+                           
						 '<TR>                          
						 <TD> '+ CONVERT(VARCHAR,@SERVER) +' </TD>                         
						 <TD> '+ CONVERT(VARCHAR,@FLD_ODIN_IP) +' </TD>                          
						 <TD> '+ CONVERT(VARCHAR,@FLD_DB_LP) +' </TD>                          
						 <TD> '+ CONVERT(VARCHAR,@MDF_LDF) +' </TD>                          
						 <TD> '+ CONVERT(VARCHAR,@MDF_BQ) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@MDF_AQ) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@FLD_MDF_DD) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@FLD_MDF_COD) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@FLD_MDF_FS) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@FLD_REMARK) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@FLD_UPD_BY) +' </TD> 
						 </TR>'            

				  SET   @CNT=@CNT+1 
				 
				  END--end of while
				 
			SET @MESS2='<BR><B>DAKC </B> <BR><BR>'+ @MESS2 + @DATA +'</TABLE>' 
			SET @SUB ='TCP TIME AS ON ' + CONVERT(VARCHAR(MAX),GETDATE())
  
  END
-- End 
/*GHATKOPAR (E)*/
	 
	  DECLARE @COUNT1 INT,@DATE1 AS VARCHAR(20),@TOTCTROT1 AS INT=0  ,@SERVER_1 AS VARCHAR(20), 
			  @FLD_SERVER_ID_1 AS VARCHAR(50),@MDF_LDF_1 AS VARCHAR(50),@MDF_BQ_1 AS VARCHAR(50),@MDF_AQ_1 AS VARCHAR(50),
			  @FLD_MDF_COD_1 AS VARCHAR(50),@FLD_MDF_FS_1 AS VARCHAR(50),@FLD_MDF_AQ_1 AS VARCHAR(50),@FLD_MDF_BQ_1 AS VARCHAR(500),@FLD_MDF_DD_1 AS VARCHAR(50),
			  @FLD_LDF_COD_1 AS VARCHAR(50),@FLD_LDF_FS_1 AS VARCHAR(50),@FLD_LDF_AQ_1 AS VARCHAR(50),@FLD_LDF_BQ_1 AS VARCHAR(50),
			  @FLD_ODIN_IP_1 AS VARCHAR(50),@FLD_DB_LP_1 AS VARCHAR(50),
			  @FLD_REMARK_1 AS VARCHAR(50),@FLD_UPD_BY_1 AS VARCHAR(50), @CNT1 INT,
			  @LDF_DB_1 AS VARCHAR(50),@LDF_BQ_1 AS VARCHAR(50),@LDF_AQ_1 AS VARCHAR(50)
			  
	   DECLARE @MESSBODY1 NVARCHAR(MAX)    
	           
		SET @DATA1=''                
		SET @MESSBODY1=''                          
		SET @MESS1=''          
		SET @COUNT1=1 
		SET @CNT1=1                                   
		
       SELECT DISTINCT FLD_SERVER_ID  
       INTO  #xx 
       FROM TBL_DB_SHRINK_DATA_NEW (NOLOCK)
       WHERE  FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000')  AND   FLD_SERVER_ID  IN ('37')
      
    SELECT ROW_NUMBER()OVER (ORDER BY FLD_BRANCH_ID) AS SRNO,* INTO  #yy 
    FROM                                            
	(  
     SELECT 'INTEGRATED ODIN(.MDF)' AS MDF_LDF,                                                                                                               
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_MDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERMDF,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_AQ,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_BQ,                                                                                                              
	FLD_MDF_COD,FLD_MDF_BQ,FLD_MDF_AQ,FLD_MDF_DD,FLD_MDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,                                                        
	FLD_REMARK,FLD_UPD_BY FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK) 
    WHERE FLD_SERVER_ID IN (SELECT * FROM #XX) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID  IN ('37')  --@FLD_FDATE
    UNION                                            
	SELECT 'TRANSACTION LOG SPACE(.LDF)',                                                        
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_LDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERLDF,                              
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_AQ,                                 
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_BQ,                                                        
	FLD_LDF_COD,FLD_LDF_BQ,FLD_LDF_AQ,FLD_LDF_DD,FLD_LDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,FLD_REMARK,FLD_UPD_BY  FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK)
	 WHERE FLD_SERVER_ID IN (SELECT * FROM #XX) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID  IN ('37')  
     )A  
                                                
	LEFT OUTER JOIN                                            
	(SELECT FLD_ID,FLD_SERVER,FLD_DB_IP,FLD_ODIN_IP FROM V_TBL_SERVER_MASTER(NOLOCK)) B                                                           
	ON A.FLD_SERVER_ID = B.FLD_ID                                                        
	LEFT OUTER JOIN                                                        
	(SELECT PERSON_NAME AS EMP_NAME,USERNAME  FROM INTRANET.RISK.DBO.USER_LOGIN)C                                                        
	ON A.FLD_UPD_BY = C.USERNAME                                               
	LEFT OUTER JOIN                                            
	(SELECT BR_TAG,BR_NAME FROM TBL_IT_BR_MASTER (NOLOCK)  WHERE BR_TYPE = 'DATACENTER' )D                                            
	ON A.FLD_BRANCH_ID = D.BR_TAG                                            
	ORDER BY FLD_BRANCH_ID
	
	
--	select   distinct  x.*,y.br_name as Branches,                                          
--case when x.Fld_Server like '%)' then substring(x.Fld_Server,0,charindex('(',x.Fld_Server)-1)       
--else x.Fld_Server end as Serv,      
--convert(numeric,case when x.Fld_Server like '%)' then substring(x.Fld_Server,charindex('(',x.Fld_Server)+1,                                           
--charindex(')',Convert(varchar,x.Fld_Server))-(charindex('(',Convert(varchar,x.Fld_Server))+1)) else 0 end) as Num,                            
--case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ Convert(varchar,x.fld_mdf_cod) + '</font>' else Convert(varchar,x.fld_mdf_cod) end as fld_mdf_cod,      
--case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ convert(varchar,x.fld_mdf_fs)+'</font>' else Convert(varchar,x.fld_mdf_fs) end as fld_mdf_fs,      
------case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_BQ+'</font>' else x.Fld_Mdf_BQ end as fld_m_BQ--,                            
--case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_BQ)+'</font>' else Convert(varchar,x.Fld_Mdf_BQ) end as fld_m_BQ,        
----case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_AQ+'</font>' else x.Fld_Mdf_AQ end as fld_m_AQ         
--case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_AQ)+'</font>' else Convert(varchar,x.Fld_Mdf_AQ) end as fld_m_AQ         
--from      
--(select * from #yy)x                                            
--left outer join                                            
--(select * from #yy where Fld_Remark <> '')y                                            
--on x.Fld_Branch_id = y.Fld_branch_Id                                            
---- and x.Fld_server_id = y.Fld_server_id and x.mdf_ldf = y.mdf_ldf                                            
--order by Serv,Num,x.Fld_id 
	
    END
  
    SELECT @COUNT1=COUNT(*) FROM #yy
    SELECT @TOTCTROT1=COUNT(1) FROM #yy     
     
     IF(@COUNT1=0)
     BEGIN 
     SET @MESS1='<B>NOTE:TCP COUNT HAS NOT BEEN UPDATED BY GHATKOPAR BRANCH.</B><BR><BR>'
     SET @MESS1=@MESS1+'HAVE A NICE DAY AHEAD.'
     SET @SUB ='TCP ' + CONVERT(VARCHAR(MAX),GETDATE())
     END
    ELSE
    BEGIN     
   SET @MESS1=                            
		   '<TABLE BORDER="1">                            
		   <TR>                       
		   <TH> SERVER </TH>              
		   <TH> ODIN IP</TH>                            
		   <TH> DATABASE IP </TH>                            
		   <TH> DATABASE</TH>    
		   <TH> BEFORE QUERY (GB)</TH>  
		   <TH>AFTER QUERY (GB)</TH> 
		   <TH>DISK DRIVE</TH>
		   <TH>CAPICITY OF DRIVE (GB)</TH>
		   <TH>FREE SPACE (GB)</TH>
		   <TH>REMARK</TH>     
		   <TH>ENTRY BY</TH>                         
		   </TR>'
		      
     SET @DATA1=''
     WHILE @CNT1 <= @TOTCTROT1                              
     BEGIN
     PRINT @CNT1 
     --chnage here
		 SELECT @SERVER_1=FLD_SERVER,@FLD_MDF_COD_1=FLD_MDF_COD,@FLD_MDF_BQ_1=FLD_MDF_BQ,@FLD_MDF_AQ_1=FLD_MDF_AQ,
      @FLD_MDF_FS_1=FLD_MDF_FS,@FLD_MDF_DD_1=FLD_MDF_DD,
      @MDF_LDF_1=MDF_LDF,@MDF_BQ_1=MDF_BQ,@MDF_AQ_1=MDF_AQ,
      @FLD_ODIN_IP_1=FLD_ODIN_IP,@FLD_DB_LP_1=FLD_DB_IP,@FLD_REMARK_1=FLD_REMARK,@FLD_UPD_BY_1=EMP_NAME
		  FROM #yy 
		  WHERE SRNO=1
		  
		 SELECT @LDF_DB_1=MDF_LDF,@LDF_BQ_1=MDF_BQ,@LDF_AQ_1=MDF_AQ
		 FROM #yy 
		  WHERE SRNO=2
		  
		  select a.srno from #yy a , #yy b
		  where a.fld_Server=b.fld_server
		
				 SET @DATA1=@DATA1+                                                   
				 '<TR>                          
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@SERVER_1) +' </TD>                         
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_ODIN_IP_1) +' </TD>                          
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_DB_LP_1) +' </TD>                          
				 <TD> '+ CONVERT(VARCHAR,@MDF_LDF_1) +' </TD>                          
				 <TD> '+ CONVERT(VARCHAR,@MDF_BQ_1) +' </TD> 
				 <TD> '+ CONVERT(VARCHAR,@MDF_AQ_1) +' </TD> 
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_DD_1) +' </TD> 
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_COD_1) +' </TD> 
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_FS_1) +' </TD> 
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_REMARK_1) +' </TD> 
				 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_UPD_BY_1) +' </TD> 
				 </TR>
					  <TR>
						<TD> '+ CONVERT(VARCHAR,@LDF_DB_1) +' </TD>                          
						<TD> '+ CONVERT(VARCHAR,@LDF_BQ_1) +' </TD> 
					    <TD> '+ CONVERT(VARCHAR,@LDF_AQ_1) +' </TD> 
					 </TR>'            
				  PRINT @DATA1                
				  SET   @CNT1=@CNT1+1    
				                                 
				 END 

		SET @MESS1='<BR><B> GHATKOPAR (E)</B> <BR><BR>'+ @MESS1 + @DATA1+'</TABLE>'
  
		SET @MESS='DEAR ALL,<BR><BR>GOOD MORNING!!!<BR><BR>GREETINGS OF THE DAY!<BR><BR>' + @MESS2 +  '<BR>'+@MESS1+'<BR>'
		SET @MESS=@MESS+'<BR><BR>THIS IS A SYSTEM GENERATED MESSAGE. PLEASE DO NOT REPLY.<BR><BR>REGARDS,<BR><BR>(IT HELPDESK)'                              
		SET @SUB ='TCP COUNT REPORT AS ON ' + CONVERT(VARCHAR(MAX),GETDATE())

 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
 @RECIPIENTS =@EMAILTO,                              
 @COPY_RECIPIENTS = @EMAILCC,                              
 @BLIND_COPY_RECIPIENTS=@EMAILBCC,                    
 @PROFILE_NAME = 'ANGELBROKING',                              
 @BODY_FORMAT ='HTML',                              
 @SUBJECT = @SUB ,                              
 @BODY =@MESS 
  
 END
-- End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DATABASE_ACCESS_LEVEL
-- --------------------------------------------------

create PROC DATABASE_ACCESS_LEVEL
 
 
AS
BEGIN
 
 
 
WITH    perms_cte as
 
(
 
        select USER_NAME(p.grantee_principal_id) AS principal_name,
 
                dp.principal_id,
 
                dp.type_desc AS principal_type_desc,
 
                p.class_desc,
 
                OBJECT_NAME(p.major_id) AS object_name,
 
                p.permission_name,
 
                p.state_desc AS permission_state_desc 
 
        from    sys.database_permissions p
 
        inner   JOIN sys.database_principals dp
 
        on     p.grantee_principal_id = dp.principal_id
 
)
 
--users
 
SELECT p.principal_name,  p.principal_type_desc, p.class_desc [Database level or object level], p.[object_name], p.permission_name, p.permission_state_desc, cast(NULL as sysname) as role_name
 
FROM    perms_cte p
 
WHERE   principal_type_desc <> 'DATABASE_ROLE'
 
UNION
 
--role members
 
SELECT rm.member_principal_name, rm.principal_type_desc, p.class_desc, p.object_name, p.permission_name, p.permission_state_desc,rm.role_name
 
FROM    perms_cte p
 
right outer JOIN (
 
    select role_principal_id, dp.type_desc as principal_type_desc, member_principal_id,user_name(member_principal_id) as member_principal_name,user_name(role_principal_id) as role_name--,*
 
    from   sys.database_role_members rm
 
    INNER   JOIN sys.database_principals dp
 
    ON     rm.member_principal_id = dp.principal_id
 
) rm
 
ON     rm.role_principal_id = p.principal_id
 
 
 
order by 1
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_ConvertQueryInHTMP_Page
-- --------------------------------------------------
CREATE proc [dbo].[DBA_ConvertQueryInHTMP_Page] (@objectname1 varchar(max),@HTMLBODY varchar(max) OUTPUT)       
as        
         
                        
        
 set nocount on                            
        
  IF EXISTS(SELECT 1 FROM sys.objects                                 
        
  WHERE OBJECT_ID = OBJECT_ID('DBA_TempHTML') AND type = ('U'))                                   
        
  DROP TABLE DBA_TempHTML                                
        
                          
        
  DECLARE @createtable nvarchar(max)                                
        
  set @createtable ='select * into DBA_TempHTML  from  ( '+''+ @objectname1+')A order by 1 desc'                          
        
  EXECUTE sp_executesql @createtable              
                       
        
                   
        
                         
        
  DECLARE @xmlquery2 nvarchar (max)                                
        
  DECLARE @name varchar(max)                          
        
                                
        
  DECLARE c1 CURSOR READ_ONLY                                
        
  FOR  select  'Column_name'   = name  from sys.all_columns where object_id = ( select object_id  from sys.all_objects                                 
        
  where object_id = object_id('DBA_TempHTML') )                                 
        
  OPEN c1                                
        
        DECLARE  @tempvar nvarchar(max)                                
        
        DECLARE @NEWCOLUMN nvarchar(max)                              
        
  SET @NEWCOLUMN=''                            
        
  set @tempvar=''                                 
        
                                
        
   FETCH NEXT FROM c1                                
        
   INTO @name                                
        
                                
        
   WHILE @@FETCH_STATUS = 0                                
        
    BEGIN                              
        
     SET @NEWCOLUMN =@NEWCOLUMN+'<th bgcolor="#EFF3FB">'+@name +'</th>'                          
        
     set @tempvar = @tempvar+ 'cast('+@name +' as varchar(MAX) )'+'+' + '''</td><td>''' +'+'                          
        
        FETCH NEXT FROM c1                                
        
     INTO @name                                
        
    END                                
        
  CLOSE c1                                
        
  DEALLOCATE c1                            
        
  SET @tempvar=  LEFT (@tempvar, LEN(@tempvar)-13)                          
        
                              
        
  declare @BODY nvarchar(max)                          
        
  SET @BODY=' select cast( (select td = '+@tempvar+ ' from (  SELECT top 100 percent* FROM DBA_TempHTML order by 1 desc) as d '+' for xml path( ''tr'' ), type ) as varchar(max) )'                          
        
                   
        
  print  @BODY                       
        
                
        
                         
        
  create table #temp                          
        
  (returnstr nvarchar (max))                          
        
  insert into #temp  exec sp_executesql  @body                          
        
  declare @returnstr2 nvarchar(max)                          
        
  select @returnstr2=LTRIM(RTRIM(returnstr)) from #temp                          
        
                        
        
  set @HTMLBODY = '<table cellpadding="1" cellspacing="1" border="1">'                          
        
                + '<tr>'+''+@NEWCOLUMN+ ''+'</tr>'                          
        
             + replace( replace( @returnstr2, '&lt;', '<' ), '&gt;', '>'  )                       
        
                + '</table>'                          
        
                          
        
select  @HTMLBODY                          
        
drop table #temp                          
        
drop table DBA_TempHTML

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_ConvertQueryInHTMP_Page08072013
-- --------------------------------------------------
CREATE proc [dbo].[DBA_ConvertQueryInHTMP_Page08072013] (@objectname1 varchar(max),@HTMLBODY varchar(max) OUTPUT)       
as        
      
 set nocount on       
      
  /*    
  declare @objectname1 varchar(max)    
  SELECT @objectname1='Select top 0* from demat.dbo.outstandingdebit_clientdetails'       
  */    
    
  --declare @objectname1 varchar(max)    
  --SELECT @objectname1='Select top 0* from demat.dbo.outstandingdebit_clientdetails'   
  --DECLARE @HTMLBODY varchar(max)   
         
  Declare @tablename varchar(100)    
  set @tablename='DBA_TempHTML'+replace(Convert(varchar(10),getdate(),108),':','')    
  --select @tablename    
      
  DECLARE @droptable nvarchar(max)       
      
     
  set @droptable ='DROP TABLE '+@tablename    
          
      
  IF EXISTS(SELECT 1 FROM sys.objects WHERE OBJECT_ID = OBJECT_ID(''+@tablename+'') AND type = ('U'))      
  EXECUTE sp_executesql @droptable      
      
      
      
  DECLARE @createtable nvarchar(max)       
  set @createtable ='select * into '+@tablename+'  from  ( '+''+ @objectname1+')A order by 1 desc'        
  EXECUTE sp_executesql @createtable     
      
        
  DECLARE @xmlquery2 nvarchar (max)       
  DECLARE @name varchar(max)        
      
  DECLARE c1 CURSOR READ_ONLY       
  FOR  select 'Column_name' = name from sys.all_columns       
  where object_id = ( select object_id from sys.all_objects where object_id = object_id('DBA_TempHTML'))      
        
  OPEN c1       
      
  DECLARE @tempvar nvarchar(max)       
  DECLARE @NEWCOLUMN nvarchar(max)         
  SET @NEWCOLUMN=''       
  set @tempvar=''        
  FETCH NEXT FROM c1       
  INTO @name       
  WHILE @@FETCH_STATUS = 0       
      
BEGIN         
      
 --SET @NEWCOLUMN =@NEWCOLUMN+'<th bgcolor="#538ED5">'+@name +'</th>'      
 SET @NEWCOLUMN =@NEWCOLUMN+'<th bgcolor="#538ED5"       
 style="font-family:TREBUCHET MS;color:WHITE;font-size:14px;align=center"><b>      
 '+@name +'</b></th>'      
 set @tempvar = @tempvar+ 'cast('+@name +' as varchar(MAX) )'+'+' + '''</td><td>''' +'+'        
 FETCH NEXT FROM c1       
 INTO @name       
      
END       
      
  CLOSE c1       
  DEALLOCATE c1       
  PRINT @tempvar      
  SET @tempvar=  LEFT (@tempvar, LEN(@tempvar)-13)        
        
  declare @BODY nvarchar(max)        
        
  SET @BODY=' select cast( (select td = '+@tempvar+ ' from (  SELECT top 100 percent* FROM DBA_TempHTML order by 1 desc) as d '+' for xml path( ''tr'' ), type ) as varchar(max) )'        
  print  @BODY         
      
  create table #temp (returnstr nvarchar (max))        
  insert into #temp        
  exec sp_executesql  @body        
  declare @returnstr2 nvarchar(max)        
  select @returnstr2=LTRIM(RTRIM(returnstr)) from #temp        
      
  set @HTMLBODY = '<table cellpadding="1" cellspacing="1" border="1" style="font-family:TREBUCHET MS;font-size:14px;">'        
+ '<tr style="font-family:TREBUCHET MS;font-size:14px;align=center;">'+''+@NEWCOLUMN+ ''+'</tr>'        
+ replace( replace( @returnstr2, '&lt;', '<' ), '&gt;', '>'  )         
+ '</table>'        
      
select @HTMLBODY        
drop table #temp        
--drop table DBA_TempHTML      
EXECUTE sp_executesql @droptable

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXCEL_UPLOAD_ITAsset
-- --------------------------------------------------
CREATE proc EXCEL_UPLOAD_ITAsset                 
(                                  
@filename as varchar(100)                                        
)                                    
as     
--declare @filename as varchar(100)                 
--set @filename='Test1.xls'
declare @path as varchar(200)                                              
declare @sql as varchar(1000)                        
declare @sql1 as varchar(1000)                      
truncate table Temp_tbl_ITAssetsData
set @path='\\196.1.115.136\d$\upload1\ITAssetDetails\'+ @filename                                
--SET @SQL = 'insert into V_Upload_tbl_ITAssetsData select * FROM OPENROWSET(''Microsoft.Jet.OLEDB.4.0'',''Excel 8.0;DATABASE='+@path+''',''Select * from [Sheet1$]'' )'                       
SET @SQL1 = 'insert into Temp_tbl_ITAssetsData select * FROM OPENROWSET(''Microsoft.Jet.OLEDB.4.0'',''Excel 8.0;DATABASE='+@path+''',''Select * from [Sheet1$]'' )'                       
--print @SQL   
          
exec (@sql1)   
--if(select Count(Fld_AssetTag) from tbl_ITAssetsData where Fld_AssetTag not in (select Fld_AssetTag from Temp_tbl_ITAssetsData)<>0)
--begin
--	exec (@sql)   
--end
select *,Status='Repeated' into #file1 from Temp_tbl_ITAssetsData where Fld_AssetTag in (select Fld_AssetTag from tbl_ITAssetsData)
select *,Status='New' into #file2 from Temp_tbl_ITAssetsData where Fld_AssetTag not in (select Fld_AssetTag from tbl_ITAssetsData)
/*---Insertion of data--*/
insert into V_Upload_tbl_ITAssetsData 
select * from Temp_tbl_ITAssetsData where Fld_AssetTag not in (select Fld_AssetTag from tbl_ITAssetsData)
/*--No Insertion of data*/

--------update date----------------------------------------------------------  
update tbl_ITAssetsData set Fld_WarrantyTo = convert(varchar(11),convert(datetime,Fld_WarrantyTo,103),103),  
Fld_WarrantyFrom = convert(varchar(11),convert(datetime,Fld_WarrantyFrom,103),103)  
from tbl_ITAssetsData  
------------------------------------------------------------------------------
-----------------------------Product Name Master-------------------------------------
insert into tbl_IT_ProductNameMaster 
select distinct Fld_ProductName from tbl_ITAssetsData(nolock) where Fld_ProductName not in (select Fld_ProductName from tbl_IT_ProductNameMaster(nolock))

-----------------------------Product Type Master-------------------------------------
insert into tbl_IT_ProductTypeMaster 
select distinct Fld_ProductType from tbl_ITAssetsData(nolock) where Fld_ProductType not in (select Fld_ProductType from tbl_IT_ProductTypeMaster(nolock))

-----------------------------Asset Master-------------------------------------
insert into tbl_IT_Assetmaster 
select distinct Fld_AssetName from tbl_ITAssetsData(nolock) where Fld_AssetName not in (select Fld_AssetName from tbl_IT_Assetmaster(nolock))

-----------------------------Vendor Master-------------------------------------
--insert into tbl_IT_VendorMaster 
--select distinct Fld_VendorName from tbl_ITAssetsData(nolock) where Fld_VendorName not in (select Fld_VendorName from tbl_IT_VendorMaster(nolock))

-----------------------------Assign To Dept Master-------------------------------------
insert into tbl_IT_AssignToDeptMaster 
select distinct Fld_AssignToDept from tbl_ITAssetsData(nolock) where Fld_AssignToDept not in (select Fld_AssignToDeptName from tbl_IT_AssignToDeptMaster(nolock))

-----------------------------Location Master-------------------------------------
--insert into tbl_IT_LocationMaster 
--select distinct Fld_BranchCode from tbl_ITAssetsData(nolock) where Fld_BranchCode not in (select Fld_LocationName from tbl_IT_LocationMaster(nolock))


select s=count(*) from #file1
select s1=count(*) from #file2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXCEL_UPLOAD_ITAsset1
-- --------------------------------------------------
    
      
CREATE proc [dbo].[EXCEL_UPLOAD_ITAsset1]                
(                            
@filename as varchar(100),    
@server as varchar(20)                                  
)                              
as                
declare @path as varchar(100)                                        
declare @sql as varchar(1000)                  
--truncate table tbl_ITAssetsData                
          
create table #temp          
(Fld_Srno int identity(1,1),Fld_ProductModel varchar(50),Fld_ProductDesc varchar(50),Fld_AssetName varchar(50),Fld_PartNo varchar(50),          
Fld_VendorName varchar(50),Fld_Rate varchar(50),Fld_WarrantyFrom varchar(50),Fld_WarrantyTo varchar(50),          
Fld_BranchCode varchar(50),Fld_AssignToDept varchar(50),Fld_BillNo varchar(50),Fld_ChallanNo varchar(50),          
Fld_Purpose varchar(50),Fld_CapexName varchar(50),Fld_WarrantyType varchar(50))          
            
/*set @path = (Select uploadserver from [196.1.115.182].Upload.DBO.Global_Upload where upd_srno = 2)            
set @path = @path +'ITAssetDetails\' + @filename*/            
      
set @path='\\'+@server+'\d$\upload1\ITAssetDetails\' + @filename                      
SET @SQL = 'insert into #temp select * FROM OPENROWSET(''Microsoft.Jet.OLEDB.4.0'',''Excel 8.0;DATABASE='+@path+''',''Select * from [sheet1$]'' )'             
--print @SQL                            
exec (@sql)       
         
-------------------------------------------------------          
DECLARE @Fld_BranchCode varchar(25)                              
DECLARE @Fld_AssetName varchar(25)          
DECLARE @Fld_Srno varchar(10)                                    
                            
DECLARE fatchRecords CURSOR READ_ONLY FORWARD_ONLY LOCAL FOR                               
select Fld_Srno,Fld_BranchCode,Fld_AssetName from #temp                                 
                              
OPEN fatchRecords                               
FETCH NEXT FROM fatchRecords INTO @Fld_Srno,@Fld_BranchCode,@Fld_AssetName                               
                              
WHILE @@FETCH_STATUS <> -1                               
BEGIN                               
-----------------Generate Asset Tag--------------------                                   
                                  
declare @assetTag as  varchar(100)                                        
declare @Tag as varchar(50)                                    
                                  
select @Tag=@Fld_BranchCode+'/'+@Fld_AssetName+'/'                      
if (select count(Fld_AssetTag) from tbl_ITAssetsData(nolock) where Fld_AssetTag like''+@Tag+'%') = 0                                                
 begin                                                  
  set @assetTag = @Tag+'0001'                                                
 end                                                
else                                                
 begin                                       
  declare @assetCount as varchar(4)                                                
  set @assetCount =(select right(Max(Fld_AssetTag),4) from tbl_ITAssetsData(nolock) where Fld_AssetTag like ''+@Tag+'%')                                                
  set @assetCount=replace(str(isnull(@assetCount+1,0),4),' ',0)                                                            
  set @assetTag = @Tag+@assetCount                                    
 end                                   
--print @assetTag                    
                           
insert into tbl_ITAssetsData          
Select '0','','',isnull(Fld_ProductModel,'')Fld_ProductModel,isnull(Fld_ProductDesc,'')Fld_ProductDesc,      
isnull(Fld_AssetName,'')Fld_AssetName,@assetTag,isnull(Fld_PartNo,'')Fld_PartNo,isnull(Fld_VendorName,'')Fld_VendorName,      
'1',isnull(Fld_Rate,0)Fld_Rate,isnull(Fld_WarrantyFrom,'')Fld_WarrantyFrom,isnull(Fld_WarrantyTo,'')Fld_WarrantyTo,      
isnull(Fld_BranchCode,'')Fld_BranchCode,isnull(Fld_AssignToDept,'')Fld_AssignToDept,isnull(Fld_BillNo,'')Fld_BillNo,    
isnull(Fld_ChallanNo,'')Fld_ChallanNo,isnull(Fld_Purpose,'')Fld_Purpose,      
'S',getdate(),isnull(Fld_CapexName,'')Fld_CapexName,isnull(Fld_WarrantyType,'')Fld_WarrantyType,      
'','' from #temp where Fld_Srno=@Fld_Srno          
                            
FETCH NEXT FROM fatchRecords INTO @Fld_Srno,@Fld_BranchCode,@Fld_AssetName                              
END                               
CLOSE fatchRecords                               
DEALLOCATE fatchRecords           
-------------------------------------         
select s1=count(*) from #temp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXCEL_UPLOAD_ITAsset2
-- --------------------------------------------------

CREATE proc EXCEL_UPLOAD_ITAsset2                
(                            
@filename as varchar(100),  
@server as varchar(20)                                  
)                              
as                
declare @path as varchar(100)                                        
declare @sql as varchar(1000)                  
--truncate table tbl_ITAssetsData                
          
create table #temp          
(Fld_Srno int identity(1,1),Fld_ProductModel varchar(50),Fld_ProductDesc varchar(50),Fld_AssetName varchar(50),Fld_PartNo varchar(50),          
Fld_VendorName varchar(50),Fld_Rate varchar(50),Fld_WarrantyFrom varchar(50),Fld_WarrantyTo varchar(50),          
Fld_BranchCode varchar(50),Fld_AssignToDept varchar(50),Fld_BillNo varchar(50),Fld_ChallanNo varchar(50),          
Fld_Purpose varchar(50),Fld_CapexName varchar(50),Fld_WarrantyType varchar(50))          
            
/*set @path = (Select uploadserver from [196.1.115.182].Upload.DBO.Global_Upload where upd_srno = 2)            
set @path = @path +'ITAssetDetails\' + @filename*/            
      
set @path='\\'+@server+'\d$\upload1\ITAssetDetails\' + @filename                      
SET @SQL = 'insert into #temp select * FROM OPENROWSET(''Microsoft.Jet.OLEDB.4.0'',''Excel 8.0;DATABASE='+@path+''',''Select * from [sheet1$]'' )'             
--print @SQL                            
exec (@sql)       
         
-------------------------------------------------------          
DECLARE @Fld_BranchCode varchar(25)                              
DECLARE @Fld_AssetName varchar(25)          
DECLARE @Fld_Srno varchar(10)                                    
                            
DECLARE fatchRecords CURSOR READ_ONLY FORWARD_ONLY LOCAL FOR                               
select Fld_Srno,Fld_BranchCode,Fld_AssetName from #temp                                 
                              
OPEN fatchRecords                               
FETCH NEXT FROM fatchRecords INTO @Fld_Srno,@Fld_BranchCode,@Fld_AssetName                               
                              
WHILE @@FETCH_STATUS <> -1                               
BEGIN                               
-----------------Generate Asset Tag--------------------                                   
                                  
declare @assetTag as  varchar(100)                                        
declare @Tag as varchar(50)                                    
                                  
select @Tag=@Fld_BranchCode+'/'+@Fld_AssetName+'/'                      
if (select count(Fld_AssetTag) from tbl_ITAssetsData(nolock) where Fld_AssetTag like''+@Tag+'%') = 0                                                
 begin                                                  
  set @assetTag = @Tag+'0001'                                                
 end                                                
else                                                
 begin                                       
  declare @assetCount as varchar(4)                                                
  set @assetCount =(select right(Max(Fld_AssetTag),4) from tbl_ITAssetsData(nolock) where Fld_AssetTag like ''+@Tag+'%')                                                
  set @assetCount=replace(str(isnull(@assetCount+1,0),4),' ',0)                                                            
  set @assetTag = @Tag+@assetCount                                    
 end                                   
--print @assetTag                    
                           
insert into tbl_ITAssetsData          
Select '0','','',isnull(Fld_ProductModel,'')Fld_ProductModel,isnull(Fld_ProductDesc,'')Fld_ProductDesc,      
isnull(Fld_AssetName,'')Fld_AssetName,@assetTag,isnull(Fld_PartNo,'')Fld_PartNo,isnull(Fld_VendorName,'')Fld_VendorName,      
'1',isnull(Fld_Rate,0)Fld_Rate,isnull(Fld_WarrantyFrom,'')Fld_WarrantyFrom,isnull(Fld_WarrantyTo,'')Fld_WarrantyTo,      
isnull(Fld_BranchCode,'')Fld_BranchCode,isnull(Fld_AssignToDept,'')Fld_AssignToDept,isnull(Fld_BillNo,'')Fld_BillNo,      
isnull(Fld_ChallanNo,'')Fld_ChallanNo,isnull(Fld_Purpose,'')Fld_Purpose,      
'U',getdate(),isnull(Fld_CapexName,'')Fld_CapexName,isnull(Fld_WarrantyType,'')Fld_WarrantyType,      
'','' from #temp where Fld_Srno=@Fld_Srno          
                            
FETCH NEXT FROM fatchRecords INTO @Fld_Srno,@Fld_BranchCode,@Fld_AssetName                              
END                               
CLOSE fatchRecords                               
DEALLOCATE fatchRecords           
-------------------------------------         
select s1=count(*) from #temp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.find_opjects
-- --------------------------------------------------

/*Shows all the column names from where it is getting updated*/

create proc find_opjects
as

DECLARE @TableName Varchar(100) = 'TERMINAL_BROK_LOSS'
DECLARE @ColumnName Varchar(100) = ''

--SELECT DISTINCT CALLING_OBJECT
SELECT *
FROM (
select	  OBJECT_NAME(d3.id) AS 'Calling_Object', type = substring(v2.name, 5, 66)
		, 'Affecting_Object' = (s6.name+ '.' + o1.name), updated = substring(u4.name, 1, 7)
		, selected = substring(w5.name, 1, 8), 'column' = col_name(d3.depid, d3.depnumber)
from	sys.objects o1
		INNER JOIN master.dbo.spt_values v2
			ON o1.type = substring(v2.name,1,2) collate database_default and v2.type = 'O9T'
		INNER JOIN sysdepends d3
			ON o1.object_id = d3.depid AND d3.deptype < 2
		INNER JOIN master.dbo.spt_values u4
			ON u4.number = d3.resultobj AND u4.type = 'B'
		INNER JOIN master.dbo.spt_values w5
			ON w5.number = d3.readobj|d3.selall AND w5.type = 'B'
		INNER JOIN sys.schemas s6
			ON o1.schema_id = s6.schema_id
where	o1.name = ISNULL(NULLIF(@TableName, ''), o1.name)
AND col_name(d3.depid, d3.depnumber) = ISNULL(NULLIF(@ColumnName, ''), col_name(d3.depid, d3.depnumber))
AND	  u4.name = 'yes'

) a

GO

-- --------------------------------------------------
-- PROCEDURE dbo.find_table
-- --------------------------------------------------
CREATE proc find_table @content varchar(20)    
as     
--print @content  
--declare   @content as varchar(20)
--set @content=''
--print 'a'+@content+'a'
select * from information_schema.tables where table_name like '%'+@content+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GCompNo
-- --------------------------------------------------
create proc GCompNo
as 
set nocount on

select complaintno=left(replace(convert(varchar,getdate(),103),'/',''),4)+ right(replace(convert(varchar,getdate(),103),'/',''),2) + '0' into #t 

declare @a as varchar(20)
set @a=(select  max(substring(complaintno,7,5) + 1) from #t)
select Top 1 complaintno=left(complaintno,6)+ @a from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.generate_chartdata
-- --------------------------------------------------
CREATE Procedure generate_chartdata (@opt int,@br varchar(8),@fdate as varchar(11),@tdate as varchar(11))
as
select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title='ABC' from qa_survey_ans1 a
left outer join
(select id,sdate from qa_survey_ans2 ) b
on a.id_ans2=b.id
where a.ques_no in(2,3) and left(Ans,1) in ('Y','S')
union
select 'No' as Prod, Total=count(Ans),color='#000099',title='ABC' from qa_survey_ans1 a
left outer join
(select id,sdate from qa_survey_ans2 ) b
on a.id_ans2=b.id
where a.ques_no in(2,3) and left(Ans,1)='N'
union
select 'NA' as Prod, Total=count(Ans),color='#ff0033',title='ABC' from qa_survey_ans1 a
left outer join
(select id,sdate from qa_survey_ans2 ) b
on a.id_ans2=b.id
where a.ques_no in(2,3) and replace(Ans,' ','')=''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.generate_chartdata_1
-- --------------------------------------------------
CREATE Procedure generate_chartdata_1   
as  


select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title='ABC' from qa_survey_ans1 a  
left outer join  
(select id,sdate from qa_survey_ans2 ) b  
on a.id_ans2=b.id  
where a.ques_no in(2,3) and left(Ans,1) in ('Y','S')  
union  
select 'No' as Prod, Total=count(Ans),color='#000099',title='ABC' from qa_survey_ans1 a  
left outer join  
(select id,sdate from qa_survey_ans2 ) b  
on a.id_ans2=b.id  
where a.ques_no in(2,3) and left(Ans,1)='N'  
union  
select 'NA' as Prod, Total=count(Ans),color='#ff0033',title='ABC' from qa_survey_ans1 a  
left outer join  
(select id,sdate from qa_survey_ans2 ) b  
on a.id_ans2=b.id  
where a.ques_no in(2,3) and replace(Ans,' ','')=''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.generate_chartdata1
-- --------------------------------------------------
CREATE Procedure generate_chartdata1 (@opt varchar(3),@br varchar(8),@fdate as varchar(11),@tdate as varchar(11)) as            
          
declare @yes as varchar(10),@no as varchar(10),@Avg as varchar(10),@Na as varchar(10)          
,@Good as varchar(10),@Bad as varchar(10)                  
select @yes=color from qa_graph_color where options='YES'          
select @no=color from qa_graph_color where options='No'          
select @Na=color from qa_graph_color where options='Na'          
select @Avg=color from qa_graph_color where options='Average'          
select @Good=color from qa_graph_color where options='Good'          
select @Bad=color from qa_graph_color where options='Bad'          
/*          
'#ff3399'          
#000099          
#ff0033          
*/          
          
if @opt='1'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br ) b                    
 on a.id_ans2=b.id                    
 where a.ques_no in(2,3) and left(Ans,1) in ('Y','S')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br ) b                    
 on a.id_ans2=b.id                    
 where a.ques_no in(2,3) and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no in(2,3) and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by title                     
END                    
if @opt='2'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =4 and left(Ans,1) in ('Y','S')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no  =4and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =4 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate   order by title                  
END                    
if @opt='3A'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =5 and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join          
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =5 and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate           
 union       
 select 'Na' as Prod, Total=count(Ans),color=@Avg,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no  =5 and sub_ques='' and left(Ans,1)=''                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                       
 union                    
 select 'Avg' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no  =5 and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by  title          
END                    
if @opt='3B'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =6 and left(Ans,1) ='G'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                  
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =6 and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate      
 union                    
 select 'Na' as Prod, Total=count(Ans),color=@na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no  =6 and sub_ques='' and left(Ans,1)=''                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate             
 union                    
 select 'Avg' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no  =6 and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                        
END                    
if @opt='4'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =12 and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate          
union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =12 and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =12 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                               
 union                    
 select 'Avg' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no  =12 and left(Ans,1)='A'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by  title       
          
END                    
                    
if @opt='5'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =13 and left(Ans,1) <>'N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id         
 where a.ques_no =13 and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate            
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@nA,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =13 and left(Ans,1)=' '                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by  title                     
END                    
if @opt='6'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =14 and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =14 and left(Ans,1)<>'Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate          
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@nA,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =14 and left(Ans,1)=' '                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                    
END                    
if @opt='7A'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =15 and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =15 and left(Ans,1)<>'Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate        
union                    
 select 'NA' as Prod, Total=count(Ans),color=@no,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =15 and left(Ans,1)=' '                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                     
END                    
if @opt='7B'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =16 and left(Ans,1) ='Y'       
  and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a       left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =16 and left(Ans,1)<>'Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate        
union                    
 select 'NA' as Prod, Total=count(Ans),color=@no,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =16 and left(Ans,1)=' '                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                     
END                    
if @opt='8'          
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='A' and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                 
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='A'  and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='A'  and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
union                    
 select 'Average' as Prod, Total=count(Ans),color=@avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='A'  and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by  title            
END                
if @opt='9'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='B' and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                           
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='B'  and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='B'  and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate         
union                    
 select 'Average' as Prod, Total=count(Ans),color=@avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='B'  and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                       
END                       
if @opt='10'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='C' and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                 
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='C'  and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='C'  and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate           
union                    
 select 'Average' as Prod, Total=count(Ans),color=@avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='C'  and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by  title                       
END                    
               
if @opt='11'     
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='D' and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                                  
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='D'  and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='D'  and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate         
union                    
 select 'Average' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='D'  and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate   order by  title              
END                 
if @opt='12'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='E' and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                    
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='E'  and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='E'  and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate          
union                    
 select 'Average' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =18 and Sub_ques='E' and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by  title                     
END                       
if @opt='13'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =19  and left(Ans,1) ='G'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
             
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =19   and left(Ans,1)='B'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =19 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate        
union                    
 select 'Average' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =19   and left(Ans,1)='A'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                           
END                    
if @opt='14A'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =20  and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                              
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a       left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =20   and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =20 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate        
union                    
 select 'Average' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =20   and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by  title                         
END                    
if @opt='14B'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =21  and left(Ans,1) ='G'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                    
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =21   and left(Ans,1)='B'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =21 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate        
union                    
 select 'Average' as Prod, Total=count(Ans),color=@avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =21   and left(Ans,1)='A'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                      
END                    
if @opt='15A'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='A' and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                 
 union                    
 select 'No' as Prod, Total=count(Ans),color=@bad,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='A'  and left(Ans,2)='NO'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='A' and left(Ans,2)='NA'    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate        
 union                    
 select 'Average' as Prod, Total=count(Ans),color=@avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='A'  and left(Ans,1)='S'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                        
END                    
if @opt='15B'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a               
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='B'  and left(Ans,1) ='G'             
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                   
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='B'  and left(Ans,1)='B'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='B' and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
union                    
 select 'Average' as Prod, Total=count(Ans),color=@avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =22 and Sub_ques='B'  and left(Ans,1)='A'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title          
END                    
if @opt='16'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =23  and left(Ans,1) ='Y'               
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =23   and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =23 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title                    
END                    
if @opt='17'                    
BEGIN                    
 select 'Good' as Prod, Total=count(Ans),color=@good,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =24  and left(Ans,1) ='G'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
                  
 union                    
 select 'Bad' as Prod, Total=count(Ans),color=@bad,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =24   and left(Ans,1)='B'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =24 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
union                    
 select 'Avg' as Prod, Total=count(Ans),color=@Avg,title=4 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =24   and left(Ans,1)='A'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title          
END                    
if @opt='18'                    
BEGIN                    
 select 'Yes' as Prod, Total=count(Ans),color=@yes,title=1 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =26  and left(Ans,1) ='Y'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'No' as Prod, Total=count(Ans),color=@no,title=2 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =26   and left(Ans,1)='N'                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
 union                    
 select 'NA' as Prod, Total=count(Ans),color=@Na,title=3 from qa_survey_ans1 a                    
 left outer join                    
 (select id,sdate from qa_survey_ans2 where type='CLI' and branch=@br) b                    
 on a.id_ans2=b.id                    
 where a.ques_no =26 and left(replace(Ans,' ',''),2) in ('NA','')                    
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by  title         
                    
END 
if @opt='19'                    
BEGIN   
                     
/*select 'Calls' as Prod , total=count(1) ,color='',title=1
 from complaint_table where Complaint_date >= 'Jul 01 2008'
and Complaint_date <= 'Aug 30 2008' and entered_through='HD' and  entry_by like '%' and department like '%' and status like '%' and wrong_entry <> 'Y'*/

select 'Calls' as Prod, Total=42919,color='',title=1 --from qa_survey_ans1 a                    
                 
 union                    
 select 'No' as Prod, Total=20,color=@no,title=2 --from qa_survey_ans1 a                    
  union                    
 select 'NA' as Prod, Total=55,color=@Na,title=3-- from qa_survey_ans1 a                    
                     
                    
END 
if @opt='20'                    
BEGIN   
                     
select 'Calls' as Prod , Total=count(1) ,color='',title=1
 from complaint_table where Complaint_date >= 'Jul 01 2008'
 and Complaint_date <= 'Aug 30 2008' and entered_through='HD' and  entry_by like '%' and department like '%' and    status like '%' and wrong_entry <> 'Y'

--select 'Calls' as Prod, Total=42919,color='',title=1 --from qa_survey_ans1 a                    
                 
 union                    
 select 'No' as Prod, Total=20,color=@no,title=2 --from qa_survey_ans1 a                    
  union                    
 select 'NA' as Prod, Total=55,color=@Na,title=3-- from qa_survey_ans1 a                    
                     
                    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetDateList
-- --------------------------------------------------
  
CREATE Proc GetDateList  
  
@Start As datetime,  
@End As  datetime  


-- Created By	: Mahendra Bonde
-- Created On	: 27 Apr 2011
-- Description	: List Of Dates between Two Dates
-- Modifief By	:
-- Modified Date: 
  
As  
Begin  
  
 DECLARE @AllDates table     
 (Date datetime)    
   
 CREATE TABLE dbo.Number   
 (   
  Number INT IDENTITY(1,1) PRIMARY KEY CLUSTERED   
 )   
    
 WHILE COALESCE(SCOPE_IDENTITY(), 0) <= 1024   
 BEGIN   
  INSERT dbo.Number DEFAULT VALUES   
 END  
  
 --SELECT @Start = '06/23/2008', @End = '06/30/2008'    
  
 INSERT INTO @AllDates (Date)       
 SELECT @Start+Number-1 FROM Number           
 WHERE Number<=DATEDIFF(day,@Start,@End)+1    
   
 SELECT * FROM @AllDates   
  
 Drop Table Number  
   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GetID_Opt
-- --------------------------------------------------
CREATE Proc GetID_Opt  
as 
Set Nocount On 
declare @id as int  
select @id=max(id) from ID_temp_opt  
insert into ID_temp_opt select @id+1  
select ID=@id+1

Set Nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.HR_send_mail
-- --------------------------------------------------
CREATE proc HR_send_mail    
(    
@PTO AS VARCHAR(50), @cc_mail as varchar(500),@frm as varchar(500),@msg as varchar(500),@Sub as varchar(500),@file as varchar(500)    
)    
as     
        
DECLARE @rc INT                   
IF NOT EXISTS (SELECT * FROM intranet.msdb.sys.service_queues                   
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                  
EXEC @rc = intranet.msdb.dbo.sysmail_start_sp   
                            
EXEC intranet.msdb.dbo.sp_send_dbmail                                                                      
                                        
@recipients  = @PTO,                                  
--@TO = 'Angel Harmony',   
@profile_name = 'harmony', 
--@from = @frm,                                         
@copy_recipients  = @cc_mail,                                               
@body  = @msg,            
@subject = @Sub,                                  
@file_attachments   = @file,                          
@body_format  = 'html'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IT_helpdesk_Automation_AOTD
-- --------------------------------------------------



CREATE Procedure [dbo].[IT_helpdesk_Automation_AOTD]                
as
Begin

DECLARE @Emp_name as varchar(100),@emp_email as varchar(100),@cnt int              
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(max),@MESS NVARCHAR(MAX)                            
    --SELECT @emailto='renil.pillai@angelbroking.com;nimesh.sanghvi@angelbroking.com;prashant.patade@angelbroking.com;sandeep.rai@angelbroking.com' 
      SELECT @emailto='networkadmin@angelbroking.com; odinadmin@angelbroking.com; cso.infrateam@angelbroking.com; bo.support@angelbroking.com;serveradmin@angelbroking.com'
    --SELECT @emailto='prashant.patade@angelbroking.com' 
    Select @emailcc=' rohit.ambosta@angelbroking.com; Ithelpdeskakruti@angelbroking.com;devanshu.desai@angelbroking.com'
    SELECT @emailbcc='sandeep.rai@angelbroking.com;prashant.patade@angelbroking.com'
  declare @Count int,@CountEnd int,@Fld_DateTime as datetime, @Fld_ComplainNo as varchar(50),@Status as varchar(50),
  @Fld_Business_dntime as varchar(50),@Fld_Reason as varchar(50),@Category as varchar(500)
  
  
             
  DECLARE @MessBody NVARCHAR(MAX),@MESS2 NVARCHAR(MAX)            
  DECLARE @xml NVARCHAR(MAX)              
   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0  
   
      set @Data=''                
    set @MessBody=''                          
    set @MESS2=''          
    set @Count=1
       set @cnt=1 
    --drop table #aa
    select  row_number()over (order by Fld_ComplainNo) As Srno, Fld_ComplainNo,Status,Fld_Business_dntime,Fld_Reason,Category,Fld_DateTime
    into #aa 
    from v_aotd_rpt  
    where convert(varchar(12),Fld_DateTime,106)=CONVERT(varchar(12),getdate(),106) and Fld_Reason='pending'
    --from tbl_Order_Confirmation     
   --drop table #aa
    select   @Count=count(*) from #aa 
     SELECT @totctrOT=count(1) from #aa 
 
   print @MESS  
    if(@Count=0)
    Begin
      print 'hi'
      
      set @MESS2='<b> AOTD has not been updated by Back office, Infrastructure, V-sat and System team.</b><br><br>'
       set @MESS2=@MESS2+'Have a nice day ahead.'
     set @sub ='Order Confirmation Report not updated as on ' + Convert(varchar(max),GETDATE())

    print @MESS
   --SET @MESS2='<Br><B>Equity</B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
    End
      else
    begin
     SET @MESS2=                            
   '<Table border="1">                            
   <tr>                       
    <th> Complain No </th>                            
       <th> Business down time </th>                            
       <th> Status  </th>                            
       <th> Reason</th>    
       <th> Category </th>  
       <th> Date and Time</th>                              
   </tr>' 
   
     set @Data=''
     WHILE @cnt <= @totctrOT                              
     BEGIN
     print @cnt
    
     --WHILE @Count <= @totctrOT                              
     --BEGIN
   -- SELECT @Date=Fld_Upd_Time,@BranchName=Br_Name,@CONTACTPERSON=Fld_Contact_Person,@CONFIRMATIONTIME=convert(varchar(11),Fld_Confimation_Time,103),@STATUS=Fld_Staus,@REASON=Fld_Reason
		 --FROM #bb WHERE Srno=@count                                   
		 SELECT @Fld_ComplainNo=Fld_ComplainNo,@Fld_Business_dntime=Fld_Business_dntime,@Status=Status,@Fld_Reason=Fld_Reason,@Category=Category,@Fld_DateTime=Fld_DateTime--convert(varchar(11),Fld_DateTime,103)
		 FROM #aa WHERE Srno=@count 
      set @Data=@Data+                           
     '<tr>                          
     <td> '+ CONVERT(VARCHAR,@Fld_ComplainNo) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@Fld_Business_dntime) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@Status) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@Fld_Reason) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@Category) +' </td> 
     <td> '+ CONVERT(VARCHAR,@Fld_DateTime) +' </td> 
     
       </tr>'           
      -- print @Data                         
        SET   @cnt=@cnt+1                                    
    END
     print @Data
    SET @MESS2='<Br><B> IT helpdesk Automation AOTD For Pending</B> <Br><Br>'+ @MESS2 + @Data +'</Table>'                       
 
  set @sub ='Pending ' + Convert(varchar(max),GETDATE())
    
    End
    
   --SET @MESS2='<Br><B> IT helpdesk Automation AOTD For Pending</B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
   -- End
   -- else
   -- begin
   --  select 'No data Updated'
   -- End
    
    /*PENDING*/
    
    
    declare @Count1 int,@date1 as varchar(20),@totctrOT1 as int=0,@Fld_DateTime_1 as datetime, @Fld_ComplainNo_1 as varchar(50),@Status_1 as varchar(50),
  @Fld_Business_dntime_1 as varchar(50),@Fld_Reason_1 as varchar(50),@Category_1 as varchar(500),@cnt1 int 
    
	 
	 
                 
	  DECLARE @MessBody1 NVARCHAR(MAX) ,@MESS1 NVARCHAR(MAX)          
--	  DECLARE @xml NVARCHAR(MAX)              
	  DECLARE @Data1 NVARCHAR(MAX)          
          
    set @Data1=''                
    set @MessBody1=''                          
    set @MESS1=''          
    set @Count1=1 
    set @cnt1=1 
    
    select  row_number()over (order by Fld_ComplainNo) As Srno, Fld_ComplainNo,Status,Category,Fld_DateTime
    into #bb 
    from v_aotd_rpt  
    where convert(varchar(12),Fld_DateTime,106)=CONVERT(varchar(12),getdate(),106) and Status='No Issue'
    --from tbl_Order_Confirmation     
   --drop table #aa
   select   @Count1=count(*) from #bb 
     SELECT @totctrOT1=count(1) from #bb 
     
     
   
   --print @MESS  
   if(@Count1=0)
    Begin 
    print 'hi'
     set @MESS1='<b>AOTD has not been updated by Back office, Infrastructure, V-sat and System team.</b><br><br>'
       set @MESS1=@MESS1+'Have a nice day ahead.'
     set @sub ='AOTD Report as on  ' + Convert(varchar(max),GETDATE())

    --print @MESS
   --SET @MESS2='<Br><B>Equity</B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
    End
    
    else
    begin
    SET @MESS1=                            
   '<Table border="1">                            
   <tr>                       
       <th> Complaint No </th>                            
       <th> Category </th>                            
       <th> Status  </th>  
       <th> Date and Time</th>                          
                                   
   </tr>' 
     set @Data1=''
     WHILE @cnt1 <= @totctrOT1                              
     BEGIN
     print @cnt1 
   -- SELECT @Date=Fld_Upd_Time,@BranchName=Br_Name,@CONTACTPERSON=Fld_Contact_Person,@CONFIRMATIONTIME=convert(varchar(11),Fld_Confimation_Time,103),@STATUS=Fld_Staus,@REASON=Fld_Reason
		 --FROM #bb WHERE Srno=@count                                   
		 SELECT @Fld_ComplainNo_1=Fld_ComplainNo,@Status_1=Status,@Category_1=Category,@Fld_DateTime_1=Fld_DateTime--convert(varchar(11),Fld_DateTime,103)
		 FROM #bb WHERE Srno=@cnt1 
		 
		 
      set @Data1=@Data1+                           
     '<tr>                          
     <td> '+ CONVERT(VARCHAR,@Fld_ComplainNo_1) +' </td>                          
     <td> '+ CONVERT(VARCHAR,@Status_1) +' </td>                                                   
     <td> '+ CONVERT(VARCHAR,@Category_1) +' </td> 
     <td> '+ CONVERT(VARCHAR,@Fld_DateTime_1) +' </td> 
     
       </tr>'           
       --print @Data1                         
       SET   @cnt1=@cnt1+1                                    
    END
    
     print @Data1
    
  SET @MESS1='<Br><B>IT helpdesk Automation AOTD For No Issue</B> <Br><Br>'+ @MESS1 + @Data1+'</Table>' 
   set @sub ='AOTD Report as on ' + Convert(varchar(max),GETDATE())
   END
--SET @MESS2='<Br><B> IT helpdesk Automation AOTD</B> <Br><Br>'+ @MESS2 + @Data +'</Table>'
SET @MESS='Dear Sir,<br><Br>Good Evening!!!<br><Br>Greetings of the day!<Br><Br>' + @MESS2 + '<Br>'+@MESS1+'<Br>'
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(IT helpdesk)'                              
--set @sub ='AOTD Report as on ' + Convert(varchar(max),GETDATE())
--select 'AOTD Report as on ' + Convert(varchar(max),GETDATE())

 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
 @RECIPIENTS =@emailto,                              
 @COPY_RECIPIENTS = @emailcc,                              
 @blind_copy_recipients=@emailbcc,                    
 @PROFILE_NAME = 'AngelBroking',                              
 @BODY_FORMAT ='HTML',                              
 @SUBJECT = @sub ,                              
 --@FILE_ATTACHMENTS =@s,                              
 @BODY =@MESS 
 
 drop table #aa
 drop table #bb
 
END

    
     --v_aotd_rpt  Fld_ComplainNo,Status,Fld_Business_dntime,Fld_Reason,Category,Fld_DateTime
     
     --select * from v_aotd_rpt where Fld_DateTime='2016-07-08'   row_number()over (order by a.Fld_SrNo) As Srno,

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IT_helpdesk_Automation_TCP
-- --------------------------------------------------

        
/* Order Confirmation Report (Daily)*/
--EXEC USP_TCP_Update1 '%%','08/08/2016'   
CREATE Procedure [dbo].[IT_helpdesk_Automation_TCP]                
as
Begin
DECLARE @Emp_name as varchar(100),@emp_email as varchar(100)                
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(max),@MESS NVARCHAR(MAX)                            
    --SELECT @emailto='rohit.ambosta@angelbroking.com'
     SELECT @emailto='prashant.patade@angelbroking.com'
    --Select @emailcc='odinadmin@angelbroking.com'
 -- SELECT @emailbcc='sandeep.rai@angelbroking.com;prashant.patade@angelbroking.com'
    
    /*DHOK */
  declare @Count int,@Data1 NVARCHAR(MAX),@MESS1 NVARCHAR(MAX),@CountEnd int,@Server as varchar(20), @TCPCOUNT1015AM as varchar(50),@TCPCOUNT0315PM as varchar(50),
  @SERVILENCECOUNT0815AM as varchar(50),@PREVIOUSDAYSURVILENCECOUNT as varchar(50),@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT as varchar(500),
  @Remrks as varchar(500),@ENTRYBY as varchar(50),@cnt int--,@prevDaySurCnt as varchar(50),@First_Uur_Cnt as varchar(50)
  
               
  DECLARE @MessBody NVARCHAR(MAX),@MESS2 NVARCHAR(MAX)            
  DECLARE @xml NVARCHAR(MAX)              
   DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0
    
   
	--	select Fld_SrNo,Fld_Contact_person,Fld_Confimation_Time,Fld_Staus,Fld_Reason into #tbl_Order_Confirmation
	--from tbl_Order_Confirmation
    set @Data=''                
    set @MessBody=''                          
    set @MESS2=''          
    set @Count=1   
    set @cnt=1 
                            
	                            
       --drop table #aa
     -- select top 10 * from tbl_Order_Confirmation order by Fld_UPD_Time Desc 
      --IF (Not EXISTS (SELECT 1 FROM [196.1.115.239].HARMONY.DBO.HOLIMST WHERE HDATE =  CONVERT(DATETIME,CONVERT(VARCHAR(10), GETDATE(), 112))))
      -- AND DATENAME(WEEKDAY,GETDATE()) <> 'SATURDAY' AND DATENAME(WEEKDAY,GETDATE()) <> 'SUNDAY'   
      -- BEGIN  
      
    -- select top 0 * into tcp_count from V_Tbl_Tcp_Count
      truncate table tbl_Tcp_Count_phy 
      truncate table tbl_Tcp_Count_phy1
      
      if(DATENAME(DW, GETDATE())= 'Monday')
      begin
       --select * into tbl_Tcp_Count_phy from tcp_count
      insert into tbl_Tcp_Count_phy
      --select * from tcp_count
     select row_number()over (order by a.Fld_Server_id) As Srno,a.* 
     --into tbl_Tcp_Count_phy 
     from 
     (select distinct  t.Fld_Server_id,t.Fld_Tcp_1015,t.Fld_Tcp_0315,t.Fld_Sur_Cnt,t.Fld_Remark,t.Fld_FldDate,t.Fld_EmpCode,
     t.PrevDay_Sur_Cnt,t.First_Sur_Cnt,n.FLd_Server,n.server_id,q.Emp_name
     from V_Tbl_Tcp_Count t inner join V_TCP_Servers n  ON t.Fld_Server_id=n.server_id 
     join [INTRANET].risk.dbo.Emp_info q on q.emp_no=t.Fld_EmpCode
     where convert(varchar(12),Fld_FldDate,106)=CONVERT(varchar(12),getdate()-3,106) and fld_server_id not in ('37')
     ) a
     end
     else
     begin
     insert into tbl_Tcp_Count_phy
    --select * from tcp_count
      select row_number()over (order by a.Fld_Server_id) As Srno,a.* 
     --into tbl_Tcp_Count_phy  
     from 
     (select distinct  t.Fld_Server_id,t.Fld_Tcp_1015,t.Fld_Tcp_0315,t.Fld_Sur_Cnt,t.Fld_Remark,t.Fld_FldDate,t.Fld_EmpCode,
     t.PrevDay_Sur_Cnt,t.First_Sur_Cnt,n.FLd_Server,n.server_id,q.Emp_name
     from V_Tbl_Tcp_Count t inner join V_TCP_Servers n  ON t.Fld_Server_id=n.server_id 
     join [INTRANET].risk.dbo.Emp_info q on q.emp_no=t.Fld_EmpCode
     where convert(varchar(12),Fld_FldDate,106)=CONVERT(varchar(12),getdate()-1,106) and fld_server_id not in ('37')
     ) a
     END
     
   --  END
     --select person_name from intranet.rolemgm.dbo.user_login where username='E05119'
    -- select * from risk.Emp_info where 
    --from tbl_Order_Confirmation     
   --drop table #bb
    --select top 10 * into #bb from #aa
    select   @Count=count(*) from tbl_Tcp_Count_phy 
     SELECT @totctrOT=count(1) from tbl_Tcp_Count_phy
     
     print @MESS  
     if(@Count=0)
    Begin 
    print 'hi'
     set @MESS2='<b>Note:TCP count has not been updated by DAKC  branch.</b><br><br>'
       set @MESS2=@MESS2+'Have a nice day ahead.'
     set @sub ='TCP ' + Convert(varchar(max),GETDATE())

    print @MESS
   --SET @MESS2='<Br><B>Equity</B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
    End
    else
    begin
   
               
   SET @MESS2=                           
   '<Table border="1">                            
   <tr>                       
    <th> Server </th>                            
       <th> TCP COUNT 10.15 AM</th>                            
       <th> TCP COUNT 0315 PM  </th>                            
       <th> SERVILENCE COUNT 08.15 AM</th>    
       <th> PREVIOUS DAY SURVILENCE COUNT</th>  
       <th>FIRST DAY OF CURRENT MONTH-SURVILENCE COUNT</th> 
       <th>REMARK</th>     
       <th>ENTRY BY</th>                         
   </tr>'  
   print @MESS2
   set @Data=''
     WHILE @cnt <= @totctrOT                              
     BEGIN
     print @cnt
   SELECT @Server=FLd_Server,@TCPCOUNT1015AM=Fld_Tcp_1015,@TCPCOUNT0315PM=Fld_Tcp_0315,@SERVILENCECOUNT0815AM=Fld_Sur_Cnt,
				  @PREVIOUSDAYSURVILENCECOUNT=PrevDay_Sur_Cnt,@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT=First_Sur_Cnt,@Remrks=Fld_Remark,@ENTRYBY=Emp_name
				 FROM tbl_Tcp_Count_phy WHERE Srno=@cnt 
   
--print @MESS  
  --if(@Count<=1)
  -- Begin
  --   WHILE @Count <= @totctrOT                              
		--	 BEGIN
		--	SELECT @Server=FLd_Server,@TCPCOUNT1015AM=Fld_Tcp_1015,@TCPCOUNT0315PM=Fld_Tcp_0315,@SERVILENCECOUNT0815AM=Fld_Sur_Cnt,
		--		  @PREVIOUSDAYSURVILENCECOUNT=PrevDay_Sur_Cnt,@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT=First_Sur_Cnt,@Remrks=Fld_Remark,@ENTRYBY=Emp_name
		--		 FROM #aa WHERE Srno=@count                                   
			  set @Data=@Data+                           
				 '<tr>                          
				 <td> '+ CONVERT(VARCHAR,@Server) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@TCPCOUNT1015AM) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@TCPCOUNT0315PM) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@SERVILENCECOUNT0815AM) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@PREVIOUSDAYSURVILENCECOUNT) +' </td> 
				 <td> '+ CONVERT(VARCHAR,@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT) +' </td> 
				 <td> '+ CONVERT(VARCHAR,@Remrks) +' </td> 
				 <td> '+ CONVERT(VARCHAR,@ENTRYBY) +' </td> 
				   </tr>'           
				  print @Data                         
				--  SET   @Count=@Count+1                                    
				SET   @cnt=@cnt+1 
				END
			SET @MESS2='<Br><B>DAKC </B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
			set @sub ='TCP Time as on ' + Convert(varchar(max),GETDATE())
  End
    --else
    --begin
    -- select 'No data Updated'
   -- End
 
/*GHATKOPAR (E)*/
	  declare @Count1 int,@date1 as varchar(20),@totctrOT1 as int=0  ,@Server_1 as varchar(20), @TCPCOUNT1015AM_1 as varchar(50),@TCPCOUNT0315PM_1 as varchar(50),
	 @SERVILENCECOUNT0815AM_1 as varchar(50),@PREVIOUSDAYSURVILENCECOUNT_1 as varchar(50),@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT_1 as varchar(500),
	 @Remrks_1 as varchar(500),@ENTRYBY_1 as varchar(50),@cnt1 int--,@prevDaySurCnt_1 as varchar(50),@First_Uur_Cnt_1 as varchar(50) 
	 
	 
                 
	  DECLARE @MessBody1 NVARCHAR(MAX)  --,@MESS1 NVARCHAR(MAX)          
--	  DECLARE @xml NVARCHAR(MAX)              
	  --DECLARE @Data1 NVARCHAR(MAX)          
           
    set @Data1=''                
    set @MessBody1=''                          
    set @MESS1=''          
    set @Count1=1 
    set @cnt1=1                                   
              --select GETDATE() 
              -- select DATENAME(DW, '2016-08-22 15:58:54.150') -- 'Monday'-- 2016-08-22 15:58:54.150
       if(DATENAME(DW, GETDATE())= 'Monday')
      begin
      insert into tbl_Tcp_Count_phy1                
    select row_number()over (order by a.Fld_Server_id) As Srno,a.* 
    --into #CC   
     from 
     (select distinct  t.Fld_Server_id,t.Fld_Tcp_1015,t.Fld_Tcp_0315,t.Fld_Sur_Cnt,t.Fld_Remark,t.Fld_FldDate,t.Fld_EmpCode,
      t.PrevDay_Sur_Cnt,t.First_Sur_Cnt,n.FLd_Server,n.server_id,q.Emp_name
     from V_Tbl_Tcp_Count t inner join V_TCP_Servers n ON t.Fld_Server_id=n.server_id
      join [INTRANET].risk.dbo.Emp_info q on q.emp_no=t.Fld_EmpCode
     where convert(varchar(12),Fld_FldDate,106)=CONVERT(varchar(12),getdate()-3,106) and fld_server_id  in ('37') and FLd_Server not in('MIS (34)')
     ) a
     END
     else
     BEGIN
     insert into tbl_Tcp_Count_phy1
      select row_number()over (order by a.Fld_Server_id) As Srno,a.* 
   -- into #CC   
     from 
     (select distinct  t.Fld_Server_id,t.Fld_Tcp_1015,t.Fld_Tcp_0315,t.Fld_Sur_Cnt,t.Fld_Remark,t.Fld_FldDate,t.Fld_EmpCode,
      t.PrevDay_Sur_Cnt,t.First_Sur_Cnt,n.FLd_Server,n.server_id,q.Emp_name
     from V_Tbl_Tcp_Count t inner join V_TCP_Servers n ON t.Fld_Server_id=n.server_id
      join [INTRANET].risk.dbo.Emp_info q on q.emp_no=t.Fld_EmpCode
     where convert(varchar(12),Fld_FldDate,106)=CONVERT(varchar(12),getdate()-1,106) and fld_server_id  in ('37') and FLd_Server not in('MIS (34)')
     ) a
     END
    --from tbl_Order_Confirmation     
   --drop table #bb
    --select top 10 * into #bb from #aa
     select   @Count1=count(*) from tbl_Tcp_Count_phy1
     SELECT @totctrOT1=count(1) from tbl_Tcp_Count_phy1
     
     if(@Count1=0)
    Begin 
    print 'hi'
     set @MESS1='<b>Note:TCP count has not been updated by Ghatkopar branch.</b><br><br>'
       set @MESS1=@MESS1+'Have a nice day ahead.'
     set @sub ='TCP ' + Convert(varchar(max),GETDATE())

    --print @MESS
   --SET @MESS2='<Br><B>Equity</B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
    End
    
    else
    begin
     
   SET @MESS1=                            
   '<table border="1">                            
   <tr>                       
    <th> Server </th>                            
       <th> TCP COUNT 10.15 AM</th>                            
       <th> TCP COUNT 0315 PM  </th>                            
       <th> SERVILENCE COUNT 08.15 AM</th>    
       <th> PREVIOUS DAY SURVILENCE COUNT</th>  
       <th>FIRST DAY OF CURRENT MONTH-SURVILENCE COUNT</th> 
       <th>REMARK</th>     
       <th>ENTRY BY</th>                         
   </tr>'          
print @MESS 
   --if(@Count<=1)
   --Begin 
   
    set @Data1=''
     WHILE @cnt1 <= @totctrOT1                              
     BEGIN
     print @cnt1 
     
      	 SELECT @Server_1=FLd_Server,@TCPCOUNT1015AM_1=Fld_Tcp_1015,@TCPCOUNT0315PM_1=Fld_Tcp_0315,@SERVILENCECOUNT0815AM_1=Fld_Sur_Cnt,
						 @PREVIOUSDAYSURVILENCECOUNT_1=PrevDay_Sur_Cnt,@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT_1=First_Sur_Cnt,@Remrks_1=Fld_Remark,@ENTRYBY_1=Emp_name
						 FROM tbl_Tcp_Count_phy1 WHERE Srno=@cnt1 
		 
		 
			  -- WHILE @Count1 <= @totctrOT1                             
				 --BEGIN                        
					--	 SELECT @Server_1=FLd_Server,@TCPCOUNT1015AM_1=Fld_Tcp_1015,@TCPCOUNT0315PM_1=Fld_Tcp_0315,@SERVILENCECOUNT0815AM_1=Fld_Sur_Cnt,
					--	 @PREVIOUSDAYSURVILENCECOUNT_1=PrevDay_Sur_Cnt,@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT_1=First_Sur_Cnt,@Remrks_1=Fld_Remark,@ENTRYBY_1=Emp_name
					--	 FROM #CC WHERE Srno=@count1                                   
				  set @Data1=@Data1+                           
				'<tr>                          
				 <td> '+ CONVERT(VARCHAR,@Server_1) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@TCPCOUNT1015AM_1) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@TCPCOUNT0315PM_1) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@SERVILENCECOUNT0815AM_1) +' </td>                          
				 <td> '+ CONVERT(VARCHAR,@PREVIOUSDAYSURVILENCECOUNT_1) +' </td> 
				 <td> '+ CONVERT(VARCHAR,@FIRSTDAYOFCURRENTMONTHSURVILENCECOUNT_1) +' </td> 
				 <td> '+ CONVERT(VARCHAR,@Remrks_1) +' </td> 
				 <td> '+ CONVERT(VARCHAR,@ENTRYBY_1) +' </td> 
			       
			     
				   </tr>'                  
				  print @Data1                         
				  SET   @cnt1=@cnt1+1                                   
				 END 

		SET @MESS1='<Br><B> GHATKOPAR (E)</B> <Br><Br>'+ @MESS1 + @Data1+'</Table>'
		
		   
  --SET @MESS1='<Br><B>IT helpdesk Automation AOTD For No Issue</B> <Br><Br>'+ @MESS1 + @Data1+'</Table>' 
   --set @sub ='AOTD Report as on ' + Convert(varchar(max),GETDATE())
   END
  --End
  --  else
  --  begin
  --  --declare @MESS3 as nvarchar(max)
  --  --set @MESS3='No data Updated'
  --  --print @MESS3
  --   select 'No data Updated'
  --  End
SET @MESS='Dear All,<br><Br>Good Morning!!!<br><Br>Greetings of the day!<Br><Br>' + @MESS2 +  '<Br>'+@MESS1+'<Br>'
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(IT helpdesk)'                              
set @sub ='TCP Count Report as on ' + Convert(varchar(max),GETDATE())


 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
 @RECIPIENTS =@emailto,                              
 @COPY_RECIPIENTS = @emailcc,                              
 @blind_copy_recipients=@emailbcc,                    
 @PROFILE_NAME = 'AngelBroking',                              
 @BODY_FORMAT ='HTML',                              
 @SUBJECT = @sub ,                              
 --@FILE_ATTACHMENTS =@s,                              
 @BODY =@MESS 
 
 --drop table #aa
 --drop table #cc
 
 
 END
 
  
  
  --select * from Tbl_Tcp_Count where convert(varchar(12),Fld_FldDate,106)='04 Aug 2016'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.it_inventory_branch
-- --------------------------------------------------
create procedure it_inventory_branch(@brtag  varchar(15))
as
select * from            
(            
select br_type,Br_Region,Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from tbl_it_br_master (nolock) where Br_Tag = 'HO'            
union            
select br_type,Br_Region,Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from tbl_it_br_master (nolock) where Br_Region ='HO'            
) x order by Br_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.it_inventory_entry
-- --------------------------------------------------



--it_inventory_entry 'All','Ahd_5','%','2011','January'  
CREATE proc [dbo].[it_inventory_entry]  
(  
@brid as varchar(15),  
@access_code as varchar(11),  
@type as varchar(11),  
@year as varchar(10),  
@month as varchar(15))                    
as                    
if @type='All'                  
begin                  
set @type='%'                  
end                  
                  
if @brid='All' and @access_code ='CSO'                           
begin               
                                
 select * into #t from                                
 (                                
 select Sr_No,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch from tbl_it_br_master (nolock) where Br_Status='A'and br_tag like  @access_code   and br_type like   @type                          
 union                                
 select Sr_No,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch  from tbl_it_br_master (nolock) where Br_Status='A'and Br_Region  like @access_code   and br_type like   @type                                    
 union                         
 select 0,'CSO-(CSO)'                      
 ) x order by Branch                       
      
 select * from      
 (select Sr_No,Branch from #t) a      
 left outer join      
 (select * from tbl_it_inventory WHERE year=@year and month=@month )B      
 ON a.Sr_No=b.br_id                     
end                        
if @brid='All' and @access_code <> 'CSO'                      
begin       
 --if @brid='All'                  
 --begin                  
 --set @brid='%'                  
 --end                
		-- commented by harshal  at 5th  June 2013
 --select * into #t1 from                                
 --(                                
 --select Sr_No,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch from tbl_it_br_master (nolock) where Br_Status='A'and br_tag like @access_code and br_type like   @type                                       
 --union                                
 --select Sr_No,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch   from tbl_it_br_master (nolock) where Br_Status='A'and Br_Region like   @access_code and br_type like   @type                                   
 --union  
 --select Sr_No,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch from V_tbl_it_br_master (nolock)  
 --where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code)  
 --) x order by Branch                       
		--added by harshal at 5th june 2013
 select * into #t1 from                      
(                          
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch from V_tbl_it_br_master (nolock) where (Br_Tag like @access_code or Reg_Code like @access_code and Br_Status='A' )                         
union                          
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch from V_tbl_it_br_master (nolock) where (Br_Region like @access_code or Reg_Code like @access_code and Br_Status='A')                        
union      
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch from V_tbl_it_br_master (nolock) where brmast_cd like @access_code and Br_Status='A'        
union      
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag ,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch from V_tbl_it_br_master (nolock)      
where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code and Br_Status='A')                           
) x order by Branch   
 --- End Harshal                    
 --drop table #t1
  select * from      
  (select Sr_No,Branch from #t1) a      
  left outer join      
  (select * from tbl_it_inventory WHERE year=@year and month=@month )B      
  ON a.Sr_No=b.br_id            
end                    
if @brid<>'All'                    
begin                    
    select Sr_No,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch  into #t2 from tbl_it_br_master (nolock) where Br_Status='A'and  sr_no like  @brid                   
and br_type like   @type                  
            
       
 select * from      
 (select Sr_No,Branch from #t2) a      
 left outer join      
 (select * from tbl_it_inventory WHERE year=@year and month=@month)B      
 ON a.Sr_No=b.br_id and a.Sr_No = @brid        
                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.it_inventory_entry_test
-- --------------------------------------------------

--  it_inventory_entry_test 'All','All','%','2010','May'

CREATE proc [dbo].[it_inventory_entry_test]
(
	@brid as varchar(15),
	@access_code as varchar(11),
	@type as varchar(11),
	@year as varchar(10),
	@month as varchar(15)
)                  
as 

Declare @Query1 varchar(Max)
Declare @Query2 varchar(Max)
Declare @Query3 varchar(Max)
Declare @ConQuery varchar(Max)

Set @ConQuery = ''

If(@month = '%')
Begin

	If((Select Convert(datetime,@year)) >= (Select(CONVERT(Datetime,'2011-05-01'))))
	Begin
		
		Set @ConQuery= 'And br_id Not IN (''33'',''41'',''48'',''65'',''210'',''165'',''183'',''184'',''68'',''26'',''24'')'

	End
End
Else
Begin

	If((Select Convert(datetime,@month+ ' ' + @year)) >= (CONVERT(Datetime,'2011-05-01')))
	Begin
		
		Set @ConQuery= 'And br_id Not IN (''33'',''41'',''48'',''65'',''210'',''165'',''183'',''184'',''68'',''26'',''24'')'

	End
End
                 
if @type='All'                
begin                
set @type='%'                
end                
                
if @brid='All' and @access_code ='CSO'                         
begin             
  set @Query1='                            
 select * into #t from                              
 (                              
 select Sr_No,upper(Br_Name)+''-(''+upper(Br_tag)+'')'' as Branch from tbl_it_br_master (nolock) where Br_Status=''A''and br_tag like  '''+@access_code+'''   and br_type like '''+@type+'''                        
 union                              
 select Sr_No,upper(Br_Name)+''-(''+upper(Br_tag)+'')'' as Branch  from tbl_it_br_master (nolock) where Br_Status=''A''and Br_Region  like '''+@access_code+'''   and br_type like '''+@type+'''                                  
 union                       
 select 0,''CSO-(CSO)''                    
 ) x order by Branch                     
    
 select * from    
 (select Sr_No,Branch from #t) a    
 left outer join    
 (select * from tbl_it_inventory WHERE year='''+@year+''' and month='''+@month+''')B    
 ON a.Sr_No=b.br_id '  
 
 print(@Query1) 
 Exec(@Query1)
                 
end                      
if @brid='All' and @access_code <> 'CSO'                    
begin                   
 set @Query2='select * into #t1 from                              
 (                              
 select Sr_No,upper(Br_Name)+''-(''+upper(Br_tag)+'')'' as Branch from tbl_it_br_master (nolock) where Br_Status=''A''and br_tag like '''+@access_code+''' and br_type like '''+@type+'''                                    
 union                              
 select Sr_No,upper(Br_Name)+''-(''+upper(Br_tag)+'')'' as Branch from tbl_it_br_master (nolock) where Br_Status=''A''and Br_Region like '''+@access_code+''' and br_type like '''+@type+'''                                 
 ) x order by Branch                     
                  
 --drop table #t               
  select * from    
  (select Sr_No,Branch from #t1) a    
  left outer join    
  (select * from tbl_it_inventory WHERE year='''+@year+''' and month='''+@month+''' )B    
  ON a.Sr_No=b.br_id '  
  print(@Query2) 
  Exec(@Query2)
         
end                  
if @brid<>'All'                  
begin  
	set @Query3= '               
			select Sr_No,upper(Br_Name)+''-(''+upper(Br_tag)+'')'' as Branch  into #t2 from tbl_it_br_master (nolock) where Br_Status=''A''and  sr_no like '''+@brid+'''                 
			and br_type like '''+@type+'''                
		          
     
 select * from    
 (select Sr_No,Branch from #t2) a    
 left outer join    
 (select * from tbl_it_inventory WHERE year='''+@year+''' and month='''+@month+''')B    
 ON a.Sr_No=b.br_id and a.Sr_No = '''+@brid+''' '     
     
     print(@Query2) 
     Exec(@Query2)          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.mail_Report_time
-- --------------------------------------------------
CREATE procedure mail_Report_time (@flag  varchar (1),@FromDate varchar(11),@ToDate varchar(11),@code varchar (10))      
as      
set nocount on    
if @flag='A'      
begin      
select a.gc_sendername,gc_senderemailaddress=(case when a.gc_senderemailtype='EX' then replace(a.gc_senderemailaddress,'/O=ANGEL/OU=FIRST ADMINISTRATIVE GROUP/CN=RECIPIENTS/CN=','')+'@angeltrade.com' else a.gc_senderemailaddress end),a.gc_subject,a.gc_receivedtime  
 from  
mail a   
join request_map b  
on a.gc_guid=b.guid  
where b.request_type like @code and gc_receivedtime>=@FromDate and  gc_receivedtime<=@ToDate  
end  
if @flag='B'      
begin    
select a.gc_sendername,gc_senderemailaddress=(case when c.gc_senderemailtype='EX' then replace(a.gc_senderemailaddress,'/O=ANGEL/OU=FIRST ADMINISTRATIVE GROUP/CN=RECIPIENTS/CN=','')+'@angeltrade.com' else a.gc_senderemailaddress end),a.gc_subject,a.gc_receivedtime from  
reply_mail a   
join request_map b  
on a.gc_guid=b.guid join mail c  on a.gc_guid=c.gc_guid
where b.request_type like @code and a.gc_receivedtime>=@FromDate and  a.gc_receivedtime<=@ToDate  
end  
if @flag='C'      
begin    
select a.gc_sendername,gc_senderemailaddress=(case when a.gc_senderemailtype='EX' then replace(a.gc_senderemailaddress,'/O=ANGEL/OU=FIRST ADMINISTRATIVE GROUP/CN=RECIPIENTS/CN=','')+'@angeltrade.com' else a.gc_senderemailaddress end),a.gc_subject,a.gc_receivedtime from  
mail a   
join request_map b  
on a.gc_guid=b.guid  
where b.request_type like @code and gc_receivedtime>=@FromDate and  gc_receivedtime<=@ToDate  
and a.gc_guid not in (select gc_guid from reply_mail)  
END  
set nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ModifyITSTaffOtherDetails
-- --------------------------------------------------



-- =============================================    
-- Author:  Harshal Mahadik    
-- Create date: 4 Feb 2013    
-- Description: To Update the CSCP,Group1 & Group2 Columns.    
-- =============================================    
CREATE PROCEDURE ModifyITSTaffOtherDetails     
    
 @EmpNo varchar(20),    
 @CSCP varchar(50),    
 @Group1 varchar(50),    
 @Group2 varchar(50)     
AS    
BEGIN    
DECLARE @Count int
SELECT @Count = COUNT(*) FROM tbl_ITStaff_OtherDetails WHERE ITSO_EmpId = @EmpNo

IF @Count > 0
	BEGIN
	 Update  tbl_ITStaff_OtherDetails
	 SET  ITSO_CSCP=@CSCP,    
	   ITSO_Group_1=@Group1,     
	   ITSO_Group_2 =@Group2      
	 WHERE ITSO_EmpId=@EmpNo    
	END
ELSE
	BEGIN
		INSERT INTO tbl_ITStaff_OtherDetails (ITSO_EmpId,ITSO_CSCP,ITSO_Group_1,ITSO_Group_2)
		VALUES (@EmpNo,@CSCP,@Group1,@Group2)		 
	END 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ModifyUPSMapping
-- --------------------------------------------------
-- =============================================                      
-- Author:  Harshal Mahadik                      
-- Create date: 23 Feb 2013                      
-- Description: Update last 4 columns in tbl_ups_mapping   
-- Changed by:  Navin Sapalya
-- Create date: 29 Jul 2013                      
-- Description: Update last 4 columns in tbl_ups_mapping                      
-- =============================================                      
CREATE PROCEDURE ModifyUPSMapping                      
(                      
 @Ups_Map_ID int,                      
 @Agv_Daily_Load Varchar(50)=null,      
 @Total_TestingTime int=null,               
 @Total_Load_InPer Varchar(50)=null,      
 @Fld_remark Varchar(4000)=null,      
 @ChangedBy varchar(20) =null,      
 @tdate varchar(15)=null,      
 @Fld_Branch_Id int =null,      
 @Ups_Id int = null      
)      
AS                   
BEGIN      
 Set @tdate = Convert(varchar(11),Convert(datetime,@tdate,103),121)      
 DECLARE @COUNT int      
 SELECT  @COUNT = COUNT(*) FROM tbl_ups_data Where Fld_Ups_id = @Ups_Id and Fld_Entry_date  = @tdate and fld_branch = @Fld_Branch_Id
 --IF @COUNT > 0      
 --BEGIN      
 --Update tbl_ups_mapping_TEST      
 --SET Agv_Daily_Load =@Agv_Daily_Load ,      
 --Total_TestingTime =@Total_TestingTime,      
 --Total_Load_InPer =@Total_Load_InPer ,      
 --Remark =@Fld_remark ,      
 --ChangedBy = @ChangedBy,      
 --ChangedOn = GETDATE(),      
 --Fld_ToDate = @tdate,      
 --fld_EntryDate = @tdate      
 --WHERE Fld_SrNo = @Ups_Map_ID      
 --END      
 --ELSE      
 --BEGIN      
 --insert into tbl_ups_mapping_TEST (Fld_Branch_id,Fld_Ups_id,Fld_Flag,Fld_App,Agv_Daily_Load,Total_TestingTime,Total_Load_InPer,Remark,ChangedBy,ChangedOn,      
 --Fld_ToDate,fld_EntryDate) values(@Fld_Branch_Id,@Ups_Id,'A','U',@Agv_Daily_Load,@Total_TestingTime,@Total_Load_InPer,@Fld_remark ,@ChangedBy,GETDATE(),@tdate,@tdate)       
 --END       
     
 IF @COUNT > 0    
 BEGIN    
 Update tbl_ups_data SET     
 Agv_Daily_Load =@Agv_Daily_Load,    
 Total_TestingTime =@Total_TestingTime,    
 Total_Load_InPer =@Total_Load_InPer,    
 Remark =@Fld_remark,    
 ChangedBy =@ChangedBy,    
 ChangedOn =GETDATE()    
 WHERE Fld_Ups_id = @Ups_Id and Fld_Entry_date = @tdate and fld_branch =  @Fld_Branch_Id 
 END    
 ELSE    
 BEGIN    
 insert into tbl_ups_data(Fld_Ups_id,Agv_Daily_Load,Total_TestingTime,Total_Load_InPer,Remark,ChangedBy,ChangedOn,      
 Fld_Entry_date,fld_branch) values(@Ups_Id,@Agv_Daily_Load,@Total_TestingTime,@Total_Load_InPer,@Fld_remark,@ChangedBy,GETDATE(),      
 @tdate,@Fld_Branch_Id)      
 END     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OP_Helpdsk_name
-- --------------------------------------------------
create proc OP_Helpdsk_name
(
@name as varchar(50)
)
as
select emp_no from intranet.risk.dbo.emp_info
where emp_name=@name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OpsHD_Auto_Esclation_mapping
-- --------------------------------------------------
CREATE Proc OpsHD_Auto_Esclation_mapping
as
SELECT EI.EMP_NO,
	EI.EMP_NAME,
	DI.DEPARTMENT,
	DI.EMAIL AS [DI EMAIL],
	EI.EMAIL AS [EI EMAIL]
INTO #TEMP
FROM INTRANET.RISK.DBO.EMP_INFO EI , INTRANET.MISC.DBO.DEPT_INFO DI 
WHERE SUBSTRING(EI.EMAIL,1,CHARINDEX('@',EI.EMAIL)) = SUBSTRING(DI.EMAIL,1,CHARINDEX('@',DI.EMAIL))
AND EI.EMAIL <> '' AND DI.EMAIL <> ''

/*select * from #emp1	where email not in
(
select SUBSTRING([EI EMAIL],1,CHARINDEX('@',[EI EMAIL])-1) from #temp	where charindex('@',[EI EMAIL])>0
)

select * from  #emp1 where email1='santanu.syam@angeltrade.com'

select * from INTRANET.risk.dbo.emp_info where email like 'Anil.ranka@%'

select department,email=substring(email,1,charindex('@',email)-1),email1=email
into #emp1
from INTRANET.MISC.DBO.DEPT_INFO
where isnull(email,'')<>'' and charindex('@',email)>0

*/
	

SELECT  a.emp_no,a.emp_name,a.department,b.dept_name ,b.dept_id 
into #fin
FROM #TEMP	a , department_master b 	
where a.department= b.dummy5

insert into TBL_DEPT_MAPPING
select dept_name,emp_no,dept_id,'Y' 
from #fin where emp_no not in
(SELECT fld_empid FROM TBL_DEPT_MAPPING)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PivotExample
-- --------------------------------------------------
    
CREATE procedure PivotExample     
@pivotRowFields as nvarchar(1000),     
@pivotField as nvarchar(100),     
@pivotTable as nvarchar(1000),     
@aggField as nvarchar(100),     
@aggFunc as nvarchar(10),     
@pivotWhere as nvarchar(1000) = Null,     
@pivotOrder as nvarchar(100) = Null,     
@colField as nvarchar(100) = Null,     
@colTable as nvarchar(100) = Null,     
@colWhere as nvarchar(300) = Null,     
@colTop as nvarchar(10) = Null     
AS     
    
    
--This is the variable that stores all the column names     
declare @cols as nvarchar(max)     
    
If object_id('tempdb..#cols') is not null     
drop table #cols     
    
create table #cols (Col nvarchar(max))   
  
declare @query as nvarchar(max)   
  
set @colField = case when @colField is null then @pivotField else @colField end   
set @colTable = case when @colTable is null then @pivotTable else @colTable end   
set @colWhere = case when @colField is null and @pivotWhere is not null then @pivotWhere else @colWhere end   
  
set @query = '   
DECLARE @cols NVARCHAR(max)   
SELECT @cols = STUFF((SELECT DISTINCT case when '+ @colTop+' is not null then Top ' + @colTop+' else '' end + ''''],['' + t2.' + @pivotField + 'FROM (SELECT CONVERT(nvarchar(max),a.' + @colField + ') AS ' + @pivotField + ' FROM (SELECT DISTINCT ' + @colField + 'FROM ' + @colTable + ' + case when @colWhere is not null then WHERE ' + @colWhere + ' else '' end  ) AS a ) AS t2 ORDER BY''],['' + t2.' + @pivotField + 'FOR XML PATH('' '')), 1, 2, '''')+ '']'' select'+ @cols+''  
insert into #cols   
exec (@query)   
  
set @cols = (select * from #cols)   
  
drop table #cols   
  
DECLARE @query2 NVARCHAR(max)   
SET @query2 = N'SELECT ' + @pivotRowFields + ', '+ @cols + '   
FROM   
(SELECT  ' + @pivotRowFields + ' ,' + @pivotField + ' ,' + @aggField + '   
FROM   ' + @pivotTable + ' as a ' + case when @pivotWhere is not null then 'WHERE ' + @pivotWhere else '' end + ') p   
PIVOT   
( ' + @aggFunc + '(' + @aggField + ')   
FOR ' + @pivotField + ' IN   
( '+ @cols +' ) ) AS pvt ' + case when @pivotOrder is not null then 'Order by ' + @pivotOrder else '' end + ';'   
  
exec (@query2)

/*  This is example data 
--set @colField = 'fw' 
--set @colTable = 'fscl_yr_wk' 
--set @colWhere = 'fw between (select min(fw) from CC_MKDN_DLRS) AND (SELECT max(fw) from CC_MKDN_DLRS)' 
set @colTop = '17' 

set @pivotRowFields = 'SubDpt' 
set @pivotField = 'fw' 
set @pivotTable = 'CC_MKDN_DLRS' 
set @aggField = '[$MKDN]' 
set @aggFunc = 'SUM' 
--set @pivotWhere = 'subdpt = ''24''' 
set @pivotOrder = 'SubDpt' 
--*/ 



/* 
--This is the field name of where your dynamic columns will come from 
--If left null then the pivot table data will be used 
--Use this only if you want to use a table that is different than the pivot table/view you are getting your data from for column names 
--(In Access this is called the Column Heading on a Crosstab Query) 
declare @colField as nvarchar(100) 

--This is the table name of the table you want to pull your column names from 
--Use this only if you want to use a table that is different than the pivot table/view you are getting your data from for column names 
declare @colTable as nvarchar(100) 

--Use this only if you want to use filter from the optional table that is different than the pivot table/view you are getting your data from 
declare @colWhere as nvarchar(300) 

--Use this to limit the number of columns you are pulling your column names from 
--Use this only if you want to use a table that is different than the pivot table/view you are getting your data from for column names 
declare @colTop as nvarchar(10) 

/* This is the section of the pivot data */ 
--This is the comma seperated list of field(s) from the pivot table/view to include with the data 
--(In Access these are called the Row Heading on a Crosstab Query) 
-- eg. 'column1,column2,column3' or 'column1' 
declare @pivotRowFields as nvarchar(1000) 

--This is the field in the pivot table/view that matches the 
declare @pivotField as nvarchar(100) 

--This is the table/view for the pivot 
--This can also be an entire query wrapped in parentheses 
declare @pivotTable as nvarchar(1000) 

--This is the optional WHERE clause for the pivot table/view 
declare @pivotWhere as nvarchar(300) 

--This is the optional ORDER BY statement for the pivot table/view 
declare @pivotOrder as nvarchar(100) 

--This is the field in the pivot table/view that will be aggregated 
--(In Access this is called the Value Field on a Crosstab Query) 
declare @aggField as nvarchar(100) 

--This is the function to perform on the aggregate field 
-- eg. SUM or MAX or MIN or AVG or any valid aggregate function 
declare @aggFunc as nvarchar(10) 


--This is the variable that stores all the column names 
declare @cols as nvarchar(max) 
--*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_VLMSInhouse
-- --------------------------------------------------
CREATE proc  PROC_VLMSInhouse  
  
AS  
  
TRUNCATE TABLE VLMSInhouse  
  
INSERT INTO VLMSInhouse  
Select  *    
from [MIDDLEWARE].[Harmony].dbo.VLMSInhouse  where department = 'IT'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.QA_Survey_BarChart
-- --------------------------------------------------
CREATE Procedure QA_Survey_BarChart(@type as varchar(6),@br as varchar(10),@fdate as varchar(11),@tdate as varchar(11))              
as              
/*declare @br as varchar(8)              
Set @br='HYD'              
declare @fdate as varchar(11)              
Set @fdate='Jul 01 2008'              
declare @tdate as varchar(11) ,@type as varchar(6)             
Set @tdate='Aug 31 2008'          
set @type='CLI'    */        
Set Nocount On              
declare @count as float,@no as int                   
select @count = count(*) from qa_survey_ans2 where branch=@br              
and sdate>=@fdate and sdate<=@tdate  and type=@type         
                 
If @type='CLI'            
 Begin            
  Set @no=27            
 END            
else            
 Begin            
  Set @no=17            
 END            
              
Set transaction isolation level read uncommitted              
            
 select 'Delighted' as Prod, Total=round((count(Ans)* 100 / case when @count=0 then 1 else @count end),2),tot=@count,order1=1 from qa_survey_ans1 a(nolock)                 
 left outer join                
 (select id,sdate from qa_survey_ans2 (nolock) where type=@type and branch=@br) b                
 on a.id_ans2=b.id                
 where a.ques_no =@no  and left(Ans,1) ='V'                
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                 
 union                
 select 'Satisfied' as Prod, Total=round((count(Ans)* 100 / case when @count=0 then 1 else @count end),2),tot=@count,order1=2 from qa_survey_ans1 a (nolock)                
 left outer join                
 (select id,sdate from qa_survey_ans2 (nolock) where type=@type and branch=@br) b                
 on a.id_ans2=b.id                
 where a.ques_no =@no   and left(Ans,1)='S'                
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                 
 union                
 select 'Dissatisfied' as Prod, Total=round((count(Ans)* 100 / case when @count=0 then 1 else @count end),2),tot=@count,  order1=3 from qa_survey_ans1 a (nolock)                
 left outer join                
 (select id,sdate from qa_survey_ans2 (nolock) where type=@type and branch=@br) b                
 on a.id_ans2=b.id                
 where a.ques_no =@no and  left(Ans,1)='D'                
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    order by order1             
              
Set Nocount Off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.QA_Survey_chart_SB
-- --------------------------------------------------
      
CREATE Procedure QA_Survey_chart_SB (@opt varchar(3),@br varchar(8),@fdate as varchar(11),@tdate as varchar(11))             
as              
            
if @opt='1'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in (1,2) and left(Ans,1)=('Y')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate     
 union              
 select 'No' as Prod, Total=count(Ans),color='#000099',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in(1,2) and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in (1,2) and left(replace(Ans,' ',''),2) in ('NA','')
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                 
 union            
 select 'Avg' as Prod, Total=count(Ans),color='#ff3399',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in (1,2) and left(Ans,1)=('A')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by title            
             
END              
if @opt='2A'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in (2,3) and left(Ans,1) in ('A','G')            
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
union              
 select 'No' as Prod, Total=count(Ans),color='#000099',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in (2,3) and left(Ans,1) in ('N','B')            
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in (2,3) and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate       
 union            
 select 'Avg' as Prod, Total=count(Ans),color='#ff3399',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no in (2,3) and left(Ans,1) in ('A','S')            
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by title             
            
END             
if @opt='2B'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =9  and Sub_ques='B' and left(Ans,1) ='Y'            
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'No' as Prod, Total=count(Ans),color='#000099',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no  =9  and Sub_ques='B' and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =9  and Sub_ques='B'  and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate       
 union              
 select 'Avg' as Prod, Total=count(Ans),color='#000099',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =9  and Sub_ques='B' and left(Ans,1)='A'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by title                   
END             
if @opt='3'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =5 and Sub_ques='B' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'No' as Prod, Total=count(Ans),color='#000099',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no  =5 and Sub_ques='B' and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =5 and Sub_ques='B' and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by title               
END              
if @opt='4'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =6 and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'No' as Prod, Total=count(Ans),color='#000099',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no  =6  and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =6 and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title               
END              
if @opt='5'         
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='A' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
              
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join             
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='A' and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0000',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='A' and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate      
union              
 select 'Avg' as Prod, Total=count(Ans),color='#000099',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='A' and left(Ans,1)='S'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title              
END              
              
if @opt='6'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='B' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                    
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='B' and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0000',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='B' and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
union              
 select 'Avg' as Prod, Total=count(Ans),color='#000099',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='B' and left(Ans,1)='S'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                  
END              
if @opt='7'              
BEGIN              
select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='C' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                   
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='C' and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0000',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='C' and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate      
union              
 select 'Avg' as Prod, Total=count(Ans),color='#000099',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='C' and left(Ans,1)='S'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                 
END              
if @opt='8'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='D' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
            
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='D' and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0000',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='D' and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate     
 union              
 select 'Avg' as Prod, Total=count(Ans),color='#000099',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='D' and left(Ans,1)='S'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                
END              
if @opt='9'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='E' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
       
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='E'  and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='E'  and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate       
union              
 select 'Avg' as Prod, Total=count(Ans),color='#ff0033',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='E'  and left(Ans,1)='S'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                    
END            
if @opt='10'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='F' and left(Ans,1) ='Y'             and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='F'  and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='F'  and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
union              
 select 'Avg' as Prod, Total=count(Ans),color='#ff0033',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =8 and Sub_ques='F'  and left(Ans,1)='S'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                  
END                
if @opt='11'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =10  and Sub_ques='B' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
       
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =10  and Sub_ques='B'  and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =10  and Sub_ques='B'  and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
union              
 select 'Avg' as Prod, Total=count(Ans),color='#ff0033',title=4 from qa_survey_ans1 a  (nolock)       
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =10  and Sub_ques='B'  and left(Ans,1)='A'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                     
END              
if @opt='12'              
BEGIN         
          
 select 'Good' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =12  and left(Ans,1) ='G'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                    
 union              
 select 'BAD' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =12   and left(Ans,1)='B'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =12   and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
union              
 select 'Avg' as Prod, Total=count(Ans),color='#ff0033',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =12   and left(Ans,1)='A'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                   
END              
if @opt='13A'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =13 and Sub_ques='A' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
  select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =13 and Sub_ques='A'   and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =13 and Sub_ques='A'  and left(Ans,2) in ('NA' ,'')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate order by title              
END              
if @opt='13B'              
BEGIN              
 select 'Good' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =13 and Sub_ques='B' and left(Ans,1) ='G'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                      
 union              
 select 'BAD' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =13 and Sub_ques='B'  and left(Ans,1)='B'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =13 and Sub_ques='B'  and left(Ans,2) in ('NA' ,'')
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
union              
 select 'Avg' as Prod, Total=count(Ans),color='#ff0033',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =13 and Sub_ques='B'  and left(Ans,1)='A'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                  
END            
if @opt='14A'              
BEGIN              
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =14 and Sub_ques='A' and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
  select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =14 and Sub_ques='A'   and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =14 and Sub_ques='A'  and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate   order by title             
END              
if @opt='14B'              
BEGIN              
 select 'Good' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =14 and Sub_ques='B' and left(Ans,1) ='G'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
              
 union              
 select 'BAD' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =14 and Sub_ques='B'  and left(Ans,1)='B'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =14 and Sub_ques='B'  and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
union              
 select 'Avg' as Prod, Total=count(Ans),color='#ff0033',title=4 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =14 and Sub_ques='B'  and left(Ans,1)='A'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title                
END                
if @opt='15'              
BEGIN              
  select 'Good' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
  left outer join              
  (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
  on a.id_ans2=b.id              
  where a.ques_no =15  and left(Ans,1) ='G'              
  and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate                     
  union              
  select 'BAD' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
  left outer join              
  (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
  on a.id_ans2=b.id              
  where a.ques_no =15   and left(Ans,1)='B'              
  and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
  union              
  select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
  left outer join              
  (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
  on a.id_ans2=b.id              
  where a.ques_no =15 and left(replace(Ans,' ',''),2) in ('NA','')              
  and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate    
 union              
  select 'Avg' as Prod, Total=count(Ans),color='#ff0033',title=4 from qa_survey_ans1 a  (nolock)            
  left outer join              
  (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
  on a.id_ans2=b.id              
  where a.ques_no =15   and left(Ans,1)='A'              
  and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate   order by title                 
END              
if @opt='16'              
BEGIN     
 select 'Yes' as Prod, Total=count(Ans),color='#ff3399',title=1 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =17  and left(Ans,1) ='Y'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'No' as Prod, Total=count(Ans),color='#ff0033',title=2 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =17   and left(Ans,1)='N'              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate               
 union              
 select 'NA' as Prod, Total=count(Ans),color='#ff0033',title=3 from qa_survey_ans1 a  (nolock)            
 left outer join              
 (select id,sdate from qa_survey_ans2 (nolock) where type='SB' and branch=@br) b              
 on a.id_ans2=b.id              
 where a.ques_no =17 and left(replace(Ans,' ',''),2) in ('NA','')              
 and a.branch=@br and b.sdate>=@fdate and b.sdate<=@tdate  order by title             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RCA_report
-- --------------------------------------------------
CREATE procedure RCA_report(@FromDate varchar(11),@ToDate varchar(11))
as              
set nocount on   

begin 
 
declare @sum float
--declare @FromDate varchar(11)       
--declare @Todate varchar(11)         
--set @FromDate='01/07/2008'        
--set @ToDate =  '01/08/2008'  
select a.departmentname as TypeOfQuery,NoOfCalls = count(b.department) into #file from departmentmaster a 
right outer join Complaint_table b
on a.deptno = b.department
where complaint_date >= @FromDate and complaint_date <= @ToDate
group by a.departmentname,b.department,a.deptno


select TypeOfQuery = 'Total No Of Calls',NoOfCalls = sum(NoOfCalls),Percentage = 100 into #temp2 from #file

select @sum = sum(NoOfCalls) from #file

select TypeOfQuery,NoOfCalls,Percentage= round(NoOfCalls*100/@sum,2) into #tempfinal from #file

select * from #tempfinal union  select * from #temp2

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RCA_report1
-- --------------------------------------------------
CREATE procedure RCA_report1(@FromDate varchar(11),@ToDate varchar(11))    
as                  
set nocount on       
    
begin     
     
declare @sum float    
/*declare @FromDate varchar(11)           
declare @Todate varchar(11)             
set @FromDate='Apr 01 2008'            
set @ToDate =  'Jun 30 2008' */     
  
select Department,departmentname,noofqueries=count(1),West=sum(case when zone='WEST' then 1 else 0 end)   
,CENTRAL=sum(case when zone='CENTRAL' then 1 else 0 end)  
,EAST=sum(case when zone='EAST' then 1 else 0 end)  
,NORTH=sum(case when zone='NORTH' then 1 else 0 end)  
,SOUTH=sum(case when zone='SOUTH' then 1 else 0 end) 
into #file1 
from Complaint_BR as ct   
inner join departmentmaster as a   
on ct.department = a.deptno   
left outer join  
intranet.risk.dbo.zone d  
on ct.branch=d.branch_cd  
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:000'   
--where complaint_date>='07/01/2008' and complaint_date<= '08/01/2008'
 --and entered_through='HD'   
group by Department,departmentname  

      
select  @sum = sum(noofqueries) from #file1   

select departmentname,noofqueries = sum(noofqueries),Percentage=round(NoOfqueries*100/@sum,2),West,central,east,North,south
into #file2 from #file1
group by noofqueries,west,central,east,north,south,departmentname

select * from #file2 order by departmentname
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
CREATE procedure [dbo].[rebuild_index]  
@database varchar(100)  
as  
begin  
  
declare @db_id int  
Select @db_id = db_id(@database)  
  
if @db_id is Null  
return  
  
SET NOCOUNT ON;  
DECLARE @objectid int;  
DECLARE @indexid int;  
DECLARE @partitioncount bigint;  
DECLARE @schemaname nvarchar(130);  
DECLARE @objectname nvarchar(130);  
DECLARE @indexname nvarchar(130);  
DECLARE @partitionnum bigint;  
DECLARE @partitions bigint;  
DECLARE @frag float;  
DECLARE @command nvarchar(4000);  
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function  
-- and convert object and index IDs to names.  
  
SELECT  
object_id AS objectid,  
index_id AS indexid,  
partition_number AS partitionnum,  
avg_fragmentation_in_percent AS frag  
INTO #work_to_do  
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')  
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;  
  
-- Declare the cursor for the list of partitions to be processed.  
DECLARE partitions CURSOR FOR SELECT objectid,indexid,partitionnum,frag FROM #work_to_do;  
  
-- Open the cursor.  
OPEN partitions;  
  
-- Loop through the partitions.  
WHILE (1=1)  
BEGIN;  
FETCH NEXT  
FROM partitions  
INTO @objectid, @indexid, @partitionnum, @frag;  
IF @@FETCH_STATUS < 0 BREAK;  
SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)  
FROM sys.objects AS o  
JOIN sys.schemas as s ON s.schema_id = o.schema_id  
WHERE o.object_id = @objectid;  
SELECT @indexname = QUOTENAME(name)  
FROM sys.indexes  
WHERE object_id = @objectid AND index_id = @indexid;  
SELECT @partitioncount = count (*)  
FROM sys.partitions  
WHERE object_id = @objectid AND index_id = @indexid;  
  
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.  
IF @frag < 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';  
IF @frag >= 30.0  
      SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';  
IF @partitioncount > 1  
      SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));  
IF @frag >= 30.0  
      set @command = @command +N' WITH (SORT_IN_TEMPDB = ON)' 
 
EXEC (@command);  
PRINT N'Executed: ' + @command;  
END;  
  
-- Close and deallocate the cursor.  
CLOSE partitions;  
DEALLOCATE partitions;  
  
-- Drop the temporary table.  
DROP TABLE #work_to_do;  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_gen_complaintno
-- --------------------------------------------------
CREATE proc sp_gen_complaintno          
-- SP CREATED BY :AJAY VARMA & Mangesh Wangane    
-- CREATIONDATE  :2006 02 20        
-- PURPOSE       :TO Generate new Complaint NO  department wise & insert Records in complaint table        
(          
@Now varchar(50),          
@txtEml varchar(100),          
@txtMsg varchar(8000),          
@txtSub varchar(1000),          
@txtcltName varchar(1000),          
@UserId varchar(1000),          
@ddDept varchar(30),          
@F_Name varchar(1000),          
@txtTelNo varchar(1000),          
@txtSug varchar(1000),          
@txtCode varchar(1000),          
@ddForwardTo varchar(1000),
@category varchar(50), 
@status varchar(50)         
--@compID varchar(30)          
)          
AS        
SET NOCOUNT ON        
  
  
--print @now  
--print @txtEml  
  
  
set transaction isolation level read uncommitted          
begin          
declare @complno varchar(25)          
declare @newcomplno varchar(25)          
declare @inccomplno bigint          
declare @generatecomplaintno varchar(25)          
  
set @complno = (select max(ltrim(rtrim(complaintno))) from complaint_table where department = ''+@ddDept+' ')          
  
          
if @complno != ''            
begin          
  
 --select @complno          
 --select len(@complno)          
           
 set @newcomplno= (select substring(@complno,charindex('-',@complno)+1,(len( @complno))))          
 set @inccomplno = convert(bigint,@newcomplno)+ 1          
   
 set @generatecomplaintno = (select substring(@ddDept,0,charindex('-',@complno)))+ '-' + (select convert(varchar(50),@inccomplno))          
 select @generatecomplaintno          
   
 --        
 begin transaction          
   
 Insert into complaint_table(complaintno,complaint_date,emailid,problem,subject,queryfrom,entered_through,          
 department,entry_by,Phone,Suggestion,code,forwardto_dept,category,status)          
 values(''+ @generatecomplaintno + '','' +@Now + '','' + @txtEml+ '',''+ @txtMsg+'',''+ @txtSub+'',          
 ''+ @txtcltName+ '',''+ @UserId + '',''+ @ddDept +'',''+ @F_Name+'',          
 ''+ @txtTelNo+ '','' + @txtSug + '','' + @txtCode+ '',''+ @ddForwardTo+'',''+@category+'',''+@status+'')          
   
 Commit transaction        
 --update complaint_table set complaintno = @generatecomplaintno where complaintno = 'GCID'          
 --select charindex('-',@complno)          
end          
else          
begin          
 set @complno='10000001'          
 set @newcomplno =(select @complno)          
 set @inccomplno = convert(bigint,@newcomplno)+ 1          
 set @generatecomplaintno = (select @ddDept)+ '-' + (select convert(varchar(50),@inccomplno))          
           
 begin transaction        
 Insert into complaint_table(complaintno,complaint_date,emailid,problem,subject,queryfrom,entered_through,          
        department,entry_by,Phone,Suggestion,code,forwardto_dept,category,status)          
            values(''+ @generatecomplaintno + '',''+@Now + '','' + @txtEml+ '',''+ @txtMsg+'',''+ @txtSub+'',          
     ''+ @txtcltName+ '',''+ @UserId + '',''+ @ddDept +'',''+ @F_Name+'',          
                   ''+ @txtTelNo+ '','' + @txtSug + '','' + @txtCode+ '',''+ @ddForwardTo+'',''+ @category+'',''+@status+'')          
 Commit transaction      
   
   
   
 --update complaint_table set complaintno = @generatecomplaintno where complaintno = 'GCID'          
 select @generatecomplaintno          
 --select @complno           
end          
  
update mailreader set dummy1='1' where fromheader=@txtEml and dateheader=@Now  
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_get_client_info
-- --------------------------------------------------
CREATE procedure sp_get_client_info(@pcode as varchar(10),@pname as varchar(10),@city as varchar(10),@segment as varchar(10))    
as    
    
set nocount on    
    
set transaction isolation level read uncommitted    
select party_code,branch_Cd,branch=b.tradername,a.sub_broker,c.sbname,long_name,l_Address1,l_address2,L_address3,L_City,l_zip,pan_gir_no     
into #cli    
from intranet.risk.dbo.client_Details a, intranet.risk.dbo.branch b, intranet.risk.dbo.subgroup c    
where party_code like @pcode and long_name like @pname and l_city like @city     
and a.branch_Cd=b.sbtag and a.sub_BRoker=c.sub_Broker    
    
    
select pcode=isnull(x.pcode,y.pcode),cocode=isnull(x.cocode,y.cocode),    
COMPDATE=isnull((case when compdate = '' then status else substring(compdate,4,3)+substring(compdate,1,3)+substring(compdate,7,4) end ),status)     
into #temp1    
from (    
select pcode,cocode,COMPDATE from ABVSKYCMIS.kyc.dbo.formstatus with (nolock) where cocode=@segment and pcode=@pcode )x     
full outer join     
(    
select cocode,pcode,status=(case when id+bref+deed+board+sign+dp+intro+pan+bank >=1 then 'Incomplete' else '-' end)     
from ABVSKYCMIS.kyc.dbo.formdetails with (nolock) where cocode LIKE @segment and pcode LIKE @pcode    
) y on x.pcode=y.pcode and x.cocode=y.cocode     
    
set transaction isolation level read uncommitted    
select * from #cli  a left outer join #temp1 b    
on a.party_code=b.pcode    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_OPHelpdesk_AutoComplt
-- --------------------------------------------------

CREATE PROC SP_OPHELPDESK_AUTOCOMPLT                  
      AS                  
      BEGIN                  
      SELECT * INTO #T             
      FROM TBL_COMPLAINT       
      WHERE STATUS='C'       
      AND SOLUTION_DATE<=GETDATE()-7                 
      AND COMPLAINT_ID NOT IN                  
      (      
         SELECT COMPLAINT_ID       
         FROM TBL_COMPLAINT       
         WHERE STATUS IN ('BC')      
      )             
              
      SELECT A.*,B.SUBJECT AS SUBNAME       
      INTO #EMAIL       
      FROM           
      (      
        SELECT X.*,Y.EMAIL        
        FROM             
        (      
         SELECT * FROM #T WITH (NOLOCK)      
        )X            
        INNER JOIN            
         (      
          SELECT * FROM INTRANET.RISK.DBO.EMP_INFO WITH (NOLOCK)       
         )Y            
         ON X.FLD_ENTRYBY=Y.EMP_NO      
      ) A            
      INNER JOIN           
      TBL_SUBJECT B WITH (NOLOCK)          
      ON A.SUBJECT=B.SRNO          
              
                      
      UPDATE #T       
      SET COMPLAINT = 'AUTO COMPLETED',      
          SOLUTION = 'AUTO COMPLETED',       
       STATUS = 'BC',      
       FLD_HOLD_REASON='',      
       COMPLAINT_DATE=GETDATE(),      
       SOLUTION_DATE=GETDATE()                  
                      
      INSERT INTO   TBL_COMPLAINT                   
      SELECT DEPT_ID,COMPLAINT_ID,QUERY_TYPE,SUBJECT,COMPLAINT,SOLUTION,ACCESS_CODE,SOLUTION_BY,COMPLAINT_DATE,SOLUTION_DATE,ATTACHMENT,STATUS,FLD_ENTRYBY,CSO_ATTCH,FLD_HOLD_REASON,COMPL_ABT,CLT_SUBDETL                  
      FROM #T              
      
      
      SELECT TOP 0 * INTO #EMAIL1 FROM #EMAIL                    
                       
      ALTER TABLE #EMAIL1 ADD SRNO INT IDENTITY(1,1)                     
      TRUNCATE TABLE #EMAIL1                                  
                                     
      INSERT INTO #EMAIL1                                   
      SELECT * FROM #EMAIL              
      
      
      
      DECLARE @CNT INT,      
        @MESS VARCHAR(5000),      
        @SUB VARCHAR(100),          
        @REQID VARCHAR(100),      
        @EMAIL VARCHAR(200),          
        @REMAIL VARCHAR(200)          
                      
--      SET @MESS=''              
      
      SELECT @CNT=COUNT(1) FROM #EMAIL1           
      --PRINT  @CNT          
      
      DECLARE @INTFLAG INT                    
      SET @INTFLAG = 1                    
      WHILE (@INTFLAG <=@CNT)                    
      BEGIN            
      
      SELECT @REQID=COMPLAINT_ID,@EMAIL=EMAIL,@SUB=SUBNAME          
      FROM #EMAIL1 WHERE SRNO=@INTFLAG             
      --             
      --     SET @MESS='YOUR REQUEST '+ @REQID +' HAS BEEN COMPLETED.           
      --     <BR> <BR> <BR>        
      --     SOFTWARE CSO <BR>          
      --     THIS IS A SYSTEM GENERATED MAIL'       
      
      SET @MESS=      
      'Dear Sir/Madam,      
      <BR> <BR> <BR>      
      Your request  '+ @REQID +' has been completed.      
      <BR> <BR> <BR>       
	  This is an automated system generated Information for your reference. Please do not reply.<BR>
	  Angel Broking.'
		     
      
              
      EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                                                 
      @RECIPIENTS  = @EMAIL,        
      --@RECIPIENTS  = 'RENIL.PILLAI@ANGELTRADE.COM',        
      @COPY_RECIPIENTS =  '',        
      @BLIND_COPY_RECIPIENTS='ROOPALI.PANDEY@ANGELTRADE.COM',        
      @PROFILE_NAME = 'OPERATIONHELPDESK',        
      @BODY_FORMAT ='HTML',        
      @SUBJECT = @SUB,        
      --@FILE_ATTACHMENTS =@ATTACH,                                                                                                                                                                     
      --@SERVER = 'ANGELMAIL.ANGELBROKING.COM',                               
      @BODY =@MESS             
      
-- PRINT @INTFLAG                    
      SET @INTFLAG = @INTFLAG + 1                    
                      
      END          
      
      
              
      END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_SummaryReport
-- --------------------------------------------------
CREATE Proc sp_SummaryReport
(
@fDate as varchar(50),
@tDate as varchar(50)
)
as --'Delete #temp
--select @fDate
set nocount off
/*
declare @fdate as datetime,@tdate as datetime
set @fdate = 'Apr 13 2006 00:00:000'
set @tdate = 'Apr 13 2006 23:59:000'
*/

select distinct a.departmentname as Department,
Solved_Complaints = (Isnull(Completed,0)),Pending_Complaints = (Isnull(Pending,0)),
Total = (Isnull(Completed,0)+Isnull(Pending,0)) 
into #temp /* Drop Table #Temp */
from complaint_table 
 as ct inner join departmentmaster as a on ct.department = a.deptno left outer join (select 
Department,Completed=count(*)from complaint_table where status='Completed' and 
complaint_date >= @fDate  and complaint_date <= @tDate  
group by Department) as C on ct.Department = C.Department left outer join 
(select Department,Pending=count(*) from complaint_table where status='Pending' and 
complaint_date >= @fDate  and complaint_date <=  @tDate 
group by Department)as P on ct.Department = P.Department

select * from #temp  where total > 0

set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.StockQuoteGet
-- --------------------------------------------------
create procedure StockQuoteGet 
@Name char(4)
as
select * from Stocks 
where Name = @Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TAT_callmail
-- --------------------------------------------------
CREATE procedure  TAT_CallMail (@flag  varchar (1),@FromDate varchar(11),@ToDate varchar(11),@dept varchar (10))  
as  
set nocount on 
if @flag='A'  
begin 
select distinct type='Call',Less=sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) <=12 then 1 else 0 end)  from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept

union all
select distinct type='Mail',less= sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) <=12 then 1 else 0 end) from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept

end

if @flag='B'  
begin 
select distinct type='Call',Less =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >12 and  datediff(hh,complaint_date,completed_on) <=24 then 1       
else 0 end) from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept 
 
union all
select distinct type='Mail',less= sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >12 and  datediff(hh,gc_senton,resolved_date) <=24 then 1       
else 0 end) from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept 
 
end

if @flag='C'  
begin 
select distinct type='Call',Less=sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >24 and  datediff(hh,complaint_date,completed_on) <=36 then 1       
else 0 end) from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept 

union all
select distinct type='Mail',less=sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >24 and  datediff(hh,gc_senton,resolved_date) <=36 then 1       
else 0 end) from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept 

end

if @flag='D'  
begin 
select distinct type='Call',Less =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >36 and  datediff(hh,complaint_date,completed_on) <=48 then 1       
else 0 end) from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept
 
union all
select distinct type='Mail',less=sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >36 and  datediff(hh,gc_senton,resolved_date) <=48 then 1       
else 0 end) from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept 

end  


if @flag='E'  
begin 
select distinct type='Call',Less=sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >48 and  datediff(hh,complaint_date,completed_on) <=60 then 1       
else 0 end) from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept 

union all
select distinct type='Mail',less=sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >48 and  datediff(hh,gc_senton,resolved_date) <=60 then 1       
else 0 end) from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept
 
end

if @flag='F'  
begin 
select distinct type='Call',Less =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >60 and  datediff(hh,complaint_date,completed_on) <=72 then 1       
else 0 end) from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept 

union all
select distinct type='Mail',less=sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >60 and  datediff(hh,gc_senton,resolved_date) <=72 then 1       
else 0 end)  from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept 

end  

if @flag='G'  
begin 
select distinct type='Call',Less=sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >72  then 1       
else 0 end) from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept 

union all
select distinct type='Mail',less=sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >72  then 1       
else 0 end) from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept 

end

if @flag='H'  
begin 
select distinct type='Call',Less =sum(case when helpdeskmarkcompleted='N'   then 1       
else 0 end) from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <=@ToDate+' 23:59:00'       
and  entered_through='HD' and ct.department=@dept 

union all
select distinct type='Mail',less=sum(case when resolved<>'yes'   then 1       
else 0 end)  from reply_Mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@FromDate+' 00:00:000' and gc_senton <=@ToDate+' 23:59:00' and  ct.department=@dept 

end  

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TAT_Report
-- --------------------------------------------------
CREATE procedure TAT_Report(@FromDate varchar(11),@ToDate varchar(11))    
as                  
set nocount on       
    
begin     
     
/*declare @sum float    
declare @FromDate varchar(11)           
declare @Todate varchar(11)             
set @FromDate='Apr 01 2008'            
set @ToDate =  'Jun 30 2008'    */  
  
Set transaction Isolation level read uncommitted  
select distinct a.departmentname as Department,ct.department as Deptid,Less12 =sum(case when helpdeskmarkcompleted='Y'   
and datediff(hh,complaint_date,completed_on) <=12 then 1 else 0 end)  
,Less24 =sum(case when helpdeskmarkcompleted='Y'   
and datediff(hh,complaint_date,completed_on) >12 and  datediff(hh,complaint_date,completed_on) <=24 then 1   
else 0 end)  
,Less36 =sum(case when helpdeskmarkcompleted='Y'   
and datediff(hh,complaint_date,completed_on) >24 and  datediff(hh,complaint_date,completed_on) <=36 then 1   
else 0 end)  
,Less48 =sum(case when helpdeskmarkcompleted='Y'   
and datediff(hh,complaint_date,completed_on) >36 and  datediff(hh,complaint_date,completed_on) <=48 then 1   
else 0 end)  
,Less60 =sum(case when helpdeskmarkcompleted='Y'   
and datediff(hh,complaint_date,completed_on) >48 and  datediff(hh,complaint_date,completed_on) <=60 then 1   
else 0 end)  
,Less72 =sum(case when helpdeskmarkcompleted='Y'   
and datediff(hh,complaint_date,completed_on) >60 and  datediff(hh,complaint_date,completed_on) <=72 then 1   
else 0 end)  
,Great72 =sum(case when helpdeskmarkcompleted='Y'   
and datediff(hh,complaint_date,completed_on) >72  then 1   
else 0 end)  
,Unsolved =sum(case when helpdeskmarkcompleted='N'   then 1   
else 0 end)  
from complaint_table as ct (nolock)  
inner join departmentmaster as a (nolock)  
on ct.department = a.deptno   
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'   
and  entered_through='HD'  
group by a.departmentname ,ct.department
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TAT_Report_time
-- --------------------------------------------------
CREATE procedure  TAT_Report_time (@type varchar(5), @flag  varchar (1),@FromDate varchar(11),@ToDate varchar(11),@dept varchar (10))  
as  
set nocount on   
 if @type='Call' 
begin
if @flag='A'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='completed' and datediff(hh,complaint_date,completed_on) <=12   
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end   
  
if @flag='B'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='completed' and datediff(hh,complaint_date,completed_on) >12 and  datediff(hh,complaint_date,completed_on) <=24  
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end   
  
if @flag='C'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='completed' and datediff(hh,complaint_date,completed_on) >24 and  datediff(hh,complaint_date,completed_on) <=36  
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end   
  
if @flag='D'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='completed' and datediff(hh,complaint_date,completed_on) >36 and  datediff(hh,complaint_date,completed_on) <=48  
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end   
  
  
if @flag='E'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='completed' and datediff(hh,complaint_date,completed_on) >48 and  datediff(hh,complaint_date,completed_on) <=60  
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end   
  
  
if @flag='F'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='completed' and datediff(hh,complaint_date,completed_on) >60 and  datediff(hh,complaint_date,completed_on) <=72  
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end   
  
  
if @flag='G'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='completed' and datediff(hh,complaint_date,completed_on) >72   
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end   
  
  
if @flag='H'  
begin  
select complaint_date=complaint_date,code,department,dsection,queryfrom,contact_person,problem,   
suggestion,remark,completed_on,a.status,complaintno,a.party_code,category,dremark,   
helpdeskmarkcompleteddate,entry_by,b.departmentname,c.branch_cd,c.region   
from mis.helpdesk.dbo.complaint_table a left outer join mis.helpdesk.dbo.departmentmaster  
 b on a.department=b.deptno left outer join intranet.risk.dbo.client_details c   
on a.code = c.cl_code where complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'  
and a.status='pending'    
 and entered_through='HD' and department like @dept and a.status like '%' and wrong_entry <> 'Y'  
end 
end
 

if @type='Mail' 
begin
if @flag='A'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved='yes' and datediff(hh,a.gc_senton,a.resolved_date) <=12   
 and department like @dept
end   
  
if @flag='B'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved='yes'and datediff(hh,a.gc_senton,a.resolved_date) >12 and  datediff(hh,a.gc_senton,a.resolved_date) <=24  
 and department like @dept
end   
  
if @flag='C'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved='yes'and datediff(hh,a.gc_senton,a.resolved_date) >24 and  datediff(hh,a.gc_senton,a.resolved_date) <=36  
 and department like @dept
end   
  
if @flag='D'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved='yes'and datediff(hh,a.gc_senton,a.resolved_date) >36 and  datediff(hh,a.gc_senton,a.resolved_date) <=48  
 and department like @dept
end   
  
  
if @flag='E'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved='yes'and datediff(hh,a.gc_senton,a.resolved_date) >48 and  datediff(hh,a.gc_senton,a.resolved_date) <=60  
 and department like @dept
end   
  
  
if @flag='F'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved='yes'and datediff(hh,a.gc_senton,a.resolved_date) >60 and  datediff(hh,a.gc_senton,a.resolved_date) <=72 
 and department like @dept
end   
  
  
if @flag='G'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved='yes'and datediff(hh,a.gc_senton,a.resolved_date) >72 
 and department like @dept
end   
  
  
if @flag='H'  
begin  
select a.gc_senton,b.region,b.branch_cd,a.code,a.gc_sendername,a.category,a.gc_guid,a.gc_subject,a.gc_reply,
resolved=case when a.resolved='yes' then 'completed' else 'pending' end,a.resolved_by
from reply_Mail a join intranet.risk.dbo.client_details b
on a.code=b.party_code
where a.gc_senton >=@FromDate+' 00:00:000' and a.gc_senton <= @ToDate+' 23:59:00'  
and a.resolved<>'yes'
 and department like @dept
end 
end 
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TAT_Report1
-- --------------------------------------------------
CREATE procedure TAT_Report1 (@FromDate varchar(11),@ToDate varchar(11))        
as                      
set nocount on     
/*declare @FromDate varchar(11),@ToDate varchar(11)
Set @FromDate='Sep 13 2008'
Set @ToDate='Sep 13 2008'      
*/        
begin         
         
select distinct a.departmentname as Department,ct.department as Deptid,less12= sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) <=12 then 1 else 0 end)      
,Less24 =sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >12 and  datediff(hh,gc_senton,resolved_date) <=24 then 1       
else 0 end)      
,Less36 =sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >24 and  datediff(hh,gc_senton,resolved_date) <=36 then 1       
else 0 end)      
,Less48 =sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >36 and  datediff(hh,gc_senton,resolved_date) <=48 then 1       
else 0 end)      
,Less60 =sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >48 and  datediff(hh,gc_senton,resolved_date) <=60 then 1       
else 0 end)      
,Less72 =sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >60 and  datediff(hh,gc_senton,resolved_date) <=72 then 1       
else 0 end)      
,Great72 =sum(case when resolved='yes'       
and datediff(hh,gc_senton,resolved_date) >72  then 1       
else 0 end)      
,Unsolved =sum(case when resolved<>'yes'   then 1       
else 0 end) into #file2     
from helpdesk.dbo.reply_mail as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  gc_senton >=@fromdate+' 00:00:000' and gc_senton <= @Todate+' 23:59:00'       
group by a.departmentname ,ct.department
  
    
Set transaction Isolation level read uncommitted      
select distinct a.departmentname as Department,ct.department as Deptid,Less12 =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) <=12 then 1 else 0 end)      
,Less24 =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >12 and  datediff(hh,complaint_date,completed_on) <=24 then 1       
else 0 end)      
,Less36 =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >24 and  datediff(hh,complaint_date,completed_on) <=36 then 1       
else 0 end)      
,Less48 =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >36 and  datediff(hh,complaint_date,completed_on) <=48 then 1       
else 0 end)      
,Less60 =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >48 and  datediff(hh,complaint_date,completed_on) <=60 then 1       
else 0 end)      
,Less72 =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >60 and  datediff(hh,complaint_date,completed_on) <=72 then 1       
else 0 end)      
,Great72 =sum(case when helpdeskmarkcompleted='Y'       
and datediff(hh,complaint_date,completed_on) >72  then 1       
else 0 end)      
,Unsolved =sum(case when helpdeskmarkcompleted='N'   then 1       
else 0 end) into #file1     
from complaint_table as ct (nolock)      
inner join departmentmaster as a (nolock)      
on ct.department = a.deptno       
where  complaint_date >=@FromDate+' 00:00:000' and complaint_date <= @ToDate+' 23:59:00'       
and  entered_through='HD'      
group by a.departmentname ,ct.department  
  
select department='CLIENT SUMMARY',deptid='cs',Less12 =sum(case when status='1'       
and datediff(hh,qdate,adate) <=12 then 1 else 0 end)      
,Less24 =sum(case when status='1'       
and datediff(hh,qdate,adate) >12 and  datediff(hh,qdate,adate) <=24 then 1       
else 0 end)      
,Less36 =sum(case when status='1'       
and datediff(hh,qdate,adate) >24 and  datediff(hh,qdate,adate) <=36 then 1       
else 0 end)      
,Less48 =sum(case when status='1'       
and datediff(hh,qdate,adate) >36 and  datediff(hh,qdate,adate) <=48 then 1       
else 0 end)      
,Less60 =sum(case when status='1'       
and datediff(hh,qdate,adate) >48 and  datediff(hh,qdate,adate) <=60 then 1       
else 0 end)      
,Less72 =sum(case when status='1'       
and datediff(hh,qdate,adate) >60 and  datediff(hh,qdate,adate) <=72 then 1       
else 0 end)      
,Great72 =sum(case when status='1'       
and datediff(hh,qdate,adate) >72  then 1       
else 0 end)      
,Unsolved =sum(case when status='0'   then 1       
else 0 end) into #file3     
from mimansa.bsedb_ab.dbo.ClientQuestionAnswer     
where  qdate >=@FromDate+' 00:00:000' and qdate <=@toDate+' 23:59:00'     
  
select department='PASSWORD VERIFICATION',deptid='pv',Less12 =sum(case when verification_status='Confirmed'       
and datediff(hh,requestdatetime,verified_on) <=12 then 1 else 0 end)      
,Less24 =sum(case when verification_status='Confirmed'       
and datediff(hh,requestdatetime,verified_on) >12 and  datediff(hh,requestdatetime,verified_on) <=24 then 1       
else 0 end)      
,Less36 =sum(case when verification_status='Confirmed'       
and datediff(hh,requestdatetime,verified_on) >24 and  datediff(hh,requestdatetime,verified_on) <=36 then 1       
else 0 end)      
,Less48 =sum(case when verification_status='Confirmed'       
and datediff(hh,requestdatetime,verified_on) >36 and  datediff(hh,requestdatetime,verified_on) <=48 then 1       
else 0 end)      
,Less60 =sum(case when verification_status='Confirmed'       
and datediff(hh,requestdatetime,verified_on) >48 and  datediff(hh,requestdatetime,verified_on) <=60 then 1       
else 0 end)      
,Less72 =sum(case when verification_status='Confirmed'       
and datediff(hh,requestdatetime,verified_on) >60 and  datediff(hh,requestdatetime,verified_on) <=72 then 1       
else 0 end)      
,Great72 =sum(case when verification_status='Confirmed'       
and datediff(hh,requestdatetime,verified_on) >72  then 1       
else 0 end)      
,Unsolved =sum(case when verification_status<>'Confirmed' then 1       
else 0 end) into #file4     
from intranet.misc.dbo.bo_passwordreset      
where  requestdatetime >=@FromDate+' 00:00:000' and requestdatetime <=@toDate+' 23:59:00'        
  
  
Select Department,deptid,Less12=sum(less12),Less24=sum(less24),Less36=sum(less36),Less48=sum(less48),Less60=sum(less60),Less72=sum(less72),Great72=sum(Great72),Unsolved=sum(Unsolved)
from
(
select * from #file1  
union all  
select * from #file2  
union all  
select * from #file3  
union all  
select * from #file4  
) a group by   Department,deptid
  
  
END   
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.tbl_it_br_master_megha
-- --------------------------------------------------
CREATE proc tbl_it_br_master_megha (@branch as varchar(50))
as   
select br_tag,br_name,br_address,br_telno,br_fax,br_head,br_head_mails,br_cellno from tbl_it_br_master where Sr_No = @branch

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Temp_calc
-- --------------------------------------------------
Create proc Temp_calc
as

select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from      
(
select g.Total_Brok_Loss,h.* from
(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= 'Sep 01 2007' and sauda_date <= 'Sep 30 2007' 
and dt <> 0  group by server)
g inner join
(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from
(
select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss))   
from terminal_brok_loss where  sauda_date >= 'Sep 01 2007' and sauda_date <= 'Sep 30 2007' 
and dt <> 0  group by server,issues
)
e inner join
(
select server,dt=sum(convert(dec,dt))
from terminal_brok_loss where  sauda_date >= 'Sep 01 2007' and sauda_date <= 'Sep 30 2007' 
and dt <> 0  group by server
)f on e.server = f.server) h 
on g.server = h.server
)

 c 
inner join 
(
select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in       
(
select distinct server from terminal_brok_loss where sauda_date >= 'Sep 01 2007' and sauda_date <= 'Sep 30 2007' 
and dt <> 0
)
) 
a inner join ( 
select segment,uptime from 
( 
select 'ABLCM' as segment, Uptime=sum(bse) from sett_mst where tdate >= 'Sep 01 2007' and tdate <= 'Sep 30 2007'    
union SELECT 'ACDLCM' as segment, sum(cm) from sett_mst where tdate >= 'Sep 01 2007' and tdate <= 'Sep 30 2007'      
union SELECT 'ACDLFO' as segment,sum(fo) from sett_mst where tdate >= 'Sep 01 2007' and tdate <= 'Sep 30 2007'      
union SELECT 'ACPLMCX' as segment, sum(mcx) from sett_mst where tdate >= 'Sep 01 2007' and tdate <= 'Sep 30 2007'      
union SELECT 'ACPLNCDEX' as segment, sum(NCDEX) from sett_mst where tdate >= 'Sep 01 2007' and tdate <= 'Sep 30 2007'      
)
x) 
b on a.segment = b.segment group by a.server
)d 
on c.server = d.server order by  c.server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPD_Del_IP
-- --------------------------------------------------
Create Proc UPD_Del_IP (@SrNo as int)
as

begin tran

delete tbl_IT_IPaddress where Fld_SrNo = @SrNo
delete tbl_ip_details where Fld_Ip_ID = @SrNo

commit

GO

-- --------------------------------------------------
-- PROCEDURE dbo.update_addsolution
-- --------------------------------------------------
CREATE proc update_addsolution
(
@Fld_Request_ID numeric(10),
@Fld_Solution varchar(500)
)
as
update Tbl_HR_Solution_Master set Fld_Request_ID = @Fld_Request_ID,Fld_Solution = @Fld_Solution 
where Fld_Request_ID=@Fld_Request_ID and Fld_Solution=@Fld_Solution

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPLOADDATE_CSV
-- --------------------------------------------------
CREATE proc UPLOADDATE_CSV   
(            
@filename as varchar(100)                
)            
as            
declare @path as varchar(100)                      
declare @sql as varchar(1000)            
--set @filename = 'pledge'             
truncate table NCFM_Date_Upload                           
set @path='d:\upload1\NCFM\' + @filename              
SET @SQL = 'BULK INSERT NCFM_Date_Upload FROM '''+@Path+''' WITH (FIELDTERMINATOR = '','',FirstRow=1,KeepNULLS)'                      
--print @SQL              
exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Ups_Modify_Inventory
-- --------------------------------------------------
CREATE PROC Ups_Modify_Inventory
(
 @UpsMapId int =null,
 @UpsId int =null,
 @Activation_Status Char(1)=null,
 @Remark Varchar(50)=null,
 @UpdatedBy Varchar(20)=null
)
AS
BEGIN
 --Update  tbl_ups_mapping
 --SET Remark =@Remark,UpdatedBy =@UpdatedBy,StatusUpdatedOn =GETDATE()
 --WHERE Fld_SrNo = @UpsMapId    

 Update tbl_ups_master
 SET Fld_Activation_Status =@Activation_Status,
	 Remark =@Remark,UpdatedBy =@UpdatedBy,
	 DeactivatedOn = CASE WHEN @Activation_Status='D' THEN GETDATE() ELSE '2049-12-30 14:20:49.483' END
 WHERE Fld_srNo = @UpsId
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPS_Order_Confirmation
-- --------------------------------------------------
  
  
--UPS_Order_Confirmation '1/1/2012'  , '5/22/2012' ,'%%','R'        
--UPS_Order_Confirmation '1/1/2013'  , '1/16/2013' ,'%%','R'        
      
--UPS_Order_Confirmation '09/17/2012'  , '9/22/2012' ,'all','R'        
      
CREATE Proc [dbo].[UPS_Order_Confirmation]        
@fdate as Varchar(11),        
@tdate as Varchar(11),        
@datacenter as varchar(15),        
@Type as char(1)        
as          
        
Declare @str as varchar(3000)           
declare @case as varchar(1000)          
Declare @ServerCase As Varchar(1000)         
            
if @Type = 'E'          
Begin           
 select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,      
 convert(varchar(11),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from          
 (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person      
  FROM Tbl_IT_Br_Master (nolock) WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH'))x          
 left outer join          
 (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate + ' 23:59:59')y          
 on x.Branch_id = y.Fld_Branch_id        
 order by Fld_upd_Time,Br_name        
end          
else if @Type = 'R'          
Begin           
 If  CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'        
  BEGIN        
   select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,        
     convert(VARCHAR(10),Fld_Upd_Time,103)  as Fld_Upd_Time,Fld_Contact_Person         
    from        
    (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person         
     FROM Tbl_IT_Br_Master (nolock)         
     WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH') and convert(varchar,Sr_No) like replace(@datacenter,'all','%') ---like  @datacenter(zeba)      
     and  Sr_No in (SELECT (sr_no) FROM dbo.Server_manager_Branch_ITdetails_todate WHERE fld_to_date > @tdate )        
    )x        
    INNER JOIN        
    (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate        
    -- and Fld_Branch_Id not in ('129')   
      --and Fld_Branch_Id  in (select sr_no from Server_manager_Branch_ITdetails it)  
     and Fld_Branch_Id  in ( SELECT (sr_no) FROM dbo.Server_manager_Branch_ITdetails_todate WHERE fld_to_date > @tdate)
    )y        
     on x.Branch_id = y.Fld_Branch_id           
    order by Fld_upd_Time,Br_name        
  END        
 ELSE        
  BEGIN        
   select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,        
    convert(VARCHAR(10),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person         
   from        
   (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person         
    FROM Tbl_IT_Br_Master (nolock)         
    WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH') and convert(varchar,Sr_No) like replace(@datacenter,'all','%')  ---like  @datacenter(zeba)         
   )x          
   inner join          
   (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate        
   )y        
    on x.Branch_id = y.Fld_Branch_id           
   order by Fld_upd_Time,Br_name         
  END        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPS_Order_Confirmation_16012013
-- --------------------------------------------------


--UPS_Order_Confirmation '1/1/2012'  , '5/22/2012' ,'%%','R'      
--UPS_Order_Confirmation '7/1/2012'  , '7/22/2012' ,'%%','R'      
    
--UPS_Order_Confirmation '09/17/2012'  , '9/22/2012' ,'all','R'      
    
CREATE Proc [dbo].[UPS_Order_Confirmation_16012013]      
@fdate as Varchar(11),      
@tdate as Varchar(11),      
@datacenter as varchar(15),      
@Type as char(1)      
as        
      
Declare @str as varchar(3000)         
declare @case as varchar(1000)        
Declare @ServerCase As Varchar(1000)       
          
if @Type = 'E'        
Begin         
 select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,    
 convert(varchar(11),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from        
 (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person    
  FROM Tbl_IT_Br_Master (nolock) WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH'))x        
 left outer join        
 (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate + ' 23:59:59')y        
 on x.Branch_id = y.Fld_Branch_id      
 order by Fld_upd_Time,Br_name      
end        
else if @Type = 'R'        
Begin         
 If  CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'      
  BEGIN      
   select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,      
     convert(VARCHAR(10),Fld_Upd_Time,103)  as Fld_Upd_Time,Fld_Contact_Person       
    from      
    (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person       
     FROM Tbl_IT_Br_Master (nolock)       
     WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH') and convert(varchar,Sr_No) like replace(@datacenter,'all','%') ---like  @datacenter(zeba)    
     and  Sr_No not in ('129')      
    )x      
    INNER JOIN      
    (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate      
     and Fld_Branch_Id not in ('129')      
    )y      
     on x.Branch_id = y.Fld_Branch_id         
    order by Fld_upd_Time,Br_name      
  END      
 ELSE      
  BEGIN      
   select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,      
    convert(VARCHAR(10),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person       
   from      
   (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person       
    FROM Tbl_IT_Br_Master (nolock)       
    WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH') and convert(varchar,Sr_No) like replace(@datacenter,'all','%')  ---like  @datacenter(zeba)       
   )x        
   inner join        
   (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate      
   )y      
    on x.Branch_id = y.Fld_Branch_id         
   order by Fld_upd_Time,Br_name       
  END      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPS_Order_Confirmation_entry
-- --------------------------------------------------
--UPS_Order_Confirmation_entry   '09/09/2014'  , '09/09/2014' ,'%%','E'          
--UPS_Order_Confirmation_entry    '25/7/2012'  , '25/7/2012' ,'%%','E'          
CREATE Proc [dbo].[UPS_Order_Confirmation_entry](@fdate as varchar(11),@tdate as varchar(11),@datacenter as varchar(15),@Type as char(1))                                
as                                
                              
set @fdate = convert(datetime,@fdate,103)                              
set @tdate = convert(datetime,@tdate,103)                    
          
Declare @str as varchar(3000)=''                                 
declare @case as varchar(1000) =''               
Declare @ServerCase As Varchar(1000)             
 If  CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'  and CONVERT(datetime , @fdate)<'2014-09-09 00:00:00.000' and CONVERT(datetime , @tdate)<'2014-09-09 00:00:00.000'    
 --Select @case='   and  Sr_No not in (''129'',''115'')'            
 Select @case= 'and Sr_No  in (select distinct(sr_no) from Server_manager_Branch_ITdetails it where sr_no not in (''329'') )' 
 Else If  CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'  and CONVERT(datetime , @fdate)>'2014-09-08 00:00:00.000' and CONVERT(datetime , @tdate)>'2014-09-08 00:00:00.000'    
 --Select @case='   and  Sr_No not in (''129'',''115'')'            
 Select @case= 'and Sr_No  in (select distinct(sr_no) from Server_manager_Branch_ITdetails it where sr_no not in (''198'') )' 
 Else                                        
 Select @case= ''         
          
          
If CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'  and CONVERT(datetime , @fdate)<'2014-09-09 00:00:00.000' and CONVERT(datetime , @tdate)<'2014-09-09 00:00:00.000'            
  --Select @ServerCase= '  and Fld_Branch_Id not in (''129'')'
  Select @ServerCase= 'and Fld_Branch_Id  in (select distinct(sr_no) from Server_manager_Branch_ITdetails it where sr_no not in (''329'') )'
Else If CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'  and CONVERT(datetime , @fdate)>'2014-09-08 00:00:00.000' and CONVERT(datetime , @tdate)>'2014-09-08 00:00:00.000'            
  --Select @ServerCase= '  and Fld_Branch_Id not in (''129'')'
  Select @ServerCase= 'and Fld_Branch_Id  in (select distinct(sr_no) from Server_manager_Branch_ITdetails it where sr_no not in (''198'') )'
 Else                                        
Select @ServerCase= ''               
                      
if @Type = 'E'                      
                      
Begin                       
 set @str='select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11)    
 ,Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                                
(SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person    
 FROM Tbl_IT_Br_Master (nolock) WHERE BR_TYPE = ''DATACENTER'' '+@case+')x                                
 left outer join                                
--inner join        
(select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= '''+@fdate+''' and Fld_Upd_Time <= '''+@tdate+''' '+ @ServerCase+')y                                
on x.Branch_id = y.Fld_Branch_id                            
order by Fld_upd_Time,Br_name'                              
        Print (@Str)          
         Exec(@Str)           
end                      
                            
if @Type = 'R'                      
                      
Begin                                  
 set @str='                          
      select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                                
      (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person FROM Tbl_IT_Br_Master (nolock) WHERE BR_TYPE = ''DATACENTER'' and convert(varchar,Sr_No) like '''+@datacenter+''' '+@case+')x                         
  
    
      
       
      inner join                                
      (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= '''+@fdate+''' and Fld_Upd_Time <= '''+@tdate+''' '+ @ServerCase+')y                                
      on x.Branch_id = y.Fld_Branch_id                            
      order by Fld_upd_Time,Br_name'                              
                            
         Print (@Str)          
         Exec(@Str)           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPS_Order_Confirmation_entry_17012013
-- --------------------------------------------------


 --UPS_Order_Confirmation_entry   '6/1/2012'  , '6/1/2012' ,'%%','E'        
--UPS_Order_Confirmation_entry    '25/7/2012'  , '25/7/2012' ,'%%','E'        
CREATE Proc [dbo].[UPS_Order_Confirmation_entry_17012013](@fdate as varchar(11),@tdate as varchar(11),@datacenter as varchar(15),@Type as char(1))                              
as                              
                            
set @fdate = convert(datetime,@fdate,103)                            
set @tdate = convert(datetime,@tdate,103)                  
        
Declare @str as varchar(3000)=''                               
declare @case as varchar(1000) =''             
Declare @ServerCase As Varchar(1000)           
 If  CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'                  
 Select @case='   and  Sr_No not in (''129'',''115'')'          
 Else                                      
 Select @case= ''        
        
        
If CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'        
  Select @ServerCase= '  and Fld_Branch_Id not in (''129'')'        
 Else                                      
Select @ServerCase= ''             
                    
if @Type = 'E'                    
                    
Begin                     
 set @str='select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11)  
 ,Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                              
(SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person  
 FROM Tbl_IT_Br_Master (nolock) WHERE BR_TYPE = ''DATACENTER'' '+@case+')x                              
 left outer join                              
--inner join      
(select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= '''+@fdate+''' and Fld_Upd_Time <= '''+@tdate+''' '+ @ServerCase+')y                              
on x.Branch_id = y.Fld_Branch_id                          
order by Fld_upd_Time,Br_name'                            
        Print (@Str)        
         Exec(@Str)         
end                    
                          
if @Type = 'R'                    
                    
Begin                                
 set @str='                        
      select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                              
      (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person FROM Tbl_IT_Br_Master (nolock) WHERE BR_TYPE = ''DATACENTER'' and convert(varchar,Sr_No) like '''+@datacenter+''' '+@case+')x                         
  
    
     
      inner join                              
      (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= '''+@fdate+''' and Fld_Upd_Time <= '''+@tdate+''' '+ @ServerCase+'
		 and Fld_Branch_Id  in (select distinct(sr_no) from Server_manager_Branch_ITdetails it )
	  )y                              
      on x.Branch_id = y.Fld_Branch_id                          
      order by Fld_upd_Time,Br_name'                            
                          
         Print (@Str)        
         Exec(@Str)         
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPS_Order_Confirmation_entry_22Oct2014
-- --------------------------------------------------
  
  
 --UPS_Order_Confirmation_entry   '6/1/2012'  , '6/1/2012' ,'%%','E'          
--UPS_Order_Confirmation_entry    '25/7/2012'  , '25/7/2012' ,'%%','E'          
Create Proc [dbo].[UPS_Order_Confirmation_entry_22Oct2014](@fdate as varchar(11),@tdate as varchar(11),@datacenter as varchar(15),@Type as char(1))                                
as                                
                              
set @fdate = convert(datetime,@fdate,103)                              
set @tdate = convert(datetime,@tdate,103)                    
          
Declare @str as varchar(3000)=''                                 
declare @case as varchar(1000) =''               
Declare @ServerCase As Varchar(1000)             
 If  CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'                    
 --Select @case='   and  Sr_No not in (''129'',''115'')'            
 Select @case= 'and Sr_No  in (select distinct(sr_no) from Server_manager_Branch_ITdetails it )'
 Else                                        
 Select @case= ''         
          
          
If CONVERT(datetime , @fdate)>'2012-06-22 00:00:00.000' and CONVERT(datetime , @tdate)>'2012-06-22 00:00:00.000'          
  --Select @ServerCase= '  and Fld_Branch_Id not in (''129'')'
  Select @ServerCase= 'and Fld_Branch_Id  in (select distinct(sr_no) from Server_manager_Branch_ITdetails it )'
 Else                                        
Select @ServerCase= ''               
                      
if @Type = 'E'                      
                      
Begin                       
 set @str='select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11)    
 ,Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                                
(SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person    
 FROM Tbl_IT_Br_Master (nolock) WHERE BR_TYPE = ''DATACENTER'' '+@case+')x                                
 left outer join                                
--inner join        
(select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= '''+@fdate+''' and Fld_Upd_Time <= '''+@tdate+''' '+ @ServerCase+')y                                
on x.Branch_id = y.Fld_Branch_id                            
order by Fld_upd_Time,Br_name'                              
        Print (@Str)          
         Exec(@Str)           
end                      
                            
if @Type = 'R'                      
                      
Begin                                  
 set @str='                          
      select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                                
      (SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person FROM Tbl_IT_Br_Master (nolock) WHERE BR_TYPE = ''DATACENTER'' and convert(varchar,Sr_No) like '''+@datacenter+''' '+@case+')x                         
  
    
      
       
      inner join                                
      (select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= '''+@fdate+''' and Fld_Upd_Time <= '''+@tdate+''' '+ @ServerCase+')y                                
      on x.Branch_id = y.Fld_Branch_id                            
      order by Fld_upd_Time,Br_name'                              
                            
         Print (@Str)          
         Exec(@Str)           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPS_Order_Confirmation_New
-- --------------------------------------------------
CREATE Proc [dbo].[UPS_Order_Confirmation_new](@fdate as varchar(11),@tdate as varchar(11),@datacenter as varchar(15),@Type as char(1))                      
as                      
                    
--set @fdate = convert(datetime,@fdate,103)                    
--set @tdate = convert(datetime,@tdate,103)                    
            
if @Type = 'E'            
            
Begin             
                    
select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                      
(SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person FROM Tbl_IT_Br_Master (nolock) WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH'))x                      
left outer join                      
(select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate + ' 23:59:59')y                      
on x.Branch_id = y.Fld_Branch_id                  
order by Fld_upd_Time,Br_name                    
            
end            
                  
if @Type = 'R'            
            
Begin             
                    
select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,convert(varchar(11),Fld_Upd_Time,103) as Fld_Upd_Time,Fld_Contact_Person from                      
(SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name,upper(Br_Contact_Person) as Br_Contact_Person FROM Tbl_IT_Br_Master (nolock) WHERE (BR_TYPE = 'DATACENTER' or BR_TYPE = 'BRANCH') and convert(varchar,Sr_No) like @datacenter)x                      
inner join                      
(select * from tbl_Order_Confirmation (nolock) where Fld_Upd_Time >= @fdate and Fld_Upd_Time <= @tdate + ' 23:59:59')y                      
on x.Branch_id = y.Fld_Branch_id                  
order by Fld_upd_Time,Br_name                    
            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPS_TCP_COUNT
-- --------------------------------------------------
CREATE Proc UPS_TCP_COUNT(@fdate as varchar(11),@tdate as varchar(11),@server as varchar(50))
as

set @fdate = convert(varchar(11),convert(datetime,@fdate,103))
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))
set @server = case when @server = 'ALL' then 'like ''%%''' else '= '+''''+@server+'''' end

declare @str as varchar(500)

set @str = 'select Fld_Server_id,Sum(convert(int,Fld_Count)) as TCP_Count from tbl_TCP 
where Fld_date >= '''+@fdate+''' and fld_date <= '''+@tdate+' 23:59:59'' and Fld_Server_ID '+@server+'
group by Fld_Server_id'

exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_AddEditITStaffMaster
-- --------------------------------------------------
CREATE proc [dbo].[Usp_AddEditITStaffMaster]
@Option int,
@Emp_Id varchar(20),
@Phone varchar(50),
@Emailadd varchar(100),
@IT_Location nvarchar(255),
@Modified_By varchar(20),
@Modification_Remark varchar(200)

As


Begin
if(@Option = 1)--Check if Emp Exits(only IT employees)in ITStaffMaster
Begin
	
	Select [Emp No] As [Emp_No]
	From tbl_ITStaffmaster where [Emp No] = @Emp_Id

End


else if(@Option = 2)--Show the particular emp's edetails
Begin
	Select Emp_Name As [Emp_Name],PHONE As [Phone] ,CONVERT(VARCHAR (10),JOINDATE,101) As [JoinDate],
		   emailadd As [EmailAdd],Designation As [Designation],IT_Location As [IT_Location],
		   [Company Name] As [Company_Name],
		 [Status] = CASE [Status] WHEN 'A' THEN 'ACTIVE'
						   ELSE 'DISABLED' 
						END 
	From tbl_ITStaffmaster where [Emp No] = @Emp_Id

End

--else if (@Option = 3)--fill designation ddl
--Begin
--	Select distinct Designation  As [Designation]
--	 From tbl_ITStaffmaster 
--
--End

else if (@Option = 4)--fill IT_Loc (i.e branch) ddl
Begin

	Select distinct Sr_No As [Branch_Code], Br_name As [Branch_Name]
	From Tbl_IT_Br_Master 

End

--else if (@Option = 5)--fill CompanyName (i.e type) ddl
--Begin
--
--	Select distinct [Company Name] As [Company_Name]
--	From tbl_ITStaffMaster 
--
--End

--else if (@Option = 6)--fill Status ddl (WHETHER TO STATUS FROM STATUSMASTER OR FROM STAFFMASTER)
--Begin
--
--	Select distinct [Status] As [Status]
--	From tbl_ITStaffMaster 
--End

else if (@Option = 7)--edit required details
Begin
	Update tbl_ITStaffmaster 
	Set PHONE = @Phone,
		DESIGNATION = @Emailadd,
		IT_Location = @IT_Location,
		Modified_By = @Modified_By ,
		Modified_Datetime = getdate(),
		Modification_Remark = @Modification_Remark
	Where [Emp No] = @Emp_Id

Insert into tbl_ITStaffmaster_Log([Emp No],EMP_NAME,[HOD No],[HOD Name],[Company Name],SBU,Lob,Zone,Region,Location,
								  AttendanceLoc,Department,[Sub Department],Designation,[Location Address],[LEVEL],
								  categorydesc,Costcode,[Join Date],[Separation Date],emailadd,sex,BirthDate,PHONE,
								  JOINDATE,[STATUS],[Address],City,[State],[Account No],pincode,[Functional Head],
								  flgCSOBranch,tpdlgcode,LOBDESC,IT_Location,Modified_By,Modified_Datetime,
								  Modification_Remark)
Select	[Emp No],EMP_NAME,[HOD No],[HOD Name],[Company Name],SBU,Lob,Zone,Region,Location,
		AttendanceLoc,Department,[Sub Department],Designation,[Location Address],[LEVEL],
		categorydesc,Costcode,[Join Date],[Separation Date],emailadd,sex,BirthDate,PHONE,
		JOINDATE,[STATUS],[Address],City,[State],[Account No],pincode,[Functional Head],
		flgCSOBranch,tpdlgcode,LOBDESC,IT_Location,Modified_By,Modified_Datetime,Modification_Remark
From tbl_ITStaffMaster 
Where [Emp No] = @Emp_Id
End

Else if(@Option = 8)--Show the particular Non-IT emp's details
Begin
	If Exists(Select [Emp No] From tbl_ITStaffMaster Where [Emp No] = @Emp_Id)
	Begin
		Select Emp_Name As [Emp_Name],PHONE As [Phone] ,CONVERT(VARCHAR (10),JOINDATE,101) As [JoinDate],
			   emailadd As [EmailAdd],Designation As [Designation],IT_Location As [IT_Location],
			   [Company Name] As [Company_Name],
			 [Status] = CASE [Status] WHEN 'A' THEN 'ACTIVE'
							   ELSE 'DISABLED' 
							END 
		From tbl_ITStaffmaster where [Emp No] = @Emp_Id
	End
	Else
	Select Emp_Name As [Emp_Name],PHONE As [Phone] ,CONVERT(VARCHAR (10),JOINDATE,101) As [JoinDate],
		   emailadd As [EmailAdd],Designation As [Designation],CostCode As [IT_Location],[Company] As [Company_Name],
		 [Status] = CASE [Status] WHEN 'A' THEN 'ACTIVE'
						   ELSE 'DISABLED' 
						END 
	From tbl_IT_UserMaster 
	where Emp_Id = @Emp_Id and Department <> 'IT'
End

Else if (@Option = 9)-- Insert Non IT Empoyees into IT Staff Master
Begin
	Insert into tbl_ITStaffMaster([Emp No],EMP_NAME,[HOD No],[HOD Name],[Company Name],SBU,Lob,Zone,Region,Location,
									  AttendanceLoc,Department,[Sub Department],Designation,[Location Address],[LEVEL],
									  categorydesc,Costcode,[Join Date],[Separation Date],emailadd,sex,BirthDate,PHONE,
									  JOINDATE,[STATUS],[Address],City,[State],[Account No],pincode,[Functional Head],
									  flgCSOBranch,tpdlgcode,LOBDESC,IT_Location,Modified_By,Modified_Datetime,
									  Modification_Remark)
	Select Emp_ID,EMP_NAME,HOD,HOD_Name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,Department,Sub_Department,
			Designation,Location_Address,[LEVEL],categorydesc,Costcode,Join_Date,Separation_Date,emailadd,sex,
			BirthDate,PHONE,JOINDATE,[STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,
			tpdlgcode,LOBDESC,@IT_Location,@Modified_By,getdate(),@Modification_Remark							
	From tbl_IT_UserMaster 
	Where Emp_Id = @Emp_Id

	Insert into tbl_ITStaffMaster_Log([Emp No],EMP_NAME,[HOD No],[HOD Name],[Company Name],SBU,Lob,Zone,Region,Location,
									  AttendanceLoc,Department,[Sub Department],Designation,[Location Address],[LEVEL],
									  categorydesc,Costcode,[Join Date],[Separation Date],emailadd,sex,BirthDate,PHONE,
									  JOINDATE,[STATUS],[Address],City,[State],[Account No],pincode,[Functional Head],
									  flgCSOBranch,tpdlgcode,LOBDESC,IT_Location,Modified_By,Modified_Datetime,
									  Modification_Remark)
	Select [Emp No],EMP_NAME,[HOD No],[HOD Name],[Company Name],SBU,Lob,Zone,Region,Location,
									  AttendanceLoc,Department,[Sub Department],Designation,[Location Address],[LEVEL],
									  categorydesc,Costcode,[Join Date],[Separation Date],emailadd,sex,BirthDate,PHONE,
									  JOINDATE,[STATUS],[Address],City,[State],[Account No],pincode,[Functional Head],
									  flgCSOBranch,tpdlgcode,LOBDESC,IT_Location,Modified_By,Modified_Datetime,
									  Modification_Remark							
	From tbl_ITStaffMaster 
	Where [Emp No] = @Emp_Id



End
Else If(@Option =10)
Begin
    Select distinct[Status]= CASE [Status] WHEN 'A' THEN 'ACTIVE'
						   ELSE 'DISABLED' END 
	From tbl_ITStaffmaster
End

End


--Select * from tbl_ITStaffMaster

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ADDSUBJECT_HELPDESK
-- --------------------------------------------------
CREATE proc USP_ADDSUBJECT_HELPDESK  
(  
@department as int,  
@querytype as varchar(15),  
@subject as varchar(200),  
@mandotary_details as varchar(200)  
)  
as  
insert into tbl_subject values  
(  
@department,  
@querytype,  
@subject,  
@mandotary_details,
'N'  
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Addsubject_opHelpdesk
-- --------------------------------------------------
Create proc USP_Addsubject_opHelpdesk
as
declare @srno as int
set @srno = (SELECT max(srno) FROM tbl_subject)

Select * from v_Addsubject_opHelpdesk where srno = @srno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AOTD
-- --------------------------------------------------
CREATE procedure [dbo].[usp_AOTD]                      
(                      
@Action as varchar(20),                      
@Fld_ComplainNo as varchar(50),               
@Fld_Date as varchar(11),               
@Fld_Connectivity as varchar(50),                
@Fld_CircuitId  as varchar(50),                      
@Fld_Descrip as varchar(100),                      
@Fld_MediumInfo as varchar(50),                      
@Fld_Action as varchar(100),                      
@Fld_Timefrm as varchar(50),                      
@Fld_TimeTo as varchar(50),                      
@Fld_Link_dntime as varchar(50),                      
@Fld_Business_dntime as varchar(50),                      
@Fld_Backup as varchar(50),                      
@Fld_Impact as varchar(50),       
@Fld_Location as varchar(50),   
@Fld_Loc as varchar(50),                      
@Fld_Reason as varchar(100),                      
@Fld_LastUpdate as varchar(300),                      
@Fld_Status as varchar(50),                      
@Fld_DateTime datetime,                    
@Fld_CompletedTime datetime,                  
@Fld_Username as varchar(50),                      
@Fld_Accesscode as varchar(50)                      
)                      
as                      
             
set @Fld_Date=convert(datetime,@Fld_Date,103)            
declare @Cnt as int                      
                      
if @Action='add'                      
begin                      
                      
set @cnt= (Select max(convert(numeric,substring(Fld_ComplainNo,14,len(Fld_ComplainNo)))) from tbl_Aotd)                      
 if @cnt is null                      
  set @Fld_ComplainNo = 'AOTD-'+convert(varchar(11),getdate(),112)+'1'                      
 else                      
  set @Fld_ComplainNo = 'AOTD-'+convert(varchar(11),getdate(),112)+Convert(varchar(5),@Cnt+1)                      
                      
 insert into tbl_Aotd values                      
 (                      
 @Fld_ComplainNo,                
 @Fld_Date,                    
 @Fld_Connectivity,                
 @Fld_CircuitId,                      
 @Fld_Descrip,                      
 @Fld_MediumInfo,                      
 @Fld_Action,                      
 @Fld_Timefrm,                      
 @Fld_TimeTo,                      
 @Fld_Link_dntime,                      
 @Fld_Business_dntime,                      
 @Fld_Backup,                      
 @Fld_Impact,         
 @Fld_Location,  
 @Fld_Loc,                        
 @Fld_Reason,                      
 @Fld_LastUpdate,                      
 @Fld_Status,                      
 @Fld_DateTime,                   
 @Fld_CompletedTime,                  
 @Fld_Username,                      
 @Fld_Accesscode                      
 )                              
end                       
if @Action='edit'                      
begin                      
 update tbl_Aotd set      
 --Fld_Date = Convert(Varchar(12),GETDATE(),109),                 
 Fld_Connectivity=@Fld_Connectivity,                
 Fld_CircuitId=@Fld_CircuitId,                      
 Fld_Descrip=@Fld_Descrip,                      
 Fld_MediumInfo=@Fld_MediumInfo,                      
 Fld_Action=@Fld_Action,                      
 Fld_Timefrm=@Fld_Timefrm,                      
 Fld_TimeTo=@Fld_TimeTo,                      
 Fld_Link_dntime=@Fld_Link_dntime,                      
 Fld_Business_dntime=@Fld_Business_dntime,                      
 Fld_Backup=@Fld_Backup,                      
 Fld_Impact=@Fld_Impact,                      
 Fld_Location=@Fld_Location,    
 Fld_Loc = @Fld_Loc,                     
 Fld_Reason=@Fld_Reason,                      
 Fld_LastUpdate=@Fld_LastUpdate,                      
 Fld_Status=@Fld_Status,                      
 --Fld_DateTime=@Fld_DateTime,                      
 Fld_CompletedTime=@Fld_CompletedTime                  
 --Fld_Username=@Fld_Username,                      
 --Fld_Accesscode=@Fld_Accesscode         
where Fld_ComplainNo=@Fld_ComplainNo                      
end                      
                      
select  Fld_ComplainNo from tbl_Aotd where Fld_ComplainNo=@Fld_ComplainNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AOTD_Rpt
-- --------------------------------------------------
CREATE Proc [dbo].[USP_AOTD_Rpt]--USP_AOTD_Rpt '16/8/2012','16/8/2012','all'                                       
(                                            
@fdate as varchar(45),                                            
@tdate as varchar(45),                                            
@status as varchar(45)                                            
)                                            
as                                            
                         
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                            
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                             
                                          
--set @fdate = convert(datetime,@fdate,103)                                            
--set @tdate = convert(datetime,@tdate,103) + ' 23:59:59'                                            
                                            
select *,                                  
case when fld_business_dntime!='0 MIN' or fld_business_dntime!='0 Min' then '<font color="red">'+fld_business_dntime+'</font>'       
else fld_business_dntime end as fld_business_dntimeRed                                  
into #t from v_aotd_rpt where convert(varchar(45),Fld_Date,103) >= @fdate and                                             
convert(varchar(45),Fld_Date,103) <= @tdate and Fld_Status like REPLACE(@status,'ALL','%')                
                
select distinct a.*,b.category as issue_area from #t a                
inner join                
(select * from it_category1(nolock)) b                
on a.flD_Connectivity = b.srno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AOTD_Rpt1
-- --------------------------------------------------
       
CREATE Proc [dbo].[USP_AOTD_Rpt1]                      
(               
@tdate as varchar(45),                         
@status as varchar(45)                      
)                      
as                             
--set @tdate = convert(varchar(45),convert(datetime,@tdate,103)) + ' 23:59:59'   
  
set @tdate = convert(varchar(45),@tdate)                    
                    
select *,            
case when fld_business_dntime!='0 MIN' or fld_business_dntime!='0 Min'   
then '<font color="red">'+fld_business_dntime+'</font>' else fld_business_dntime end as fld_business_dntimeRed   
--from v_aotd_rpt where convert(datetime,Fld_Date) <= convert(datetime , @tdate) and Fld_Status like @status       
           
from v_aotd_rpt where convert(varchar(45),Fld_Date) <= @tdate and Fld_Status like @status   
  
  
--select * from v_aotd_rpt  
--where  convert(varchar(45),Fld_Date) >='Aug 16 2012' and  convert(varchar(45),Fld_Date)<='Aug 16 2012'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Asset
-- --------------------------------------------------
CREATE proc USP_Asset  
(  
  @AssetName varchar(30),
  @AssetType varchar(20) 
)  
as  
insert into tbl_IT_Assetmaster values(@AssetName,@AssetType)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ASSET_REPORT
-- --------------------------------------------------
CREATE proc USP_ASSET_REPORT          
(          
@requesttype varchar(25),          
@Fld_AssetTag varchar(25)          
)          
as          
declare @str  varchar(6000)                
        
/*          
set @str='select * from                      
(                      
Select x.*,brcode=y.Fld_BranchCode,y.department,z.*  from                       
(select '''' as Fld_PurchaseOrderNo, * from tbl_itassetsdata (nolock) where fld_AssetName like '''+@requesttype+'''                       
and Fld_AssetTag like '''+@Fld_AssetTag+''')x                       
left outer join                       
(select distinct Fld_RequestId,Fld_RequestBy,Fld_BranchCode,department from tbl_itrequestmaster (nolock) where fld_status<>''PO'')y                       
on x.Fld_Requestid=y.Fld_Requestid                       
left outer join                       
(select [Emp No], emp_name, attendanceloc from hrsoft.angelbroking.dbo.vlms with (nolock))z                       
on y.Fld_RequestBy=z.[Emp No])a where brcode is not null'                   
*/          
        
set @str='select * from (Select distinct x.*,brcode=y.Fld_BranchCode,y.department,z.*         
from (select '''' as Fld_PurchaseOrderNo, * from tbl_itassetsdata (nolock)         
where (Fld_AssetTag like ''HO%''or Fld_AssetTag like ''AKRUTI%'') and fld_AssetName like '''+@requesttype+'''         
and fld_status = ''S'')x left outer join         
(select Fld_RequestId,Fld_RequestBy,Fld_BranchCode,department from tbl_itrequestmaster (nolock))y         
on x.Fld_Requestid=y.Fld_Requestid left outer join (select [Emp No], emp_name, attendanceloc from       
[MIDDLEWARE].harmony.dbo.vlmsinhouse with (nolock))z on y.Fld_RequestBy=z.[Emp No])a'          
--print @str                          
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AutoAssetTag
-- --------------------------------------------------

CREATE proc USP_AutoAssetTag(@Fld_RequestId int,@Fld_AssetName varchar(50))  
as  
declare @Fld_UniqueID as varchar(50)    
declare @Fld_BranchCode varchar(15) 

set @Fld_BranchCode = (select Distinct Fld_BranchCode from tbl_itRequestMaster(nolock) where Fld_RequestId = @Fld_RequestId ) 
if (Select isnull(count(Fld_AssetTag),0) from tbl_ITAssetsData where Fld_Branchcode = @Fld_BranchCode and Fld_Assetname = @Fld_AssetName)>0  
 begin    
 set @Fld_UniqueID = @Fld_BranchCode +'-'+ @Fld_AssetName +':'+  
 (select  convert(varchar,max(substring(Fld_AssetTag,charindex(':',Fld_AssetTag)+1,100))+1) 
from tbl_ITAssetsData where Fld_Branchcode = @Fld_BranchCode and Fld_Assetname = @Fld_AssetName)  
 end    
 else    
 begin    
 set @Fld_UniqueID = @Fld_BranchCode +'-'+ @Fld_AssetName +':'+ '1'    
 End    
--print @Fld_UniqueID  
  
update tbl_ITAssetsData set Fld_AssetTag = @Fld_UniqueID,Fld_Status = '' where Fld_Status = 'X'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AutoMail
-- --------------------------------------------------
CREATE proc usp_AutoMail(@PTo as varchar(5000),                                    
@PFROM as varchar(5000),@Psubject as varchar(5000),@msg as varchar(5000),@brcode as varchar(5000))                                                                                  
as                                                                                    
--EXEC master..xp_smtp_sendmail                                                                                     
--    @TO = @PTO,                                                                                  
--    @from = @Pfrom,                                                                                  
--    @cc = 'ITBranchsupport@angeltrade.com',                                                                              
--   -- @bcc = 'mangesh.wangane@angelbroking.com',                                                                                  
--    @subject = @Psubject,                                                                                
--    @message = @msg,                                                                                     
--    @type = 'text/html',                                                                                               
--    @server = 'angelmail.angelbroking.com'                                  
                                  
exec MIS.msdb.dbo.sp_send_dbmail                                                                                                             
--@recipients  = 'sanjay.patel@angeltrade.com',                                                                                                                 
@recipients  = @PTo,--@email,                  
--@copy_recipients ='megha.wangane@angeltrade.com;sanjay.patel@angeltrade.com',           
@copy_recipients ='IThelpdeskakruti@angelbroking.com',                                                         
                                                      
@profile_name =@PFROM,                                
--@profile_name = @Pfrom,                                                                                                   
@subject = @Psubject,                                                                                                 
@body_format = 'html',                                                                                      
@body =@msg         
        
        
        
                                   
----exec MIS.msdb.dbo.sp_send_dbmail                                                                                                             
------@recipients  = 'sanjay.patel@angeltrade.com',                                                                                                                 
----@recipients  = 'Amol.Jadiyar@angelbroking.com;Amarish.Hirap@angelbroking.com;Sujnendra.Shetty@angelbroking.com' ,                 
------@copy_recipients ='megha.wangane@angeltrade.com;sanjay.patel@angeltrade.com',           
----@copy_recipients ='IThelpdeskakruti@angelbroking.com',                                                         
                                                      
--@profile_name =@PFROM,                                
----@profile_name = @Pfrom,                                                                                                   
--@subject = @Psubject,                                                                                                 
--@body_format = 'html',                                                                                      
--@body =@msg    
       
insert into tbl_IT_Jobs_Log_Detail values(@brcode,@pfrom,@pto,@psubject,@msg,'UPS Mails',getdate())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_AUTOMAIL_DATABASE_SHRINK _REPORT
-- --------------------------------------------------
--DROP TABLE #Y
--DROP TABLE #X

CREATE PROCEDURE [dbo].[USP_AUTOMAIL_DATABASE_SHRINK _REPORT]                
AS
BEGIN
DECLARE @EMP_NAME AS VARCHAR(100),@EMP_EMAIL AS VARCHAR(100)                
DECLARE @EMAILTO AS VARCHAR(1000),@EMAILCC AS VARCHAR(1000),@EMAILBCC AS VARCHAR(1000),@SUB AS VARCHAR(MAX),@MESS NVARCHAR(MAX)                            
   -- SELECT @EMAILTO='ATUL.SASHITTAL@ANGELBROKING.COM'
     SELECT @EMAILTO='sandeep.rai@angelbroking.com;PRASHANT.PATADE@ANGELBROKING.COM'
    --SELECT @EMAILCC='ITHELPDESKAKRUTI@ANGELBROKING.COM;ODINADMIN@ANGELBROKING.COM'
   -- SELECT @EMAILBCC='SANDEEP.RAI@ANGELBROKING.COM;PRASHANT.PATADE@ANGELBROKING.COM'
    
    /*DHOKA */
  
  --if(DATENAME(DW, GETDATE())= 'Monday')
  --begin
       
  DECLARE @COUNT INT,@DATA1 NVARCHAR(MAX),@MESS1 NVARCHAR(MAX),@COUNTEND INT,@SERVER AS VARCHAR(50), 
		  @FLD_SERVER_ID AS VARCHAR(50),@MDF_LDF AS VARCHAR(50),@MDF_BQ AS VARCHAR(50),@MDF_AQ AS VARCHAR(50),
		  @FLD_MDF_COD AS VARCHAR(50),@FLD_MDF_FS AS VARCHAR(50),@FLD_MDF_AQ AS VARCHAR(50),@FLD_MDF_BQ AS VARCHAR(500),@FLD_MDF_DD AS VARCHAR(50),
		  @FLD_LDF_COD AS VARCHAR(50),@FLD_LDF_FS AS VARCHAR(50),@FLD_LDF_AQ AS VARCHAR(50),@FLD_LDF_BQ AS VARCHAR(50),
		  @FLD_ODIN_IP AS VARCHAR(50),@FLD_DB_LP AS VARCHAR(50),
		  @FLD_REMARK AS VARCHAR(50),@FLD_UPD_BY AS VARCHAR(50), @CNT INT,
		  @MESSBODY NVARCHAR(MAX),@MESS2 NVARCHAR(MAX),@XML NVARCHAR(MAX),@DATA NVARCHAR(MAX) ,  @TOTCTROT AS INT=0
 
		SET @DATA=''                
		SET @MESSBODY=''                          
		SET @MESS2=''          
		SET @COUNT=1   
		SET @CNT=1  
		
	SELECT DISTINCT FLD_SERVER_ID  
    INTO  #X
    FROM TBL_DB_SHRINK_DATA_NEW (NOLOCK)
    WHERE  FLD_UPD_DATE = DATEADD(d,DATEDIFF(d,0,getdate()),-9)  AND  FLD_SERVER_ID NOT IN ('37')
    
    --WHERE  FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000')  AND  FLD_SERVER_ID NOT IN ('37')
   
    --SELECT DATEADD(d,DATEDIFF(d,0,getdate()),-2)
    ALTER table #X
    add RecID int Identity(1,1)
    
    declare @cntServer int,@CntServerCount int,@ServerID varchar(10),@cntServerBody int,@cntServerBodyCount int
    
    set @CntServerCount=1
    set @cntServer=(select count(*) from #x)
    set @MESS2='<TABLE BORDER="1">                            
	   <TR>                       
			   <TH> SERVER </TH>              
			   <TH> ODIN IP</TH>                            
			   <TH> DATABASE IP </TH>                            
			   <TH> DATABASE</TH>    
			   <TH> BEFORE QUERY (GB)</TH>  
			   <TH>AFTER QUERY (GB)</TH> 
			   <TH>DISK DRIVE</TH>
			   <TH>CAPICITY OF DRIVE (GB)</TH>
			   <TH>FREE SPACE (GB)</TH>
			   <TH>REMARK</TH>     
			   <TH>ENTRY BY</TH>                         
		</TR>'  
    
    while(@CntServerCount<=@cntServer)
    Begin
    set @ServerId=(select Fld_Server_id from #x where RecId=@CntServerCount)
    set @cntServerBody=1
    
    truncate table TempServerDate
    
    insert into TempServerDate 
    
      SELECT ROW_NUMBER()OVER (ORDER BY FLD_BRANCH_ID) AS SRNO,*  
     FROM                                            
	 (  
     SELECT 'INTEGRATED ODIN(.MDF)' AS MDF_LDF,                                                                                                               
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_MDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERMDF,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_AQ,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_BQ,                                                                                                              
	FLD_MDF_COD,FLD_MDF_BQ,FLD_MDF_AQ,FLD_MDF_DD,FLD_MDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,                                                        
	FLD_REMARK,FLD_UPD_BY FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK) 
    WHERE FLD_SERVER_ID IN (@ServerId) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID NOT IN ('37')  --@FLD_FDATE
    UNION                                            
	SELECT 'TRANSACTION LOG SPACE(.LDF)',                                                        
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_LDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERLDF,                              
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_AQ,                                 
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_BQ,                                                        
	FLD_LDF_COD,FLD_LDF_BQ,FLD_LDF_AQ,FLD_LDF_DD,FLD_LDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,FLD_REMARK,FLD_UPD_BY  FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK)
	 WHERE FLD_SERVER_ID IN (@ServerId) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID NOT IN ('37')  
     )A                                         
	LEFT OUTER JOIN                                            
	(SELECT FLD_ID,FLD_SERVER,FLD_DB_IP,FLD_ODIN_IP FROM V_TBL_SERVER_MASTER(NOLOCK)) B                                                           
	ON A.FLD_SERVER_ID = B.FLD_ID                                                        
	LEFT OUTER JOIN                                                        
	(SELECT PERSON_NAME AS EMP_NAME,USERNAME  FROM INTRANET.RISK.DBO.USER_LOGIN)C                                                        
	ON A.FLD_UPD_BY = C.USERNAME                                               
	LEFT OUTER JOIN                                            
	(SELECT BR_TAG,BR_NAME FROM TBL_IT_BR_MASTER (NOLOCK)  WHERE BR_TYPE = 'DATACENTER' )D                                            
	ON A.FLD_BRANCH_ID = D.BR_TAG                                            
	ORDER BY FLD_BRANCH_ID   
    
    set @cntServerBodyCount=(select count(*) from TempServerDate)
    
     IF(@cntServer=0)
     BEGIN 
	 print 'hhh'
		 SET @MESS2='<B>NOTE:Report has not been updated by Odin Team or Ghatkopar Team.</B><BR><BR>'
		 SET @MESS2=@MESS2+'HAVE A NICE DAY AHEAD.'
		 SET @SUB ='Database shrink report' + CONVERT(VARCHAR(MAX),GETDATE())
     END
     ELSE
     BEGIN
   
                               
	   
     SET @DATA=''
     
				 WHILE @cntServerBody <= @cntServerBodyCount                              
				 BEGIN
				 --PRINT @CNT
				 SELECT @SERVER=FLD_SERVER,@FLD_MDF_COD=FLD_MDF_COD,@FLD_MDF_BQ=FLD_MDF_BQ,@FLD_MDF_AQ=FLD_MDF_AQ,@FLD_MDF_FS=FLD_MDF_FS,@FLD_MDF_DD=FLD_MDF_DD,
						@MDF_LDF=MDF_LDF,@MDF_BQ=MDF_BQ,@MDF_AQ=MDF_AQ,
						@FLD_ODIN_IP=FLD_ODIN_IP,@FLD_DB_LP=FLD_DB_IP,@FLD_REMARK=FLD_REMARK,@FLD_UPD_BY=EMP_NAME
				 FROM TempServerDate 
				 WHERE SRNO=@cntServerBody    
			                                
			     --SET @DATA=@DATA                           
					if(@cntServerBody=1)
					Begin
					SET @DATA=@DATA+'<TR>                          
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@SERVER) +' </TD>                         
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_ODIN_IP) +' </TD>                          
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_DB_LP) +' </TD>                          
						 <TD> '+ CONVERT(VARCHAR,@MDF_LDF) +' </TD>                          
						 <TD> '+ CONVERT(VARCHAR,@MDF_BQ) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@MDF_AQ) +' </TD> 
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_DD) +' </TD> 
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_COD) +' </TD> 
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_FS) +' </TD> 
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_REMARK) +' </TD> 
						 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_UPD_BY) +' </TD>
					</TR>
					  '  
					 End          
					 Else
					 Begin
					 SET @DATA=@DATA+' <TR> <TD> '+ CONVERT(VARCHAR,@MDF_LDF) +' </TD>                          
						 <TD> '+ CONVERT(VARCHAR,@MDF_BQ) +' </TD> 
						 <TD> '+ CONVERT(VARCHAR,@MDF_AQ) +' </TD> </TR>'
					 End

				  SET   @cntServerBody=@cntServerBody+1 
				 
				  END--end of while
				 
			SET @MESS2=@MESS2 + @DATA  
			
  --print @MESS2
  END
 
    
    
    
    
    set @CntServerCount=@CntServerCount+1
    End
   SET @MESS2='<BR><B>DAKC </B> <BR><BR>'+ @MESS2   
    set @MESS2=@MESS2+'</TABLE>'
  print @MESS2
  SET @SUB ='Database shrink report AS ON ' + CONVERT(VARCHAR(MAX),GETDATE())
    
    --while 
    
    --SELECT @COUNT=COUNT(*) FROM #Y --where FLD_Server='DAKC DIET CLIENT (48)'
    --SELECT @TOTCTROT=COUNT(1) FROM #Y
    
    
-- End 
/*GHATKOPAR (E)*/
	 
	  DECLARE @COUNT1 INT,@DATE1 AS VARCHAR(20),@TOTCTROT1 AS INT=0  ,@SERVER_1 AS VARCHAR(20), 
			  @FLD_SERVER_ID_1 AS VARCHAR(50),@MDF_LDF_1 AS VARCHAR(50),@MDF_BQ_1 AS VARCHAR(50),@MDF_AQ_1 AS VARCHAR(50),
			  @FLD_MDF_COD_1 AS VARCHAR(50),@FLD_MDF_FS_1 AS VARCHAR(50),@FLD_MDF_AQ_1 AS VARCHAR(50),@FLD_MDF_BQ_1 AS VARCHAR(500),@FLD_MDF_DD_1 AS VARCHAR(50),
			  @FLD_LDF_COD_1 AS VARCHAR(50),@FLD_LDF_FS_1 AS VARCHAR(50),@FLD_LDF_AQ_1 AS VARCHAR(50),@FLD_LDF_BQ_1 AS VARCHAR(50),
			  @FLD_ODIN_IP_1 AS VARCHAR(50),@FLD_DB_LP_1 AS VARCHAR(50),
			  @FLD_REMARK_1 AS VARCHAR(50),@FLD_UPD_BY_1 AS VARCHAR(50), @CNT1 INT,
			  @LDF_DB_1 AS VARCHAR(50),@LDF_BQ_1 AS VARCHAR(50),@LDF_AQ_1 AS VARCHAR(50)
			  
	   DECLARE @MESSBODY1 NVARCHAR(MAX)    
	           
		SET @DATA1=''                
		SET @MESSBODY1=''                          
		SET @MESS1=''          
		SET @COUNT1=1 
		SET @CNT1=1                                   
		
       SELECT DISTINCT FLD_SERVER_ID  
       INTO  #xx 
       FROM TBL_DB_SHRINK_DATA_NEW (NOLOCK)
       WHERE  FLD_UPD_DATE =  DATEADD(d,DATEDIFF(d,0,getdate()),-9)  AND  FLD_SERVER_ID  IN ('37')
       
      
    SELECT  ROW_NUMBER()OVER (ORDER BY FLD_BRANCH_ID) AS SRNO,* INTO  #yy 
    FROM                                            
	(  
     SELECT 'INTEGRATED ODIN(.MDF)' AS MDF_LDF,                                                                                                               
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_MDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERMDF,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_AQ,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_MDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS MDF_BQ,                                                                                                              
	FLD_MDF_COD,FLD_MDF_BQ,FLD_MDF_AQ,FLD_MDF_DD,FLD_MDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,                                                        
	FLD_REMARK,FLD_UPD_BY FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK) 
    WHERE FLD_SERVER_ID IN (SELECT * FROM #XX) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID  IN ('37')  --@FLD_FDATE
    UNION                                            
	SELECT 'TRANSACTION LOG SPACE(.LDF)',                                                        
	(CONVERT(FLOAT,ISNULL(REPLACE(REPLACE(REPLACE(FLD_LDF_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 AS PERLDF,                              
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_FS,                                                        
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_AQ,                                 
	ISNULL(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(FLD_LDF_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) AS LDF_BQ,                                                        
	FLD_LDF_COD,FLD_LDF_BQ,FLD_LDF_AQ,FLD_LDF_DD,FLD_LDF_FS,FLD_SERVER_ID,FLD_BRANCH_ID,FLD_REMARK,FLD_UPD_BY  FROM TBL_DB_SHRINK_DATA_NEW(NOLOCK)
	 WHERE FLD_SERVER_ID IN (SELECT * FROM #XX) AND FLD_UPD_DATE = CONVERT(DATETIME,'2016-09-03 00:00:00.000') AND  FLD_SERVER_ID  IN ('37')  
     )A  
                                                
	LEFT OUTER JOIN                                            
	(SELECT FLD_ID,FLD_SERVER,FLD_DB_IP,FLD_ODIN_IP FROM V_TBL_SERVER_MASTER(NOLOCK)) B                                                           
	ON A.FLD_SERVER_ID = B.FLD_ID                                                        
	LEFT OUTER JOIN                                                        
	(SELECT PERSON_NAME AS EMP_NAME,USERNAME  FROM INTRANET.RISK.DBO.USER_LOGIN)C                                                        
	ON A.FLD_UPD_BY = C.USERNAME                                               
	LEFT OUTER JOIN                                            
	(SELECT BR_TAG,BR_NAME FROM TBL_IT_BR_MASTER (NOLOCK)  WHERE BR_TYPE = 'DATACENTER' )D                                            
	ON A.FLD_BRANCH_ID = D.BR_TAG                                            
	ORDER BY FLD_BRANCH_ID
	
	
--	select   distinct  x.*,y.br_name as Branches,                                          
--case when x.Fld_Server like '%)' then substring(x.Fld_Server,0,charindex('(',x.Fld_Server)-1)       
--else x.Fld_Server end as Serv,      
--convert(numeric,case when x.Fld_Server like '%)' then substring(x.Fld_Server,charindex('(',x.Fld_Server)+1,                                           
--charindex(')',Convert(varchar,x.Fld_Server))-(charindex('(',Convert(varchar,x.Fld_Server))+1)) else 0 end) as Num,                            
--case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ Convert(varchar,x.fld_mdf_cod) + '</font>' else Convert(varchar,x.fld_mdf_cod) end as fld_mdf_cod,      
--case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ convert(varchar,x.fld_mdf_fs)+'</font>' else Convert(varchar,x.fld_mdf_fs) end as fld_mdf_fs,      
------case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_BQ+'</font>' else x.Fld_Mdf_BQ end as fld_m_BQ--,                            
--case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_BQ)+'</font>' else Convert(varchar,x.Fld_Mdf_BQ) end as fld_m_BQ,        
----case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_AQ+'</font>' else x.Fld_Mdf_AQ end as fld_m_AQ         
--case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_AQ)+'</font>' else Convert(varchar,x.Fld_Mdf_AQ) end as fld_m_AQ         
--from      
--(select * from #yy)x                                            
--left outer join                                            
--(select * from #yy where Fld_Remark <> '')y                                            
--on x.Fld_Branch_id = y.Fld_branch_Id                                            
---- and x.Fld_server_id = y.Fld_server_id and x.mdf_ldf = y.mdf_ldf                                            
--order by Serv,Num,x.Fld_id 
	
    END
  
    SELECT  @COUNT1=COUNT(*) FROM #yy
    SELECT  @TOTCTROT1=COUNT(1) FROM #xx     
     
     IF(@COUNT1=0)
     BEGIN 
     SET @MESS1='<B>NOTE:Report has not been updated by Odin Team or Ghatkopar Team.</B><BR><BR>'
     SET @MESS1=@MESS1+'HAVE A NICE DAY AHEAD.'
     SET @SUB ='Database shrink report' + CONVERT(VARCHAR(MAX),GETDATE())
     END
    ELSE
    BEGIN     
   SET @MESS1=                            
		   '<TABLE BORDER="1">                            
		   <TR>                       
		   <TH> SERVER </TH>              
		   <TH> ODIN IP</TH>                            
		   <TH> DATABASE IP </TH>                            
		   <TH> DATABASE</TH>    
		   <TH> BEFORE QUERY (GB)</TH>  
		   <TH>AFTER QUERY (GB)</TH> 
		   <TH>DISK DRIVE</TH>
		   <TH>CAPICITY OF DRIVE (GB)</TH>
		   <TH>FREE SPACE (GB)</TH>
		   <TH>REMARK</TH>     
		   <TH>ENTRY BY</TH>                         
		   </TR>'
		      
     SET @DATA1=''
     WHILE @CNT1 <= @TOTCTROT1                              
     BEGIN
     PRINT @CNT1 
     --chnage here
		 SELECT @SERVER_1=FLD_SERVER,@FLD_MDF_COD_1=FLD_MDF_COD,@FLD_MDF_BQ_1=FLD_MDF_BQ,@FLD_MDF_AQ_1=FLD_MDF_AQ,
      @FLD_MDF_FS_1=FLD_MDF_FS,@FLD_MDF_DD_1=FLD_MDF_DD,
      @MDF_LDF_1=MDF_LDF,@MDF_BQ_1=MDF_BQ,@MDF_AQ_1=MDF_AQ,
      @FLD_ODIN_IP_1=FLD_ODIN_IP,@FLD_DB_LP_1=FLD_DB_IP,@FLD_REMARK_1=FLD_REMARK,@FLD_UPD_BY_1=EMP_NAME
		  FROM #yy 
		  WHERE SRNO=1
		  
		 SELECT @LDF_DB_1=MDF_LDF,@LDF_BQ_1=MDF_BQ,@LDF_AQ_1=MDF_AQ
		 FROM #yy 
		  WHERE SRNO=2
		  
		  select a.srno from #yy a , #yy b
		  where a.fld_Server=b.fld_server
		
				 SET @DATA1=@DATA1+                                                   
				 '<TR>                          
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@SERVER_1) +' </TD>                         
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_ODIN_IP_1) +' </TD>                          
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_DB_LP_1) +' </TD>                          
					 <TD> '+ CONVERT(VARCHAR,@MDF_LDF_1) +' </TD>                          
					 <TD> '+ CONVERT(VARCHAR,@MDF_BQ_1) +' </TD> 
					 <TD> '+ CONVERT(VARCHAR,@MDF_AQ_1) +' </TD> 
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_DD_1) +' </TD> 
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_COD_1) +' </TD> 
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_MDF_FS_1) +' </TD> 
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_REMARK_1) +' </TD> 
					 <TD rowspan="2"> '+ CONVERT(VARCHAR,@FLD_UPD_BY_1) +' </TD> 
				 </TR>
					  <TR>
						<TD> '+ CONVERT(VARCHAR,@LDF_DB_1) +' </TD>                          
						<TD> '+ CONVERT(VARCHAR,@LDF_BQ_1) +' </TD> 
					    <TD> '+ CONVERT(VARCHAR,@LDF_AQ_1) +' </TD> 
			     </TR>'            
				  PRINT @DATA1                
				  SET   @CNT1=@CNT1+1    
				                                 
				 END 

		SET @MESS1='<BR><B> GHATKOPAR (E)</B> <BR><BR>'+ @MESS1 + @DATA1+'</TABLE>'
  
		SET @MESS='DEAR SIR,<BR><BR>GOOD EVENING!!!<BR><BR>Below is the details of Database Shrink weekly report<BR><BR>' + @MESS2 +  '<BR>'+@MESS1+'<BR>'
		SET @MESS=@MESS+'<BR><BR>THIS IS A SYSTEM GENERATED MESSAGE. PLEASE DO NOT REPLY.<BR><BR>REGARDS,<BR><BR>(IT HELPDESK)'                              
		SET @SUB ='Database shrink report AS ON ' + CONVERT(VARCHAR(MAX),GETDATE())

 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
 @RECIPIENTS =@EMAILTO,                              
 @COPY_RECIPIENTS = @EMAILCC,                              
 @BLIND_COPY_RECIPIENTS=@EMAILBCC,                    
 @PROFILE_NAME = 'ANGELBROKING',                              
 @BODY_FORMAT ='HTML',                              
 @SUBJECT = @SUB ,                              
 @BODY =@MESS 
  
 END
-- End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Automail_Inventory_Report
-- --------------------------------------------------



CREATE Procedure [dbo].[USP_Automail_Inventory_Report]                
as
Begin
DECLARE @Emp_name as varchar(100),@emp_email as varchar(100),@cnt int                 
DECLARE @emailto as varchar(1000),@emailcc as varchar(1000),@emailbcc as varchar(1000),@sub as varchar(max),@MESS NVARCHAR(MAX)                            
   
   SELECT @emailto='sandeep.rai@angelbroking.com;PRASHANT.PATADE@ANGELBROKING.COM'
    
   DECLARE @COUNT INT,@DATA1 NVARCHAR(MAX),@MESS1 NVARCHAR(MAX),@COUNTEND INT,@SERVER AS VARCHAR(50), 
		  @Branch as varchar(500),@Br_Type1 as varchar(50),@desktops as varchar(50),@desktop_server as varchar(50),
		  @brandes_server as varchar(50),@laptops as varchar(50),@Remark as varchar(50),@Update_On as varchar(50),
		  @date as varchar(50),@person_name as  varchar(50),@Total as varchar(50)
		 
             
	  DECLARE @MessBody NVARCHAR(MAX),@MESS2 NVARCHAR(MAX)            
	  DECLARE @xml NVARCHAR(MAX)              
	  DECLARE @Data NVARCHAR(MAX) ,  @totctrOT as int=0  
   
		set @cnt=1  
		set @Data=''                
		set @MessBody=''                          
		set @MESS2=''          
		set @Count=1                                    
      declare @month as varchar(20)
      set @month= DATENAME(month, GETDATE()) --convert(char(3), GETDATE(), 0) 
      print @month
      
      declare @year as varchar(10)
      set @year=YEAR(getdate())
      print @year
       
     Declare @fromdate as varchar(11),@todate as varchar(11)            
	set @fromdate = DATEADD(ss, 1, DATEADD(month, DATEDIFF(month, 0, getdate()), 0))            
	set @fromdate = left(@fromdate,4)+'01'+right(@fromdate,5)            
	print @fromdate         
	        
	set @todate = DATEADD(ss, 1, DATEADD(month, DATEDIFF(month, 0, getdate()), 0))            
	set @todate = left(@todate,4)+'14'+right(@todate,5)                   
	print @todate 
     
    select ROW_NUMBER()OVER (ORDER BY month) AS SRNO,upper(br_name+'-('+br_tag+')') as Branch , Br_Type ,desktops,desktop_server,                    
    branded_server,laptops,                     
    Total=convert(int,desktops)+convert(int,desktop_server)+convert(int,branded_server)+convert(int,laptops),
    --Total=  desktops+  branded_server+ laptops  ,            
    Remark,convert(varchar(11),UpdatedOn,103) as [Update On],month+'-'+year as date,person_name
    into  #y
    from V_IT_Inventory_Rpt (nolock) where year=@year and month like @month and
	 enteredon>=replace(CONVERT(VARCHAR(12),convert(datetime,@fromdate,103),106), '/', ' ')+' 00:00:00' and 
    enteredon <=replace(CONVERT(VARCHAR(12),convert(datetime,@todate,103),106), '/', ' ')+' 23:59:59'              
    order by V_IT_Inventory_Rpt.Br_Type 
    
    --where br_id in (select Sr_No from #t) --and Br_Type like @Br_Type    
    --and year=@year and month like @month order by V_IT_Inventory_Rpt.Br_Type  
  
  print 'hii'
     
    select   @Count=count(*) from #y
    print @Count
     SELECT @totctrOT=count(1) from #y          
  print @totctrOT
   
print @MESS  
    if(@Count=0)
    Begin 
    print 'hi'
     set @MESS2='<b>Note: Inventory report as on December-2015 has been attached for all region and branches.</b><br><br>'
       set @MESS2=@MESS2+'Have a nice day ahead.'
     set @sub ='Inventory Report as on December-2015.' --+ Convert(varchar(max),GETDATE())

    print @MESS
   --SET @MESS2='<Br><B>Equity</B> <Br><Br>'+ @MESS2 + @Data +'</Table>' 
    End
    else
    begin
     SET @MESS2=                            
   '<Table border="1">                            
   <tr>                       
				<TH> Date</TH>              
			   <TH> Branch</TH>                            
			   <TH>Branch Type</TH>                            
			   <TH> DESKTOPS</TH>    
			   <TH> DESKTOP SERVERS</TH>  
			   <TH>BRANDED SERVERS</TH> 
			   <TH>LAPTOPS</TH>
			   <TH>TOTAL</TH>
			   <TH>REMARK</TH>
			   <TH>	ENTRY BY)</TH>                               
   </tr>'  
   set @Data=''
     WHILE @cnt <= @totctrOT                              
     BEGIN
     print @cnt
    SELECT @Branch=Branch,@Br_Type1=Br_Type,@desktops=desktops,@desktop_server=desktop_server,@brandes_server=branded_server,
				        @laptops=laptops,@Remark=Remark,@date=date,@person_name=person_name,@Total=Total
				 FROM #Y 
				 WHERE srno=@CNT
     
                    
	  
      set @Data=@Data+                           
     '<tr>                          
		 <TD> '+ CONVERT(VARCHAR,@date) +' </TD>
		 <TD> '+ CONVERT(VARCHAR,@Branch) +' </TD>                         
         <TD> '+ CONVERT(VARCHAR,@Br_Type1) +' </TD> 
         <TD> '+ CONVERT(VARCHAR,@desktops) +' </TD>                          
		 <TD> '+ CONVERT(VARCHAR,@desktop_server) +' </TD>                          
		 <TD> '+ CONVERT(VARCHAR,@brandes_server) +' </TD> 
		 <TD> '+ CONVERT(VARCHAR,@laptops) +' </TD> 
		 <TD> '+ CONVERT(VARCHAR,@Total) +' </TD> 
		 <TD> '+ CONVERT(VARCHAR,@Remark) +' </TD>
		 <TD> '+ CONVERT(VARCHAR,@person_name) +' </TD> 
       </tr>'           
      print @Data  
        
      SET   @cnt=@cnt+1 
     
                                   
    END
    --print @Data
    SET @MESS2='<Br><Br>'+ @MESS2 + @Data +'</Table>'                       
 
  set @sub ='Inventory Report as on December-2015.' --+ Convert(varchar(max),GETDATE())
    
   
    End
    
   
SET @MESS='Dear Sir,<br><Br>Greetings of the day!<Br><Br><Br>Inventory report as on December-2015 has been attached for all region and branches.</Br><br></br>' + @MESS2 +  '<Br><Br>'
SET @MESS=@MESS+'<BR><BR>This is a System generated Message. Please do not Reply.<BR><BR>Regards,<br><Br>(IT helpdesk)'                              


 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                              
 @RECIPIENTS =@emailto,                              
 @COPY_RECIPIENTS = @emailcc,                              
 @blind_copy_recipients=@emailbcc,                    
 @PROFILE_NAME = 'AngelBroking',                              
 @BODY_FORMAT ='HTML',                              
 @SUBJECT = @sub ,                              
 --@FILE_ATTACHMENTS =@s,                              
 @BODY =@MESS 
 
 
 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_AutoMail_TCP
-- --------------------------------------------------
--sp_helptext usp_AutoMail_TCP    
CREATE proc usp_AutoMail_TCP(@PTo as varchar(500),                                    
@PFROM as varchar(500),@Psubject as varchar(500),@msg as varchar(5000),@brcode as varchar(50))                                                                                  
as                                                                                    
--EXEC master..xp_smtp_sendmail                                                                                     
--    @TO = @PTO,                                                                                  
--    @from = @Pfrom,                                                                                  
--    @cc = 'ITBranchsupport@angeltrade.com',                                                                              
--   -- @bcc = 'mangesh.wangane@angelbroking.com',                                                                                  
--    @subject = @Psubject,                                                                                
--    @message = @msg,                                                                                     
--    @type = 'text/html',                                                                                               
--    @server = 'angelmail.angelbroking.com'                                  
                                  
        
        
exec MIS.msdb.dbo.sp_send_dbmail                                                                                                             
--@recipients  = 'Megha.Wangane@angelbroking.com',                                                                                                                 
@recipients  = @PTo,--@email,                  
--@copy_recipients ='Megha.Wangane@angelbroking.com;MahendraD.Bonde@angelbroking.com',           
@copy_recipients ='Harishchandrajaiswal@angelbroking.com;Ithelpeskakruti@angelbroking.com',                                                         
                                                      
@profile_name =@PFROM,                                
--@profile_name = @Pfrom,                                                                                                   
@subject = @Psubject,                                                                                                 
@body_format = 'html',                                                                                      
@body =@msg         
        
insert into tbl_IT_Jobs_Log_Detail values(@brcode,@pfrom,@pto,@psubject,@msg,'TCP Mails',getdate())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Bind_AllData
-- --------------------------------------------------

CREATE Proc Usp_Bind_AllData
as  
  
select a.Fld_Id as Srno,a.Fld_Link,a.Fld_Connectivity_Type,a.Fld_Chk_Id,a.Fld_Provider,a.Fld_BandWidth,a.Fld_Purpose,a.Fld_CSO,a.Fld_Branch,Fld_Doft1=convert(varchar(11),convert(datetime,b.fld_doft),103),  
b.*  
 from V_Wan_data a  
inner join  
Tbl_IT_Wanlink_Update_Data b  
on a.Fld_Id = b.Fld_Srno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Bind_Data
-- --------------------------------------------------

CREATE Proc Usp_Bind_Data (@BrCode as varchar(15),@fld_branch varchar(20))                
as                
                
select a.Fld_Id as Srno,a.Fld_Link,a.category ,a.Fld_Chk_Id,              
a.Fld_Provider,a.Fld_BandWitdh,a.Fld_Purpose,a.Fld_CSO,a.Fld_Branch,              
Fld_Doft1=convert(varchar(11),convert(datetime,b.fld_doft),103),                
b.Fld_SrNo,b.Fld_Id,b.Fld_Fetch_Date,b.Fld_Flag,b.Fld_Status,b.Fld_Connectivity_Type,              
b.Fld_DOFT,z.person_name as Fld_First_TestBy,z.person_name as Fld_FEmpCode, b.Fld_DOST,b.Fld_Second_TestBy,              
b.Fld_First_Remark ,b.Fld_Second_Remark,b.Fld_SEmpCode,upper(c.br_Name) as br_name               
from V_Wan_data a  inner join                
Tbl_IT_Wanlink_Update_Data  b   (nolock)              
on a.Fld_Id = b.Fld_Srno and fld_cso like replace(@BrCode,'ALL','%%')  and fld_branch like replace(@fld_branch,'ALL','%%')          
left outer join              
intranet.risk.dbo.user_login z on b.Fld_FEmpCode = z.username             
left outer join          
tbl_it_br_master c on a.Fld_Branch = convert(varchar,c.Sr_No)          
order by c.br_Name,a.Fld_Id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Bind_Data_Branch
-- --------------------------------------------------


CREATE PROC USP_BIND_DATA_BRANCH    
(                                                  
@FLD_BRANCH VARCHAR(20),                                                  
@FLD_CSO VARCHAR(15),                                                  
@FETCHDATE VARCHAR(11) =NULL                                                  
)                                                  
AS                                                                   
 IF @FLD_BRANCH ='SELECT'                                                   
 BEGIN                                                  
 SET @FLD_BRANCH = 0                                                  
 END                        
 DECLARE @FDATE AS DATETIME                                                  
 SET @FDATE =CONVERT(DATETIME,@FETCHDATE,105)                        
 CREATE TABLE #T                                                            
 (                                                            
 SR_NO INT,                                                            
 BR_TAG VARCHAR(50),                                                            
 BR_NAME VARCHAR(200)                                                            
 )                                                                         
  SET @FLD_CSO = CASE WHEN @FLD_CSO ='ALL' THEN '%%' ELSE @FLD_CSO END                                                            
 IF @FLD_BRANCH = 'ALL'                                                            
 BEGIN                                                            
  INSERT INTO #T                                           
  EXEC USP_WAN_SEARCH_BRANCH @FLD_CSO                              
 END                                                            
 ELSE                                                            
 BEGIN                                                            
  INSERT INTO #T                                                            
  SELECT @FLD_BRANCH,'',''                                                            
 END                        
 DECLARE @CSONAME VARCHAR(30)                                                      
 SELECT @CSONAME = FLD_REGNAME FROM TBL_REGION_MASTER WHERE FLD_REGCODE = @FLD_CSO                                                
 SELECT A.FLD_ID AS SRNO,A.FLD_LINK,A.CATEGORY,A.FLD_CHK_ID,C.Br_Tag ,                                                                             
   A.FLD_PROVIDER,A.FLD_BANDWITDH,A.FLD_PURPOSE,A.FLD_CSO,A.FLD_BRANCH,                        
   B.FLD_ID,B.FLD_ENTRY_DATE,                                          
   B.FLD_STATUS,B.FLD_CONNECTIVITY_TYPE,                                                                              
   Ltrim(Rtrim(D.Fld_Status)) as Status,        
   D.FLD_DOFT,Z.PERSON_NAME AS FLD_FIRST_TESTBY,Z.PERSON_NAME AS FLD_FEMPCODE,                                           
   D.FLD_DOST,D.FLD_SECOND_TESTBY,                                              
   D.FLD_FIRST_REMARK  AS FLD_FIRST_REMARK ,D.FLD_SECOND_REMARK  AS FLD_SECOND_REMARK,                                          
   D.FLD_SEMPCODE,B.ACTIVESTATUS,B.INACTIVEDATE,                            
   UPPER(C.BR_NAME) AS BR_NAME ,UPPER(C.BR_TAG) AS BR_TAG,FLD_REGNAME AS CSONAME                        
 FROM V_WAN_DATA A                          
 INNER JOIN TBL_IT_WANLINK_DATA B  ON A.FLD_ID = B.FLD_ID         
 AND A.FLD_BRANCH IN (SELECT SR_NO FROM #T) ---- commented by harshal at 8 May 2013        
 LEFT OUTER JOIN (SELECT * FROM TBL_IT_WANLINK_UPDATE_DATA (NOLOCK) WHERE FLD_DOST=@FDATE) D  ON A.FLD_ID = D.FLD_ID                                         
 LEFT OUTER JOIN INTRANET.RISK.DBO.USER_LOGIN Z ON D.FLD_SECOND_TESTBY = Z.USERNAME                                                                             
 LEFT OUTER JOIN TBL_IT_BR_MASTER C ON A.FLD_BRANCH = CONVERT(VARCHAR,C.SR_NO)                                
 --LEFT OUTER JOIN TBL_IT_BR_MASTER E ON A.FLD_BRANCH = E.SR_NO              
 LEFT OUTER JOIN Tbl_RegionMaster_UPSWanlink F ON C.Br_Tag =F.FLD_REGCODE              
 WHERE CONVERT(DATETIME,(CONVERT(VARCHAR(11),A.INACTIVEDATE ,103)),103) >= CONVERT(DATETIME,@FETCHDATE,103)                
 --WHERE CONVERT(VARCHAR(11),CONVERT(DATETIME,A.FLD_ENTRY_DATE,103),121) = @FDATE                        
 ORDER BY C.BR_NAME,A.FLD_ID       
 drop table #T

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Bind_Data_Branch_12Mar2013
-- --------------------------------------------------




CREATE Proc Usp_Bind_Data_Branch_12Mar2013         
(        
  @fld_branch varchar(20),        
  @Fld_CSO varchar(15),        
  @FetchDate varchar(11) =null        
)        
as                         
 IF @fld_branch ='Select'         
 BEGIN        
 SET @fld_branch = 0        
 END        
         
DECLARE @FDate as datetime        
SET @FDate =CONVERT(datetime,@FetchDate,105)        
        
                  
create table #t                  
(                  
Sr_No int,                  
Br_tag varchar(50),                  
Br_Name varchar(200)                  
)                               
                  
if @fld_branch = 'All'                  
                  
begin                  
 insert into #t                  
 exec USP_WAN_Search_Branch @Fld_CSO                 
end                  
else                  
begin                  
 insert into #t                  
 select @fld_branch,'',''                  
end                        
                          
--set @fld_branch =  (select Sr_No from tbl_it_br_master where br_tag = @fld_branch)            
DECLARE @CSOName Varchar(30)            
SELECT @CSOName = Fld_RegName FROM tbl_region_master WHERE Fld_RegCode = @Fld_CSO      
                                     
select a.Fld_Id as Srno,a.Fld_Link,a.category,a.Fld_Chk_Id,                                    
a.Fld_Provider,a.Fld_BandWitdh,a.Fld_Purpose,a.Fld_CSO,a.Fld_Branch,                                    
Fld_Doft1=replace(convert(varchar(11),convert(datetime,b.fld_doft),103),'01/01/1900',''),                                      
b.Fld_SrNo,b.Fld_Id,b.Fld_Fetch_Date,b.Fld_Flag,b.Fld_Status,b.Fld_Connectivity_Type,                                    
b.Fld_DOFT,z.person_name as Fld_First_TestBy,z.person_name as Fld_FEmpCode, b.Fld_DOST,b.Fld_Second_TestBy,                                    
b.Fld_First_Remark ,b.Fld_Second_Remark,b.Fld_SEmpCode,upper(c.br_Name) as br_name ,upper(c.Br_Tag) as br_tag,Case WHEN @CSOName Is null THEN '' ELSE @CSOName END as CSOName      
from V_Wan_data a  inner join                                      
Tbl_IT_Wanlink_Update_Data b                                      
on a.Fld_Id = b.Fld_Srno and /*fld_cso like @BrCode and*/ fld_branch in (select Sr_No from #t) /* and Fld_CSO like replace(@Fld_CSO,'ALL','%%')*/                                
left outer join                                    
intranet.risk.dbo.user_login z on b.Fld_Second_TestBy = z.username                                   
left outer join                                
tbl_it_br_master c on a.Fld_Branch = convert(varchar,c.Sr_No)        
--WHERE Convert(varchar(11),Convert(datetime,a.Fld_Entry_Date,103),121) = @FDate                    
order by c.br_Name,a.Fld_Id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Bind_Report_Data
-- --------------------------------------------------

CREATE Proc Usp_Bind_Report_Data                            
(                              
  @fld_branch varchar(20),                              
  @Fld_CSO varchar(15),                              
  @FetchDate varchar(11) =null                              
)                              
as                                               
BEGIN      
 --IF @fld_branch ='Select'                               
 --BEGIN                              
 --SET @fld_branch = 0                              
 --END                              
                               
DECLARE @FDate as datetime                              
SET @FDate =CONVERT(datetime,@FetchDate,105)                              
                              
                                        
create table #t                                        
(                                        
Sr_No int,                                        
Br_tag varchar(50),                                        
Br_Name varchar(200)                                        
)                                                     
                                        
if @fld_branch = 'All'                                        
begin                                        
 insert into #t                                        
 exec USP_WAN_Search_Branch @Fld_CSO                                       
end                                        
else                                        
begin                                        
 insert into #t                                        
 select @fld_branch,'',''                                        
end                                              
             
                                                
--set @fld_branch =  (select Sr_No from tbl_it_br_master where br_tag = @fld_branch)                                  
DECLARE @CSOName Varchar(30)                                  
SELECT @CSOName = Fld_RegName FROM tbl_region_master WHERE Fld_RegCode = @Fld_CSO                            
      
 IF @Fld_CSO ='All'      
 BEGIN      
  select a.Fld_Id as Srno,a.Fld_Link,a.category,a.Fld_Chk_Id,                                                          
   a.Fld_Provider,a.Fld_BandWitdh,a.Fld_Purpose,a.Fld_CSO,a.Fld_Branch,                                                          
   --Fld_Doft1=replace(convert(varchar(11),convert(datetime,b.fld_doft),103),'01/01/1900',''),                                                            
   b.Fld_Id,b.Fld_Entry_Date,                      
   --a.Fld_Flag,                      
   b.Fld_Status,b.Fld_Connectivity_Type,                                                          
   d.Fld_DOFT,z.person_name as Fld_First_TestBy,z.person_name as Fld_FEmpCode,                       
   d.Fld_DOST,d.Fld_Second_TestBy,                          
   d.Fld_First_Remark  as Fld_First_Remark ,d.Fld_Second_Remark  as Fld_Second_Remark,                      
   d.Fld_SEmpCode, d.Fld_Status as Status ,                    
   upper(c.br_Name) as br_name ,upper(c.Br_Tag) as br_tag, Fld_RegName as CSOName                            
  from V_Wan_data a        
  inner join Tbl_IT_Wanlink_Data b on a.Fld_Id = b.Fld_Id       
  left outer join (SELECT * FROM Tbl_IT_Wanlink_Update_Data (nolock) WHERE Fld_DOST=@FDate) d on a.Fld_Id = d.Fld_Id                     
  left outer join intranet.risk.dbo.user_login z on d.Fld_Second_TestBy = z.username                                                         
  left outer join tbl_it_br_master c on a.Fld_Branch = convert(varchar,c.Sr_No)       
  left outer join Tbl_RegionMaster_UPSWanlink e on c.Br_Tag  = e.Fld_RegCode      
  Where d.Fld_DOST=@FDate      
  order by c.br_Name,a.Fld_Id          
 END      
Else      
 BEGIN      
  select a.Fld_Id as Srno,a.Fld_Link,a.category,a.Fld_Chk_Id,                                                          
   a.Fld_Provider,a.Fld_BandWitdh,a.Fld_Purpose,a.Fld_CSO,a.Fld_Branch,        
   --Fld_Doft1=replace(convert(varchar(11),convert(datetime,b.fld_doft),103),'01/01/1900',''),                             
   b.Fld_Id,b.Fld_Entry_Date,                      
   --a.Fld_Flag,                      
   b.Fld_Status,b.Fld_Connectivity_Type,                                                          
   d.Fld_DOFT,z.person_name as Fld_First_TestBy,z.person_name as Fld_FEmpCode,                       
   d.Fld_DOST,d.Fld_Second_TestBy,                          
   d.Fld_First_Remark  as Fld_First_Remark ,d.Fld_Second_Remark  as Fld_Second_Remark,                      
   d.Fld_SEmpCode, d.Fld_Status as Status ,                    
   upper(c.br_Name) as br_name ,upper(c.Br_Tag) as br_tag,Fld_RegName as CSOName                            
  from V_Wan_data a        
  inner join Tbl_IT_Wanlink_Data b on a.Fld_Id = b.Fld_Id and a.fld_branch in (select Sr_No from #t)                    
  left outer join (SELECT * FROM Tbl_IT_Wanlink_Update_Data (nolock) WHERE Fld_DOST=@FDate) d on a.Fld_Id = d.Fld_Id                     
  left outer join intranet.risk.dbo.user_login z on d.Fld_Second_TestBy = z.username                                                         
  left outer join tbl_it_br_master c on a.Fld_Branch = convert(varchar,c.Sr_No)        
  left outer join Tbl_RegionMaster_UPSWanlink e on c.Br_Tag  = e.Fld_RegCode        
  Where d.Fld_DOST=@FDate                          
  order by c.br_Name,a.Fld_Id       
 END      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_branch_details_m
-- --------------------------------------------------
CREATE proc usp_branch_details_m(@status as varchar(50),@regcode as varchar(50))  
as  
select        
upper(EMP_NO) as EMP_ID,                         
upper(EMP_NAME) as EMP_NAME ,                
upper(JOB_DES) as JOB_DES,                
upper(PHONE) as PHONE,  
upper(JOINDATE) as JOINDATE,        
upper(Department)as Department,        
upper(subdepartment) as subdepartment,          
upper(Emp_region) as region,               
upper(br_Name) as br_Name,          
upper(attnlocation) as attnlocation,        
upper(Costcode) as CostCenter,                
upper(emailadd) as emailadd,   
upper(status) as status,   
upper(relievedate) as relievedate,     
case when status = 'A' then 'ACTIVE' else 'DISABLE' end as status,RelieveDate from V_IT_Staff_Rpt_new                   
where status like @status --and mm <= @mm       
and Fld_Branch_Id in (select Sr_No from V_tbl_it_br_master where br_tag LIKE @regcode)               
order by convert(datetime,joindate,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Branch_Master
-- --------------------------------------------------
  
CREATE Proc USP_Branch_Master            
(         
@sr_No int,           
@Br_Tag varchar(15),            
@Br_Name varchar(50),            
@Br_Type varchar(50),            
@Br_Region varchar(20),            
@Br_Contact_Person varchar(200),            
@Br_Address varchar(300),            
@Br_Email varchar(200),            
@Br_TelNo varchar(200),            
@Br_Fax varchar(200),            
@Br_Head  varchar(200),            
@Br_Head_Mails varchar(100),            
@Br_CellNo varchar(200),          
@Fld_Business_Category varchar(10)            
)            
as            
          
if (select count(*) from tbl_it_br_master where Br_tag = @Br_Tag) >= 1           
begin          
 update tbl_it_br_master set Br_Tag = @Br_Tag,Br_Name = @Br_Name,Br_Type = @Br_Type,Br_Region = @Br_Region,            
 Br_Contact_Person = @Br_Contact_Person,Br_Address = @Br_Address,Br_Email = @Br_Email,Br_TelNo = @Br_TelNo,            
 Br_Fax = @Br_Fax,Br_Head = @Br_Head,Br_CellNo = @Br_CellNo,Br_Head_Mails=@Br_Head_Mails,Fld_Business_Category=@Fld_Business_Category where Sr_No = @sr_No           
          
 Select 'Record Updated Successfully' as MSG          
end          
else          
begin          
 insert into tbl_it_br_master values            
 (            
 @Br_Tag,            
 @Br_Name,            
 @Br_Type,            
 @Br_Region,            
 @Br_Contact_Person,            
 @Br_Address,            
 @Br_Email,            
 @Br_TelNo,            
 @Br_Fax,            
 @Br_Head,            
 @Br_Head_Mails,            
 @Br_CellNo,          
 @Fld_Business_Category,      
'A',
NULL,
NULL           
 )             
 Select 'Record Saved Successfully' as MSG          
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Branch_Master_delete
-- --------------------------------------------------
CREATE proc [dbo].[USP_Branch_Master_delete]    
  
@Br_Tag varchar(15),    
@username varchar(10)    
as    
Begin    
select usertype,access_code into #t from intranet.risk.dbo.user_login with(nolock)where username=@username    
if (select usertype from #t) = 'ADMIN'              
Begin     
if (select access_code from #t) = 'CSO' 
BEGIN      
delete from tbl_it_br_master where rtrim(ltrim(Br_tag))=rtrim(ltrim(@Br_tag))    
Select 'Record Deleted Successfully ' as MSG     
END
End      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BranchActive_DeActive
-- --------------------------------------------------
--select * from tbl_it_br_master
--Exec USP_BranchActive_DeActive  'ACM','E30252','1'
CREATE proc [dbo].[USP_BranchActive_DeActive]

@Br_Tag varchar(15),
@username varchar(10),
@Option as int
as

Begin
   If(@Option=1)
   Begin
   ----   Select usertype,access_code into #t from intranet.risk.dbo.user_login with(nolock)where username=@username
	  ----    If (select usertype from #t) = 'ADMIN'          
			----Begin 
				----If (select access_code from #t) = 'CSO'   
				Update  tbl_it_br_master set
				Br_Status='A'
				where rtrim(ltrim(Br_tag))=rtrim(ltrim(@Br_tag))
				
				Select 'Branch Activated Successfully' as MSG 
			----End	
	End
	Else If(@Option=2)
	Begin
	  -- Select usertype,access_code into #t1 from intranet.risk.dbo.user_login with(nolock)where username=@username
	  --    If (select usertype from #t1) = 'ADMIN'          
			--Begin 
				--If (select access_code from #t1) = 'CSO'   
				Update  tbl_it_br_master set
				Br_Status='D'
				where rtrim(ltrim(Br_tag))=rtrim(ltrim(@Br_tag))
				
				Select 'Branch DeActivated Successfully' as MSG 
			--End	
	End			
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BranchWiseReport
-- --------------------------------------------------
CREATE proc  USP_BranchWiseReport 
(@region as varchar(30),@fdate as varchar(11),@tdate as varchar(11))    
as     
begin
Set NOCount ON    
  set @fdate =convert(datetime,@fdate,103)    
set @tdate =convert(datetime,@tdate,103) 
select complaint_id,max(sr_num) sr_num into #t from tbl_complaint(nolock) 
where complaint_date>=@fdate    
and complaint_date<=@tdate+' 23:59:59' group by complaint_id    
  
 select a.*,b.access_code into #tt from    
(select v_opsstatus.* from v_opsstatus inner join #t on v_opsstatus.sr_num=#t.sr_num)a    
 left outer join    
(select distinct access_code from tbl_complaint)b    
 on a.branch_tag=b.access_code
 
select a.*,isnull(b.Pend,0) Pending ,isnull(c.ip,0) InProcess,isnull(d.hld,0) Hold,    
isnull(e.Comp,0)Completed,isnull(f.BC,0) Branch_Completed into #branch from    
(select access_code,Total=count(*) from #tt group by access_code)a     
left outer join    
(select access_code,Pend=count(*) from #tt where stat_flag ='P' group by access_code)b
on a.access_code=b.access_code    
left outer join    
(select access_code,ip=count(*) from #tt where stat_flag in('IP','F') group by access_code)c 
on a.access_code=c.access_code    
left outer join    
(select access_code,Hld=count(*) from #tt where stat_flag='H' group by access_code)d 
on a.access_code=d.access_code    
left outer join    
(select access_code,Comp=count(*) from #tt where stat_flag='C' group by access_code)e 
on a.access_code=e.access_code    
left outer join    
(select access_code,BC=count(*) from #tt where stat_flag='BC' group by access_code)f    
on a.access_code=f.access_code
where a.access_code is not null

select name,#branch.* from #branch inner join intranet.risk.dbo.region a
on #branch.access_code=a.code 
where a.region=''+@region+''

----select * from #branch

--select * from intranet.risk.dbo.region where region ='COIMBATORE'
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_brdetail
-- --------------------------------------------------
create proc usp_brdetail
as
(
select Sr_No,upper(br_tag)+'-'+upper(Br_Name) as br_name from tbl_it_br_master (nolock)
) order by Br_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS                                
(@fdate as varchar(15),@tdate as varchar(15),@segment as varchar(25))                                
as                      
                                
set nocount on                      
                      
declare @ttime as int                        
declare @str as varchar(500)                        
declare @tname as varchar(25)                            
-- declare @fdate as varchar(15)                        
-- declare @tdate as varchar(15)                        
-- declare @segment as varchar(25)                       
-- set @segment = 'NCDEX'                        
-- set @fdate = 'Mar 1 2006'                        
-- set @tdate = 'Mar 13 2007'                        
-- set @segment = 'BSE_+_CM_+_FO'                      
                        
Set @tname = (Select                                       
 (case                                       
 when @segment = 'BSE' then '''ABLCM'''                                       
 when @segment = 'NSE' then '''ACDLCM'''                        
 when @segment = 'FO' then '''ACDLFO'''                                                      
 when @segment = 'All_Exchanges' then  '%'                                       
 when @segment = 'ALL' then  '%'      
 when @segment = 'BSE_+_CM_+_FO'then  '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                                        
 when @segment = 'CM_+_FO' then  '''ACDLCM'''+','+'''ACDLFO'''                        
 when @segment = 'MCX' then '''ACPLMCX'''                                       
 when @segment = 'NCDEX' then '''ACPLNCDEX'''                        
 when @segment = 'MCX_+_NCDEX' then  '''MCX'''+','+'''NCDEX'''                                      
 else '''NONE''' end))                                     
--print @tname                       
                    
select Top 0 Total=convert(int,sum(BSE+CM+FO))  into #Ttime  from sett_mst where tdate >= 'Mar 1 2006 00:00:000' and tdate <= 'Mar 13 2007 23:59:000'                    
                    
if @tname = '''ABLCM'''                    
begin                    
 set @str = ('select Total=isnull(convert(int,sum(BSE)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
                    
if @tname = '''ACDLCM'''                    
begin                    
                    
 set @str = ('select Total=isnull(convert(int,sum(CM)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
if @tname = '''ACDLFO'''                    
begin                    
                    
 set @str = ('select Total=isnull(convert(int,sum(FO)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
if @tname = '''ACPLMCX'''                    
begin                    
                    
 set @str = ('select Total=isnull(convert(int,sum(MCX)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
if @tname = '''ACPLNCDEX'''                    
begin                    
                    
 set @str = ('select Total=isnull(convert(int,sum(NCDEX)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
                    
if @tname = '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                       
begin                    
                    
 set @str = ('select Total=isnull(convert(int,sum(BSE+CM+FO)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
                    
if @tname = '''MCX'''+','+'''NCDEX'''                       
begin                    
 set @str = ('select Total=isnull(convert(int,sum(MCX+NCDEX)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')       
end                     
                    
if @tname = '''ACDLCM'''+','+'''ACDLFO'''                       
begin                    
 set @str = ('select Total=isnull(convert(int,sum(CM+FO)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
            
if @tname = '%'                       
begin                    
 set @str = ('select Total=isnull(convert(int,sum(bse+cm+FO+mcx+ncdex)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                      
end                     
          
if @tname = 'NONE'                       
begin                    
 set @str = ('select Total=sum(0) from sett_mst')                      
end          
                    
insert into  #Ttime                    
exec (@str)              
                      
select Top 0 Terminal_id,Brokeage=isnull(sum(Brokerage),0) into #t from terminal_brok  where sauda_date >= 'Mar 1 2007' and                       
sauda_date <= 'Mar 01 2007' and company like '%' group by Terminal_id                        
                        
if @tname = '%'                        
 begin                                
  set @str = ('select Terminal_id,Brokeage=isnull(sum(Brokerage),0) from terminal_brok  where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and company like '''+@tname+''' group by Terminal_id')                        
 end                        
else                        
 begin                                
  set @str = ('select Terminal_id,Brokeage=isnull(sum(Brokerage),0) from terminal_brok  where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and company in'+'('+@tname+')'+'group by Terminal_id' )                        
 end                        
                       
insert into #t                        
exec (@str)                                  
          
--select * from terminals          
                               
select server=replace(a.server,'KARAD','BOK'),brokeage=isnull(sum(b.brokeage),0) into #b                        
from terminals a inner join #t b on a.Odin_id = b.terminal_id           
--and server like replace(@location,'All','%')+'%'           
where brokeage <> 0  group by a.server                                    
                               
set @ttime = (select * from #Ttime)                                            
          
select Top 0 a.location,downtime=isnull(sum(convert (int,downtimemin)),0),Pecentage=isnull((sum(convert (dec,downtimemin))/@ttime)*100,0),          
Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,downtimemin))),0) into #dtime from NewTAb1 a left outer join #b b           
on a.location = b.server where dt >= 'Jan 01 2007' and dt <= 'Jan 01 2007' group by location,brokeage order by Location                          
          
if @segment = 'All_Exchanges'          
	 begin          
	  insert into #dtime          
	  select  a.location,downtime=isnull(sum(convert (int,downtimemin)),0),Pecentage=isnull((sum(convert (dec,downtimemin))/@ttime)*100,0),          
	  Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,downtimemin))),0)                                
	  from NewTAb1 a left outer join #b b on a.location = b.server where dt >= @fdate and dt <= @tdate           
	  and ImpactedSegemnt = 'All Exchanges' group by location,brokeage order by Location                           
	 end          
else 
if @segment = 'ALL'          
	begin          
	insert into #dtime          
	select  a.location,downtime=isnull(sum(convert (int,downtimemin)),0),Pecentage=isnull((sum(convert (dec,downtimemin))/@ttime)*100,0),          
	Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,downtimemin))),0)                                
	from NewTAb1 a left outer join #b b on a.location = b.server and ImpactedSegemnt like '%' where dt >= @fdate and dt <= @tdate group by location,brokeage order by Location                          
end    
else    
	begin          
	  insert into #dtime          
	  select  a.location,downtime=isnull(sum(convert (int,downtimemin)),0),Pecentage=isnull((sum(convert (dec,downtimemin))/@ttime)*100,0),          
	  Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,downtimemin))),0)                                
	  from NewTAb1 a left outer join #b b on a.location = b.server where dt >= @fdate and dt <= @tdate group by location,brokeage order by Location                          
	 end    
                  
                              
truncate table Brokerage_Loss                 
                              
insert into Brokerage_Loss                
select location,downtime,pecentage,brok_loss=isnull(brok_loss,0),total=100-pecentage from  #dtime                      
                  
--select * from  #dtime                      
                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW      
(@fdate as varchar(15),@tdate as varchar(15),@segment as varchar(25))                                        
as                              
                                        
set nocount on                              
                              
declare @ttime as int                                
declare @str as varchar(500)                                
declare @str1 as varchar(500)                                
declare @tname as varchar(25)                                    
-- declare @fdate as varchar(15)                                
-- declare @tdate as varchar(15)                                
-- declare @segment as varchar(25)                               
-- set @segment = 'NCDEX'                                
-- set @fdate = 'Mar 1 2006'                                
-- set @tdate = 'Mar 13 2007'                                
-- set @segment = 'BSE_+_CM_+_FO'                              
                                
Set @tname = (Select                                               
 (case                                               
 when @segment = 'BSE' then '''ABLCM'''                                               
 when @segment = 'NSE' then '''ACDLCM'''                                
 when @segment = 'FO' then '''ACDLFO'''                                                              
 when @segment = 'All_Exchanges' then  '%'                                               
 when @segment = 'ALL' then  '%'              
 when @segment = 'BSE_+_CM_+_FO'then  '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                                                
 when @segment = 'CM_+_FO' then  '''ACDLCM'''+','+'''ACDLFO'''                                
 when @segment = 'MCX' then '''ACPLMCX'''                                               
 when @segment = 'NCDEX' then '''ACPLNCDEX'''                                
 when @segment = 'MCX_+_NCDEX' then  '''MCX'''+','+'''NCDEX'''                                              
 else '''NONE''' end))                                             
--print @tname                               
                            
select Top 0 Total=convert(int,sum(BSE+CM+FO))  into #Ttime  from sett_mst where tdate >= 'Mar 1 2006 00:00:000' and tdate <= 'Mar 13 2007 23:59:000'                            
select Top 0 loc=location,downtime=sum(convert(int,downtimemin)) into  #downtime from newtab1 where dt  >= 'Mar 1 2006 00:00:000' and dt <= 'Mar 13 2007 23:59:000' and Impactedsegemnt = 'BSE' group by location                           
    
                            
if @tname = '''ABLCM'''                            
begin                            
 set @str = ('select Total=isnull(convert(int,sum(BSE)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''BSE'' group by location')                                 
end                             
                            
if @tname = '''ACDLCM'''                            
begin                            
    set @str = ('select Total=isnull(convert(int,sum(CM)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
    set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''CM'' group by location')                                 
end                             
      
if @tname = '''ACDLFO'''                            
begin                                              
 set @str = ('select Total=isnull(convert(int,sum(FO)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''FO'' group by location')                                 
end                             
      
if @tname = '''ACPLMCX'''                            
begin                                          
 set @str = ('select Total=isnull(convert(int,sum(MCX)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''MCX'' group by location')                                 
end                             
      
if @tname = '''ACPLNCDEX'''                            
begin                             
 set @str = ('select Total=isnull(convert(int,sum(NCDEX)),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''NCDEX'' group by location')                                 
end                             
                            
if @tname = '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                               
begin                             
 set @str = ('select Total=isnull(convert(int,sum(BSE+CM+FO)/3),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''BSE + CM + FO'' group by location')                                 
end                             
            
if @tname = '''MCX'''+','+'''NCDEX'''                               
begin                            
      
 set @str = ('select Total=isnull(convert(int,sum(MCX+NCDEX)/2),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')               
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''MCX + NCDEX'' group by location')                                 
end                             
                            
if @tname = '''ACDLCM'''+','+'''ACDLFO'''                               
begin                            
 set @str = ('select Total=isnull(convert(int,sum(CM+FO)/2),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''CM + FO'' group by location')                                 
end                             
                    
if @tname = '%'                               
begin                            
 set @str = ('select Total=isnull(convert(int,sum(bse+cm+FO+mcx+ncdex)/5),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt like ''%'' group by location')                                 
end     
  
if @segment = 'All_Exchanges'                               
begin                            
 set @str = ('select Total=isnull(convert(int,sum(bse+cm+FO+mcx+ncdex)/5),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                              
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''All Exchanges'' group by location')                                 
end     
           
if @tname = 'NONE'                               
begin                            
 set @str = ('select Total=sum(0) from sett_mst')                              
end                  
                            
insert into  #Ttime                            
exec (@str)                      
      
insert into #downtime      
exec (@str1)                      
                              
select Top 0 Terminal_id,Brokeage=isnull(sum(Brokerage),0) into #t from terminal_brok  where sauda_date >= 'Mar 1 2007' and                               
sauda_date <= 'Mar 01 2007' and company like '%' group by Terminal_id                                
                                
if @tname = '%'                                
 begin                                        
  set @str = ('select Terminal_id,Brokeage=isnull(sum(Brokerage),0) from terminal_brok  where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and company like '''+@tname+''' group by Terminal_id')                                
 end                                
else                                
 begin                                        
  set @str = ('select Terminal_id,Brokeage=isnull(sum(Brokerage),0) from terminal_brok  where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and company in'+'('+@tname+')'+'group by Terminal_id' )                                
 end                                
                               
insert into #t                                
exec (@str)                                          
                  
--select * from terminals                  
                                       
select server=replace(a.server,'KARAD','BOK'),brokeage=isnull(sum(b.brokeage),0) into #b                                
from terminals a inner join #t b on a.Odin_id = b.terminal_id                   
--and server like replace(@location,'All','%')+'%'                   
where brokeage <> 0  group by a.server                                            
                                       
set @ttime = (select * from #Ttime)                                                    
                  
select Top 0 a.location,downtime=isnull(sum(convert (int,downtimemin)),0),Pecentage=isnull((sum(convert (dec,downtimemin))/@ttime)*100,0),                
Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,downtimemin))),0) into #dtime from NewTAb1 a left outer join #b b                 
on a.location = b.server where dt >= 'Jan 01 2007' and dt <= 'Jan 01 2007' group by location,brokeage order by Location                                
                   
-- if @segment = 'All_Exchanges'                  
--   begin                  
--     insert into #dtime                  
--     select  a.location,Pecentage=isnull((sum(convert (dec,c.downtime))/@ttime)*100,0),Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,c.downtime))),0)                                        
--     from NewTAb1 a left outer join #b as b on a.location = b.server left outer join #downtime c on a.locaton = c.#downtime       
--     where dt >= @fdate and dt <= @tdate and ImpactedSegemnt = 'All Exchanges' group by location,brokeage order by Location                                   
--   end                  
-- else         
--   begin                  
 insert into #dtime                   
 select server=a.loc,a.downtime,Pecentage=isnull((sum(convert (dec,a.downtime))/@ttime)*100,0),  
 Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,a.downtime))),0)  
 from #downtime a left outer join #b b on a.loc = b.server                            
 group by loc,downtime,brokeage                               
--  end            
                          
             
truncate table Brokerage_Loss                         
                                      
insert into Brokerage_Loss                        
select location,downtime,pecentage,brok_loss=isnull(brok_loss,0),total=100-pecentage from  #dtime                              
                          
--select * from  #dtime                              
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_1
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_1        
(@fdate as varchar(15),@tdate as varchar(15),@segment as varchar(25))                                          
as                                
                                          
set nocount on                                
                                
declare @ttime as int                                  
declare @str as varchar(500)                                  
declare @str1 as varchar(500)                                  
declare @tname as varchar(25)                                      
-- declare @fdate as varchar(15)                                  
-- declare @tdate as varchar(15)                                  
-- declare @segment as varchar(25)                                 
-- set @segment = 'NCDEX'                                  
-- set @fdate = 'Mar 1 2006'                                  
-- set @tdate = 'Mar 13 2007'                                  
-- set @segment = 'BSE_+_CM_+_FO'                                
                                  
Set @tname = (Select                                                 
 (case                                                 
 when @segment = 'BSE' then '''ABLCM'''                                                 
 when @segment = 'NSE' then '''ACDLCM'''                                  
 when @segment = 'FO' then '''ACDLFO'''                                                                
 when @segment = 'All_Exchanges' then  '%'                                                 
 when @segment = 'ALL' then  '%'                
 when @segment = 'BSE_+_CM_+_FO'then  '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                                                  
 when @segment = 'CM_+_FO' then  '''ACDLCM'''+','+'''ACDLFO'''                                  
 when @segment = 'MCX' then '''ACPLMCX'''                                                 
 when @segment = 'NCDEX' then '''ACPLNCDEX'''                                  
 when @segment = 'MCX_+_NCDEX' then  '''MCX'''+','+'''NCDEX'''                                                
 else '''NONE''' end))                                               
--print @tname                                 
                              
select Top 0 Total=convert(int,sum(BSE+CM+FO))  into #Ttime  from sett_mst where tdate >= 'Mar 1 2006 00:00:000' and tdate <= 'Mar 13 2007 23:59:000'                              
select Top 0 loc=location,downtime=sum(convert(int,downtimemin)) into  #downtime from newtab1 where dt  >= 'Mar 1 2006 00:00:000' and dt <= 'Mar 13 2007 23:59:000' and Impactedsegemnt = 'BSE' group by location                                   
                              
if @tname = '''ABLCM'''                              
begin                              
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''BSE'' group by location')                                   
end                               
                              
if @tname = '''ACDLCM'''                              
begin                              
    set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''CM'' group by location')                                   
end                               
        
if @tname = '''ACDLFO'''                              
begin                                                
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''FO'' group by location')                                   
end                               
        
if @tname = '''ACPLMCX'''                              
begin                                            
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''MCX'' group by location')                                   
end                               
        
if @tname = '''ACPLNCDEX'''                              
begin                               
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''NCDEX'' group by location')                                   
end                               
                              
if @tname = '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                                 
begin                               
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''BSE + CM + FO'' group by location')                                   
end                               
              
if @tname = '''MCX'''+','+'''NCDEX'''                                 
begin
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''MCX + NCDEX'' group by location')                                   
end                               
                              
if @tname = '''ACDLCM'''+','+'''ACDLFO'''                                 
begin                              
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''CM + FO'' group by location')                                   
end                               
                     
if @tname = '%'                                 
begin                               
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt like ''%'' group by location')                                   
end       
    
if @segment = 'All_Exchanges'                                 
begin                         
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''All Exchanges'' group by location')                                   
end       
             
if @tname = 'NONE'                                 
begin                              
 set @str = ('select Total=sum(0) from sett_mst')                                
end                    
    
insert into #downtime        
exec (@str1)     

set @str = ('select Total=isnull(convert(int,sum(bse+cm+FO+mcx+ncdex)/5),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                                                          
insert into  #Ttime                              
exec (@str)                                
                   
                                
select Top 0 Terminal_id,Brokeage=isnull(sum(Brokerage),0) into #t from terminal_brok  where sauda_date >= 'Mar 1 2007' and                                 
sauda_date <= 'Mar 01 2007' and company like '%' group by Terminal_id                                  

set @str = ('select Terminal_id,Brokeage=isnull(sum(Brokerage),0) from terminal_brok  where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and company like ''%'' group by Terminal_id')                                  
                                 
insert into #t                                  
exec (@str)                                            
                    
--select * from terminals                    
                                         
select server=replace(a.server,'KARAD','BOK'),brokeage=isnull(sum(b.brokeage),0) into #b                                  
from terminals a inner join #t b on a.Odin_id = b.terminal_id                     
--and server like replace(@location,'All','%')+'%'                     
where brokeage <> 0  group by a.server                                              
                                         
set @ttime = (select * from #Ttime)                                                      
                    
select Top 0 a.location,downtime=isnull(sum(convert (int,downtimemin)),0),Pecentage=isnull((sum(convert (dec,downtimemin))/@ttime)*100,0),                  
Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,downtimemin))),0) into #dtime from NewTAb1 a left outer join #b b                   
on a.location = b.server where dt >= 'Jan 01 2007' and dt <= 'Jan 01 2007' group by location,brokeage order by Location                                  
                     
insert into #dtime                     
select server=a.loc,a.downtime,Pecentage=isnull((sum(convert (dec,a.downtime))/@ttime)*100,0),    
Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,a.downtime))),0)    
from #downtime a left outer join #b b on a.loc = b.server                              
group by loc,downtime,brokeage                                 
--  end                                          
               
truncate table Brokerage_Loss                           
                                        
insert into Brokerage_Loss                          
select location,downtime,pecentage,brok_loss=isnull(brok_loss,0),total=100-pecentage from  #dtime                                
                            
--select * from  #dtime                                
                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_10
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_10(@fdate as varchar(11))                          
as                                                                      
                          
set @fdate = convert(datetime,@fdate,103)              
                          
-----------------------Fetch Brokerage----------                          
select company,Terminal_id,Brokerage=sum(Brokerage)                                                                        
into #terminal_brok                           
--from mis_terminal_brok where sauda_date >= @fdate and                           
from intranet.bsedb_ab.dbo.mis_to_terminal  where sauda_date >= @fdate and                           
sauda_date <= @fdate group by company,Terminal_id                                                                        
                          
---------------------Market Time-----------------                          
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                                                                         
into #tt from sett_mst with(nolock) where tdate = @fdate                          
                          
---------------------Downtime --------------------                          
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)),                          
Problem into #downtime from newtab1 with(nolock) where dt >= convert(datetime,@fdate,105) and dt <= convert(datetime,@fdate,105)                          
group by Location,ImpactedSegemnt,problem                            
                          
-- select b.server,b.sdate,b.edate,a.*  into #a from #terminal_brok a inner join Terminals b                           
-- on a.terminal_id = b.odin_id /*and edate is null order by server*/                          
                        
select y.server,x.* into #a from #terminal_brok x,                        
(select * from Terminals with(nolock) where @fdate >= sdate and @fdate <= edate) y where x.terminal_id=y.odin_id                        
                          
--------------------------Affected Server Brokerage---------------                          
select server,company as segment,brokerage=sum(brokerage) into #ser_brok from #a where /*edate is null and*/ server  in                           
(select Location from #downtime where Impactedsegemnt <> 'None') group by server,company  order by server                           
                  
-----------------------------Data for trade not done in affected server-------------------------                  
insert into #ser_brok                  
select server,segment,0 from terminals where Odin_id not in (select Terminal_id from #a )                   
and server in (select distinct location from #downtime) and server+segment not in                    
(select distinct server+company from #a )                  
                          
--------------------------insert data in temp table--------------                          
select Top 0 #a.server,#a.company as segment, #a.brokerage,space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,                          
space(40) as Issues,space(100) as Exchanges into #temp_cal from #a                          
                          
--------------------------------Cursor for Updating temp table --------------------------                          
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50),@issues as varchar(100)                          
DECLARE authors_cursor CURSOR FOR select Location,ImpactedSegemnt,Downtimemin,Problem from #downtime where Impactedsegemnt <> 'None'                           
                                                
OPEN authors_cursor                                                
                                                
FETCH NEXT FROM authors_cursor                                                 
INTO @location,@segment,@downtime,@issues                                                
         
WHILE @@FETCH_STATUS = 0                                                
BEGIN                            
                          
                                  
if @segment = 'NCDEX'                                          
 Begin                                          
   insert into #temp_cal           
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                
@issues,@segment from #downtime a inner join #ser_brok b on                 
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                      
 End                                          
                                              
if @segment = 'MCX'                                                           
 Begin                                          
   insert into #temp_cal                                                
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,@issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                                                 
 end                                          
                                          
if @segment = 'BSECM'                                               
 Begin                                             
   insert into #temp_cal                                                
select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'BSECM' then 'ABLCM' end = b.segment and @location = b.server                                                 
 end                                          
                                          
if @segment = 'NSEFO'                                                   
 Begin                                             
   insert into #temp_cal                                                
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                                 
 end                                          
                                          
if @segment = 'NSECM'                                                   
 Begin                                                 
   insert into #temp_cal                                                
   select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'NSECM' then 'ACDLCM' end = b.segment and @location = b.server                                                   
 end                                          
                                          
                          
/*                                    
if @segment = 'All Segments'                                      
                                                   
 Begin                                                 
   insert into #temp_cal                                           
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'All Segments' then 'ACPLNCDEX' end = b.segment and @location = b.server                                                 
    union                       
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'All Segments' then 'ACPLMCX' end = b.segment and @location = b.server                                           
    union                                        
   select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                            
   case when a.impactedsegemnt = 'All Segments' then 'ABLCM' end = b.segment and @location = b.server                                           
   union                                          
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                
   case when a.impactedsegemnt = 'All Segments' then 'ACDLFO' end = b.segment and @location = b.server                                          
   union                                          
    select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'All Segments' then 'ACDLCM' end = b.segment and @location = b.server                                                       
 end                                          
                                          
if @segment = 'CM + FO + NCDEX'                                          
                         
 Begin                                                 
 insert into #temp_cal                                           
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                                 
    union                                          
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLFO' end = b.segment and @location = b.server                                          
   union                                          
          select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLCM' end = b.segment and @location = b.server                                                       
 end                                          
                                          
if @segment = 'BSE +  MCX + NCDEX'                                          
 begin                                           
  insert into #temp_cal                                           
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                             union                                          
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,     
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLMCX' end = b.segment and @location = b.server                                           
    union                                          
   select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ABLCM' end = b.segment and @location = b.server                                           
 end                                           
*/                    
                                          
if @segment = 'BSECM + NSECM + NSEFO'                                          
 Begin                                             
   insert into #temp_cal                                           
   select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'BSECM + NSECM + NSEFO' then 'ABLCM' end = b.segment and @location = b.server                                           
   union                                          
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                 
   @issues,@segment from #downtime a inner join #ser_brok b on                                           
   case when a.impactedsegemnt = 'BSECM + NSECM + NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                          
   union                                          
 select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'BSECM + NSECM + NSEFO' then 'ACDLCM' end = b.segment and @location = b.server                              
 end                                          
                                          
if @segment = 'NSECM + NSEFO'                    
 Begin                                                 
   insert into #temp_cal                                           
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'NSECM + NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                          
   union                                          
          select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'NSECM + NSEFO' then 'ACDLCM' end = b.segment and @location = b.server                                                       
 end                                          
                                          
if @segment = 'MCX + NCDEX'                    
 begin                                           
  insert into #temp_cal                                           
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                                 
    union                          
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,                                 
   @issues,@segment from #downtime a inner join #ser_brok b on                                                 
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLMCX' end = b.segment and @location = b.server                                           
 end                                                   
                              
                          
 FETCH NEXT FROM authors_cursor                                                 
 INTO @location,@segment,@downtime,@issues                                                
END                                                
                                                
CLOSE authors_cursor                                                
DEALLOCATE authors_cursor                                
                          
--------------------------------------Cursor End--------------------------------------------------                          
                          
-----------------------------------Updating temp table for not affected server---------------------------                          
                          
insert into #temp_cal                          
select server,company,sum(brokerage),'','','','','',''  from #a where rtrim(ltrim(server))+rtrim(ltrim(company)) not in                          
(select rtrim(ltrim(server))+rtrim(ltrim(segment)) from #temp_cal where server in                           
(select Location from #downtime where Impactedsegemnt <> 'None')) /*and sdate <= @fdate or  Sdate is null*/ group by server,company  order by server                          
          
                
-----------------------------------New changes for No Trade and No Downtime  June 28 2007-------------------------                
                
insert into #temp_cal                          
select server,segment,0,'','','','','','' from terminals where Odin_id not in (select Terminal_id from #a )                   
and server in (select distinct location from #downtime) and server+segment not in  (select distinct server+company from #a )                  
              
insert into #temp_cal                          
select Distinct server,segment,0,'','','','','','' from terminals where server+segment not in (select server+company from #a)              
and @fdate >= sdate and @fdate <= edate and server in (select distinct server from #a)              
                
----------------------------------------------------------------------------------------------------                
                          
update #temp_cal set uptime = (select bse from #tt) where segment = 'ABLCM'                          
update #temp_cal set uptime = (select cm from #tt) where segment = 'ACDLCM'                          
update #temp_cal set uptime = (select fo from #tt) where segment = 'ACDLFO'                          
update #temp_cal set uptime = (select mcx from #tt) where segment = 'ACPLMCX'                          
update #temp_cal set uptime = (select ncdex from #tt) where segment = 'ACPLNCDEX'                          
                          
update #temp_cal set sauda_date = @fdate                          
                          
update #temp_cal set dt = 0 where dt = ''                          
                          
delete terminal_brok_loss  where sauda_date = @fdate                          
            
-- insert into terminal_brok_loss                          
-- select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(convert(money,Brokerage)/case when (convert(int,uptime)-convert(int,dt)) = 0 then 1 else (convert(int,uptime)-convert(int,dt)) end)*convert(int,dt),sauda_date=convert(datetime,sauda_date
  
--),Issues,Exchanges from #temp_cal                          
            
-- insert into terminal_brok_loss                          
-- select distinct server, segment, Brokerage, dt, uptime,Brk_Loss= case when convert(int,dt) >= convert(int,uptime) then  convert(money,Brokerage)             
-- else ((convert(money,Brokerage))/(convert(int,uptime)-convert(int,dt)))*convert(int,dt)            
-- end,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal                          
            
insert into terminal_brok_loss              
select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(((convert(dec,dt)/convert(dec,uptime))*100)*(convert(dec,Brokerage)))/100,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal           
where  convert(dec,dt) <> 0 and convert(dec,uptime) <> 0                      
insert into terminal_brok_loss                          
select distinct server, segment, Brokerage, dt, uptime,0,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal           
where  convert(dec,dt) = 0 and convert(dec,(case when uptime='' then 0 else uptime end)) = 0                      
          
insert into terminal_brok_loss                            
select distinct server, segment, Brokerage, dt, uptime,0,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal           
where  convert(dec,dt) = 0 and convert(dec,(case when uptime='' then 0 else uptime end)) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_11
-- --------------------------------------------------
CREATE  Proc [dbo].[USP_BROK_LOSS_NEW_11](@fdate as varchar(11))                            
as                          
                        
--declare @fdate as varchar(11)            
set @fdate = convert(datetime,@fdate,103)                                        
--set @fdate = 'May 20 2009'                                        
                    
-----------------------Fetch Brokerage----------                                                                
select company,Terminal_id,Brokerage=sum(Brokerage)                                                                                                              
into #terminal_brok                                                                 
--from mis_terminal_brok where sauda_date >= @fdate and                                                                 
from intranet.bsedb_ab.dbo.mis_to_terminal  where sauda_date >= @fdate and                                                                 
sauda_date <= @fdate group by company,Terminal_id                             
                            
------------------------Get Details of All servers upto for that day---------------                            
select * into #Terminal_id from V_Manager_Details where @fdate >= sdate and @fdate <= tdate                            
                            
-------------------------Server wise Brokerage--------------                            
                            
select y.Fld_Id as Server,x.company as segment,sum(x.brokerage) as brokerage into #ser_brok  from #terminal_brok x,                                                              
(select * from #Terminal_id with(nolock) where @fdate >= sdate and @fdate <= tdate) y where x.Terminal_id=y.Fld_Manager_id                                                              
group by y.Fld_Id,x.company                            
                            
------------------------Details for not traded server                            
insert into #ser_brok                            
select Distinct Fld_id,Fld_segment,0 from #Terminal_id x where not exists                            
(select * from #ser_brok y where x.Fld_id = y.server)                            
                            
-----------------------Cursor For calculate Downtime Brokerage-----------                             
                            
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)),                                                                
Problem into #downtime from newtab1 with(nolock) where dt >= CONVERT(datetime,@fdate,105) and dt <= CONVERT(datetime,@fdate,105)    
group by Location,ImpactedSegemnt,problem                                                             
                            
select Top 0 server,segment, brokerage,space(40) as dt,space(40) as uptime,                            
space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges                             
into #temp_cal from #ser_brok                                  
                          
                            
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50),@issues as varchar(100)                                                                
DECLARE authors_cursor CURSOR FOR select Location,ImpactedSegemnt,Downtimemin,Problem from #downtime where Impactedsegemnt <> 'None'                                                                 
                                                             
OPEN authors_cursor                                                                                      
                                                                                    
FETCH NEXT FROM authors_cursor                                                    
INTO @location,@segment,@downtime,@issues                                                                                      
             
WHILE @@FETCH_STATUS = 0                              
BEGIN                          
                                                                
                                                 
if @segment = 'NCDEX'                                        
 Begin                                                                                
insert into #temp_cal                                                 
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                 
@issues,@segment from #downtime a inner join #ser_brok b on                                                       
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                                                 
 End                       
                                                                                    
if @segment = 'MCX'                                                                                                 
Begin                                                                                
   insert into #temp_cal                                                             
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,@issues,@segment from #downtime a inner join #ser_brok b on                                              
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                                                                                       
 end                                                                                
                                                                                
if @segment = 'BSECM'                                                                                     
 Begin                                                                                   
   insert into #temp_cal                                                                                      
select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                                                      
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                                       
   case when a.impactedsegemnt = 'BSECM' then 'ABLCM' end = b.segment and @location = b.server                                                                                       
 end                                                                                
                                                                                
if @segment = 'NSEFO'                                                                                         
 Begin                                                                                   
   insert into #temp_cal                                                                                      
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                                                      
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                                       
   case when a.impactedsegemnt = 'NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                                                                       
 end                                                                                
                                                                                
if @segment = 'NSECM'                                                                                         
 Begin                                                                                       
   insert into #temp_cal                                                                                      
   select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                                
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                                       
   case when a.impactedsegemnt = 'NSECM' then 'ACDLCM' end = b.segment and @location = b.server                                         
 end          
         
 ----Zeba        
 if @segment = 'NSECD'                                                                                         
 Begin                                                                                       
   insert into #temp_cal                                                                                      
   select @location,'ACDLNSX',b.brokerage,@downtime,'','',@fdate,                                                                                      
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                                       
   case when a.impactedsegemnt = 'NSECD' then 'ACDLNSX' end = b.segment and @location = b.server                                         
 end                  
----Zeba        
        
              
if @segment = 'MCXSX'                                                                                         
 Begin                                  
   insert into #temp_cal                                                                                      
   select @location,'ACDLNSX',b.brokerage,@downtime,'','',@fdate,                                                                                      
   @issues,@segment from #downtime a inner join #ser_brok b on                       
   case when a.impactedsegemnt = 'MCXSX' then 'ACPLMCD' end = b.segment and @location = b.server                                         
 end                
              
if @segment = 'MCXCD'                                                                                         
 Begin                                                                                       
   insert into #temp_cal                                                                                      
   select @location,'ACPLMCD',b.brokerage,@downtime,'','',@fdate,                                                                                      
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                                       
   case when a.impactedsegemnt = 'MCXCD' then 'ACPLMCD' end = b.segment and @location = b.server                                         
 end                 
              
                                                                            
                                                                
 FETCH NEXT FROM authors_cursor                                                                                       
 INTO @location,@segment,@downtime,@issues                                                                                      
END                                                                                      
                                                                                      
CLOSE authors_cursor                                                                     
DEALLOCATE authors_cursor                                                 
                                 
                            
------------------------------Cursor End------------                            
                                         
                            
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX),ACDLNSX=sum(ACDLNSX),ACPLMCD=sum(ACPLMCD)                                   
into #tt from sett_mst with(nolock) where tdate = @fdate                               
                            
select distinct * into #act_calc from #temp_cal                            
                            
insert into #act_calc                            
select *,0,0,0,@fdate,'','' from #ser_brok x where not exists                            
(select * from #temp_cal y where x.server = y.server and x.Segment = y.segment)                     
                  
-----------------------Segment Not In                   
select *,            
segment =             
case        
when ImpactedSegemnt = 'NSECD' then 'ACDLNSX' ---Zeba          
when ImpactedSegemnt = 'BSECM' then 'ABLCM'            
when ImpactedSegemnt = 'MCX' then 'ACPLMCX'            
when ImpactedSegemnt = 'NCDEX' then 'ACPLNCDEX'            
when ImpactedSegemnt = 'NSEFO' then 'ACDLFO'            
when ImpactedSegemnt = 'NSECM' then 'ACDLCM'            
when ImpactedSegemnt = 'MCXCD' then 'ACPLMCD'            
when ImpactedSegemnt = 'MCXSX' then 'ACPLMCD' end into #segment            
from #downtime            
            
            
insert into #act_calc                    
select distinct Fld_Id,Fld_Segment,0,isnull(Downtimemin,0),0,0,@fdate,isnull(problem,''),isnull(y.impactedSegemnt,'') from            
(            
select distinct Fld_Id,Fld_Segment from #Terminal_id x where not exists                            
(select * from #act_calc y where x.Fld_Id = y.server and x.Fld_Segment = y.segment)            
)x            
left outer join            
(select * from #segment) y on x.Fld_Id = y.location and x.Fld_Segment = y.segment            
                            
update #act_calc set uptime = (select bse from #tt) where segment = 'ABLCM'                                                                
update #act_calc set uptime = (select cm from #tt) where segment = 'ACDLCM'                             
update #act_calc set uptime = (select fo from #tt) where segment = 'ACDLFO'                                                                
update #act_calc set uptime = (select mcx from #tt) where segment = 'ACPLMCX'               
update #act_calc set uptime = (select ncdex from #tt) where segment = 'ACPLNCDEX'                                     
update #act_calc set uptime = (select ACDLNSX from #tt) where segment = 'ACDLNSX'                                             
update #act_calc set uptime = (select ACPLMCD from #tt) where segment = 'ACPLMCD'                             
                            
delete from terminal_brok_loss where sauda_date = @fdate                            
                            
insert into terminal_brok_loss                            
select  server, segment, Brokerage, dt, uptime,                         
case when  uptime <> 0 then                        
(((convert(dec,dt)/convert(dec,uptime))*100)*(convert(dec,Brokerage)))/100                        
else 0 end,                            
sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #act_calc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_11_Downtime
-- --------------------------------------------------
CREATE Proc [dbo].[USP_BROK_LOSS_NEW_11_Downtime](@fdate as varchar(11))                  
as                
              
--declare @fdate as varchar(11)  
set @fdate = convert(datetime,@fdate,103)                              
--set @fdate = 'May 20 2009'                              
          
-----------------------Fetch Brokerage----------                                                      
select company,Terminal_id,Brokerage=sum(Brokerage)                                                                                                    
into #terminal_brok                                                       
--from mis_terminal_brok where sauda_date >= @fdate and                                                       
from intranet.bsedb_ab.dbo.mis_to_terminal  where sauda_date = @fdate and                                                       
sauda_date <= @fdate group by company,Terminal_id                   
                  
------------------------Get Details of All servers upto for that day---------------                  
select * into #Terminal_id from V_Manager_Details where @fdate = sdate and @fdate = tdate                  
                  
-------------------------Server wise Brokerage--------------                  
                  
select y.Fld_Id as Server,x.company as segment,sum(x.brokerage) as brokerage into #ser_brok  from #terminal_brok x,                                                    
(select * from #Terminal_id with(nolock) where @fdate = sdate and @fdate = tdate) y where x.Terminal_id=y.Fld_Manager_id                                                    
group by y.Fld_Id,x.company                  
                  
------------------------Details for not traded server                  
insert into #ser_brok                  
select Distinct Fld_id,Fld_segment,0 from #Terminal_id x where not exists                  
(select * from #ser_brok y where x.Fld_id = y.server)                  
                  
-----------------------Cursor For calculate Downtime Brokerage-----------                   
                  
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)),                                                      
Problem into #downtime from newtab1 with(nolock) where dt = @fdate and dt = @fdate                                                      
group by Location,ImpactedSegemnt,problem                                                   
                  
select Top 0 server,segment, brokerage,space(40) as dt,space(40) as uptime,                  
space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges                   
into #temp_cal from #ser_brok                        
                
                  
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50),@issues as varchar(100)                                                      
DECLARE authors_cursor CURSOR FOR select Location,ImpactedSegemnt,Downtimemin,Problem from #downtime where Impactedsegemnt <> 'None'                                                       
                                                   
OPEN authors_cursor                                                                            
                                                                          
FETCH NEXT FROM authors_cursor                                          
INTO @location,@segment,@downtime,@issues                                                                            
                                                                            
WHILE @@FETCH_STATUS = 0                                                                            
BEGIN                                                        
                                                      
                                                              
if @segment = 'NCDEX'                                                                      
 Begin                                                                      
insert into #temp_cal                                       
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,       
@issues,@segment from #downtime a inner join #ser_brok b on                                             
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                                       
 End             
                                                                          
if @segment = 'MCX'                                                                                       
Begin                                                                      
   insert into #temp_cal                                                   
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,@issues,@segment from #downtime a inner join #ser_brok b on                                    
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                                                                             
 end                                                                      
                                                                      
if @segment = 'BSECM'                                                                           
 Begin                                                                         
   insert into #temp_cal                                                                            
select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                                            
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                             
   case when a.impactedsegemnt = 'BSECM' then 'ABLCM' end = b.segment and @location = b.server                                                                             
 end                                                                      
                                                                      
if @segment = 'NSEFO'                                                                               
 Begin                                                                         
   insert into #temp_cal                                                                            
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                                            
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                             
   case when a.impactedsegemnt = 'NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                                                             
 end                                                                      
                                                                      
if @segment = 'NSECM'                                                                               
 Begin                                                                             
   insert into #temp_cal                                                                            
   select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                                            
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                             
   case when a.impactedsegemnt = 'NSECM' then 'ACDLCM' end = b.segment and @location = b.server                               
 end       
    
if @segment = 'MCXSX'                                                                               
 Begin                                                                             
   insert into #temp_cal                                                                            
   select @location,'ACDLNSX',b.brokerage,@downtime,'','',@fdate,                                                                            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'MCXSX' then 'ACDLNSX' end = b.segment and @location = b.server                               
 end      
    
if @segment = 'MCXCD'                                                                               
 Begin                                                                             
   insert into #temp_cal                                                                            
   select @location,'ACPLMCD',b.brokerage,@downtime,'','',@fdate,                                                                            
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                             
   case when a.impactedsegemnt = 'MCXCD' then 'ACPLMCD' end = b.segment and @location = b.server                               
 end       
    
                                                                  
                                                      
 FETCH NEXT FROM authors_cursor                                                                             
 INTO @location,@segment,@downtime,@issues                                                                            
END                                                                            
                                                                            
CLOSE authors_cursor                                                           
DEALLOCATE authors_cursor                                       
                       
                  
------------------------------Cursor End------------                  
                               
                  
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX),ACDLNSX=sum(ACDLNSX),ACPLMCD=sum(ACPLMCD)                         
into #tt from sett_mst with(nolock) where tdate = @fdate                     
                  
select distinct * into #act_calc from #temp_cal                  
                  
insert into #act_calc                  
select *,0,0,0,@fdate,'','' from #ser_brok x where not exists                  
(select * from #temp_cal y where x.server = y.server and x.Segment = y.segment)           
        
-----------------------Segment Not In         
select *,  
segment =   
case   
when ImpactedSegemnt = 'BSECM' then 'ABLCM'  
when ImpactedSegemnt = 'MCX' then 'ACPLMCX'  
when ImpactedSegemnt = 'NCDEX' then 'ACPLNCDEX'  
when ImpactedSegemnt = 'NSEFO' then 'ACDLFO'  
when ImpactedSegemnt = 'NSECM' then 'ACDLCM'  
when ImpactedSegemnt = 'MCXCD' then 'ACPLMCD'  
when ImpactedSegemnt = 'MCXSX' then 'ACDLNSX' end into #segment  
from #downtime  
  
  
insert into #act_calc          
select distinct Fld_Id,Fld_Segment,0,isnull(Downtimemin,0),0,0,@fdate,isnull(problem,''),isnull(y.impactedSegemnt,'') from  
(  
select distinct Fld_Id,Fld_Segment from #Terminal_id x where not exists                  
(select * from #act_calc y where x.Fld_Id = y.server and x.Fld_Segment = y.segment)  
)x  
left outer join  
(select * from #segment) y on x.Fld_Id = y.location and x.Fld_Segment = y.segment  
                  
update #act_calc set uptime = (select bse from #tt) where segment = 'ABLCM'                                                      
update #act_calc set uptime = (select cm from #tt) where segment = 'ACDLCM'                   
update #act_calc set uptime = (select fo from #tt) where segment = 'ACDLFO'                                                      
update #act_calc set uptime = (select mcx from #tt) where segment = 'ACPLMCX'                                   
update #act_calc set uptime = (select ncdex from #tt) where segment = 'ACPLNCDEX'                           
update #act_calc set uptime = (select ACDLNSX from #tt) where segment = 'ACDLNSX'                                   
update #act_calc set uptime = (select ACPLMCD from #tt) where segment = 'ACPLMCD'                   
                  
--delete from terminal_brok_loss where sauda_date = @fdate                  
                  
insert into terminal_brok_loss                  
select  server, segment, Brokerage, dt, uptime,               
case when  uptime <> 0 then              
(((convert(dec,dt)/convert(dec,uptime))*100)*(convert(dec,Brokerage)))/100              
else 0 end,                  
sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #act_calc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_12
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_12(@fdate as varchar(11))                            
as                                                                        
                            
set @fdate = convert(datetime,@fdate,103)                
                            
-----------------------Fetch Brokerage----------                            
select company,Terminal_id,Brokerage=sum(Brokerage)                                                                          
into #terminal_brok                             
--from mis_terminal_brok where sauda_date >= @fdate and                             
from intranet.bsedb_ab.dbo.mis_to_terminal  where sauda_date >= @fdate and                             
sauda_date <= @fdate group by company,Terminal_id          
                            
---------------------Market Time-----------------                            
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                                                                           
into #tt from sett_mst with(nolock) where tdate = @fdate                            
                            
---------------------Downtime --------------------                            
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)),                            
Problem into #downtime from newtab1 with(nolock) where dt >= @fdate and dt <= @fdate                            
group by Location,ImpactedSegemnt,problem                                                     
    
   
select y.Fld_Id as Server,x.* into #a from #terminal_brok x,                          
(select * from V_Manager_Details with(nolock) where @fdate >= sdate and @fdate <= tdate) y where x.Terminal_id=y.Fld_Manager_id                          
                            
--------------------------Affected Server Brokerage---------------                            
    
select server,company as segment,brokerage=sum(brokerage) into #ser_brok from #a where /*edate is null and*/ server  in                             
(select Location from #downtime where Impactedsegemnt <> 'None') group by server,company  order by server                             
                    
-----------------------------Data for trade not done in affected server-------------------------                      
    
--------Comment By Mangesh  
/*  
insert into #ser_brok                    
select Fld_Id,Fld_segment,0 from V_Manager_Details where Fld_Manager_id not in (select Terminal_id from #a )                     
and Fld_Id in (select distinct location from #downtime) and convert(varchar,Fld_Id)+Fld_segment not in                      
(select distinct convert(varchar,server)+company from #a)                    
*/  
  
    
insert into #ser_brok                    
select distinct Fld_Id,Fld_segment,0 from V_Manager_Details where Fld_Manager_id not in (  
select Fld_Manager_id from V_Manager_Details with(nolock) where @fdate >= sdate and @fdate <= tdate  
)   
    
                            
--------------------------insert data in temp table--------------                            
select Top 0 #a.server,#a.company as segment, #a.brokerage,space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,                            
space(40) as Issues,space(100) as Exchanges into #temp_cal from #a                            
    
                            
--------------------------------Cursor for Updating temp table --------------------------                            
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50),@issues as varchar(100)                            
DECLARE authors_cursor CURSOR FOR select Location,ImpactedSegemnt,Downtimemin,Problem from #downtime where Impactedsegemnt <> 'None'                             
                         
OPEN authors_cursor                                                  
                                                  
FETCH NEXT FROM authors_cursor                
INTO @location,@segment,@downtime,@issues                                                  
                                                  
WHILE @@FETCH_STATUS = 0                                                  
BEGIN                              
                            
                                    
if @segment = 'NCDEX'                                            
 Begin                                            
   insert into #temp_cal             
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                  
@issues,@segment from #downtime a inner join #ser_brok b on                   
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                        
 End                                            
                                                
if @segment = 'MCX'                                                             
 Begin                                            
   insert into #temp_cal                                                  
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,@issues,@segment from #downtime a inner join #ser_brok b on                                                   
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                                                   
 end                                            
                                            
if @segment = 'BSECM'                                                 
 Begin                                               
   insert into #temp_cal                                                  
select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                  
   @issues,@segment from #downtime a inner join #ser_brok b on                                                   
   case when a.impactedsegemnt = 'BSECM' then 'ABLCM' end = b.segment and @location = b.server                                                   
 end                                            
                                            
if @segment = 'NSEFO'                                                     
 Begin                                               
   insert into #temp_cal                                                  
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                  
   @issues,@segment from #downtime a inner join #ser_brok b on                                                   
   case when a.impactedsegemnt = 'NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                                   
 end                                            
                                            
if @segment = 'NSECM'                                                     
 Begin                                                   
   insert into #temp_cal                                                  
   select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                  
   @issues,@segment from #downtime a inner join #ser_brok b on                                                   
   case when a.impactedsegemnt = 'NSECM' then 'ACDLCM' end = b.segment and @location = b.server                                                     
 end                                           
                            
 FETCH NEXT FROM authors_cursor                                                   
 INTO @location,@segment,@downtime,@issues                                                  
END                                                  
                                                  
CLOSE authors_cursor                                                  
DEALLOCATE authors_cursor             
                            
--------------------------------------Cursor End--------------------------------------------------                            
                            
-----------------------------------Updating temp table for not affected server---------------------------                            
                            
insert into #temp_cal                            
select server,company,sum(brokerage),'','','','','',''  from #a where rtrim(ltrim(server))+rtrim(ltrim(company)) not in                            
(select rtrim(ltrim(server))+rtrim(ltrim(segment)) from #temp_cal where server in                             
(select Location from #downtime where Impactedsegemnt <> 'None')) /*and sdate <= @fdate or  Sdate is null*/ group by server,company  order by server                                    
                  
-----------------------------------New changes for No Trade and No Downtime  June 28 2007-------------------------                  
    
/*                  
insert into #temp_cal                            
select server,segment,0,'','','','','','' from terminals where Odin_id not in (select Terminal_id from #a )                     
and server in (select distinct location from #downtime) and server+segment not in  (select distinct server+company from #a )                    
*/    
insert into #temp_cal                            
select Fld_Id,Fld_segment,0,'','','','','','' from V_Manager_Details where Fld_Manager_Id not in (select Terminal_id from #a )                     
and Fld_Id in (select distinct location from #downtime) and convert(varchar,Fld_Id)+Fld_segment not in  (select distinct convert(varchar,server)+company from #a )                    
    
/*               
insert into #temp_cal                            
select Distinct server,segment,0,'','','','','','' from terminals where server+segment not in (select server+company from #a)                
and @fdate >= sdate and @fdate <= edate and server in (select distinct server from #a)                
*/    
    
insert into #temp_cal                            
select Distinct Fld_Id,Fld_segment,0,'','','','','','' from V_Manager_Details where convert(varchar,Fld_Id)+Fld_segment     
not in (select convert(varchar,server)+company from #a)                
and @fdate >= sdate and @fdate <= tdate and Fld_Id in (select distinct server from #a)                              
                  
----------------------------------------------------------------------------------------------------                  
                            
update #temp_cal set uptime = (select bse from #tt) where segment = 'ABLCM'                            
update #temp_cal set uptime = (select cm from #tt) where segment = 'ACDLCM'                            
update #temp_cal set uptime = (select fo from #tt) where segment = 'ACDLFO'                            
update #temp_cal set uptime = (select mcx from #tt) where segment = 'ACPLMCX'                            
update #temp_cal set uptime = (select ncdex from #tt) where segment = 'ACPLNCDEX'                            
                            
update #temp_cal set sauda_date = @fdate                            
                            
update #temp_cal set dt = 0 where dt = ''                                                    
delete terminal_brok_loss  where sauda_date = @fdate                            
              
-- insert into terminal_brok_loss                            
-- select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(convert(money,Brokerage)/case when (convert(int,uptime)-convert(int,dt)) = 0 then 1 else (convert(int,uptime)-convert(int,dt)) end)*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal                            
              
-- insert into terminal_brok_loss                            
-- select distinct server, segment, Brokerage, dt, uptime,Brk_Loss= case when convert(int,dt) >= convert(int,uptime) then  convert(money,Brokerage)               
-- else ((convert(money,Brokerage))/(convert(int,uptime)-convert(int,dt)))*convert(int,dt)              
-- end,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal                            
              
insert into terminal_brok_loss                
select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(((convert(dec,dt)/convert(dec,uptime))*100)*(convert(dec,Brokerage)))/100,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal             
where  convert(dec,dt) <> 0 and convert(dec,uptime) <> 0                        
    
insert into terminal_brok_loss                            
select distinct server, segment, Brokerage, dt, uptime,0,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal             
where  convert(dec,dt) = 0 and convert(dec,(case when uptime='' then 0 else uptime end)) = 0                        
            
insert into terminal_brok_loss                              
select distinct server, segment, Brokerage, dt, uptime,0,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal             
where  convert(dec,dt) = 0 and convert(dec,(case when uptime='' then 0 else uptime end)) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_13
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_13(@fdate as varchar(11))                                    
as       
    


                                                                                                
set @fdate = convert(datetime,@fdate,103)            
                                    
-----------------------Fetch Brokerage----------                                    
select company,Terminal_id,Brokerage=sum(Brokerage)                                                                                  
into #terminal_brok                                     
--from mis_terminal_brok where sauda_date >= @fdate and                                     
from intranet.bsedb_ab.dbo.mis_to_terminal  where sauda_date >= @fdate and                                     
sauda_date <= @fdate group by company,Terminal_id                  
                                    
---------------------Market Time-----------------                                    
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                                                                                   
into #tt from sett_mst with(nolock) where tdate = @fdate                                    
                                    
---------------------Downtime --------------------                                    
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)),                                    
Problem into #downtime from newtab1 with(nolock) where dt >= @fdate and dt <= @fdate                                    
group by Location,ImpactedSegemnt,problem                                                             


select * into #ser_not from V_server_master where Fld_id in
(
select Fld_id from V_Manager_Details with(nolock) where @fdate >= sdate and @fdate <= tdate
)            
           
select y.Fld_Id as Server,x.* into #a from #terminal_brok x,                                  
(select * from V_Manager_Details with(nolock) where @fdate >= sdate and @fdate <= tdate) y where x.Terminal_id=y.Fld_Manager_id                                  
                                    
--------------------------Affected Server Brokerage---------------                                    
            
select server,company as segment,brokerage=sum(brokerage) into #ser_brok from #a where /*edate is null and*/ server  in                                     
(select Location from #downtime where Impactedsegemnt <> 'None') group by server,company  order by server               
            
                                    
--------------------------insert data in temp table--------------                                    
select Top 0 #a.server,#a.company as segment, #a.brokerage,space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,                                    
space(40) as Issues,space(100) as Exchanges into #temp_cal from #a                                    
            
                                    
--------------------------------Cursor for Updating temp table --------------------------                                    
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50),@issues as varchar(100)                                    
DECLARE authors_cursor CURSOR FOR select Location,ImpactedSegemnt,Downtimemin,Problem from #downtime where Impactedsegemnt <> 'None'                                     
                                 
OPEN authors_cursor                                                          
                                                        
FETCH NEXT FROM authors_cursor                        
INTO @location,@segment,@downtime,@issues                                                          
                                                          
WHILE @@FETCH_STATUS = 0                                                          
BEGIN                                      
                                    
                                            
if @segment = 'NCDEX'                                                    
 Begin                                                    
   insert into #temp_cal                     
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                          
@issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                                
 End                                                    
                                                        
if @segment = 'MCX'                                                                     
 Begin                                                    
   insert into #temp_cal                                                          
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,@issues,@segment from #downtime a inner join #ser_brok b on                                                           
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                                                           
 end                                                    
                                                    
if @segment = 'BSECM'                                                         
 Begin                                                       
   insert into #temp_cal                                                          
select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                          
   @issues,@segment from #downtime a inner join #ser_brok b on                                                           
   case when a.impactedsegemnt = 'BSECM' then 'ABLCM' end = b.segment and @location = b.server                                                           
 end                                                    
                                                    
if @segment = 'NSEFO'                                                             
 Begin                                                       
   insert into #temp_cal                                                          
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                          
   @issues,@segment from #downtime a inner join #ser_brok b on                                                           
   case when a.impactedsegemnt = 'NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                                           
 end                                                    
                                                    
if @segment = 'NSECM'                                                             
 Begin                                                           
   insert into #temp_cal                                                          
   select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                          
   @issues,@segment from #downtime a inner join #ser_brok b on                                                           
   case when a.impactedsegemnt = 'NSECM' then 'ACDLCM' end = b.segment and @location = b.server             
 end                                                   
                                    
 FETCH NEXT FROM authors_cursor                                                           
 INTO @location,@segment,@downtime,@issues                                                          
END                                                          
                                                          
CLOSE authors_cursor                                         
DEALLOCATE authors_cursor                     
                                    
--------------------------------------Cursor End--------------------------------------------------                                    
                                    
-----------------------------------Updating temp table for not affected server---------------------------        
      
                                    
insert into #temp_cal                                    
select server,company,sum(brokerage),'','','','','',''  from #a where rtrim(ltrim(server))+rtrim(ltrim(company)) not in                                    
(select rtrim(ltrim(server))+rtrim(ltrim(segment)) from #temp_cal where server in                                     
(select Location from #downtime where Impactedsegemnt <> 'None')) /*and sdate <= @fdate or  Sdate is null*/ group by server,company  order by server                                            
                          
-----------------------------------New changes for No Trade and No Downtime  June 28 2007-------------------------                          
            
      
insert into #temp_cal                                    
select Fld_Id,Fld_segment,0,'','','','','','' from V_Manager_Details where Fld_Manager_Id not in (select Terminal_id from #a )                             
and Fld_Id in (select distinct location from #downtime) and convert(varchar,Fld_Id)+Fld_segment not in  (select distinct convert(varchar,server)+company from #a )                                 
      
insert into #temp_cal                                    
select Distinct Fld_Id,Fld_segment,0,'','','','','','' from V_Manager_Details where convert(varchar,Fld_Id)+Fld_segment             
not in (select convert(varchar,server)+company from #a)                        
and @fdate >= sdate and @fdate <= tdate and Fld_Id in (select distinct server from #a)                                          
      
insert into #temp_cal        
select distinct Fld_Id,Fld_segment,0,'','','','','','' from V_Manager_Details where Fld_Manager_id not in (        
select Fld_Manager_id from V_Manager_Details with(nolock) where @fdate >= sdate and @fdate <= tdate  ) and status = 'ACTIVE'        
  
  
insert into #temp_cal  
select distinct Fld_Id,Fld_Segment,0,'','','','','','' from V_Manager_Details where Fld_id in
(                       
select Fld_Id from #ser_not where Fld_id not in
(select server from #a)
) and status = 'active'
                          
----------------------------------------------------------------------------------------------------                          
                                    
update #temp_cal set uptime = (select bse from #tt) where segment = 'ABLCM'                                    
update #temp_cal set uptime = (select cm from #tt) where segment = 'ACDLCM'                                    
update #temp_cal set uptime = (select fo from #tt) where segment = 'ACDLFO'                                    
update #temp_cal set uptime = (select mcx from #tt) where segment = 'ACPLMCX'                                    
update #temp_cal set uptime = (select ncdex from #tt) where segment = 'ACPLNCDEX'         
  
                                    
update #temp_cal set sauda_date = @fdate                                    
                                   
update #temp_cal set dt = 0 where dt = ''                                                            
delete terminal_brok_loss  where sauda_date = @fdate                                                   
                      
/*      
select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(((convert(dec,dt)/convert(dec,uptime))*100)*(convert(dec,Brokerage)))/100,sauda_date=convert(datetime,sauda_date),Issues,Exchanges     
--into #cal     
from #temp_cal         
*/    
    
insert into terminal_brok_loss                      
select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(((convert(dec,dt)/convert(dec,uptime))*100)*(convert(dec,Brokerage)))/100,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal                   
where  convert(dec,dt) <> 0 and convert(dec,uptime) <> 0                              
          
insert into terminal_brok_loss                                  
select distinct server, segment, Brokerage, dt, uptime,0,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal                   
where  convert(dec,dt) = 0 and convert(dec,(case when uptime='' then 0 else uptime end)) = 0                              
                  
insert into terminal_brok_loss                                    
select distinct server, segment, Brokerage, dt, uptime,0,sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal                   
where  convert(dec,dt) = 0 and convert(dec,(case when uptime='' then 0 else uptime end)) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_2
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_2             
(@fdate as varchar(15),@tdate as varchar(15),@segment as varchar(25),@issues as varchar(200))                                                
as                                      
                                                
set nocount on                                      
                                      
declare @ttime as int                                        
declare @str as varchar(500)                                        
declare @str1 as varchar(500)                                        
declare @tname as varchar(25)                                            
declare @opt as varchar(25)                                            
declare @issues1 as varchar(25)  
-- declare @fdate as varchar(15)                                        
-- declare @tdate as varchar(15)                                        
-- declare @segment as varchar(25)                                       
-- set @segment = 'NCDEX'                                        
-- set @fdate = 'Mar 1 2006'                                        
-- set @tdate = 'Mar 13 2007'                                        
-- set @segment = 'BSE_+_CM_+_FO'                                      
                                        
Set @tname = (Select                                                       
 (case                                                       
 when @segment = 'BSE' then '''ABLCM'''                                                       
 when @segment = 'NSE' then '''ACDLCM'''                                        
 when @segment = 'FO' then '''ACDLFO'''                                                                      
 when @segment = 'All_Exchanges' then  '%'                                                       
 when @segment = 'ALL' then  '%'                      
 when @segment = 'BSE_+_CM_+_FO'then  '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                                                        
 when @segment = 'CM_+_FO' then  '''ACDLCM'''+','+'''ACDLFO'''                                        
 when @segment = 'MCX' then '''ACPLMCX'''                                                       
 when @segment = 'NCDEX' then '''ACPLNCDEX'''                                        
 when @segment = 'MCX_+_NCDEX' then  '''MCX'''+','+'''NCDEX'''                                                      
 else '''NONE''' end))                                                     
--print @tname                   
  
set   @opt = (select  
(case  
when @issues = 'All' then 'like' else '=' end  
) )                          
  
set   @issues1 = (select  
(case  
when @issues = 'All' then '%' else @issues end  
) )                          
  
  
                      
                                    
select Top 0 Total=convert(int,sum(BSE+CM+FO))  into #Ttime  from sett_mst where tdate >= 'Mar 1 2006 00:00:000' and tdate <= 'Mar 13 2007 23:59:000'                                    
select Top 0 loc=location,downtime=sum(convert(int,downtimemin)) into  #downtime from newtab1 where dt  >= 'Mar 1 2006 00:00:000' and dt <= 'Mar 13 2007 23:59:000' and Impactedsegemnt = 'BSE' group by location                                         
                                    
if @tname = '''ABLCM'''                                    
begin                                    
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''BSE'' and Problem '+@opt+' '''+@issues1+'''  group by location')        
                               
end                                     
                                    
if @tname = '''ACDLCM'''                                    
begin                                    
    set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''CM'' and Problem '+@opt+' '''+@issues1+'''  group by location')       
                                
end                                     
              
if @tname = '''ACDLFO'''                                    
begin                                                      
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''FO'' and Problem '+@opt+' '''+@issues1+'''  group by location')         
                              
end                       
              
if @tname = '''ACPLMCX'''                                    
begin                                            
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''MCX'' and Problem '+@opt+' '''+@issues1+'''  group by location')        
                               
end                                     
              
if @tname = '''ACPLNCDEX'''                                    
begin                                     
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''NCDEX'' and Problem '+@opt+' '''+@issues1+'''  group by location')      
                                 
end                                     
                                    
if @tname = '''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'''                                       
begin                                     
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''BSE + CM + FO'' and Problem '+@opt+' '''+@issues1+'''  group by location
')                                       
    
     
end                                     
                    
if @tname = '''MCX'''+','+'''NCDEX'''                                       
begin      
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''MCX + NCDEX''  and Problem '+@opt+' '''+@issues1+'''  group by location'
)                                       
end                                     
                                    
if @tname = '''ACDLCM'''+','+'''ACDLFO'''                                       
begin                                    
  set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''CM + FO''  and Problem '+@opt+' '''+@issues1+'''  group by location')   
                                    
end                                     
                           
if @tname = '%'                                       
begin                                     
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt like ''%'' and Problem '+@opt+' '''+@issues1+'''  group by location')        
                               
end             
          
if @segment = 'All_Exchanges'                                       
begin                               
 set @str1 = ('select location,downtime=sum(convert(int,downtimemin)) from newtab1 where dt >= '''+@fdate+' 00:00:000'''+' and dt <= '''+@tdate+' 23:59:000'' and Impactedsegemnt = ''All Exchanges'' and Problem '+@opt+' '''+@issues1+'''  group by location'
)                                       
   
end             
                   
if @tname = 'NONE'                                       
begin                                    
 set @str = ('select Total=sum(0) from sett_mst')                                      
end   
          
insert into #downtime              
exec (@str1)           
      
set @str = ('select Total=isnull(convert(int,sum(bse+cm+FO+mcx+ncdex)/5),0) from sett_mst where tdate >= '''+@fdate+' 00:00:000'''+' and tdate <= '''+@tdate+' 23:59:000''')                                                                
insert into  #Ttime                                    
exec (@str)                                      
                         
                                      
select Top 0 Terminal_id,Brokeage=isnull(sum(Brokerage),0) into #t from terminal_brok  where sauda_date >= 'Mar 1 2007' and                                       
sauda_date <= 'Mar 01 2007' and company like '%' group by Terminal_id                                        
      
set @str = ('select Terminal_id,Brokeage=isnull(sum(Brokerage),0) from terminal_brok  where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and company like ''%'' group by Terminal_id')                                        
                                       
insert into #t                                        
exec (@str)              
                          
--select * from terminals                          
                                               
select server=replace(a.server,'KARAD','BOK'),brokeage=isnull(sum(b.brokeage),0) into #b                                        
from terminals a inner join #t b on a.Odin_id = b.terminal_id                           
--and server like replace(@location,'All','%')+'%'                           
where brokeage <> 0  group by a.server                                                    
                                               
set @ttime = (select * from #Ttime)                                                            
                          
select Top 0 a.location,downtime=isnull(sum(convert (int,downtimemin)),0),Pecentage=isnull((sum(convert (dec,downtimemin))/@ttime)*100,0),                        
Brok_Loss=isnull(((b.brokeage/@ttime)*sum(convert (int,downtimemin))),0) into #dtime from NewTAb1 a left outer join #b b                         
on a.location = b.server where dt >= 'Jan 01 2007' and dt <= 'Jan 01 2007' group by location,brokeage order by Location                                        
                           
insert into #dtime                           
select server=a.loc,a.downtime,Pecentage=isnull((sum(convert (dec,a.downtime))/@ttime)*100,0),          
Brok_Loss=isnull(((b.brokeage/(@ttime-a.downtime))*sum(convert (int,a.downtime))),0)          
from #downtime a left outer join #b b on a.loc = b.server                                    
group by loc,downtime,brokeage                                       
--  end                                                
                     
truncate table Brokerage_Loss                                 
                                              
insert into Brokerage_Loss                                
select location,downtime,pecentage,brok_loss=isnull(brok_loss,0),total=100-pecentage from  #dtime                                      
                                  
--select * from  #dtime                                      
                                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_3
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_3(@fdate as varchar(15),@tdate as varchar(15),@issues as varchar(200))    
as    
    
declare @str as varchar(500)     
declare @opt as varchar(25)                                                  
declare @issues1 as varchar(25)     
--declare @issues as varchar(25)     
    
set   @opt = (select        
(case        
when @issues = 'All' then 'like' else '=' end        
) )                                
        
set   @issues1 = (select        
(case        
when @issues = 'All' then '%' else @issues end        
) )     
    
     
select Top 0 Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin))  into #downtime from newtab1  where dt >= 'Dec 13 2006' and dt <= 'Dec 13 2006' group by Location,ImpactedSegemnt      
    
set @str = ('select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)) from newtab1  where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Problem '+@opt+''''+@issues1+''' group by Location,ImpactedSegemnt')      
    
insert into #downtime    
exec (@str)    
    
    
select company,Terminal_id,Brokerage=sum(Brokerage)      
into #terminal_brok from terminal_brok where sauda_date >= @fdate and       
sauda_date <= @tdate group by company,Terminal_id      
    
select b.server,b.segment,Brokerage=sum(a.Brokerage) into #server from #terminal_brok a inner join terminals b       
on a.terminal_id = b.odin_id group by  server,segment      
    
select * into #ser_brok from #server  where server in (select location from  #downtime)      
      
select *, space(20) as dt,space(20) as uptime,space(20) as Brk_Loss into #t from #ser_brok       
     
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)       
into #tt from sett_mst where tdate >= @fdate and tdate <= @tdate    
      
update #t set uptime = bse from #tt where #t.segment = 'ABLCM'      
update #t set uptime = cm from #tt where #t.segment = 'ACDLCM'      
update #t set uptime = fo from #tt where #t.segment = 'ACDLFO'      
update #t set uptime = mcx from #tt where #t.segment = 'ACPLNCDEX'      
update #t set uptime = ncdex from #tt where #t.segment = 'ACPLMCX'      
  
-- update #t set Sauda_date = @fdate  
-- update #t set Issues = @issues  
    
------------------------------BSE--------------------------------------------      
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'BSE' THEN 'ABLCM' END  )    
    
------------------------------CM--------------------------------------------      
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'CM' THEN 'ACDLCM' END  )    
    
------------------------------FO--------------------------------------------      
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'FO' THEN 'ACDLFO' END  )    
    
------------------------------MCX--------------------------------------------      
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'MCX' THEN 'ACPLMCX' END  )    
    
------------------------------NCDEX--------------------------------------------      
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'NCDEX' THEN 'ACPLNCDEX' END  )    
    
    
-----------------------------ALL  Segments----------------------------------------     
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT LIKE CASE WHEN #downtime.ImpactedSegemnt = 'All Segments' THEN '%' END        
    
------------------------------CM+FO-------------------------------------------------    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLCM' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLFO' END)    
------------------------------BSE + CM + FO---------------------------------------    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ABLCM' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLCM' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLFO' END)    
    
---------------------------MCX + NCDEX-------------------------------------    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLMCX' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLNCDEX' END)    
    
------------------------------BSE +  MCX + NCDEX---------------------------    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ABLCM' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLMCX' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLNCDEX' END)    
    
------------------------------CM + FO + NCDEX-----------------------------    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLCM' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLFO' END)    
    
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACPLNCDEX' END)    
    
update #t set dt = 0 where dt = ''    
    
truncate table Terminal_Brok_Loss    
    
insert into Terminal_Brok_Loss    
select server, segment, Brokerage, dt, uptime, Brk_Loss=(convert(money,Brokerage)/(convert(int,uptime)-convert(int,dt)))*convert(int,dt) from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_4
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_4(@fdate as varchar(11),@tdate as varchar(11),@issues as varchar(200))                    
as                    
                    
            
-- declare @fdate as varchar(15)            
-- declare @tdate as varchar(15)            
declare @str as varchar(500)                     
declare @opt as varchar(25)                                                                  
declare @issues1 as varchar(100)                     
--declare @issues as varchar(100)                     
            
set @fdate = convert(datetime,@fdate,103)    
set @tdate = convert(datetime,@tdate,103)    
-- set @issues = 'Exchange connectivity issue'            
                    
set   @opt = (select                        
(case                        
when @issues = 'All' then 'like' else '=' end                        
) )                                                
                        
set   @issues1 = (select                        
(case                        
when @issues = 'All' then '%' else @issues end                        
) )                     
                    
                     
select Top 0 Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin))  into #downtime from newtab1  where dt >= 'Dec 13 2006' and dt <= 'Dec 13 2006' group by Location,ImpactedSegemnt                      
                    
set @str = ('select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)) from newtab1  where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Problem '+@opt+''''+@issues1+''' group by Location,ImpactedSegemnt')                      
--print @str            
                    
insert into #downtime                    
exec (@str)                    
                    
                    
select company,Terminal_id,Brokerage=sum(Brokerage)                      
into #terminal_brok from terminal_brok where sauda_date >= @fdate and                       
sauda_date <= @tdate group by company,Terminal_id                      
                    
select b.server,b.segment,Brokerage=sum(a.Brokerage) into #server from #terminal_brok a inner join terminals b                       
on a.terminal_id = b.odin_id group by  server,segment                      
                    
select * into #ser_brok from #server  where server in (select location from  #downtime)                      
                      
select *, space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges into #t from #ser_brok                       
                     
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                       
into #tt from sett_mst where tdate >= @fdate and tdate <= @tdate                    
                      
update #t set uptime = bse from #tt where #t.segment = 'ABLCM'                      
update #t set uptime = cm from #tt where #t.segment = 'ACDLCM'                      
update #t set uptime = fo from #tt where #t.segment = 'ACDLFO'                      
update #t set uptime = mcx from #tt where #t.segment = 'ACPLNCDEX'                      
update #t set uptime = ncdex from #tt where #t.segment = 'ACPLMCX'                      
                  
update #t set Sauda_date = @fdate                  
update #t set Issues = @issues                  
                    
------------------------------BSE--------------------------------------------                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'BSE' THEN 'ABLCM' END  )                    
                    
------------------------------CM--------------------------------------------                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'CM' THEN 'ACDLCM' END  )                    
                    
------------------------------FO--------------------------------------------            
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'FO' THEN 'ACDLFO' END  )                    
                    
------------------------------MCX--------------------------------------------             
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'MCX' THEN 'ACPLMCX' END  )                    
                    
------------------------------NCDEX--------------------------------------------                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'NCDEX' THEN 'ACPLNCDEX' END  )                    
                    
                    
-----------------------------ALL  Segments----------------------------------------                     
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT LIKE CASE WHEN #downtime.ImpactedSegemnt = 'All Segments' THEN '%' END                        
                    
------------------------------CM+FO-------------------------------------------------                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                  
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLCM' END)                    
                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLFO' END)                    
------------------------------BSE + CM + FO---------------------------------------                    
                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ABLCM' END)                    
                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLCM' END)                    
                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLFO' END)                    
                    
---------------------------MCX + NCDEX-------------------------------------                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLMCX' END)                    
                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLNCDEX' END)                    
                    
------------------------------BSE +  MCX + NCDEX---------------------------                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ABLCM' END)                    
                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLMCX' END)                    
                
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLNCDEX' END)                    
                    
------------------------------CM + FO + NCDEX-----------------------------                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLCM' END)                    
                    
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLFO' END)                    
        
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                      
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACPLNCDEX' END)                    
                    
update #t set dt = 0 where dt = ''                    
                    
--truncate table Terminal_Brok_Loss                 
            
delete from  Terminal_Brok_Loss  where sauda_date = @fdate and Issues = @issues            
                    
insert into Terminal_Brok_Loss                    
select server, segment, Brokerage, dt, uptime, Brk_Loss=(convert(money,Brokerage)/(convert(int,uptime)-convert(int,dt)))*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_5
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_5(@fdate as varchar(11),@tdate as varchar(11))                      
as                     
                      
              
-- declare @fdate as varchar(15)              
-- declare @tdate as varchar(15)              
declare @str as varchar(500)                       
declare @opt as varchar(25)                                                                    
declare @issues1 as varchar(100)                       
--declare @issues as varchar(100)                       
              
set @fdate = convert(datetime,@fdate,103)      
set @tdate = convert(datetime,@tdate,103)      
-- set @issues = 'Exchange connectivity issue'              
          
/*            
set   @opt = (select                          
(case                          
when @issues = 'All' then 'like' else '=' end                          
) )                                                  
                          
set   @issues1 = (select                          
(case                          
when @issues = 'All' then '%' else @issues end                          
) )                       
  */                    
                       
select Top 0 Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin))  into #downtime from newtab1  where dt >= 'Dec 13 2006' and dt <= 'Dec 13 2006' group by Location,ImpactedSegemnt                        
                      
set @str = ('select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)) from newtab1  where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' group by Location,ImpactedSegemnt')                        
--print @str              
                      
insert into #downtime                      
exec (@str)                      
                      
                      
select company,Terminal_id,Brokerage=sum(Brokerage)                        
into #terminal_brok from terminal_brok where sauda_date >= @fdate and                         
sauda_date <= @tdate group by company,Terminal_id                        
                      
select b.server,b.segment,Brokerage=sum(a.Brokerage) into #server from #terminal_brok a inner join terminals b                         
on a.terminal_id = b.odin_id group by  server,segment                        
                      
select * into #ser_brok from #server  where server in (select location from  #downtime)                        
                        
select *, space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges into #t from #ser_brok                         
                       
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                         
into #tt from sett_mst where tdate >= @fdate and tdate <= @tdate                      
                        
update #t set uptime = bse from #tt where #t.segment = 'ABLCM'                        
update #t set uptime = cm from #tt where #t.segment = 'ACDLCM'                        
update #t set uptime = fo from #tt where #t.segment = 'ACDLFO'                        
update #t set uptime = mcx from #tt where #t.segment = 'ACPLNCDEX'                        
update #t set uptime = ncdex from #tt where #t.segment = 'ACPLMCX'                        
                    
update #t set Sauda_date = @fdate                    
--update #t set Issues = @issues                    
                      
------------------------------BSE--------------------------------------------                        
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'BSE' THEN 'ABLCM' END  )                      
                      
------------------------------CM--------------------------------------------                        
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'CM' THEN 'ACDLCM' END  )                      
                      
------------------------------FO--------------------------------------------              
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'FO' THEN 'ACDLFO' END  )                      
                      
------------------------------MCX--------------------------------------------               
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'MCX' THEN 'ACPLMCX' END  )                      
                      
------------------------------NCDEX--------------------------------------------                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'NCDEX' THEN 'ACPLNCDEX' END  )                      
                      
                      
-----------------------------ALL  Segments----------------------------------------                       
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT LIKE CASE WHEN #downtime.ImpactedSegemnt = 'All Segments' THEN '%' END                          
                      
------------------------------CM+FO-------------------------------------------------                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                    
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLCM' END)                      
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLFO' END)                      
------------------------------BSE + CM + FO---------------------------------------                      
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ABLCM' END)                      
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLCM' END)                      
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLFO' END)                      
                      
---------------------------MCX + NCDEX-------------------------------------                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLMCX' END)                      
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLNCDEX' END)                      
                      
------------------------------BSE +  MCX + NCDEX---------------------------                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ABLCM' END)                      
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLMCX' END)                      
                  
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLNCDEX' END)                      
                      
------------------------------CM + FO + NCDEX-----------------------------                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLCM' END)                      
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLFO' END)                      
          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACPLNCDEX' END)                      
                      
update #t set dt = 0 where dt = ''                      
                      
--truncate table Terminal_Brok_Loss                   
              
delete from  Terminal_Brok_Loss  where sauda_date = @fdate /*and Issues = @issues              */
                      
insert into Terminal_Brok_Loss                      
select server, segment, Brokerage, dt, uptime, Brk_Loss=(convert(money,Brokerage)/(convert(int,uptime)-convert(int,dt)))*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_6
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_6(@fdate as varchar(11),@tdate as varchar(11),@issues as varchar(200))                          
as                          
                          
                  
-- declare @fdate as varchar(15)                  
-- declare @tdate as varchar(15)                  
declare @str as varchar(500)                           
declare @opt as varchar(25)                                                                        
declare @issues1 as varchar(100)                           
--declare @issues as varchar(100)                           
                  
set @fdate = convert(datetime,@fdate,103)          
set @tdate = convert(datetime,@tdate,103)          
-- set @issues = 'Exchange connectivity issue'                  
                          
set   @opt = (select                              
(case                              
when @issues = 'All' then 'like' else '=' end                              
) )                                                      
                              
set   @issues1 = (select                              
(case                              
when @issues = 'All' then '%' else @issues end                              
) )                           
                          
                           
select Top 0 Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin))  into #downtime from newtab1  where dt >= 'Dec 13 2006' and dt <= 'Dec 13 2006' group by Location,ImpactedSegemnt                            
                          
set @str = ('select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)) from newtab1  where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Problem '+@opt+''''+@issues1+''' group by Location,ImpactedSegemnt')                            
--print @str                  
                          
insert into #downtime                          
exec (@str)                          
                          
                          
select company,Terminal_id,Brokerage=sum(Brokerage)                            
into #terminal_brok from terminal_brok where sauda_date >= @fdate and                             
sauda_date <= @tdate group by company,Terminal_id                            
                          
select b.server,b.segment,Brokerage=sum(a.Brokerage) into #server from #terminal_brok a inner join terminals b                             
on a.terminal_id = b.odin_id group by  server,segment                            
                          
select * into #ser_brok from #server  where server in (select location from  #downtime)                            
                            
select *, space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges into #t from #ser_brok                             
                           
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                             
into #tt from sett_mst where tdate >= @fdate and tdate <= @tdate                          
                            
update #t set uptime = bse from #tt where #t.segment = 'ABLCM'                            
update #t set uptime = cm from #tt where #t.segment = 'ACDLCM'                            
update #t set uptime = fo from #tt where #t.segment = 'ACDLFO'                            
update #t set uptime = mcx from #tt where #t.segment = 'ACPLNCDEX'                            
update #t set uptime = ncdex from #tt where #t.segment = 'ACPLMCX'                            
                        
update #t set Sauda_date = @fdate                        
update #t set Issues = @issues                        
                          
------------------------------BSE--------------------------------------------                            
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'BSE' THEN 'ABLCM' END  )                          
                          
------------------------------CM--------------------------------------------                            
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'CM' THEN 'ACDLCM' END  )                          
                          
------------------------------FO--------------------------------------------                  
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'FO' THEN 'ACDLFO' END  )                          
                          
------------------------------MCX--------------------------------------------                   
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'MCX' THEN 'ACPLMCX' END  )                          
                          
------------------------------NCDEX--------------------------------------------                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'NCDEX' THEN 'ACPLNCDEX' END  )                          
                          
                          
-----------------------------ALL  Segments----------------------------------------                           
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT LIKE CASE WHEN #downtime.ImpactedSegemnt = 'All Segments' THEN '%' END                              
                          
------------------------------CM+FO-------------------------------------------------                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                        
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLCM' END)                          
                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLFO' END)                          
------------------------------BSE + CM + FO---------------------------------------                          
                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ABLCM' END)                          
                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLCM' END)                          
                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE + CM + FO' THEN 'ACDLFO' END)                          
                          
---------------------------MCX + NCDEX-------------------------------------                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLMCX' END)                          
                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'MCX + NCDEX' THEN 'ACPLNCDEX' END)        
                          
------------------------------BSE +  MCX + NCDEX---------------------------                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ABLCM' END)                          
                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLMCX' END)                          
                      
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'BSE +  MCX + NCDEX' THEN 'ACPLNCDEX' END)                          
                          
------------------------------CM + FO + NCDEX-----------------------------                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLCM' END)                          
                          
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACDLFO' END)                          
              
UPDATE #t SET DT = DOWNTIMEMIN,Exchanges = ImpactedSegemnt FROM #downtime WHERE #t.SERVER = #downtime.LOCATION                            
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO + NCDEX' THEN 'ACPLNCDEX' END)                          
                          
update #t set dt = 0 where dt = ''                          
                          
--truncate table Terminal_Brok_Loss                       
  
declare @cnt int  
set @cnt = (select cnt=count(*) from #downtime group by Location having count(*) > 1 )   
  
if @cnt > 1  
  
begin    
    
SET NOCOUNT ON    
    
DECLARE @location varchar(100),@segment as varchar(100)       
DECLARE authors_cursor CURSOR FOR     
select Location from #downtime group by Location having count(*) > 1    
    
OPEN authors_cursor    
    
FETCH NEXT FROM authors_cursor     
INTO @location    
    
WHILE @@FETCH_STATUS = 0    
BEGIN             
     
 insert into #t    
 select a.location,'ACPLNCDEX',b.brokerage,a.downtimemin,uptime=(select NCDEX from #tt),'',@fdate,    
 @issues,'NCDEX' from #downtime a inner join #ser_brok b on     
 case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server     
  
 insert into #t    
 select a.location,'ACPLMCX',b.brokerage,a.downtimemin,uptime=(select MCX from #tt),'',@fdate,    
 @issues,'MCX' from #downtime a inner join #ser_brok b on     
 case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and a.location = b.server     
  
 insert into #t    
 select a.location,'ABLCM',b.brokerage,a.downtimemin,uptime=(select BSE from #tt),'',@fdate,    
 @issues,'BSE' from #downtime a inner join #ser_brok b on     
 case when a.impactedsegemnt = 'BSE' then 'ABLCM' end = b.segment and a.location = b.server     
  
 insert into #t    
 select a.location,'ACDLFO',b.brokerage,a.downtimemin,uptime=(select FO from #tt),'',@fdate,    
 @issues,'FO' from #downtime a inner join #ser_brok b on     
 case when a.impactedsegemnt = 'FO' then 'ACDLFO' end = b.segment and a.location = b.server     
  
 insert into #t    
 select a.location,'ACDLCM',b.brokerage,a.downtimemin,uptime=(select CM from #tt),'',@fdate,    
 @issues,'CM' from #downtime a inner join #ser_brok b on     
 case when a.impactedsegemnt = 'CM' then 'ACDLCM' end = b.segment and a.location = b.server       
    
 FETCH NEXT FROM authors_cursor     
 INTO @location    
END    
    
CLOSE authors_cursor    
DEALLOCATE authors_cursor    
  
end                  
delete from  Terminal_Brok_Loss  where sauda_date = @fdate and Issues = @issues                  
                          
insert into Terminal_Brok_Loss                          
select server, segment, Brokerage, dt, uptime, Brk_Loss=(convert(money,Brokerage)/(convert(int,uptime)-convert(int,dt)))*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_7
-- --------------------------------------------------


CREATE proc USP_BROK_LOSS_NEW_7(@fdate as varchar(11),@tdate as varchar(11),@issues as varchar(200))                                  
as                                  
                                  
                          
-- declare @fdate as varchar(15)                          
-- declare @tdate as varchar(15)                          
declare @str as varchar(500)                                   
declare @opt as varchar(25)                                                                                
declare @issues1 as varchar(100)                                   
--declare @issues as varchar(100)                                   
                          
-- set @fdate = 'Jan 12 2007'      
-- set @tdate = 'Jan 12 2007'      
-- set @issues = 'ANGEL HARDWARE ISSUE'                          
                                  
set   @opt = (select                                      
(case                                      
when @issues = 'All' then 'like' else '=' end                                      
) )                                                              
                                      
set   @issues1 = (select                                      
(case                                      
when @issues = 'All' then '%' else @issues end                                      
) )                                   
                                  
----------------------------------------Down Time Information--------------------------------      
                                   
select Top 0 Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin))  into #downtime from newtab1  where dt >= 'Dec 13 2006' and dt <= 'Dec 13 2006' group by Location,ImpactedSegemnt                                    
                                  
set @str = ('select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)) from newtab1  where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Problem '+@opt+''''+@issues1+''' group by Location,ImpactedSegemnt')                              
  
    
      
--print @str                          
                                  
insert into #downtime                                  
exec (@str)                       
                 
--------------------------------------Brokerage Data and Server information---------------------------                                  
                                  
select company,Terminal_id,Brokerage=sum(Brokerage)                                    
into #terminal_brok from terminal_brok where sauda_date >= @fdate and                                     
sauda_date <= @tdate group by company,Terminal_id                                    
                                  
select b.server,b.segment,Brokerage=sum(a.Brokerage) into #server from #terminal_brok a inner join terminals b                                     
on a.terminal_id = b.odin_id group by  server,segment                                    
                                  
select * into #ser_brok from #server  where server in (select location from  #downtime)                                    
                                    
------------------------------------Settlement Data-----------------------------------------      
                                   
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                                     
into #tt from sett_mst where tdate >= @fdate and tdate <= @tdate                                  
      
--------------------------------------------Insert Query for store All Data--------------------------------------------------------      
      
select Top 0 * , space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges into #t from #ser_brok                                     
      
--------------------------------Cursor for Same Issue but for Multiple EXchanges------------      
      
declare @cnt int          
set @cnt = (select cnt=count(*) from #downtime group by Location having count(*) > 1 )           
          
if @cnt > 1          
          
begin            
          
SET NOCOUNT ON            
            
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50)       
          DECLARE authors_cursor CURSOR FOR  select Location,ImpactedSegemnt,Downtimemin from #downtime where Location in       
(select Location from #downtime group by Location having count(*) > 1)            
            
OPEN authors_cursor            
            
FETCH NEXT FROM authors_cursor             
INTO @location,@segment,@downtime            
            
WHILE @@FETCH_STATUS = 0            
BEGIN       
                    
if @segment = 'NCDEX'           
 Begin      
   insert into #t            
   select a.location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
 End      
          
if @segment = 'MCX'           
 Begin      
   insert into #t            
   select a.location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and a.location = b.server             
 end      
      
if @segment = 'BSE'           
 Begin         
   insert into #t            
   select a.location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE' then 'ABLCM' end = b.segment and a.location = b.server             
 end      
      
if @segment = 'FO'               
 Begin         
   insert into #t            
   select a.location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'FO' then 'ACDLFO' end = b.segment and a.location = b.server             
 end      
      
if @segment = 'CM'               
 Begin             
   insert into #t            
   select a.location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM' then 'ACDLCM' end = b.segment and a.location = b.server               
 end      
      
      
if @segment = 'All Segments'      
               
 Begin             
   insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ACPLMCX' end = b.segment and a.location = b.server       
    union      
   select a.location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ABLCM' end = b.segment and a.location = b.server       
   union      
   select a.location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ACDLFO' end = b.segment and a.location = b.server      
   union      
          select a.location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment = 'CM + FO + NCDEX'      
       
 Begin             
 insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLFO' end = b.segment and a.location = b.server      
   union      
          select a.location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment = 'BSE +  MCX + NCDEX'      
 begin       
  insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLMCX' end = b.segment and a.location = b.server       
    union      
   select a.location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ABLCM' end = b.segment and a.location = b.server       
 end       
      
if @segment = 'BSE + CM + FO'      
 Begin             
   insert into #t       
   select a.location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ABLCM' end = b.segment and a.location = b.server       
   union      
   select a.location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLFO' end = b.segment and a.location = b.server      
   union      
          select a.location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment = 'CM + FO'      
 Begin             
   insert into #t       
   select a.location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLFO' end = b.segment and a.location = b.server      
   union      
          select a.location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment = 'MCX + NCDEX'    
 begin       
  insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLMCX' end = b.segment and a.location = b.server       
 end       
            
 FETCH NEXT FROM authors_cursor             
 INTO @location,@segment,@downtime            
END            
            
CLOSE authors_cursor            
DEALLOCATE authors_cursor            
      
end       
      
-------------------------------------------end cursor-------------------------------------------------------      
      
-------------------------------------------Single Issue------------------------      
declare @cnt1 int          
set @cnt1 = (select cnt=count(*) from #downtime group by Location having count(*) <= 1 )      
    
if @cnt1 = 1      
          
begin            
            
SET NOCOUNT ON            
            
DECLARE @location1 varchar(100),@segment1 as varchar(100),@downtime1 as varchar(50)       
DECLARE authors_cursor1 CURSOR FOR  select Location,ImpactedSegemnt,Downtimemin from #downtime where Location in       
(select Location from #downtime group by Location having count(*) <= 1)            
            
OPEN authors_cursor1            
            
FETCH NEXT FROM authors_cursor1             
INTO @location1,@segment1,@downtime1            
            
WHILE @@FETCH_STATUS = 0            
  
BEGIN       
      
if @segment1 = 'NCDEX'           
 Begin      
   insert into #t            
   select a.location,'ACPLNCDEX',b.brokerage,@downtime1,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
 End      
          
if @segment1 = 'MCX'           
 Begin      
   insert into #t            
   select a.location,'ACPLMCX',b.brokerage,@downtime1,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and a.location = b.server             
 end      
      
if @segment1 = 'BSE'           
 Begin         
   insert into #t            
   select a.location,'ABLCM',b.brokerage,@downtime1,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE' then 'ABLCM' end = b.segment and a.location = b.server             
 end      
      
if @segment1 = 'FO'               
 Begin         
   insert into #t            
   select a.location,'ACDLFO',b.brokerage,@downtime1,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'FO' then 'ACDLFO' end = b.segment and a.location = b.server             
 end      
      
if @segment1 = 'CM'               
 Begin             
   insert into #t            
   select a.location,'ACDLCM',b.brokerage,@downtime1,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM' then 'ACDLCM' end = b.segment and a.location = b.server               
 end      
      
      
if @segment1 = 'All Segments'      
               
 Begin             
   insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime1,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
 case when a.impactedsegemnt = 'All Segments' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACPLMCX',b.brokerage,@downtime1,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ACPLMCX' end = b.segment and a.location = b.server       
    union      
   select a.location,'ABLCM',b.brokerage,@downtime1,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ABLCM' end = b.segment and a.location = b.server       
   union      
   select a.location,'ACDLFO',b.brokerage,@downtime1,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ACDLFO' end = b.segment and a.location = b.server      
   union      
          select a.location,'ACDLCM',b.brokerage,@downtime1,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'All Segments' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment1 = 'CM + FO + NCDEX'      
       
 Begin             
   insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime1,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACDLFO',b.brokerage,@downtime1,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on       
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLFO' end = b.segment and a.location = b.server      
   union      
          select a.location,'ACDLCM',b.brokerage,@downtime1,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment1 = 'BSE +  MCX + NCDEX'      
 begin       
  insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime1,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACPLMCX',b.brokerage,@downtime1,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLMCX' end = b.segment and a.location = b.server       
    union      
   select a.location,'ABLCM',b.brokerage,@downtime1,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ABLCM' end = b.segment and a.location = b.server       
 end       
      
if @segment1 = 'BSE + CM + FO'      
 Begin             
   insert into #t       
   select a.location,'ABLCM',b.brokerage,@downtime1,uptime=(select BSE from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ABLCM' end = b.segment and a.location = b.server       
   union      
   select a.location,'ACDLFO',b.brokerage,@downtime1,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLFO' end = b.segment and a.location = b.server      
   union      
          select a.location,'ACDLCM',b.brokerage,@downtime1,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment1 = 'CM + FO'      
 Begin             
   insert into #t       
   select a.location,'ACDLFO',b.brokerage,@downtime1,uptime=(select FO from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLFO' end = b.segment and a.location = b.server      
  union      
          select a.location,'ACDLCM',b.brokerage,@downtime1,uptime=(select CM from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLCM' end = b.segment and a.location = b.server                   
 end      
      
if @segment1 = 'MCX + NCDEX'      
 begin       
  insert into #t       
   select a.location,'ACPLNCDEX',b.brokerage,@downtime1,uptime=(select NCDEX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and a.location = b.server             
    union      
   select a.location,'ACPLMCX',b.brokerage,@downtime1,uptime=(select MCX from #tt),'',@fdate,            
   @issues,@segment1 from #downtime a inner join #ser_brok b on             
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLMCX' end = b.segment and a.location = b.server       
 end       
  
    
      
FETCH NEXT FROM authors_cursor1             
 INTO @location1,@segment1,@downtime1          
END            
            
CLOSE authors_cursor1            
DEALLOCATE authors_cursor1            
      
end       
--------------------------------------------------End -------------------------------------------------------      
      
update #t set dt = 0 where dt = ''                                  
                                  
--truncate table Terminal_Brok_Loss                                   
      
delete from  Terminal_Brok_Loss  where sauda_date = @fdate and Issues = @issues                          
             
insert into Terminal_Brok_Loss                                  
select server, segment, Brokerage, dt, uptime, Brk_Loss=(convert(money,Brokerage)/(convert(int,uptime)-convert(int,dt)))*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_8
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_8(@fdate as varchar(11),@tdate as varchar(11),@issues as varchar(200))                                          
as                                          
                                          
                                  
-- declare @fdate as varchar(15)                                  
-- declare @tdate as varchar(15)                                  
declare @str as varchar(500)                                           
declare @opt as varchar(25)                                                                                        
declare @issues1 as varchar(100)                                           
--declare @issues as varchar(100)                                           
                                  
set @fdate = convert(datetime,@fdate,103)          
set @tdate = convert(datetime,@tdate,103)              
-- set @issues = 'ANGEL HARDWARE ISSUE'                                  
                                          
set   @opt = (select                                              
(case                                              
when @issues = 'All' then 'like' else '=' end                                              
) )                                                                      
                                              
set   @issues1 = (select                                              
(case                                              
when @issues = 'All' then '%' else @issues end                                              
) )                                           
                                          
----------------------------------------Down Time Information--------------------------------              
                                           
select Top 0 Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin))  into #downtime from newtab1  where dt >= 'Dec 13 2006' and dt <= 'Dec 13 2006' group by Location,ImpactedSegemnt                                            
                                          
set @str = ('select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)) from newtab1  where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Problem '+@opt+''''+@issues1+''' group by Location,ImpactedSegemnt')                              
  
    
      
        
          
            
              
--print @str                                  
                                          
insert into #downtime                                          
exec (@str)                               
                         
--------------------      
--select * from #downtime      
      
------------------Brokerage Data and Server information---------------------------                                          
                                          
-- select company,Terminal_id,Brokerage=sum(Brokerage)                                            
-- into #terminal_brok from terminal_brok where sauda_date >= @fdate and                                             
-- sauda_date <= @tdate group by company,Terminal_id                                            
  
select company,Terminal_id,Brokerage=sum(Brokerage)                                            
into #terminal_brok from mis_terminal_brok where sauda_date >= @fdate and                                             
sauda_date <= @tdate group by company,Terminal_id                                            
                                         
select b.server,b.segment,Brokerage=sum(a.Brokerage) into #server from #terminal_brok a inner join terminals b                                             
on a.terminal_id = b.odin_id group by  server,segment                                            
                                          
select * into #ser_brok from #server  where server in (select location from  #downtime)                                            
                                            
------------------------------------Settlement Data-----------------------------------------              
                                           
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                                             
into #tt from sett_mst where tdate >= @fdate and tdate <= @tdate                                          
              
--------------------------------------------Insert Query for store All Data--------------------------------------------------------              
              
select Top 0 * , space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges into #t from #ser_brok                                             
              
--------------------------------Cursor for Same Issue but for Multiple EXchanges------------              
              
-- declare @cnt int                  
-- set @cnt = (select cnt=count(*) from #downtime group by Location having count(*) > 1 )                   
--                   
-- if @cnt > 1                  
                  
begin                    
                  
--SET NOCOUNT ON                    
                    
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50)               
          DECLARE authors_cursor CURSOR FOR  select Location,ImpactedSegemnt,Downtimemin from #downtime where Location in               
(select Location from #downtime group by Location)       
-- having count(*) > 1)                    
                    
OPEN authors_cursor                    
                    
FETCH NEXT FROM authors_cursor                     
INTO @location,@segment,@downtime                    
                    
WHILE @@FETCH_STATUS = 0                    
BEGIN               
-------      
      
if @segment = 'NCDEX'                   
 Begin              
   insert into #t                    
   select @location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                     
 End              
                  
if @segment = 'MCX'                   
 Begin              
   insert into #t                    
   select @location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                     
 end              
              
if @segment = 'BSE'                   
 Begin                 
   insert into #t                    
   select @location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'BSE' then 'ABLCM' end = b.segment and @location = b.server                     
 end              
              
if @segment = 'FO'                       
 Begin                 
   insert into #t                    
   select @location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'FO' then 'ACDLFO' end = b.segment and @location = b.server                     
 end              
              
if @segment = 'CM'                       
 Begin                     
   insert into #t                    
   select @location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'CM' then 'ACDLCM' end = b.segment and @location = b.server                       
 end              
              
              
if @segment = 'All Segments'          
                       
 Begin                     
   insert into #t               
   select @location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'All Segments' then 'ACPLNCDEX' end = b.segment and @location = b.server                     
    union              
   select @location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'All Segments' then 'ACPLMCX' end = b.segment and @location = b.server               
    union              
   select @location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'All Segments' then 'ABLCM' end = b.segment and @location = b.server               
   union              
   select @location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'All Segments' then 'ACDLFO' end = b.segment and @location = b.server              
   union              
          select @location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'All Segments' then 'ACDLCM' end = b.segment and @location = b.server                           
 end              
              
if @segment = 'CM + FO + NCDEX'              
               
 Begin                     
 insert into #t               
   select @location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                     
    union              
   select @location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLFO' end = b.segment and @location = b.server              
   union              
          select @location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLCM' end = b.segment and @location = b.server                           
 end              
              
if @segment = 'BSE +  MCX + NCDEX'              
 begin               
  insert into #t               
   select @location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                     
    union              
   select @location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLMCX' end = b.segment and @location = b.server               
    union              
   select @location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ABLCM' end = b.segment and @location = b.server               
 end               
              
if @segment = 'BSE + CM + FO'              
 Begin                     
   insert into #t               
   select @location,'ABLCM',b.brokerage,@downtime,uptime=(select BSE from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ABLCM' end = b.segment and @location = b.server               
   union              
   select @location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on               
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLFO' end = b.segment and @location = b.server              
   union              
          select @location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLCM' end = b.segment and @location = b.server                           
 end              
              
if @segment = 'CM + FO'              
 Begin                     
   insert into #t               
   select @location,'ACDLFO',b.brokerage,@downtime,uptime=(select FO from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLFO' end = b.segment and @location = b.server              
   union              
          select @location,'ACDLCM',b.brokerage,@downtime,uptime=(select CM from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLCM' end = b.segment and @location = b.server                           
 end              
              
if @segment = 'MCX + NCDEX'            
 begin               
  insert into #t               
   select @location,'ACPLNCDEX',b.brokerage,@downtime,uptime=(select NCDEX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                     
    union              
   select @location,'ACPLMCX',b.brokerage,@downtime,uptime=(select MCX from #tt),'',@fdate,                    
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLMCX' end = b.segment and @location = b.server               
 end          
      
      
                            
--------------                    
 FETCH NEXT FROM authors_cursor                     
 INTO @location,@segment,@downtime                    
END                    
                    
CLOSE authors_cursor                    
DEALLOCATE authors_cursor                    
              
end               
              
-------------------------------------------end cursor-------------------------------------------------------                          
              
update #t set dt = 0 where dt = ''                                          
                                          
--truncate table Terminal_Brok_Loss                                           
              
delete from  Terminal_Brok_Loss  where sauda_date = @fdate and Issues = @issues                                  
                     
insert into Terminal_Brok_Loss                                          
select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(convert(money,Brokerage)/case when (convert(int,uptime)-convert(int,dt)) = 0 then 1 else (convert(int,uptime)-convert(int,dt)) end)*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #t                                          
--select distinct server, segment, Brokerage, dt, uptime, Brk_Loss=(convert(money,Brokerage)/(convert(int,uptime)-convert(int,dt)))*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_BROK_LOSS_NEW_9
-- --------------------------------------------------
CREATE proc USP_BROK_LOSS_NEW_9(@fdate as varchar(11))    
as                                                
    
set @fdate = convert(datetime,@fdate,103)                
    
-----------------------Fetch Brokerage----------    
select company,Terminal_id,Brokerage=sum(Brokerage)                                                  
into #terminal_brok     
--from mis_terminal_brok where sauda_date >= @fdate and     
from intranet.bsedb_ab.dbo.mis_to_terminal where sauda_date >= @fdate and     
sauda_date <= @fdate group by company,Terminal_id                                                  
    
---------------------Market Time-----------------    
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)                                                   
into #tt from sett_mst where tdate = @fdate    
    
---------------------Downtime --------------------    
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)),    
Problem into #downtime from newtab1 where dt >= @fdate and dt <= @fdate    
group by Location,ImpactedSegemnt,problem      
    
-- select b.server,b.sdate,b.edate,a.*  into #a from #terminal_brok a inner join Terminals b     
-- on a.terminal_id = b.odin_id /*and edate is null order by server*/    
  
select y.server,x.* into #a from #terminal_brok x,  
(select * from Terminals (nolock) where @fdate >= sdate and @fdate <= edate) y where x.terminal_id=y.odin_id  
    
--------------------------Affected Server Brokerate---------------    
select server,company as segment,brokerage=sum(brokerage) into #ser_brok from #a where /*edate is null and*/ server  in     
(select Location from #downtime where Impactedsegemnt <> 'None') group by server,company  order by server     
    
--------------------------insert data in temp table--------------    
select Top 0 #a.server,#a.company as segment, #a.brokerage,space(40) as dt,space(40) as uptime,space(40) as Brk_Loss,space(40) as Sauda_date,    
space(40) as Issues,space(100) as Exchanges into #temp_cal from #a    
    
--------------------------------Cursor for Updating temp table --------------------------    
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50),@issues as varchar(100)    
DECLARE authors_cursor CURSOR FOR select Location,ImpactedSegemnt,Downtimemin,Problem from #downtime where Impactedsegemnt <> 'None'     
                          
OPEN authors_cursor                          
                          
FETCH NEXT FROM authors_cursor                           
INTO @location,@segment,@downtime,@issues                          
                          
WHILE @@FETCH_STATUS = 0                          
BEGIN                     
    
            
if @segment = 'NCDEX'                         
 Begin                    
   insert into #temp_cal                          
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                           
 End                    
                        
if @segment = 'MCX'       
                      
 Begin                    
   insert into #temp_cal                          
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,@issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                           
 end                    
                    
if @segment = 'BSE'                         
 Begin                       
   insert into #temp_cal                          
   select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'BSE' then 'ABLCM' end = b.segment and @location = b.server                           
 end                    
                    
if @segment = 'FO'                             
 Begin                       
   insert into #temp_cal                          
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'FO' then 'ACDLFO' end = b.segment and @location = b.server                           
 end                    
                    
if @segment = 'CM'                             
 Begin                           
   insert into #temp_cal                          
   select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'CM' then 'ACDLCM' end = b.segment and @location = b.server                             
 end                    
                    
                    
if @segment = 'All Segments'                
                             
 Begin                           
   insert into #temp_cal                     
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'All Segments' then 'ACPLNCDEX' end = b.segment and @location = b.server                           
    union                    
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'All Segments' then 'ACPLMCX' end = b.segment and @location = b.server                     
    union                    
   select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'All Segments' then 'ABLCM' end = b.segment and @location = b.server                     
   union                    
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'All Segments' then 'ACDLFO' end = b.segment and @location = b.server                    
   union                    
          select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'All Segments' then 'ACDLCM' end = b.segment and @location = b.server                                 
 end                    
                    
if @segment = 'CM + FO + NCDEX'                    
                     
 Begin                           
 insert into #temp_cal                     
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                           
    union                    
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLFO' end = b.segment and @location = b.server                    
   union                    
          select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'CM + FO + NCDEX' then 'ACDLCM' end = b.segment and @location = b.server                                 
 end                    
                    
if @segment = 'BSE +  MCX + NCDEX'                    
 begin                     
  insert into #temp_cal                     
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                             union                    
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ACPLMCX' end = b.segment and @location = b.server                     
    union                    
   select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'BSE +  MCX + NCDEX' then 'ABLCM' end = b.segment and @location = b.server                     
 end                     
                    
if @segment = 'BSE + CM + FO'                    
 Begin                           
   insert into #temp_cal                     
   select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ABLCM' end = b.segment and @location = b.server                     
   union                    
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                     
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLFO' end = b.segment and @location = b.server                    
   union                    
          select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'BSE + CM + FO' then 'ACDLCM' end = b.segment and @location = b.server                                 
 end                    
                    
if @segment = 'CM + FO'                    
 Begin                           
   insert into #temp_cal                     
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLFO' end = b.segment and @location = b.server                    
   union                    
          select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'CM + FO' then 'ACDLCM' end = b.segment and @location = b.server                                 
 end                    
                    
if @segment = 'MCX + NCDEX'                  
 begin                     
  insert into #temp_cal                     
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                           
    union                    
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,                          
   @issues,@segment from #downtime a inner join #ser_brok b on                           
   case when a.impactedsegemnt = 'MCX + NCDEX' then 'ACPLMCX' end = b.segment and @location = b.server                     
 end                             
                                  
    
 FETCH NEXT FROM authors_cursor                           
 INTO @location,@segment,@downtime,@issues                          
END                          
                          
CLOSE authors_cursor                          
DEALLOCATE authors_cursor          
    
--------------------------------------Cursor End--------------------------------------------------    
    
-----------------------------------Updating temp table for not affected server---------------------------    
    
insert into #temp_cal    
select server,company,sum(brokerage),'','','','','',''  from #a where rtrim(ltrim(server))+rtrim(ltrim(company)) not in    
(select rtrim(ltrim(server))+rtrim(ltrim(segment)) from #temp_cal where server in     
(select Location from #downtime where Impactedsegemnt <> 'None')) /*and sdate <= @fdate or  Sdate is null*/ group by server,company  order by server    
    
update #temp_cal set uptime = (select bse from #tt) where segment = 'ABLCM'    
update #temp_cal set uptime = (select cm from #tt) where segment = 'ACDLCM'    
update #temp_cal set uptime = (select fo from #tt) where segment = 'ACDLFO'    
update #temp_cal set uptime = (select mcx from #tt) where segment = 'ACPLMCX'    
update #temp_cal set uptime = (select ncdex from #tt) where segment = 'ACPLNCDEX'    
    
update #temp_cal set sauda_date = @fdate    
    
update #temp_cal set dt = 0 where dt = ''    
    
delete from terminal_brok_loss where sauda_date = @fdate    
--     
insert into terminal_brok_loss    
select distinct server, segment, Brokerage, dt, uptime,Brk_Loss=(convert(money,Brokerage)/case when (convert(int,uptime)-convert(int,dt)) = 0 then 1 else (convert(int,uptime)-convert(int,dt)) end)*convert(int,dt),sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #temp_cal

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Bulk_Excel_IT_IP_Upload
-- --------------------------------------------------
CREATE Proc USP_Bulk_Excel_IT_IP_Upload          
as           
          
  
insert into tbl_IT_IPaddress     
select Fld_Branch,Fld_IpFrom,Fld_IpTo,Fld_SB_mask,Fld_Def_GT,Fld_Remark,getdate(),'System' from oldintranet.upload.dbo.tbl_IT_IPaddress          
  
select * from oldintranet.upload.dbo.tbl_IT_IPaddress

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Bulk_Excel_Upload
-- --------------------------------------------------
CREATE PROC [DBO].[USP_BULK_EXCEL_UPLOAD]                  
AS 
BEGIN          
SET XACT_ABORT ON
BEGIN TRAN

INSERT INTO NEWTAB1             
SELECT DT,FLD_TYPE,FLD_ID,FLD_TIME_FROM,FLD_TIME_TO,FLD_EVENTS,FLD_SOLUTION,FLD_PROBLEM,FLD_SEGMENT,FLD_DOWNTIME,FLD_DOWNTIME,FLD_REMARK FROM      
(      
SELECT  CONVERT(DATETIME,FLD_DATE,103) AS DT,FLD_TYPE,FLD_SERVER,FLD_TIME_FROM,FLD_TIME_TO,FLD_EVENTS,              
REPLACE(FLD_SOLUTION,'&','AND') AS FLD_SOLUTION,FLD_PROBLEM,FLD_SEGMENT,ISNULL(FLD_DOWNTIME,0) AS FLD_DOWNTIME , FLD_REMARK    
FROM MIS.UPLOAD.DBO.IT_EVENTS            
) X      
LEFT OUTER JOIN         
(SELECT * FROM TBL_SERVER_MASTER)  Y      
ON X.FLD_SERVER = Y.FLD_SERVER 

TRUNCATE TABLE UPLOAD.DBO.IT_EVENTS 

COMMIT TRAN
SET XACT_ABORT OFF
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Call_Report
-- --------------------------------------------------
CREATE proc USP_Call_Report(@fdate as  varchar(11),@tdate as varchar(11),@Fld_Call_Type as varchar(10))        
as        
          
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))         
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))         
        
select x.*,y.Fld_Location,y.Fld_Server_ip from             
(select  Fld_Gateway_ip,        
case when Fld_Call_Type = 'R' then 'Rotated Calls' else 'Daily Calls' end as Fld_Call_Type        
,Fld_Dealer_Name,Fld_First_Confirmation,Fld_First_Frq,Fld_Second_Confirmation,            
Fld_Second_Frq,Fld_First_Entered_By,Fld_Second_Entered_By from tbl_call_rpt (nolock)         
where /*Fld_Gateway_ip = @Fld_Gateway_ip and*/ Fld_Upd_date >= @fdate  and   Fld_Upd_date <= @tdate + ' 23:59:59'          
and Fld_Call_Type like @Fld_Call_Type        
)x inner join            
(select  * from v_tbl_it_site_data) y on x.Fld_Gateway_ip = y.Fld_Def_Gateway order by Fld_Call_Type

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Calls_Summ_Report
-- --------------------------------------------------
CREATE Proc USP_Calls_Summ_Report(          
@fdate as varchar(11),@tdate as varchar(11),          
@access_code as varchar(500),@region as varchar(15),@empcode as varchar(15),@call_type as varchar(25))                
as                
            
declare @str as varchar(2000)          
--set @access_code = case when @access_code = 'All' then '%%' else @access_code end             
set @access_code = (case when @region = 'ALL' and @access_code = 'ALL' then 'like ''%%''' else 'in (select br_tag from(select Br_Tag from v_tbl_it_br_master (nolock) where (br_region = '''+@region+''' or reg_Code = '''+@region+''' )and br_tag like replace
  
('''+@access_code+''',''All'',''%%'')union select replace('''+@access_code+''',''All'','''+@region+'''))x)' end)                               
--set @Region_Code = case when @Region_Code = 'All' then '%%' else @Region_Code end             
                
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                
                
set @str = 'select x.*,isnull(y.Pending,0) as Pending,isnull(z.Completed,0) as Completed from                
(select upper(grp_id) as grp_id,count(*) as Total from complaint_table (nolock) where complaint_date >= '''+@fdate+'''                
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and call_type like '''+@call_type+''' and grp_id '+@access_code+' and entry_by like '''+@empcode+'''   group by grp_id                
)x left outer join                
(select upper(grp_id) as grp_id,count(*) as Pending from complaint_table (nolock) where complaint_date >= '''+@fdate+'''                
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and call_type like '''+@call_type+''' and status = ''Pending'' and grp_id '+@access_code+' and entry_by like '''+@empcode+''' group by grp_id                
)y on x.grp_id = y.grp_id                
left outer join                
(select upper(grp_id) as grp_id,count(*) as Completed from complaint_table (nolock) where complaint_date >= '''+@fdate+'''                
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and call_type like '''+@call_type+''' and status = ''Completed'' and grp_id '+@access_code+' and entry_by like '''+@empcode+''' group by grp_id                
)z on x.grp_id = z.grp_id'           
--print @str      
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Calls_Summ_Report_test
-- --------------------------------------------------
CREATE Proc USP_Calls_Summ_Report_test(
@fdate as varchar(11),@tdate as varchar(11),
@access_code as varchar(500),@region as varchar(15))      
as      
  
declare @str as varchar(2000)
--set @access_code = case when @access_code = 'All' then '%%' else @access_code end   
set @access_code = (case when @region = 'ALL' and @access_code = 'ALL' then 'like ''%%''' else 'in (select br_tag from(select Br_Tag from tbl_it_br_master (nolock) where br_region = '''+@region+''' and br_tag like replace('''+@access_code+''',''All'',''%%'')union select replace('''+@access_code+''',''All'','''+@region+'''))x)' end)                     
--set @Region_Code = case when @Region_Code = 'All' then '%%' else @Region_Code end   
      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))      
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))      
      
set @str = 'select x.*,isnull(y.Pending,0) as Pending,isnull(z.Completed,0) as Completed from      
(select upper(grp_id) as grp_id,count(*) as Total from complaint_table (nolock) where complaint_date >= '''+@fdate+'''      
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and grp_id '+@access_code+'  group by grp_id      
)x left outer join      
(select upper(grp_id) as grp_id,count(*) as Pending from complaint_table (nolock) where complaint_date >= '''+@fdate+'''      
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and status = ''Pending'' and grp_id '+@access_code+' group by grp_id      
)y on x.grp_id = y.grp_id      
left outer join      
(select upper(grp_id) as grp_id,count(*) as Completed from complaint_table (nolock) where complaint_date >= '''+@fdate+'''      
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and status = ''Completed'' and grp_id '+@access_code+' group by grp_id      
)z on x.grp_id = z.grp_id' 
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Calls_Users_Report
-- --------------------------------------------------
CREATE Proc USP_Calls_Users_Report(@fdate as varchar(11),@tdate as varchar(11),@access_code as varchar(1000),@region as varchar(15),@empcode as varchar(15),@call_type as varchar(25))                   
as                        
          
--set @access_code = case when @access_code = 'CSO' then '%%' else @access_code end           
set @access_code = (case when @region = 'ALL' and @access_code = 'ALL' then 'like ''%%''' else 'in (select br_tag from(select Br_Tag from v_tbl_it_br_master (nolock) where (br_region = '''+@region+''' or reg_code =  '''+@region+''')and br_tag like replace('''+@access_code+''',''All'',''%%'')union select replace('''+@access_code+''',''All'','''+@region+'''))x)' end)                             
declare @str as varchar(5000)                        
        
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                        
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                        
                        
set @str = 'select x.entry_by,x.Total,isnull(y.Pending,0) as Pending,isnull(z.Completed,0) as Completed,upper(a.person_name) as person_name,x.grp_id as access_code from                        
(select upper(entry_by) as entry_by,grp_id,count(*) as Total from complaint_table (nolock) where complaint_date >=  '''+@fdate+'''              
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT''and call_type like '''+@call_type+''' and grp_id '+@access_code+' and entry_by like '''+@empcode+''' group by entry_by,grp_id                        
)x left outer join (select grp_id,upper(entry_by) as entry_by,count(*) as Pending from complaint_table (nolock) where complaint_date >=  '''+@fdate+'''                
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and call_type like '''+@call_type+''' and status = ''Pending'' and grp_id '+@access_code+' and entry_by like '''+@empcode+''' group by entry_by,grp_id                        
)y on x.entry_by = y.entry_by and x.grp_id = y.grp_id left outer join                        
(select grp_id,upper(entry_by) as entry_by,count(*) as Completed from complaint_table (nolock) where complaint_date >=  '''+@fdate+'''                     
and complaint_date <= '''+@tdate+'''+'' 23:59:59'' and department = ''IT'' and call_type like '''+@call_type+''' and status = ''Completed'' and grp_id '+@access_code+' and entry_by like '''+@empcode+'''                
group by entry_by,grp_id )z on x.entry_by = z.entry_by  and x.grp_id = z.grp_id                         
left outer join (select * from intranet.risk.dbo.user_login)a on x.entry_by = a.username  order by  access_code'         
--print @str        
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Check_UPS_Data
-- --------------------------------------------------
CREATE Proc Usp_Check_UPS_Data(@Date Varchar(15),@BranchId int,@BrTag Varchar(15))        
as  
  
Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)       
  
if(@BranchId <> 0)  
Begin  
	Select Count(*) from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and   
	Fld_BranchId = @BranchId  
End  
Else
Begin  
	Create Table #t(BrCode int,BrTag varchar(15),BrName varchar(100))  
	  
	Insert into #t  
	Exec Usp_Wan_Search_Branch @BrTag

	Select Count(*) from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and   
	Fld_BranchId in (Select BrCode from #t)
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Cheque_dep
-- --------------------------------------------------
CREATE proc Usp_Cheque_dep(@queryid as varchar(10),@segment as varchar(10),@date as varchar(11),@cheque as varchar(10),              
@amount as varchar(15),@accno as varchar(15),@pcode as varchar(10),@remark as varchar(100),              
@username as varchar(10),@accesscode as varchar(10),@status as varchar(10),@forwardto as varchar(10))              
as            

set @date = convert(datetime,@date,103)


declare @Fld_Complaint_No as varchar(100)          
          
if (select count(*) from tbl_Query_entry (nolock) where convert(varchar(11),Fld_Entry_Time,103) = convert(varchar(11),getdate(),103)) > 0          
 Begin           
  set @Fld_Complaint_No = replace(convert(varchar,getdate(),3),'/','') + convert(varchar,(select max(substring(Fld_Complaint_No,7,100))+1 from tbl_Query_entry where convert(varchar(11),Fld_Entry_Time,103) =convert(varchar(11),getdate(),103)))            
 End          
Else          
 Begin          
  set @Fld_Complaint_No = replace(convert(varchar,getdate(),3),'/','') + '0'          
 end         
/*  
declare @status as varchar(5)  
set @status = 'P'  
declare @compdate as varchar(20)  
set @compdate = (case when @status = 'C' then getdate() else '' end)  
--print @compdate  
*/  
if @status = 'C'  
begin         
insert into tbl_Query_entry values        
(@queryid,@segment,@date,@cheque,@amount,@accno,@pcode,@remark,getdate(),@username,@accesscode,@status,getdate(),@forwardto,@Fld_Complaint_No)              
end  
else  
begin  
insert into tbl_Query_entry values        
(@queryid,@segment,@date,@cheque,@amount,@accno,@pcode,@remark,getdate(),@username,@accesscode,@status,'',@forwardto,@Fld_Complaint_No)              
end   
       
select @Fld_Complaint_No as RefNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Cheque_Not_Rec
-- --------------------------------------------------
CREATE proc Usp_Cheque_Not_Rec    
(@queryid as varchar(10),@segment as varchar(10),@date as varchar(11),@pcode as varchar(10),@amount as varchar(15),@username as varchar(10),@accesscode as varchar(10))    
    
as    

set @date = convert(datetime,@date,103)
    
set nocount on    
    
insert into tbl_Query_entry(Fld_Query_id,Fld_Segment,Fld_Date,Fld_Amount,Fld_Party_Code,Fld_UserName,Fld_Access_Code) values (@queryid,@segment,@date,@amount,@pcode,@username,@accesscode)    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Client_Details
-- --------------------------------------------------
CREATE Proc USP_Client_Details
as 
truncate table tbl_helpdesk_data

insert into tbl_helpdesk_data Values ('Party Code'+'|'+'Party Name'+'|'+'Branch'+'|'+'Sub Broker'+'|'+'Email'+'|'+'Tel No')

insert into tbl_helpdesk_data
select x.code+'|'+long_name+'|'+branch_cd+'|'+sub_broker+'|'+lower(email)+'|'+res_phone1 from
(select Distinct Code from complaint_table (nolock) where Department not in ('IT','SW') and Category = 'Client' and complaint_date >= 'Feb 26 2008' ) x
inner join
(select * from intranet.risk.dbo.client_details) y on rtrim(ltrim(x.code)) = rtrim(ltrim(y.party_code))
and (email <> '' and res_phone1 <> '')

Declare @s as varchar(1000),@s1 as varchar(1000)

set @s = 'exec MASTER.dbo.xp_cmdshell '+ '''' +'bcp  "SELECT data FROM mis.helpdesk.DBO.tbl_helpdesk_data" queryout '+'d:\upload1\Helpdesk\UPdated_Data.xls -c -SMis -Usa -Pnirwan612'                      
set @s1= @s+''''                               
exec(@s1)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Comp_Update
-- --------------------------------------------------
create proc Usp_Comp_Update (@complaint as varchar(10))
as
set nocount on

update tbl_Query_Entry set Fld_Completed_Date = getdate(),Fld_Status = 'C' where Fld_Complaint_No = @complaint

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_complaint
-- --------------------------------------------------
CREATE PROC usp_complaint                            
(                            
 @deptId AS int,                    
 @Complaint_ID AS VARCHAR(50),                             
 @queryType AS VARCHAR(100),                        
 @Subject As VARCHAR(50),                            
 @complaint AS VARCHAR(2000),                            
 @solution AS VARCHAR(2000),                            
 @accessTo AS VARCHAR(20),                             
 @solutionBy AS VARCHAR(50),                             
 @attachment AS VARCHAR(70),                            
 @status AS VARCHAR(20),                            
 @Fld_EntryBy AS VARCHAR(50),                      
 @complaintNo as varchar(100),  
 @compl_abt as smallint,  
 @clt_subdetl as varchar(50)  
)                            
AS                         
                  
           
                    
if @status = 'H'                    
 begin                    
                    
  update tbl_complaint set fld_hold_Reason = '',Status = 'H' where Complaint_ID = @complaintNo                     
                    
 end                       
                    
               
                    
If @status = 'P'                    
                    
Begin                    
-- Declare @Complaintno as varchar(100)                      
 set @Complaintno = (select count(*) from tbl_complaint (nolock) where Fld_EntryBy =@Fld_EntryBy)                                                                     
                                                                                 
 if @Complaintno = 0                                                                                
  begin                                                                                 
   set @Complaintno = @Fld_EntryBy+'0'                                                                                      
  end                                                                                
 else                                                                                
  begin                                                                                 
  /* set @Complaintno = (select top 1 @Fld_EntryBy+convert(varchar,substring(Complaint_ID,7,100)+1)                     
   from tbl_complaint where  Fld_EntryBy =@Fld_EntryBy order by Complaint_Date desc)   */        
   set @Complaintno = (select  @Fld_EntryBy+convert(varchar,max(convert(int,substring(complaint_id,len(@Fld_EntryBy)+1,3)))+1)                     
   from tbl_complaint where  Fld_EntryBy =@Fld_EntryBy)                                                                     
  end                                                                                  
                    
 INSERT INTO tbl_complaint                             
  (                            
  Dept_ID,                            
  Complaint_ID,                            
  Query_Type,                          
  Subject,                            
  Complaint,                            
  Solution,                                  
  Access_code,                            
  Solution_By,                            
  Complaint_Date,                            
  Solution_Date,                            
  Attachment,                            
  Status,                            
  Fld_EntryBy,                            
  cso_attch,                            
  fld_hold_Reason,                            
compl_abt,                            
clt_subdetl                            
  )                            
  VALUES                            
  (                            
  @deptId,                            
  @Complaintno,                            
  @queryType,                          
  @Subject,                            
  @complaint,  
  @solution,  
  ltrim(rtrim(@accessTo)),  
  @solutionBy,  
  getdate(),  
  Null,  
  @attachment,  
  @status,  
  @Fld_EntryBy,  
  '',  
  '',  
  @compl_abt,  
  @clt_subdetl  
  )  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Confirm
-- --------------------------------------------------

Create Proc Usp_Confirm (@EMod as int,@Loc as int)
as

Select * from Examtype(nolock) where Srno = @EMod
Select * from Listoflocation(nolock) where Srno = @Loc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Confirm_Exam
-- --------------------------------------------------
CREATE Proc Usp_Confirm_Exam (@EmpCode as varchar(15),@Date as varchar(15),@Regno as varchar(20),@NcfmCode as varchar(15),@ApprovedBy as varchar(15))          
as           
set Nocount off        
    
Declare @To as varchar(50)          
Declare @CC as varchar(50)    
set @Date = convert(varchar(11),convert(datetime,@Date,103))         
          
Update tbl_ncfm_Exam_master set Fld_AllocatedDate = @Date,Fld_Registration_No = @Regno,fld_flag = 'Y',Fld_Approveddate = getdate(),Fld_Approvedby = @ApprovedBy where Fld_NcfmCode = @NcfmCode          
          
select a.email as ToMail,b.email as CCMail into #t from           
(select * from intranet.risk.dbo.emp_info where emp_no = @EmpCode)a          
join intranet.risk.dbo.emp_info b           
on a.Senior = b.Emp_no          
          
DECLARE Ncfm_Mail CURSOR FOR Select ToMail,CCMail from #t          
OPEN Ncfm_Mail                                                                     
                                                                                                  
FETCH NEXT FROM Ncfm_Mail                                                                                   
INTO @To,@CC          
                                                                                                  
WHILE @@FETCH_STATUS = 0                                                                            
                                                                                              
BEGIN                                                                                                                                 
	Exec Usp_Ncfm_Mail @To,@CC,@NcfmCode  
             
FETCH NEXT FROM Ncfm_Mail                                                               
INTO @To,@CC                                                                          
                                                                        
END                                                                                                  
                                                                          
CLOSE Ncfm_Mail                                                                                                  
DEALLOCATE Ncfm_Mail

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_connectivity_dtl
-- --------------------------------------------------
CREATE proc USP_connectivity_dtl      
(      
@Fld_From varchar(50),      
@Fld_To varchar(50),      
@Fld_LC_id varchar(50),      
@Fld_Circuit_id varchar(50),      
@Fld_From_Device varchar(50),      
@Fld_To_Device varchar(50),      
@Fld_Lan_IP varchar(50),      
@Fld_ISP varchar(50),      
@Fld_Connectivity_Type varchar(50),      
@Fld_Comm_Date varchar(50),      
@Fld_Bandwidth varchar(50),      
@Fld_Router varchar(50),      
@Fld_Cheesy_Slot varchar(50),      
@Fld_Modem varchar(50),      
@Fld_Remarks varchar(50),  
@Fld_Billing_Date varchar(50),  
@Fld_Billing_Type varchar(50),      
@Fld_Access_code varchar(10)  
   
)      
      
as      
      
insert into tbl_connectivity_dtl values       
(      
@Fld_From,    
@Fld_To,      
@Fld_LC_id,      
@Fld_Circuit_id,      
@Fld_From_Device,      
@Fld_To_Device,      
@Fld_Lan_IP,      
@Fld_ISP,      
@Fld_Connectivity_Type,      
@Fld_Comm_Date,      
@Fld_Bandwidth,      
@Fld_Router,      
@Fld_Cheesy_Slot,      
@Fld_Modem,      
@Fld_Remarks,       
getdate(),      
@Fld_Access_code,
@Fld_Billing_Date,  
@Fld_Billing_Type      
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Create_Server
-- --------------------------------------------------
Create proc USP_Create_Server(@server as varchar(50),@Odin_id as varchar(15),@Segment as varchar(15),@sdate as varchar(11))
as

if (select count(*) from terminals where server = @server and Odin_id = @segment and segment = @segment) = 0

begin
	insert into terminals values (@server,@Odin_id,@Segment,@sdate,'Dec 31 2007') 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Daily_UPS_Report
-- --------------------------------------------------
  
CREATE Proc Usp_Daily_UPS_Report          
(          
  --@Date Varchar(15),          
  @BranchId Varchar(20),          
  @BrTag Varchar(15)          
)          
as          
BEGIN                             
--Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)           
    
  IF @BrTag='All'    
  BEGIN    
 SET @BrTag='%%'    
  END    
    
  IF(@BranchId <> '%%')             
 BEGIN          
  SELECT Br_Name,Fld_VendorName,Fld_Brand_Name,Fld_Model_Name,          
  Fld_Model_Capacity,Fld_Model_srno,CONVERT(VARCHAR(11),Fld_Warrenty_From,103)AS Fld_Warrenty_From ,  
  CONVERT(VARCHAR(11),Fld_Warrenty_To,103) AS Fld_Warrenty_To,a.STATUS,Ups_Map_ID,Fld_srNo as upsid,StatusUpdatedBy,b.Emp_Name,         
  Fld_Battery_Bank,CONVERT(VARCHAR(11),Fld_Bat_WFrom,103) AS Fld_Bat_WFrom ,Fld_Activation_Status,Remark,UserRemark,UserName,  
  CONVERT(VARCHAR(11),Fld_Bat_WTo,103) AS Fld_Bat_WTo  
  FROM V_UPS_Master(NOLOCK) a  
  LEFT OUTER JOIN intranet.risk.dbo.emp_info  b ON a.UserName = b.Emp_no  
  WHERE fld_branch_id in(@BranchId)   
  --and a.DeactivatedOn >=@Date  
  --AND fld_app LIKE 'U'  
  ORDER BY Br_Name  
 END  
  ELSE  
 BEGIN  
  Create Table #t1(BrCode int,BrTag varchar(15),BrName varchar(100))  
  Insert into #t1  
  Exec Usp_Wan_Search_Branch @BrTag  
            
  SELECT Br_Name,Fld_VendorName,Fld_Brand_Name,Fld_Model_Name,  
  Fld_Model_Capacity,Fld_Model_srno,CONVERT(VARCHAR(11),Fld_Warrenty_From,103)AS Fld_Warrenty_From ,  
  CONVERT(VARCHAR(11),Fld_Warrenty_To,103) AS Fld_Warrenty_To,a.STATUS, Ups_Map_ID,Fld_srNo as upsid,StatusUpdatedBy,b.Emp_Name,         
  Fld_Battery_Bank,CONVERT(VARCHAR(11),Fld_Bat_WFrom,103) AS Fld_Bat_WFrom ,Fld_Activation_Status,Remark,UserRemark,UserName,  
  CONVERT(VARCHAR(11),Fld_Bat_WTo,103) AS Fld_Bat_WTo FROM V_UPS_Master(NOLOCK) a  
  LEFT OUTER JOIN intranet.risk.dbo.emp_info  b ON a.UserName = b.Emp_no  
  WHERE fld_branch_id in (Select BrCode from #t1)   
  --and a.DeactivatedOn >=@Date  
  --AND fld_app LIKE 'U'  
  ORDER BY Br_Name  
  drop table #t1  
 END          
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_datacenter_bind
-- --------------------------------------------------
create proc usp_datacenter_bind(  
@tdate as varchar(25)  
)  
as  
  
(SELECT Sr_No as Branch_id,upper(Br_Name) as Br_Name FROM Tbl_IT_Br_Master (nolock)   
WHERE BR_TYPE = 'DATACENTER')  
union   
(select Sr_No as Branch_id,upper(Br_Name) as Br_Name from Tbl_IT_Br_Master   
where fdate >= convert(datetime,'01/01/1900',103) and tdate > convert(datetime,@tdate,103))  
order by br_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_Not_Update
-- --------------------------------------------------
CREATE Proc USP_DB_Not_Update(@fdate as varchar(11))          
as          
      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))       
          
select Distinct Br_Name from V_TCP_Servers x (nolock)   where not exists          
(select * from tbl_DB_Shrink_Data_new y (nolock)  where Fld_upd_Date = @fdate and x.Fld_Branch_cd = y.Fld_Branch_id)           
and  x.Fld_Branch_cd in (SELECT (fld_branch_cd) FROM dbo.Server_manager_Branch_ITdetails_todate WHERE fld_to_date > @fdate)  
order by Br_Name--,S,Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_Not_Update_21012013
-- --------------------------------------------------
CREATE Proc USP_DB_Not_Update_21012013(@fdate as varchar(11))          
as          
      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))       
          
select Distinct Br_Name from V_TCP_Servers x (nolock)   where not exists          
(select * from tbl_DB_Shrink_Data_new y (nolock)  where Fld_upd_Date = @fdate and x.Fld_Branch_cd = y.Fld_Branch_id)           

order by Br_Name--,S,Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_Not_Update_Uploadedfile
-- --------------------------------------------------

CREATE Proc USP_DB_Not_Update_Uploadedfile(@fdate as varchar(11))            
as            
        
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))         
            
select Distinct Br_Name from V_TCP_Servers x (nolock)   where exists            
(select * from tbl_uploadedfile_entry y (nolock)  where entrydate = convert(datetime,@fdate,103) and x.Fld_Branch_cd = y.fld_branch_id)             
order by Br_Name--,S,Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_Shrink_Check
-- --------------------------------------------------
CREATE proc USP_DB_Shrink_Check          
@Fld_Server_Id varchar(25),              
@Fld_Branch_Id varchar(25)       
      
as      
     
if (@Fld_Server_Id = '%%' and @Fld_Branch_Id ='%%')      
begin      
  select * from           
 (select * from V_Tbl_server_master(nolock) where fld_id like @Fld_Server_Id and fld_branch_cd like @Fld_Branch_Id)a          
 left outer join          
 (select * from tbl_DB_Shrink_Data_New (nolock))b          
 on a.fld_id = b.fld_server_id        
end    
if (@Fld_Server_Id = '%%' and @Fld_Branch_Id <> '%%')      
 begin       
 select * from           
 (select * from V_Tbl_server_master(nolock) where fld_id like @Fld_Server_Id and fld_branch_cd like @Fld_Branch_Id )a          
 left outer join          
 (select * from tbl_DB_Shrink_Data_New (nolock))b          
 on a.fld_id = b.fld_server_id       
end      
if(@Fld_Server_Id <> '%%' and @Fld_Branch_Id <> '%%')    
begin    
 if(select count(*) from tbl_DB_Shrink_Data_New(nolock) where fld_server_id = @Fld_Server_Id and fld_branch_id = @Fld_Branch_Id ) > 0      
 begin       
   --select * from tbl_DB_Shrink_Data (nolock) where fld_server_id = @Fld_Server_Id and fld_branch_id = @Fld_Branch_Id       
   select * from (select * from tbl_DB_Shrink_Data_New(nolock) where fld_server_id like @Fld_Server_Id           
   and fld_branch_id like @Fld_Branch_Id )a left outer join           
   (select * from V_Tbl_server_master(nolock)) b on a.fld_server_id = b.fld_id         
    
 end      
 else      
 begin   
  
select * from      
(select * from V_Tbl_server_master(nolock) where fld_id = @Fld_Server_Id and fld_branch_cd = @Fld_Branch_Id)a  
left outer join(select * from tbl_DB_Shrink_Data_New) b   
on a.fld_id  = b.fld_server_id  
end    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_Shrink_Check_New
-- --------------------------------------------------
CREATE Proc USP_DB_Shrink_Check_New            
(            
@Fld_Server_Id varchar(25),                            
@Fld_Branch_Id varchar(25),            
@Fld_Date varchar(11)            
)            
as            
--declare @Fld_Server_Id varchar(25)                           
--declare @Fld_Branch_Id varchar(25)            
--declare @Fld_Date varchar(11)  

--set @Fld_Server_Id='%%'
--set @Fld_Branch_Id ='%%'
--set @Fld_Date = convert(datetime,'18/07/2009',103)         
set @Fld_Date = convert(datetime,@Fld_Date,103)            
            
select * from            
(select * from V_Tbl_server_master(nolock) where status='Active' and Fld_Branch_cd<>'CMBTR' and Fld_branch_cd like @Fld_Branch_Id and Fld_id like @Fld_Server_Id )x            
left outer join            
(select * from tbl_DB_Shrink_Data_New (nolock) where fld_upd_date >= @Fld_Date and fld_upd_date <= @Fld_Date + ' 23:59:59')y            
on x.Fld_Branch_cd = y.Fld_Branch_id and x.Fld_id = y.Fld_Server_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_Shrink_Data
-- --------------------------------------------------
CREATE proc [dbo].[USP_DB_Shrink_Data]                                      
(                                      
@Fld_SrNo int,                                      
@Fld_Server_Id int,                                      
@Fld_Branch_Id varchar(25),                       
@Fld_Mdf_COD varchar(15),                                       
@Fld_Mdf_BQ varchar(15),                                      
@Fld_Mdf_AQ varchar(15),                                      
@Fld_Mdf_DD varchar(15),                                      
@Fld_Mdf_FS varchar(15),                      
@Fld_Ldf_COD varchar(15),                                  
@Fld_Ldf_BQ varchar(15),                                      
@Fld_Ldf_AQ varchar(15),                                      
@Fld_Ldf_DD varchar(15),                                      
@Fld_Ldf_FS varchar(15),                            
@Fld_Remark varchar(500),                                       
@Fld_Upd_By varchar(15),                                      
--@Fld_Sys_Date datetime,                                      
@Fld_Upd_Date varchar(50)      
                                    
)                                      
as                 
              
if (select count(*) from tbl_DB_Shrink_Data_New(nolock) where Fld_Server_Id = @Fld_Server_Id and fld_branch_id =@fld_branch_id and Fld_Upd_Date = convert(datetime,@Fld_Upd_Date,103) )=0              
begin              
 insert into tbl_DB_Shrink_Data_New values                                      
 (                                      
  @Fld_Server_Id,                                      
  @Fld_Branch_Id,                      
  @Fld_Mdf_COD,                                       
  @Fld_Mdf_BQ,                                      
  @Fld_Mdf_AQ,                                      
  @Fld_Mdf_DD,                                      
  @Fld_Mdf_FS,                      
  @Fld_Ldf_COD,                                  
  @Fld_Ldf_BQ,                                      
  isnull(@Fld_Ldf_AQ,'0'),                                      
  @Fld_Ldf_DD,                                      
  @Fld_Ldf_FS,                            
  @Fld_Remark,                                      
  @Fld_Upd_By,                                      
  getdate(),                                      
  --@Fld_Upd_Date                        
convert(datetime,@Fld_Upd_Date,103)                                      
 )                
end               
else              
begin        
if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@Fld_Upd_By) = 'ADMIN'          
Begin       
update tbl_DB_Shrink_Data_New set                                      
Fld_Server_Id = @Fld_Server_Id,                                      
Fld_Branch_Id = @Fld_Branch_Id,                      
Fld_Mdf_COD = @Fld_Mdf_COD,                                      
Fld_Mdf_BQ = @Fld_Mdf_BQ ,                                      
Fld_Mdf_AQ = @Fld_Mdf_AQ,                                      
Fld_Mdf_DD = @Fld_Mdf_DD,                                      
Fld_Mdf_FS = @Fld_Mdf_FS,                      
Fld_Ldf_COD = @Fld_Ldf_COD,                                  
Fld_Ldf_BQ = @Fld_Ldf_BQ,                                      
Fld_Ldf_AQ = isnull(@Fld_Ldf_AQ,'0'),                                      
Fld_Ldf_DD = @Fld_Ldf_DD,                                      
Fld_Ldf_FS = @Fld_Ldf_FS,                            
Fld_Remark = @Fld_Remark,                                      
--Fld_Upd_By = @Fld_Upd_By,                                         
Fld_Upd_Date = convert(datetime,@Fld_Upd_Date,103)                        
where Fld_Server_Id = @Fld_Server_Id and  fld_branch_id = @fld_branch_id and Fld_Upd_Date = convert(datetime,@Fld_Upd_Date,103)              
End      
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_SHRINK_REPORT
-- --------------------------------------------------
CREATE proc USP_DB_SHRINK_REPORT              
(                  
@Fld_Fdate varchar(11),          
@Fld_Tdate varchar(11),          
@Fld_Server_Id varchar(25),                                  
@Fld_Branch_Id varchar(25)                  
)                  
as             
          
set @Fld_Fdate = convert(datetime,@Fld_Fdate,103)           
set @Fld_Tdate = convert(datetime,@Fld_Tdate,103)            
          
select * from              
(select * from tbl_DB_Shrink_Data_new (nolock) where fld_branch_id like @Fld_Branch_Id and fld_server_id like @Fld_Server_Id and fld_upd_date >= @Fld_Fdate and fld_upd_date <= @Fld_Tdate + ' 23:59:59') a        
left outer join               
(select fld_id,fld_server from V_Tbl_server_master where status='Active') b               
on a.fld_server_id = b.fld_id            
left outer join            
(select person_name as emp_name,username  from intranet.risk.dbo.user_login)c            
on a.fld_upd_by = c.username   
left outer join
(select br_tag,br_name from tbl_it_br_master (nolock)  where br_type = 'DATACENTER' )d
on a.Fld_Branch_Id = d.br_tag
 order by br_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_SHRINK_REPORT_New
-- --------------------------------------------------
CREATE proc USP_DB_SHRINK_REPORT_New                    
(                        
@Fld_Fdate varchar(11),                
@Fld_Tdate varchar(11),                
@Fld_Server_Id varchar(25),                                        
@Fld_Branch_Id varchar(25)                        
)                        
as                   
      
      
-- declare @Fld_Fdate varchar(11)      
-- declare @Fld_Tdate varchar(11)      
-- declare @Fld_Server_Id varchar(25)      
-- declare @Fld_Branch_Id varchar(25)                        
--       
-- set @Fld_Fdate = 'Nov 08 2008'      
-- set @Fld_Tdate = 'Nov 08 2008'      
-- set @Fld_Server_Id = '%%'      
-- set @Fld_Branch_Id = '%%'      
             
set nocount on      
         
set @Fld_Fdate = convert(datetime,@Fld_Fdate,103)                 
set @Fld_Tdate = convert(datetime,@Fld_Tdate,103)            
      
select distinct Fld_server_id into #x from tbl_DB_Shrink_Data_new (nolock) where       
fld_branch_id like @Fld_Branch_Id and fld_server_id like @Fld_Server_Id and fld_upd_date >= @Fld_Fdate and fld_upd_date <= @Fld_Tdate + ' 23:59:59'      
      
select * into #y from      
(      
select 'INTEGRATED ODIN(.mdf)' as MDF_LDf,Fld_Mdf_COD,Fld_Mdf_BQ,Fld_Mdf_AQ,Fld_Mdf_DD,Fld_Mdf_FS,Fld_Server_Id,Fld_Branch_id,Fld_Remark,fld_upd_by from tbl_DB_Shrink_Data_new where Fld_Server_id in (select * from #x)      
union      
select 'TRANSACTION LOG SPACE(.ldf)',Fld_Ldf_COD,Fld_Ldf_BQ,Fld_Ldf_AQ,Fld_Ldf_DD,Fld_Ldf_FS,Fld_Server_Id,Fld_Branch_id,Fld_Remark,fld_upd_by  from tbl_DB_Shrink_Data_new where Fld_Server_id in (select * from #x)      
)a      
left outer join      
(select fld_id,fld_server,Fld_Odin_Ip from V_Tbl_server_master where status='Active') b                     
on a.fld_server_id = b.fld_id                  
left outer join                  
(select person_name as emp_name,username  from intranet.risk.dbo.user_login)c                  
on a.fld_upd_by = c.username         
left outer join      
(select br_tag,br_name from tbl_it_br_master (nolock)  where br_type = 'DATACENTER' )d      
on a.Fld_Branch_Id = d.br_tag      
order by br_name,fld_server,mdf_ldf      
      
select distinct x.*,y.br_name as Branches,    
case when x.Fld_Server like '%)' then substring(x.Fld_Server,0,charindex('(',x.Fld_Server)-1)     
 else x.Fld_Server end as Serv,convert(numeric,case when x.Fld_Server like '%)' then substring(x.Fld_Server,charindex('(',x.Fld_Server)+1,     
 charindex(')',x.Fld_Server)-(charindex('(',x.Fld_Server)+1)) else 0 end) as Num from      
(select * from #y)x      
left outer join      
(select * from #y where Fld_Remark <> '')y      
on x.Fld_Branch_id = y.Fld_branch_Id      
-- and x.Fld_server_id = y.Fld_server_id and x.mdf_ldf = y.mdf_ldf      
order by Serv,Num,x.Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_SHRINK_REPORT_New1
-- --------------------------------------------------
CREATE proc USP_DB_SHRINK_REPORT_New1                                                        
(                                                            
@Fld_Fdate varchar(25),                                                                                          
@Fld_Server_Id varchar(25),                                                                            
@Fld_Branch_Id varchar(25)                                                            
)                                                            
as                                                       
                                          
--                                          
-- declare @Fld_Fdate varchar(25)                                          
-- declare @Fld_Tdate varchar(25)                                          
-- declare @Fld_Server_Id varchar(25)                                          
-- declare @Fld_Branch_Id varchar(25)                                                            
--                                           
-- set @Fld_Fdate = 'Nov 29 2008'                                          
-- set @Fld_Tdate = 'Nov 29 2008'                                          
-- set @Fld_Server_Id = '%%'                                          
-- set @Fld_Branch_Id = '%%'                                          
                                                 
set nocount on                                          
                                             
--set @Fld_Fdate = convert(datetime,@Fld_Fdate,103)                                                     
--set @Fld_Tdate = convert(datetime,@Fld_Tdate,103)                                                
--print @Fld_Tdate                                          
select distinct Fld_server_id into #x from tbl_DB_Shrink_Data_new (nolock) where                                           
fld_branch_id like @Fld_Branch_Id and fld_server_id like @Fld_Server_Id and fld_upd_date = Convert(datetime,@Fld_Fdate,103)                                           
                                          
select * into #y from                                          
(                                          
select 'INTEGRATED ODIN(.mdf)' as MDF_LDf,                                                      
                                                      
(convert(float,isnull(replace(replace(replace(fld_mdf_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 as permdf,                                                      
isnull(replace(replace(replace(replace(replace(Fld_Mdf_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as mdf_fs,                                                      
isnull(replace(replace(replace(replace(replace(fld_mdf_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as mdf_AQ,                                                      
isnull(replace(replace(replace(replace(replace(Fld_mdf_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as mdf_BQ,                                                      
/*                                                      
(convert(float,replace(replace(replace(fld_mdf_COD,right(fld_mdf_COD,2),''),',',''),'')*10)/100  as permdf,                                                      
replace(Fld_Mdf_FS,right(fld_mdf_FS,2),'') as mdf_fs,                                                      
replace(replace(fld_mdf_AQ,right(fld_mdf_AQ,2),''),',','') as mdf_AQ,                                                      
replace(replace(Fld_mdf_BQ,right(fld_mdf_BQ,2),''),',','') as mdf_BQ,                                                      
*/                                                      
Fld_Mdf_COD,Fld_Mdf_BQ,Fld_Mdf_AQ,Fld_Mdf_DD,Fld_Mdf_FS,Fld_Server_Id,Fld_Branch_id,                                                      
Fld_Remark,fld_upd_by from tbl_DB_Shrink_Data_new(nolock) where Fld_Server_id in (select * from #x) and fld_upd_date = Convert(datetime,@Fld_Fdate,103)                                           
union                                          
select 'TRANSACTION LOG SPACE(.ldf)',                                                      
                                                    
(convert(float,isnull(replace(replace(replace(fld_Ldf_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 as perldf,                            
isnull(replace(replace(replace(replace(replace(fld_ldf_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as ldf_fs,                                                      
isnull(replace(replace(replace(replace(replace(fld_ldf_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as ldf_AQ,                               
isnull(replace(replace(replace(replace(replace(Fld_ldf_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as ldf_BQ,                                                      
/*                                                      
(convert(float,replace(replace(fld_Ldf_COD,right(fld_mdf_COD,2),''),',',''))*10)/100  as perldf,                                                      
replace(Fld_ldf_FS,right(fld_ldf_FS,2),'') as ldf_fs,                                                      
replace(replace(fld_ldf_AQ,right(fld_ldf_AQ,2),''),',','') as ldf_AQ,                                                      
replace(replace(Fld_ldf_BQ,right(fld_ldf_BQ,2),''),',','') as ldf_BQ,                                                      
*/                                  
Fld_Ldf_COD,Fld_Ldf_BQ,Fld_Ldf_AQ,Fld_Ldf_DD,Fld_Ldf_FS,Fld_Server_Id,Fld_Branch_id,Fld_Remark,fld_upd_by  from tbl_DB_Shrink_Data_new(nolock) where Fld_Server_id in (select * from #x) and fld_upd_date = Convert(datetime,@Fld_Fdate,103)                   
  
    
     
         
          
            
                                      
)a                                           
left outer join                                          
(select fld_id,fld_server,fld_DB_Ip,Fld_Odin_Ip from V_Tbl_server_master(nolock)) b                                                         
on a.fld_server_id = b.fld_id                                                      
left outer join                                                      
(select person_name as emp_name,username  from intranet.risk.dbo.user_login)c                                                      
on a.fld_upd_by = c.username                                             
left outer join                                          
(select br_tag,br_name from tbl_it_br_master (nolock)  where br_type = 'DATACENTER' )d                                          
on a.Fld_Branch_Id = d.br_tag                                          
order by br_name,fld_server,mdf_ldf                                         
       
-- --old query                                   
--select distinct x.*,y.br_name as Branches,                                        
--case when x.Fld_Server like '%)' then substring(x.Fld_Server,0,charindex('(',x.Fld_Server)-1)                                         
-- else x.Fld_Server end as Serv,convert(numeric,case when x.Fld_Server like '%)' then substring(x.Fld_Server,charindex('(',x.Fld_Server)+1,                                         
-- charindex(')',x.Fld_Server)-(charindex('(',x.Fld_Server)+1)) else 0 end) as Num,                          
--case when x.permdf>x.mdf_fs then '<font color="red">'+ x.fld_mdf_cod+'</font>' else x.fld_mdf_cod end as fld_mdf_cod,                          
--case when x.permdf>x.mdf_fs then '<font color="red">'+x.fld_mdf_fs+'</font>' else x.fld_mdf_fs end as fld_mdf_fs,                        
--case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_BQ+'</font>' else x.Fld_Mdf_BQ end as fld_m_BQ,                          
--case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_AQ+'</font>' else x.Fld_Mdf_AQ end as fld_m_AQ from                                          
--(select * from #y)x                                          
--left outer join                                          
--(select * from #y where Fld_Remark <> '')y                                          
--on x.Fld_Branch_id = y.Fld_branch_Id                                          
---- and x.Fld_server_id = y.Fld_server_id and x.mdf_ldf = y.mdf_ldf                                          
--order by Serv,Num,x.Fld_id       
      
---new query megha     

select   distinct  x.*,y.br_name as Branches,                                        
case when x.Fld_Server like '%)' then substring(x.Fld_Server,0,charindex('(',x.Fld_Server)-1)     
else x.Fld_Server end as Serv,    
convert(numeric,case when x.Fld_Server like '%)' then substring(x.Fld_Server,charindex('(',x.Fld_Server)+1,                                         
charindex(')',Convert(varchar,x.Fld_Server))-(charindex('(',Convert(varchar,x.Fld_Server))+1)) else 0 end) as Num,                          
case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ Convert(varchar,x.fld_mdf_cod) + '</font>' else Convert(varchar,x.fld_mdf_cod) end as fld_mdf_cod,    
case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ convert(varchar,x.fld_mdf_fs)+'</font>' else Convert(varchar,x.fld_mdf_fs) end as fld_mdf_fs,    
----case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_BQ+'</font>' else x.Fld_Mdf_BQ end as fld_m_BQ--,                          
case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_BQ)+'</font>' else Convert(varchar,x.Fld_Mdf_BQ) end as fld_m_BQ,      
--case when Convert(decimal(10,2),x.mdf_AQ)>Convert(decimal(10,2),x.mdf_BQ) then '<font color="red">'+x.Fld_Mdf_AQ+'</font>' else x.Fld_Mdf_AQ end as fld_m_AQ       
case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_AQ)+'</font>' else Convert(varchar,x.Fld_Mdf_AQ) end as fld_m_AQ       
from    
(select * from #y)x                                          
left outer join                                          
(select * from #y where Fld_Remark <> '')y                                          
on x.Fld_Branch_id = y.Fld_branch_Id                                          
-- and x.Fld_server_id = y.Fld_server_id and x.mdf_ldf = y.mdf_ldf                                          
order by Serv,Num,x.Fld_id        
---end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DB_SHRINK_REPORT_New1_bak
-- --------------------------------------------------
CREATE proc USP_DB_SHRINK_REPORT_New1_bak--  'Aug 11 2012','all','all'                                                        
(                                                              
@Fld_Fdate varchar(25),                                                                                            
@Fld_Server_Id varchar(25),                                                                              
@Fld_Branch_Id varchar(25)                                                              
)                                                              
as                                                         
                                            
                                         
                                                   
set nocount on                                            
                                          
select distinct Fld_server_id into #x from tbl_DB_Shrink_Data_new (nolock) where                                             
fld_branch_id like @Fld_Branch_Id and fld_server_id like @Fld_Server_Id and fld_upd_date = Convert(datetime,@Fld_Fdate,103)                                             
                                            
select * into #y from                                            
(                                            
select 'INTEGRATED ODIN(.mdf)' as MDF_LDf,                                                        
                                                        
(convert(float,isnull(replace(replace(replace(fld_mdf_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 as permdf,                                                        
isnull(replace(replace(replace(replace(replace(Fld_Mdf_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as mdf_fs,                                                        
isnull(replace(replace(replace(replace(replace(fld_mdf_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as mdf_AQ,                                                        
isnull(replace(replace(replace(replace(replace(Fld_mdf_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as mdf_BQ,                                                        
                                                       
Fld_Mdf_COD,Fld_Mdf_BQ,Fld_Mdf_AQ,Fld_Mdf_DD,Fld_Mdf_FS,Fld_Server_Id,Fld_Branch_id,                                                        
Fld_Remark,fld_upd_by from tbl_DB_Shrink_Data_new(nolock) where Fld_Server_id in (select * from #x) 
and fld_upd_date = Convert(datetime,@Fld_Fdate,103)                                     

union                                            
select 'TRANSACTION LOG SPACE(.ldf)',                                                        
                                                      
(convert(float,isnull(replace(replace(replace(fld_Ldf_COD,'GB',''),'KB',''),'MB',''),0))*10)/100 as perldf,                              
isnull(replace(replace(replace(replace(replace(fld_ldf_FS,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as ldf_fs,                                                        
isnull(replace(replace(replace(replace(replace(fld_ldf_AQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as ldf_AQ,                                 
isnull(replace(replace(replace(replace(replace(Fld_ldf_BQ,',',''),'GB',''),'KB',''),'MB',''),'NA','0'),0) as ldf_BQ,                                                        

                                   
Fld_Ldf_COD,Fld_Ldf_BQ,Fld_Ldf_AQ,Fld_Ldf_DD,Fld_Ldf_FS,Fld_Server_Id,Fld_Branch_id,Fld_Remark,fld_upd_by
  from tbl_DB_Shrink_Data_new(nolock) where Fld_Server_id in (select * from #x) and fld_upd_date = Convert(datetime,@Fld_Fdate,103)                  
)a                                             
left outer join                                            
(select fld_id,fld_server,fld_DB_Ip,Fld_Odin_Ip from V_Tbl_server_master(nolock)) b                                                           
on a.fld_server_id = b.fld_id                                                        
left outer join                                                        
(select person_name as emp_name,username  from intranet.risk.dbo.user_login)c                                                        
on a.fld_upd_by = c.username                                               
left outer join                                            
(select br_tag,br_name from tbl_it_br_master (nolock)  where br_type = 'DATACENTER' )d                                            
on a.Fld_Branch_Id = d.br_tag                                            
order by br_name,fld_server,mdf_ldf                                           
         
 
  
select   distinct  x.*,y.br_name as Branches,                                          
case when x.Fld_Server like '%)' then substring(x.Fld_Server,0,charindex('(',x.Fld_Server)-1)       
else x.Fld_Server end as Serv,      
convert(numeric,case when x.Fld_Server like '%)' then substring(x.Fld_Server,charindex('(',x.Fld_Server)+1,                                           
charindex(')',Convert(varchar,x.Fld_Server))-(charindex('(',Convert(varchar,x.Fld_Server))+1)) else 0 end) as Num,                            
case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ Convert(varchar,x.fld_mdf_cod) + '</font>' else Convert(varchar,x.fld_mdf_cod) end as fld_mdf_cod,      
case when Convert(varchar,x.permdf)>Convert(varchar,x.mdf_fs) then '<font color="red">'+ convert(varchar,x.fld_mdf_fs)+'</font>' else Convert(varchar,x.fld_mdf_fs) end as fld_mdf_fs,      
case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_BQ)+'</font>' else Convert(varchar,x.Fld_Mdf_BQ) end as fld_m_BQ,        
case when x.mdf_AQ>x.mdf_BQ then '<font color="red">'+convert(varchar,x.Fld_Mdf_AQ)+'</font>' else Convert(varchar,x.Fld_Mdf_AQ) end as fld_m_AQ         
from      
(select * from #y)x                                            
left outer join                                            
(select * from #y where Fld_Remark <> '')y                                            
on x.Fld_Branch_id = y.Fld_branch_Id                                            
order by Serv,Num,x.Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_delayed_details
-- --------------------------------------------------
CREATE proc usp_delayed_details (@fdate as varchar(11),@tdate as varchar(11),@Req_ID as varchar(5), @code as varchar(25))  
as  
  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))   
  
select * from V_Mis_Rpt (nolock) where Fld_Status = 'P' and               
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and   
Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID               
and region_code = @code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_delete_solution_hr
-- --------------------------------------------------
create proc Usp_delete_solution_hr
(
@subjectid as int
)
as

update tbl_hr_subjectmaster set fldsubjectstatus = 'N' where fldsubjectid = @subjectid

update tbl_hr_solutionmaster set fldsolutionstatus = 'N' where fldsolutionid in 
(select fldsolutionid from tbl_HR_SubjectSolution where fldsubjectid = @subjectid)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_dept_insert
-- --------------------------------------------------
CREATE proc usp_dept_insert     
(    
 @deptname varchar(100)      
)    
as      
begin      
insert into dept_mast(dept_name ,dummy1,dummy5) values (@deptname,'Active',@deptname)      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_DIRTextFileReport
-- --------------------------------------------------
CREATE proc usp_DIRTextFileReport(@datacenter as varchar(30),@version as varchar(50))                    
as                    
if @datacenter = '%All%'          
begin          
set @datacenter= '%%'          
end       
if @version = '%All%'          
begin          
set @version= '%%'          
end      
/*else if @datacenter = '%Ahmedabad (Mahalay)%'          
begin          
set @datacenter= '%Ahmedabad%'          
end          
else if @datacenter = '%Ghatkopar (E)%'          
begin          
set @datacenter= '%Ghatkopar%'          
end          
else if @datacenter = '%Rajkot (Star-301)%'          
begin          
set @datacenter= '%Rajkot%'          
end  */        
select * from tbl_DIRTextFileUpload(nolock) where manager like @datacenter and  folder like @version      
--convert(datetime,date,121)>=convert(datetime,@fdate,121) and           
--convert(datetime,date,121)<=convert(datetime,@tdate,121) order by date desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_DIRTextFileReport1
-- --------------------------------------------------
CREATE proc usp_DIRTextFileReport1(@datacenter as varchar(30))                      
as                      
if @datacenter = '%All%'            
begin            
set @datacenter= '%%'            
end              
select filename from tbl_DIRTextFile_Master where filename not in
(select filename from tbl_DIRTextFileUpload(nolock) where manager like @datacenter)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Downtime_cal_proc
-- --------------------------------------------------




CREATE Proc USP_Downtime_cal_proc(@fdate as varchar(67))              
as            
          
              
-----------------------Fetch Brokerage----------                                                  
select company,Terminal_id,Brokerage=sum(Brokerage)                                                                                                
into #terminal_brok                                                   
--from mis_terminal_brok where sauda_date >= @fdate and                                                   
from intranet.bsedb_ab.dbo.mis_to_terminal  where sauda_date >= @fdate and                                                   
sauda_date <= @fdate group by company,Terminal_id               
              
------------------------Get Details of All servers upto for that day---------------              
select * into #Terminal_id from V_Manager_Details where @fdate >= sdate and @fdate <= tdate              
              
-------------------------Server wise Brokerage--------------              
              
select y.Fld_Id as Server,x.company as segment,sum(x.brokerage) as brokerage into #ser_brok  from #terminal_brok x,                                                
(select * from #Terminal_id with(nolock) where @fdate >= sdate and @fdate <= tdate) y where x.Terminal_id=y.Fld_Manager_id                                                
group by y.Fld_Id,x.company              
              
------------------------Details for not traded server              
insert into #ser_brok              
select Distinct Fld_id,Fld_segment,0 from #Terminal_id x where not exists              
(select * from #ser_brok y where x.Fld_id = y.server)              
              
-----------------------Cursor For calculate Downtime Brokerage-----------               
              
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)),                                                  
Problem into #downtime from newtab1 with(nolock) where dt >= @fdate and dt <= @fdate  
group by Location,ImpactedSegemnt,problem                                               
              
select Top 0 server,segment, brokerage,space(40) as dt,space(40) as uptime,              
space(40) as Brk_Loss,space(40) as Sauda_date,space(40) as Issues,space(100) as Exchanges               
into #temp_cal from #ser_brok                    
            
              
DECLARE @location varchar(100),@segment as varchar(100),@downtime as varchar(50),@issues as varchar(100)                                                  
DECLARE authors_cursor CURSOR FOR select Location,ImpactedSegemnt,Downtimemin,Problem from #downtime where Impactedsegemnt <> 'None'                                                   
                                               
OPEN authors_cursor                                                                        
                                                                      
FETCH NEXT FROM authors_cursor                                      
INTO @location,@segment,@downtime,@issues                                                                        
                                                                        
WHILE @@FETCH_STATUS = 0                                                                        
BEGIN                                                    
                                                  
                                                          
if @segment = 'NCDEX'                                                                  
 Begin                                                                  
   insert into #temp_cal                                   
   select @location,'ACPLNCDEX',b.brokerage,@downtime,'','',@fdate,                                                                        
@issues,@segment from #downtime a inner join #ser_brok b on                                         
   case when a.impactedsegemnt = 'NCDEX' then 'ACPLNCDEX' end = b.segment and @location = b.server                                                     
 End         
                                                                      
if @segment = 'MCX'                                                                                   
 Begin                                                                  
   insert into #temp_cal                                               
   select @location,'ACPLMCX',b.brokerage,@downtime,'','',@fdate,@issues,@segment from #downtime a inner join #ser_brok b on                                
   case when a.impactedsegemnt = 'MCX' then 'ACPLMCX' end = b.segment and @location = b.server                                                                         
 end                                                                  
                                                                  
if @segment = 'BSECM'                                                                       
 Begin                                                                     
   insert into #temp_cal                                                                        
select @location,'ABLCM',b.brokerage,@downtime,'','',@fdate,                                                                        
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                         
   case when a.impactedsegemnt = 'BSECM' then 'ABLCM' end = b.segment and @location = b.server                                                                         
 end                                                                  
                                                                  
if @segment = 'NSEFO'                                                                           
 Begin                                                                     
   insert into #temp_cal                                                                        
   select @location,'ACDLFO',b.brokerage,@downtime,'','',@fdate,                                                                        
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                         
   case when a.impactedsegemnt = 'NSEFO' then 'ACDLFO' end = b.segment and @location = b.server                                                                         
 end                                                                  
                                                                  
if @segment = 'NSECM'                                                                           
 Begin                                                                         
   insert into #temp_cal                                                                        
   select @location,'ACDLCM',b.brokerage,@downtime,'','',@fdate,                                                                        
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                         
   case when a.impactedsegemnt = 'NSECM' then 'ACDLCM' end = b.segment and @location = b.server                           
 end                                                                 
         
  ----Zeba            
 if @segment = 'NSECD'                                                                                             
 Begin                                                                                           
   insert into #temp_cal                                                                                          
   select @location,'ACDLNSX',b.brokerage,@downtime,'','',@fdate,                                                                                          
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                                           
   case when a.impactedsegemnt = 'NSECD' then 'ACDLNSX' end = b.segment and @location = b.server                                             
 end         
         
if @segment = 'MCXCD'                                                                                             
 Begin                                                                                           
   insert into #temp_cal                                                                                          
   select @location,'ACPLMCD',b.brokerage,@downtime,'','',@fdate,                                                                                          
   @issues,@segment from #downtime a inner join #ser_brok b on                                                                                           
   case when a.impactedsegemnt = 'MCXCD' then 'ACPLMCD' end = b.segment and @location = b.server                                             
 end      
      
                                               
 FETCH NEXT FROM authors_cursor                                                                         
 INTO @location,@segment,@downtime,@issues                                                                        
END                                                                        
                                                                        
CLOSE authors_cursor                                                       
DEALLOCATE authors_cursor                                   
                   
              
------------------------------Cursor End------------              
                                   
              
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX),ACDLNSX=sum(ACDLNSX),ACPLMCD=sum(ACPLMCD)                                                                                                
into #tt from sett_mst with(nolock) where tdate = @fdate                 
              
select distinct * into #act_calc from #temp_cal              
              
insert into #act_calc              
select *,0,0,0,@fdate,'','' from #ser_brok x where not exists              
(select * from #temp_cal y where x.server = y.server and x.Segment = y.segment)              
              
              
update #act_calc set uptime = (select bse from #tt) where segment = 'ABLCM'                                                  
update #act_calc set uptime = (select cm from #tt) where segment = 'ACDLCM'               
update #act_calc set uptime = (select fo from #tt) where segment = 'ACDLFO'                                                  
update #act_calc set uptime = (select mcx from #tt) where segment = 'ACPLMCX'                               
update #act_calc set uptime = (select ncdex from #tt) where segment = 'ACPLNCDEX'          
---updated Zeba        
update #act_calc set uptime = (select ACDLNSX from #tt) where segment = 'ACDLNSX'---Zeba     
update #act_calc set uptime = (select ACPLMCD from #tt) where segment = 'ACPLMCD'---Zeba        
---Zeba        
                     
              
              
delete from terminal_brok_loss where sauda_date = @fdate              
              
insert into terminal_brok_loss              
select  server, segment, Brokerage, dt, uptime,           
case when  uptime <> 0 then          
(((convert(dec,dt)/convert(dec,uptime))*100)*(convert(dec,Brokerage)))/100          
else 0 end,              
sauda_date=convert(datetime,sauda_date),Issues,Exchanges from #act_calc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Edit_Br_Master
-- --------------------------------------------------
CREATE Proc USP_Edit_Br_Master  
(  
@Br_Tag varchar(15),  
@Br_Name varchar(50), 
@Br_Type varchar(50),  
@Br_Region varchar(20),  
@Br_Contact_Person varchar(200),  
@Br_Address varchar(300),  
@Br_Email varchar(200),  
@Br_TelNo varchar(200),  
@Br_Fax varchar(200),  
@Br_Head  varchar(200),  
@Br_CellNo varchar(200),
@Br_Head_Mails varchar(200),
@Sr_No varchar(10)  
)  
as  
  
update tbl_it_br_master set Br_Tag = @Br_Tag,Br_Name = @Br_Name,Br_Type = @Br_Type,Br_Region = @Br_Region,
Br_Contact_Person = @Br_Contact_Person,Br_Address = @Br_Address,Br_Email = @Br_Email,Br_TelNo = @Br_TelNo,
Br_Fax = @Br_Fax,Br_Head = @Br_Head,Br_CellNo = @Br_CellNo,Br_Head_Mails=@Br_Head_Mails where Br_Tag = @Sr_No

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_empComplaint_details
-- --------------------------------------------------
CREATE proc USP_empComplaint_details --'E459690'               
(                
@complainNo varchar(10)                
)                
as                
              
--select emp_no,emp_name,Senior,sr_name,lower(email) as email,phone from emp_info where emp_no=left(@complainNo,6)              
              
/*select x.*, y.fldsubcatid,y.fldsubcatname,y.Fld_Subject,y.Fld_Query,w.fldsubjectname from               
(          
--select emp_no,emp_name,Senior,sr_name,lower(email) as email,phone from intranet.risk.dbo.View_Emp_info          
select [Emp No] as emp_no,emp_name,[HOD NO] Senior,[HOD NAME] sr_name,lower(emailadd) as email,phone from hrsoft.angelbroking.dbo.Vlms          
where [Emp No] = left(@complainNo,6)) x              
inner join              
(              
select x.Fld_Emp_Code,y.fldsubcatid,y.fldsubcatname,x.Fld_Subject,x.Fld_Query,y.fldsubjectname from              
(select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_Complaint_No =  @complainNo) x              
inner join              
(select * from tbl_hr_catmaster) y              
on x.Fld_Request_id =  y.fldsubcatid )y    
on x.emp_no = y.Fld_emp_Code     
inner join     
(select * from tbl_hr_subjectmaster (nolock))w    
on x.fld_subject = w.fldsubjectid*/    
  
select * from    
(select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_Complaint_No = @complainNo)x    
inner join     
(select * from tbl_hr_subcatmaster) y     
on x.Fld_Request_id =  y.fldsubcatid    
inner join     
(select * from tbl_hr_subjectmaster (nolock))w    
on x.fld_subject = w.fldsubjectid    
inner join    
(select emp_no,emp_name,Senior,sr_name,email,phone from intranet.risk.dbo.emp_info where emp_no = left(@complainNo,6))z    
on x.Fld_emp_Code = z.emp_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_exp_details
-- --------------------------------------------------
CREATE PROCEDURE usp_exp_details       
(                                            
@fdt as varchar(11),@tdt as varchar(11),@exp_code as varchar(10),@access_to as varchar(25),@access_code as varchar(25)                                             
)                                            
 as                                             
set nocount on                                             
set transaction isolation level read uncommitted                     
    
declare @fdt1 as datetime    
declare @tdt1 as datetime    
set @fdt1=convert(datetime,@fdt,103)    
set @tdt1=convert(datetime,@tdt,103)    
select v_no,inv_no,narration,v_date,emp_no,segment,ven_name,                  
ven_code,entry_date,status,total into #file1 from intranet.angelvms.dbo.vouchermaster  where len(v_date)>=10                  
              
select v_no,inv_no,narration,convert(datetime,v_date,103) as v_date, emp_no,segment,ven_name,                  
ven_code,entry_date,status,total into #file2 from #file1                  
              
--declare @exp_code as varchar(25)                    
--set @exp_code='5800013'      
--set @exp_code='520021'      
select * into #data from #file2 where v_date>=@fdt1 and v_date<=@tdt1                      
--select distinct ven_code,segment into #temp2 from #temp1                      
--select b.* from #temp2 a  right outer join vendormaster b (nolock) on a.ven_code=b.cltcode and a.segment=b.segment where a.ven_code is not null and a.segment is not null order by segment                      
--end             
      
--select * from vouchermaster      
select * into #file3 from intranet.angelvms.dbo.voucherentry  
where  v_code =@exp_code and v_no in (select v_no from #data) order by v_no       
--select * from #file3      
select a.v_no[JV No.],a.inv_no [Inv. No.],a.Segment,a.ven_name [Vendor Name],a.ven_code [Vendor Code],      
b.v_code as [ExpenseCode],b.ac_name as [ExpenseName],b.Amount,      
b.Br_Tag as[BranchTag] into #file4 from intranet.angelvms.dbo.vouchermaster a inner join #file3 b on a.v_no=b.v_no       
--select * from #file5      
--select * from billmaster      
--select * from voucher_details      
select a.*,b.IO_NO into #file5 from #file4 a left outer join intranet.angelvms.dbo.voucher_details b on a.[JV No.]=b.v_no      
      
      
select a.*,case when b.exp_fdt='01/01/1900' then 'Not Available' else convert(varchar(11),b.exp_fdt,103) end  as [Expense from date],      
case when b.exp_tdt='01/01/1900' then 'Not Available' else convert(varchar(11),exp_tdt,103) end  as [Expense to date],      
b.LOB,b.Order_Maker,b.eid_Branch       
into #file6 from #file5 a left outer join intranet.angelvms.dbo.billmaster b on a.IO_NO= b.v_no      
      
select a.*,b.person_name into #file7 from #file6 a left outer join intranet.risk.dbo.user_login b on a.eid_branch=b.username      
      
--select * from #file7      
select [JV No.],IO_NO as [IO. SrNO],[Inv. No.],Segment,[Vendor Name],[Vendor Code],ExpenseCode,      
ExpenseName,Amount,BranchTag,[Expense from date],[Expense to date],LOB,Order_Maker,eid_Branch as [Branch UserID],person_name as [Branch User Name]       
from #file7       
      
      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Fetch_Brokerage
-- --------------------------------------------------
CREATE Proc Usp_Fetch_Brokerage(@sauda_date as varchar(15))    
as        
-- insert into terminal_brok    
-- select Company, sauda_Date, branch_cd, sub_broker, party_code, party_name, Terminal_Id,     
-- Turnover, brokerage from intranet.bsedb_ab.dbo.mis_to where sauda_Date = convert(datetime,@sauda_date,103)  

insert into mis_terminal_brok
select Company,Terminal_Id,sauda_Date,Turnover,brokerage,
To_Trd_fut,TO_Del_opt,Bk_trd_fut,Bk_del_opt 
from intranet.bsedb_ab.dbo.mis_to_terminal where sauda_Date = convert(datetime,@sauda_date,103)  
--from intranet.bsedb_ab.dbo.mis_to_terminal where sauda_Date = 'Jan 01 2007'
    
insert into Brokerage_Sauda_Date values  (convert(datetime,@sauda_date,103))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Fetch_BrReport
-- --------------------------------------------------

CREATE Proc [dbo].[Usp_Fetch_BrReport](@Type as varchar(10),@branch as varchar(50),@DC_Type as varchar(15),@order_by_column varchar(50),@Sort varchar(10),@buss_category varchar(05))            
as            
            
declare @str as varchar(1000)         
declare @code as varchar(50)         
        
set @branch = (case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end)            
        
set @code = case           
when @Type = 'C' then 'where  Br_Tag '+@branch+' and'          
when @Type = 'N' then 'where  Br_Name '+@branch+' and'          
when @Type = 'R' then 'where  Br_Region '+@branch+' and'         
--when @Type = 'ALL' then 'where'         
end           
            
--set @str = 'select * from tbl_it_br_master where '+@code+' and Br_Type like '''+@Type+''' order by br_type'            
set @str = 'select *,case     
when Fld_Business_Category  = ''B'' then ''BRANCH''    
when Fld_Business_Category  = ''O'' then ''OTHERS''     
when Fld_Business_Category  = ''R'' then ''RO''     
when Fld_Business_Category  = ''F'' then ''FRANCHISEE''     
when Fld_Business_Category  = ''C'' then ''CSO'' END    
AS Fld_Cat from tbl_it_br_master '+@code+' Br_Type like ''%'+@DC_Type+'%''  and Fld_Business_Category like '''+@buss_category+'''  
order by '+@order_by_column+' '+@Sort       
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Fetch1_UPS_Data
-- --------------------------------------------------
CREATE PROC [DBO].USP_FETCH1_UPS_DATA                    
(                            
 @DATE VARCHAR(15),                                      
 @BRANCHID INT,                                      
 @BRTAG VARCHAR(15)                            
)                            
AS                            
 DECLARE @FDATE VARCHAR(15)                
 SET @FDATE= @DATE                
 SET @DATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE,103),121)                
 DECLARE @CSONAME AS VARCHAR(50)                
 SELECT @CSONAME = FLD_REGNAME FROM TBL_REGION_MASTER WHERE FLD_REGCODE = @BRTAG                
IF(@BRANCHID <> 0)                
 BEGIN                
  SELECT A.FLD_SRNO,A.UPS_ID AS [UPSID],A.UPS_NAME,                
  h.AGV_DAILY_LOAD,                
  CASE WHEN h.TOTAL_TESTINGTIME = 0 THEN '' ELSE h.TOTAL_TESTINGTIME END AS TOTAL_TESTINGTIME,                
  h.TOTAL_LOAD_INPER,                
  h.REMARK,                                    
  FLD_MODEL_CAPACITY,FLD_MODEL_NAME,A.BR_NAME,g.CSONAME as Fld_RegName,                            
  (A.UPS_NAME + '-'+ (CASE WHEN FLD_MODEL_NAME IS NULL THEN '-' ELSE FLD_MODEL_NAME END) + '-' + FLD_MODEL_CAPACITY) AS UPS_MODEL, ----ADDED THREE COLUMNS BY HARSHAL 22 FEB 2013                                    
  FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID,A.UPS_MAP_ID,@CSONAME AS CSONAME,FLD_BRANCH_ID                                      
  --CASE WHEN B.FLD_SRNO IS NULL THEN 'INSERT' ELSE 'UPDATE' END STATUS,B.*,          
 -- C.EMP_NAME                                      
  FROM                                                    
  (SELECT * FROM V_UPS_MASTER(NOLOCK) s             
   WHERE FLD_BRANCH_ID = @BRANCHID                         
  AND DeactivatedOn >= Convert(datetime,@FDATE,103)            
  )A                                                    
  --LEFT OUTER JOIN                                              
  --(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK)                                       
  --WHERE CONVERT(VARCHAR(11),FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID = @BRANCHID)B                                               
  --ON A.FLD_SRNO = B.FLD_UPS_ID                                        
  --LEFT OUTER JOIN                                        
  --INTRANET.RISK.DBO.EMP_INFO C                                     
 -- ON B.FLD_FOB = C.EMP_NO                             
  left outer join V_CSONAMES g on A.Fld_Branch_id = g.Sr_No                   
  left outer join tbl_ups_data h on A.Fld_srNo  = h.fld_ups_id and Fld_Entry_date = Convert(datetime,@FDATE,103)     
  and A.Fld_Branch_id = h.fld_branch              
  --Where h. Fld_Entry_date = Convert(datetime,@FDATE,103)               
  ORDER BY A.UPS_ID                    
 END                    
ELSE                    
 BEGIN                    
  CREATE TABLE #T(BRCODE INT,BRTAG VARCHAR(15),BRNAME VARCHAR(100))                                        
  INSERT INTO #T                                        
  EXEC USP_WAN_SEARCH_BRANCH @BRTAG                    
                            
  SELECT A.FLD_SRNO ,A.UPS_ID AS [UPSID],A.UPS_NAME,                
  h.AGV_DAILY_LOAD,                
  CASE WHEN h.TOTAL_TESTINGTIME = 0 THEN '' ELSE h.TOTAL_TESTINGTIME  END AS TOTAL_TESTINGTIME,                
  h.TOTAL_LOAD_INPER,                
  h.REMARK,                                    
  FLD_MODEL_CAPACITY,FLD_MODEL_NAME,A.BR_NAME,g.CSONAME as Fld_RegName,                            
  (A.UPS_NAME + '-'+ (CASE WHEN FLD_MODEL_NAME IS NULL THEN '-' ELSE FLD_MODEL_NAME END)  + '-' + FLD_MODEL_CAPACITY) AS UPS_MODEL, ----ADDED THREE COLUMNS BY HARSHAL 22 FEB 2013                                    
  FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID, A.UPS_MAP_ID, @CSONAME AS CSONAME,FLD_BRANCH_ID                              
  --CASE WHEN B.FLD_SRNO IS NULL THEN 'INSERT' ELSE 'UPDATE' END STATUS,B.*          
 -- C.EMP_NAME           
  FROM     
  (SELECT * FROM V_UPS_MASTER(NOLOCK) WHERE FLD_BRANCH_ID IN (SELECT BRCODE FROM #T)                        
  AND DeactivatedOn >= Convert(datetime,@FDATE,103)             
  )A            
 -- LEFT OUTER JOIN            
  --(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK)  WHERE CONVERT(VARCHAR(11),            
  --FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID  IN (SELECT BRCODE FROM #T))B            
 -- ON A.FLD_SRNO = B.FLD_UPS_ID            
 -- LEFT OUTER JOIN                    
  --INTRANET.RISK.DBO.EMP_INFO C                    
  --ON B.FLD_FOB = C.EMP_NO                    
  left outer join V_CSONAMES g on A.Fld_Branch_id = g.Sr_No                 
  left outer join tbl_ups_data h on A.Fld_srNo = h.fld_ups_id and Fld_Entry_date = Convert(datetime,@FDATE,103)              
  and A.Fld_Branch_id = h.fld_branch     
  ORDER BY A.UPS_ID                         
                            
  DROP TABLE #T                                  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FETCH1_UPS_DATA_15122010
-- --------------------------------------------------
CREATE PROC USP_FETCH1_UPS_DATA_15122010
(
	@Date Varchar(15),
	@BranchId int,
	@BrTag Varchar(15)
)

as                
                
Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)                

if(@BranchId <> 0)    
Begin    

	Select * 
	into #temp
	from V_Ups_Master(nolock) 
	where fld_Branch_id = @BranchId
		
	Select a.fld_srno UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,
		case when b.Fld_SrNo is null then 'Insert' else 'Update' end Status,b.*,
		c.Emp_Name 
	from                
	--(
	--	Select * 
	--	from V_Ups_Master(nolock) 
	--	where fld_Branch_id = @BranchId
	--)a
	#temp a
	left outer join          
	(
		Select * 
		from tbl_Weekly_ups_details(nolock) 
		where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId = @BranchId
	)b
	on a.Fld_Srno = b.fld_ups_id 
	left outer join intranet.risk.dbo.emp_info c on b.Fld_Fob = c.Emp_no 
	order by #temp.UpsId    
End 

   
Else    

Begin     

	Create Table #t(BrCode int,BrTag varchar(15),BrName varchar(100))    

	Insert into #t    
	Exec Usp_Wan_Search_Branch @BrTag     
	
	Select * 
	into #temp1
	from V_Ups_Master(nolock) 
	where fld_Branch_id in (Select BrCode from #t)

	Select a.fld_srno UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,
		case when b.Fld_SrNo is null then 'Insert' else 'Update' end Status,
		b.*,c.Emp_Name 
	from                
	--(
	--	Select * 
	--	from V_Ups_Master(nolock) 
	--	where fld_Branch_id in (Select BrCode from #t)
	--)a           
	#temp1 a     
	left outer join          
	(
		Select * 
		from tbl_Weekly_ups_details(nolock) 
		where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId in (Select BrCode from #t)
	)b on a.Fld_Srno = b.fld_ups_id    
	left outer join intranet.risk.dbo.emp_info c on b.Fld_Fob = c.Emp_no 
	--order by a.UpsId    
	order by #temp1.UpsId
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FETCH1_UPS_DATA_31122010
-- --------------------------------------------------
CREATE PROCEDURE USP_FETCH1_UPS_DATA_31122010
(
	@DATE VARCHAR(15),
	@BRANCHID INT,
	@BRTAG VARCHAR(15)
)
                
AS                
                
	SET @DATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE,103),121)                

	IF(@BRANCHID <> 0)    
	BEGIN    
		SELECT UPSID=A.FLD_SRNO,A.UPS_ID,A.UPS_NAME,FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID,CASE WHEN B.FLD_SRNO IS NULL THEN 'INSERT' ELSE 'UPDATE' END STATUS,B.*,C.EMP_NAME FROM                
		(SELECT * FROM V_UPS_MASTER(NOLOCK) WHERE FLD_BRANCH_ID = @BRANCHID)A                
		LEFT OUTER JOIN          
		(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK) WHERE CONVERT(VARCHAR(11),FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID = @BRANCHID)B           
		ON A.FLD_SRNO = B.FLD_UPS_ID    
		LEFT OUTER JOIN    
		INTRANET.RISK.DBO.EMP_INFO C     
		ON B.FLD_FOB = C.EMP_NO 
		ORDER BY UPSID    
	END    
	
	
	ELSE    
	
	BEGIN     
	
	CREATE TABLE #T(BRCODE INT,BRTAG VARCHAR(15),BRNAME VARCHAR(100))    

		INSERT INTO #T    
		EXEC USP_WAN_SEARCH_BRANCH @BRTAG     

		SELECT UPSID=A.FLD_SRNO,A.UPS_ID,A.UPS_NAME,FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID,CASE WHEN B.FLD_SRNO IS NULL THEN 'INSERT' ELSE 'UPDATE' END STATUS,B.*,C.EMP_NAME FROM                
		(SELECT * FROM V_UPS_MASTER(NOLOCK) WHERE FLD_BRANCH_ID IN (SELECT BRCODE FROM #T))A                
		LEFT OUTER JOIN          
		(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK) WHERE CONVERT(VARCHAR(11),FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID IN (SELECT BRCODE FROM #T))B           
		ON A.FLD_SRNO = B.FLD_UPS_ID    
		LEFT OUTER JOIN    
		INTRANET.RISK.DBO.EMP_INFO C     
		ON B.FLD_FOB = C.EMP_NO 
		ORDER BY UPSID    	
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FETCH1_UPS_DATA20062013
-- --------------------------------------------------
CREATE PROC [DBO].USP_FETCH1_UPS_DATA20062013                  
(                          
 @DATE VARCHAR(15),                                    
 @BRANCHID INT,                                    
 @BRTAG VARCHAR(15)                          
)                          
AS                          
 DECLARE @FDATE VARCHAR(15)              
 SET @FDATE= @DATE              
 SET @DATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE,103),121)              
 DECLARE @CSONAME AS VARCHAR(50)              
 SELECT @CSONAME = FLD_REGNAME FROM TBL_REGION_MASTER WHERE FLD_REGCODE = @BRTAG              
IF(@BRANCHID <> 0)              
 BEGIN              
  SELECT A.FLD_SRNO,A.UPS_ID AS [UPSID],A.UPS_NAME,              
  h.AGV_DAILY_LOAD,              
  CASE WHEN h.TOTAL_TESTINGTIME = 0 THEN '' ELSE h.TOTAL_TESTINGTIME END AS TOTAL_TESTINGTIME,              
  h.TOTAL_LOAD_INPER,              
  h.REMARK,                                  
  FLD_MODEL_CAPACITY,FLD_MODEL_NAME,A.BR_NAME,g.CSONAME as Fld_RegName,                          
  (A.UPS_NAME + '-'+ (CASE WHEN FLD_MODEL_NAME IS NULL THEN '-' ELSE FLD_MODEL_NAME END) + '-' + FLD_MODEL_CAPACITY) AS UPS_MODEL, ----ADDED THREE COLUMNS BY HARSHAL 22 FEB 2013                                  
  FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID,A.UPS_MAP_ID,@CSONAME AS CSONAME,FLD_BRANCH_ID                                    
  --CASE WHEN B.FLD_SRNO IS NULL THEN 'INSERT' ELSE 'UPDATE' END STATUS,B.*,        
 -- C.EMP_NAME                                    
  FROM                                                  
  (SELECT * FROM V_UPS_MASTER(NOLOCK) s           
   WHERE FLD_BRANCH_ID = @BRANCHID                       
  AND DeactivatedOn >= Convert(datetime,@FDATE,103)          
  )A                                                  
  --LEFT OUTER JOIN                                            
  --(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK)                                     
  --WHERE CONVERT(VARCHAR(11),FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID = @BRANCHID)B                                             
  --ON A.FLD_SRNO = B.FLD_UPS_ID                                      
  --LEFT OUTER JOIN                                      
  --INTRANET.RISK.DBO.EMP_INFO C                                   
 -- ON B.FLD_FOB = C.EMP_NO                           
  left outer join V_CSONAMES g on A.Fld_Branch_id = g.Sr_No                 
  left outer join tbl_ups_data h on A.Fld_srNo  = h.fld_ups_id and Fld_Entry_date = Convert(datetime,@FDATE,103)   
  and A.Fld_Branch_id = h.fld_branch            
  --Where h. Fld_Entry_date = Convert(datetime,@FDATE,103)             
  ORDER BY A.UPS_ID                  
 END                  
ELSE                  
 BEGIN                  
  CREATE TABLE #T(BRCODE INT,BRTAG VARCHAR(15),BRNAME VARCHAR(100))                                      
  INSERT INTO #T                                      
  EXEC USP_WAN_SEARCH_BRANCH @BRTAG                  
                          
  SELECT A.FLD_SRNO ,A.UPS_ID AS [UPSID],A.UPS_NAME,              
  h.AGV_DAILY_LOAD,              
  CASE WHEN h.TOTAL_TESTINGTIME = 0 THEN '' ELSE h.TOTAL_TESTINGTIME  END AS TOTAL_TESTINGTIME,              
  h.TOTAL_LOAD_INPER,              
  h.REMARK,                                  
  FLD_MODEL_CAPACITY,FLD_MODEL_NAME,A.BR_NAME,g.CSONAME as Fld_RegName,                          
  (A.UPS_NAME + '-'+ (CASE WHEN FLD_MODEL_NAME IS NULL THEN '-' ELSE FLD_MODEL_NAME END)  + '-' + FLD_MODEL_CAPACITY) AS UPS_MODEL, ----ADDED THREE COLUMNS BY HARSHAL 22 FEB 2013                                  
  FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID, A.UPS_MAP_ID, @CSONAME AS CSONAME,FLD_BRANCH_ID                            
  --CASE WHEN B.FLD_SRNO IS NULL THEN 'INSERT' ELSE 'UPDATE' END STATUS,B.*        
 -- C.EMP_NAME         
  FROM                                                  
  (SELECT * FROM V_UPS_MASTER(NOLOCK) WHERE FLD_BRANCH_ID IN (SELECT BRCODE FROM #T)                      
  AND DeactivatedOn >= Convert(datetime,@FDATE,103)           
  )A          
 -- LEFT OUTER JOIN          
  --(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK)  WHERE CONVERT(VARCHAR(11),          
  --FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID  IN (SELECT BRCODE FROM #T))B          
 -- ON A.FLD_SRNO = B.FLD_UPS_ID          
 -- LEFT OUTER JOIN                  
  --INTRANET.RISK.DBO.EMP_INFO C                  
  --ON B.FLD_FOB = C.EMP_NO                  
  left outer join V_CSONAMES g on A.Fld_Branch_id = g.Sr_No               
  left outer join tbl_ups_data h on A.Fld_srNo = h.fld_ups_id and Fld_Entry_date = Convert(datetime,@FDATE,103)            
  and A.Fld_Branch_id = h.fld_branch   
  ORDER BY A.UPS_ID                       
                          
  DROP TABLE #T                                
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FIND
-- --------------------------------------------------
 

CREATE PROCEDURE USP_FIND                    
 @DBNAME VARCHAR(500),                  
 @SRCSTR VARCHAR(500)                    
AS                    
                    
 SET NOCOUNT ON                  
 SET @SRCSTR  = '%' + @SRCSTR + '%'                    
                  
 DECLARE @STR AS VARCHAR(1000)                  
 SET @STR=''                  
 IF @DBNAME <>''                  
 BEGIN                  
 SET @DBNAME=@DBNAME+'.DBO.'                  
 END                  
 ELSE                  
 BEGIN                  
 SET @DBNAME=DB_NAME()+'.DBO.'                  
 END                  
 ----PRINT @DBNAME                  
                  
 SET @STR='SELECT DISTINCT O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '                   
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '                   
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                    
 --PRINT @STR                  
  EXEC(@STR)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FIND_STMT_BYKEYWORD_IN_USP
-- --------------------------------------------------
/**********************************************************************************        
CREATED BY: RAJENDRA VERMA        
DATE: 22/10/2010        
PURPOSE: USE TO GET ALL STATEMENTS IN STORE PROCEDURE        
   WHICH CONTAINS KEY_TO_SEARCH PARAMETER FOR DEFINED DATABASE @DBNAME       
   AND OPTIONAL PARAMETER STORE PROCEDURE       
        
MODIFIED BY: PROGRAMMER NAME        
DATED: DD/MM/YYYY        
REASON: REASON TO CHANGE STORE PROCEDURE        
**********************************************************************************/        
        
CREATE PROCEDURE USP_FIND_STMT_BYKEYWORD_IN_USP     
(        
  @DBNAME VARCHAR(500),        
  @KEY_TO_SEARCH VARCHAR(500),    
  @KEY_SP_NAME VARCHAR(500) = NULL        
)        
        
AS        
BEGIN        
        
 SET NOCOUNT ON   
-- DECLARE @DBNAME VARCHAR(500),@KEY_TO_SEARCH VARCHAR(500),@KEY_SP_NAME VARCHAR(500) = NULL    
-- SET @DBNAME='RISK'        
-- SET @KEY_TO_SEARCH=''  
-- SET  @KEY_SP_NAME VARCHAR(500) = NULL   
  
 /*****************************************************************        
 USE TO STORE PARTICULAR SP CONTAIN IN WHILE LOOP      
 ***************************************************************/      
 CREATE TABLE #TEMP    
 (     
 SP_CONTAIN VARCHAR(MAX)      
 )      
    
 /*****************************************************************        
 USE TO STORE FINAL RESULT TO DISPLAY        
 ***************************************************************/        
 CREATE TABLE #TEMP_RESULT        
 (        
 SRNO INT IDENTITY(1,1),        
 SP_NAME VARCHAR(MAX),        
 SQL_STATEMENT VARCHAR(MAX)        
 )        
    
 /*****************************************************************        
 USE TO STORE SP NAMES WHICH CONTAIN KEYWORD TO SEARCH        
 ***************************************************************/        
 CREATE TABLE #TEMP_SPNAME        
 (        
 SRNO INT IDENTITY(1,1),        
 SP_NAME VARCHAR(MAX)        
 )        
    
 /*****************************************************************        
 USE TO STORE SP CONTAIN ALONG WITH IT'S NAME        
 ***************************************************************/        
 CREATE TABLE #TEMP_SP_CONTAIN        
 (        
 SRNO INT IDENTITY(1,1),        
 SP_NAME VARCHAR(MAX),        
 SP_CONTAIN VARCHAR(MAX)        
 )        
    
 SET @KEY_TO_SEARCH  = '%' + @KEY_TO_SEARCH + '%'                  
    
 DECLARE @STR AS VARCHAR(1000)                
 SET @STR=''                
    
 IF @DBNAME <>''                
 BEGIN                
  SET @DBNAME=@DBNAME+'.DBO.'                
 END                
 ELSE                
 BEGIN                
  SET @DBNAME=DB_NAME()+'.DBO.'                
 END                
    
 SET @STR = 'SELECT DISTINCT O.NAME FROM ' + @DBNAME + 'SYSCOMMENTS  C '                 
 SET @STR = @STR + ' JOIN ' + @DBNAME +'SYSOBJECTS O ON O.ID = C.ID '    
 SET @STR = @STR + ' WHERE O.XTYPE IN (''P'')  AND C.TEXT LIKE ''' + @KEY_TO_SEARCH + ''''     
 IF ISNULL(@KEY_SP_NAME,'') <> ''                
 BEGIN    
  SET @STR = @STR + '  AND O.NAME LIKE ''' + @KEY_SP_NAME + ''''                  
 END    
    
 INSERT INTO #TEMP_SPNAME EXEC(@STR)        
    
 DECLARE @SP_COUNT INT        
 DECLARE @SP_SEARCH_NAME VARCHAR(MAX)      
    
 DECLARE @COUNT INT       
 SET @COUNT = 1       
    
 SET @SP_COUNT = (SELECT COUNT(*) FROM #TEMP_SPNAME)        
    
 /*****************************************************************        
 USE TO GET PARTICULAR STATEMENT FROM EACH STORE PROCEDURE        
 ***************************************************************/        
 IF (@SP_COUNT > 0)        
 BEGIN        
    
 WHILE( @COUNT <= @SP_COUNT )        
 BEGIN        
    
  SET @SP_SEARCH_NAME = (SELECT SP_NAME FROM #TEMP_SPNAME A WHERE A.SRNO = @COUNT)    
  INSERT INTO #TEMP EXEC SP_HELPTEXT @SP_SEARCH_NAME    
  INSERT INTO #TEMP_SP_CONTAIN SELECT @SP_SEARCH_NAME,SP_CONTAIN FROM #TEMP    
  TRUNCATE TABLE #TEMP      
    
 SET @COUNT = @COUNT + 1      
    
 END        
    
 END        
    
 INSERT INTO #TEMP_RESULT     
  SELECT SP_NAME,SP_CONTAIN     
 FROM #TEMP_SP_CONTAIN     
 WHERE SP_CONTAIN LIKE @KEY_TO_SEARCH        
    
 SELECT * FROM #TEMP_RESULT        
     
 DROP TABLE #TEMP   
 DROP TABLE #TEMP_RESULT  
 DROP TABLE #TEMP_SPNAME  
 DROP TABLE #TEMP_SP_CONTAIN  
 SET NOCOUNT OFF          
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------
CREATE PROCEDURE USP_FINDINUSP                    
 @DBNAME VARCHAR(500),                  
 @SRCSTR VARCHAR(500)                    
AS                    
                    
 SET NOCOUNT ON                  
 SET @SRCSTR  = '%' + @SRCSTR + '%'                    
                  
 DECLARE @STR AS VARCHAR(1000)                  
 SET @STR=''                  
 IF @DBNAME <>''                  
 BEGIN                  
 SET @DBNAME=@DBNAME+'.DBO.'                  
 END                  
 ELSE                  
 BEGIN                  
 SET @DBNAME=DB_NAME()+'.DBO.'                  
 END                  
 ----PRINT @DBNAME                  
                  
 SET @STR='SELECT DISTINCT O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '                   
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '                   
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                    
 --PRINT @STR                  
  EXEC(@STR)                  
          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Forward
-- --------------------------------------------------
Create Proc USP_Forward(@Query_No as varchar(50))
as
select x.Fld_Segment,x.Fld_Date,x.Fld_Cheque,x.Fld_Amount,x.Fld_AccNo,x.Fld_Party_Code,x.Fld_Remarks,y.Fld_Query_name from
(select Fld_Query_Id,Fld_Segment,Fld_Date,Fld_Cheque,Fld_Amount,Fld_AccNo,Fld_Party_Code,Fld_Remarks from tbl_Query_entry (nolock) where Fld_Complaint_No = @Query_No) x
inner join
(select * from tbl_Query_type (nolock)) y
on x.Fld_Query_Id = y.Fld_Sr_No

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ForwardMail
-- --------------------------------------------------
CREATE procedure Usp_ForwardMail  --'E17811342','Backdated /Reverse Entry','Shivakumar.L@angelbroking.com','Renil.Pillai@angelbroking.com','E31452'        
(           
       @ComplaintId    as varchar(100),          
       @Subject        as varchar(500),          
       @mailto         as varchar(1000),          
       @mailcc         as varchar(1000),    
       @repliedby      as varchar(100)        
)          
 as          
    
declare @emp_no varchar(30)    
select  @emp_no=emp_no from intranet.risk.dbo.emp_info  with(nolock) where email=@mailto    
    
update tbl_complaint set Solution='Forwarded to '+@emp_no,Solution_by=@repliedby,status='f',Solution_Date=getdate()     
 where Sr_num in     
(select Sr_num=max(Sr_num) from tbl_complaint with (nolock) where  complaint_id=@ComplaintId group by complaint_id)    
    
insert into tbl_complaint    
select     
Dept_ID,Complaint_ID,Query_Type,Subject,Complaint,Solution='',    
Access_code,Solution_By=@emp_no,Complaint_Date,Solution_Date=NULL,    
Attachment,Status='p',Fld_EntryBy,cso_attch,fld_hold_Reason,    
compl_abt,clt_subdetl    
 from tbl_complaint    
 where Sr_num in     
(select Sr_num=max(Sr_num) from tbl_complaint with (nolock)     
where  complaint_id=@ComplaintId group by complaint_id)    
    
    
    
 begin             
 DECLARE @CID VARCHAR(100),  --PURPOSE- @CID IS USED FOR COMPLAIN ID               
   @SUB VARCHAR(500),  --PERPOSE- @SUB IS USED FOR SUBJECT              
   @EMAIL VARCHAR(1000), --PURPOSE- @EMAIL IS USED FOR EMAILID               
   @MESS VARCHAR(4000), --PURPOSE- @MESS IS USED FOR MESSAGE                
   @EMAILCC varchar(1000) -- purpose -@EMAILCC is used for CCEmailId          
              
          
   set  @CID=@ComplaintId        
      set  @SUB=@Subject        
      set  @EMAIL=@mailto         
      set  @EMAILCC = @mailcc          
                  
                  
     SET @MESS='<BR>            
             
            Dear Team, <BR><BR>              
            
            Kindly do the needful. <BR><BR>             
            
            Kindly revert us through below mentioned link :  https://172.29.2.158/AngelInHouse/OperationHelpdesk/InboxCF.aspx?id='+ ltrim(rtrim(@CID)) +'&username='+ ltrim(rtrim(@emp_no)) +'            
                                                                      
            <BR><BR>            
             
            This is a System Generated Mail kindly do not reply.            
                                                                                                                   
                                                                            
     <BR>                                                                                            
     <BR>'              
                                   
                                  
     EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                    
     @RECIPIENTS = @EMAIL,                    
     @COPY_RECIPIENTS=@EMAILCC,                   
     @PROFILE_NAME = 'OPERATIONHELPDESK ',                                      
     @BODY_FORMAT ='HTML',                                                                                                          
     @SUBJECT =@SUB ,                                                                                    
     @FILE_ATTACHMENTS ='',                                                                                                                    
     @BODY =@MESS                    
              
              
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ForwardMail1
-- --------------------------------------------------
CREATE procedure [dbo].[Usp_ForwardMail1]  --'E17811342','Backdated /Reverse Entry','Shivakumar.L@angelbroking.com','Renil.Pillai@angelbroking.com'
(   
       @ComplaintId    as varchar(50),  
       @Subject        as varchar(80),  
       @mailto         as varchar(15),  
       @mailcc         as varchar(15)
)  
 as    
 begin     
 DECLARE	@CID VARCHAR(100),  --PURPOSE- @CID IS USED FOR COMPLAIN ID       
			@SUB VARCHAR(100),  --PERPOSE- @SUB IS USED FOR SUBJECT      
			@EMAIL VARCHAR(50), --PURPOSE- @EMAIL IS USED FOR EMAILID       
			@MESS VARCHAR(4000), --PURPOSE- @MESS IS USED FOR MESSAGE        
			@EMAILCC varchar(50) -- purpose -@EMAILCC is used for CCEmailId  
      
		
	  set  @CID=@ComplaintId
      set  @SUB=@Subject
      set  @EMAIL=@mailto 
      set  @EMAILCC = @mailcc  
          
          
     SET @MESS='<BR>    
     
            Dear Team, <BR><BR>      
    
            Kindly do the needful. <BR><BR>     
    
            Kindly revert us through below mentioned link : http://196.1.115.183/AngelInHouse/OperationHelpdesk/InboxC.aspx?id='+ @CID +'    
                                                              
            <BR><BR>    
     
            This is a System Generated Mail kindly do not reply.    
                                                                                                           
                                                                    
     <BR>                                                                                    
     <BR>'       
                           
                          
     EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                            
     @RECIPIENTS =@EMAIL,            
     @COPY_RECIPIENTS=@EMAILCC,           
     @PROFILE_NAME = 'OPERATIONHELPDESK ',                              
     @BODY_FORMAT ='HTML',                                                                                                  
     @SUBJECT =@SUB ,                                                                            
     @FILE_ATTACHMENTS ='',                                                                                                            
     @BODY =@MESS            
      
      
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ForwardMail2
-- --------------------------------------------------
create procedure Usp_ForwardMail2  --'E17811342',--'Backdated /Reverse Entry','Shivakumar.L@angelbroking.com','Renil.Pillai@angelbroking.com'
(   
    @ComplaintId    as varchar(50)  
)
as
begin
          
   DECLARE	@CID VARCHAR(100),
            @MESS VARCHAR(4000)
    set  @CID=@ComplaintId

     SET @MESS='<BR>    
     
            Dear Team, <BR><BR>      
    
            Kindly do the needful. <BR><BR>     
    
            Kindly revert us through below mentioned link : http://196.1.115.183/AngelInHouse/OperationHelpdesk/InboxC.aspx?id='+ @CID +'    
                                                              
            <BR><BR>    
     
            This is a System Generated Mail kindly do not reply.    
                                                                                                           
                                                                    
     <BR>                                                                                    
     <BR>'       
                           
                          
     EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                            
     @RECIPIENTS ='Shivakumar.L@angelbroking.com',            
     @COPY_RECIPIENTS='Renil.Pillai@angelbroking.com',           
     @PROFILE_NAME = 'OPERATIONHELPDESK ',                              
     @BODY_FORMAT ='HTML',                                                                                                  
     @SUBJECT ='Testing the mail' ,                                                                            
     @FILE_ATTACHMENTS ='',                                                                                                            
     @BODY =@MESS            
      
      
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_functions_findInUSP
-- --------------------------------------------------
create PROCEDURE usp_functions_findInUSP  
@str varchar(500)  
AS  
  
 set @str = '%' + @str + '%'  
   
 select O.name from sysComments  C  
 join sysObjects O on O.id = C.id  
 where O.xtype = 'P' and C.text like @str

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GenAssetTag
-- --------------------------------------------------
  
CREATE proc usp_GenAssetTag(@Fld_RequestId int,@Fld_AssetName varchar(50))                
as                
--declare @Fld_RequestId int            
--declare @Fld_AssetName varchar(50)             
--set @Fld_RequestId='5'            
--set @Fld_AssetName='UTM'            
             
declare @assetTag as  varchar(100)                 
declare @Tag as varchar(50)                
set @Tag =(select a.Fld_BranchCode+'/'+b.Fld_AssetName+'/' from                 
(select top 1 * from tbl_itRequestMaster(nolock) where Fld_RequestID=@Fld_RequestId and Fld_Status='CSOF' and Fld_assetType in (select Fld_AssetId from tbl_IT_Assetmaster(nolock) where Fld_AssetName=@Fld_AssetName))a                 
left outer join                 
(select Fld_AssetId,Fld_AssetName from tbl_It_assetmaster(nolock))b                
on a.Fld_AssetType=b.fld_assetId)                
--print @Tag                
if (select count(Fld_AssetTag) from tbl_ITAssetsData(nolock) where Fld_AssetTag like''+@Tag+'%') = 0                
begin                  
set @assetTag = @Tag+'0001'                
end                
else                
begin                 
declare @assetCount as varchar(4)                
set @assetCount =(select right(Max(Fld_AssetTag),4) from tbl_ITAssetsData(nolock) where Fld_AssetTag like ''+@Tag+'%')                
set @assetCount=replace(str(isnull(@assetCount+1,0),4),' ',0)                
--print @assetCount                
set @assetTag = @Tag+@assetCount                
end                
select @assetTag as assetTag into ##file1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO
-- --------------------------------------------------
  
CREATE proc USP_GENERATE_COMPLAINTNO            
(@complaint_date as datetime,          
@department as varchar(50),          
@dsection as varchar(20),          
@queryfrom as varchar(250),          
--@contact_person as varchar(250),          
@problem as varchar(5000),          
@suggestion as varchar(5000),          
--@completed_on as datetime,          
--@completed_remark as varchar(150),          
@grade as varchar(50),          
--@helpdeskmarkcompleted as char(10),          
--@helpdeskmarkcompleteddate as datetime,          
--@status as char(10),          
--@complaintno as varchar(50),          
@code as varchar(20),          
@party_code as varchar(20),          
@category as varchar(15),          
--@deptmarkcompleted as char(10),          
--@deptmarkcompleteddate as datetime,          
--@remark as varchar(600),          
@dstatus as varchar(50),          
--@dremark as varchar(600),          
@emailid as varchar(70),          
@phone as varchar(250),          
@entry_by as varchar(20),          
@subject as varchar(500),          
@entered_through as varchar(15),          
--@time_limit as varchar(15),          
@forwardto_dept as varchar(100),          
--@mark_complete as varchar(5),          
@call_type as varchar(200),          
@grp_id as varchar(50),          
--@attachment as varchar(1000),          
@it_cat as varchar(50),          
@it_subcat as varchar(50),          
@it_conn as varchar(50),          
--@wrong_entry as char(10)            
-----------New Fields-----------      
@email as varchar(50),      
@status as varchar(50),
@server as varchar(20)      
)            
as             
set nocount on            
            
---------------Generation of Complaint No--------------------------            
            
Declare @No as varchar(20)      
      
--set @department = 'IT'      
            
--set @No = (select count(*) from Test_complaint_table where convert(varchar(11),complaint_date,103) >= convert(varchar(11),getdate(),103))      
  
set @No =  (select count(*) from Test_complaint_table where complaint_date >= convert(varchar(11),getdate(),106))  
            
if @NO = 0            
begin             
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +             
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2))            
set @NO = @NO+'0'                  
set @No = @department+'-'+@NO            
print @NO            
end            
else            
begin             
set @NO = (select Top 1 substring(substring(complaintno,charindex('-',complaintno)+1,100),7,100)+1 from             
Test_complaint_table where  complaint_date >=convert(varchar(11),getdate()) order by             
isnull((substring(complaintno,CHARINDEX('-', complaintno)+7,100))+1,0) desc)            
          
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +             
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2)) + @NO           
          
set @No = @department + '-' + @NO            
          
print @No            
end            
------------------------------------------------------------------------            
          
insert into Test_complaint_table           
(complaint_date,department,dsection,queryfrom,contact_person,problem,suggestion,completed_on,          
completed_remark,grade,helpdeskMarkcompleted,helpdeskmarkcompleteddate,status,complaintno,          
code,party_code,category,deptmarkcompleted,deptmarkcompleteddate,Remark,dstatus,dremark,          
emailid,phone,entry_by,subject,entered_through,time_limit,forwardto_dept,mark_complete,          
Call_type,Grp_Id,Attachment,it_cat,it_subcat,it_conn,Wrong_Entry)          
values           
(@complaint_date,@department,@dsection,@queryfrom,'',@problem,@suggestion,'',          
'remark',@grade,'N','',@status,@NO,@code,@party_code,@category,'N',          
'','',@dstatus,'',@emailid,@phone,@entry_by,@subject,          
@entered_through,'',@forwardto_dept,'N',@Call_type,@Grp_Id,          
'',@it_cat,@it_subcat,@it_conn,'N')             
      
      
truncate table temp_compNo      
      
insert into temp_compNo values (@NO)      
      
if @forwardto_dept <> ''      
      
begin        
declare @sub as varchar(100),      
@msg as varchar(5000)      
set @sub = 'Your Complaint No. :' + @NO      
      
set @msg = '<font face=verdana size=2>Dear Sir,<br><br>Please note the following complaint details:<br><br><table>       
<tr><td valign=top>Complaint from:&nbsp;&nbsp;</td><td> '+ @queryfrom +' </td></tr>       
<tr><td valign=top>Phone No. :&nbsp;&nbsp;</td><td> '+ @phone +' </td></tr>       
<tr><td valign=top>Complaint No.:&nbsp;&nbsp;</td><td>  '+ @NO +' </td></tr>       
<tr><td valign=top>Complaint Nature:&nbsp;&nbsp;</td><td width=350>  '+ @problem +' </td></tr>       
<tr><td valign=top>Solution provided (if any):&nbsp;&nbsp;</td><td width=350>  '+ @suggestion +' </td></tr>       
</table><br><br><font face=verdana size=2>       
Pending Complaint Status :<a href=http://'+@server+'/helpdesk/pendingcomplaints_department1.asp?dept='+ @department +'&cno='+@NO+' >View</a>       
<br><br><br> Best regards, <br><BR><BR><b>Amit Ghodekar<br>E-Broking Product Support Manager<br><br>E-Broking Department<BR>Angel Group of Companies <BR>Akruti Trade Center<BR>Andheri (East), Mumbai  400 093<BR>Help Desk: 091-022-3088 1111<BR>Board Lines:
  
    
 091-022-2835      
      
 8800/ 3083 7700 (Ext 403)</font></b>       
<br><Br>Log on to: <A title=http://www.angeltrade.com/ href=http://www.angeltrade.com/>www.angeltrade.com</A><Br></font>'      
      
exec Intranet.master.dbo.usp_AutoMail @email,'mangesh.wangane@angelbroking.com', @sub,@msg      
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO_HR
-- --------------------------------------------------
CREATE proc USP_GENERATE_COMPLAINTNO_HR                                                            
(                                                
@Fld_Request_Id int,                                                          
@Fld_Subject varchar(200),                                                          
@Fld_Query varchar(5000),                                                          
@Fld_Emp_Code varchar(10),                                            
@File_Name varchar(500),                
@BINARYFILE image,                 
@MIMETYPE varchar(1000)                                 
)                                                            
as                                                             
set nocount on                                                            
                                                            
---------------Generation of Complaint No--------------------------                                                            
               
declare @id as int             
if @Fld_Subject = 0          
set  @id =  78          
else           
Set @id = (select top 1 fldsubjectid from V_HrSubjectSolution where fldsubjectid = @Fld_Subject and FldSubCatName is not null)          
          
/*declare @reqid as int          
if  @Fld_Request_Id = 0          
set  @reqid = 20           
else           
set  @reqid =(select fldsubcatid from tbl_hr_subcatmaster where fldsubcatid = @Fld_Request_Id )  */        
              
                                                          
Declare @Complaintno as varchar(100)                                                         
set @Complaintno = (select count(*) from Tbl_HR_Complaint_Master_New (nolock) where Fld_Emp_Code =@Fld_Emp_Code)                                                 
                                                            
if @Complaintno = 0                                                            
begin                                                             
set @Complaintno = @Fld_Emp_Code+'0'                                                                  
end                                                            
else                                                            
begin                                                             
set @Complaintno = (select top 1 @Fld_Emp_Code+convert(varchar,substring(Fld_Complaint_No,7,100)+1) from Tbl_HR_Complaint_Master_New where  Fld_Emp_Code =@Fld_Emp_Code order by Fld_complaint_date desc)                                                   
end                                                
              
              
                
                                                
/*      
insert into tbl_hr_complaint_master_new values (                                                
getdate(),@Fld_Request_Id,@id,@Fld_Query,'',upper(@Fld_Emp_Code),@Complaintno,'P',null,null,@File_Name,'','','','')   old inert query           
*/      
      
insert into tbl_hr_complaint_master_new values (                                                          
getdate(),@Fld_Request_Id,@id,@Fld_Query,'',upper(@Fld_Emp_Code),@Complaintno,'P',null,null,@File_Name,'','','','',@BINARYFILE,@MIMETYPE,'','','')                                                                                    
                                            
declare @cc_mail as varchar(200)                                            
declare @frm_mail as varchar(150)                                            
declare @str varchar(2000)                                        
                                            
set @cc_mail =                                             
(                                            
select email from intranet.risk.dbo.emp_info                                             
where emp_no=                                            
(select senior from intranet.risk.dbo.emp_info where emp_no = @Fld_Emp_Code)                                            
)                                            
                                     
set @frm_mail = ( select email from intranet.risk.dbo.emp_info where emp_no=@Fld_Emp_Code)            
                                            
--exec HR_send_mail @cc_mail,@frm_Mail,@Fld_Query,@Fld_Subject,''                                 
                                        
--exec HR_send_mail 'ANGEL HARMONY',@cc_mail,@frm_Mail,@Fld_Query,@Fld_Subject,''                                         
--exec HR_send_mail 'ANGEL HARMONY','mangesh.wangane@angeltrade.com',@frm_Mail,@Fld_Query,@Fld_Subject,''                                         
                                        
set @str = 'Dear Angelite,<br><br> We have received your request/query.  Thank you for writing to us.<br>                                        
You will receive a response from us at the earliest.<br>                                        
Kindly note your query no '+@Complaintno+'. Please provide your query no in all future communications<br><br>                                        
Regards,<br><br>HR Help Desk<br>Angel Broking Ltd.<br>6th Floor, Akruti Star,<br>Road No. 7, MIDC Marol,<br>Andheri(E), Mumbai - 4000093.<br><br>Tel: 39357950 (Direct Line)'                                        
                                        
exec HR_send_mail @frm_Mail,'','HRD',@str,'Harmony Auto Reply',''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO_HR_complaint
-- --------------------------------------------------
CREATE proc USP_GENERATE_COMPLAINTNO_HR_complaint                                        
(                                  
@Fld_Request_Id int,                                  
@Fld_Subject varchar(200),                                  
@Fld_Query varchar(5000),                                  
@Fld_Emp_Code varchar(10),                    
@File_Name varchar(500),        
@complaintno varchar(100)                    
)        
as         
  
declare @id as int  
Set @id = (select Fldssid from V_HrSubjectSolution where fldsubjectid = @Fld_Subject)  
  
insert into Tbl_HR_Complaint_Master_New values   
(getdate(),@Fld_Request_Id,@id,@Fld_Query,'',upper(@Fld_Emp_Code),@Complaintno,'P',null,null,@File_Name,'','','','')          
        
declare @cc_mail as varchar(30)                              
declare @frm_mail as varchar(30)                              
declare @str varchar(1000)                          
                              
set @cc_mail =                               
(                              
select email from intranet.risk.dbo.emp_info                               
where emp_no=                              
(select senior from intranet.risk.dbo.emp_info where emp_no = @Fld_Emp_Code))                              
                              
set @frm_mail = ( select email from intranet.risk.dbo.emp_info where emp_no=@Fld_Emp_Code)                              
                              
--exec HR_send_mail @cc_mail,@frm_Mail,@Fld_Query,@Fld_Subject,''                              
                          
--exec HR_send_mail 'ANGEL HARMONY',@cc_mail,@frm_Mail,@Fld_Query,@Fld_Subject,''                           
--exec HR_send_mail 'ANGEL HARMONY','mangesh.wangane@angeltrade.com',@frm_Mail,@Fld_Query,@Fld_Subject,''                           
                          
set @str = 'Dear Angelite,<br><br> We have received your request/query.  Thank you for writing to us.<br>                          
You will receive a response from us at the earliest.<br>                          
Kindly note your query no '+@Complaintno+'. Please provide your query no in all future communications<br><br>                          
Regards,<br><br>HR Help Desk<br>Angel Broking Ltd.<br>612, Acme Plaza,<br>Andheri (E), Mumbai 400059.<br><br>Tel: 32610921 (Direct Line)<br>40003900 Ext. 492'                          
                
exec HR_send_mail @frm_Mail,'','HRD',@str,'Harmony Auto Reply',''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO_IT
-- --------------------------------------------------
CREATE proc USP_GENERATE_COMPLAINTNO_IT(@mark as varchar(2),                        
@complaint_date as datetime,                      
@department as varchar(50),                      
@queryfrom as varchar(250),                      
@problem as varchar(5000),                      
@suggestion as varchar(5000),                      
@code as varchar(20),                      
@category as varchar(15),                      
@emailid as varchar(70),                      
@phone as varchar(250),                      
@entry_by as varchar(20),                      
@subject as varchar(500),                      
@entered_through as varchar(15),                      
@time_limit as varchar(15),                      
@forwardto_dept as varchar(100),                      
@call_type as varchar(200),                      
@grp_id as varchar(50),                      
@it_cat as varchar(50),                      
@it_subcat as varchar(50),                      
@it_conn as varchar(50),    
@city as varchar(100),
@backup as varchar(100)                      
)                        
as                         
set nocount on                        
                        
---------------Generation of Complaint No--------------------------                        
                        
Declare @No as varchar(20)                       
set @No =  (select count(*) from complaint_table where complaint_date >= convert(varchar(11),getdate(),106))              
                        
if @NO = 0                        
begin                         
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                         
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2))                        
set @NO = @NO+'0'                              
set @No = @department+'-'+@NO                        
print @NO                        
end                        
else                        
begin                   
                  
set @NO = (select Top 1 substring(substring(complaintno,charindex('-',complaintno)+1,100),7,100)+1 from                         
complaint_table where  complaint_date >=convert(varchar(11),getdate()) order by                         
isnull((substring(complaintno,CHARINDEX('-', complaintno)+7,100))+1,0) desc)                        
                      
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                         
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2)) + @NO                       
                      
set @No = @department + '-' + @NO                        
                      
print @No                        
end                        
------------------------------------------------------------------------                        
                      
insert into complaint_table                       
(complaint_date,department,dsection,queryfrom,contact_person,problem,suggestion,completed_on,                      
completed_remark,grade,helpdeskMarkcompleted,helpdeskmarkcompleteddate,status,complaintno,                      
code,category,deptmarkcompleted,deptmarkcompleteddate,Remark,dstatus,dremark,                      
emailid,phone,entry_by,subject,entered_through,time_limit,forwardto_dept,mark_complete,                      
Call_type,Grp_Id,Attachment,it_cat,it_subcat,it_conn,Wrong_Entry,city,Fld_Backup)                      
values                       
(@complaint_date,@department,'',@queryfrom,'',@problem,@suggestion,'',                      
'remark','grade','N','','pending',@NO,            
@code,@category,'N',null,'','pending','',            
@emailid,@phone,@entry_by,@subject,@entered_through,@time_limit,@forwardto_dept,'',            
@Call_type,@Grp_Id,'',@it_cat,@it_subcat,@it_conn,'N',@city,@backup)                         
        
if @mark='Y'   
begin  
update complaint_table set helpdeskmarkcompleted='Y',status='completed',completed_on=getdate(),  
helpdeskmarkcompleteddate=getdate(),mark_complete='N',deptmarkcompleteddate=getdate()   
where complaintno=@NO  
end  
     
truncate table temp_compNo                  
        
insert into temp_compNo values (@NO)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO_IT1
-- --------------------------------------------------
CREATE proc USP_GENERATE_COMPLAINTNO_IT1(@mark as varchar(2),                          
@complaint_date as datetime,                        
@department as varchar(50),                        
@queryfrom as varchar(250),                        
@problem as varchar(5000),                        
@suggestion as varchar(5000),                        
@code as varchar(20),                        
@category as varchar(15),                        
@emailid as varchar(70),                        
@phone as varchar(250),                        
@entry_by as varchar(20),                        
@subject as varchar(500),                        
@entered_through as varchar(15),                        
@time_limit as varchar(15),                        
@forwardto_dept as varchar(100),                        
@call_type as varchar(200),                        
@grp_id as varchar(50),                        
@it_cat as varchar(50),                        
@it_subcat as varchar(50),                        
@it_conn as varchar(50),      
@city as varchar(100),
@con_time as varchar(15),
@con_Type as varchar(10)                        
)                          
as                           
set nocount on                          
                          
---------------Generation of Complaint No--------------------------                          
                          
Declare @No as varchar(20)                         
set @No =  (select count(*) from complaint_table where complaint_date >= convert(varchar(11),getdate(),106))                
                          
if @NO = 0                          
begin                           
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                           
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2))                          
set @NO = @NO+'0'                                
set @No = @department+'-'+@NO                          
print @NO                          
end                          
else                          
begin                     
                    
set @NO = (select Top 1 substring(substring(complaintno,charindex('-',complaintno)+1,100),7,100)+1 from                           
complaint_table where  complaint_date >=convert(varchar(11),getdate()) order by                           
isnull((substring(complaintno,CHARINDEX('-', complaintno)+7,100))+1,0) desc)                          
                        
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                           
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2)) + @NO                         
                        
set @No = @department + '-' + @NO                          
                        
--print @No                          
end                          
------------------------------------------------------------------------                          
                        
insert into complaint_table                         
(complaint_date,department,dsection,queryfrom,contact_person,problem,suggestion,completed_on,                        
completed_remark,grade,helpdeskMarkcompleted,helpdeskmarkcompleteddate,status,complaintno,                        
code,category,deptmarkcompleted,deptmarkcompleteddate,Remark,dstatus,dremark,                        
emailid,phone,entry_by,subject,entered_through,time_limit,forwardto_dept,mark_complete,                        
Call_type,Grp_Id,Attachment,it_cat,it_subcat,it_conn,Wrong_Entry,city,Fld_Con_Time,Fld_Courtesy_Call_Type)                        
values                         
(@complaint_date,@department,'',@queryfrom,'',@problem,@suggestion,'',                        
'remark','grade','N','','pending',@NO,              
@code,@category,'N',null,'','pending','',              
@emailid,@phone,@entry_by,@subject,@entered_through,@time_limit,@forwardto_dept,'',              
@Call_type,@Grp_Id,'',@it_cat,@it_subcat,@it_conn,'N',@city,@con_time,@con_Type)                           
          
if @mark='Y'     
begin    
update complaint_table set helpdeskmarkcompleted='Y',status='completed',completed_on=getdate(),    
helpdeskmarkcompleteddate=getdate(),mark_complete='N',deptmarkcompleteddate=getdate()     
where complaintno=@NO    
end    
       
truncate table temp_compNo                    
          
insert into temp_compNo values (@NO)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO_IT11
-- --------------------------------------------------
CREATE proc USP_GENERATE_COMPLAINTNO_IT11(@mark as varchar(2),                                  
@complaint_date as datetime,                                
@department as varchar(50),                                
@queryfrom as varchar(250),                                
@problem as varchar(5000),                                
@suggestion as varchar(5000),                                
@code as varchar(20),                                
@category as varchar(15),                                
@emailid as varchar(70),                                
@phone as varchar(250),                                
@entry_by as varchar(20),                                
@subject as varchar(500),                                
@entered_through as varchar(15),                                
@time_limit as varchar(15),                                
@forwardto_dept as varchar(100),                                
@call_type as varchar(200),                                
@grp_id as varchar(50),                                
@it_cat as varchar(50),                                
@it_subcat as varchar(50),                                
@it_conn as varchar(50),              
@city as varchar(100),        
@con_time as varchar(15),        
@con_Type as varchar(10),      
--@flag as int,       
@complaintno as varchar(50)                               
)                                  
as       
  
if @complaintno = ''      
begin                               
set nocount on                                   
---------------Generation of Complaint No--------------------------                              
                              
Declare @No as varchar(20)                             
set @No =  (select count(*) from complaint_table where complaint_date >= convert(varchar(11),getdate(),106))                    
                              
if @NO = 0                              
begin                               
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                               
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2))                              
set @NO = @NO+'0'                                    
set @No = @department+'-'+@NO                              
print @NO                              
end                              
else                              
begin                         
                        
set @NO = (select Top 1 substring(substring(complaintno,charindex('-',complaintno)+1,100),7,100)+1 from                               
complaint_table where  complaint_date >=convert(varchar(11),getdate()) order by                               
isnull((substring(complaintno,CHARINDEX('-', complaintno)+7,100))+1,0) desc)                              
                            
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                               
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2)) + @NO                             
                            
set @No = @department + '-' + @NO                              
                            
--print @No                              
end                              
------------------------------------------------------------------------                              
                            
insert into complaint_table                             
(complaint_date,department,dsection,queryfrom,contact_person,problem,suggestion,completed_on,                            
completed_remark,grade,helpdeskMarkcompleted,helpdeskmarkcompleteddate,status,complaintno,                            
code,category,deptmarkcompleted,deptmarkcompleteddate,Remark,dstatus,dremark,                            
emailid,phone,entry_by,subject,entered_through,time_limit,forwardto_dept,mark_complete,                            
Call_type,Grp_Id,Attachment,it_cat,it_subcat,it_conn,Wrong_Entry,city,Fld_Con_Time,Fld_Courtesy_Call_Type)                            
values                             
(@complaint_date,@department,'',@queryfrom,'',@problem,@suggestion,'',                            
'remark','grade','N','','pending',@NO,                  
@code,@category,'N',null,'','pending','',                  
@emailid,@phone,@entry_by,@subject,@entered_through,@time_limit,@forwardto_dept,'',                  
@Call_type,@Grp_Id,'',@it_cat,@it_subcat,@it_conn,'N',@city,@con_time,@con_Type)                               
              
if @mark='Y'         
begin        
update complaint_table set helpdeskmarkcompleted='Y',status='completed',completed_on=getdate(),        
helpdeskmarkcompleteddate=getdate(),mark_complete='N',deptmarkcompleteddate=getdate()         
where complaintno=@NO        
end        
           
truncate table temp_compNo                        
              
insert into temp_compNo values (@NO)                
         
end       
else         
begin       
      
update complaint_table set department=@department,queryfrom=@queryfrom,problem=@problem,      
 suggestion=@suggestion,code=@code,category=@category,emailid=@emailid,phone=@phone,      
 entry_by=@entry_by,subject=@subject,entered_through=@entered_through,time_limit=@time_limit,      
forwardto_dept=@forwardto_dept,mark_complete=@mark,Call_type=@call_type,Grp_Id=@grp_id,      
it_cat=@it_cat,it_subcat=@it_subcat,it_conn=@it_conn,city=@city,Fld_Con_Time=@con_time,Fld_Courtesy_Call_Type=@con_Type      
where complaintno = @complaintno                  
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO_QA
-- --------------------------------------------------
CREATE proc USP_GENERATE_COMPLAINTNO_QA        
(      
--@complaint_date as datetime,                            
@department as varchar(50),                            
@queryfrom as varchar(250),                            
@problem as varchar(5000),                            
@suggestion as varchar(5000),                            
@code as varchar(20),                            
@category as varchar(15),                            
@emailid as varchar(70),                            
@phone as varchar(250),                            
@entry_by as varchar(20),                            
--@subject as varchar(500),                            
--@entered_through as varchar(15),                            
--@time_limit as varchar(15),                            
--@forwardto_dept as varchar(100),                            
@call_type as varchar(200),                            
@grp_id as varchar(50)      
--@it_cat as varchar(50),                            
--@it_subcat as varchar(50),                            
--@it_conn as varchar(50),          
--@city as varchar(100)                            
)                              
as                               
set nocount on                              
                              
---------------Generation of Complaint No--------------------------                              
                              
Declare @No as varchar(20)                             
set @No =  (select count(*) from complaint_table where complaint_date >= convert(varchar(11),getdate(),106))                    
                              
if @NO = 0                              
begin                               
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                               
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2))                              
set @NO = @NO+'0'                                    
set @No = @department+'-'+@NO                              
print @NO                              
end                              
else                              
begin                         
                        
set @NO = (select Top 1 substring(substring(complaintno,charindex('-',complaintno)+1,100),7,100)+1 from                               
complaint_table where  complaint_date >=convert(varchar(11),getdate()) order by                               
isnull((substring(complaintno,CHARINDEX('-', complaintno)+7,100))+1,0) desc)                              
                            
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                               
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2)) + @NO                             
                            
set @No = @department + '-' + @NO                                                    
      
end                              
------------------------------------------------------------------------                              
                            
insert into complaint_table                             
(      
complaint_date,department,dsection,queryfrom,contact_person,problem,suggestion,completed_on,                            
completed_remark,grade,helpdeskMarkcompleted,helpdeskmarkcompleteddate,status,complaintno,                            
code,category,emailid,phone,entry_by,subject,entered_through,mark_complete,Call_type,Grp_Id)                            
values                             
(getdate(),@department,'',@queryfrom,'',@problem,@suggestion,'',                            
'remark','grade','N','','pending',@NO,@code,@category,@emailid,@phone,      
@entry_by,@problem,'HD','Y',@Call_type,@Grp_Id)                               
  
truncate table QA_temp_compNo  
  
insert into QA_temp_compNo values (@NO)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GENERATE_COMPLAINTNO_QA_new
-- --------------------------------------------------
CREATE proc USP_GENERATE_COMPLAINTNO_QA_new                
(              
--@complaint_date as datetime,                                    
@department as varchar(50),                                    
@queryfrom as varchar(250),                                    
@problem as varchar(5000),                                    
@suggestion as varchar(5000),     
@contact_person as varchar(5000),     
@code as varchar(20),                                    
@category as varchar(15),                                    
@emailid as varchar(70),                                    
@phone as varchar(250),                                    
@entry_by as varchar(20),                                    
@call_type as varchar(200),                                    
@grp_id as varchar(50),    
@City as varchar(100),    
@chk as varchar(25)    
)  
as  
set nocount on                                      
                                      
---------------Generation of Complaint No--------------------------                                      
                                      
Declare @No as varchar(20)                                     
set @No =  (select count(*) from complaint_table where complaint_date >= convert(varchar(11),getdate(),106))                            
                                      
if @NO = 0  
begin  
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +  
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2))  
set @NO = @NO+'0'  
set @No = @department+'-'+@NO  
print @NO  
end  
else  
begin  
  
set @NO = (select Top 1 substring(substring(complaintno,charindex('-',complaintno)+1,100),7,100)+1 from                                       
complaint_table where  complaint_date >=convert(varchar(11),getdate()) order by                                       
isnull((substring(complaintno,CHARINDEX('-', complaintno)+7,100))+1,0) desc)                                      
                                    
set @NO = (SELECT left(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4) +                                       
right(right(replace(CONVERT(varchar(11),GETDATE(),103),'/',''),4),2)) + @NO                                     
                                    
set @No = @department + '-' + @NO                                                            
              
end                                      
-------------------Inserting Data ----------------------------------------------------------    
insert into complaint_table  
(              
complaint_date,department,dsection,queryfrom,contact_person,problem,suggestion,completed_on,                                    
completed_remark,grade,helpdeskMarkcompleted,helpdeskmarkcompleteddate,status,complaintno,                                    
code,category,emailid,phone,entry_by,subject,entered_through,mark_complete,Call_type,Grp_Id,City)                                    
values                                     
(getdate(),@department,'',@queryfrom,@contact_person,@problem,@suggestion,'',                                    
'remark','grade','N','','pending',@NO,@code,@category,@emailid,@phone,              
@entry_by,@problem,'HD','Y',@Call_type,@Grp_Id,@City)    
---------------------------------------------------------------------------------------------    
truncate table QA_temp_compNo          
insert into QA_temp_compNo values (@NO)    
----------------------If Mark as comapleted then update--------------------------------------    
if @chk = 'True'  
begin  
update helpdesk.dbo.complaint_table set helpdeskmarkcompleted='Y',status='Completed',completed_on=getdate(),    
helpdeskmarkcompleteddate=getdate(),mark_complete='N' where complaintno= @NO    
end    
---------------------------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetAllDates
-- --------------------------------------------------
CREATE procedure USP_GetAllDates    
(@Start_Date datetime,
@End_Date datetime)    
As     
Begin    
Create Table #Datetable (AllDates Datetime)    
While @Start_Date < = @End_Date    
Begin    
Insert into #Datetable(AllDates) Values(@Start_Date)    
Set @Start_Date = @Start_Date + 1    
End    
    
Select * From  #Datetable    
Drop Table #Datetable    
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_getData
-- --------------------------------------------------

create Proc USP_getData
(
@PONo as varchar(30)
)
as
declare @Fld_PID as int,@Fld_SrNo as int 
set @Fld_PID=(select Fld_PId from tbl_ItRequestPurchaseOrder(nolock) where Fld_PurchaseOrderNo=@PONo)
set @Fld_SrNo=(SELECT Fld_requestTableSrNo FROM tbl_ITAssetsData(nolock) where Fld_PId =@Fld_PID)
SELECT Fld_RequestId,Fld_requestTime FROM tbl_ITRequestMaster(nolock) where Fld_SrNo=@Fld_SrNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HelpdDesk_InboxCount
-- --------------------------------------------------
Create proc USP_HelpdDesk_InboxCount(@username  varchar(10))
as
select ( select count(*)  from V_OpsStatus (nolock)where dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username)) as Total,  
( select count(*)  from V_OpsStatus (nolock) where stat_flag ='P' and
dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username) ) as Pending,  
( select count(*)  from V_OpsStatus (nolock) where stat_flag in('IP','F','c') and 
dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username) ) as InProcess,  
( select count(*)  from V_OpsStatus (nolock) where stat_flag ='H'  and 
dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username) ) as HOld,  
( select count(*)  from V_OpsStatus (nolock) where stat_flag ='BC' and 
dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username) ) as Completed

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_helpdesk_DateWise_Rpt
-- --------------------------------------------------
CREATE proc dbo.usp_helpdesk_DateWise_Rpt        
(        
@fdate as varchar(25),        
@todate as varchar(25),        
@status as varchar(25),        
@username as varchar(25),        
@dept as varchar(25),      
@branch as varchar(50)    
)        
as         
    
if @branch = 'ALL'          
begin          
set @branch='%%'          
end         
    
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                                  
set @todate = convert(varchar(11),convert(datetime,@todate,103)) + ' 23:59:59.998'            
        
select convert(varchar(11),a.complaint_date,103)complaint_date,a.code,a.department,a.dsection,a.queryfrom,a.contact_person,a.problem,a.suggestion,      
a.remark,a.completed_on,a.status,a.complaintno,a.category,a.dremark,      
a.helpdeskmarkcompleteddate,a.entry_by,c.branch_cd,c.region,a.Grp_ID from         
(select complaint_date,code,department,dsection,queryfrom,contact_person,problem,suggestion,remark,completed_on,  
status,complaintno,party_code,category,dremark,helpdeskmarkcompleteddate,entry_by,Grp_ID 
from complaint_table (nolock) where complaint_date >= @fdate    
and complaint_date <= @todate and status like @status and department like @dept and 
entry_by like @username and Grp_ID like @branch and department <> 'IT')a        
left outer join        
(select departmentname,deptno from departmentmaster  )b        
on a.department = b.deptno        
left outer join         
(select party_code,branch_cd,region from intranet.risk.dbo.client_details)c        
on a.code = c.party_code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_helpdesk_misreport
-- --------------------------------------------------
CREATE proc usp_helpdesk_misreport  
(  
@fdate as varchar(50),  
@tdate as varchar(50),  
@department as varchar(50),  
@subject as varchar(50),  
@status as varchar(50)  
)  
as  
select * from v_helpdesk_misreport  
where complaint_date >= @fdate and complaint_date <= @tdate and  
dept_name=@department and  
subject=@subject and   
status like @status  
order by complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Helpdesk_PPQ
-- --------------------------------------------------
CREATE proc USP_Helpdesk_PPQ
(
@code as varchar(25)
)
as
Select * from 
(select convert(varchar(11),complaint_date,103)complaint_date,department,dsection,queryfrom,contact_person,problem,
isnull(suggestion,'')suggestion,completed_on,status,complaintno,party_code,category,
isnull(remark,'')remark,dremark,entry_by
from complaint_table where code=@code) a
left outer join 
(Select * from departmentmaster) b 
on a.department=b.deptno 
order by complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HelpDesk_requestdetail
-- --------------------------------------------------
Create proc  USP_HelpDesk_requestdetail          
(        
@complaint_id as varchar(30)        
)               
as            
SET NOCOUNT ON                  
select a.*,b.sub_broker         
into #temp from         
(select compl_abt,clt_subdetl,complaint_id,b.subject,Fld_EntryBy,c.emp_name,c.costcode,               
convert(varchar(12),complaint_date,103)as complaint_Date,        
convert(varchar(12),Solution_date,103)as Solution_date,                      
complaint,Attachment,a.status,sr_num           
from tbl_complaint a(nolock)         
left outer join         
intranet.risk.dbo.emp_info c on a.fld_entryby=c.emp_no         
,tbl_subject b                 
where  a.subject=b.srno)a left outer join  intranet.risk.dbo.client_details b          
on a.clt_subdetl = b.party_code  where a.complaint_id= @complaint_id  
        
update #temp set sub_broker = #temp.clt_subdetl from #temp where  compl_abt = 1      
update #temp set sub_broker = 'Branch' from #temp where  compl_abt = 2          
        
select a.*, case when a.sub_broker = b.b2c_sb then 'B2C' else 'B2B' end as Sb_type into #temp1 from        
(select * from #temp)a left outer join         
(select * from mis.remisior.dbo.b2c_sb)b        
on a.sub_broker = b.b2c_sb        
        
select * from #temp1 where status<>'F'        
and sr_num in (select max (sr_num) from v_requestdetail (nolock) group by complaint_id )        
order by complaint_date desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HelpDesk_requestdetail_d
-- --------------------------------------------------
CREATE proc  USP_HelpDesk_requestdetail_d              
(            
@complaint_id as varchar(30)            
)                   
as                
SET NOCOUNT ON                      
/*select a.*,b.sub_broker,Sb_type=case when b.b2c='Y' then 'B2C' else 'B2B' end             
into #temp from             
(select compl_abt,clt_subdetl,complaint_id,b.subject,Fld_EntryBy,c.person_name,c.access_code,                   
convert(varchar(12),complaint_date,103)as complaint_Date,            
convert(varchar(12),Solution_date,103)as Solution_date,                          
complaint,Attachment,a.status,sr_num               
from tbl_complaint a(nolock)             
left outer join             
intranet.risk.dbo.user_login c with (nolock) on a.fld_entryby=c.username             
,tbl_subject b                     
where  a.subject=b.srno)a left outer join  intranet.risk.dbo.client_details b    with (nolock)          
on a.clt_subdetl = b.party_code  
where a.complaint_id= @complaint_id      
            
update #temp set sub_broker = #temp.clt_subdetl from #temp where  compl_abt = 1          
update #temp set sub_broker = 'Branch' from #temp where  compl_abt = 2              
            
/*select a.*, case when a.sub_broker = b.b2c_sb then 'B2C' else 'B2B' end as Sb_type into #temp1 from            
(select * from #temp)a left outer join             
(select * from mis.remisior.dbo.b2c_sb)b            
on a.sub_broker = b.b2c_sb            
*/            
select * from #temp where status<>'F'            
and sr_num in (select max (sr_num) from v_requestdetail (nolock) group by complaint_id )            
order by complaint_date desc   

*/
-------------
select compl_abt,clt_subdetl,complaint_id,Fld_EntryBy,                   
convert(varchar(12),complaint_date,103)as complaint_Date,            
convert(varchar(12),Solution_date,103)as Solution_date,sub=subject,                          
complaint,Attachment,a.status,sr_num               
into #complain
from tbl_complaint a(nolock) where a.complaint_id= @complaint_id

select a.*,b.sub_broker,Sb_type=case when b.b2c='Y' then 'B2C' else 'B2B' end             
into #temp from             
(
select a.*,c.person_name,c.access_code,b.subject 
from
#complain a          
join             
(select person_name,username,access_code from 
intranet.risk.dbo.user_login with (nolock) 
) c
on a.fld_entryby=c.username             
,tbl_subject b                     
where  a.sub=b.srno)a 
left outer join 
(
select sub_broker,b2c,party_code from intranet.risk.dbo.client_details  with (nolock)
) b
on a.clt_subdetl = b.party_code        
            
update #temp set sub_broker = #temp.clt_subdetl from #temp where  compl_abt = 1          
update #temp set sub_broker = 'Branch' from #temp where  compl_abt = 2              
            
/*select a.*, case when a.sub_broker = b.b2c_sb then 'B2C' else 'B2B' end as Sb_type into #temp1 from            
(select * from #temp)a left outer join             
(select * from mis.remisior.dbo.b2c_sb)b            
on a.sub_broker = b.b2c_sb            
*/            
select * from #temp where status<>'F'            
and sr_num in (select max (sr_num) from v_requestdetail (nolock) group by complaint_id )            
order by complaint_date desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Helpdesk_Summary_Rpt
-- --------------------------------------------------
CREATE Proc dbo.USP_Helpdesk_Summary_Rpt              
(               
@fdate as varchar(30),              
@tdate as varchar(30),              
@dept as varchar(50),          
@branch as varchar(50)          
)              
as              
              
set @fdate = convert(datetime,@fdate,103)              
set @tdate = convert(datetime,@tdate,103) + ' 23:59:59.998'              
              
if @dept = 'ALL'              
begin              
set @dept='%%'              
end              
          
if @branch = 'ALL'              
begin              
set @branch='%%'              
end              
          
Select * from               
(select distinct a.departmentname as Department,            
Solved_Complaints = (Isnull(Completed,0)),Pending_Complaints = (Isnull(Pending,0)),        
Total = (Isnull(Completed,0)+Isnull(Pending,0))            
from complaint_table as ct (nolock)        
inner join               
departmentmaster as a (nolock) on ct.department = a.deptno              
left outer join               
(select Department,Completed=count(*)from complaint_table (nolock)              
where status='Completed' and complaint_date >=@fdate and Grp_ID like @branch    
and complaint_date <= @tdate and Grp_ID like @branch and department <> 'IT'    
group by Department) as C on ct.Department = C.Department              
left outer join               
(select Department,Pending=count(*) from complaint_table (nolock)              
where status='Pending' and complaint_date >=@fdate and               
complaint_date <= @tdate and Grp_ID like @branch and department <> 'IT' 
group by Department)as P               
on ct.Department = P.Department ) xxx               
where Total > 0 and Department like @dept
order by Department

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HELPDESKOPRATION_BranchMIS
-- --------------------------------------------------
CREATE proc  USP_HELPDESKOPRATION_BranchMIS  
(@fdate as varchar(11),  
@tdate as varchar(11),  
@access as varchar(20)  
)    
as     
Set NOCount ON    
set @fdate =convert(datetime,@fdate,103)    
set @tdate =convert(datetime,@tdate,103)    
select complaint_id,max(sr_num) sr_num into #t from tbl_complaint(nolock) where complaint_date>=@fdate    
and complaint_date<=@tdate+' 23:59:59' and access_code=@access group by complaint_id,access_code   
    
select a.*,b.dept_name into #tt from    
(select Complaint_date,Complaint_id,Fld_Query,Stat_Flag,status,Emp_name,Branch_Tag,subject,dept_id,deptname=DEPT_NAME,
fld_entryby,sr_num,clt_subdetl from v_opsstatus where sr_num in    
(select sr_num from #t))a    
left outer join    
(select dept_id,dept_name from department_master)b    
on a.dept_id=b.dept_id    
    
select a.*,isnull(b.Pend,0) Pending ,isnull(c.ip,0) InProcess,isnull(d.hld,0) Hold,    
isnull(e.Comp,0)Completed,isnull(f.BC,0) Branch_Completed from    
(select dept_name,dept_id,Total=count(*) from #tt group by dept_name,dept_id)a     
left outer join    
(select dept_name,Pend=count(*) from #tt where stat_flag ='P' group by dept_name)b on a.dept_name=b.dept_name    
left outer join    
(select dept_name,ip=count(*) from #tt where stat_flag in('IP','F') group by dept_name)c on a.dept_name=c.dept_name    
left outer join    
(select dept_name,Hld=count(*) from #tt where stat_flag='H' group by dept_name)d on a.dept_name=d.dept_name    
left outer join    
(select dept_name,Comp=count(*) from #tt where stat_flag='C' group by dept_name)e on a.dept_name=e.dept_name    
left outer join    
(select dept_name,BC=count(*) from #tt where stat_flag='BC' group by dept_name)f    
on a.dept_name=f.dept_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HELPDESKOPRATION_MNM_REPORT
-- --------------------------------------------------
CREATE proc  USP_HELPDESKOPRATION_MNM_REPORT
(
@fdate as varchar(11),
@tdate as varchar(11),
@access_code as varchar(15),
@dept_id as varchar(2)
)    
as     
Set NOCount ON  
set @fdate =convert(datetime,'01/01/2010',103)    
set @tdate =convert(datetime,'01/03/2010',103)    
select complaint_id,max(sr_num) sr_num into #t from tbl_complaint(nolock) where complaint_date>=@fdate    
and complaint_date<=@tdate+' 23:59:59' and access_code like @access_code and dept_id like @dept_id group by complaint_id   

    
select a.*,b.dept_name into #tt from    
(select * from v_opsstatus where sr_num in    
(select sr_num from #t))a    
left outer join    
(select dept_id,dept_name from department_master)b    
on a.dept_id=b.dept_id    
    
select a.*,isnull(b.Pend,0) Pending ,isnull(c.ip,0) InProcess,isnull(d.hld,0) Hold,    
isnull(e.Comp,0)Completed,isnull(f.BC,0) Branch_Completed from    
(select dept_name,dept_id,Total=count(*) from #tt group by dept_name,dept_id)a     
left outer join    
(select dept_name,Pend=count(*) from #tt where stat_flag ='P' group by dept_name)b on a.dept_name=b.dept_name    
left outer join    
(select dept_name,ip=count(*) from #tt where stat_flag in('IP','F') group by dept_name)c on a.dept_name=c.dept_name    
left outer join    
(select dept_name,Hld=count(*) from #tt where stat_flag='H' group by dept_name)d on a.dept_name=d.dept_name    
left outer join    
(select dept_name,Comp=count(*) from #tt where stat_flag='C' group by dept_name)e on a.dept_name=e.dept_name    
left outer join    
(select dept_name,BC=count(*) from #tt where stat_flag='BC' group by dept_name)f    
on a.dept_name=f.dept_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HELPDESKOPRATION_REPORT
-- --------------------------------------------------
CREATE proc  USP_HELPDESKOPRATION_REPORT(@fdate as varchar(11),@tdate as varchar(11))  
as   
Set NOCount ON  
set @fdate =convert(datetime,@fdate,103)  
set @tdate =convert(datetime,@tdate,103)  
select complaint_id,max(sr_num) sr_num into #t from tbl_complaint(nolock) where complaint_date>=@fdate  
and complaint_date<=@tdate+' 23:59:59' group by complaint_id  
  
select a.*,b.dept_name into #tt from  
(select * from v_opsstatus where sr_num in  
(select sr_num from #t))a  
left outer join  
(select dept_id,dept_name from department_master)b  
on a.dept_id=b.dept_id  
  
select a.*,isnull(b.Pend,0) Pending ,isnull(c.ip,0) InProcess,isnull(d.hld,0) Hold,  
isnull(e.Comp,0)Completed,isnull(f.BC,0) Branch_Completed from  
(select dept_name,dept_id,Total=count(*) from #tt group by dept_name,dept_id)a   
left outer join  
(select dept_name,Pend=count(*) from #tt where stat_flag ='P' group by dept_name)b on a.dept_name=b.dept_name  
left outer join  
(select dept_name,ip=count(*) from #tt where stat_flag in('IP','F') group by dept_name)c on a.dept_name=c.dept_name  
left outer join  
(select dept_name,Hld=count(*) from #tt where stat_flag='H' group by dept_name)d on a.dept_name=d.dept_name  
left outer join  
(select dept_name,Comp=count(*) from #tt where stat_flag='C' group by dept_name)e on a.dept_name=e.dept_name  
left outer join  
(select dept_name,BC=count(*) from #tt where stat_flag='BC' group by dept_name)f  
on a.dept_name=f.dept_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HELPDESKOPRATION_REPORT_Dummy
-- --------------------------------------------------
CREATE proc USP_HELPDESKOPRATION_REPORT_Dummy    
(            
@From_Date varchar(20),            
@To_Date varchar(20)            
)             
as    
  
--declare @From_Date varchar(20),@To_Date varchar(20)         
set @From_Date=convert(datetime,@From_Date,103)             
set @To_Date=convert(datetime,@To_Date,103)+ ' 23:59:59.000'   
  
select count(distinct dept_id)as Total,dept_id into #t from tbl_complaint(nolock) where  complaint_date >= @From_Date and complaint_date <= @To_Date group by dept_id,Complaint_id   
select count(distinct dept_id)as Total,dept_id into #t1 from tbl_complaint(nolock) where status='P' and complaint_date >= @From_Date and complaint_date <= @To_Date group by dept_id,Complaint_id   
select count(distinct dept_id)as Total,dept_id into #t2 from tbl_complaint(nolock) where status in ('IP','F','C') and complaint_date >= @From_Date and complaint_date <= @To_Date group by dept_id,Complaint_id   
select count(distinct dept_id)as Total,dept_id into #t3 from tbl_complaint(nolock) where status ='H' and complaint_date >= @From_Date and complaint_date <= @To_Date group by dept_id,Complaint_id   
select count(distinct dept_id)as Total,dept_id into #t4 from tbl_complaint(nolock) where status ='BC' and complaint_date >= @From_Date and complaint_date <= @To_Date group by dept_id,Complaint_id   
  
select dept_name,isnull(b.Total,0) as Total,isnull(c.Pending,0) as Pending, isnull(d.InProcess,0) as InProcess, isnull(e.Hold,0) as Hold,isnull(f.Branch_Completed,0) as Branch_Completed --,isnull(f.Completed,0) as Completed  
from            
(select * from department_master(nolock))a            
 full outer join     
(select Dept_id,count(Dept_id) as Total from #t group by Dept_id) b            
on a.dept_id = b.dept_id    
  
 full outer join     
(select Dept_id,count(Dept_id) as Pending from #t1 group by Dept_id) c            
on a.dept_id = c.dept_id     
  
 full outer join     
(select Dept_id,count(Dept_id) as InProcess from #t2 group by Dept_id) d            
on a.dept_id = d.dept_id    
  
 full outer join     
(select Dept_id,count(Dept_id) as Hold from #t3 group by Dept_id) e           
on a.dept_id = e.dept_id    
  
 full outer join     
(select Dept_id,count(Dept_id) as Branch_Completed from #t4 group by Dept_id) f          
on a.dept_id = f.dept_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hlp_catgory_item
-- --------------------------------------------------
CREATE proc usp_hlp_catgory_item
(@drpDepartment as varchar(50),  
@drpLocation as varchar(50),  
@txtItemId as Varchar(100),  
@txtAltIP as varchar(100),  
@txtEmail as varchar(50),  
@txtTelNo as varchar(50),  
@txtCity as varchar(100),  
@txtType as varchar(100),  
@txtAddress as varchar(100),  
@txtContPerson as varchar(100)
)  
as  
set nocount on  

insert into v_sat_mast1 values (@drpDepartment,@drpLocation,@txtItemId,@txtAltIP,@txtEmail,@txtTelNo,@txtCity,@txtType,@txtAddress,@txtContPerson)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hlp_Client_Details
-- --------------------------------------------------
CREATE proc usp_hlp_Client_Details  
(  
@category as varchar(50),  
@code as varchar(15)
)  
  
as  
set nocount on  
  
if @category = 'CLIENT'  
begin  
select Top 1 city=a.l_city,a.short_name,ph=isnull(a.res_phone1,''),email=isnull(a.email,''),branch=a.branch_cd,  
subgroup=a.sub_broker,b.subject,b.suggestion from intranet.risk.dbo.client_details  
as a inner join Test_complaint_table as b on a.party_Code = @code  order by b.complaint_date desc  
end  
  
if @category = 'SUBBROKER'  
begin  
select Top 1 city=isnull(a.city,''),short_name=a.Name,ph=isnull(a.Phone1,''),Email=isnull(a.Email,''),  
branch=a.branch_code,subgroup=a.sub_broker,b.subject,b.suggestion from intranet.risk.dbo.subbrokers as a inner join  
Test_complaint_table as b on a.Sub_broker = @code order by b.complaint_date desc  
end  
  
if @category = 'BRANCH'  
begin  
select Top 1 city=a.l_city,a.short_name,ph=isnull(a.res_phone1,''),email=isnull(a.email,''),  
branch=a.branch_cd,subgroup=a.sub_broker,b.subject,b.suggestion from intranet.risk.dbo.client_details as a inner join  
Test_complaint_table as b on a.party_Code = @code  order by b.complaint_date desc  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hlp_Client_Details_IT
-- --------------------------------------------------
CREATE proc usp_hlp_Client_Details_IT    
(    
@category as varchar(50),    
@code as varchar(15)  
)    
    
as    
set nocount on    

select Top 1 code=@code,short_name=ltrim(isnull(Cat_ContPerson,'')), ph=ltrim(rtrim(isnull(cat_phone,''))),
email=isnull(cat_email,''),city=isnull(cat_city,'') from v_sat_mast1 where category = @category and 
(cat_item_id = @code or cat_PCIP = @code) order by Sr_No desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hlp_login
-- --------------------------------------------------
CREATE proc usp_hlp_login    
(@txtuserName as varchar(50),    
@txtpwd as varchar(50),    
@txtconPwd as Varchar(50),    
@txtdepartment as varchar(50),    
@txtname as varchar(50),    
@txtMidName as varchar(50),    
@txtLastName as varchar(50),    
@txtcategory as varchar(50),    
@txtEmailID as varchar(50),    
@txtTelNo as varchar(50),    
@txtAdd as varchar(50),    
@txtlocation as varchar(50))    
as    
set nocount on    
    
insert into logintablecopy values(@txtuserName,@txtpwd,@txtconPwd,@txtdepartment,@txtname,@txtMidName,@txtLastName,@txtcategory,@txtEmailID,@txtTelNo,@txtAdd,@txtlocation,0,'')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HLP_MISREPORT
-- --------------------------------------------------
CREATE Proc USP_HLP_MISREPORT  
(@FromDate as varchar(20),  
@ToDate as  varchar(20),  
@Location as Varchar(20),  
@UserName as varchar(20),  
@Status as varchar(20))  
  
as   
  
set nocount on  

-- select  * from complaint_table where complaint_date >= convert(datetime,@FromDate,103)
-- and complaint_date <= convert(datetime,@ToDate,103) + ' 23:59:59' and Grp_Id like @Location
-- and entry_by  like @UserName and status like @Status

select distinct complaint_date,code,queryfrom,contact_person,problem,suggestion,completed_on,status,complaintno,
deptmarkcompleteddate,cast(datediff(Minute,complaint_date, deptmarkcompleteddate)as varchar(50)) + 'Minutes' as Minutes 
from complaint_table where complaint_date >= convert(datetime,@FromDate,103) and complaint_date <= convert(datetime,@ToDate,103) + ' 23:59:59'
--and department = @department and status like @Status and entry_by like @UserName and grp_id like @Location
and status like @Status and entry_by like @UserName and grp_id like @Location

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_HodRequest_Count
-- --------------------------------------------------
Create Proc Usp_HodRequest_Count
(
@hod as varchar(15)
)
as
SET NOCOUNT ON 
select srno,complaint_id,flag into #tt from travelbooking where hod=@hod
select Total=count(*) from #tt where flag like '%%'
select Hold=count(*) from #tt where flag ='HH'
select Accept=count(*) from #tt where flag='HA'
select Reject=count(*) from #tt where flag='HR'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Branch_MIS
-- --------------------------------------------------
CREATE Proc USP_HR_Branch_MIS            
(            
@fdate as varchar(11),            
@tdate as varchar(11),            
@Req_ID as char(5)            
)            
as            
      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))      
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))      
          
select x.*,y.code from          
(            
select * from        
(        
select distinct x.pid,x.Attnlocation,            
isnull(y.Total,0) as Total,            
isnull(a.Completed,0) as Completed,            
isnull(z.Delayed,0) as Delayed,            
isnull(z.Pending,0) as Pending            
 from            
(select * from V_Region_Location) x            
left outer join            
(select Branch_id,count(*) as Total from V_Mis_Rpt where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Branch_id) y            
on x.pid = y.Branch_id            
left outer join            
(            
select             
case when x.Branch_id is null then y.Branch_id else x.Branch_id  end as Branch_id,            
isnull(x.Delayed,0) as Delayed,            
isnull(y.Pending,0) as Pending             
 from             
(select Branch_id,count(*) as  Delayed from V_Mis_Rpt where Fld_Status = 'P' and             
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID group by Branch_id)x            
full outer join            
(select Branch_id,count(*) as  Pending from V_Mis_Rpt where Fld_Status = 'P' and             
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Branch_id)y            
on x.Branch_id = y.Branch_id            
) z            
on x.pid = z.Branch_id            
left outer join            
(select Branch_id,count(*) as Completed from  V_Mis_Rpt where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID group by Branch_id) a            
on x.pid = a.Branch_id        
) x where pid is not null and   Total <> 0        
) x          
left outer join          
(select * from V_Region_Location) y          
on x.pid  = y.pid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Branch_MIS_New
-- --------------------------------------------------
CREATE Proc USP_HR_Branch_MIS_New                  
(                  
@fdate as varchar(11),                  
@tdate as varchar(11),                  
@Req_ID as char(5)                  
)                  
as                  
            
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))            
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))            
                
select x.*,y.description from                
(                  
select * from              
(              
select distinct x.pid,x.Attnlocation,                  
isnull(y.Total,0) as Total,                  
isnull(a.Completed,0) as Completed,                  
isnull(z.Delayed,0) as Delayed,                  
isnull(z.Pending,0) as Pending                  
 from                  
(select * from V_Region_Location) x                  
left outer join                  
(select Branch_id,branch_cd,count(*) as Total from V_Mis_Rpt_new where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Branch_id,branch_cd) y                  
on x.Attnlocation = y.branch_cd                  
left outer join                  
(                  
select                   
case when x.branch_cd is null then y.branch_cd else x.branch_cd  end as branch_cd,                  
isnull(x.Delayed,0) as Delayed,                  
isnull(y.Pending,0) as Pending                   
 from                   
(select branch_cd,count(*) as  Delayed from V_Mis_Rpt_new where Fld_Status = 'P' and                   
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID group by branch_cd)x                  
full outer join                  
(select branch_cd,count(*) as  Pending from V_Mis_Rpt_new where Fld_Status = 'P' and                   
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by branch_cd)y                  
on x.branch_cd = y.branch_cd                  
) z                  
on x.Attnlocation = z.branch_cd                  
left outer join                  
(select branch_cd,count(*) as Completed from  V_Mis_Rpt_new where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID group by branch_cd) a                  
on x.Attnlocation = a.branch_cd              
) x where Attnlocation is not null and   Total <> 0              
) x                
left outer join                
(select * from V_Region_Location) y                
on x.Attnlocation  = y.Attnlocation

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Branch_MIS_New_HR
-- --------------------------------------------------
CREATE Proc USP_HR_Branch_MIS_New_HR                  
(                  
@fdate as varchar(11),                  
@tdate as varchar(11),                  
@Req_ID as char(5)                  
)                  
as                  
            
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))            
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))            
                
select x.*,y.description from                
(                  
select * from              
(              
select distinct x.pid,x.Attnlocation,                  
isnull(y.Total,0) as Total,                  
isnull(a.Completed,0) as Completed,                  
isnull(z.Delayed,0) as Delayed,                  
isnull(z.Pending,0) as Pending                  
 from                  
(select * from V_Region_Location) x                  
left outer join                  
(select Branch_id,branch_cd,count(*) as Total from V_Mis_Rpt_New where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Branch_id,branch_cd) y                  
on x.Attnlocation = y.branch_cd                  
left outer join                  
(                  
select                   
case when x.branch_cd is null then y.branch_cd else x.branch_cd  end as branch_cd,                  
isnull(x.Delayed,0) as Delayed,                  
isnull(y.Pending,0) as Pending                   
 from                   
(select branch_cd,count(*) as  Delayed from V_Mis_Rpt_New where Fld_Status = 'P' and                   
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID group by branch_cd)x                  
full outer join                  
(select branch_cd,count(*) as  Pending from V_Mis_Rpt_New where Fld_Status = 'P' and                   
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by branch_cd)y                  
on x.branch_cd = y.branch_cd                  
) z                  
on x.Attnlocation = z.branch_cd                  
left outer join                  
(select branch_cd,count(*) as Completed from  V_Mis_Rpt_New where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID group by branch_cd) a                  
on x.Attnlocation = a.branch_cd              
) x where Attnlocation is not null and   Total <> 0              
) x                
left outer join                
(select * from V_Region_Location) y                
on x.Attnlocation  = y.Attnlocation

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hr_branch_mis_newbranch
-- --------------------------------------------------
CREATE proc usp_hr_branch_mis_newbranch
(                        
@fdate as varchar(11),                        
@tdate as varchar(11),                        
@Req_ID as char(5),  
@catid as char(5)                      
)                        
                        
as                        
                    
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                    
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                    
  
/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5),@catid as char(5)          
set @fdate = convert(varchar(11),convert(datetime,'01/01/2010',103))          
set @tdate = convert(varchar(11),convert(datetime,'12/01/2010',103))            
set @Req_ID = '%'  
set @catid = '%'  
 */
  
select  
case when a.Regionname is null then b.Regionname else a.Regionname end as Regionname,  
case when a.code is null then b.code else a.code end as code,  
case when a.branch_name is null then b.branch_name else a.branch_name end as branch_name,
Total = isnull(Total,0),  
Completed = isnull(Completed,0),  
Delayed = isnull(Delayed,0),  
Pending = isnull(Pending,0)   
from  
(  
select case   
when a.Regionname is null then b.Regionname else b.Regionname end as Regionname,  
case when a.code is null then b.code else b.code end as code,
case when a.branch_name is null then b.branch_name else b.branch_name end as branch_name,    
Total = isnull(Total,0),  
Completed = isnull(Completed,0) from  
(
select case when Regionname  is null then 'Others' else Regionname  end as Regionname,
case when code is null then 'Others' else code end as code,
case when branch_name is null then 'Others' else branch_name end as branch_name,
count(*) as Total from V_Mis_Rpt_new with (nolock)
where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' 
and convert(char(10),Fld_Request_id) like @Req_ID  and 
convert(char(10),Fldcatid) like @catid group by Regionname,code,branch_name

)a                  
full outer join  
(
select case when Regionname is null then 'Others' else Regionname end as Regionname,
case when code is null then 'Others' else code end as code,
case when branch_name is null then 'Others' else branch_name end as branch_name,
count(*) as Completed from  V_Mis_Rpt_new with (nolock)
where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59' 
and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and 
convert(char(10),Fldcatid) like @catid group by Regionname,code,branch_name) b  
on a.code = b.code  
)a  
Full outer join  
(  
select   
case when a.Regionname is null then b.Regionname else b.Regionname end as Regionname,  
case when a.code is null then b.code else b.code end as code, 
case when a.branch_name is null then b.branch_name else b.branch_name end as branch_name, 
Delayed = isnull(Delayed,0),  
Pending = isnull(Pending,0) from  
(
select 
case when regionname is null then 'Others' else regionname end as regionname,
case when code is null then 'Others' else code end as code,
case when branch_name is null then 'Others' else branch_name end as branch_name,
count(*) as  Delayed from V_Mis_Rpt_new with (nolock) where Fld_Status = 'P' and                         
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid group by regionname,code,branch_name)a  
full outer join  
(
select 
case when regionname is null then 'Others' else regionname end as regionname,
case when code is null then 'Others' else code end as code,
case when branch_name is null then 'Others' else branch_name end as branch_name,
count(*) as  Pending from V_Mis_Rpt_new with (nolock) where Fld_Status = 'P' and                         
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID  and convert(char(10),Fldcatid) like @catid group by regionname,code,branch_name)b  
on a.code = b.code  
)b  
on 
a.Regionname = b.Regionname  
and  
a.code = b.code 
where 
a.regionname is not null 
and 
a.code is not null
and 
a.branch_name is not null order by a.branch_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_BRANCH_MIS_NEWBRANCH_15122010
-- --------------------------------------------------
CREATE PROCEDURE USP_HR_BRANCH_MIS_NEWBRANCH_15122010
(                          
	@fdate as varchar(11),                          
	@tdate as varchar(11),                          
	@Req_ID as char(5),    
	@catid as char(5)                        
)                          
                          
as                          
                      
	set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                      
	set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                      
	    
	/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5),@catid as char(5)            
	set @fdate = convert(varchar(11),convert(datetime,'01/01/2010',103))            
	set @tdate = convert(varchar(11),convert(datetime,'12/01/2010',103))              
	set @Req_ID = '%'    
	set @catid = '%'    
	 */  
	
	-- [+] ADDED ON 15-12-2010
	 
	SELECT CASE WHEN A.REGIONNAME IS NULL THEN B.REGIONNAME ELSE B.REGIONNAME END AS REGIONNAME,    
			case when a.code is null then b.code else b.code end as code,  
			case when a.branch_name is null then b.branch_name else b.branch_name end as branch_name,      
			Total = isnull(Total,0),    
			Completed = isnull(Completed,0) 
	INTO #TEMP
	from    
	(  
		select case when Regionname  is null then 'Others' else Regionname  end as Regionname,  
			case when code is null then 'Others' else code end as code,  
			case when branch_name is null then 'Others' else branch_name end as branch_name,  
			count(*) as Total 
		from V_Mis_Rpt_new with (nolock)  
		where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'   
			and convert(char(10),Fld_Request_id) like @Req_ID  and   
			convert(char(10),Fldcatid) like @catid 
		group by Regionname,code,branch_name  
	)a  
	                  
	full outer join    
	(  
		select case when Regionname is null then 'Others' else Regionname end as Regionname,  
			case when code is null then 'Others' else code end as code,  
			case when branch_name is null then 'Others' else branch_name end as branch_name,  
			count(*) as Completed 
		from  V_Mis_Rpt_new with (nolock)  
		where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59'   
			and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and   
			convert(char(10),Fldcatid) like @catid 
		group by Regionname,code,branch_name
	) b on a.code = b.code
	
	
	-- [-] ADDED ON 15-12-2010
	
	select case when a.Regionname is null then b.Regionname else a.Regionname end as Regionname,    
		case when a.code is null then b.code else a.code end as code,    
		case when a.branch_name is null then b.branch_name else a.branch_name end as branch_name,  
		Total = isnull(Total,0),    
		Completed = isnull(Completed,0),    
		Delayed = isnull(Delayed,0),    
		Pending = isnull(Pending,0)     
	from    
	#temp a
	--(    
		--select case when a.Regionname is null then b.Regionname else b.Regionname end as Regionname,    
		--	case when a.code is null then b.code else b.code end as code,  
		--	case when a.branch_name is null then b.branch_name else b.branch_name end as branch_name,      
		--	Total = isnull(Total,0),    
		--	Completed = isnull(Completed,0) 
		--from    
		--(  
		--	select case when Regionname  is null then 'Others' else Regionname  end as Regionname,  
		--		case when code is null then 'Others' else code end as code,  
		--		case when branch_name is null then 'Others' else branch_name end as branch_name,  
		--		count(*) as Total 
		--	from V_Mis_Rpt_new with (nolock)  
		--	where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'   
		--		and convert(char(10),Fld_Request_id) like @Req_ID  and   
		--		convert(char(10),Fldcatid) like @catid 
		--	group by Regionname,code,branch_name  
		--)a  
		                  
		--full outer join    
		--(  
		--	select case when Regionname is null then 'Others' else Regionname end as Regionname,  
		--		case when code is null then 'Others' else code end as code,  
		--		case when branch_name is null then 'Others' else branch_name end as branch_name,  
		--		count(*) as Completed 
		--	from  V_Mis_Rpt_new with (nolock)  
		--	where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59'   
		--		and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and   
		--		convert(char(10),Fldcatid) like @catid 
		--	group by Regionname,code,branch_name
		--) b on a.code = b.code    
	--)a
		    
	Full outer join    
	(    
		select case when a.Regionname is null then b.Regionname else b.Regionname end as Regionname,    
		case when a.code is null then b.code else b.code end as code,   
		case when a.branch_name is null then b.branch_name else b.branch_name end as branch_name,   
		Delayed = isnull(Delayed,0),    
		Pending = isnull(Pending,0) 
		from    
		(  
			select case when regionname is null then 'Others' else regionname end as regionname,  
				case when code is null then 'Others' else code end as code,  
				case when branch_name is null then 'Others' else branch_name end as branch_name,  
				count(*) as  Delayed 
			from V_Mis_Rpt_new with (nolock) 
			where Fld_Status = 'P' and  datediff(hh,Fld_complaint_date,getdate()) > 24 
				and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'
				and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid 
			group by regionname,code,branch_name
		)a
			    
		full outer join    
		(  
			select case when regionname is null then 'Others' else regionname end as regionname,  
				case when code is null then 'Others' else code end as code,  
				case when branch_name is null then 'Others' else branch_name end as branch_name,  
				count(*) as  Pending 
			from V_Mis_Rpt_new with (nolock) 
			where Fld_Status = 'P' and datediff(hh,Fld_complaint_date,getdate()) <= 24 
				and Fld_complaint_date >= @fdate 
				and Fld_complaint_date <= @tdate+' 23:59:59' 
				and convert(char(10),Fld_Request_id) like @Req_ID 
				and convert(char(10),Fldcatid) like @catid 
			group by regionname,code,branch_name
		)b on a.code = b.code    
	)b 
	   
	on a.Regionname = b.Regionname and a.code = b.code   
	where a.regionname is not null   
		and a.code is not null and a.branch_name is not null 
	--order by a.branch_name
	order by #temp.branch_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_BRANCH_MIS_NEWBRANCH_31122010
-- --------------------------------------------------
CREATE PROCEDURE USP_HR_BRANCH_MIS_NEWBRANCH_31122010
(                          
	@FDATE AS VARCHAR(11),                          
	@TDATE AS VARCHAR(11),                          
	@REQ_ID AS CHAR(5),    
	@CATID AS CHAR(5)                        
)                          
                          
AS                          
                      
	SET @FDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103))                      
	SET @TDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))                      
	    
	/*DECLARE @FDATE AS VARCHAR(11),@TDATE AS VARCHAR(11), @REQ_ID AS CHAR(5),@CATID AS CHAR(5)            
	SET @FDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,'01/01/2010',103))            
	SET @TDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,'12/01/2010',103))              
	SET @REQ_ID = '%'    
	SET @CATID = '%'    
	 */  
	    
	SELECT    
	CASE WHEN A.REGIONNAME IS NULL THEN B.REGIONNAME ELSE A.REGIONNAME END AS REGIONNAME,    
	CASE WHEN A.CODE IS NULL THEN B.CODE ELSE A.CODE END AS CODE,    
	BRANCH_NAME=CASE WHEN A.BRANCH_NAME IS NULL THEN B.BRANCH_NAME ELSE A.BRANCH_NAME END,  
	TOTAL = ISNULL(TOTAL,0),    
	COMPLETED = ISNULL(COMPLETED,0),    
	DELAYED = ISNULL(DELAYED,0),    
	PENDING = ISNULL(PENDING,0)     
	FROM    
	(    
	SELECT CASE     
	WHEN A.REGIONNAME IS NULL THEN B.REGIONNAME ELSE B.REGIONNAME END AS REGIONNAME,    
	CASE WHEN A.CODE IS NULL THEN B.CODE ELSE B.CODE END AS CODE,  
	CASE WHEN A.BRANCH_NAME IS NULL THEN B.BRANCH_NAME ELSE B.BRANCH_NAME END AS BRANCH_NAME,      
	TOTAL = ISNULL(TOTAL,0),    
	COMPLETED = ISNULL(COMPLETED,0) FROM    
	(  
	SELECT CASE WHEN REGIONNAME  IS NULL THEN 'OTHERS' ELSE REGIONNAME  END AS REGIONNAME,  
	CASE WHEN CODE IS NULL THEN 'OTHERS' ELSE CODE END AS CODE,  
	CASE WHEN BRANCH_NAME IS NULL THEN 'OTHERS' ELSE BRANCH_NAME END AS BRANCH_NAME,  
	COUNT(*) AS TOTAL FROM V_MIS_RPT_NEW WITH (NOLOCK)  
	WHERE FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59'   
	AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID  AND   
	CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY REGIONNAME,CODE,BRANCH_NAME  
	  
	)A                    
	FULL OUTER JOIN    
	(  
	SELECT CASE WHEN REGIONNAME IS NULL THEN 'OTHERS' ELSE REGIONNAME END AS REGIONNAME,  
	CASE WHEN CODE IS NULL THEN 'OTHERS' ELSE CODE END AS CODE,  
	CASE WHEN BRANCH_NAME IS NULL THEN 'OTHERS' ELSE BRANCH_NAME END AS BRANCH_NAME,  
	COUNT(*) AS COMPLETED FROM  V_MIS_RPT_NEW WITH (NOLOCK)  
	WHERE FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE<= @TDATE+' 23:59:59'   
	AND FLD_STATUS = 'C' AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID AND   
	CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY REGIONNAME,CODE,BRANCH_NAME) B    
	ON A.CODE = B.CODE    
	)A    
	FULL OUTER JOIN    
	(    
	SELECT     
	CASE WHEN A.REGIONNAME IS NULL THEN B.REGIONNAME ELSE B.REGIONNAME END AS REGIONNAME,    
	CASE WHEN A.CODE IS NULL THEN B.CODE ELSE B.CODE END AS CODE,   
	CASE WHEN A.BRANCH_NAME IS NULL THEN B.BRANCH_NAME ELSE B.BRANCH_NAME END AS BRANCH_NAME,   
	DELAYED = ISNULL(DELAYED,0),    
	PENDING = ISNULL(PENDING,0) FROM    
	(  
	SELECT   
	CASE WHEN REGIONNAME IS NULL THEN 'OTHERS' ELSE REGIONNAME END AS REGIONNAME,  
	CASE WHEN CODE IS NULL THEN 'OTHERS' ELSE CODE END AS CODE,  
	CASE WHEN BRANCH_NAME IS NULL THEN 'OTHERS' ELSE BRANCH_NAME END AS BRANCH_NAME,  
	COUNT(*) AS  DELAYED FROM V_MIS_RPT_NEW WITH (NOLOCK) WHERE FLD_STATUS = 'P' AND                           
	DATEDIFF(HH,FLD_COMPLAINT_DATE,GETDATE()) > 24 AND FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59'AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID AND CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY REGIONNAME,CODE,BRANCH_NAME)A
	    
	FULL OUTER JOIN    
	(  
	SELECT   
	CASE WHEN REGIONNAME IS NULL THEN 'OTHERS' ELSE REGIONNAME END AS REGIONNAME,  
	CASE WHEN CODE IS NULL THEN 'OTHERS' ELSE CODE END AS CODE,  
	CASE WHEN BRANCH_NAME IS NULL THEN 'OTHERS' ELSE BRANCH_NAME END AS BRANCH_NAME,  
	COUNT(*) AS  PENDING FROM V_MIS_RPT_NEW WITH (NOLOCK) WHERE FLD_STATUS = 'P' AND                           
	DATEDIFF(HH,FLD_COMPLAINT_DATE,GETDATE()) <= 24 AND FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59' AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID  AND CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY REGIONNAME,CODE,BRANCH_NAME
	)B    
	ON A.CODE = B.CODE    
	)B    
	ON   
	A.REGIONNAME = B.REGIONNAME    
	AND    
	A.CODE = B.CODE   
	WHERE   
	A.REGIONNAME IS NOT NULL   
	AND   
	A.CODE IS NOT NULL  
	AND   
	A.BRANCH_NAME IS NOT NULL 
	
	ORDER BY BRANCH_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hr_Delayed_ReqCategoryWise
-- --------------------------------------------------
CREATE proc usp_hr_Delayed_ReqCategoryWise
(
@fdate as varchar(25),                            
@tdate as varchar(25),                            
@Req_ID as varchar(10),      
@catid as varchar(10),
@regionname as varchar(80)  
)
as
/*
declare
@fdate as varchar(11),@tdate as varchar(11),@Req_ID as char(5),@catid as char(5),@regionname as varchar(80)
set @fdate =  '04/01/2010'
set @tdate = '06/01/2010'
set @Req_ID = '%'
set @catid = '1'
set @regionname = 'COIMBATORE'

set @fdate = convert(datetime,@fdate,103)                       
set @tdate = convert(datetime,@tdate,103)*/

--print @Req_ID 

select 
fld_srno,
convert(varchar(11),Fld_Complaint_date,103) as Fld_Complaint_date ,
Fld_Emp_Code,
fldsubcatname,
Fld_Mark_Time,
Fld_Solved_By,
Fld_Complaint_No,
Fld_Status,
Fld_Query,
Fld_Solution,
emp_name,
Emp_No,
department,
Sr_Name,
phone,
Solved_by,
fldcatname 
from V_Mis_RptCategory with (nolock) 
where regionname like @regionname
and fld_complaint_date >= convert(varchar(11),convert(datetime,@fdate,103)) and
fld_complaint_date <= convert(varchar(11),convert(datetime,@tdate,103)) + ' 23:59:59.000' 
and fld_request_id like @Req_ID and fldcatid like @catid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Mail_MIS
-- --------------------------------------------------
CREATE Proc USP_HR_Mail_MIS            
(                    
@fdate as varchar(11),                    
@tdate as varchar(11),                    
@Req_ID as char(5)                    
)                    
as                    
 /*declare @fdate as varchar(11),@tdate as varchar(11),@Req_ID as char(5)                 
set @fdate='02/07/2008'    
set @tdate='02/07/2008'    
set @Req_ID='2'*/    
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))              
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))           
          
          
select a.*,Completed=isnull(b.Completed,'0'),Pending=isnull(c.Pending,'0'),delayed=isnull(d.delayed,'0') into #temp from           
(select Fld_request_id,Total = count(*)  from tbl_hr_complaint_master (nolock) where Fld_complaint_date >= @fdate          
and Fld_complaint_date <= @tdate+' 23:59:59' group by Fld_request_id)a          
left outer join          
(select Fld_request_id,count(*) as Completed  from tbl_hr_complaint_master (nolock) where Fld_complaint_date >= @fdate          
and Fld_complaint_date <= @tdate+' 23:59:59' and fld_status = 'c' group by Fld_request_id)b          
on a.Fld_request_id = b.Fld_request_id          
left outer join          
(select Fld_request_id,count(*) as Pending from tbl_hr_complaint_master (nolock) where datediff(hh,Fld_complaint_date,getdate()) <= 24 
and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and fld_status = 'P' group by Fld_request_id)c          
on a.Fld_request_id = c.Fld_request_id          
left outer join          
(select Fld_request_id,count(*) as  delayed from tbl_hr_complaint_master (nolock) where Fld_Status = 'P' and                     
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and           
Fld_complaint_date <= @tdate+' 23:59:59' group by Fld_request_id)d          
on a.Fld_request_id = d.Fld_request_id          
          
if @Req_ID = '%%'          
begin          
 select b.fld_request,a.* from #temp a inner join tbl_request_master b on a.Fld_request_id=b.Fld_srno    
    order by a.Fld_request_id      
end          
else          
begin           
 select b.fld_request,a.* from #temp a inner join tbl_request_master b on a.Fld_request_id=b.Fld_srno    
  where a.Fld_request_id = @Req_ID      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Mail_MIS_HR
-- --------------------------------------------------
CREATE Proc USP_HR_Mail_MIS_HR              
(                      
@fdate as varchar(11),                      
@tdate as varchar(11),                      
@Req_ID as char(5)                      
)                      
as                      
 /*declare @fdate as varchar(11),@tdate as varchar(11),@Req_ID as char(5)                   
set @fdate='02/07/2008'      
set @tdate='02/07/2008'      
set @Req_ID='2'*/      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))             
            
            
select a.*,Completed=isnull(b.Completed,'0'),Pending=isnull(c.Pending,'0'),delayed=isnull(d.delayed,'0') into #temp from             
(select Fld_request_id,Total = count(*)  from tbl_hr_complaint_master_New (nolock) where Fld_complaint_date >= @fdate            
and Fld_complaint_date <= @tdate+' 23:59:59' group by Fld_request_id)a            
left outer join            
(select Fld_request_id,count(*) as Completed  from tbl_hr_complaint_master_New (nolock) where Fld_complaint_date >= @fdate            
and Fld_complaint_date <= @tdate+' 23:59:59' and fld_status = 'c' group by Fld_request_id)b            
on a.Fld_request_id = b.Fld_request_id            
left outer join            
(select Fld_request_id,count(*) as Pending from tbl_hr_complaint_master_New (nolock) where datediff(hh,Fld_complaint_date,getdate()) <= 24   
and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and fld_status = 'P' group by Fld_request_id)c            
on a.Fld_request_id = c.Fld_request_id            
left outer join            
(select Fld_request_id,count(*) as  delayed from tbl_hr_complaint_master_New (nolock) where Fld_Status = 'P' and                       
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and             
Fld_complaint_date <= @tdate+' 23:59:59' group by Fld_request_id)d            
on a.Fld_request_id = d.Fld_request_id            
            
if @Req_ID = '%%'            
begin            
 select b.fldsubcatid,a.* from #temp a inner join tbl_hr_subcatmaster b on a.Fld_request_id=b.fldsubcatid      
    order by a.Fld_request_id        
end            
else            
begin             
 select b.fldsubcatid,a.* from #temp a inner join tbl_hr_subcatmaster b on a.Fld_request_id=b.fldsubcatid      
  where a.Fld_request_id = @Req_ID        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Mail_MIS_New
-- --------------------------------------------------
CREATE Proc USP_HR_Mail_MIS_New              
(                      
@fdate as varchar(11),                      
@tdate as varchar(11),                      
@Req_ID as char(5)                      
)                      
as                      
 /*declare @fdate as varchar(11),@tdate as varchar(11),@Req_ID as char(5)                   
set @fdate='02/07/2008'      
set @tdate='02/07/2008'      
set @Req_ID='2'*/      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))             
            
            
select a.*,Completed=isnull(b.Completed,'0'),Pending=isnull(c.Pending,'0'),delayed=isnull(d.delayed,'0'),CompletedDelayed=isnull(e.CompletedDelayed,'0') into #temp from             
(select Fld_request_id,Total = count(*)  from tbl_hr_complaint_master (nolock) where Fld_complaint_date >= @fdate            
and Fld_complaint_date <= @tdate+' 23:59:59' group by Fld_request_id)a            
left outer join            
(select Fld_request_id,count(*) as Completed  from tbl_hr_complaint_master (nolock) where Fld_complaint_date >= @fdate            
and Fld_complaint_date <= @tdate+' 23:59:59' and fld_status = 'c' and datediff(hh,Fld_complaint_date,Fld_Mark_Time) <= 24 group by Fld_request_id)b            
on a.Fld_request_id = b.Fld_request_id            
left outer join            
(select Fld_request_id,count(*) as Pending from tbl_hr_complaint_master (nolock) where datediff(hh,Fld_complaint_date,getdate()) <= 24   
and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and fld_status = 'P' group by Fld_request_id)c            
on a.Fld_request_id = c.Fld_request_id            
left outer join            
(select Fld_request_id,count(*) as  delayed from tbl_hr_complaint_master (nolock) where Fld_Status = 'P' and                       
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and             
Fld_complaint_date <= @tdate+' 23:59:59' group by Fld_request_id)d            
on a.Fld_request_id = d.Fld_request_id
left outer join
(select Fld_request_id,count(*) as  CompletedDelayed from tbl_hr_complaint_master (nolock) where Fld_request_id <> '41' and Fld_Status = 'C' 
and datediff(hh,Fld_complaint_date,Fld_Mark_Time) > 24 and Fld_complaint_date >= @fdate and             
Fld_complaint_date <= @tdate+' 23:59:59' group by Fld_request_id)e              
on a.Fld_request_id = e.Fld_request_id 

           
if @Req_ID = '%%'            
begin            
 select b.fld_request,a.* from #temp a inner join tbl_request_master b on a.Fld_request_id=b.Fld_srno      
    order by a.Fld_request_id        
end            
else            
begin             
 select b.fld_request,a.* from #temp a inner join tbl_request_master b on a.Fld_request_id=b.Fld_srno      
  where a.Fld_request_id = @Req_ID        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hr_mis_CategoryWise
-- --------------------------------------------------
Create proc usp_hr_mis_CategoryWise
(                        
@fdate as varchar(11),                        
@tdate as varchar(11),                        
@Req_ID as char(5),  
@catid as char(5)                      
)                        
                        
as                        
                    
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                    
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))       

/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5),@catid as char(5)          
set @fdate = convert(varchar(11),convert(datetime,'01/10/2009',103))          
set @tdate = convert(varchar(11),convert(datetime,'12/10/2009',103))            
set @Req_ID = '%'  
set @catid = '%' */
select  
case when a.fldcatname is null then b.fldcatname else a.fldcatname end as fldcatname,  
Total = isnull(Total,0),  
Completed = isnull(Completed,0),  
Delayed = isnull(Delayed,0),  
Pending = isnull(Pending,0)   
from   
(
select 
case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,      
Total = isnull(Total,0),  
Completed = isnull(Completed,0) from 
(
select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,
count(*) as Total from V_Mis_RptCategory with (nolock)
where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' 
and convert(char(10),Fld_Request_id) like @Req_ID  and 
convert(char(10),Fldcatid) like @catid group by fldcatname
)a                  
full outer join  
(
select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,
count(*) as Completed from  V_Mis_RptCategory with (nolock)
where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59' 
and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and 
convert(char(10),Fldcatid) like @catid group by fldcatname) b  
on a.fldcatname = b.fldcatname  
)a
full outer join
(
select   
case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,  
Delayed = isnull(Delayed,0),  
Pending = isnull(Pending,0) from  
(
select 
case when fldcatname is null then 'Others' else fldcatname end as fldcatname,
count(*) as  Delayed from V_Mis_RptCategory with (nolock) where Fld_Status = 'P' and                         
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid group by fldcatname)a  
full outer join  
(
select 
case when fldcatname is null then 'Others' else fldcatname end as fldcatname,
count(*) as  Pending from V_Mis_RptCategory with (nolock) where Fld_Status = 'P' and                         
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID  and convert(char(10),Fldcatid) like @catid group by fldcatname)b  
on a.fldcatname = b.fldcatname  
)b
on a.fldcatname = b.fldcatname  where a.fldcatname is not null order by a.fldcatname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_CATEGORYWISE_15122010
-- --------------------------------------------------
CREATE PROCEDURE USP_HR_MIS_CATEGORYWISE_15122010
(                          
	@fdate as varchar(11),                          
	@tdate as varchar(11),                          
	@Req_ID as char(5),    
	@catid as char(5)                        
)                          
                          
as                          
                      
	set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                      
	set @tdate = convert(varchar(11),convert(datetime,@tdate,103))         
	  
	/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5),@catid as char(5)            
	set @fdate = convert(varchar(11),convert(datetime,'01/10/2009',103))            
	set @tdate = convert(varchar(11),convert(datetime,'12/10/2009',103))              
	set @Req_ID = '%'    
	set @catid = '%' */  
	
	select case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,        
	Total = isnull(Total,0),    
	Completed = isnull(Completed,0) 
	into #temp
	from   
	(  
		select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,  
			count(*) as Total 
		from V_Mis_RptCategory with (nolock)  
		where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'   
			and convert(char(10),Fld_Request_id) like @Req_ID  and   
			convert(char(10),Fldcatid) like @catid 
		group by fldcatname  
	)a                    

	full outer join    
	(  
		select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,  
		count(*) as Completed from  V_Mis_RptCategory with (nolock)  
		where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59'   
		and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and   
		convert(char(10),Fldcatid) like @catid group by fldcatname
	) b    
	on a.fldcatname = b.fldcatname    
	
	select case when a.fldcatname is null then b.fldcatname else a.fldcatname end as fldcatname,    
		Total = isnull(Total,0),    
		Completed = isnull(Completed,0),    
		Delayed = isnull(Delayed,0),    
		Pending = isnull(Pending,0)     
	from     
	--(  
	--	select case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,        
	--	Total = isnull(Total,0),    
	--	Completed = isnull(Completed,0) 
	--	from   
	--	(  
	--		select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,  
	--			count(*) as Total 
	--		from V_Mis_RptCategory with (nolock)  
	--		where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'   
	--			and convert(char(10),Fld_Request_id) like @Req_ID  and   
	--			convert(char(10),Fldcatid) like @catid 
	--		group by fldcatname  
	--	)a                    
	
	--	full outer join    
	--	(  
	--		select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,  
	--		count(*) as Completed from  V_Mis_RptCategory with (nolock)  
	--		where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59'   
	--		and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and   
	--		convert(char(10),Fldcatid) like @catid group by fldcatname
	--	) b    
	--	on a.fldcatname = b.fldcatname    
	--)a 
	 
	#temp a
	
	full outer join  
	(  
		select case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,    
			Delayed = isnull(Delayed,0),    
			Pending = isnull(Pending,0) 
		from    
		(  
			select case when fldcatname is null then 'Others' else fldcatname end as fldcatname,  
				count(*) as  Delayed 
			from V_Mis_RptCategory with (nolock) 
			where Fld_Status = 'P' and datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid 
			group by fldcatname
		)a    
		
		full outer join    
		(  
			select case when fldcatname is null then 'Others' else fldcatname end as fldcatname,  
				count(*) as  Pending 
			from V_Mis_RptCategory with (nolock) 
			where Fld_Status = 'P' and datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID  and convert(char(10),Fldcatid) like @catid 
			group by fldcatname
		)b    
		
		on a.fldcatname = b.fldcatname    
	)b  
	
	on a.fldcatname = b.fldcatname  
	where a.fldcatname is not null 
	order by #temp.fldcatname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_CATEGORYWISE_31122010
-- --------------------------------------------------
CREATE PROC USP_HR_MIS_CATEGORYWISE_31122010
(                          
	@FDATE AS VARCHAR(11),                          
	@TDATE AS VARCHAR(11),                          
	@REQ_ID AS CHAR(5),    
	@CATID AS CHAR(5)                        
)                          
                          
AS                          
                      
	SET @FDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103))                      
	SET @TDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))         
	  
	/*DECLARE @FDATE AS VARCHAR(11),@TDATE AS VARCHAR(11), @REQ_ID AS CHAR(5),@CATID AS CHAR(5)            
	SET @FDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,'01/10/2009',103))            
	SET @TDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,'12/10/2009',103))              
	SET @REQ_ID = '%'    
	SET @CATID = '%' */  
	SELECT    
	FLDCATNAME=CASE WHEN A.FLDCATNAME IS NULL THEN B.FLDCATNAME ELSE A.FLDCATNAME END,    
	TOTAL = ISNULL(TOTAL,0),    
	COMPLETED = ISNULL(COMPLETED,0),    
	DELAYED = ISNULL(DELAYED,0),    
	PENDING = ISNULL(PENDING,0)     
	FROM     
	(  
	SELECT   
	CASE WHEN A.FLDCATNAME IS NULL THEN B.FLDCATNAME ELSE B.FLDCATNAME END AS FLDCATNAME,        
	TOTAL = ISNULL(TOTAL,0),    
	COMPLETED = ISNULL(COMPLETED,0) FROM   
	(  
	SELECT CASE WHEN FLDCATNAME  IS NULL THEN 'OTHERS' ELSE FLDCATNAME  END AS FLDCATNAME,  
	COUNT(*) AS TOTAL FROM V_MIS_RPTCATEGORY WITH (NOLOCK)  
	WHERE FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59'   
	AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID  AND   
	CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDCATNAME  
	)A                    
	FULL OUTER JOIN    
	(  
	SELECT CASE WHEN FLDCATNAME  IS NULL THEN 'OTHERS' ELSE FLDCATNAME  END AS FLDCATNAME,  
	COUNT(*) AS COMPLETED FROM  V_MIS_RPTCATEGORY WITH (NOLOCK)  
	WHERE FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE<= @TDATE+' 23:59:59'   
	AND FLD_STATUS = 'C' AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID AND   
	CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDCATNAME) B    
	ON A.FLDCATNAME = B.FLDCATNAME    
	)A  
	FULL OUTER JOIN  
	(  
	SELECT     
	CASE WHEN A.FLDCATNAME IS NULL THEN B.FLDCATNAME ELSE B.FLDCATNAME END AS FLDCATNAME,    
	DELAYED = ISNULL(DELAYED,0),    
	PENDING = ISNULL(PENDING,0) FROM    
	(  
	SELECT   
	CASE WHEN FLDCATNAME IS NULL THEN 'OTHERS' ELSE FLDCATNAME END AS FLDCATNAME,  
	COUNT(*) AS  DELAYED FROM V_MIS_RPTCATEGORY WITH (NOLOCK) WHERE FLD_STATUS = 'P' AND                           
	DATEDIFF(HH,FLD_COMPLAINT_DATE,GETDATE()) > 24 AND FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59'AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID AND CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDCATNAME)A    
	FULL OUTER JOIN    
	(  
	SELECT   
	CASE WHEN FLDCATNAME IS NULL THEN 'OTHERS' ELSE FLDCATNAME END AS FLDCATNAME,  
	COUNT(*) AS  PENDING FROM V_MIS_RPTCATEGORY WITH (NOLOCK) WHERE FLD_STATUS = 'P' AND                           
	DATEDIFF(HH,FLD_COMPLAINT_DATE,GETDATE()) <= 24 AND FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59' AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID  AND CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDCATNAME)B    
	ON A.FLDCATNAME = B.FLDCATNAME    
	)B  
	ON A.FLDCATNAME = B.FLDCATNAME  WHERE A.FLDCATNAME IS NOT NULL 
	
	ORDER BY FLDCATNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hr_mis_ReqCategoryWise
-- --------------------------------------------------
Create proc usp_hr_mis_ReqCategoryWise  
(                          
@fdate as varchar(11),                          
@tdate as varchar(11),                          
@Req_ID as char(5),    
@catid as char(5)                        
)                          
                          
as                          
                      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                      
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))         
  
/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5),@catid as char(5)            
set @fdate = convert(varchar(11),convert(datetime,'01/10/2009',103))            
set @tdate = convert(varchar(11),convert(datetime,'12/10/2009',103))              
set @Req_ID = '%'    
set @catid = '%' */  
select    
case when a.fldcatname is null then b.fldcatname else a.fldcatname end as fldcatname,    
case when a.fldsubcatname is null then b.fldsubcatname else a.fldsubcatname end as fldsubcatname,    
Total = isnull(Total,0),    
Completed = isnull(Completed,0),    
Delayed = isnull(Delayed,0),    
Pending = isnull(Pending,0)     
from     
(  

select   
case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname, 
case when a.fldsubcatname is null then b.fldsubcatname else b.fldsubcatname end as fldsubcatname,         
Total = isnull(Total,0),    
Completed = isnull(Completed,0) from   
(  
select 
case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,  
case when fldsubcatname  is null then 'Others' else fldsubcatname  end as fldsubcatname,  
count(*) as Total from V_Mis_RptCategory with (nolock)  
where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'   
and convert(char(10),Fld_Request_id) like @Req_ID  and   
convert(char(10),Fldcatid) like @catid group by fldcatname,fldsubcatname  
)a                    
full outer join    
(  
select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,  
case when fldsubcatname  is null then 'Others' else fldsubcatname  end as fldsubcatname, 
count(*) as Completed from  V_Mis_RptCategory with (nolock)  
where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59'   
and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and   
convert(char(10),Fldcatid) like @catid group by fldcatname,fldsubcatname) b    
on a.fldsubcatname = b.fldsubcatname    
)a  
full outer join  
(  
select     
case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,
case when a.fldsubcatname is null then b.fldsubcatname else b.fldsubcatname end as fldsubcatname,     
Delayed = isnull(Delayed,0),    
Pending = isnull(Pending,0) from    
(  
select   
case when fldcatname is null then 'Others' else fldcatname end as fldcatname,
case when fldsubcatname is null then 'Others' else fldsubcatname end as fldsubcatname,   
count(*) as  Delayed from V_Mis_RptCategory with (nolock) where Fld_Status = 'P' and                           
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid group by fldsubcatname,fldcatname)a    
full outer join    
(  
select   
case when fldcatname is null then 'Others' else fldcatname end as fldcatname,  
case when fldsubcatname is null then 'Others' else fldsubcatname end as fldsubcatname, 
count(*) as  Pending from V_Mis_RptCategory with (nolock) where Fld_Status = 'P' and                           
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID  and convert(char(10),Fldcatid) like @catid group by fldcatname,fldsubcatname)b    
on a.fldsubcatname = b.fldsubcatname    
)b  
on a.fldsubcatname = b.fldsubcatname  where a.fldsubcatname is not null order by a.fldsubcatname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_REQCATEGORYWISE_15122010
-- --------------------------------------------------
CREATE PROC USP_HR_MIS_REQCATEGORYWISE_15122010
(                            
	@fdate as varchar(11),                            
	@tdate as varchar(11),                            
	@Req_ID as char(5),      
	@catid as char(5)                          
)                            
                            
as                            
	set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                        
	set @tdate = convert(varchar(11),convert(datetime,@tdate,103))           
	    
	/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5),@catid as char(5)              
	set @fdate = convert(varchar(11),convert(datetime,'01/10/2009',103))              
	set @tdate = convert(varchar(11),convert(datetime,'12/10/2009',103))                
	set @Req_ID = '%'      
	set @catid = '%' */    
	
	-- CODE ADDED ON 15-12-2010
	
	select case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,   
		case when a.fldsubcatname is null then b.fldsubcatname else b.fldsubcatname end as fldsubcatname,           
		Total = isnull(Total,0),      
		Completed = isnull(Completed,0) 
	INTO #TEMP
	from     
	(    
		select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,    
			case when fldsubcatname  is null then 'Others' else fldsubcatname  end as fldsubcatname,    
			count(*) as Total 
		from V_Mis_RptCategory with (nolock)    
		where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'     
			and convert(char(10),Fld_Request_id) like @Req_ID  and     
			convert(char(10),Fldcatid) like @catid 
		group by fldcatname,fldsubcatname    
	)a
	                      
	full outer join      
	(    
		select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,    
			case when fldsubcatname  is null then 'Others' else fldsubcatname  end as fldsubcatname,   
			count(*) as Completed 
		from V_Mis_RptCategory with (nolock)    
		where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59'     
			and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and     
			convert(char(10),Fldcatid) like @catid 
		group by fldcatname,fldsubcatname
	) b      
	on a.fldsubcatname = b.fldsubcatname      
	
	---- END 

	select case when a.fldcatname is null then b.fldcatname else a.fldcatname end as fldcatname,      
		case when a.fldsubcatname is null then b.fldsubcatname else a.fldsubcatname end as fldsubcatname,      
		Total = isnull(Total,0),      
		Completed = isnull(Completed,0),      
		Delayed = isnull(Delayed,0),      
		Pending = isnull(Pending,0)       
	from       
	--(    
		--select case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,   
		--	case when a.fldsubcatname is null then b.fldsubcatname else b.fldsubcatname end as fldsubcatname,           
		--	Total = isnull(Total,0),      
		--	Completed = isnull(Completed,0) 
		--from     
		--(    
		--	select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,    
		--		case when fldsubcatname  is null then 'Others' else fldsubcatname  end as fldsubcatname,    
		--		count(*) as Total 
		--	from V_Mis_RptCategory with (nolock)    
		--	where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'     
		--		and convert(char(10),Fld_Request_id) like @Req_ID  and     
		--		convert(char(10),Fldcatid) like @catid 
		--	group by fldcatname,fldsubcatname    
		--)a
		                      
		--full outer join      
		--(    
		--	select case when fldcatname  is null then 'Others' else fldcatname  end as fldcatname,    
		--		case when fldsubcatname  is null then 'Others' else fldsubcatname  end as fldsubcatname,   
		--		count(*) as Completed 
		--	from V_Mis_RptCategory with (nolock)    
		--	where Fld_complaint_date >= @fdate and Fld_complaint_date<= @tdate+' 23:59:59'     
		--		and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and     
		--		convert(char(10),Fldcatid) like @catid 
		--	group by fldcatname,fldsubcatname
		--) b      
		--on a.fldsubcatname = b.fldsubcatname      
	--)a    
	
	#TEMP a
		
	full outer join    
	(    
		select case when a.fldcatname is null then b.fldcatname else b.fldcatname end as fldcatname,  
			case when a.fldsubcatname is null then b.fldsubcatname else b.fldsubcatname end as fldsubcatname,       
			Delayed = isnull(Delayed,0),      
			Pending = isnull(Pending,0) 
		from      
		(    
			select case when fldcatname is null then 'Others' else fldcatname end as fldcatname,  
				case when fldsubcatname is null then 'Others' else fldsubcatname end as fldsubcatname,     
				count(*) as  Delayed 
			from V_Mis_RptCategory with (nolock) 
			where Fld_Status = 'P' and datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid 
			group by fldsubcatname,fldcatname
		)a   
			   
		full outer join      
		(    
			select case when fldcatname is null then 'Others' else fldcatname end as fldcatname,    
				case when fldsubcatname is null then 'Others' else fldsubcatname end as fldsubcatname,   
				count(*) as  Pending 
			from V_Mis_RptCategory with (nolock) 
			where Fld_Status = 'P' and                             
				datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID  and convert(char(10),Fldcatid) like @catid 
			group by fldcatname,fldsubcatname
		)b 
		
		on a.fldsubcatname = b.fldsubcatname      
	
	)b    
	
	on a.fldsubcatname = b.fldsubcatname  
	where a.fldsubcatname is not null 
	order by #temp.fldsubcatname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_REQCATEGORYWISE_31122010
-- --------------------------------------------------
CREATE PROC USP_HR_MIS_REQCATEGORYWISE_31122010
(                            
	@FDATE AS VARCHAR(11),                            
	@TDATE AS VARCHAR(11),                            
	@REQ_ID AS CHAR(5),      
	@CATID AS CHAR(5)                          
)                            
                            
AS                            
                        
	SET @FDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@FDATE,103))                        
	SET @TDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@TDATE,103))           
	    
	/*DECLARE @FDATE AS VARCHAR(11),@TDATE AS VARCHAR(11), @REQ_ID AS CHAR(5),@CATID AS CHAR(5)              
	SET @FDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,'01/10/2009',103))              
	SET @TDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,'12/10/2009',103))                
	SET @REQ_ID = '%'      
	SET @CATID = '%' */    
	
	SELECT  CASE WHEN A.FLDCATNAME IS NULL THEN B.FLDCATNAME ELSE A.FLDCATNAME END AS FLDCATNAME,      
		FLDSUBCATNAME = CASE WHEN A.FLDSUBCATNAME IS NULL THEN B.FLDSUBCATNAME ELSE A.FLDSUBCATNAME END,      
		TOTAL = ISNULL(TOTAL,0),      
		COMPLETED = ISNULL(COMPLETED,0),      
		DELAYED = ISNULL(DELAYED,0),      
		PENDING = ISNULL(PENDING,0)       
	FROM       
	(    
	  
		SELECT CASE WHEN A.FLDCATNAME IS NULL THEN B.FLDCATNAME ELSE B.FLDCATNAME END AS FLDCATNAME,   
			FLDSUBCATNAME = CASE WHEN A.FLDSUBCATNAME IS NULL THEN B.FLDSUBCATNAME ELSE B.FLDSUBCATNAME END,           
			TOTAL = ISNULL(TOTAL,0),      
			COMPLETED = ISNULL(COMPLETED,0) FROM     
			(    
			SELECT   
			CASE WHEN FLDCATNAME  IS NULL THEN 'OTHERS' ELSE FLDCATNAME  END AS FLDCATNAME,    
			CASE WHEN FLDSUBCATNAME  IS NULL THEN 'OTHERS' ELSE FLDSUBCATNAME  END AS FLDSUBCATNAME,    
			COUNT(*) AS TOTAL FROM V_MIS_RPTCATEGORY WITH (NOLOCK)    
			WHERE FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59'     
			AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID  AND     
			CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDCATNAME,FLDSUBCATNAME    
			)A                      
		
			FULL OUTER JOIN      
			(    
				SELECT CASE WHEN FLDCATNAME  IS NULL THEN 'OTHERS' ELSE FLDCATNAME  END AS FLDCATNAME,    
				CASE WHEN FLDSUBCATNAME  IS NULL THEN 'OTHERS' ELSE FLDSUBCATNAME  END AS FLDSUBCATNAME,   
				COUNT(*) AS COMPLETED FROM  V_MIS_RPTCATEGORY WITH (NOLOCK)    
				WHERE FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE<= @TDATE+' 23:59:59'     
				AND FLD_STATUS = 'C' AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID AND     
				CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDCATNAME,FLDSUBCATNAME) B      
				ON A.FLDSUBCATNAME = B.FLDSUBCATNAME      
			)A    
			
			FULL OUTER JOIN    
			(    
				SELECT       
					CASE WHEN A.FLDCATNAME IS NULL THEN B.FLDCATNAME ELSE B.FLDCATNAME END AS FLDCATNAME,  
					CASE WHEN A.FLDSUBCATNAME IS NULL THEN B.FLDSUBCATNAME ELSE B.FLDSUBCATNAME END AS FLDSUBCATNAME,       
					DELAYED = ISNULL(DELAYED,0),      
					PENDING = ISNULL(PENDING,0) 
				FROM      
				(    
					SELECT     
					CASE WHEN FLDCATNAME IS NULL THEN 'OTHERS' ELSE FLDCATNAME END AS FLDCATNAME,  
					CASE WHEN FLDSUBCATNAME IS NULL THEN 'OTHERS' ELSE FLDSUBCATNAME END AS FLDSUBCATNAME,     
					COUNT(*) AS  DELAYED FROM V_MIS_RPTCATEGORY WITH (NOLOCK) WHERE FLD_STATUS = 'P' AND                             
					DATEDIFF(HH,FLD_COMPLAINT_DATE,GETDATE()) > 24 AND FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59'AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID AND CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDSUBCATNAME,FLDCATNAME
				)A   
					   
				FULL OUTER JOIN      
				(    
					SELECT     
					CASE WHEN FLDCATNAME IS NULL THEN 'OTHERS' ELSE FLDCATNAME END AS FLDCATNAME,    
					CASE WHEN FLDSUBCATNAME IS NULL THEN 'OTHERS' ELSE FLDSUBCATNAME END AS FLDSUBCATNAME,   
					COUNT(*) AS  PENDING FROM V_MIS_RPTCATEGORY WITH (NOLOCK) WHERE FLD_STATUS = 'P' AND                             
					DATEDIFF(HH,FLD_COMPLAINT_DATE,GETDATE()) <= 24 AND FLD_COMPLAINT_DATE >= @FDATE AND FLD_COMPLAINT_DATE <= @TDATE+' 23:59:59' AND CONVERT(CHAR(10),FLD_REQUEST_ID) LIKE @REQ_ID  AND CONVERT(CHAR(10),FLDCATID) LIKE @CATID GROUP BY FLDCATNAME,FLDSUBCATNAME
				)B ON A.FLDSUBCATNAME = B.FLDSUBCATNAME      
			)B  ON A.FLDSUBCATNAME = B.FLDSUBCATNAME  
			
	WHERE A.FLDSUBCATNAME IS NOT NULL 
	ORDER BY FLDSUBCATNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_Rpt
-- --------------------------------------------------
CREATE Proc USP_HR_MIS_Rpt                        
(@From_date varchar(11),@To_date varchar(11),@Status varchar(15),@Fld_EmpCode as varchar(15))                        
as                        
                        
/*                
Declare @From_date varchar(11)                
Declare @To_date varchar(11)                
Declare @Status varchar(15)                
Declare @Fld_EmpCode as varchar(15)                
                
                
set @From_date = '01/04/2008'                
set @To_date = '09/04/2008'                
set @Status = 'P'                
set @Fld_EmpCode = 'E02031'                
*/                
                    
                    
Declare @str  as varchar(5000)                        
                        
--set  @str = 'select * from                        
--(select * from Tbl_HR_Complaint_Master where                         
--fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59''                        
--and Fld_Status like  '''+@Status+''') x  inner join (select Emp_no,Emp_Name,emailadd from                         
--hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                        
                      
set @From_date = convert(varchar(11),convert(datetime,@From_date,103))                      
set @To_date = convert(varchar(11),convert(datetime,@To_date,103))                       
                        
                        
/*                        
set @str = 'select x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (select x.*,y.Fld_Request from                         
(select x.*,y.Fld_Request from                         
(select * from Tbl_HR_Complaint_Master (nolock) where fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''') x                        
inner join (select x.Fld_Srno,y.Fld_Request from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                
inner join(select * from Tbl_Request_Master (nolock)) y on x.Fld_SrNo = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) x                        
inner join (select Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                        
*/                
                
set @str = 'select distinct x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (                
select x.*,y.Fld_Request from (select * from Tbl_HR_Complaint_Master (nolock) where Fld_status <> ''D'' and        
fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''' and fld_request_id not in (''4'',''3'',''5'',''34'',''41'',''40'',''35'',''36'',''37'',''38'',''39'')) x                
  
        
inner join (select x.Fld_Srno,y.Fld_Request from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                
inner join(select * from Tbl_Request_Master (nolock)) y on x.Fld_SrNo = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) x                        
inner join (select [Emp No] Emp_no,Emp_Name,emailadd from [MIDDLEWARE].harmony.dbo.vlmsinhouse) y on x.Fld_Emp_Code = y.Emp_no order by fld_complaint_date'                
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_Rpt_NEw
-- --------------------------------------------------
CREATE Proc USP_HR_MIS_Rpt_New                                          
(    
@From_date varchar(11),    
@To_date varchar(11),@Status varchar(15),    
@Fld_EmpCode as varchar(15))                                          
as                                          
                                          
/*                                  
Declare @From_date varchar(11)                                  
Declare @To_date varchar(11)                                  
Declare @Status varchar(15)                                  
Declare @Fld_EmpCode as varchar(15)                                  
                                  
                                  
set @From_date = '01/04/2008'                                  
set @To_date = '09/04/2008'                                  
set @Status = 'P'                                  
set @Fld_EmpCode = 'E02031'                                  
*/                                  
                                      
                                      
--Declare @str  as varchar(5000)                                          
                                          
--set  @str = 'select * from                                          
--(select * from Tbl_HR_Complaint_Master where                                           
--fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59''                                          
--and Fld_Status like  '''+@Status+''') x  inner join (select Emp_no,Emp_Name,emailadd from                                           
--hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                          
    
                                          
/*                                          
select x.* ,case when x.Fld_Status = 'C' then 'CLOSED' else 'OPEN' end as status,y.fldsubcatid,y.fldsubcatname,        
z.fldsubjectid,z.fldsubjectname,w.emp_no,w.emp_name,w.emailadd from         
(        
select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> 'D' and                          
fld_complaint_date >= @From_date and fld_complaint_date <= @To_date+' 23:59:59' and         
Fld_Status like  @Status  and fld_request_id not in ('4','5','7','8','11','13','15','16','17','19')        
)x        
left outer join        
(select * from tbl_hr_subcatmaster (nolock))y        
on x.fld_request_id = y.fldsubcatid        
left outer join        
(select * from tbl_hr_subjectmaster (nolock))z        
on x.fld_subject  = z.fldsubjectid        
left outer join        
(select [Emp No] Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.Vlms)w        
on  x.Fld_Emp_Code = w.Emp_no        
left outer join        
(select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like @Fld_EmpCode)v        
on y.fldsubcatid  = v.Fld_Srno order by x.fld_complaint_date    
--print(@str) ('1','4','7','8','9','11','13','15','16','17','19') */       
    
    
                                        
set @From_date = convert(varchar(11),convert(datetime,@From_date,103))                                        
set @To_date = convert(varchar(11),convert(datetime,@To_date,103))                                         
                                          
select x.* ,case when x.Fld_Status = 'C' then 'CLOSED' else 'OPEN' end as status,y.fldsubcatid,y.fldsubcatname,        
z.fldsubjectid,z.fldsubjectname,w.emp_no,w.emp_name,w.emailadd from         
(        
select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> 'D' and                          
fld_complaint_date >= @From_date and fld_complaint_date <= @To_date+' 23:59:59' and         
Fld_Status like  @Status  and fld_request_id not in ('4','5','7','8','11','13','15','16','17','19')        
)x        
left outer join        
(select * from tbl_hr_subcatmaster (nolock))y        
on x.fld_request_id = y.fldsubcatid        
left outer join        
(select * from tbl_hr_subjectmaster (nolock))z        
on x.fld_subject  = z.fldsubjectid        
left outer join     
(select [Emp No] Emp_no,Emp_Name,emailadd from [MIDDLEWARE].harmony.dbo.vlmsinhouse)w        
on  x.Fld_Emp_Code = w.Emp_no        
left outer join      (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like @Fld_EmpCode)v        
on y.fldsubcatid  = v.Fld_Srno order by x.fld_complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_Rpt_New1
-- --------------------------------------------------
--USP_HR_MIS_Rpt_New1 '02/04/2013','03/04/2013','%','t00153'  
--select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like 't00153'  
CREATE Proc USP_HR_MIS_Rpt_New1                                              
(@From_date varchar(11),@To_date varchar(11),@Status varchar(100),@Fld_EmpCode as varchar(15))                                              
as                                              
                                              
/*                                      
Declare @From_date varchar(11)                                      
Declare @To_date varchar(11)                                      
Declare @Status varchar(100)                                      
Declare @Fld_EmpCode as varchar(15)                                      
                                      
                                      
set @From_date = '18/08/2009'                                      
set @To_date = '20/08/2009'                                        
set @Status = 'P'                                      
set @Fld_EmpCode = 'E02031'  */                                    
                                          
                                          
--Declare @str  as varchar(5000)                                              
                                              
--set  @str = 'select * from                                              
--(select * from Tbl_HR_Complaint_Master where                                               
--fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59''                                              
--and Fld_Status like  '''+@Status+''') x  inner join (select Emp_no,Emp_Name,emailadd from                                               
--hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                              
         
        
        
set @From_date = convert(varchar(11),convert(datetime,@From_date,103))                                            
set @To_date = convert(varchar(11),convert(datetime,@To_date,103))        
        
set @Status = case when @Status = 'P' then 'Fld_status in (''P'',''H'')' else 'Fld_status like '''+ @Status +'''' end         
        
declare @str as varchar(2000)        
        
     
        
set @str = 'select [Emp No] Emp_no,Emp_Name,emailadd into #vlms from [MIDDLEWARE].harmony.dbo.vlmsinhouse;  
select x.* ,case when x.Fld_Status IN (''P'',''H'') then ''OPEN'' else ''CLOSED'' end as status,y.fldsubcatid,y.fldsubcatname,            
z.fldsubjectid,z.fldsubjectname,w.emp_no,w.emp_name,w.emailadd from             
(            
select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> ''D'' and                              
fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+' 23:59:59''  and  '+@Status+'        
and fld_request_id not in (''4'',''5'',''7'',''8'',''11'',''13'',''15'',''16'',''17'',''19'')            
)x            
left outer join            
(select * from tbl_hr_subcatmaster (nolock))y            
on x.fld_request_id = y.fldsubcatid            
left outer join            
(select * from tbl_hr_subjectmaster (nolock))z            
on x.fld_subject  = z.fldsubjectid            
left outer join            
(select Emp_no,Emp_Name,emailadd from #Vlms)w            
on  x.Fld_Emp_Code = w.Emp_no            
left outer join            
(select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like '''+@Fld_EmpCode+''')v            
on y.fldsubcatid  = v.Fld_Srno order by x.fld_complaint_date'        
        
--print @str        
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_Rpt_payroll
-- --------------------------------------------------
CREATE Proc USP_HR_MIS_Rpt_payroll                            
(@From_date varchar(11),@To_date varchar(11),@Status varchar(15),@Fld_EmpCode as varchar(15))                            
as                            
                            
/*                    
Declare @From_date varchar(11)                    
Declare @To_date varchar(11)                    
Declare @Status varchar(15)                    
Declare @Fld_EmpCode as varchar(15)                    
                    
                    
set @From_date = '01/04/2008'                    
set @To_date = '09/04/2008'                    
set @Status = 'P'                    
set @Fld_EmpCode = 'E02031'                    
*/                    
                        
                        
Declare @str  as varchar(5000)                            
                            
--set  @str = 'select * from                            
--(select * from Tbl_HR_Complaint_Master where                             
--fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59''                            
--and Fld_Status like  '''+@Status+''') x  inner join (select Emp_no,Emp_Name,emailadd from                             
--hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                            
                          
set @From_date = convert(datetime,convert(varchar(11),convert(datetime,@From_date,103)),103)                          
set @To_date = convert(datetime,convert(varchar(11),convert(datetime,@To_date,103)),103)                           
                            
                            
/*                            
set @str = 'select x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (select x.*,y.Fld_Request from                             
(select x.*,y.Fld_Request from                             
(select * from Tbl_HR_Complaint_Master (nolock) where fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''') x                            
inner join (select x.Fld_Srno,y.Fld_Request from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                    
inner join(select * from Tbl_Request_Master (nolock)) y on x.Fld_SrNo = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) x                            
inner join (select Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                            
*/                    
                    
set @str = 'select distinct x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (                    
select x.*,y.Fld_Request from (select * from Tbl_HR_Complaint_Master (nolock) where Fld_status <> ''D'' and            
fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''' and fld_request_id in (''4'',''3'',''5'',''34'',''41'',''40'',''35'',''36'',''37'',''38'',''39'')) x                    
  
    
      
        
left outer join(select x.Fld_Srno,y.Fld_Request from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                    
left outer join(select * from Tbl_Request_Master (nolock)) y on x.Fld_SrNo = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) x                            
left outer join (select [Emp No] Emp_no,Emp_Name,emailadd from [MIDDLEWARE].harmony.dbo.vlmsinhouse) y on x.Fld_Emp_Code = y.Emp_no order by fld_complaint_date'                    
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_Rpt_payroll_New
-- --------------------------------------------------
CREATE Proc USP_HR_MIS_Rpt_payroll_New                                          
(@From_date varchar(11),@To_date varchar(11),@Status varchar(15),@Fld_EmpCode as varchar(15))                                          
as                                          
                                          
/*                                  
Declare @From_date varchar(11)                                  
Declare @To_date varchar(11)                                  
Declare @Status varchar(15)                                  
Declare @Fld_EmpCode as varchar(15)                                  
                                  
                                  
set @From_date = '01/04/2008'                                  
set @To_date = '09/04/2008'                                  
set @Status = 'P'                                  
set @Fld_EmpCode = 'E02031'                                  
*/                                  
                                      
                                      
--Declare @str  as varchar(5000)                                          
                                          
--set  @str = 'select * from                                          
--(select * from Tbl_HR_Complaint_Master where                                           
--fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59''                                          
--and Fld_Status like  '''+@Status+''') x  inner join (select Emp_no,Emp_Name,emailadd from                                           
--hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                          
                                        
set @From_date = convert(datetime,convert(varchar(11),convert(datetime,@From_date,103)),103)                                        
set @To_date = convert(datetime,convert(varchar(11),convert(datetime,@To_date,103)),103)                                         
                                          
                                          
/*                                          
set @str = 'select x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (select x.*,y.Fld_Request from                                           
(select x.*,y.Fld_Request from                                           
(select * from Tbl_HR_Complaint_Master (nolock) where fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''') x                                          
inner join (select x.Fld_Srno,y.Fld_Request from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                                  
inner join(select * from Tbl_Request_Master (nolock)) y on x.Fld_SrNo = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) x                                          
inner join (select Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                          
*/                                  
                                  
/*set @str = 'select distinct x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (                                  
select x.*,y.fldsubcatname,y.fldsubjectname,y.fldssid,y.fldsubjectid,y.fldsubcatid  from (select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> ''D'' and                          
fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''' and fld_request_id in (''1'',''4'',''7'',''8'',''9'',''11'',''13'',''15'',''16'',''17'',''19'')) x                      
  
    
      
        
left outer join(select x.Fld_Srno,y.fldsubcatname,y.fldsubjectname,y.fldssid,y.fldsubjectid,y.fldsubcatid from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                                  
left outer join(select * from V_HrSubjectSolution (nolock)) y on x.Fld_SrNo = y.fldsubcatid) y on x.Fld_subject = y.fldsubjectid) x                                          
left outer join (select [Emp No] Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.Vlms) y on x.Fld_Emp_Code = y.Emp_no order by fld_complaint_date'                                  
exec(@str) '1','4','7','8','9','11','13','15','16','17','19'  */      
      
      
select x.* ,case when x.Fld_Status = 'C' then 'CLOSED' else 'OPEN' end as status,y.fldsubcatid,y.fldsubcatname,      
z.fldsubjectid,z.fldsubjectname,w.emp_no,w.emp_name,w.emailadd from       
(      
select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> 'D' and                        
fld_complaint_date >= @From_date and fld_complaint_date <= @To_date+' 23:59:59' and       
Fld_Status like  @Status  and fld_request_id  in ('4','5','7','8','11','13','15','16','17','19')      
)x      
left outer join      
(select * from tbl_hr_subcatmaster (nolock))y      
on x.fld_request_id = y.fldsubcatid      
left outer join      
(select * from tbl_hr_subjectmaster (nolock))z      
on x.fld_subject  = z.fldsubjectid      
left outer join      
(select [Emp No] Emp_no,Emp_Name,emailadd from [MIDDLEWARE].harmony.dbo.vlmsinhouse)w      
on  x.Fld_Emp_Code = w.Emp_no      
left outer join      
(select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like @Fld_EmpCode)v      
on y.fldsubcatid  = v.Fld_Srno order by x.fld_complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_Rpt_payroll_New1
-- --------------------------------------------------
CREATE Proc USP_HR_MIS_Rpt_payroll_New1                                               
(@From_date varchar(11),@To_date varchar(11),@Status varchar(150),@Fld_EmpCode as varchar(15))                                                
as                                                
                                                
/*                                        
Declare @From_date varchar(11)                                        
Declare @To_date varchar(11)                                        
Declare @Status varchar(15)                                        
Declare @Fld_EmpCode as varchar(15)                                        
                                        
                                        
set @From_date = '01/04/2008'                                        
set @To_date = '09/04/2008'                                        
set @Status = 'P'                                        
set @Fld_EmpCode = 'E02031'                                        
*/                                        
                                            
                                            
--Declare @str  as varchar(5000)                                                
                                                
--set  @str = 'select * from                                                
--(select * from Tbl_HR_Complaint_Master where                                                 
--fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59''                                                
--and Fld_Status like  '''+@Status+''') x  inner join (select Emp_no,Emp_Name,emailadd from                                                 
--hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                                
                                              
set @From_date = convert(datetime,convert(varchar(11),convert(datetime,@From_date,103)),103)                                              
set @To_date = convert(datetime,convert(varchar(11),convert(datetime,@To_date,103)),103)                                               
set @Status = case when @Status = 'P' then 'Fld_status in (''P'',''H'')' else 'Fld_status like '''+ @Status +'''' end                                                 
                                                
/*                                                
set @str = 'select x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (select x.*,y.Fld_Request from                                                 
(select x.*,y.Fld_Request from                                                 
(select * from Tbl_HR_Complaint_Master (nolock) where fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''') x                                                
inner join (select x.Fld_Srno,y.Fld_Request from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                                        
inner join(select * from Tbl_Request_Master (nolock)) y on x.Fld_SrNo = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) x                                                
inner join (select Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                                
*/                                        
                                        
/*set @str = 'select distinct x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (                                        
select x.*,y.fldsubcatname,y.fldsubjectname,y.fldssid,y.fldsubjectid,y.fldsubcatid  from (select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> ''D'' and                                
fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''' and fld_request_id in (''1'',''4'',''7'',''8'',''9'',''11'',''13'',''15'',''16'',''17'',''19'')) x                      
  
    
      
        
          
            
              
left outer join(select x.Fld_Srno,y.fldsubcatname,y.fldsubjectname,y.fldssid,y.fldsubjectid,y.fldsubcatid from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                                        
left outer join(select * from V_HrSubjectSolution (nolock)) y on x.Fld_SrNo = y.fldsubcatid) y on x.Fld_subject = y.fldsubjectid) x                                                
left outer join (select [Emp No] Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.Vlms) y on x.Fld_Emp_Code = y.Emp_no order by fld_complaint_date'                                        
exec(@str) '1','4','7','8','9','11','13','15','16','17','19'  */            
/*        
        
select x.* ,case when x.Fld_Status = 'C' then 'CLOSED' else 'OPEN' end as status,y.fldsubcatid,y.fldsubcatname,            
z.fldsubjectid,z.fldsubjectname,w.emp_no,w.emp_name,w.emailadd from             
(            
select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> 'D' and                              
fld_complaint_date >= @From_date and fld_complaint_date <= @To_date+' 23:59:59' and             
Fld_Status like  @Status  and fld_request_id  in ('4','5','7','8','11','13','15','16','17','19')            
)x            
left outer join            
(select * from tbl_hr_subcatmaster (nolock))y            
on x.fld_request_id = y.fldsubcatid            
left outer join            
(select * from tbl_hr_subjectmaster (nolock))z            
on x.fld_subject  = z.fldsubjectid            
left outer join            
(select [Emp No] Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.Vlms)w            
on  x.Fld_Emp_Code = w.Emp_no            
left outer join            
(select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like @Fld_EmpCode)v            
on y.fldsubcatid  = v.Fld_Srno order by x.fld_complaint_date         
        
*/            
            
           
/*select [Emp No] Emp_no,Emp_Name,emailadd into #vlms from hrsoft.angelbroking.dbo.Vlms  */    
declare @str as varchar(2000)          
          
set @str = 'select [Emp No] Emp_no,Emp_Name,emailadd into #vlms from [MIDDLEWARE].harmony.dbo.vlmsinhouse select x.* ,case when x.Fld_Status IN (''P'',''H'') then ''OPEN'' else ''CLOSED'' end as status,y.fldsubcatid,y.fldsubcatname,              
z.fldsubjectid,z.fldsubjectname,w.emp_no,w.emp_name,w.emailadd from               
(              
select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> ''D'' and                                
fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+' 23:59:59''  and  '+@Status+'          
and fld_request_id  in (''4'',''5'',''7'',''8'',''11'',''13'',''15'',''16'',''17'',''19'')              
)x              
left outer join              
(select * from tbl_hr_subcatmaster (nolock))y              
on x.fld_request_id = y.fldsubcatid              
left outer join              
(select * from tbl_hr_subjectmaster (nolock))z              
on x.fld_subject  = z.fldsubjectid              
left outer join              
(select  Emp_no,Emp_Name,emailadd from #vlms)w              
on  x.Fld_Emp_Code = w.Emp_no              
left outer join              
(select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like '''+@Fld_EmpCode+''')v              
on y.fldsubcatid  = v.Fld_Srno order by x.fld_complaint_date'          
          
--print @str          
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_MIS_Rpt_WIP
-- --------------------------------------------------
CREATE Proc USP_HR_MIS_Rpt_WIP                                            
(@From_date varchar(11),@To_date varchar(11),@Status varchar(15),@Fld_EmpCode as varchar(15))                                            
as                                            
                                            
/*                                    
Declare @From_date varchar(11)                                    
Declare @To_date varchar(11)                                    
Declare @Status varchar(15)                                    
Declare @Fld_EmpCode as varchar(15)                                    
                                    
                                    
set @From_date = '01/04/2008'                                    
set @To_date = '09/04/2008'                                    
set @Status = 'P'                                    
set @Fld_EmpCode = 'E02031'                                    
*/                                    
                                        
                                        
--Declare @str  as varchar(5000)                                            
                                            
--set  @str = 'select * from                                            
--(select * from Tbl_HR_Complaint_Master where                                             
--fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59''                                            
--and Fld_Status like  '''+@Status+''') x  inner join (select Emp_no,Emp_Name,emailadd from                                             
--hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                            
                                          
set @From_date = convert(varchar(11),convert(datetime,@From_date,103))                                          
set @To_date = convert(varchar(11),convert(datetime,@To_date,103))                                           
                                            
                                            
/*                                            
set @str = 'select x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (select x.*,y.Fld_Request from                                             
(select x.*,y.Fld_Request from                                             
(select * from Tbl_HR_Complaint_Master (nolock) where fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''') x                                            
inner join (select x.Fld_Srno,y.Fld_Request from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                                    
inner join(select * from Tbl_Request_Master (nolock)) y on x.Fld_SrNo = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) y on x.Fld_Request_id = y.Fld_SrNo) x                                            
inner join (select Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.emplmst) y on x.Fld_Emp_Code = y.Emp_no'                                            
*/                                    
                                    
/*set @str = 'select distinct x.*,y.Emp_Name,y.emailadd,case when x.Fld_Status = ''C'' then ''CLOSED'' else ''OPEN'' end as status from (                                    
select x.*,y.fldsubcatname,y.fldsubjectname,y.fldssid,y.fldsubjectid,y.fldsubcatid from (select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> ''D'' and                            
fld_complaint_date >= '''+@From_date+''' and fld_complaint_date <= '''+@To_date+'''+'' 23:59:59'' and Fld_Status like  '''+@Status+''' and fld_request_id not in (''1'',''4'',''7'',''8'',''9'',''11'',''13'',''15'',''16'',''17'',''19'')) x                  
  
    
      
        
          
            
              
                
                    
inner join (select x.Fld_Srno,y.fldsubcatname,y.fldsubjectname,y.fldssid,y.fldsubjectid,y.fldsubcatid from (select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like ''%'+@Fld_EmpCode+'%'') x                                    
inner join(select * from V_HrSubjectSolution (nolock)) y on x.Fld_SrNo = y.fldsubcatid) y on x.Fld_subject = y.fldsubjectid) x                                            
inner join (select [Emp No] Emp_no,Emp_Name,emailadd from hrsoft.angelbroking.dbo.Vlms) y on x.Fld_Emp_Code = y.Emp_no order by fld_complaint_date'                    
exec(@str)                       
fld_request_id not in ('4','5','7','8','11','13','15','16','17','19')          
--print(@str) ('1','4','7','8','9','11','13','15','16','17','19') */          
          
select x.* ,case when x.Fld_Status = 'H' then 'CLOSED' else 'OPEN' end as status,y.fldsubcatid,y.fldsubcatname,          
z.fldsubjectid,z.fldsubjectname,w.emp_no,w.emp_name,w.emailadd from           
(          
select * from Tbl_HR_Complaint_Master_New (nolock) where Fld_status <> 'D' and                            
fld_complaint_date >= @From_date and fld_complaint_date <= @To_date+' 23:59:59' and           
Fld_Status like  @Status  and fld_wip_fres = 'Software'     
)x          
left outer join          
(select * from tbl_hr_subcatmaster (nolock))y          
on x.fld_request_id = y.fldsubcatid          
left outer join          
(select * from tbl_hr_subjectmaster (nolock))z          
on x.fld_subject  = z.fldsubjectid          
left outer join          
(select [Emp No] Emp_no,Emp_Name,emailadd from [MIDDLEWARE].harmony.dbo.vlmsinhouse)w          
on  x.Fld_Emp_Code = w.Emp_no          
left outer join          
(select * from Tbl_Request_Master_Mapping (nolock) where Fld_EmpCode like @Fld_EmpCode)v          
on y.fldsubcatid  = v.Fld_Srno order by x.fld_complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_HR_MisRpt_Request_Tat
-- --------------------------------------------------
CREATE proc usp_HR_MisRpt_Request_Tat  
  
  
/* --'01/08/2009','12/08/2009','%'     */  
(          
@Fd as varchar(25),          
@Td as varchar(25),          
@status as varchar(5),
@request as varchar(20)          
)          
as          
create table #t          
(          
Fld_srno int,          
Fld_Complaint_date varchar(25),          
Fld_mark_time varchar(25),          
Fld_Count int,    
RowId int primary key identity(1,1)           
)          
select fld_srno,Fld_Emp_Code,emp_name,Region,branch_cd,Fldsubcatname,fld_query,fld_solution,        
Fld_Complaint_Date,Fld_Mark_Time,Solved_by,Fld_Request_id into #temp from V_Mis_Rpt_New(nolock) where Fld_Complaint_date >=  convert(varchar(11), convert(datetime, @Fd, 103))         
and Fld_Complaint_date <= convert(varchar(11), convert(datetime, @Td, 103)) +' 23:59:59'          
and Fld_Status like @status and  Fld_Request_id = @request order by Fld_Complaint_date    
    
insert into #t          
select fld_srno,Fld_Complaint_date,Fld_mark_time,'0' from #temp(nolock)         
             
DECLARE @fld_srno int,@Fld_Complaint_date varchar(25),@Fld_mark_time varchar(25)          
        
Declare @MinRowId int,@MaxRowId int,@CurrRowId int    
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #t    
set @CurrRowId=@MinRowId    
while(@CurrRowId <=@MaxRowId)    
Begin    
select @fld_srno=Fld_srno,@Fld_Complaint_date=Fld_Complaint_date,@Fld_mark_time=Fld_mark_time from #t(nolock)    
where RowId=@CurrRowId    
    
declare @day int,@HH int,@Flag int,@Fdate datetime,@Tdate datetime             
set @Flag=0          
set @Fdate=@Fld_Complaint_date          
set @Tdate=@Fld_mark_time          
          
while(convert(datetime,convert(varchar(11),@Fdate),102) <> convert(datetime,convert(varchar(11),@Tdate),102))        
begin         
 if(select datename(dw,@Fdate)) = 'Sunday'        
 begin       
  set @Flag = (select datediff(hh,@Fdate,convert(varchar(11),@Fdate)+' 23:59:59.999'))      
  set @Flag=@Flag+@Flag        
 end        
 set @Fdate=  convert(datetime,dateadd(dd,1,@Fdate),102)        
end          
set @day = (select datediff(hh,@Fld_Complaint_date,@Fld_mark_time))          
set @HH = (@day-@Flag)        
--print @HH        
         
update #T set Fld_Count=@HH where Fld_srno= @fld_srno      
    
set @CurrRowId=@CurrRowId+1     
end    
         
select a.fld_srno,a.Fld_Emp_Code,a.emp_name,a.Region,branch_cd,a.Fldsubcatname,a.fld_query,a.fld_solution,          
a.Fld_Complaint_Date,a.Fld_Mark_Time,a.Solved_by,b.Fld_Count as compltedtime from          
(select * from #temp(nolock))a          
left outer join          
(select Fld_srno,Fld_Count from #t(nolock))b            
on a.fld_srno=b.Fld_srno 
order by Fld_Complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_HR_MisRpt_Tat
-- --------------------------------------------------
CREATE proc usp_HR_MisRpt_Tat


/* --'01/08/2009','12/08/2009','%'     */
(        
@Fd as varchar(25),        
@Td as varchar(25),        
@status as varchar(5)        
)        
as        
create table #t        
(        
Fld_srno int,        
Fld_Complaint_date varchar(25),        
Fld_mark_time varchar(25),        
Fld_Count int,  
RowId int primary key identity(1,1)         
)        
select fld_srno,Fld_Emp_Code,emp_name,Region,branch_cd,Fldsubcatname,fld_query,fld_solution,      
Fld_Complaint_Date,Fld_Mark_Time,Solved_by into #temp from V_Mis_Rpt_New(nolock) where Fld_Complaint_date >=  convert(varchar(11), convert(datetime, @Fd, 103))       
and Fld_Complaint_date <= convert(varchar(11), convert(datetime, @Td, 103)) +' 23:59:59'        
and Fld_Status like @status order by Fld_Complaint_date  
  
insert into #t        
select fld_srno,Fld_Complaint_date,Fld_mark_time,'0' from #temp(nolock)       
           
DECLARE @fld_srno int,@Fld_Complaint_date varchar(25),@Fld_mark_time varchar(25)        
      
Declare @MinRowId int,@MaxRowId int,@CurrRowId int  
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #t  
set @CurrRowId=@MinRowId  
while(@CurrRowId <=@MaxRowId)  
Begin  
select @fld_srno=Fld_srno,@Fld_Complaint_date=Fld_Complaint_date,@Fld_mark_time=Fld_mark_time from #t(nolock)  
where RowId=@CurrRowId  
  
declare @day int,@HH int,@Flag int,@Fdate datetime,@Tdate datetime           
set @Flag=0        
set @Fdate=@Fld_Complaint_date        
set @Tdate=@Fld_mark_time        
        
while(convert(datetime,convert(varchar(11),@Fdate),102) <> convert(datetime,convert(varchar(11),@Tdate),102))      
begin       
 if(select datename(dw,@Fdate)) = 'Sunday'      
 begin     
  set @Flag = (select datediff(hh,@Fdate,convert(varchar(11),@Fdate)+' 23:59:59.999'))    
  set @Flag=@Flag+@Flag      
 end      
 set @Fdate=  convert(datetime,dateadd(dd,1,@Fdate),102)      
end        
set @day = (select datediff(hh,@Fld_Complaint_date,@Fld_mark_time))        
set @HH = (@day-@Flag)      
--print @HH      
       
update #T set Fld_Count=@HH where Fld_srno= @fld_srno    
  
set @CurrRowId=@CurrRowId+1   
end  
       
select a.fld_srno,a.Fld_Emp_Code,a.emp_name,a.Region,branch_cd,a.Fldsubcatname,a.fld_query,a.fld_solution,        
a.Fld_Complaint_Date,a.Fld_Mark_Time,a.Solved_by,b.Fld_Count as compltedtime from        
(select * from #temp(nolock))a        
left outer join        
(select Fld_srno,Fld_Count from #t(nolock))b          
on a.fld_srno=b.Fld_srno        
order by Fld_Complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_HR_MisRpt_WIP_Tat
-- --------------------------------------------------
CREATE proc usp_HR_MisRpt_WIP_Tat      
      
      
/* --'01/08/2009','12/08/2009','%'     */      
(              
@Fd as varchar(25),              
@Td as varchar(25),              
@status as varchar(200)             
)              
as   

           
create table #t              
(              
Fld_srno int,              
Fld_Complaint_date varchar(25),              
Fld_mark_time varchar(25),              
Fld_Count int,        
RowId int primary key identity(1,1)               
)      
  
/*select fld_srno,Fld_Emp_Code,emp_name,Region,branch_cd,Fldsubcatname,fld_query,fld_solution,            
Fld_Complaint_Date,Fld_Mark_Time,Solved_by,Fld_Request_id,Fld_wip_fres into #temp from V_Mis_Rpt_New(nolock)   
where Fld_Complaint_date >=  convert(varchar(11), convert(datetime, @Fd, 103))             
and Fld_Complaint_date <= convert(varchar(11), convert(datetime, @Td, 103)) +' 23:59:59'              
and Fld_Status like @status and  Fld_wip_fres <> '' order by Fld_Complaint_date  */          

  
/*declare @Fd as varchar(25),@Td as varchar(25),@status as varchar(150)   
set @Fd = '01/08/2009'  
set @Td = '01/09/2009'  
set @status = 'C'   
*/


set @Status = case when @Status = 'P' then 'Fld_status in (''P'',''H'')' else 'Fld_status like '''+ @Status +'''' end     
declare @str as varchar(3000)  

select Top 0 fld_srno,Fld_Emp_Code,emp_name,Region,branch_cd,Fldsubcatname,fld_query,fld_solution,            
Fld_Complaint_Date,Fld_Mark_Time,Solved_by,Fld_Request_id,Fld_wip_fres into #temp from V_Mis_Rpt_New(nolock)   

  
set @str =  'insert into #temp select fld_srno,Fld_Emp_Code,emp_name,Region,branch_cd,Fldsubcatname,fld_query,fld_solution,            
Fld_Complaint_Date,Fld_Mark_Time,Solved_by,Fld_Request_id,Fld_wip_fres from V_Mis_Rpt_New(nolock)   
where Fld_Complaint_date >=  convert(varchar(11), convert(datetime, '''+@Fd+''', 103))             
and Fld_Complaint_date <= convert(varchar(11), convert(datetime, '''+@Td+' 23:59:59'', 103))              
and  '+@status+' and  Fld_wip_fres <> '''' order by Fld_Complaint_date'  
  
exec (@str)  

        
insert into #t              
select fld_srno,Fld_Complaint_date,Fld_mark_time,'0' from #temp(nolock)             
                 
DECLARE @fld_srno int,@Fld_Complaint_date varchar(25),@Fld_mark_time varchar(25)              
            
Declare @MinRowId int,@MaxRowId int,@CurrRowId int        
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #t        
set @CurrRowId=@MinRowId        
while(@CurrRowId <=@MaxRowId)        
Begin        
select @fld_srno=Fld_srno,@Fld_Complaint_date=Fld_Complaint_date,@Fld_mark_time=Fld_mark_time from #t(nolock)        
where RowId=@CurrRowId        
        
declare @day int,@HH int,@Flag int,@Fdate datetime,@Tdate datetime                 
set @Flag=0              
set @Fdate=@Fld_Complaint_date              
set @Tdate=@Fld_mark_time              
              
while(convert(datetime,convert(varchar(11),@Fdate),102) <> convert(datetime,convert(varchar(11),@Tdate),102))            
begin             
 if(select datename(dw,@Fdate)) = 'Sunday'            
 begin           
  set @Flag = (select datediff(hh,@Fdate,convert(varchar(11),@Fdate)+' 23:59:59.999'))          
  set @Flag=@Flag+@Flag            
 end            
 set @Fdate=  convert(datetime,dateadd(dd,1,@Fdate),102)            
end              
set @day = (select datediff(hh,@Fld_Complaint_date,@Fld_mark_time))              
set @HH = (@day-@Flag)            
--print @HH            
             
update #T set Fld_Count=@HH where Fld_srno= @fld_srno          
        
set @CurrRowId=@CurrRowId+1         
end        
             
select a.fld_srno,a.Fld_Emp_Code,a.emp_name,a.Region,branch_cd,a.Fldsubcatname,a.fld_query,a.fld_solution,              
a.Fld_Complaint_Date,a.Fld_Mark_Time,a.Solved_by,b.Fld_Count as compltedtime,Fld_wip_fres from              
(select * from #temp(nolock))a              
left outer join              
(select Fld_srno,Fld_Count from #t(nolock))b                
on a.fld_srno=b.Fld_srno     
order by Fld_Complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Region_MIS
-- --------------------------------------------------
CREATE Proc USP_HR_Region_MIS              
(              
@fdate as varchar(11),              
@tdate as varchar(11),              
@Req_ID as char(5)              
)              
              
as              
          
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))          

/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5)
set @fdate = convert(varchar(11),convert(datetime,'22/03/2009',103))
set @tdate = convert(varchar(11),convert(datetime,'25/03/2009',103))  
set @Req_ID = '%%'*/
        
select * into #temp from            
(                
select distinct x.code,x.Description,             
isnull(y.Total,0) as Total,              
isnull(a.Completed,0) as Completed,              
isnull(z.Delayed,0) as Delayed,              
isnull(z.Pending,0) as Pending              
 from              
(select * from V_Region_Location) x              
left outer join              
(select Region_Code,count(*) as Total from V_Mis_Rpt where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code) y              
on x.Description = y.Region_Code              
left outer join              
(              
select               
case when x.Region_Code is null then y.region_code else x.Region_Code  end as Region_Code,              
isnull(x.Delayed,0) as Delayed,              
isnull(y.Pending,0) as Pending               
 from               
(select Region_Code,count(*) as  Delayed from V_Mis_Rpt where Fld_Status = 'P' and               
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code)x              
full outer join              
(select Region_Code,count(*) as  Pending from V_Mis_Rpt where Fld_Status = 'P' and               
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code)y              
on x.Region_Code = y.Region_Code              
) z              
on x.Description = z.Region_Code              
left outer join              
(select Region_Code,count(*) as Completed from  V_Mis_Rpt where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code) a              
on x.Description = a.Region_Code                    
) x where Total <> 0 order by Description       
      
select * from #temp      
union all      
select '', 'Total',sum(Total),sum(completed),sum(delayed),sum(pending) from #temp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Region_MIS_New1
-- --------------------------------------------------
CREATE Proc USP_HR_Region_MIS_New1                    
(                    
@fdate as varchar(11),                    
@tdate as varchar(11),                    
@Req_ID as char(5)                    
)                    
                    
as                    
                
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                
      
/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5)      
set @fdate = convert(varchar(11),convert(datetime,'22/03/2009',103))      
set @tdate = convert(varchar(11),convert(datetime,'25/03/2009',103))        
set @Req_ID = '%%'*/      
              
select * into #temp from                  
(                      
select distinct x.Description,            
isnull(y.Total,0) as Total,                    
isnull(a.Completed,0) as Completed,                    
isnull(z.Delayed,0) as Delayed,                    
isnull(z.Pending,0) as Pending                    
 from                    
(select * from V_Region_Location)x                    
left outer join                    
(select Region_Code,count(*) as Total from V_Mis_Rpt_new where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code) y      
on x.Description = y.Region_Code                    
left outer join                    
(                    
select                     
case when x.Region_Code is null then y.region_code else x.Region_Code  end as Region_Code,                    
isnull(x.Delayed,0) as Delayed,                    
isnull(y.Pending,0) as Pending                     
 from                     
(select Region_Code,count(*) as  Delayed from V_Mis_Rpt_new where Fld_Status = 'P' and                     
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code)x                    
full outer join                    
(select Region_Code,count(*) as  Pending from V_Mis_Rpt_new where Fld_Status = 'P' and                     
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code)y                    
on x.Region_Code = y.Region_Code                    
) z                    
on x.Description = z.Region_Code                    
left outer join                    
(select Region_Code,count(*) as Completed from  V_Mis_Rpt_new where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code) a                    
on x.Description = a.Region_Code                          
) x where Total <> 0 order by Description             
      
select * from #temp            
union all            
select 'Total',sum(Total),sum(completed),sum(delayed),sum(pending) from #temp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Region_MIS_New1_HR
-- --------------------------------------------------
CREATE Proc USP_HR_Region_MIS_New1_HR                    
(                    
@fdate as varchar(11),                    
@tdate as varchar(11),                    
@Req_ID as char(5)                    
)                    
                    
as                    
                
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                
      
/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5)      
set @fdate = convert(varchar(11),convert(datetime,'22/03/2009',103))      
set @tdate = convert(varchar(11),convert(datetime,'25/03/2009',103))        
set @Req_ID = '%%'*/      
              
select * into #temp from                  
(                      
select distinct x.Description,            
isnull(y.Total,0) as Total,                    
isnull(a.Completed,0) as Completed,                    
isnull(z.Delayed,0) as Delayed,                    
isnull(z.Pending,0) as Pending                    
 from                    
(select * from V_Region_Location)x                    
left outer join                    
(select Region_Code,count(*) as Total from V_Mis_Rpt_New where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code) y      
on x.Description = y.Region_Code                    
left outer join                    
(                    
select                     
case when x.Region_Code is null then y.region_code else x.Region_Code  end as Region_Code,                    
isnull(x.Delayed,0) as Delayed,                    
isnull(y.Pending,0) as Pending                     
 from                     
(select Region_Code,count(*) as  Delayed from V_Mis_Rpt_New where Fld_Status = 'P' and                     
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code)x                    
full outer join                    
(select Region_Code,count(*) as  Pending from V_Mis_Rpt_New where Fld_Status = 'P' and                     
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code)y                    
on x.Region_Code = y.Region_Code                    
) z                    
on x.Description = z.Region_Code                    
left outer join                    
(select Region_Code,count(*) as Completed from  V_Mis_Rpt_New where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID group by Region_Code) a                    
on x.Description = a.Region_Code                          
) x where Total <> 0 order by Description             
      
select * from #temp            
union all            
select 'Total',sum(Total),sum(completed),sum(delayed),sum(pending) from #temp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Region_MIS_NewRegion
-- --------------------------------------------------
CREATE Proc USP_HR_Region_MIS_NewRegion                      
(                      
@fdate as varchar(11),                      
@tdate as varchar(11),                      
@Req_ID as char(5),
@catid as char(5)                    
)                      
                      
as                      
                  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                  
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                  

/*declare @fdate as varchar(11),@tdate as varchar(11), @Req_ID as char(5),@catid as char(5)        
set @fdate = convert(varchar(11),convert(datetime,'01/01/2010',103))        
set @tdate = convert(varchar(11),convert(datetime,'12/01/2010',103))          
set @Req_ID = '%'
set @catid = '%'
*/

select
case when a.Regionname is null then b.Regionname else a.Regionname end as Regionname,
case when a.reg_code is null then b.reg_code else a.reg_code end as reg_code,
Total = isnull(Total,0),
Completed = isnull(Completed,0),
Delayed = isnull(Delayed,0),
Pending = isnull(Pending,0)
 
from
(
select case 
when a.Regionname is null then b.Regionname else b.Regionname end as Regionname,
case when a.reg_code is null then b.reg_code else b.reg_code end as reg_code,
Total = isnull(Total,0),
Completed = isnull(Completed,0) from
(select case when Regionname is null then 'Others' else Regionname end as Regionname,case when reg_code is null then 'Others' else reg_code end as reg_code,count(*) as Total from V_Mis_Rpt_new where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID  and convert(char(10),Fldcatid) like @catid group by Regionname,reg_code)a                
full outer join
(select case when Regionname is null then 'Others' else Regionname end as Regionname,case when reg_code is null then 'Others' else reg_code end as reg_code,count(*) as Completed from  V_Mis_Rpt_new where Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and Fld_Status = 'C' and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid group by Regionname,reg_code) b
on a.Regionname = b.Regionname
)a
Full outer join
(
select 
case when a.Regionname is null then b.Regionname else b.Regionname end as Regionname,
case when a.reg_code is null then b.reg_code else b.reg_code end as reg_code,
Delayed = isnull(Delayed,0),
Pending = isnull(Pending,0) from
(select case when regionname is null then 'Others' else regionname end as regionname,case when Reg_Code is null then 'Others' else Reg_code end as reg_code,count(*) as  Delayed from V_Mis_Rpt_new where Fld_Status = 'P' and                       
datediff(hh,Fld_complaint_date,getdate()) > 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59'and convert(char(10),Fld_Request_id) like @Req_ID and convert(char(10),Fldcatid) like @catid group by regionname,reg_code)a
full outer join
(select case when regionname is null then 'Others' else regionname end as regionname,case when Reg_Code is null then 'Others' else Reg_code end as reg_code,count(*) as  Pending from V_Mis_Rpt_new where Fld_Status = 'P' and                       
datediff(hh,Fld_complaint_date,getdate()) <= 24 and Fld_complaint_date >= @fdate and Fld_complaint_date <= @tdate+' 23:59:59' and convert(char(10),Fld_Request_id) like @Req_ID  and convert(char(10),Fldcatid) like @catid group by regionname,Reg_Code)b
on a.Regionname = b.Regionname
)b
on a.Regionname = b.Regionname  and  a.reg_code = b.reg_code where a.regionname is not null and a.reg_Code is not null

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Rpt
-- --------------------------------------------------
CREATE Proc USP_HR_Rpt(@Fld_Emp_Code varchar(15), @no_rec as varchar(15), @status as varchar(10))  
as  
  
--print @Fld_Emp_Code  
--print @no_rec  
declare @str as varchar(1000)  
declare @opt as varchar(100)  
  
set @opt = (case when @no_rec = 'S' then '*' else  ' top ' +@no_rec + ' * ' end)  
  
  
set @str = 'select '+ @opt +' from (  
select x.*,y.Fld_Request, status=   
(case when x.fld_status=''P'' then ''Open'' else ''Closed'' end)  
 from   
(select *,''<a href=http://localhost/AngelInhouse/Attachments/''+File_Name+''>''+File_Name+''</a>'' as Attachment from Tbl_HR_Complaint_Master (nolock) where Fld_Emp_Code = '''+@Fld_Emp_Code+''' and Fld_Status like '''+ @status + ''' ) x  
left outer join  
(select * from tbl_request_master (nolock) ) y  
on x.Fld_Request_id = y.Fld_SrNO  
) x  
order by Fld_Complaint_date desc'   
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Rpt_New
-- --------------------------------------------------

--USP_HR_Rpt_New 'E07260','48','C'
CREATE Proc USP_HR_Rpt_New(@Fld_Emp_Code varchar(15), @no_rec as varchar(15), @status as varchar(10))                  
as                  
                  
/*--print @Fld_Emp_Code                  
--print @no_rec                  
declare @str as varchar(1000)                  
declare @opt as varchar(100)                  
                  
set @opt = (case when @no_rec = 'S' then '*' else  ' top ' +@no_rec + ' * ' end)                
              
set @str = 'select '+ @opt +' from (                  
select x.*,y.fldsubcatname,z.fldsubjectname, status=                   
(case when x.fld_status=''P'' then ''Open'' else ''Closed'' end)                  
 from                   
(select *,''<a href=http://localhost/AngelInhouse/Attachments/''+File_Name+''>''+File_Name+''</a>'' as Attachment from Tbl_HR_Complaint_Master_New (nolock) where Fld_Emp_Code = '''+@Fld_Emp_Code+''' and Fld_Status like '''+ @status + ''' ) x              
  
    
left outer join          
(select * from tbl_hr_subcatmaster (nolock))y          
on x.Fld_request_id = y.fldsubcatid          
left outer join            
(select * from tbl_hr_subjectmaster (nolock))Z          
on x.Fld_subject = z.fldsubjectid                 
) x                  
order by Fld_Complaint_date desc'                   
exec(@str)   
*/  
  
  
declare @str as varchar(1000)                          
declare @opt as varchar(100)                          
                          
set @opt = (case when @no_rec = 'S' then '*' else  ' top ' +@no_rec + ' * ' end)                        
                      
set @str = 'select '+ @opt +' from (                          
select x.*,y.fldsubcatname,z.fldsubjectname, status=                           
(case when x.fld_status=''P'' then ''Open'' else ''Closed'' end)                          
 from                           
(select top 25 * from tbl_hr_complaint_master_new (nolock) where Fld_Emp_Code = '''+@Fld_Emp_Code+''' and Fld_Status like '''+ @status + ''' order by fld_srno desc ) x                    
left outer join                  
(select * from tbl_hr_subcatmaster (nolock))y                  
on x.Fld_request_id = y.fldsubcatid                  
left outer join                    
(select * from tbl_hr_subjectmaster (nolock))Z                  
on x.Fld_subject = z.fldsubjectid                         
) x                          
order by Fld_Complaint_date desc'                           
exec(@str)    
--print @str

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Rpt1
-- --------------------------------------------------
CREATE Proc USP_HR_Rpt1(@Fld_Emp_Code varchar(15), @no_rec as varchar(15), @status as varchar(10))  
as  
  
--print @Fld_Emp_Code  
--print @no_rec  
declare @str as varchar(1000)  
declare @opt as varchar(100)  
  
set @opt = (case when @no_rec = 'S' then '*' else  ' top ' +@no_rec + ' * ' end)  
  
  
set @str = 'select '+ @opt +' from (  
select x.Fld_Complaint_date,x.Fld_Subject, x.Fld_Complaint_no,y.Fld_Request, status=   
(case when x.fld_status=''P'' then ''Open'' else ''Closed'' end)  
 from   
(select * from Tbl_HR_Complaint_Master (nolock) where Fld_Emp_Code = '''+@Fld_Emp_Code+''' and Fld_Status like '''+ @status + ''' ) x  
left outer join  
(select * from tbl_request_master (nolock) ) y  
on x.Fld_Request_id = y.Fld_SrNO  
) x  
order by Fld_Complaint_date desc'  
  
--print @str  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Summary_Rpt
-- --------------------------------------------------
CREATE Proc USP_HR_Summary_Rpt(@fdate as varchar(11),@tdate as varchar(20),@Fld_Request_id as varchar(5))      
as      
      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))      
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))+' 23:59:59'    

declare @str as varchar(1000)

set @str = 'select * from      
(      
select count(*) as Total from tbl_hr_Complaint_Master where Fld_Complaint_Date >= '''+@fdate+'''      
and Fld_Complaint_Date <= '''+@tdate+''' and Fld_Request_id like '''+@Fld_Request_id+'''      
) x      
left outer join      
(      
select count(*) as Pending from tbl_hr_Complaint_Master where Fld_Complaint_Date >= '''+@fdate+'''            
and Fld_Complaint_Date <= '''+@tdate+''' and Fld_Request_id like '''+@Fld_Request_id+'''   and Fld_Status = ''P''      
) y on x.Total = x.Total      
left outer join      
(      
select count(*) Completed from tbl_hr_Complaint_Master where Fld_Complaint_Date >= '''+@fdate+'''            
and Fld_Complaint_Date <= '''+@tdate+''' and Fld_Request_id like '''+@Fld_Request_id+'''   and Fld_Status = ''C''      
) z on x.Total = x.Total'   
exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Summary_Rpt_New
-- --------------------------------------------------
CREATE Proc USP_HR_Summary_Rpt_New(@fdate as varchar(11),@tdate as varchar(20),@Fld_Request_id as varchar(5))          
as          
          
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))+' 23:59:59'        
    
declare @str as varchar(1000)    
    
set @str = 'select * from          
(          
select count(*) as Total from tbl_hr_Complaint_Master_New where Fld_Complaint_Date >= '''+@fdate+'''          
and Fld_Complaint_Date <= '''+@tdate+''' and Fld_Request_id like '''+@Fld_Request_id+'''          
) x          
left outer join          
(          
select count(*) as Pending from tbl_hr_Complaint_Master_New where Fld_Complaint_Date >= '''+@fdate+'''                
and Fld_Complaint_Date <= '''+@tdate+''' and Fld_Request_id like '''+@Fld_Request_id+'''   and Fld_Status = ''P''          
) y on x.Total = x.Total          
left outer join          
(          
select count(*) Completed from tbl_hr_Complaint_Master_New where Fld_Complaint_Date >= '''+@fdate+'''                
and Fld_Complaint_Date <= '''+@tdate+''' and Fld_Request_id like '''+@Fld_Request_id+'''   and Fld_Status in (''C'',''F'')          
) z on x.Total = x.Total'       
exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_Summary_Rpt_WIP
-- --------------------------------------------------
CREATE Proc USP_HR_Summary_Rpt_WIP(@fdate as varchar(11),@tdate as varchar(20))          
as          
          
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))+' 23:59:59'        
    
declare @str as varchar(1000)    
    
set @str = 'select * from          
(          
select count(*) as Total from tbl_hr_Complaint_Master_New where Fld_Complaint_Date >= '''+@fdate+'''          
and Fld_Complaint_Date <= '''+@tdate+''' and fld_wip_fres <> ''''          
) x          
left outer join          
(          
select count(*) as Pending from tbl_hr_Complaint_Master_New where Fld_Complaint_Date >= '''+@fdate+'''                
and Fld_Complaint_Date <= '''+@tdate+''' and fld_wip_fres <> ''''    and Fld_Status = ''P''          
) y on x.Total = x.Total          
left outer join          
(          
select count(*) Completed from tbl_hr_Complaint_Master_New where Fld_Complaint_Date >= '''+@fdate+'''                
and Fld_Complaint_Date <= '''+@tdate+''' and fld_wip_fres <> ''''    and Fld_Status = ''C''          
) z on x.Total = x.Total'       
exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_hr_tmsentry
-- --------------------------------------------------
CREATE proc usp_hr_tmsentry          
(          
@complaint as varchar(50)          
)          
as          
declare @fldsubject as varchar(250),@query as varchar(50)       


          
select a.fld_request_id,a.fld_subject,a.fld_Query,a.fld_solution,a.fld_emp_code,          
a.fld_complaint_No,a.fld_status,a.fld_Mark_Time,a.[file_name],          
b.fldsubjectname into #temp from tbl_hr_complaint_master_new a  left outer join        
tbl_hr_subjectmaster b on a.fld_subject = b.fldsubjectid       
where fld_complaint_no = @complaint          
          
set @fldsubject = (select fldsubjectname from #temp  where fld_complaint_no = @complaint )          
set @query = (select fld_Query from #temp  where fld_complaint_no =  @complaint )          
          
declare @taskno int , @taskno1 int ,@refno int         
set @taskno = (select taskno = isnull(max(taskno),0)+1 from intranet.misc.dbo.user_taskno)          
set @refno = (select refno = isnull(max(refno),0)+1 from intranet.misc.dbo.user_query where keyno = 1048)  
set @taskno1 = (select fld_taskno from tbl_hr_complaint_master_new where fld_complaint_no =  @complaint)      
if  @taskno1 = 0      
begin           
      
update tbl_hr_complaint_master_new set fld_taskno = @taskno where fld_complaint_no =  @complaint      
      
insert into intranet.misc.dbo.user_query          
(refno,keyno,qdate,qfrom,qto,email_id,designation,dept,subject,msgtype,[message],sr_name,task_no,qfrom_empcd,deadline)          
values          
(@refno,1048,getdate(),'Jennifer Maharshi','soft@angeltrade.com','jennifer@angeltrade.com','Assistant Manager','HR',@fldsubject,'Modification',@query,'Manish Rahthod',@taskno,'E00208',getdate()+5)      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Hr_Uploaded_Files1
-- --------------------------------------------------
CREATE proc Usp_Hr_Uploaded_Files1      
(      
@complaintNo as varchar(25),      
@Binarfile  image,      
@mimtype as varchar(100),      
@filename as varchar(120)      
)      
as       
      
update tbl_hr_complaint_master_new set BINARYFILE_Admin = @Binarfile,MIMETYPE_Admin=@mimtype,File_Name_Admin = @filename  
where fld_complaint_no = @complaintNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_HR_USER_Status
-- --------------------------------------------------

CREATE proc USP_HR_USER_Status(@Fld_Emp_Code as varchar(15))  
as  
select x.*,isnull(z.c,0) as C from  
(  
select x.Fld_Emp_Code,isnull(x.Total,0) as Total,isnull(y.P,0) as P from  
(select Fld_Emp_Code,count(*) as Total from Tbl_HR_Complaint_Master_New (nolock) where Fld_Emp_Code = @Fld_Emp_Code group by Fld_Emp_Code) x  
full outer join  
(select Fld_Emp_Code,count(*) as P from Tbl_HR_Complaint_Master_New (nolock) where Fld_Emp_Code = @Fld_Emp_Code and Fld_status = 'P' group by Fld_Emp_Code )y  
on x.Fld_Emp_Code = y.Fld_Emp_Code  
) x  
full outer join  
(select Fld_Emp_Code,count(*) as C from Tbl_HR_Complaint_Master_New (nolock) where Fld_Emp_Code = @Fld_Emp_Code and Fld_status = 'C' group by Fld_Emp_Code )z  
on x.Fld_Emp_Code = z.Fld_Emp_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_hrempComplaint_details
-- --------------------------------------------------
  
CREATE proc dbo.USP_hrempComplaint_details               
(              
@complainNo varchar(10)              
)              
as      
select b.fldsubcatname,a.*,e.fldcatname,e.fldcatid,f.emp_name,g.fldsubjectname from      
(select *  from Tbl_HR_Complaint_Master_New (nolock) where Fld_Complaint_No =  @complainNo)a      
left outer join      
(select * from tbl_hr_subcatmaster (nolock))b      
on a.fld_request_id = fldsubcatid      
left outer join      
(select * from tbl_HR_CatSubCategory (nolock))c      
on b.fldsubcatid = c.fldsubcatsubjectid      
left outer join      
(select * from tbl_hr_catmaster (nolock))e      
on c.fldcatid = e.fldcatid      
left outer join      
(select Emp_name,[emp no] as emp_no from [MIDDLEWARE].harmony.dbo.vlmsinhouse)f      
on a.fld_emp_code =f.emp_no      
left outer join      
(select * from tbl_hr_subjectmaster)g      
on a.fld_subject = g.fldsubjectid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_HrHarmonyNewRequest
-- --------------------------------------------------
CREATE proc Usp_HrHarmonyNewRequest  
(  
@Fld_RefNo int,  
@Fld_RequestDate varchar(11),  
@Fld_From varchar(20),  
@Fld_QryType int,  
@Fld_Subject varchar(100),  
@Fld_DeadLine varchar(11),  
@Fld_Message varchar(1000),  
@fld_FileName varchar(100),  
@Fld_Flag char  
)  
as  
declare @d1 as datetime,@d2 as datetime  
set @d1=convert(datetime,@Fld_RequestDate,103)  
set @d2=convert(datetime,@Fld_DeadLine,103)  
insert into tbl_HrHarmonyNewRequest values  
(  
@Fld_RefNo,  
@d1,  
@Fld_From,  
@Fld_QryType,  
@Fld_Subject,  
@d2,  
@Fld_Message,  
@fld_FileName,  
@Fld_Flag,
''  
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_HrHarmonyReqCompletion
-- --------------------------------------------------
create proc Usp_HrHarmonyReqCompletion
(
@Status as char,
@Fdate as varchar(11),
@Tdate as varchar(11)
)
as

select a.*,b.Fld_Type from 
(select *,replace(str(isnull(Fld_RefNo,0),4),' ',0) as RequestID,
case when Fld_Flag='P' then 'Open' 
when Fld_Flag='C' then 'Completed' end flag  from tbl_HrHarmonyNewRequest(nolock) where Fld_RequestDate>=convert(datetime,@Fdate,103) and Fld_RequestDate<=convert(datetime,@Tdate,103) and Fld_Flag=@Status)a
left outer join
(select * from tbl_HrHarmonyQryType(nolock))b
on a.Fld_QryType=b.Fld_Id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_HrHarmonyReqSolution
-- --------------------------------------------------
CREATE proc Usp_HrHarmonyReqSolution     
(          
@username as varchar(11)        
)        
as        
       
select x.*,y.Fld_Type from       
(select * from       
(select [Emp No],Emp_name,[HOD No],[HOD Name],emailadd,phone from [MIDDLEWARE].harmony.dbo.vlmsinhouse where [Emp No]=@username)a      
left outer join       
(select Fld_from,Fld_Subject,Fld_Message,Fld_QryType,Fld_FileName from tbl_HrHarmonyNewRequest(nolock))b      
on a.[Emp No]=b.Fld_from)x      
left outer join       
(select * from tbl_HrHarmonyQryType(nolock))y      
on x.Fld_QryType=y.Fld_Id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_HrHarmonyUpdateSolution
-- --------------------------------------------------
CREATE proc Usp_HrHarmonyUpdateSolution    
(      
@username as varchar(11), 
@Fld_RefNo as int,   
@Solution as varchar(1000)
)    
as    
update tbl_HrHarmonyNewRequest set Fld_Solution=@Solution,Fld_Flag='C' where Fld_From=@username and Fld_RefNo=@Fld_RefNo
--select * from tbl_HrHarmonyNewRequest(nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Insert_ExamDetails
-- --------------------------------------------------
CREATE Proc Usp_Insert_ExamDetails (@EmpCode Varchar(20),@Ncfmcode Varchar(20),@Exam varchar(5),
@EResult varchar(15),@Percent varchar(5),@Attach image,@Type varchar(10),@FName Varchar(20))  
as  

insert into tbl_ncfmresult values (@EmpCode,@NcfmCode,@Exam,@EResult,@Percent,@Attach,getdate(),@Type,@FName)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Insert_ExamDetails_Fail
-- --------------------------------------------------

create proc Usp_Insert_ExamDetails_Fail 
(@EmpCode Varchar(20),@Ncfmcode Varchar(20),@Exam varchar(5),@EResult varchar(15))
as
if @EResult = 'Fail'
begin
insert into tbl_ncfmresult values (@EmpCode,@NcfmCode,@Exam,@EResult,'','',getdate(),'','')
end
else
begin
insert into tbl_ncfmresult values (@EmpCode,@NcfmCode,@Exam,'Fail','','',getdate(),'','')
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Insert_UPS_Data
-- --------------------------------------------------
CREATE Proc Usp_Insert_UPS_Data(@Fld_Upd_Date Varchar(15),@Fld_Ups_Id int,@Fld_BranchID int,@Fld_Avg_Load Varchar(15),    
@Fld_Bat_Over Varchar(15),@Fld_Critical_Check Varchar(15),@Fld_Fob Varchar(15),@Fld_Fremark Varchar(50),@Fld_Type Char(1),    
@Fld_Sob Varchar(15),@Fld_Sremark Varchar(15))          
as          
          
Set @Fld_Upd_Date = Convert(varchar(11),Convert(datetime,@Fld_Upd_Date,103),121)          
    
If(@Fld_Type = 'U')    
Begin         
 Insert into tbl_weekly_UPs_Details    
 (Fld_Ups_Id,Fld_BranchID,Fld_Avg_Load,Fld_Bat_Over,Fld_Critical_Check,Fld_Fob,Fld_Fremark,Fld_Fcd,Fld_Upd_Date)     
 values    
 (@Fld_Ups_Id,@Fld_BranchID,@Fld_Avg_Load,@Fld_Bat_Over,@Fld_Critical_Check,@Fld_Fob,@Fld_Fremark,getdate(),@Fld_Upd_Date)    
End    
Else    
Begin    
 Insert into tbl_weekly_UPs_Details    
 (Fld_Ups_Id,Fld_BranchID,Fld_Avg_Load,Fld_Bat_Over,Fld_Critical_Check,Fld_Sob,Fld_Sremark,Fld_Scd,Fld_Upd_Date)     
 values    
 (@Fld_Ups_Id,@Fld_BranchID,@Fld_Avg_Load,@Fld_Bat_Over,@Fld_Critical_Check,@Fld_Sob,@Fld_Sremark,getdate(),@Fld_Upd_Date)    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Inventory_AutoMail
-- --------------------------------------------------
CREATE proc [dbo].[USP_Inventory_AutoMail]              
as                  
            
            
BEGIN            
 DECLARE @CNT INT=0            
 DECLARE @RowCnt INT=0            
    DECLARE @EMAIL AS VARCHAR(1000)=''            
 DECLARE @Region AS VARCHAR(100)=''            
 DECLARE @GroupID AS VARCHAR(100)=''            
 DECLARE @BODY1 VARCHAR(8000)=''            
 DECLARE @BODY2 VARCHAR(8000)=''            
 DECLARE @BODY3 VARCHAR(8000)=''            
 DECLARE @HTMLBODY VARCHAR(MAX)=''            
 DECLARE @HTML VARCHAR(MAX)=''            
 DECLARE @SUB VARCHAR(8000)=''            
 DECLARE @OUTPUT VARCHAR(1000)=''            
 DECLARE @GetDate DATETIME = DATEADD(DD, 3 , getdate())            
            
 --SELECT @GetDate            
            
            
 /***** For First Saturday of the Month *****/            
 IF DATEPART(DAY, @GetDate) - DATEPART(DAY, DATEADD(DD, -DATEPART(DAY, @getdate)+1, @GetDate) + 7 - DATEPART(DW, DATEADD(DD, -DATEPART(DAY, @getdate)+1, @GetDate))) >= 0            
  AND DATEPART(DW, @GetDate) <> 1            
 BEGIN            
            
  SELECT Br_Tag,Sr_No,upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch ,            
  EMAIL= CONVERT(VARCHAR(1000),'') , GroupID=CONVERT(VARCHAR(1000),''),MAIL_SENT='N',Region=CONVERT(VARCHAR(1000),'')            
  INTO #INVENTORY_PENDING            
  FROM tbl_it_br_master (nolock) WHERE Br_Status='A'            
  AND Sr_No NOT IN             
  (SELECT DISTINCT br_id FROM tbl_it_inventory WITH (NOLOCK)            
  WHERE YEAR =  DATEPART(YEAR, DATEADD(MONTH, -1, GETDATE())) AND MONTH = DATENAME(MONTH, DATEADD(Month, -1, GETDATE())))            
  ORDER BY Br_Name,Br_Tag                 
            
  UPDATE #INVENTORY_PENDING SET             
  EMAIL= IE_Employee_Email,GroupID=IE_GroupID,Region=IE_Region_name            
  From tbl_IT_Inventory_EmailID            
  WHERE #INVENTORY_PENDING.Sr_No=tbl_IT_Inventory_EmailID.IE_Branch_SrNo            
            
  --select * from #INVENTORY_PENDING            
              
  SELECT Distinct Br_Tag,Branch,EMAIL,GroupID,MAIL_SENT,Region            
        INTO #PENDING FROM #INVENTORY_PENDING  GROUP BY GroupID,Br_Tag,Branch,EMAIL,MAIL_SENT,Region            
        ORDER BY Br_Tag            
                    
  SELECT Br_Name  AS [Branches_Not_Updated],tbl_it_br_master.Br_Tag ,GroupID            
  INTO #Branches             
  FROM tbl_it_br_master,#INVENTORY_PENDING             
  WHERE #INVENTORY_PENDING.Br_Tag = tbl_it_br_master.Br_Tag            
  AND Br_Status='A'            
                 
  SELECT @RowCnt=@@ROWCOUNT            
            
  SELECT @CNT=0            
  SELECT @CNT=COUNT(1) FROM #PENDING WITH (NOLOCK) WHERE MAIL_SENT = 'N' GROUP BY GroupID            
            
  WHILE @CNT > 0            
  BEGIN            
   SELECT TOP 1 @EMAIL=EMAIL,@GroupID=GroupID,@Region=Region FROM #PENDING WITH (NOLOCK) WHERE MAIL_SENT = 'N'            
               
   SELECT @OUTPUT='Select [Branches_Not_Updated],Br_Tag  from #Branches where GroupID='             
      +''''+@GroupID+''''            
                  
       PRINT      @OUTPUT      
       PRINT      @HTMLBODY       
      EXEC [DBA_ConvertQueryInHTMP_Page] @OUTPUT, @HTMLBODY OUTPUT            
            
   SELECT @BODY1 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;">            
   Dear IT Team,<BR/><BR/>This is to remind you for updating Inventory Report of last month.<BR/><BR/>            
   <b><font color=#ff6666>Kindly note that the cut off timing for Inventory Report is 6.00 P.M.(2nd Day of Every Month).<BR/><BR/></font></b>            
   </td></tr></table>'            
   SELECT @BODY2 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;">            
   <BR/>Best Regards,<BR/><BR/><b>IT Branch Support Team</b><BR/>Angel Broking Ltd<BR/>Central Support Office <BR/>Tel no: 022-28358800(Ext: 404/405/406)            
   </td></tr></table>'            
               
   SELECT @HTML = @BODY1+@HTMLBODY+@BODY2            
   SELECT @SUB='Reminder for Inventory Report - '+@Region+''            
            
  print @EMAIL
            
 -- EXEC MSDB.dbo.SP_SEND_DBMAIL
 --@profile_name = 'ITHelpdesk',            
 -- @recipients = @EMAIL,            
 --   @copy_recipients = 'IThelpdeskakruti@angelbroking.com',            
 -- @blind_copy_recipients = 'Rupali.Mayekar@AngelBroking.Com',            
 -- @subject = @SUB,            
 -- @body = @HTML,            
 -- @body_format = 'HTML'       
      
  --print @html    
  --print @sub         
            
  UPDATE #PENDING SET MAIL_SENT = 'Y' WHERE EMAIL=@EMAIL            
  SELECT @CNT=COUNT(1) FROM #PENDING WITH (NOLOCK) WHERE MAIL_SENT = 'N'            
 END            
             
 DROP TABLE #INVENTORY_PENDING            
 DROP TABLE #PENDING            
 DROP TABLE #Branches            
  END            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Invtr_Report_New
-- --------------------------------------------------

--USP_Invtr_Report_New 1,'%','2008','%%'
--   region  -  Broker 
--	type -'%' 
--year - '2011'
-- month '%'
--  '%'Select getdate()

CREATE Procedure USP_Invtr_Report_New   

 (
	@Option int,
	--@fld_branch varchar(20),
	--@Fld_CSO varchar(15),
	@Br_Type as varchar(20),
	@year varchar(20),
	@month varchar(11)
 )
AS
BEGIN

Declare @Query1 varchar(Max)
Declare @ConQuery varchar(Max)
Set @ConQuery = ''


If(@month = '%%')
Begin

	If((Select Convert(datetime,@year)) >= (Select(CONVERT(Datetime,'2011-05-01'))))
	Begin
		
		Set @ConQuery= 'And br_id Not IN (''33'',''41'',''48'',''65'',''210'',''165'',''183'',''184'',''68'',''26'',''24'')'

	End
End
Else
Begin

	If((Select Convert(datetime,@month+ ' ' + @year)) >= (CONVERT(Datetime,'2011-05-01')))
	Begin
		
		Set @ConQuery= 'And br_id Not IN (''33'',''41'',''48'',''65'',''210'',''165'',''183'',''184'',''68'',''26'',''24'')'

	End
End

--If((Select Convert(datetime,@month+ ' ' + @year)) >= (CONVERT(Datetime,'2011-05-01')))
--Begin
	
--	Set @ConQuery= 'And br_id Not IN (''33'',''41'',''48'',''65'',''210'',''165'',''183'',''184'',''68'',''26'',''24'')'

--End



If(@Option=1)
Begin

 set @Query1=  'Select Br_tag,Br_name from 
				tbl_it_br_master (nolock) 
				where Br_Status=''A'' and sr_no  in(select br_id from tbl_it_inventory(nolock) Where 1=1'
			
			if(@Br_Type <> '%')
			Begin
				
				Set @Query1 = @Query1 + 'And br_type = '''+@Br_Type+''''
				print(@Query1)
			
			End
			
			if(@year <> '%')
			Begin
			
				Set @Query1 = @Query1 + ' And year='''+@year+''''
				print(@Query1)
			End
			if(@month <> '%%')
			Begin 
	
				Set @Query1 = @Query1 + ' And month = '''+@month+''''
				
			End
			
			Set @Query1 = @Query1 + @ConQuery + ')'
			
			
			Exec(@Query1)


End 
  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IP_Data
-- --------------------------------------------------
CREATE Proc USP_IP_Data  
(  
@Fld_Branch varchar(50),  
@Fld_IpFrom varchar(15),  
@Fld_IpTo varchar(15),  
@Fld_SB_mask varchar(15),  
@Fld_Def_GT varchar(15),  
@Fld_Remark varchar(500),  
@Fld_User varchar(50)  
)  
as  
  
Begin tran  
insert into tbl_IT_IPaddress values (@Fld_Branch,@Fld_IpFrom,@Fld_IpTo,@Fld_SB_mask,@Fld_Def_GT,@Fld_Remark,getdate(),@Fld_User)  
Commit  

select Top 1 Fld_SrNo from tbl_IT_IPaddress (nolock) order by Fld_SrNo desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IP_Details
-- --------------------------------------------------
CREATE proc USP_IP_Details(@fld_branch varchar(500),@fld_Ip varchar(15),@Fld_Remark as varchar(100),@Fld_Subnet_Mask as varchar(15),@Fld_Default_GW as varchar(15),@Fld_IP_ID as varchar(10),@Flag as char(2))      
as      
      
if @flag = 'Y'  
  
begin   
 insert into tbl_ip_details values (@fld_branch,@fld_Ip,@Fld_Remark,getdate(),@Fld_Subnet_Mask,@Fld_Default_GW,@Fld_IP_ID)       
end  
else  
begin  
 insert into tbl_ip_details values (@fld_branch,@fld_Ip,@Fld_Remark,getdate(),@Fld_Subnet_Mask,@Fld_Default_GW,@Fld_IP_ID)       
 update tbl_ip_details set fld_branch = y.Fld_branch from tbl_IT_IPaddress y inner join tbl_ip_details x  on x.Fld_IP_ID = y.Fld_SrNO and y.Fld_Srno = @Fld_IP_ID  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IP_REPORT
-- --------------------------------------------------
CREATE Proc USP_IP_REPORT(@branch as varchar(50),@ip as varchar(50))    
as    
    
/*    
set @fdate = convert(@fdate,datetime)    
*/    
Declare @Opt as varchar(10)    
    
-- set @fdate = convert(varchar(11),convert(datetime,@fdate,103))    
-- set @tdate = convert(varchar(11),convert(datetime,@tdate,103))    
  
set @ip = case when @ip = '' then '%%' else @ip end    
set @Opt = case when @branch = 'All' then 'like' else '=' end    
set @branch = case when @branch = 'All' then '%%' else @branch end    
    
declare @str as varchar(1000)    
set @str = 'select * from tbl_ip_details where Fld_ip like ''%''+'''+@ip+'''+''%'' and Fld_Branch '+@Opt+''''+@Branch+''''    
exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_Comp_1
-- --------------------------------------------------
CREATE proc USP_ISSUE_Comp_1(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15))                    
as        
        
          
declare @sql as varchar(5000)                        
declare @opt as varchar(500)                        

/*
declare @fdate as varchar(11)                        
declare @tdate as varchar(11)                        
declare @server as varchar(500)                                
        
set @fdate = 'Apr 01 2008'                        
set @tdate = 'Apr 30 2008'                        
set @server = 'ALL'                        
*/
                        
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                      
      
set  @opt = (select                                              
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                         
        
set @sql = 'truncate table tbl_comp_rpt;insert into tbl_comp_rpt select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage from            
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from            
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''            
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),            
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e             
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''             
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from         
(select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+')a inner join 
(select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''group by segment)b on a.segment = b.segment 
group by a.server)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from            
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per            
inner join(select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+' )
a inner join (select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''
group by segment)b on a.segment = b.segment group by a.server) uptime on dt_per.server = uptime.server) v on z.server = v.server            
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q            
on p.server = q.server order by p.server'        
EXEC (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_Comp_2
-- --------------------------------------------------
CREATE proc USP_ISSUE_Comp_2(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15))                        
as            
            
-- declare @fdate as varchar(11)                            
-- declare @tdate as varchar(11)                            
-- declare @server as varchar(500)                            

set nocount on              
    
declare @sql as varchar(5000)                            
declare @opt as varchar(500)                                        
            
-- set @fdate  = 'Apr 01 2008'                            
-- set @tdate  = 'Apr 30 2008'                            
-- set @server = 'All'                            
                            
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                    
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                              
          
set  @opt = (select                                                  
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                             
            
set @sql = 'truncate table tbl_comp_rpt1;insert into tbl_comp_rpt1 
select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage from            
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from            
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''            
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),            
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e             
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''             
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from         
(select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+')a inner join 
(select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''group by segment)b on a.segment = b.segment 
group by a.server)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from            
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per            
inner join(select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+' )
a inner join (select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''
group by segment)b on a.segment = b.segment group by a.server) uptime on dt_per.server = uptime.server) v on z.server = v.server            
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q            
on p.server = q.server order by p.server'            
EXEC (@sql)
 
select Fld_Server as server,issues,A_Total_Downtime,B_Total_Downtime,A_Downtime,B_Downtime,A_Brok_Loss,B_Brok_Loss,A_Total_Brok_Loss,B_Total_Brok_Loss
 from
(           
select     
case when x.server is null then y.server else x.server end as server,    
case when x.issues is null then y.issues else x.issues end as issues,    
isnull(x.Total_Downtime_Per,0) as A_Total_Downtime,    
isnull(y.Total_Downtime_Per,0) as B_Total_Downtime,    
isnull(x.dt_per,0) as A_Downtime,    
isnull(y.dt_per,0) as B_Downtime,    
isnull(x.brk_loss,0) as A_Brok_Loss,    
isnull(y.brk_loss,0) as B_Brok_Loss,     
isnull(x.Total_Brok_Loss,0) as A_Total_Brok_Loss,    
isnull(y.Total_Brok_Loss,0) as B_Total_Brok_Loss      
 from    
(select * from tbl_comp_rpt) x full outer join      
(select * from tbl_comp_rpt1) y on x.server = y.server and x.issues = y.issues 
) x
left outer join
(select * from tbl_Server_master) y on x.server = y.Fld_Id   
order by server,isnull(A_Total_Downtime,0)+A_Total_Brok_Loss+isnull(B_Total_Downtime,0)+isnull(B_Total_Brok_Loss,0)  desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_Comp_RPT_1
-- --------------------------------------------------
CREATE proc USP_ISSUE_Comp_RPT_1(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15),@issues as varchar(100))                                
as                    
                  

-- declare @fdate as varchar(11)                                    
-- declare @tdate as varchar(11)                                    
-- declare @server as varchar(500)                                    
-- declare @issues as varchar(500)         
        

set nocount on          
                      
declare @sql as varchar(5000)                                    
declare @opt as varchar(500)                                            
            

-- set @fdate = 'Apr 01 2008'                                    
-- set @tdate = 'Apr 30 2008'                                    
-- set @server = 'ALL'                                      
-- set @issues = 'ALL'         

            
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                            
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                             
                  
                  
set  @opt = (select                                                      
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                                     
      
set @issues = (case when @issues = 'ALL' then 'like ''%%''' else  '='''+@issues+'''' end )      
                    
set @sql = 
'select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage into #Serverwise_rpt from                    
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from                    
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                    
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),                    
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e                     
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                     
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from         
(select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+')a inner join 
(select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''group by segment)b on a.segment = b.segment group by a.server
)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from                    
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                    
inner join(select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+')a inner join 
(select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''group by segment)b on a.segment = b.segment 
group by a.server) uptime on dt_per.server = uptime.server) v on z.server = v.server                    
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                    
on p.server = q.server order by p.server;truncate table tbl_comp_issue_1;insert into tbl_comp_issue_1            
select a.*,b.Total_issue_dt,b.Total_issue_per,b.Total_issue_brok from            
( select * from #Serverwise_rpt where issues '+@issues+') a inner join            
(select Issues,sum(dt) as Total_issue_dt,sum(dt_per) as Total_issue_per,sum(convert(dec,Brk_Loss)) as Total_issue_brok from #Serverwise_rpt group by Issues) b            
on a.Issues = b.issues order by a.issues'            
exec(@sql)        

/*                    
set @sql = 'select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage into #Serverwise_rpt from                    
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from                    
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                    
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),                    
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e                     
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                     
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from                     
(select distinct server,segment from terminals where server in  '+@opt+')a inner join (select segment,uptime from(select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                        
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                        
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                      
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                     
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' )                    
x)b on a.segment = b.segment group by a.server)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from                    
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                    
inner join(select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in                           
'+@opt+') a inner join(select segment,uptime from (select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                      
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                        
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                           
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                           
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+''' )                    
x) b on a.segment = b.segment group by a.server) uptime on dt_per.server = uptime.server) v on z.server = v.server                    
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                    
on p.server = q.server order by p.server;truncate table tbl_comp_issue_1;insert into tbl_comp_issue_1            
select a.*,b.Total_issue_dt,b.Total_issue_per,b.Total_issue_brok from            
( select * from #Serverwise_rpt where issues '+@issues+') a inner join            
(select Issues,sum(dt) as Total_issue_dt,sum(dt_per) as Total_issue_per,sum(convert(dec,Brk_Loss)) as Total_issue_brok from #Serverwise_rpt group by Issues) b            
on a.Issues = b.issues order by a.issues'            
exec(@sql)    
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_Comp_RPT_2
-- --------------------------------------------------
CREATE proc USP_ISSUE_Comp_RPT_2(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15),@issues as varchar(100))                                    
as                        
                      
/*          
declare @fdate as varchar(11)                                        
declare @tdate as varchar(11)                                        
declare @server as varchar(500)                                        
declare @issues as varchar(500)             
            
*/            
set nocount on              
                          
declare @sql as varchar(5000)                                        
declare @opt as varchar(500)                                                
                
/*                      
set @fdate = 'Sep 01 2007'                                        
set @tdate = 'Sep 30 2007'                                        
set @server = 'ALL'                                          
set @issues = 'Angel'             
*/          
                
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                
                      
                      
set  @opt = (select                                                          
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                                         
          
set @issues = (case when @issues = 'ALL' then 'like ''%%''' else  '='''+@issues+'''' end )          
                        
set @sql = '

select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage into #Serverwise_rpt from                    
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from                    
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                    
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),                    
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e                     
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                     
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from         
(select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+')a inner join 
(select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''group by segment)b on a.segment = b.segment group by a.server
)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from                    
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                    
inner join(select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_Id as server,Fld_Segment as segment from V_Manager_Details (nolock) where Fld_Id in '+@opt+')a inner join 
(select segment,uptime=sum(uptime) from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''group by segment)b on a.segment = b.segment 
group by a.server) uptime on dt_per.server = uptime.server) v on z.server = v.server                    
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                    
on p.server = q.server order by p.server;truncate table tbl_comp_issue_2;insert into tbl_comp_issue_2                
select a.*,b.Total_issue_dt,b.Total_issue_per,b.Total_issue_brok from                
( select * from #Serverwise_rpt where issues '+@issues+') a inner join                
(select Issues,sum(dt) as Total_issue_dt,sum(dt_per) as Total_issue_per,sum(convert(dec,Brk_Loss)) as Total_issue_brok from #Serverwise_rpt group by Issues) b                
on a.Issues = b.issues order by a.issues'                
exec(@sql)        
 
select Fld_Server as server,issues,a_dt_per,b_dt_per,a_Total_Downtime_Per,b_Total_Downtime_Per,a_brk_loss,b_brk_loss,a_Total_brok_loss,b_Total_brok_loss
 from 
(     
select     
case when x.server is null then y.server else x.server end as server,    
case when x.issues is null then y.issues else x.issues end as issues,    
isnull(x.dt_per,0) as a_dt_per,     
isnull(y.dt_per,0) as b_dt_per,     
isnull(x.Total_Issue_Per,0) as a_Total_Downtime_Per,     
isnull(y.Total_Issue_Per,0) as b_Total_Downtime_Per,     
isnull(x.brk_loss,0) as a_brk_loss,     
isnull(y.brk_loss,0) as b_brk_loss,     
isnull(x.Total_Issue_brok,0) as a_Total_brok_loss,     
isnull(y.Total_Issue_brok,0) as b_Total_brok_loss     
from    
(select * from tbl_comp_issue_1) x    
full outer join    
(select * from tbl_comp_issue_2) y    
on x.server = y.server and x.issues = y.issues 
) x left outer join
(select * from tbl_Server_master) y on x.server = y.Fld_Id    
order by issues,isnull(a_Total_Downtime_Per,0)+  
isnull(b_Total_Downtime_Per,0)+isnull(a_Total_brok_loss,0)+isnull(b_Total_brok_loss,0)  desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT(@fdate as varchar(15),@tdate as varchar(15))  
as  
  
select server,Issues,dt=sum(convert(dec,dt)),uptime=sum(convert(dec,uptime)),  
dt_per = (sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),  
brk_loss=convert(varchar(15),sum(brk_loss)) from terminal_brok_loss where   
Sauda_date >= @fdate and Sauda_date <= @tdate  and issues <> ''
group by Issues,server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_1
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT_1(@fdate as varchar(15),@tdate as varchar(15))    
as    
  
select a.server,a.issues,a.dt,b.uptime,dt_per = (sum(convert(dec,a.dt))*100)/sum(convert(dec,b.uptime)),a.brk_loss from  
(select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss))  
from terminal_brok_loss where server in (select distinct server from terminal_brok_loss   
where Sauda_date >= @fdate and Sauda_date <= @tdate and issues <> '') and dt <> 0  
and Sauda_date >= @fdate and Sauda_date <= @tdate group by server,issues) a inner join  
(select server,uptime=sum(convert(dec,uptime)) from terminal_brok_loss where   
Sauda_date >= @fdate and Sauda_date <= @tdate and server in   
(select distinct server from terminal_brok_loss where Sauda_date >= @fdate  
and Sauda_date <= @tdate and issues <> '') and Sauda_date >= @fdate and Sauda_date <= @tdate group by server) b  
on a.server = b.server  group by a.server,a.issues,a.dt,b.uptime,  a.brk_loss

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_2
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT_2(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15))            
as      
  
--   
-- declare @fdate as varchar(11)                
-- declare @tdate as varchar(11)                
  
declare @sql as varchar(5000)                
declare @opt as varchar(500)                
--declare @server as varchar(500)                
--                 
-- set @fdate = 'Jun 01 2007'                
-- set @tdate = 'Jun 15 2007'                
-- set @server = 'Baroda'                

set @fdate = convert(varchar(11),convert(datetime,@fdate,103))          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))          

                
set  @opt = (select                                      
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                 
      
set @sql = 'select c.server,c.issues,c.dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss from      
(select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss))   
from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues ) c      
inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in       
'+@opt+') a inner join ( select segment,uptime from ( select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''    
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''      
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''      
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''      
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''      
) x) b on a.segment = b.segment group by a.server ) d on c.server = d.server'      
exec (@sql)  
  
  
-- select c.server,c.issues,c.dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss from      
-- (select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss)) from terminal_brok_loss where  sauda_date >= @fdate and sauda_date <= @tdate and dt <> 0  group by server,issues ) c      
-- inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in       
-- (select distinct server from terminal_brok_loss where sauda_date >= @fdate and sauda_date <= @tdate and dt <> 0)) a      
-- inner join ( select segment,uptime from ( select 'ABLCM' as segment, Uptime=sum(bse) from sett_mst where tdate >= @fdate and tdate <= @tdate    
-- union SELECT 'ACDLCM' as segment, sum(cm) from sett_mst where tdate >= @fdate and tdate <= @tdate      
-- union SELECT 'ACDLFO' as segment,sum(fo) from sett_mst where tdate >= @fdate and tdate <= @tdate      
-- union SELECT 'ACPLMCX' as segment, sum(mcx) from sett_mst where tdate >= @fdate and tdate <= @tdate      
-- union SELECT 'ACPLNCDEX' as segment, sum(NCDEX) from sett_mst where tdate >= @fdate and tdate <= @tdate      
-- ) x) b on a.segment = b.segment group by a.server ) d on c.server = d.server      
--

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_2_test
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT_2_test(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15))              
as        
    
--     
-- declare @fdate as varchar(11)                  
-- declare @tdate as varchar(11)                  
    
declare @sql as varchar(5000)                  
declare @opt as varchar(500)                  
--declare @server as varchar(500)                  
--                   
-- set @fdate = 'Jun 01 2007'                  
-- set @tdate = 'Jun 15 2007'                  
-- set @server = 'Baroda'                  
  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))            
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))            
  
                  
set  @opt = (select                                        
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                   
        
set @sql = 'select c.server,c.issues,c.dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss from        
(select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss))     
from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues ) c        
inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in         
'+@opt+') a inner join ( select segment,uptime from ( select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''      
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''        
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''        
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''        
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''        
) x) b on a.segment = b.segment group by a.server ) d on c.server = d.server'     

print @sql   
exec (@sql)    
    
    
-- select c.server,c.issues,c.dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss from        
-- (select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss)) from terminal_brok_loss where  sauda_date >= @fdate and sauda_date <= @tdate and dt <> 0  group by server,issues ) c        
-- inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in         
-- (select distinct server from terminal_brok_loss where sauda_date >= @fdate and sauda_date <= @tdate and dt <> 0)) a        
-- inner join ( select segment,uptime from ( select 'ABLCM' as segment, Uptime=sum(bse) from sett_mst where tdate >= @fdate and tdate <= @tdate      
-- union SELECT 'ACDLCM' as segment, sum(cm) from sett_mst where tdate >= @fdate and tdate <= @tdate        
-- union SELECT 'ACDLFO' as segment,sum(fo) from sett_mst where tdate >= @fdate and tdate <= @tdate        
-- union SELECT 'ACPLMCX' as segment, sum(mcx) from sett_mst where tdate >= @fdate and tdate <= @tdate        
-- union SELECT 'ACPLNCDEX' as segment, sum(NCDEX) from sett_mst where tdate >= @fdate and tdate <= @tdate        
-- ) x) b on a.segment = b.segment group by a.server ) d on c.server = d.server        
--

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_3
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT_3(@fdate as varchar(15),@tdate as varchar(15))          
as    

declare @str as varchar(2000)
-- declare @fdate as varchar(2000)
-- declare @tdate as varchar(2000)
-- 
-- set @fdate = 'Jun 01 2007'
-- set @tdate = 'Jun 25 2007'

set @str = 'select c.server,c.issues,c.dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss)) 
from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and  sauda_date <= '''+@tdate+'''  and dt <> 0 group by server,issues union select Location,problem,sum(convert(dec,downtime)),''0'' from newtab1 
where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and ImpactedSegemnt <> ''None'' and location not in (select distinct server from  terminal_brok_loss where  
sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  and dt <> 0 )group by Location,problem ) c  inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from 
( select distinct server,segment from terminals where server in  (select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and 
server in (select distinct location from newtab1 where dt >= '''+@fdate+''' and dt <= '''+@tdate+'''))) a inner join ( select segment,uptime from ( select ''ABLCM'' as segment, Uptime=sum(bse) 
from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where 
tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' ) x )b 
on a.segment = b.segment group by a.server ) d on d.server = c.server'
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_4
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT_4(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15))                  
as      
      
-- declare @fdate as varchar(11)                      
-- declare @tdate as varchar(11)                      
-- declare @server as varchar(500)                      
        
declare @sql as varchar(5000)                      
declare @opt as varchar(500)                      
      
      
-- set @fdate = 'Sep 01 2007'                      
-- set @tdate = 'Sep 30 2007'                      
-- set @server = 'baroda'                      
                      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))              
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))              
    
    
set  @opt = (select                                            
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                       
      
set @sql = 'select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage from      
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from      
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''      
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),      
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e       
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''       
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from       
(select distinct server,segment from terminals where server in  '+@opt+')a inner join (select segment,uptime from(select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''        
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''       
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' )      
x)b on a.segment = b.segment group by a.server)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from      
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per      
inner join(select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in             
'+@opt+') a inner join(select segment,uptime from (select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''        
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''            
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''             
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''             
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+''' )      
x) b on a.segment = b.segment group by a.server) uptime on dt_per.server = uptime.server) v on z.server = v.server      
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q      
on p.server = q.server order by p.server'      
EXEC (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_5
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT_5(@server as varchar(100),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))              
as        
    
--     
--declare @fdate as varchar(11)                  
--declare @tdate as varchar(11)                  
    
declare @sql as varchar(5000)                  
declare @opt as varchar(500)                  
declare @opt1 as varchar(500)   
--declare @server as varchar(500)                  
  
/*                
set @fdate = 'Jun 09 2008'                  
set @tdate = 'Jun 09 2008'                  
set @server = 'ALL'                  
*/
  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))            
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))            
  
                  
set  @opt = (select                                        
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                   

set  @opt1 = (select                                          
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end ))   
        
set @sql = 'select Fld_Server as server,Fld_id,issues,dt,uptime,dt_per,brk_loss from (select c.server,c.issues,c.dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss from        
(select server,issues,dt=sum(convert(dec,dt)),brk_loss=convert(varchar(15),sum(brk_loss))     
from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues ) c        
inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_id as server,Fld_segment as  segment from V_Manager_Details where Fld_id in         
'+@opt+') a inner join (select Segment,uptime from  V_Segment_Master (nolock) where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''
) b on a.segment = b.segment group by a.server ) d on c.server = d.server) x inner join (select * from V_Server_Master (nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by Fld_Server'        
--print @sql

exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_Issuewise
-- --------------------------------------------------
CREATE proc USP_ISSUE_RPT_Issuewise(@server as varchar(100),@fdate as varchar(15),@tdate as varchar(15),@issues as varchar(100))                            
as                
              
/*  
declare @fdate as varchar(11)                                
declare @tdate as varchar(11)                                
declare @server as varchar(500)                                
declare @issues as varchar(500)     
    
*/    
set nocount on      
                  
declare @sql as varchar(5000)                                
declare @opt as varchar(500)                                        
        
/*              
set @fdate = 'Sep 01 2007'                                
set @tdate = 'Sep 30 2007'                                
set @server = 'ALL'                                  
set @issues = 'Angel'     
*/  
        
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                        
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                        
              
              
set  @opt = (select                                                  
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                                 
  
set @issues = (case when @issues = 'ALL' then 'like ''%%''' else  '='''+@issues+'''' end )  
                
set @sql = 'select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage into #Serverwise_rpt from                
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from                
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),                
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e                 
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                 
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.server,uptime=sum(convert(dec,b.uptime)) from                 
(select distinct server,segment from terminals where server in  '+@opt+')a inner join (select segment,uptime from(select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                    
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                    
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                  
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''                 
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' )                
x)b on a.segment = b.segment group by a.server)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from                
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                
inner join(select a.server,uptime=sum(convert(dec,b.uptime)) from (select distinct server,segment from terminals where server in                       
'+@opt+') a inner join(select segment,uptime from (select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                  
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                    
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                       
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+'''                       
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >=  '''+@fdate+''' and tdate <= '''+@tdate+''' )                
x) b on a.segment = b.segment group by a.server) uptime on dt_per.server = uptime.server) v on z.server = v.server                
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                
on p.server = q.server order by p.server;        
select a.*,b.Total_issue_dt,b.Total_issue_per,b.Total_issue_brok from        
( select * from #Serverwise_rpt where issues '+@issues+') a inner join        
(select Issues,sum(dt) as Total_issue_dt,sum(dt_per) as Total_issue_per,sum(convert(dec,Brk_Loss)) as Total_issue_brok from #Serverwise_rpt group by Issues) b        
on a.Issues = b.issues order by a.issues'        
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ISSUE_RPT_Issuewise_1
-- --------------------------------------------------




CREATE proc USP_ISSUE_RPT_Issuewise_1(@server as varchar(100),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15),@issues as varchar(100))                                  
as                      
                    
--     
-- declare @fdate as varchar(11)                                      
-- declare @tdate as varchar(11)                                      
-- declare @server as varchar(500)                                      
-- declare @issues as varchar(500)           
--           
    
set nocount on            
                        
declare @sql as varchar(5000)                                      
declare @opt as varchar(500)                                              
declare @opt1 as varchar(500)     
              
--     
-- set @fdate = 'Jun 09 2008'                                      
-- set @tdate = 'Jun 09 2008'                                      
-- set @server = 'ALL'                                        
-- set @issues = 'ALL'           
    
              
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                              
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                              
                    
                    
set  @opt = (select                                                        
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                                       
        
set @issues = (case when @issues = 'ALL' then 'like ''%%''' else  '='''+@issues+'''' end )        
set @opt1 = (case when @branch = 'ALL' then 'like ''%%''' else  '='''+@branch+'''' end )        
                      
set @sql =     
'select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage into #Serverwise_rpt from                      
(select z.*,v.Total_DownTime_Per from(select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from                      
(select g.Total_Brok_Loss,h.* from(select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                      
and dt <> 0  group by server)g inner join(select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from (select server,issues,dt=sum(convert(dec,dt)),                      
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues)e                       
inner join(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                       
and dt <> 0  group by server)f on e.server = f.server) h on g.server = h.server)c inner join (select a.Fld_id as server,uptime=sum(convert(dec,b.uptime)) from                       
(select distinct Fld_id,FLD_segment from V_Manager_Details where Fld_id in '+@opt+')a inner join (select segment,uptime from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''')b     
on a.FLD_segment = b.segment group by a.Fld_id)d on c.server = d.server) z inner join (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from                      
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                      
inner join(select a.Fld_id as server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_id,FLD_segment from V_Manager_Details where Fld_id in     
'+@opt+') a inner join(select segment,uptime from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''') b on a.FLD_segment = b.segment group by a.Fld_id)     uptime on dt_per.server = uptime.server) v on z.server = v.server          
            
) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                      
on p.server = q.server order by p.server;              
select Fld_server as server,issues,dt,Fld_id,Total_dt,uptime,dt_per,brk_loss,Total_Brok_loss,Total_DownTime_Per,Total_Brokerage,Total_issue_dt,Total_issue_per,Total_issue_brok from(    
select a.*,b.Total_issue_dt,b.Total_issue_per,b.Total_issue_brok from              
( select * from #Serverwise_rpt where issues '+@issues+') a inner join              
(select Issues,sum(dt) as Total_issue_dt,sum(dt_per) as Total_issue_per,sum(convert(dec,Brk_Loss)) as Total_issue_brok from #Serverwise_rpt group by Issues) b              
on a.Issues = b.issues ) x inner join (select * from V_Server_Master (nolock)) y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by x.issues'        

print @sql           
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_DATA
-- --------------------------------------------------
CREATE proc USP_IT_DATA
(
@complainton as varchar(11),
@Location as varchar(100),
@Timef as varchar(50),
@Timet as varchar(50),
@Eventp as varchar(1000),
@Solution as varchar(5000),
@Problem as varchar(5000),
@downtimemin as varchar(100),
@BSE as varchar(10),
@NSE as varchar(10),
@NSEFo as varchar(10),
@MCX as varchar(10),
@NCDEX as varchar(10),
@NONE as varchar(10)
)

-- declare @complainton as datetime
-- declare @Location as varchar(100)
-- declare @Timef as varchar(50)
-- declare @Timet as varchar(50)
-- declare @Eventp as varchar(1000)
-- declare @Solution as varchar(5000)
-- declare @Problem as varchar(5000)
-- declare @Segment as varchar(100)
-- declare @downtimemin as varchar(100)
-- declare @BSE as varchar(10)
-- declare @NSE as varchar(10)
-- declare @NSEFo as varchar(10)
-- declare @MCX as varchar(10)
-- declare @NCDEX as varchar(10)
-- declare @NONE as varchar(10)
AS

declare @Str as varchar(7000)
/*
declare @complainton as varchar(11)
declare @Location as varchar(100)
declare @Timef as varchar(50)
declare @Timet as varchar(50)
declare @Eventp as varchar(1000)
declare @Solution as varchar(5000)
declare @Problem as varchar(5000)
declare @Segment as varchar(100)
declare @downtimemin as varchar(100)
declare @BSE as varchar(10)
declare @NSE as varchar(10)
declare @NSEFo as varchar(10)
declare @MCX as varchar(10)
declare @NCDEX as varchar(10)
declare @NONE as varchar(10)
declare @Str as varchar(7000)

set @complainton = 'Aug 1 2007'
set @Location = 'Ahmedabad'
set @Timef = '1:00 AM'
set @Timet =  '1:00 AM'
set @Eventp = 'tEST'
set @Solution = 'tEST'
set @Problem = 	''  
set @downtimemin = '0'
set @BSE = 'on'
set @NSE = 'on'
set @NSEFo = 'on'
set @MCX = 'on'
set @NCDEX = 'on' 
*/

Set @Str = (Select             
 (case  
		--bse+nse+fo+mcx+ncdex           
	when @BSE = 'on' and @NSE = 'on' and @NSEFo = 'on' and @MCX = 'on' and @NCDEX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'				
		--bse+nse+fo+mcx
	when @BSE = 'on' and @NSE = 'on' and @NSEFo = 'on' and @MCX = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'	
		--bse+nse+fo
	when @BSE = 'on' and @NSE = 'on' and @NSEFo = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--bse+nse
	when @BSE = 'on' and @NSE = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--bse+fo
	when @BSE = 'on' and @NSEFo = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--bse+mcx
	when @BSE = 'on' and @MCX = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--bse+ncdex
	when @BSE = 'on' and @NCDEX = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--bse
	when @BSE = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''BSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--nse+fo+mcx+ncdex           
	when @NSE = 'on' and @NSEFo = 'on' and @MCX = 'on' and @NCDEX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'				
		--nse+fo+mcx
	when @NSE = 'on' and @NSEFo = 'on' and @MCX = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'	
		--nse+fo
	when @NSE = 'on' and @NSEFo = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--nse+mcx           
	when @NSE = 'on' and @MCX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--nse+ncdex
	when @NSE = 'on' and @NCDEX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--nse
	when @NSE = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSECM'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
	
		--fo+mcx+ncdex           
	when @NSEFo = 'on' and @MCX = 'on' and @NCDEX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'				
		--fo+mcx
	when @NSEFo = 'on' and @MCX = 'on'  then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--fo+ncdex
	when @NSEFo = 'on' and @NCDEX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFO'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'				
		--fo	
	when @NSEFo = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NSEFo'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
		--mcx+ncdex
	when  @MCX = 'on' and @NCDEX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''');
		insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'				
		--mcx	
	when  @MCX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''MCX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'

	when  @NCDEX = 'on' then 
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NCDEX'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'
	
	when  @NONE = 'on' then 		
		'insert into newTab1 values ('''+@complainton+''','''+@Location+''','''+@Timef+''','''+@Timet+''','''+@Eventp+''','''+@Solution+''','''+@Problem+''',''NONE'''+','+'datediff(minute,'''+@Timef+''','''+@Timet+'''),'''+@downtimemin+''')'

	 end)
 )                      

exec(@Str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_IT_ExcelReportSendMail
-- --------------------------------------------------
CREATE PROC [dbo].[Usp_IT_ExcelReportSendMail]   
AS   
  DECLARE  @rc INT   
     
  IF NOT EXISTS (SELECT *   
                 FROM   intranet.msdb.sys.service_queues   
                 WHERE  name = N'ExternalMailQueue'   
                        AND is_receive_enabled = 1)   
    EXEC @rc = intranet.msdb.dbo.Sysmail_start_sp   
     
  DECLARE  @path  AS VARCHAR(100)   
     
  SET @path = (SELECT uploadserver   
               FROM   [CSOKYC-6].upload.dbo.global_upload   
               WHERE  upd_srno = 2)   
     
  --print @path   
  TRUNCATE TABLE tbl_aotd_mail   
     
  DECLARE  @mess  AS VARCHAR(5000)   
     
  DECLARE  @s   AS VARCHAR(4000),   
           @s1  AS VARCHAR(4000)   
     
  DECLARE  @tag  VARCHAR(50),   
           @tag1 VARCHAR(50),   
           @tag2 VARCHAR(50)   
     
  SET @tag = 'AOTDReport'   
     
  SET @tag1 = 'ShrinkReport'   
     
  SET @tag2 = 'TCPCountReport'   
     
  SET @mess = 'Dear Sir/Madam,<Br><Br>  
  
    Please find the attached file which contain the below given Reports data in Excel.<Br><Br>  
    1. AOTD Report<Br>                                                                            
    2. Database Shrink Report<Br>                                                                                 
    3. TCP Count Report<Br><BR>                           
  
    Regards<Br>    
    IT Helpdesk.'   
  --------------------------Pending Reports---------------------------------------------------------  
--    4. UPS Load Reading <Br>                          
--    5. Order Confirmation Status<Br>                            
--    6. Client MIS Summary <Br><Br>                                
  
  -----------------------------------AOTD Report-------------------------------------   
  INSERT INTO tbl_aotd_mail   
  VALUES     ('Complain No',   
              'Date',   
              'Connectivity',   
              'CircuitId',   
              'Descrip',   
              'MediumInfo',   
              'Action',   
              'Timefrm',   
              'TimeTo',   
              'Link_dntime',   
              'Business_dntime',   
              '[Backup]',   
              'Impact',   
              'Location',   
              'Loc',   
              'Reason',   
              'LastUpdate',   
              'Status',   
              '[DateTime]',   
              'CompletedTime',   
              'Username',   
              '[Accesscode]')   
     
  INSERT INTO tbl_aotd_mail   
  SELECT *   
  FROM   mis.helpdesk.dbo.tbl_aotd   
  WHERE  fld_date = Convert(VARCHAR(11),Getdate() - 2,109)   
     
  SET @s = 'exec MASTER.dbo.xp_cmdshell ' + '''' + 'bcp  "select * from mis.helpdesk.dbo.tbl_aotd_mail" queryout ' + @path + '\ITReport\' + @tag + '.xls -c -Sintranet -Usa -Pnirwan612'   
     
  SET @s1 = @s + ''''   
     
  EXEC( @s1)   
     
  -----------------------------------Shrink Report-------------------------------------   
  DECLARE  @date VARCHAR(25)   
     
  SET @date = (SELECT Convert(DATETIME,Convert(VARCHAR,Max(fld_upd_date)),   
                              103)   
               FROM   tbl_db_shrink_data_new (nolock))   
     
  --print @date   
  TRUNCATE TABLE tbl_db_shrink_mail   
     
  INSERT INTO tbl_db_shrink_mail   
  VALUES     ('Branch name',   
              'Server Name',   
              'DataBase IP',   
              'Odin IP',   
              'Branch Code',   
              'Mdf Capacity of Drive(in GB)',   
              'Mdf Before Query(in GB)',   
              'Mdf After Query(in GB)',   
              'Mdf Disk Drive',   
              'Mdf Free Space(in GB)',   
              'Ldf Capacity of Drive(in GB)',   
              'Ldf Before Query(in GB)',   
              'Ldf After Query(in GB)',   
              'Ldf Disk Drive',   
              'Ldf Free Space(in GB)',   
              'Remark',   
              'Updated By',   
              'Updated Date',   
              'Server id')   
     
  INSERT INTO tbl_db_shrink_mail   
  SELECT   b.br_name,   
           a.*   
  FROM     (SELECT b.fld_server,   
                   b.fld_db_ip,   
               b.fld_odin_ip,   
                   a.*   
            FROM   (SELECT fld_branch_id,   
                           fld_mdf_cod,   
                           fld_mdf_bq,   
                           fld_mdf_aq,   
                           fld_mdf_dd,   
                           fld_mdf_fs,   
                           fld_ldf_cod,   
                           fld_ldf_bq,   
                           fld_ldf_aq,   
                           fld_ldf_dd,   
                           fld_ldf_fs,   
                           fld_remark,   
                           fld_upd_by,   
                           fld_upd_date,   
                           fld_server_id   
                    FROM   tbl_db_shrink_data_new (nolock)   
                    WHERE  fld_upd_date = @date) a   
                   LEFT OUTER JOIN (SELECT fld_id,   
                                           fld_server,   
                                           fld_db_ip,   
                                           fld_odin_ip   
                                    FROM   v_tbl_server_master (nolock)) b   
                     ON a.fld_server_id = b.fld_id) a   
           LEFT OUTER JOIN (SELECT br_tag,   
                                   br_name   
                            FROM   tbl_it_br_master (nolock)   
                            WHERE  br_type = 'DATACENTER') b   
             ON a.fld_branch_id = b.br_tag   
  ORDER BY b.br_name,   
           a.fld_server   
     
  SET @s = 'exec MASTER.dbo.xp_cmdshell ' + '''' + 'bcp  "select * from mis.Helpdesk.dbo.tbl_DB_Shrink_Mail" queryout ' + @path + '\ITReport\' + @tag1 + '.xls -c -Sintranet -Usa -Pnirwan612'   
     
  SET @s1 = @s + ''''   
     
  EXEC( @s1)   
     
  -----------------------------------TCP Count Report-------------------------------------   
  DECLARE  @Fld_Branch_cd VARCHAR(15)   
     
  DECLARE  @Fld_FldDate VARCHAR(11)   
     
  SET @Fld_Branch_cd = '%%'   
     
  SET @Fld_FldDate = (SELECT Getdate() - 2)   
     
  PRINT @Fld_FldDate   
     
  SELECT   s,   
           fld_id,   
           fld_server,   
           fld_branch_cd,   
           Upper(br_name)                          AS br_name,   
           Isnull(Convert(VARCHAR,fld_tcp_1015),0) fld_tcp_1015,   
           Isnull(Convert(VARCHAR,fld_tcp_0115),0) fld_tcp_0115,   
           Isnull(Convert(VARCHAR,fld_tcp_0315),0) fld_tcp_0315,   
           Isnull(Convert(VARCHAR,fld_sur_cnt),0)  fld_sur_cnt,   
           Isnull(fld_remark,'')                   fld_remark,   
           fld_flddate,   
           sbs_ip,   
           remark,   
           person_name   
  INTO     #t   
  FROM     (SELECT *   
            FROM   v_tcp_servers   
            WHERE  fld_branch_cd LIKE @Fld_Branch_cd) x   
           LEFT OUTER JOIN (SELECT *   
                            FROM   v_tbl_tcp_count   
                            WHERE  fld_flddate = @Fld_FldDate) y   
             ON x.fld_branch_cd = y.fld_branch_code   
                AND x.server_id = y.fld_server_id   
                AND x.s = y.fld_flag   
  --order by   S,Fld_id   
  ORDER BY br_name,   
           s,   
           fld_server   
     
  TRUNCATE TABLE tbl_tcp_count_mail   
     
  SELECT *   
  FROM   tbl_tcp_count_mail   
     
  INSERT INTO tbl_tcp_count_mail   
  VALUES     ('Branch Name',   
              'Server Name',   
              'TCP 1015',   
              'TCP 0115',   
              'TCP 0315',   
              'Sur_cnt',   
              'Remark')   
     
  INSERT INTO tbl_tcp_count_mail   
  SELECT   br_name,   
           fld_server,   
           fld_tcp_1015,   
           fld_tcp_0115,   
           fld_tcp_0315,   
           fld_sur_cnt,   
           fld_remark   
  FROM     #t   
  WHERE    fld_branch_cd IN (SELECT fld_branch_code   
                             FROM   tbl_tcp_count   
                             WHERE  fld_flddate = @Fld_FldDate)   
  ORDER BY br_name,   
           fld_server   
     
  SET @s = 'exec MASTER.dbo.xp_cmdshell ' + '''' + 'bcp  "select * from mis.Helpdesk.dbo.Tbl_Tcp_Count_Mail" queryout ' + @path + '\ITReport\' + @tag2 + '.xls -c -Sintranet -Usa -Pnirwan612'   
     
  SET @s1 = @s + ''''   
     
  EXEC( @s1)   
     
  ----------------------------------------------------------------------------------------   
  DECLARE  @attach   AS VARCHAR(1000),   
           @attach1  AS VARCHAR(1000),   
           @attach2  AS VARCHAR(1000),   
           @attach3  AS VARCHAR(1000)   
     
  /*--set @attach='\\196.1.115.136\d$\upload1\ITReport\'+@tag+'.xls;\\196.1.115.136\d$\upload1\ITReport\'+@tag1+'.xls;\\196.1.115.136\d$\upload1\ITReport\'+@tag2+'.xls;' */   
  SET @attach = @path + '\ITReport\' + @tag + '.xls'   
     
  SET @attach1 = @path + '\ITReport\' + @tag1 + '.xls'   
     
  SET @attach2 = @path + '\ITReport\' + @tag2 + '.xls'   
     
  SET @attach3 = @attach + ';' + @attach1 + ';' + @attach2   
     
  EXEC intranet.msdb.dbo.Sp_send_dbmail   
    @recipients = 'bharti.mane@angeltrade.com' ,   
    --@recipients  = 'vinayk.pandey@angeltrade.com',                                                                                               
    --@copy_recipients=  'vinayk.pandey@angeltrade.com',   
    @blind_copy_recipients = 'vinayk.pandey@angeltrade.com' ,   
    @profile_name = 'intranet' ,   
    --@From ='vinayk.pandey@angeltrade.com',   
    @body_format = 'html' ,   
    @Subject = 'IT Reports' ,   
    @file_attachments = @attach3 ,   
    @body = @mess

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_HD_Rpt
-- --------------------------------------------------
CREATE Proc USP_IT_HD_Rpt                            
(@Fdate as varchar(11),                            
@Tdate as varchar(11),                                                    
@status as varchar(20),                            
@Category as varchar(20),                                                    
@code as varchar(30),                            
@entry_by as varchar(10),                                                    
@Branch as varchar(500),                            
@Call_Type as varchar(20),                        
@region as varchar(20)                        
)                                                    
as                                                   
                                      
 /*                                         
declare @Fdate as varchar(11)                                    
declare @Tdate as varchar(11)                                    
declare @status as varchar(11)                                    
declare @Category as varchar(20)                                    
declare @code as varchar(11)                                    
declare @entry_by as varchar(10)                                    
declare @Branch as varchar(500)                                    
declare @Call_Type as varchar(20)                                    
                                    
set @Fdate = 'Sep 01 2008'                                    
set @Tdate = 'Sep 10 2008'                                    
set @status = 'ALL'                                    
set @Category = 'ALL'                                    
set @code = ''                                    
set @entry_by = 'ALL'                                     
set @Branch = 'CSO'                                    
set @Call_Type = 'ALL' */                        
                                   
                                     
declare @str as varchar(5000)                                                  
                                                   
set @Fdate = convert(varchar(11),convert(datetime,@Fdate,103))                                                    
set @Tdate = convert(varchar(11),convert(datetime,@Tdate,103))                                                   
                                                        
set @status = (case when @status = 'ALL' then 'like ''%%' else ' = '+''''+@status+'' end)                                                   
set @Category = (case when @Category = 'ALL' then 'like ''%%' else ' = '+''''+@Category+'' end)                                                                           
--set @Branch = (case when @Branch = 'ALL' then 'like ''%%''' else ' = '+'replace('''+@Branch+''',''HO'',''CSO'')' end)                                     
set @Branch = (case when @region = 'ALL' and @Branch = 'ALL' then 'like ''%%''' else 'in (select br_tag from(select Br_Tag from v_tbl_it_br_master (nolock) where (br_region = '''+@region+''' or Reg_COde = '''+@region+''')and br_tag like replace('''+@Branch+''',''All'',''%%'')union select replace('''+@Branch+''',''All'','''+@region+'''))x)' end)                                     
set @Call_Type = (case when @Call_Type = 'ALL' or @Call_Type = '%%' then 'like ''%%' else ' = '+''''+@Call_Type+'' end)                                                   
set @code = (case when @code = '' then 'like ''%%' else ' = '+''''+@code+'' end)                                                   
set @entry_by = (case when @entry_by = 'ALL' or @entry_by = '%%' then 'like ''%%' else ' = '+''''+@entry_by+'' end)                                           
                                                    
set @str = 'SELECT x.*,y.person_name,                                              
--case when y.person_name is null then x.entry_by else y.person_name end as person_name,                                              
case when y.access_code is null then x.grp_id else y.access_code end as access_code                                              
 FROM                                                    
(                                                    
select distinct complaint_date,                         
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+subject+''</font></b>'' else subject end as subject,code                                      
,TIme_Limit,department,dsection, queryfrom,cat_city=city, contact_person,                                                    
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+problem+''</font></b>'' else problem end as problem,              
--case when TIme_Limit = ''Unsatisfied'' then ''<b>''+problem+''</b>'' else problem end as problem,                   
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+suggestion+''</font></b>'' else suggestion end as suggestion,                                         
remark,completed_on, status,complaintno, party_code,category,dremark,deptmarkcompleteddate as helpdeskmarkcompleteddate,                                                     
entry_by,it_conn,grp_id,deptmarkcompleteddate,cast(datediff(Minute,complaint_date, deptmarkcompleteddate) as varchar(50)) + ''Minutes'' as Minutes from                                                     
complaint_table (nolock) where complaint_date >='''+@Fdate+' 00:00:000'' and complaint_date <='''+@Tdate+' 23:59:000'' and                                                    
entered_through = ''IT'' and status '+@status+''' and category '+@Category+''' and code '+@code+''' and                                                     
entry_by '+@entry_by+''' and grp_id '+@Branch+' and call_type '+@Call_Type+'''                                                    
)X                                                    
LEFT OUTER JOIN                                            
(                                                                                  
SELECT person_name,USERNAME,access_code FROM INTRANET.RISK.DBO.USER_LOGIN                 
) Y ON X.entry_by = Y.USERNAME                                                    
order by complaint_date'                   
                  
--print @str                            
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_HD_Rpt_forward
-- --------------------------------------------------
CREATE Proc USP_IT_HD_Rpt_forward    
(@Fdate as varchar(11),    
@Tdate as varchar(11),                            
@status as varchar(20),    
@Category as varchar(20),                            
@code as varchar(11),    
@entry_by as varchar(10),                            
@Branch as varchar(50),    
@Call_Type as varchar(20))                            
as                           
              
  /*                     
declare @Fdate as varchar(11)            
declare @Tdate as varchar(11)            
declare @status as varchar(11)            
declare @Category as varchar(20)            
declare @code as varchar(11)            
declare @entry_by as varchar(10)            
declare @Branch as varchar(50)            
declare @Call_Type as varchar(20)            
            
set @Fdate = 'Jun 11 2008'            
set @Tdate = 'Jun 11 2008'            
set @status = 'ALL'            
set @Category = 'ALL'            
set @code = ''            
set @entry_by = 'ALL'             
set @Branch = 'HO'            
set @Call_Type = 'ALL'              
*/            
             
declare @str as varchar(5000)                          
                           
set @Fdate = convert(varchar(11),convert(datetime,@Fdate,103))                            
set @Tdate = convert(varchar(11),convert(datetime,@Tdate,103))                           
                                
set @status = (case when @status = 'ALL' then 'like ''%%' else ' = '+''''+@status+'' end)                           
set @Category = (case when @Category = 'ALL' then 'like ''%%' else ' = '+''''+@Category+'' end)                           
--set @Branch = (case when @Branch = 'ALL' then 'like ''%%' else ' = '+''''+@Branch+'' end)                           
set @Branch = (case when @Branch = 'ALL' then 'like ''%%''' else ' = '+'replace('''+@Branch+''',''HO'',''CSO'')' end)             
set @Call_Type = (case when @Call_Type = 'ALL' then 'like ''%%' else ' = '+''''+@Call_Type+'' end)                           
set @code = (case when @code = '' then 'like ''%%' else ' = '+''''+@code+'' end)                           
set @entry_by = (case when @entry_by = 'ALL' then 'like ''%%' else ' = '+''''+@entry_by+'' end)                        
                            
set @str = 'SELECT x.*,y.person_name,                      
--case when y.person_name is null then x.entry_by else y.person_name end as person_name,                      
case when y.access_code is null then x.grp_id else y.access_code end as access_code                      
 FROM                            
(                            
select distinct complaint_date,                
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+subject+''</font></b>'' else subject end as subject,code              
,TIme_Limit,department,dsection, queryfrom,cat_city=city, contact_person,                            
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+problem+''</font></b>'' else problem end as problem,                  
--case when TIme_Limit = ''Unsatisfied'' then ''<b>''+problem+''</b>'' else problem end as problem,                  
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+suggestion+''</font></b>'' else suggestion end as suggestion,                 
remark,completed_on, status,complaintno, party_code,category,dremark,deptmarkcompleteddate as helpdeskmarkcompleteddate,                             
entry_by,it_conn,grp_id,deptmarkcompleteddate,cast(datediff(Minute,complaint_date, deptmarkcompleteddate) as varchar(50)) + ''Minutes'' as Minutes from                             
complaint_table where complaint_date >='''+@Fdate+' 00:00:000'' and complaint_date <='''+@Tdate+' 23:59:000'' and                            
entered_through = ''IT'' and status '+@status+''' and category '+@Category+''' and code '+@code+''' and                             
entry_by '+@entry_by+''' and grp_id '+@Branch+' and call_type '+@Call_Type+''' and forwardto_dept <> ''''                            
)X                            
LEFT OUTER JOIN                    
(                            
SELECT * FROM INTRANET.RISK.DBO.USER_LOGIN where access_code '+@Branch+'                          
) Y ON X.entry_by = Y.USERNAME                            
order by complaint_date'                      
/*print @str            */  
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_HD_Rpt_New
-- --------------------------------------------------
CREATE Proc USP_IT_HD_Rpt_New  
(@Fdate as varchar(11),                
@Tdate as varchar(11),                                        
@status as varchar(20),                
@Category as varchar(20),                                        
@code as varchar(11),                
@entry_by as varchar(10),                                        
@Branch as varchar(500),                
@Call_Type as varchar(20),            
@region as varchar(20),           
@Court_Call_Type as varchar(20))                        
as                       
          
  /*                 
declare @Fdate as varchar(11)        
declare @Tdate as varchar(11)        
declare @status as varchar(11)        
declare @Category as varchar(20)        
declare @code as varchar(11)        
declare @entry_by as varchar(10)        
declare @Branch as varchar(50)        
declare @Call_Type as varchar(20)        
        
set @Fdate = 'Jun 11 2008'        
set @Tdate = 'Jun 11 2008'        
set @status = 'ALL'        
set @Category = 'ALL'        
set @code = ''        
set @entry_by = 'ALL'         
set @Branch = 'HO'        
set @Call_Type = 'ALL'          
*/        
         
declare @str as varchar(5000)                      
                       
set @Fdate = convert(varchar(11),convert(datetime,@Fdate,103))                        
set @Tdate = convert(varchar(11),convert(datetime,@Tdate,103))                       
                            
  
set @Court_Call_Type = (case when @Court_Call_Type = 'ALL'  then 'like ''%%' else ' = '+''''+@Court_Call_Type+'' end)       
set @status = (case when @status = 'ALL' then 'like ''%%' else ' = '+''''+@status+'' end)                       
set @Category = (case when @Category = 'ALL' then 'like ''%%' else ' = '+''''+@Category+'' end)                       
--set @Branch = (case when @Branch = 'ALL' then 'like ''%%' else ' = '+''''+@Branch+'' end)                       
set @Branch = (case when @Branch = 'ALL' then 'like ''%%''' else ' = '+'replace('''+@Branch+''',''HO'',''CSO'')' end)         
set @Call_Type = (case when @Call_Type = 'ALL' then 'like ''%%' else ' = '+''''+@Call_Type+'' end)                       
set @code = (case when @code = '' then 'like ''%%' else ' = '+''''+@code+'' end)                       
set @entry_by = (case when @entry_by = 'ALL' then 'like ''%%' else ' = '+''''+@entry_by+'' end)                    
                        
set @str = 'SELECT x.*,y.person_name,                  
--case when y.person_name is null then x.entry_by else y.person_name end as person_name,                  
case when y.access_code is null then x.grp_id else y.access_code end as access_code                  
 FROM                        
(                        
select distinct 
case when Fld_Courtesy_Call_Type = ''R'' then ''Rotated Calls'' else ''Daily Calls'' end as Fld_Courtesy_Call_Type,Fld_Con_Time,complaint_date,            
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+subject+''</font></b>'' else subject end as subject,code          
,TIme_Limit,department,dsection, queryfrom,cat_city=city, contact_person,                        
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+problem+''</font></b>'' else problem end as problem,              
--case when TIme_Limit = ''Unsatisfied'' then ''<b>''+problem+''</b>'' else problem end as problem,              
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+suggestion+''</font></b>'' else suggestion end as suggestion,             
remark,completed_on, status,complaintno,Fld_Server_Ip,party_code,category,dremark,deptmarkcompleteddate as helpdeskmarkcompleteddate,                         
entry_by,it_conn,grp_id,deptmarkcompleteddate,cast(datediff(Minute,complaint_date, deptmarkcompleteddate) as varchar(50)) + ''Minutes'' as Minutes from                         
v_complaint_table where complaint_date >='''+@Fdate+' 00:00:000'' and complaint_date <='''+@Tdate+' 23:59:000'' and                        
entered_through = ''IT'' and status '+@status+''' and category '+@Category+''' and code '+@code+''' and                         
entry_by '+@entry_by+''' and grp_id '+@Branch+' and call_type '+@Call_Type+'''   
and Fld_Courtesy_Call_Type '+@Court_Call_Type+'''                        
)X                        
LEFT OUTER JOIN                        
(                        
SELECT * FROM INTRANET.RISK.DBO.USER_LOGIN where access_code '+@Branch+'                         
) Y ON X.entry_by = Y.USERNAME                        
order by complaint_date'      
--print @str          
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_HD_Rpt_test
-- --------------------------------------------------
CREATE Proc USP_IT_HD_Rpt_test        
(@Fdate as varchar(11),              
@Tdate as varchar(11),                                      
@status as varchar(20),              
@Category as varchar(20),                                      
@code as varchar(11),              
@entry_by as varchar(10),                                      
@Branch as varchar(500),              
@Call_Type as varchar(20),          
@region as varchar(20),
@Courtesy_Type as varchar(10)
)                                      
as                                     
                        
 /*                           
declare @Fdate as varchar(11)                      
declare @Tdate as varchar(11)                      
declare @status as varchar(11)                      
declare @Category as varchar(20)                      
declare @code as varchar(11)                      
declare @entry_by as varchar(10)                      
declare @Branch as varchar(500)                      
declare @Call_Type as varchar(20)                      
                      
set @Fdate = 'Sep 01 2008'                      
set @Tdate = 'Sep 10 2008'                      
set @status = 'ALL'                      
set @Category = 'ALL'                      
set @code = ''                      
set @entry_by = 'ALL'                       
set @Branch = 'CSO'                      
set @Call_Type = 'ALL' */          
                     
                       
declare @str as varchar(5000)                                    
                                     
set @Fdate = convert(varchar(11),convert(datetime,@Fdate,103))                                      
set @Tdate = convert(varchar(11),convert(datetime,@Tdate,103))                                     

set @Courtesy_Type = (case when @Courtesy_Type = 'All' or @Courtesy_Type = '' then 'like ''%%' else ' = '+''''+@Courtesy_Type+'' end)                                          
set @status = (case when @status = 'ALL' then 'like ''%%' else ' = '+''''+@status+'' end)                                     
set @Category = (case when @Category = 'ALL' then 'like ''%%' else ' = '+''''+@Category+'' end)                                                             
--set @Branch = (case when @Branch = 'ALL' then 'like ''%%''' else ' = '+'replace('''+@Branch+''',''HO'',''CSO'')' end)                       
set @Branch = (case when @region = 'ALL' and @Branch = 'ALL' then 'like ''%%''' else 'in (select br_tag from(select Br_Tag from tbl_it_br_master (nolock) where br_region = '''+@region+''' and br_tag like replace('''+@Branch+''',''All'',''%%'')union select replace('''+@Branch+''',''All'','''+@region+'''))x)' end)                       
set @Call_Type = (case when @Call_Type = 'ALL' then 'like ''%%' else ' = '+''''+@Call_Type+'' end)                                     
set @code = (case when @code = '' then 'like ''%%' else ' = '+''''+@code+'' end)                                     
set @entry_by = (case when @entry_by = 'ALL' then 'like ''%%' else ' = '+''''+@entry_by+'' end)                             
                                      
set @str = 'SELECT x.*,y.person_name,                                
--case when y.person_name is null then x.entry_by else y.person_name end as person_name,                                
case when y.access_code is null then x.grp_id else y.access_code end as access_code                                
 FROM                                      
(                                      
select distinct complaint_date,                          
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+subject+''</font></b>'' else subject end as subject,code                        
,TIme_Limit,department,dsection, queryfrom,cat_city=city, contact_person,                                      
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+problem+''</font></b>'' else problem end as problem,                            
--case when TIme_Limit = ''Unsatisfied'' then ''<b>''+problem+''</b>'' else problem end as problem,                            
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+suggestion+''</font></b>'' else suggestion end as suggestion,                           
remark,completed_on, status,complaintno, party_code,category,dremark,deptmarkcompleteddate as helpdeskmarkcompleteddate,                                       
entry_by,it_conn,grp_id,deptmarkcompleteddate,cast(datediff(Minute,complaint_date, deptmarkcompleteddate) as varchar(50)) + ''Minutes'' as Minutes from                                       
complaint_table where complaint_date >='''+@Fdate+' 00:00:000'' and complaint_date <='''+@Tdate+' 23:59:000'' and                                      
entered_through = ''IT'' and status '+@status+''' and category '+@Category+''' and code '+@code+''' and                                       
entry_by '+@entry_by+''' and grp_id '+@Branch+' and call_type '+@Call_Type+''' and Fld_Courtesy_Call_Type '+@Courtesy_Type+'                                      
)X                                      
LEFT OUTER JOIN                              
(                                                                    
SELECT * FROM INTRANET.RISK.DBO.USER_LOGIN   
) Y ON X.entry_by = Y.USERNAME                                      
order by complaint_date'     
    
--print @str              
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_it_inventory
-- --------------------------------------------------
--sp_helptext it_inventory_entry  
--exec it_inventory_entry '198','All','DATACENTER','2011','May'  
  
CREATE proc USP_it_inventory             
(            
@br_id as varchar(15),            
@desktops as varchar(15),            
@desktop_server as varchar(15),            
@branded_server as varchar(15),            
@laptops as varchar(15),            
@enteredby as varchar(15),            
@remark as varchar(100),          
@year as varchar(15),            
@month as varchar(15)              
)            
                
as            
declare @count int            
if @desktops=''        
begin         
set @desktops='0'        
end        
if @desktop_server=''        
begin         
set @desktop_server='0'        
end        
if @branded_server=''        
begin         
set @branded_server='0'        
end        
if @laptops=''        
begin         
set @laptops='0'        
end        
select @count=count(*) from tbl_it_inventory where br_id =@br_id  and year=@year and month=@month          
if @count >=  1            
begin            
  if(select count(*) from tbl_it_inventory where desktops = ltrim(rtrim(@desktops)) and desktop_server = ltrim(rtrim(@desktop_server))            
   and branded_server =  ltrim(rtrim(@branded_server)) and laptops = ltrim(rtrim(@laptops)) and  remark = ltrim(rtrim(@remark)) and br_id = @br_id and year=@year and month=@month) = 0            
   begin       
if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@enteredby) = 'ADMIN'         
Begin            
    update tbl_it_inventory            
    set desktops = ltrim(rtrim(@desktops)),            
  desktop_server = ltrim(rtrim(@desktop_server)),            
  branded_server = ltrim(rtrim(@branded_server)),            
  laptops = ltrim(rtrim(@laptops)),             
  enteredby = ltrim(rtrim(@enteredby)),            
  remark = ltrim(rtrim(@remark)),            
  updatedon = getdate() where br_id = @br_id  and year=@year and month=@month   
    
  
End     
   end            
end            
else            
begin            
  insert into tbl_it_inventory values            
  (@br_id,ltrim(rtrim(@desktops)),ltrim(rtrim(@desktop_server)),ltrim(rtrim(@branded_server)),ltrim(rtrim(@laptops)),            
        @enteredby,getdate(),ltrim(rtrim(@remark)),getdate(),@year,@month)    
          
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_IT_Inventory_Report
-- --------------------------------------------------
--Usp_IT_Inventory_Report 'ALL','CSO' ,'%%','2011','ALL'
CREATE Proc [dbo].[Usp_IT_Inventory_Report]
(
	@fld_branch varchar(20),
	@Fld_CSO varchar(15),
	@Br_Type as varchar(20),
	@year varchar(11),
	@month varchar(11)
)                            
as                    
                          
               
if  @Fld_CSO='Broker'                    
begin                    
  select srno,upper(br_name+'-('+br_tag+')') as Branch,Br_Type,desktops,desktop_server,                    
  branded_server,laptops,                    
  Total=convert(int,desktops)+convert(int,desktop_server)+convert(int,branded_server)+convert(int,laptops),                  
  Remark,convert(varchar(11),UpdatedOn,103) as  [Update On],month+'-'+year as date,person_name 
  from V_IT_Inventory_Rpt (nolock) 
  where Br_Type like @Br_Type and year=@year and month like @month  order by br_type                        
end                     
else                    
begin                    
  create table #t                          
  (                          
  Sr_No int,                          
  Br_tag varchar(150),                          
  Br_Name varchar(500)                          
  )                                       
                            
  if @fld_branch = 'All'                          
                            
  begin                          
   insert into #t                          
   exec USP_WAN_Search_Branch @Fld_CSO                          
  end                          
  else                          
  begin                          
   insert into #t                          
   select @fld_branch,'',''                          
  end                          
                            
                                    
  select *,srno,upper(br_name+'-('+br_tag+')') as Branch , Br_Type ,desktops,desktop_server,                    
  branded_server,laptops,                    
  Total=convert(int,desktops)+convert(int,desktop_server)+convert(int,branded_server)+convert(int,laptops) ,                  
  Remark,convert(varchar(11),UpdatedOn,103) as [Update On],month+'-'+year as date,person_name            
  from V_IT_Inventory_Rpt (nolock) where br_id in (select Sr_No from #t) and Br_Type like @Br_Type  
  and year=@year and month like @month order by V_IT_Inventory_Rpt.Br_Type                       
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_IT_Inventory_Report_NotUpdate
-- --------------------------------------------------
--Usp_IT_Inventory_Report_NotUpdate 'Broker','','','2011','%'
CREATE Proc [dbo].[Usp_IT_Inventory_Report_NotUpdate]
(
	@fld_branch varchar(20),
	@Fld_CSO varchar(15),
	@Br_Type as varchar(20),
	@year varchar(11),
	@month varchar(11)
)                            
as   
Begin
               
if  @Fld_CSO='Broker'                    
begin 


     --Select  b.Br_Tag ,  b.Br_Name  , b.Br_Region , 
     --a.Br_Name as Br_type
     --from tbl_it_br_master  a 
     --right outer join   tbl_it_br_master b on a.Br_Tag=b.Br_Region
     --where
     --a.Br_Status='A' and a.sr_no not in(select br_id from tbl_it_inventory(nolock) 
     --where year=@year and month='%' 
     --order by  b.Br_Tag
     If(@month<> '%')
     Begin 
     Select   br_tag  , Br_Name ,
		(case when Br_Region ='CSO' then Br_Name  
		when Br_Region ='BNG' then 'Bangalore'
		when Br_Region ='BOK' then 'Bank Of Karad'
		when Br_Region ='CMBTR' then 'Coimbatore'
		when Br_Region ='DELHI' then 'Delhi'
		when Br_Region ='HO' then 'AKRUTI' 
		when Br_Region ='INDO' then 'Indore'
		when Br_Region ='KOLK' then 'Kolkata'
		when Br_Region ='JAIP' then 'Jaipur'
		when Br_Region ='LUCK' then 'Lucknow'
		when Br_Region ='LUDHN' then 'LUDHIANA'
		when Br_Region ='NAGPR' then 'Nagpur'
		when Br_Region ='NASIK' then 'NASIK'
		when Br_Region ='PTN' then 'PATNA'
		when Br_Region ='RRO' then 'Rajkot (Star-301)'
		when Br_Region ='VD' then 'Baroda'
		when Br_Region ='XPU' then 'Pune'
		when Br_Region ='XS' then  'Surat'
		when Br_Region ='CHEN' then  'CHENNAI - ALWARPET'
		when Br_Region ='YA' then 'AHMEDABAD (MAHALAY)' else  '' end) as Br_type
		from tbl_it_br_master 
		where
		Br_Status='A' and sr_no not in(select br_id from tbl_it_inventory(nolock) where year=@year and month=@month) 
		order by  Br_Tag  
	 End	
	 Else
	 Begin
	 Select   br_tag  , Br_Name ,
		(case when Br_Region ='CSO' then Br_Name  
		when Br_Region ='BNG' then 'Bangalore'
		when Br_Region ='BOK' then 'Bank Of Karad'
		when Br_Region ='CMBTR' then 'Coimbatore'
		when Br_Region ='DELHI' then 'Delhi'
		when Br_Region ='HO' then 'AKRUTI' 
		when Br_Region ='INDO' then 'Indore'
		when Br_Region ='KOLK' then 'Kolkata'
		when Br_Region ='JAIP' then 'Jaipur'
		when Br_Region ='LUCK' then 'Lucknow'
		when Br_Region ='LUDHN' then 'LUDHIANA'
		when Br_Region ='NAGPR' then 'Nagpur'
		when Br_Region ='NASIK' then 'NASIK'
		when Br_Region ='PTN' then 'PATNA'
		when Br_Region ='RRO' then 'Rajkot (Star-301)'
		when Br_Region ='VD' then 'Baroda'
		when Br_Region ='XPU' then 'Pune'
		when Br_Region ='XS' then  'Surat'
		when Br_Region ='CHEN' then  'CHENNAI - ALWARPET'
		when Br_Region ='YA' then 'AHMEDABAD (MAHALAY)' else  '' end) as Br_type
		from tbl_it_br_master 
		where
		Br_Status='A' and sr_no not in(select br_id from tbl_it_inventory(nolock) where year=@year and month='%') 
		order by  Br_Tag  
	 End	
end
else 
begin
    If(@month<> '%')
    Begin
	Select   br_tag  , Br_Name ,
		(case when Br_Region ='CSO' then Br_Name  
		when Br_Region ='BNG' then 'Bangalore'
		when Br_Region ='BOK' then 'Bank Of Karad'
		when Br_Region ='CMBTR' then 'Coimbatore'
		when Br_Region ='DELHI' then 'Delhi'
		when Br_Region ='HO' then 'AKRUTI' 
		when Br_Region ='INDO' then 'Indore'
		when Br_Region ='KOLK' then 'Kolkata'
		when Br_Region ='JAIP' then 'Jaipur'
		when Br_Region ='LUCK' then 'Lucknow'
		when Br_Region ='LUDHN' then 'LUDHIANA'
		when Br_Region ='NAGPR' then 'Nagpur'
		when Br_Region ='NASIK' then 'NASIK'
		when Br_Region ='PTN' then 'PATNA'
		when Br_Region ='RRO' then 'Rajkot (Star-301)'
		when Br_Region ='VD' then 'Baroda'
		when Br_Region ='XPU' then 'Pune'
		when Br_Region ='XS' then  'Surat'
		when Br_Region ='CHEN' then  'CHENNAI - ALWARPET'
		when Br_Region ='YA' then 'AHMEDABAD (MAHALAY)' else  '' end) as Br_type
		from tbl_it_br_master 
		where
		Br_Status='A' and br_type like @Br_Type and
		sr_no not in (select br_id from tbl_it_inventory(nolock) where year=@year and month=@month) 
		order by  Br_Tag
	End
	Else
	Begin
	   Select   br_tag  , Br_Name ,
		(case when Br_Region ='CSO' then Br_Name  
		when Br_Region ='BNG' then 'Bangalore'
		when Br_Region ='BOK' then 'Bank Of Karad'
		when Br_Region ='CMBTR' then 'Coimbatore'
		when Br_Region ='DELHI' then 'Delhi'
		when Br_Region ='HO' then 'AKRUTI' 
		when Br_Region ='INDO' then 'Indore'
		when Br_Region ='KOLK' then 'Kolkata'
		when Br_Region ='JAIP' then 'Jaipur'
		when Br_Region ='LUCK' then 'Lucknow'
		when Br_Region ='LUDHN' then 'LUDHIANA'
		when Br_Region ='NAGPR' then 'Nagpur'
		when Br_Region ='NASIK' then 'NASIK'
		when Br_Region ='PTN' then 'PATNA'
		when Br_Region ='RRO' then 'Rajkot (Star-301)'
		when Br_Region ='VD' then 'Baroda'
		when Br_Region ='XPU' then 'Pune'
		when Br_Region ='XS' then  'Surat'
		when Br_Region ='CHEN' then  'CHENNAI - ALWARPET'
		when Br_Region ='YA' then 'AHMEDABAD (MAHALAY)' else  '' end) as Br_type
		from tbl_it_br_master 
		where
		Br_Status='A' and br_type like @Br_Type and
		sr_no not in (select br_id from tbl_it_inventory(nolock) where year=@year and month='%') 
		order by  Br_Tag
	End	
     ------Select  b.Br_Tag ,  b.Br_Name  , b.Br_Region , 
     ------a.Br_Name as Br_type
     ------from tbl_it_br_master  a 
     ------right outer join   tbl_it_br_master b on a.Br_Tag=b.Br_Region
     ------where
     ------a.Br_Status='A' and a.br_type like @Br_Type and
     ------a.sr_no not in(select br_id from tbl_it_inventory(nolock) 
     ------where year=@month and month=@month) 
     ------order by  b.Br_Tag 
     
     --select Br_tag,Br_name ,Br_Region 
     --from tbl_it_br_master (nolock) where Br_Status='A' 
     --and br_type='" + Request.QueryString["type"] + "' and sr_no not in(select br_id from tbl_it_inventory(nolock) where year='" + Request.QueryString["year"] + "' and month='" + Request.QueryString["month"] + "'";
end     
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_IT_Inventory_Report_Test
-- --------------------------------------------------
CREATE Proc Usp_IT_Inventory_Report_Test-- '%','Broker','%','2011','May' 
(
	@fld_branch varchar(20),
	@Fld_CSO varchar(15),
	@Br_Type as varchar(20),
	@year varchar(11),
	@month varchar(11)
)                                
as                    

Declare @Query1 varchar(Max)
Declare @Query2 varchar(Max)
Declare @ConQuery varchar(Max)

If((Select Convert(datetime,@month+ ' ' + @year)) >= (CONVERT(Datetime,'2011-05-01')))
Begin
Set @ConQuery= ' And br_id Not IN (''33'',''41'',''48'',''65'',''210'',''165'',''183'',''184'',''68'',''26'',''24'')'
End
	
                              
                   
if  @Fld_CSO='Broker'                        
begin

Set @Query1 =  'select srno,upper(br_name+''-(''+br_tag+'')'') as Branch,br_type,desktops,
				desktop_server,branded_server,laptops,
				Total=convert(int,desktops)+convert(int,desktop_server)+convert(int,branded_server)+convert(int,laptops),                      
				Remark,convert(varchar(11),UpdatedOn,103) as  [Update On],month+''-''+year as date,person_name
			  from V_IT_Inventory_Rpt (nolock)
			  where Br_Type like '''+@Br_Type+''' and year='''+@year+''' and month like '''+@month+'''
			  '+@ConQuery+'
			  order by br_type'
			  
			  Print(@Query1)
			  
			  Exec(@Query1)
end                         
else                        
begin    
  
 Set @Query2 = '               
  create table #t                              
  (                              
  Sr_No int,                              
  Br_tag varchar(150),                              
  Br_Name varchar(500)                              
  )                                           
                                
  if @fld_branch = ''All''                              
                                
  begin                              
   insert into #t                              
   exec USP_WAN_Search_Branch @Fld_CSO                              
  end                              
  else                              
  begin                              
   insert into #t                              
   select @fld_branch,'''',''''                              
  end                              
                                
                                        
  select *,srno,upper(br_name+''-(''+br_tag+'')'') as Branch--,br_type      
,desktops,desktop_server,                        
  branded_server,laptops,                        
  Total=convert(int,desktops)+convert(int,desktop_server)+convert(int,branded_server)+convert(int,laptops) ,                      
Remark,convert(varchar(11),UpdatedOn,103) as [Update On],month+''-''+year as date,person_name                
  from V_IT_Inventory_Rpt (nolock) 
  where br_id in (select Sr_No from #t) and Br_Type like '''+@Br_Type+'''  
  and year='''+@year+''' and month like '''+@month+''' 
  '+@ConQuery+'
  order by br_type'     
  
  print(@Query2) 
  Exec(@Query2)                
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_InventoryMaster
-- --------------------------------------------------
  
CREATE Procedure USP_IT_InventoryMaster      
(      
@tablename varchar(50),    
@Fld_AssetName varchar(30),      
@Fld_AssetType varchar(30),      
@Fld_CapexCode varchar(30),      
@Fld_Capex varchar(30),      
@Fld_CapexType varchar(30),      
@Fld_AssignToDeptName varchar(30),      
@Fld_DeptHeadName varchar(30),      
@Fld_Email varchar(30),          
@Fld_VendorName varchar(30),      
@Fld_Address1 varchar(100)       
)      
as      
if(@tablename='tbl_IT_Assetmaster')      
begin      
 insert into tbl_IT_Assetmaster values (@Fld_AssetName,@Fld_AssetType,'','','A','','')   
 --select * from tbl_It_AssetMaster     
end      
      
else if(@tablename='tbl_it_CapexMaster')          
begin          
 insert into tbl_it_CapexMaster values(@Fld_CapexCode,@Fld_Capex,@Fld_CapexType)          
end      
      
else if(@tablename='tbl_IT_AssignToDeptmaster')      
begin      
 insert into tbl_IT_AssignToDeptMaster values(@Fld_AssignToDeptName,@Fld_DeptHeadName,@Fld_Email,'','','','','','')       
end      
      
else if(@tablename='tbl_IT_vendormaster')      
begin      
 insert into tbl_IT_vendormaster values(@Fld_VendorName,@Fld_Address1,'','','A')    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_InventoryMasterSearch
-- --------------------------------------------------
  
    
CREATE Procedure USP_IT_InventoryMasterSearch        
(        
@tablename varchar(30),        
@assetname varchar(30),         
@assigntodept varchar(30),        
@Fld_CapexCode varchar(30),       
@Fld_Capex varchar(30),             
@VendorName varchar(30)        
)        
as        
if(@tablename='tbl_IT_Assetmaster')        
begin        
 select * from  tbl_IT_Assetmaster(nolock) where Fld_AssetName=@assetname        
end        
        
else if(@tablename='tbl_it_CapexMaster')        
begin        
 select * from  tbl_it_CapexMaster(nolock) where Fld_Capex=@Fld_Capex and Fld_CapexCode= @Fld_CapexCode       
end        
        
else if(@tablename='tbl_IT_AssignToDeptMaster')        
begin        
 select * from  tbl_IT_AssignToDeptMaster(nolock) where Fld_AssignToDeptName=@assigntodept        
end        
        
else if(@tablename='tbl_IT_VendorMaster')        
begin        
 select * from  tbl_IT_vendormaster(nolock) where fld_VendorName=@VendorName --and fld_VendorName=@VendorName        
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_InventoryMasterSearchSecond
-- --------------------------------------------------
CREATE Procedure USP_IT_InventoryMasterSearchSecond    
(    
@tablename varchar(50),    
@CompName varchar(30),    
@DeptName varchar(30),    
@AssetName varchar(30),    
@AssetType varchar(30),    
@CapexCode varchar(30),  
@CapexName varchar(30),  
@CapexType varchar(30),   
@Vendorcode varchar(30),    
@VendorName varchar(30)    
)    
as    
if(@tablename='tbl_it_AngelGroupofCompaniesMaster')    
begin    
 select * from  tbl_it_AngelGroupofCompaniesMaster(nolock) where compName=@CompName    
end    
    
else if(@tablename='tbl_IT_VendorMaster')    
begin    
 select * from  tbl_IT_VendorMaster(nolock) where fld_VendorCode=@Vendorcode --and fld_VendorName=@VendorName  
end    
    
else if(@tablename='tbl_IT_AssignToDeptMaster')    
begin    
 select * from  tbl_IT_AssignToDeptMaster(nolock) where Fld_AssignToDeptName =@DeptName     
end    
    
else if(@tablename='tbl_IT_Assetmaster')    
begin    
 select * from  tbl_IT_Assetmaster(nolock) where Fld_AssetName=@AssetName and  Fld_AssetType=@AssetType   
end    
    
else if(@tablename='tbl_it_CapexMaster')    
begin    
 select * from  tbl_it_CapexMaster(nolock) where Fld_CapexCode=@CapexCode and Fld_Capex=@CapexName and  Fld_CapexType=@CapexType   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_InventoryMasterSecond
-- --------------------------------------------------
CREATE Procedure USP_IT_InventoryMasterSecond    
(    
@tablename varchar(50),    
@CompName varchar(30),    
@DeptName varchar(30),    
@AssetName varchar(30),    
@AssetType varchar(30),    
@CapexCode varchar(30),  
@CapexName varchar(30),  
@CapexType varchar(30),   
@Vendorcode varchar(30),    
@VendorName varchar(30)   
)    
as    
if(@tablename='tbl_it_AngelGroupofCompaniesMaster')    
begin    
 insert into tbl_it_AngelGroupofCompaniesMaster values (@CompName)    
end    
    
else if(@tablename='tbl_IT_AssignToDeptMaster')    
begin    
 insert into tbl_IT_AssignToDeptMaster values(@DeptName)    
end    
   
else if(@tablename='tbl_IT_Assetmaster')    
begin    
 insert into tbl_IT_Assetmaster values(@AssetName,@AssetType)    
end    
  
else if(@tablename='tbl_it_CapexMaster')    
begin    
 insert into tbl_it_CapexMaster values(@CapexCode,@CapexName,@CapexType)    
end    
    
else if(@tablename='tbl_IT_vendormaster')    
begin    
 insert into tbl_IT_vendormaster values(@Vendorcode,@VendorName)     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_IP_REPORT
-- --------------------------------------------------
CREATE Proc USP_IT_IP_REPORT(@branch as varchar(50),@ip as varchar(50))      
as      
      
/*      
set @fdate = convert(@fdate,datetime)      
*/      
Declare @Opt as varchar(10)      
      
-- set @fdate = convert(varchar(11),convert(datetime,@fdate,103))      
-- set @tdate = convert(varchar(11),convert(datetime,@tdate,103))      
    
set @ip = case when @ip = '' then '%%' else @ip end      
set @Opt = case when @branch = 'All' then 'like' else '=' end      
set @branch = case when @branch = 'All' then '%%' else @branch end      
      
declare @str as varchar(1000)      
set @str = 'select Fld_SrNo,''<a href =/Utilities/Helpdesk/IT/frmIPReports.aspx?Val=''+convert(varchar,Fld_SrNo)+''>''+Fld_Branch+''</a>'' as Fld_Branch,Fld_IpFrom,Fld_IpTo,Fld_SB_mask,Fld_Def_GT,Fld_Remark from tbl_IT_IPaddress where (Fld_IpFrom like ''%
''+'''+@ip+'''+''%'' or Fld_Ipto like ''%''+'''+@ip+'''+''%'') and Fld_Branch '+@Opt+''''+@Branch+'''order by Fld_SrNo'      
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_it_PurchaseOrder
-- --------------------------------------------------

CREATE proc Usp_it_PurchaseOrder                            
(                            
@Fld_POId int,      
@username varchar(8)                            
)                            
as                            
              
select Fld_PId,Fld_RequestId into #Pid from tbl_ItRequestPurchaseOrder where Fld_PId = @Fld_POId          
                  
select a.*,TotalRate=fld_qty*fld_rate,b.fld_assetname,c.Fld_Excise,                             
c.Fld_Edn_Cess,c.Fld_CST,c.Fld_VAT,c.Fld_Service,c.Fld_Frieght,c.Fld_Octroi,c.Fld_Discount,CFld_Status=c.Fld_Status from                            
(                
select fld_RequestId,fld_producttype,Fld_AssetName,Fld_ProductModel,Fld_ProductDesc,Fld_PartNo,                
Fld_Qty=sum(Fld_Qty),Fld_VendorName,Fld_Rate,fld_WarrantyType                
from  tbl_ITAssetsData(nolock) where Fld_PId in (select Fld_PId from #Pid)                  
group by Fld_AssetName,Fld_ProductModel,Fld_ProductDesc,Fld_PartNo,Fld_VendorName,Fld_Rate,fld_producttype,fld_RequestId,fld_WarrantyType)a                             
left outer join                            
(select  * from tbl_IT_AssetMaster(nolock))b                             
on a.fld_producttype=b.fld_AssetID                             
left outer join                            
(select * from tbl_it_Taxes(nolock))c                            
on a.Fld_RequestId=c.Fld_RequestID;                             
   
select x.*,y.Fld_Address1,y.Fld_Address2,y.Fld_Address3 from                            
(select a.*,b.compName from                             
(select * from tbl_ItRequestPurchaseOrder(nolock) where Fld_Pid =@Fld_POId)a                            
left outer join                            
(select * from tbl_it_AngelGroupOfCompaniesMaster(nolock)where status='A')b                            
on a.Fld_CompId =b.CompId)x  
left outer join  
(select Fld_VendorName,Fld_Address1,Fld_Address2,Fld_Address3 from tbl_it_vendormaster(nolock))y  
 on x.Fld_VendorName=y.Fld_VendorName                           
                          
select * from tbl_ITRequestCondition(nolock)                         
                        
select a.*,TotalRate=fld_qty*fld_rate,c.Fld_Excise,                             
c.Fld_Edn_Cess,c.Fld_CST,c.Fld_VAT,c.Fld_Service,c.Fld_Frieght,c.Fld_Octroi,c.Fld_Discount,CFld_Status=c.Fld_Status into #temp from                            
(              
select y.*,x.Fld_PId from              
(select Fld_RequestId,Fld_VendorId,Fld_VendorName,Fld_PurchaseOrderNo,Fld_ShipTo,Fld_ShippingMethod,Fld_OrderTerms,Fld_DeliveryDate,Fld_CompID,Fld_PId from  tbl_ItRequestPurchaseOrder(nolock) where Fld_PId =@Fld_POId)x              
Right outer join              
(select Fld_SrNo,Fld_RequestId,Fld_ProductType,Fld_ProductName,Fld_ProductModel,Fld_ProductDesc,Fld_AssetName,Fld_AssetTag,Fld_PartNo,Fld_VendorName,Fld_Qty,Fld_Rate,Fld_WarrantyFrom,Fld_WarrantyTo,Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo, 
Fld_Purpose,Fld_Status,Fld_SystemDate,Fld_CapexName,Fld_WarrantyType from  tbl_ITAssetsData(nolock) where Fld_PId =@Fld_POId)y on x.Fld_RequestId = y.Fld_RequestId              
)a                              
left outer join                            
(select * from tbl_it_Taxes(nolock))c                            
on a.Fld_PId=c.Fld_RequestID;                  
                        
declare @Fld_Excise as float                        
declare @Fld_Edn_Cess as float                        
declare @Fld_CST as float                        
declare @Fld_VAT as float                        
declare @Fld_Service as float                        
declare @Fld_Frieght as float                        
declare @Fld_Octroi as float                        
declare @Fld_Discount as float                        
declare @status as varchar(25)            
                        
set @Fld_Excise = (Select distinct Fld_Excise from #temp(nolock) where Fld_Excise is not null)                        
set @Fld_Edn_Cess = (Select distinct Fld_Edn_Cess from #temp(nolock) where Fld_Edn_Cess is not null)                        
set @Fld_CST = (Select distinct Fld_CST from #temp(nolock) where Fld_CST is not null)                        
set @Fld_VAT = (Select distinct Fld_VAT from #temp(nolock) where Fld_VAT is not null)                        
set @Fld_Service = (Select distinct Fld_Service from #temp(nolock) where Fld_Service is not null)                        
set @Fld_Frieght = (Select distinct Fld_Frieght from #temp(nolock) where Fld_Frieght is not null)                        
set @Fld_Octroi = (Select distinct Fld_Octroi from #temp(nolock) where Fld_Octroi is not null)                        
set @Fld_Discount = (Select distinct Fld_Discount from #temp(nolock) where Fld_Discount is not null)                        
set @status = (Select distinct CFld_Status from #temp(nolock) where CFld_Status is not null)             
                        
                      
select  CFld_Status = @status,sum(TotalRate),excise=((sum(TotalRate) * @Fld_Excise)/100),Edn_Cess=((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100),                      
CST=((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_CST)/100,                      
VAT=((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100,              
ServiceTax=(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100,                      
octroi=((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))+((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100))*@Fld_Octroi)/100,                      
Freight=@Fld_Frieght,Total_Payable=(sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100)+((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_CST)/100+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100)+((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100)+(((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))+((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess  )/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100))*@Fld_Octroi)/100)+(@Fld_Frieght)),                      
Discount1=@Fld_Discount,                    
Discount=((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100)+((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_CST)/100+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100)+((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100)+(((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))+((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100))*@Fld_Octroi)/100)+(@Fld_Frieght))-@Fld_Discount),RouTotal_Payable=round((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100)+((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_CST)/100+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100)+((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100)+(((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))+((((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))+(((sum(TotalRate)+((sum(TotalRate) * @Fld_Excise)/100)+((((sum(TotalRate) * @Fld_Excise)/100)* @Fld_Edn_Cess)/100))*@Fld_VAT)/100))*@Fld_Service)/100))*@Fld_Octroi)/100)+(@Fld_Frieght))-@Fld_Discount,0) from #temp       
      
      
select person_name,email from intranet.risk.dbo.user_login where username=@username

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Report
-- --------------------------------------------------
CREATE proc USP_IT_Report(@fdate as varchar(15),@tdate as varchar(15),@Location as varchar(100),@exchange as varchar(100),@issues as varchar(200))        
as         
        
set nocount on        
--         
-- declare @fdate as varchar(50)        
-- declare @tdate as varchar(50)        
-- declare @Location as varchar(50)        
-- declare @exchange as varchar(50)        
-- declare @issues as varchar(50)        
-- --         
-- set @fdate = 'May 01 2007'        
-- set @tdate = 'May 31 2007'        
-- --set @Location = 'ALL'        
--         
-- set @Location = 'ALL'        
-- set @exchange = 'ALL'        
-- set @issues = 'ALL'              
        
declare @opt as varchar(50)        
declare @opt1 as varchar(500)        
declare @opt2 as varchar(500)        
declare @str as varchar(2000)        
        
        
set  @opt = (select                                    
(case when @Location = 'All' then 'like' else '=' end ))               
        
set  @opt1 = (select                                    
(case when @exchange = 'All' then 'like' else '=' end ))               
        
set  @opt2 = (select                                    
(case when @issues = 'All' then 'like' else '=' end ))               
        
select Top 0 Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin ,space(50) as uptime,space(50) as sr into #t from newtab1      
      
set @str =         
'select Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin,''0'',srno from newtab1 where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' (replace('''+@Location+''',''ALL'',''%''))        
and ImpactedSegemnt '+@opt1+' (replace('''+@exchange+''',''ALL'',''%'')) and Problem '+@opt2+' (replace('''+@issues+''',''ALL'',''%''))'        
insert into #t      
exec (@str)        
        
select * into #t1 from sett_mst where tdate >= @fdate and tdate <= @tdate        
        
update #t set uptime = (        
case         
when ImpactedSegemnt = 'NCDEX' then #t1.Ncdex        
when ImpactedSegemnt = 'CM + FO' then #t1.CM+#t1.FO         
when ImpactedSegemnt = 'BSE + CM + FO' then #t1.bse+#t1.CM+#t1.FO        
when ImpactedSegemnt = 'FO' then #t1.FO         
when ImpactedSegemnt = 'All segments' then #t1.bse+#t1.CM+#t1.FO+#t1.mcx+#t1.ncdex         
when ImpactedSegemnt = 'BSE' then  #t1.bse         
when ImpactedSegemnt = 'MCX' then  #t1.mcx         
when ImpactedSegemnt = 'CM' then  #t1.cm         
when ImpactedSegemnt = 'CM + FO + NCDEX' then #t1.bse+#t1.fo+#t1.ncdex        
when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t1.bse+#t1.mcx+#t1.ncdex        
when ImpactedSegemnt = 'MCX + NCDEX' then  #t1.mcx+#t1.ncdex         
when ImpactedSegemnt = 'None' then 0         
end)         
from #t1 where #t.dt = #t1.tdate        
        
select Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,  
downtime,downtimemin,uptime,per=(convert(decimal(5,1),downtimemin)/case when convert(decimal(5,1),uptime) = 0 then 1 else convert(decimal(5,1),uptime) end)*100,sr from #t order by dt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Report_1
-- --------------------------------------------------
CREATE proc USP_IT_Report_1(@fdate as varchar(15),@tdate as varchar(15),@Location as varchar(100),@exchange as varchar(100),@issues as varchar(200))                    
as                     
                    
set nocount on                    
--                     
-- declare @fdate as varchar(50)                    
-- declare @tdate as varchar(50)                    
-- declare @Location as varchar(50)                    
-- declare @exchange as varchar(50)                    
-- declare @issues as varchar(50)                    
-- --                     
-- set @fdate = 'May 01 2007'                    
-- set @tdate = 'May 31 2007'                    
--set @Location = 'ALL'                    
--                     
-- set @Location = 'ALL'                    
-- set @exchange = 'ALL'                    
-- set @issues = 'ALL'                          
                    
declare @opt as varchar(50)                    
declare @opt1 as varchar(500)                    
declare @opt2 as varchar(500)                    
declare @str as varchar(2000)                    
                    
                    
set  @opt = (select                                                
(case when @Location = 'All' then 'like' else '=' end ))                           
                    
set  @opt1 = (select                                                
(case when @exchange = 'All' then 'like' else '=' end ))                           
                    
set  @opt2 = (select                                                
(case when @issues = 'All' then 'like' else '=' end ))                           
                    
select Top 0 Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin ,space(50) as uptime,space(50) as dtime,space(50) as sr into #t from newtab1                  
                  
set @str =  'select Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin,''0'',''0'',srno from newtab1 where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' (replace('''+@Location+''',''ALL'',''%'')) and ImpactedSegemnt '+@opt1+' (replace('''+@exchange+''',''ALL'',''%'')) and Problem '+@opt2+' (replace('''+@issues+''',''ALL'',''%''))'                    
insert into #t                  
exec (@str)                    
                    
select * into #t1 from sett_mst where tdate >= @fdate and tdate <= @tdate                    
          
update #t set dtime = (                    
case                     
when ImpactedSegemnt = 'NCDEX' then #t.downtimemin          
when ImpactedSegemnt = 'NSECM + NSEFO' then #t.downtimemin * 2          
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t.downtimemin * 3          
when ImpactedSegemnt = 'NSEFO' then #t.downtimemin                     
when ImpactedSegemnt = 'BSECM' then  #t.downtimemin                     
when ImpactedSegemnt = 'MCX' then  #t.downtimemin                     
when ImpactedSegemnt = 'NSECM' then  #t.downtimemin                     
--when ImpactedSegemnt = 'CM + FO + NCDEX' then #t.downtimemin * 3          
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t.downtimemin * 3          
when ImpactedSegemnt = 'MCX + NCDEX' then  #t.downtimemin * 2          
when ImpactedSegemnt = 'NONE' then 0                     
end)                     
from #t where #t.dt = #t.dt                    
                    
update #t set uptime = (                    
case                     
when ImpactedSegemnt = 'NCDEX' then #t1.Ncdex                    
when ImpactedSegemnt = 'NSECM + NSEFO' then #t1.CM+#t1.FO                     
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t1.bse+#t1.CM+#t1.FO                    
when ImpactedSegemnt = 'NSEFO' then #t1.FO                     
when ImpactedSegemnt = 'BSECM' then  #t1.bse                     
when ImpactedSegemnt = 'MCX' then  #t1.mcx                     
when ImpactedSegemnt = 'NSECM' then  #t1.cm                     
--when ImpactedSegemnt = 'CM + FO + NCDEX' then #t1.bse+#t1.fo+#t1.ncdex                    
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t1.bse+#t1.mcx+#t1.ncdex          
when ImpactedSegemnt = 'MCX + NCDEX' then  #t1.mcx+#t1.ncdex                     
when ImpactedSegemnt = 'NONE' then 0                     
end)  from #t1 where #t.dt = #t1.tdate                    
                    
select Dt=convert(varchar(15),dt,103),Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,              
downtime,downtimemin,uptime,dtime,per=(convert(decimal(5,1),dtime)/case when convert(decimal(5,1),uptime) = 0 then 1 else convert(decimal(5,1),uptime) end)*100,sr from #t order by dt,TimeFrom

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Report_New
-- --------------------------------------------------
CREATE proc USP_IT_Report_New(@fdate as varchar(11),@tdate as varchar(11),@Location as varchar(100),@server as varchar(100),@exchange as varchar(100),@issues as varchar(200))                                
as                                 
                                
set nocount on                                
--                                 
          
/*          
declare @fdate as varchar(50)                                
declare @tdate as varchar(50)                                
declare @Location as varchar(50)                                
declare @exchange as varchar(50)                                
declare @issues as varchar(50)                                
          
          
set @fdate = '01/10/2007'          
set @tdate = '10/10/2007'          
set @Location = 'Rajkot'                                
set @exchange = 'ALL'                                
set @issues = 'ALL'             
*/          
          
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                
                                
declare @opt as varchar(50)                                
declare @opt1 as varchar(500)                                
declare @opt2 as varchar(500)                                
declare @str as varchar(2000)                                
                                
set  @opt = (select                                                            
(case when @Location = 'All' then 'like' else '=' end ))                                       
                                
set  @opt1 = (select                                                            
(case when @exchange = 'All' then 'like' else '=' end ))                                       
                                
set  @opt2 = (select                                                            
(case when @issues = 'All' then 'like' else '=' end ))                                                            
        
select Top 0 Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin ,space(50) as uptime,space(50) as dtime,space(50) as sr into #t from newtab1                            
                              
set @str =  'select Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,          
downtimemin,''0'',''0'',srno from newtab1 where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and           
Location in (select server from server_users where Location '+@opt+' (replace('''+@Location+''',''ALL'',''%''))) and           
ImpactedSegemnt '+@opt1+' (replace('''+@exchange+''',''ALL'',''%'')) and           
Problem '+@opt2+' (replace('''+@issues+''',''ALL'',''%''))'                                
          
insert into #t                              
exec (@str)                      
                                
select * into #t1 from sett_mst where tdate >= @fdate and tdate <= @tdate                       
          
                      
update #t set dtime = (                                
case                                 
when ImpactedSegemnt = 'NCDEX' then #t.downtimemin                      
when ImpactedSegemnt = 'NSECM + NSEFO' then #t.downtimemin * 2                      
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t.downtimemin * 3                      
when ImpactedSegemnt = 'NSEFO' then #t.downtimemin                                 
when ImpactedSegemnt = 'BSECM' then  #t.downtimemin                                 
when ImpactedSegemnt = 'MCX' then  #t.downtimemin                                 
when ImpactedSegemnt = 'NSECM' then  #t.downtimemin                                 
--when ImpactedSegemnt = 'CM + FO + NCDEX' then #t.downtimemin * 3                      
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t.downtimemin * 3                      
when ImpactedSegemnt = 'MCX + NCDEX' then  #t.downtimemin * 2                      
when ImpactedSegemnt = 'NONE' then 0                  
end)                                 
from #t where #t.dt = #t.dt                                
           
update #t set uptime = (                                
case                                 
when ImpactedSegemnt = 'NCDEX' then #t1.Ncdex                                
when ImpactedSegemnt = 'NSECM + NSEFO' then #t1.CM+#t1.FO                                 
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t1.bse+#t1.CM+#t1.FO                                
when ImpactedSegemnt = 'NSEFO' then #t1.FO                                 
when ImpactedSegemnt = 'BSECM' then  #t1.bse                   
when ImpactedSegemnt = 'MCX' then  #t1.mcx                                 
when ImpactedSegemnt = 'NSECM' then  #t1.cm                                 
--when ImpactedSegemnt = 'CM + FO + NCDEX' then #t1.bse+#t1.fo+#t1.ncdex                                
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t1.bse+#t1.mcx+#t1.ncdex                      
when ImpactedSegemnt = 'MCX + NCDEX' then  #t1.mcx+#t1.ncdex                                 
when ImpactedSegemnt = 'NONE' then 0                                 
end)  from #t1 where #t.dt = #t1.tdate                                

if @server = 'All'

begin                  
              
select Dt=convert(varchar(15),dt,103),Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,                          
downtime,downtimemin,uptime,dtime,
per=(convert(decimal(5,1),dtime)/case when convert(decimal(5,1),uptime) = 0 then 1 else convert(decimal(5,1),uptime) end)*100,
sr from #t  order by convert(datetime,dt,103),TimeFrom      

end
else

begin

select Dt=convert(varchar(15),dt,103),Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,                          
downtime,downtimemin,uptime,dtime,
per=(convert(decimal(5,1),dtime)/case when convert(decimal(5,1),uptime) = 0 then 1 else convert(decimal(5,1),uptime) end)*100,
sr from #t where  Location = @server  order by convert(datetime,dt,103),TimeFrom      

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Report_New_1
-- --------------------------------------------------
CREATE proc [dbo].[USP_IT_Report_New_1](@fdate as varchar(11),@tdate as varchar(11),@Location as varchar(100),@server as varchar(100),@exchange as varchar(100),@issues as varchar(200))                            
as                             
                            
set nocount on                            
--                             
      
/* 
declare @fdate as varchar(50)                            
declare @tdate as varchar(50)                            
declare @Location as varchar(50)                            
declare @exchange as varchar(50)                            
declare @issues as varchar(50)                            
      
set @fdate = '01/11/2007'      
set @tdate = '20/11/2007'      
set @Location = 'Akruti Diet (16)'                            
set @exchange = 'ALL'                            
set @issues = 'ALL'         
*/
      
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))            
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))            
                            
declare @opt as varchar(50)                            
declare @opt1 as varchar(500)                            
declare @opt2 as varchar(500)                            
declare @opt3 as varchar(500)
declare @str as varchar(2000)                            
                            
set  @opt = (select                                                        
(case when @Location = 'All' then 'like' else '=' end ))                                   
                            
set  @opt1 = (select                                                        
(case when @exchange = 'All' then 'like' else '=' end ))                                   
                            
set  @opt2 = (select                                                        
(case when @issues = 'All' then 'like' else '=' end ))                                                        

set  @opt3 = (select                                                        
(case when @Server = 'All' then 'like' else '=' end ))                                                        
    
select Top 0 SRNO, Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin ,space(50) as uptime,space(50) as dtime,space(50) as sr into #t from newtab1                        
                          
set @str =  'select  Dt,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,      
downtimemin,''0'',''0'',srno from newtab1 where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and       
Location in (select server from server_users where Location '+@opt+' (replace('''+@Location+''',''ALL'',''%'')) and server '+@opt3+'(replace('''+@Server+''',''ALL'',''%'')) ) and       
ImpactedSegemnt '+@opt1+' (replace('''+@exchange+''',''ALL'',''%'')) and       
Problem '+@opt2+' (replace('''+@issues+''',''ALL'',''%''))'                            
      
insert into #t                          
exec (@str)                  
                            
select * into #t1 from sett_mst where tdate >= @fdate and tdate <= @tdate                   
      
                  
update #t set dtime = (                            
case                             
when ImpactedSegemnt = 'NCDEX' then #t.downtimemin                  
when ImpactedSegemnt = 'NSECM + NSEFO' then #t.downtimemin * 2                  
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t.downtimemin * 3                  
when ImpactedSegemnt = 'NSEFO' then #t.downtimemin                             
when ImpactedSegemnt = 'BSECM' then  #t.downtimemin                             
when ImpactedSegemnt = 'MCX' then  #t.downtimemin                             
when ImpactedSegemnt = 'NSECM' then  #t.downtimemin                             
--when ImpactedSegemnt = 'CM + FO + NCDEX' then #t.downtimemin * 3                  
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t.downtimemin * 3                  
when ImpactedSegemnt = 'MCX + NCDEX' then  #t.downtimemin * 2                  
when ImpactedSegemnt = 'NONE' then 0                             
end)                             
from #t where #t.dt = #t.dt                            
       
update #t set uptime = (                            
case                             
when ImpactedSegemnt = 'NCDEX' then #t1.Ncdex                            
when ImpactedSegemnt = 'NSECM + NSEFO' then #t1.CM+#t1.FO                             
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t1.bse+#t1.CM+#t1.FO                            
when ImpactedSegemnt = 'NSEFO' then #t1.FO                             
when ImpactedSegemnt = 'BSECM' then  #t1.bse               
when ImpactedSegemnt = 'MCX' then  #t1.mcx                             
when ImpactedSegemnt = 'NSECM' then  #t1.cm                             
--when ImpactedSegemnt = 'CM + FO + NCDEX' then #t1.bse+#t1.fo+#t1.ncdex                            
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t1.bse+#t1.mcx+#t1.ncdex                  
when ImpactedSegemnt = 'MCX + NCDEX' then  #t1.mcx+#t1.ncdex                             
when ImpactedSegemnt = 'NONE' then 0                             
end)  from #t1 where #t.dt = #t1.tdate                            
                            
select  Dt=convert(varchar(15),dt,103),Location,TimeFrom,
TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,                      
downtime,downtimemin,uptime,dtime,
per=(convert(decimal(5,1),dtime)/case when convert(decimal(5,1),uptime) = 0 then 1 else convert(decimal(5,1),uptime) end)*100,
sr from #t order by convert(datetime,dt,103),TimeFrom

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Report_New1
-- --------------------------------------------------
--USP_IT_Report_New1 '01/04/2015','30/04/2015','','','',''

CREATE proc [dbo].[USP_IT_Report_New1]          
(          
 @fdate as varchar(11),          
 @tdate as varchar(11),          
 @Location as varchar(100),          
 @server as varchar(100),          
 @exchange as varchar(100),          
 @issues as varchar(200)          
 )                                                        
as                                                         
                                                        
set nocount on                                                       
--                                                         
                      
/*                                
declare @fdate as varchar(50)                                                        
declare @tdate as varchar(50)                                                        
declare @Location as varchar(50)                                                        
declare @exchange as varchar(50)                                                        
declare @issues as varchar(50)                                                        
                                  
                                  
set @fdate = '06/06/2008'                                  
set @tdate = '06/06/2008'                                  
set @Location = 'ALL'                                                        
set @exchange = 'ALL'                                                        
set @issues = 'ALL'                        
*/                                 
   --print   @fdate          
 -- print   @tdate                                  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                        
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                        
                                                        
declare @opt as varchar(50)                                                        
declare @opt1 as varchar(500)                                                        
declare @opt2 as varchar(500)                                                        
declare @str as varchar(2000)                                                        
  --print   @fdate          
 -- print   @tdate                                                 
set  @opt = (select                                                                                    
(case when @Location = 'All' then 'like' else '=' end ))                                                               
                                                        
set  @opt1 = (select                                                                                    
(case when @exchange = 'All' then 'like' else '=' end ))                                                               
                                                        
set  @opt2 = (select                                                                                    
(case when @issues = 'All' then 'like' else '=' end ))                                                                                    
                                
select Top 0 Dt,Type,Location,Replace(TimeFrom,'.',':') as TimeFrom,Replace(TimeTo,'.',':') as TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin,space(50) as uptime,space(50) as dtime,space(50) as sr,space(1000) as remark into 
  
    
      
        
#t from newtab1                                                    
                                                      
set @str =  'select Distinct Dt,Type,Location,Replace(TimeFrom,''.'','':'') as TimeFrom,Replace(TimeTo,''.'','':'') as TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,                                  
downtimemin,''0'',''0'',srno,          
case when remark <> '''' then remark When Remark Is null then '''' else ''NA'' end as remark          
from newtab1 where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and                                   
Location in (select Fld_id from V_Server_Master where Fld_Branch_cd '+@opt+' (replace('''+@Location+''',''ALL'',''%''))) and                                   
ImpactedSegemnt '+@opt1+' (replace('''+@exchange+''',''ALL'',''%'')) and             
Problem '+@opt2+' (replace('''+@issues+''',''ALL'',''%'')) '                                                        
                               
insert into #t                                                      
exec (@str)                       
print @str                     
                                                        
select * into #t1 from sett_mst where tdate >= @fdate and tdate <= @tdate                                  
                                              
update #t set dtime = (                                                        
case                                                         
when ImpactedSegemnt = 'NCDEX' then #t.downtimemin                                              
when ImpactedSegemnt = 'NSECM + NSEFO' then #t.downtimemin * 2                                              
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t.downtimemin * 3                                            
when ImpactedSegemnt = 'NSEFO' then #t.downtimemin                                                         
when ImpactedSegemnt = 'BSECM' then  #t.downtimemin                                                         
when ImpactedSegemnt = 'MCX' then  #t.downtimemin         
when ImpactedSegemnt = 'MCXCD' then   #t.downtimemin         
when ImpactedSegemnt = 'NSECD' then   #t.downtimemin   ---zeba                                                       
  ---zeba                                                       
                                                        
when ImpactedSegemnt = 'NSECM' then  #t.downtimemin                                                     
--when ImpactedSegemnt = 'CM + FO + NCDEX' then                                                                                                                                        #t.downtimemin * 3                                              
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t.downtimemin * 3                                      
when ImpactedSegemnt = 'MCX + NCDEX' then  #t.downtimemin * 2                                              
when ImpactedSegemnt = 'NONE' then 0                                          
end)                                                                                                                                                                                               
      
from #t where #t.dt = #t.dt                                                        
                      
                                   
update #t set uptime = (                                                        
case                                                         
when ImpactedSegemnt = 'NCDEX' then #t1.Ncdex                                                        
when ImpactedSegemnt = 'NSECM + NSEFO' then #t1.CM+#t1.FO                                                         
when ImpactedSegemnt = 'BSECM + NSECM + NSEFO' then #t1.bse+#t1.CM+#t1.FO                                                        
when ImpactedSegemnt = 'NSEFO' then #t1.FO                                                         
when ImpactedSegemnt = 'BSECM' then  #t1.bse                                           
when ImpactedSegemnt = 'MCX' then  #t1.mcx         
when ImpactedSegemnt = 'MCXCD' then  #t1.ACPLMCD ---zeba                                                        
                                                        
when ImpactedSegemnt = 'NSECM' then  #t1.cm                                                         
--when ImpactedSegemnt = 'CM + FO + NCDEX' then #t1.bse+#t1.fo+#t1.ncdex                                                        
--when ImpactedSegemnt = 'BSE +  MCX + NCDEX' then #t1.bse+#t1.mcx+#t1.ncdex                                              
when ImpactedSegemnt = 'MCX + NCDEX' then  #t1.mcx+#t1.ncdex         
when ImpactedSegemnt = 'NSECD' then   #t1.ACDLNSX   ---zeba                                                       
                                                        
when ImpactedSegemnt = 'NONE' then 0         
end)  from #t1 where #t.dt = #t1.tdate                                                        
                        
if @server = 'All'                    
                        
begin                                          
                        
select Dt,Type,y.Fld_server as Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin,uptime,dtime,per,sr,fld_id,remark from                       
(                                    
select Dt=convert(varchar(10),convert(datetime,Dt),101)          
,Type,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,           
downtime,downtimemin,uptime,dtime,                        
per=(convert(decimal(5,1),dtime)/case when convert(decimal(5,1),uptime) = 0 then 1 else convert(decimal(5,1),uptime) end)*100,                        
sr,          
--remark           
case when remark <> '' then remark else 'NA' end as remark          
from #t ) x                      
left outer join                      
(select * from Tbl_Server_Master (nolock)) y                      
on x.Location = y.Fld_Id                      
order by convert(varchar(10),convert(datetime,Dt),101),TimeFrom ,sr                     
                        
end                        
else                        
                        
begin                          
                        
select  Dt,Type,y.Fld_server as Location, TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,downtime,downtimemin,uptime,dtime,per,sr,fld_id,remark,Type from                      
(                      
select Dt=convert(varchar(10),convert(datetime,Dt),101)          
,Type,Location,TimeFrom,TimeTo,EventParticulars,Solution,Problem,ImpactedSegemnt,                                                  
downtime,downtimemin,uptime,dtime,                        
per=(convert(decimal(5,1),dtime)/case when convert(decimal(5,1),uptime) = 0 then 1 else convert(decimal(5,1),uptime) end)*100,                        
sr,          
--remark           
case when remark <> '' then remark else 'NA' end as remark          
from #t where  Location = @server                       
)x                      
 left outer join                      
(select * from Tbl_Server_Master (nolock)) y                      
on x.Location = y.Fld_Id                      
order by convert(varchar(10),convert(datetime,Dt),101),TimeFrom , sr                       
                      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Reports
-- --------------------------------------------------
CREATE Proc USP_IT_Reports  
(  
@Fdate varchar(11),  
@Tdate varchar(20),  
@Fld_Frq varchar(10),  
@Fld_SrNo varchar(10),  
@Fld_Br_Code varchar(10),  
@status varchar(11)  
)  
as  
  
set @Fdate = convert(varchar(11),convert(datetime,@Fdate,103))  
set @Tdate = convert(varchar(11),convert(datetime,@Tdate,103)) + ' 23:59:59'  
declare @str as  varchar(500)  
  
set @str ='select * from V_Tbl_IT_Reports_details where Fld_Frq like replace('''+@Fld_Frq+''',''All'',''%%'') and   
Fld_SrNo like replace('''+@Fld_SrNo+''',''All'',''%%'') and Fld_Br_Code like replace('''+@Fld_Br_Code+''',''All'',''%%'') and   
Fld_Status like replace('''+@status+''',''All'',''%%'') and Fld_Fet_Date >= '''+@Fdate+''' and   
Fld_Fet_Date <= '''+@Tdate+''''  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Reports_Branches
-- --------------------------------------------------



CREATE Proc USP_IT_Reports_Branches(@Fld_Id int)      
as      
      
select distinct x.*, y.Br_Name,upper(y.Br_Name)+'-('+Fld_Br_Code+')' as Br_Name from      
(select Fld_Id,FLd_Br_Code from Tbl_IT_Reports_details where Fld_Id = @Fld_Id)x      
left outer join      
(select * from tbl_it_br_master (nolock))y      
on x.FLd_Br_Code = y.br_tag  order by y.Br_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_REPORTS_BRANCHES_15122010
-- --------------------------------------------------
CREATE PROC USP_IT_REPORTS_BRANCHES_15122010
(
	@FLD_ID INT
)
    
AS    
    
    SELECT * 
    INTO #TEMP
	FROM TBL_IT_BR_MASTER (NOLOCK)
		
	SELECT DISTINCT X.*,
		UPPER(Y.BR_NAME)+'-('+FLD_BR_CODE+')' AS BR_NAME 
	FROM    
	(
		SELECT FLD_ID,FLD_BR_CODE 
		FROM TBL_IT_REPORTS_DETAILS 
		WHERE FLD_ID = @FLD_ID
	)X    
	LEFT OUTER JOIN #TEMP Y
	--(
	--	SELECT * 
	--	FROM TBL_IT_BR_MASTER (NOLOCK)
	--)Y
	    
	ON X.FLD_BR_CODE = Y.BR_TAG  
	-- ORDER BY Y.BR_NAME
	ORDER BY #TEMP.BR_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_REPORTS_BRANCHES_31122010
-- --------------------------------------------------
CREATE PROC USP_IT_REPORTS_BRANCHES_31122010
(
	@FLD_ID INT
)    
AS    
    
	SELECT DISTINCT X.*,
		BR_NAME=UPPER(Y.BR_NAME)+'-('+FLD_BR_CODE+')'
	FROM    
	(
		SELECT FLD_ID,FLD_BR_CODE 
		FROM TBL_IT_REPORTS_DETAILS 
		WHERE FLD_ID = @FLD_ID
	)X    
	LEFT OUTER JOIN    
	(
		SELECT * 
		FROM TBL_IT_BR_MASTER (NOLOCK)
	)Y ON X.FLD_BR_CODE = Y.BR_TAG 
	ORDER BY BR_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Rotated_Calls
-- --------------------------------------------------
CREATE Proc USP_IT_Rotated_Calls            
(@Fdate as varchar(11),                            
@Tdate as varchar(11),                                                    
@status as varchar(20),                            
@Category as varchar(20),                                                    
@code as varchar(11),                            
@entry_by as varchar(10),                                                    
@Branch as varchar(500),                            
@Call_Type as varchar(20),                        
@region as varchar(20),                       
@Court_Call_Type as varchar(20))                                    
as                                   
                      
  /*                             
declare @Fdate as varchar(11)                    
declare @Tdate as varchar(11)                    
declare @status as varchar(11)                    
declare @Category as varchar(20)                    
declare @code as varchar(11)                    
declare @entry_by as varchar(10)                    
declare @Branch as varchar(50)                    
declare @Call_Type as varchar(20)                    
                    
set @Fdate = 'Jun 11 2008'                    
set @Tdate = 'Jun 11 2008'                    
set @status = 'ALL'                    
set @Category = 'ALL'                    
set @code = ''                    
set @entry_by = 'ALL'                     
set @Branch = 'HO'                    
set @Call_Type = 'ALL'                      
*/                    
                     
declare @str as varchar(5000)                                  
                                   
set @Fdate = convert(varchar(11),convert(datetime,@Fdate,103))                                    
set @Tdate = convert(varchar(11),convert(datetime,@Tdate,103))                                   
                                        
              
set @Court_Call_Type = (case when @Court_Call_Type = 'ALL'  then 'like ''%%' else ' = '+''''+@Court_Call_Type+'' end)                   
set @status = (case when @status = 'ALL' then 'like ''%%' else ' = '+''''+@status+'' end)                                   
set @Category = (case when @Category = 'ALL' then 'like ''%%' else ' = '+''''+@Category+'' end)                                   
--set @Branch = (case when @Branch = 'ALL' then 'like ''%%' else ' = '+''''+@Branch+'' end)        
set @Branch = (case when @region = 'ALL' and @Branch = 'ALL' then 'like ''%%''' else 'in (select br_tag from(select Br_Tag from tbl_it_br_master (nolock) where br_region = '''+@region+''' and br_tag like replace('''+@Branch+''',''All'',''%%'')union select
  
    
 replace('''+@Branch+''',''All'','''+@region+'''))x)' end)                                                            
--set @Branch = (case when @Branch = 'ALL' then 'like ''%%''' else ' = '+'replace('''+@Branch+''',''HO'',''CSO'')' end)                     
set @Call_Type = (case when @Call_Type = 'ALL' then 'like ''%%' else ' = '+''''+@Call_Type+'' end)                                   
set @code = (case when @code = '' then 'like ''%%' else ' = '+''''+@code+'' end)                                   
set @entry_by = (case when @entry_by = 'ALL' then 'like ''%%' else ' = '+''''+@entry_by+'' end)                                
                                    
set @str = 'SELECT x.*,y.person_name,z.person_name as secondconftaken,                              
--case when y.person_name is null then x.entry_by else y.person_name end as person_name,                              
case when y.access_code is null then x.grp_id else y.access_code end as access_code                              
 FROM                                    
(                                
select * from                                    
(select distinct             
case when Fld_Courtesy_Call_Type = ''R'' then ''Rotated Calls'' else ''Daily Calls'' end as Fld_Courtesy_Call_Type,Fld_Con_Time,complaint_date,                        
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+subject+''</font></b>'' else subject end as subject,code           
,TIme_Limit,department,dsection, queryfrom,cat_city=city, contact_person,                                    
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+problem+''</font></b>'' else problem end as problem,                          
--case when TIme_Limit = ''Unsatisfied'' then ''<b>''+problem+''</b>'' else problem end as problem,                          
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+suggestion+''</font></b>'' else suggestion end as suggestion,                         
remark,completed_on, status,complaintno,Fld_Server_Ip,party_code,category,dremark,deptmarkcompleteddate as helpdeskmarkcompleteddate,                                     
entry_by,it_conn,grp_id,deptmarkcompleteddate,cast(datediff(Minute,complaint_date, deptmarkcompleteddate) as varchar(50)) + ''Minutes'' as Minutes from                                     
v_complaint_table where complaint_date >='''+@Fdate+' 00:00:000'' and complaint_date <='''+@Tdate+' 23:59:000'' and                                    
Fld_Con_Time like ''%AM%'' and entered_through = ''IT'' and status '+@status+''' and category '+@Category+''' and code '+@code+''' and                                     
entry_by '+@entry_by+''' and grp_id '+@Branch+' and call_type '+@Call_Type+'''               
and Fld_Courtesy_Call_Type '+@Court_Call_Type+''') a
left outer join
(select fld_con_time as contime,code as codesecond,entry_by as entry_bysecond,
case when TIme_Limit = ''Unsatisfied'' then ''<b><font color=red>''+suggestion+''</font></b>'' else suggestion end as suggestionsecond from                                     
v_complaint_table where complaint_date >='''+@Fdate+' 00:00:000'' and complaint_date <='''+@Tdate+' 23:59:000'' and                                    
Fld_Con_Time like ''%pm%'' and entered_through = ''IT'' and status '+@status+''' and category '+@Category+''' and code '+@code+''' and                                     
entry_by '+@entry_by+''' and grp_id '+@Branch+' and call_type '+@Call_Type+'''               
and Fld_Courtesy_Call_Type '+@Court_Call_Type+''') b
on a.code=b.codesecond                                  
)X                                    
LEFT OUTER JOIN                                    
(                                    
SELECT * FROM INTRANET.RISK.DBO.USER_LOGIN where access_code '+@Branch+'                                     
) Y ON X.entry_by = Y.USERNAME 
LEFT OUTER JOIN                                    
(                                    
SELECT * FROM INTRANET.RISK.DBO.USER_LOGIN where access_code '+@Branch+'                                     
) z ON X.entry_bysecond = z.USERNAME 
                                
order by x.Fld_Courtesy_Call_Type,complaint_date'                
--print @str                      
Exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_RPT
-- --------------------------------------------------
CREATE proc USP_IT_RPT(@server as varchar(60),@fdate as varchar(15),@tdate as varchar(15))                                    
as    
    
-- declare @fdate as varchar(11)            
-- declare @tdate as varchar(11)            
-- declare @server as varchar(60)            
declare @sql as varchar(5000)            
declare @opt as varchar(500)            
--     
-- set @fdate = 'Jun 01 2007'          
-- set @tdate = 'Jun 15 2007'          
-- set @server = 'All'  
                    
set  @opt = (select                                  
(case when @server = 'All' then 'like' else '=' end ) )             
    
-- set @sql = 'select a.server,a.issues,a.segment,a.dt,Total_Dt=e.dt,Seg_Loss=a.brk_loss,Total_brok_loss=d.brk_loss,Overall_Loss=f.brk_loss,    
-- Segment_Brok=b.brokerage,Total_brok=c.brokerage,g.dt_per,g.uptime_per,b.uptime from( (select server,issues,segment,dt=sum(convert(dec,dt)),brk_loss=sum(brk_loss) from terminal_brok_loss     
-- where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <>  0 and server '+@opt+''''+replace(@server,'All','%')+'''    
-- group by issues,segment,server )a inner join ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),uptime=sum(convert(dec,uptime)),    
-- dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)             
-- from terminal_brok_loss where server '+@opt+''''+replace(@server,'All','%')+''' and sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment    
-- )b on a.server = b.server and a.segment = b.segment inner join (select server,brokerage=convert(varchar(15),sum(distinct brokerage))    
-- from terminal_brok_loss where server '+@opt+''''+replace(@server,'All','%')+''' and sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by server    
-- )c on a.server = c.server )inner join ( select server,segment,brk_loss=sum(brk_loss) from terminal_brok_loss where sauda_date >= '''+@fdate+''' and     
-- sauda_date <= '''+@tdate+''' and dt <>  0 and server '+@opt+''''+replace(@server,'All','%')+''' group by server,segment )d on a.server = d.server and a.segment = d.segment     
-- inner join (select server,segment,dt=sum(convert(dec,dt))from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and     
-- dt <>  0 and server '+@opt+''''+replace(@server,'All','%')+''' group by server,segment )e on a.server = e.server and a.segment = e.segment inner join     
-- (select server,brk_loss=sum(brk_loss) from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <>  0 and server '+@opt+''''+replace(@server,'All','%')+'''    
-- group by server )f on a.server = f.server inner join ( select server,dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)             
-- from terminal_brok_loss where server '+@opt+''''+replace(@server,'All','%')+''' and sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server ) g on a.server = g.server '    
-- exec (@sql)  


set @sql = 'select a.server,a.issues,a.segment,a.dt,Total_Dt=e.dt,Seg_Loss=a.brk_loss,Total_brok_loss=d.brk_loss,Overall_Loss=f.brk_loss,  
Segment_Brok=b.brokerage,Total_brok=c.brokerage,g.dt_per,g.uptime_per,b.uptime from((select server,issues,segment,dt=sum(convert(dec,dt)),brk_loss=sum(brk_loss) from terminal_brok_loss   
where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and  server '+@opt+''''+replace(@server,'All','%')+'''  
group by issues,segment,server )a inner join ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),uptime=sum(convert(dec,uptime)),  
dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)           
from terminal_brok_loss where server '+@opt+''''+replace(@server,'All','%')+''' and sauda_date >='''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment  
)b on a.server = b.server and a.segment = b.segment inner join (select server,brokerage=convert(varchar(15),sum(distinct brokerage))  
from terminal_brok_loss where server '+@opt+''''+replace(@server,'All','%')+''' and sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by server  
)c on a.server = c.server  )inner join ( select server,segment,brk_loss=sum(brk_loss) from terminal_brok_loss where sauda_date >= '''+@fdate+''' and   
sauda_date <= '''+@tdate+''' and server '+@opt+''''+replace(@server,'All','%')+''' group by server,segment )d on a.server = d.server and a.segment = d.segment   
inner join (select server,segment,dt=sum(convert(dec,dt))from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+''''+replace(@server,'All','%')+''' group by server,segment )e on a.server = e.server and a.segment = e.segment inner join   
(select server,brk_loss=sum(brk_loss) from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and  server '+@opt+''''+replace(@server,'All','%')+''' 
group by server )f on a.server = f.server inner join ( select server,dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)           
from terminal_brok_loss where server '+@opt+''''+replace(@server,'All','%')+''' and sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server ) g on a.server = g.server'
exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_site_Date
-- --------------------------------------------------
    
CREATE Proc USP_IT_site_Date          
(          
@Fld_Site_Code varchar(50),        
@Fld_Location varchar(50),     
@Fld_BranchTag varchar(50),       
@Fld_Connectivity Varchar(50),          
@Fld_RelationShip varchar(15),          
@Fld_Def_Gateway Varchar(50),          
@Fld_Subnet_Mast varchar(50),          
@Fld_Status Varchar(25),          
@Fld_Postal_Address Varchar(50),          
@Fld_Contact_Person Varchar(50),      
@Fld_Contact_No varchar(50),          
@Fld_Email_Id varchar(50),          
@Fld_Connected_Branch varchar(50),          
@Fld_BSE char(1),          
@Fld_NSE char(1),          
@Fld_FO char(1),          
@Fld_BSEFO char(1),          
@Fld_MCX char(1),          
@Fld_NCX char(1),          
@Fld_Odin_Userid_Eq varchar(50),          
@Fld_Odin_Userid_Comm varchar(50),          
@Fld_Server_Ip varchar(10),          
@Fld_Userid varchar(10),          
@Fld_UserLocation varchar(10),          
@Fld_SrNo int         
       
)          
as          
          
if (select count(*) from tbl_IT_site_Data where  Fld_SrNo = @Fld_SrNo) = 0          
Begin          
 insert into tbl_IT_site_Data          
 values          
 (          
 @Fld_Site_Code,         
 @Fld_Location,    
 @Fld_BranchTag,         
 @Fld_Connectivity,          
 @Fld_RelationShip,          
 @Fld_Def_Gateway,          
 @Fld_Subnet_Mast,          
 @Fld_Status,          
 @Fld_Postal_Address,          
 @Fld_Contact_Person,      
 @Fld_Contact_No,          
 @Fld_Email_Id,          
 @Fld_Connected_Branch,          
 @Fld_BSE,          
 @Fld_NSE,          
 @Fld_FO,          
 @Fld_BSEFO,          
 @Fld_MCX,          
 @Fld_NCX,          
 @Fld_Odin_Userid_Eq,          
 @Fld_Odin_Userid_Comm,          
 @Fld_Server_Ip,          
 getdate(),          
 @Fld_Userid,          
 @Fld_UserLocation          
 )          
 Select 'Record Saved !' as MSg          
end          
else          
          
--set @Fld_SrNo = (select Fld_SrNo from tbl_IT_site_Data where Fld_Site_Code = @Fld_Site_Code)          
          
Begin          
 update tbl_IT_site_Data set           
 Fld_Site_Code = @Fld_Site_Code,          
 Fld_Location = @Fld_Location,    
 Fld_BranchTag = @Fld_BranchTag,        
 Fld_Connectivity = @Fld_Connectivity,          
 Fld_RelationShip = @Fld_RelationShip,          
 Fld_Def_Gateway = @Fld_Def_Gateway,          
 Fld_Subnet_Mast = @Fld_Subnet_Mast,          
 Fld_Status = @Fld_Status,          
 Fld_Postal_Address = @Fld_Postal_Address,          
 Fld_Contact_Person = @Fld_Contact_Person,      
 Fld_Contact_No = @Fld_Contact_No,          
 Fld_Email_Id = @Fld_Email_Id,          
 Fld_Connected_Branch = @Fld_Connected_Branch,          
 Fld_BSE = @Fld_BSE,          
 Fld_NSE = @Fld_NSE,          
 Fld_FO = @Fld_FO,          
 Fld_BSEFO = @Fld_BSEFO,          
 Fld_MCX = @Fld_MCX,          
 Fld_NCX = @Fld_NCX,          
 Fld_Odin_Userid_Eq = @Fld_Odin_Userid_Eq,          
 Fld_Odin_Userid_Comm = @Fld_Odin_Userid_Comm,          
 Fld_Server_Ip = @Fld_Server_Ip,          
 Fld_Entry_Date = getdate(),          
 Fld_Userid = @Fld_Userid,          
 Fld_UserLocation = @Fld_UserLocation          
 where Fld_SrNo = @Fld_SrNo          
          
 Select 'Record Updated !' as MSg          
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Rpt_new
-- --------------------------------------------------


CREATE proc [dbo].[USP_IT_Staff_Rpt_new](@yy as varchar(10),@status as varchar(15),@mm as varchar(10),            
@branch as varchar(15),@Fld_CSO varchar(15))                  
as                   
              
create table #t                    
(                    
Sr_No int,                    
Br_tag varchar(150),                    
Br_Name varchar(500)                    
)                                 
                    
if @Fld_CSO = 'ALL' and  @branch = '%%'                      
                    
begin                    
insert into #t                    
exec USP_WAN_Search_Branch '%%'                    
              
insert into #t                      
select 0,'',''                    
end                
              
if @Fld_CSO = 'ALL' and  @branch <> '%%'                      
                    
begin                    
insert into #t                    
 select @branch,'',''                    
end                    
              
              
if @Fld_CSO <> 'ALL' and  @branch = '%%'                   
                    
begin                    
 insert into #t                    
 exec USP_WAN_Search_Branch @Fld_CSO              
end                    
              
if @Fld_CSO <> 'ALL' and @branch <> '%%'                   
              
begin                    
 insert into #t                    
 select @branch,'',''                    
end                    
            
if @Fld_CSO = '' and @branch <> ''                   
              
begin                    
 insert into #t                    
 select @branch,'',''                    
end              
     
if @yy <> '%%'     
begin                
select                 
upper(EMP_NAME) as EMP_NAME ,                
upper(JOB_DES) as JOB_DES,                
upper(PHONE) as PHONE,                
upper(EMP_NO) as EMP_NO,                
upper(JOINDATE) as JOINDATE,        
upper(Department)as Department,        
upper(subdepartment) as subdepartment,          
upper(Emp_region) as region,               
upper(br_Name) as br_Name,          
upper(attnlocation) as attnlocation,        
upper(Costcode) as CostCenter,                
upper(emailadd) as emailadd,                
upper(USERNAME) as USERNAME,                
---upper(USERPASSWORD) as USERPASSWORD,                
upper(USERTYPE) as USERTYPE,                
upper(ACCESS_TO) as ACCESS_TO,                
upper(ACCESS_CODE) as ACCESS_CODE,                  
upper(CAT_NAME) as CAT_NAME,                
case when status = 'A' then 'ACTIVE' else 'DISABLE' end as status,RelieveDate from V_IT_Staff_Rpt_new                   
where yy <= @yy and status like @status --and mm <= @mm       
and Fld_Branch_Id in (select Sr_No from #t)               
 order by convert(datetime,joindate,103)       
end    
else    
begin    
select                 
upper(EMP_NAME) as EMP_NAME ,                
upper(JOB_DES) as JOB_DES,                
upper(PHONE) as PHONE,                
upper(EMP_NO) as EMP_NO,                
upper(JOINDATE) as JOINDATE,        
upper(Department)as Department,        
upper(subdepartment) as subdepartment,          
upper(Emp_region) as region,               
upper(br_Name) as br_Name,          
upper(attnlocation) as attnlocation,        
upper(Costcode) as CostCenter,                
upper(emailadd) as emailadd,                
upper(USERNAME) as USERNAME,                
---upper(USERPASSWORD) as USERPASSWORD,                
upper(USERTYPE) as USERTYPE,                
upper(ACCESS_TO) as ACCESS_TO,                
upper(ACCESS_CODE) as ACCESS_CODE,                  
upper(CAT_NAME) as CAT_NAME,                
case when status = 'A' then 'ACTIVE' else 'DISABLE' end as status,RelieveDate from V_IT_Staff_Rpt_new                   
where status like @status-- and yy like @yy --and mm <= @mm       
and Fld_Branch_Id in (select Sr_No from #t)               
 order by convert(datetime,joindate,103)     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Rpt_new_
-- --------------------------------------------------
CREATE proc USP_IT_Staff_Rpt_new_(@yy as varchar(10),@status as varchar(15),@mm as varchar(10),@branch as varchar(15),@Region as varchar(15),@brtag as varchar(15))    
as    

create table #t      
(      
Sr_No int,      
Br_tag varchar(150),      
Br_Name varchar(500)      
)                   
      
if @branch = '%%' and @Region = 'CSO'            
begin      
 insert into #t      
 exec USP_WAN_Search_Branch '%%'
end      

if @branch = '%%' and @Region <> 'CSO'            
begin      
 insert into #t      
 exec USP_WAN_Search_Branch @Region
end            

else

begin      
 insert into #t      
 exec USP_WAN_Search_Branch @brtag   
end    
    
select   
upper(EMP_NAME) as EMP_NAME ,  
upper(JOB_DES) as JOB_DES,  
upper(PHONE) as PHONE,  
upper(EMP_NO) as EMP_NO,  
upper(JOINDATE) as JOINDATE,  
upper(br_Name) as br_Name,  
upper(emailadd) as emailadd,  
upper(USERNAME) as USERNAME,  
upper(USERPASSWORD) as USERPASSWORD,  
upper(USERTYPE) as USERTYPE,  
upper(ACCESS_TO) as ACCESS_TO,  
upper(ACCESS_CODE) as ACCESS_CODE,    
upper(CAT_NAME) as CAT_NAME,  
case when status = 'A' then 'ACTIVE' else 'DISABLE' end as status,RelieveDate from V_IT_Staff_Rpt_new     
where yy like @yy and status like @status and mm like @mm and Fld_Branch_Id in (select Sr_No from #t)   
order by convert(datetime,joindate,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Rpt_new_M
-- --------------------------------------------------
CREATE proc USP_IT_Staff_Rpt_new_M(@status as varchar(15),               
@branch as varchar(15),@Fld_CSO varchar(15))                      
as                       
                  
create table #t                        
(                        
Sr_No int,                        
Br_tag varchar(150),                        
Br_Name varchar(500)                        
)                                     
                        
if @Fld_CSO = 'ALL' and  @branch = '%%'                          
                        
begin                        
insert into #t                        
exec USP_WAN_Search_Branch '%%'                        
                  
insert into #t                          
select 0,'',''                        
end                    
                  
if @Fld_CSO = 'ALL' and  @branch <> '%%'                          
                        
begin                        
insert into #t                        
 select @branch,'',''                        
end                        
                  
                  
if @Fld_CSO <> 'ALL' and  @branch = '%%'                       
                        
begin                        
 insert into #t                        
 exec USP_WAN_Search_Branch @Fld_CSO                  
end                        
                  
if @Fld_CSO <> 'ALL' and @branch <> '%%'                       
                  
begin                        
 insert into #t                        
 select @branch,'',''                        
end                        
                
if @Fld_CSO = '' and @branch <> ''                       
                  
begin                        
 insert into #t                        
 select @branch,'',''                        
end                  
         
select                     
upper(EMP_NO) as EMP_ID,                               
upper(EMP_NAME) as EMP_NAME ,                      
upper(JOB_DES) as JOB_DES,                      
upper(PHONE) as PHONE,        
upper(JOINDATE) as JOINDATE,              
upper(Department)as Department,              
upper(subdepartment) as subdepartment,        
--HOD              
upper(Emp_region) as region,                     
--LOCATION      
--upper(attendanceLoc) as Location,                
upper(attnlocation) as attnlocation,              
upper(Costcode) as CostCenter,                      
upper(emailadd) as emailadd,         
upper(status) as status,         
upper(relievedate) as relievedate1,                     
case when status = 'A' then 'ACTIVE' else 'DISABLE' end as status1,RelieveDate into #tt  from V_IT_Staff_Rpt_new                       
where status like 'A'-- and yy like @yy --and mm <= @mm           
and Fld_Branch_Id in (select Sr_No from #t)                   
order by convert(datetime,joindate,103)         


select EMP_ID,EMP_NAME,JOB_DES,PHONE,JOINDATE,Department,subdepartment,b.sr_name as HOD,region,attnlocation,CostCenter,emailadd,status,relievedate1 from #t1 a  
inner join  
(select emp_no,sr_name from intranet.risk.dbo.emp_info)b  
on a.emp_id = b.emp_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Rpt_new_Rupali
-- --------------------------------------------------
--USP_IT_Staff_Rpt_new_Rupali '%%','%%','%%','BOK%%','%%'
--select * from tbl_ITStaffMaster
CREATE  proc [dbo].[USP_IT_Staff_Rpt_new_Rupali](@yy as varchar(10),@status as varchar(15),@mm as varchar(10),            
@branch as varchar(15),@Fld_CSO varchar(15))                  
as                   
              
create table #t                    
(                    
Sr_No varchar(20),                    
Br_tag varchar(150),                    
Br_Name varchar(500)                    
)                                 
                    
if @Fld_CSO = 'ALL' and  @branch = '%%'                      
                    
begin                    
insert into #t                    
exec USP_WAN_Search_Branch_ITStaff '%%'                    
              
insert into #t                      
select 0,'',''                    
end                
              
if @Fld_CSO = 'ALL' and  @branch <> '%%'                      
                    
begin                    
insert into #t                    
 select '',@branch,''                    
end                    
              
              
if @Fld_CSO <> 'ALL' and  @branch = '%%'                   
                    
begin                    
 insert into #t                    
 exec USP_WAN_Search_Branch_ITStaff @Fld_CSO              
end                    
              
if @Fld_CSO <> 'ALL' and @branch <> '%%'                   
              
begin                    
 insert into #t                    
 select '',@branch,''                    
end                    
            
if @Fld_CSO = '' and @branch <> ''                   
              
begin                    
 insert into #t                    
 select '',@branch,''                    
end              



 If((@yy = '%%') and (@status = '%%'))
 Begin 
    select  
	upper(EMP_NAME) as EMP_NAME ,                
	upper(Designation) as JOB_DES,                
	upper(PHONE) as PHONE,                
	upper([Emp No]) as EMP_NO,                
	convert(varchar(11),upper(JOINDATE),113) as JOINDATE,        
	upper(Department)as Department,        
	upper([Sub Department]) as [subdepartment],          
	upper(Region) as region,               
	upper(Costcode) as br_Name,          
	upper(AttendanceLoc) as attnlocation,        
	upper(Costcode) as CostCenter,                
	upper(emailadd) as emailadd,                
	upper(EMP_NAME) as USERNAME,                
	'' as USERPASSWORD,                
	'' as USERTYPE,                
	'' as ACCESS_TO,                
	'' as ACCESS_CODE,                  
	'' as CAT_NAME,                
	case when status = 'A' then 'ACTIVE' else 'DISABLE' end as [status],
	(case when  [Emp No] IN (select username from [INTRANET].rolemgm.dbo.user_login)  then 'Yes' else 'NO' End) as RM_User,
	convert(varchar(11),upper([Separation Date]),113) as [RelieveDate],
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	       then (select  ITSO_CSCP from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as CSCP,
	 (case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_1 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group1,
	 (case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_2 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group2 
	from tbl_ITStaffMaster  with(nolock)                 
	where     
	Costcode in (select Br_tag from #t)               
	 order by convert(datetime,joindate,103)
  End    
Else If ((@yy <> '%%') and (@status = 'A'))
Begin             
	select  
	upper(EMP_NAME) as EMP_NAME ,                
	upper(Designation) as JOB_DES,                
	upper(PHONE) as PHONE,                
	upper([Emp No]) as EMP_NO,                
	convert(varchar(11),upper(JOINDATE),113) as JOINDATE,        
	upper(Department)as Department,        
	upper([Sub Department]) as [subdepartment],          
	upper(Region) as region,               
	upper(Costcode) as br_Name,          
	upper(AttendanceLoc) as attnlocation,        
	upper(Costcode) as CostCenter,                
	upper(emailadd) as emailadd,                
	upper(EMP_NAME) as USERNAME,                
	'' as USERPASSWORD,                
	'' as USERTYPE,                
	'' as ACCESS_TO,                
	'' as ACCESS_CODE,                  
	'' as CAT_NAME,                
	case when status = 'A' then 'ACTIVE' else 'DISABLE' end as [status],
	(case when  [Emp No] IN (select username from [INTRANET].rolemgm.dbo.user_login)  then 'Yes' else 'NO' End) as RM_User,
	convert(varchar(11),upper([Separation Date]),113) as RelieveDate,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	      then (select  ITSO_CSCP from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as CSCP,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_1 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group1,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_2 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group2 
	from tbl_ITStaffMaster with(nolock)                 
	where 
	datepart(yy,Joindate)<= @yy  
	--and datepart(mm,Joindate) <=@mm 
	and status = 'A'
	 --and mm <= @mm       
	and Costcode in (select Br_tag from #t)               
	 order by convert(datetime,joindate,103) 
 End  
Else If ((@yy = '%%') and (@status = 'A'))
begin             
	select  
	upper(EMP_NAME) as EMP_NAME ,                
	upper(Designation) as JOB_DES,                
	upper(PHONE) as PHONE,                
	upper([Emp No]) as EMP_NO,                
	convert(varchar(11),upper(JOINDATE),113) as JOINDATE,        
	upper(Department)as Department,        
	upper([Sub Department]) as [subdepartment],          
	upper(Region) as region,               
	upper(Costcode) as br_Name,          
	upper(AttendanceLoc) as attnlocation,        
	upper(Costcode) as CostCenter,                
	upper(emailadd) as emailadd,                
	upper(EMP_NAME) as USERNAME,                
	'' as USERPASSWORD,                
	'' as USERTYPE,                
	'' as ACCESS_TO,                
	'' as ACCESS_CODE,                  
	'' as CAT_NAME,                
	case when status = 'A' then 'ACTIVE' else 'DISABLE' end as [status],
	(case when  [Emp No] IN (select username from [INTRANET].rolemgm.dbo.user_login)  then 'Yes' else 'NO' End) as RM_User,
	convert(varchar(11),upper([Separation Date]),113) as RelieveDate,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	    then (select  ITSO_CSCP from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as CSCP,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_1 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group1,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_2 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group2 
	from tbl_ITStaffMaster  with(nolock)                 
	where 

	--and datepart(mm,Joindate) <=@mm 
	 status = 'A'
	 --and mm <= @mm       
	and Costcode in (select Br_tag from #t)               
	 order by convert(datetime,joindate,103) 
End      
Else If ((@yy = '%%') and (@status = 'D'))
Begin    
	select                 
	upper(EMP_NAME) as EMP_NAME ,                
	upper(Designation) as JOB_DES,                
	upper(PHONE) as PHONE,                
	upper([Emp No]) as EMP_NO,                
	convert(varchar(11),upper(JOINDATE),113) as JOINDATE,   
	upper(Department)as Department,        
	upper([Sub Department]) as [subdepartment],          
	upper(Region) as region,               
	upper(Costcode) as br_Name,          
	upper(AttendanceLoc) as attnlocation,        
	upper(Costcode) as CostCenter,                
	upper(emailadd) as emailadd,                
	upper(EMP_NAME) as USERNAME,                
	'' as USERPASSWORD,                
	'' as USERTYPE,                
	'' as ACCESS_TO,                
	'' as ACCESS_CODE,                  
	'' as CAT_NAME,                
	case when status = 'A' then 'ACTIVE' else 'DISABLE' end as [status],
	(case when  [Emp No] IN (select username from [INTRANET].rolemgm.dbo.user_login)  then 'Yes' else 'NO' End) as RM_User,
	convert(varchar(11),upper([Separation Date]),113) as RelieveDate,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	    then (select  ITSO_CSCP from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as CSCP,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_1 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group1,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_2 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group2 
	from tbl_ITStaffMaster with(nolock)                  
	where status in ('S','H','D','I')-- and yy like @yy --and mm <= @mm       
	and rtrim(ltrim(Costcode)) in (select rtrim(ltrim(Br_tag)) from #t)               
	 order by convert(datetime,[joindate],103)     
End
Else If ((@yy <> '%%') and (@status <> 'D'))
Begin    
	select                 
	upper(EMP_NAME) as EMP_NAME ,                
	upper(Designation) as JOB_DES,                
	upper(PHONE) as PHONE,                
	upper([Emp No]) as EMP_NO,                
	convert(varchar(11),upper(JOINDATE),113) as JOINDATE,        
	upper(Department)as Department,        
	upper([Sub Department]) as [subdepartment],          
	upper(Region) as region,               
	upper(Costcode) as br_Name,          
	upper(AttendanceLoc) as attnlocation,        
	upper(Costcode) as CostCenter,                
	upper(emailadd) as emailadd,                
	upper(EMP_NAME) as USERNAME,                
	'' as USERPASSWORD,                
	'' as USERTYPE,                
	'' as ACCESS_TO,                
	'' as ACCESS_CODE,                  
	'' as CAT_NAME,                
	case when status = 'A' then 'ACTIVE' else 'DISABLE' end as [status],
	(case when  [Emp No] IN (select username from [INTRANET].rolemgm.dbo.user_login)  then 'Yes' else 'NO' End) as RM_User,
	convert(varchar(11),upper([Separation Date]),113) as RelieveDate,
	(case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_CSCP from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as CSCP,
    (case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_1 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group1,
	 (case when  [Emp No] IN (select ITSO_EmpID from tbl_ITStaff_OtherDetails)  
	     then (select  ITSO_Group_2 from tbl_ITStaff_OtherDetails where ITSO_EmpID=[Emp No]) else '' End) as Group2 
	from tbl_ITStaffMaster  with(nolock)                  
	where status in ('S','H','D','I')
	and datepart(yy,Joindate)<= @yy  
	--and mm <= @mm       
	and rtrim(ltrim(Costcode)) in (select rtrim(ltrim(Br_tag)) from #t)               
	 order by convert(datetime,[joindate],103)     
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Rpt_new1
-- --------------------------------------------------

CREATE proc USP_IT_Staff_Rpt_new1(@yy as varchar(10),@status as varchar(15),@mm as varchar(10),  
@branch as varchar(15),@Fld_CSO varchar(15),@region varchar(10))        
as       
    
    
create table #t          
(          
Sr_No int,          
Br_tag varchar(150),          
Br_Name varchar(500)          
)                       
          
if @Fld_CSO = 'CSO' and  @branch = '%%'            
          
begin          
insert into #t          
exec USP_WAN_Search_Branch '%%'          
    
insert into #t            
select 0,'',''          
end          
    
    
if @Fld_CSO = 'CSO' and  @branch <> '%%'            
          
begin          
insert into #t          
 select @branch,'',''          
end          
    
    
if @Fld_CSO <> 'CSO' and  @branch = '%%'         
          
begin          
 insert into #t          
 exec USP_WAN_Search_Branch @Fld_CSO    
end          
    
if @Fld_CSO <> 'CSO' and @branch <> '%%'         
    
begin          
 insert into #t          
 select @branch,'',''          
end          
  
if @Fld_CSO = '' and @branch <> ''         
    
begin          
 insert into #t          
 select @branch,'',''          
end    
        
select       
upper(EMP_NAME) as EMP_NAME ,      
upper(JOB_DES) as JOB_DES,      
upper(PHONE) as PHONE,      
upper(EMP_NO) as EMP_NO,      
upper(JOINDATE) as JOINDATE,      
upper(br_Name) as br_Name,      
upper(emailadd) as emailadd,      
upper(USERNAME) as USERNAME,      
upper(USERPASSWORD) as USERPASSWORD,      
upper(USERTYPE) as USERTYPE,      
upper(ACCESS_TO) as ACCESS_TO,      
upper(ACCESS_CODE) as ACCESS_CODE,        
upper(CAT_NAME) as CAT_NAME,      
case when status = 'A' then 'ACTIVE' else 'DISABLE' end as status,RelieveDate from V_IT_Staff_Rpt_new         
where yy like @yy and status like @status and mm like @mm and access_code like @region and Fld_Branch_Id in (select Sr_No from #t)     
 order by convert(datetime,joindate,103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Summ_Rpt
-- --------------------------------------------------
CREATE proc USP_IT_Staff_Summ_Rpt                  
(                  
@yy varchar(10),                  
@mm varchar(10),            
@Fld_CSO as varchar(10),    
@fld_branch as varchar(10)                  
)                  
as            
--truncate table #t    
--select * from #t    
create table #t            
(            
Sr_No int,            
Br_tag varchar(150),            
Br_Name varchar(500)            
)                         
      
--declare @yy varchar(10),            
--@mm varchar(10),            
--@Fld_CSO varchar(10),      
--@fld_branch varchar(10)    
--    
--set @yy='%%'           
--set @mm='%%'      
--set @Fld_CSO='%%'           
--set @fld_branch='ACM'             
if @fld_branch = '%%'            
            
begin            
 insert into #t            
 exec USP_WAN_Search_Branch @Fld_CSO           
end            
else            
begin            
 insert into #t            
 --select @fld_branch,'',''            
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from tbl_it_br_master (nolock) where Sr_No = @fld_branch      
end       
          
    
select x.Loc_Name,          
x.fld_branch_id,                  
isnull(x.total,0) as total,                  
isnull(y.Active,0) as Active,                  
isnull(z.Disabled,0) as  Disabled from                   
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Total     
from V_IT_Staff_Rpt_new where /*yy like @yy and mm like @mm and*/ Fld_Branch_id in (select Sr_No from #t)     
 group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)x                  
left outer join                  
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Active from     
V_IT_Staff_Rpt_new where  /*yy like @yy and mm like @mm and*/ status = 'A' and Fld_Branch_id in     
(select Sr_No from #t)  group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)y                 
on x.Loc_Name = y.Loc_Name                  
left outer join                  
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Disabled from     
V_IT_Staff_Rpt_new where  /*yy like @yy and mm like @mm and*/ status = 'D' and Fld_Branch_id in     
(select Sr_No from #t)  group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)z      
on x.Loc_Name = z.Loc_Name                  
order by x.Loc_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Summ_Rpt_
-- --------------------------------------------------
CREATE proc USP_IT_Staff_Summ_Rpt_              
(              
@yy varchar(10),              
@mm varchar(10),        
@branch as varchar(10),  
@Region as varchar(15)           
)              
as              
  
declare @brtag as varchar(15)

-- declare @yy varchar(10)
-- declare @mm varchar(10)
-- declare @branch  varchar(10)
-- declare @Region varchar(15)
-- declare @brtag as varchar(15)
-- 
-- set @yy = '%%'
-- set @mm = '%%'
-- set @branch = '%%'
-- set @Region = 'CSO'
--   
  
create table #t        
(        
Sr_No int,        
Br_tag varchar(150),        
Br_Name varchar(500)        
)                     
        
if @branch = '%%' and @Region = 'CSO'              
begin        
 insert into #t        
 exec USP_WAN_Search_Branch '%%'  
end        
  
if @branch = '%%' and @Region <> 'CSO'              
begin        
 insert into #t        
 exec USP_WAN_Search_Branch @Region  
end              
  
if @branch <> '%%' and @Region <> 'CSO'              
  
begin          
 set @brtag = (select Br_tag from tbl_IT_br_master where Sr_No = @branch)   
 insert into #t        
 exec USP_WAN_Search_Branch @brtag     
end      
  
  
select x.Loc_Name,      
x.fld_branch_id,              
isnull(x.total,0) as total,              
isnull(y.Active,0) as Active,              
isnull(z.Disabled,0) as  Disabled from               
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Total from V_IT_Staff_Rpt_new where yy like @yy and mm like @mm and Fld_Branch_id in (select Sr_No from #t) group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)x           
   
left outer join              
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Active from V_IT_Staff_Rpt_new where  yy like @yy and mm like @mm and status = 'A' and Fld_Branch_id in (select Sr_No from #t) group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)y              
on x.Loc_Name = y.Loc_Name              
left outer join              
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Disabled from V_IT_Staff_Rpt_new where  yy like @yy and mm like @mm and status = 'D' and Fld_Branch_id in (select Sr_No from #t) group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)z              
on x.Loc_Name = z.Loc_Name              
order by x.Loc_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Summ_Rpt_m
-- --------------------------------------------------
CREATE proc USP_IT_Staff_Summ_Rpt_m                    
(                                
@Fld_CSO as varchar(10),      
@fld_branch as varchar(10)                    
)                    
as              
--truncate table #t      
--select * from #t      
create table #t              
(              
Sr_No int,              
Br_tag varchar(150),              
Br_Name varchar(500)              
)                           
        
--declare @yy varchar(10),              
--@mm varchar(10),              
--@Fld_CSO varchar(10),        
--@fld_branch varchar(10)      
--      
--set @yy='%%'             
--set @mm='%%'        
--set @Fld_CSO='%%'             
--set @fld_branch='ACM'               
if @fld_branch = '%%'              
              
begin              
 insert into #t              
 exec USP_WAN_Search_Branch @Fld_CSO             
end              
else              
begin              
 insert into #t              
 --select @fld_branch,'',''              
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from tbl_it_br_master (nolock) where Sr_No = @fld_branch        
end         
            
      
select x.Loc_Name,            
x.fld_branch_id,                    
isnull(x.total,0) as total,                    
isnull(y.Active,0) as Active,                    
isnull(z.Disabled,0) as  Disabled from                     
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Total       
from V_IT_Staff_Rpt_new where /*yy like @yy and mm like @mm and*/ Fld_Branch_id in (select Sr_No from #t)       
 group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)x                    
left outer join                    
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Active from       
V_IT_Staff_Rpt_new where  /*yy like @yy and mm like @mm and*/ status = 'A' and Fld_Branch_id in       
(select Sr_No from #t)  group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)y                   
on x.Loc_Name = y.Loc_Name                    
left outer join                    
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Disabled from       
V_IT_Staff_Rpt_new where  /*yy like @yy and mm like @mm and*/ status = 'D' and Fld_Branch_id in       
(select Sr_No from #t)  group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)z        
on x.Loc_Name = z.Loc_Name                    
order by x.Loc_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Summ_Rpt_New
-- --------------------------------------------------
CREATE proc [dbo].[USP_IT_Staff_Summ_Rpt_New]                  
(                  
@yy varchar(10),                  
@mm varchar(10),            
@Fld_CSO as varchar(10),    
@fld_branch as varchar(10)                  
)                  
as            
--truncate table #t    
--select * from #t    
create table #t            
(            
Sr_No int,            
Br_tag varchar(150),            
Br_Name varchar(500)            
)                         
      
--declare @yy varchar(10),            
--@mm varchar(10),            
--@Fld_CSO varchar(10),      
--@fld_branch varchar(10)    
--    
--set @yy='%%'           
--set @mm='%%'      
--set @Fld_CSO='%%'           
--set @fld_branch='ACM'             
if @fld_branch = '%%'            
            
begin            
 insert into #t            
 exec USP_WAN_Search_Branch @Fld_CSO           
end            
else            
begin            
 insert into #t            
 --select @fld_branch,'',''            
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from tbl_it_br_master (nolock) where Sr_No = @fld_branch      
end       
          
    
select x.Loc_Name,x.fld_branch_id,                  
isnull(x.total,0) as total,                  
isnull(y.Active,0) as Active,                  
isnull(z.Disabled,0) as  Disabled 
from 
(select ITS.It_Location as fld_branch_id,upper(ITB.Br_Tag)+'-'+upper(ITB.br_Name) as Loc_Name,count(*) as Total     
 from tbl_ITStaffMaster ITS,  tbl_it_br_master ITB
 where  ITS.It_Location =upper(ITB.Br_Tag)
group by upper(ITB.br_tag)+'-'+upper(ITB.br_Name),ITS.It_Location)x
left outer join 

(select ITS.It_Location  as fld_branch_id,upper(ITB.Br_Tag)+'-'+upper(ITB.br_Name) as Loc_Name,count(*) as Active     
 from tbl_ITStaffMaster ITS,  tbl_it_br_master ITB  where  /*yy like @yy and mm like @mm and*/ [STATUS] = 'A'    
and ITS.It_Location =upper(ITB.Br_Tag)  
 group by upper(ITB.Br_Tag)+'-'+upper(ITB.br_Name),ITS.It_Location )  y   
 on x.fld_branch_id = y.fld_branch_id
 left outer join 
 (select ITS.It_Location as fld_branch_id,upper(ITB.Br_Tag)+'-'+upper(ITB.br_Name) as Loc_Name,count(*) as Disabled     
 from tbl_ITStaffMaster ITS,  tbl_it_br_master ITB   where  /*yy like @yy and mm like @mm and*/ [STATUS] <> 'A'   
and ITS.It_Location =upper(ITB.Br_Tag) 
 group by upper(ITB.Br_Tag)+'-'+upper(ITB.br_Name),It_Location ) z          
on x.fld_branch_id = z.fld_branch_id                  
order by x.fld_branch_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Summ_Rpt1
-- --------------------------------------------------

CREATE proc USP_IT_Staff_Summ_Rpt1                      
(                      
@yy varchar(10),                      
@mm varchar(10),                
@branch as varchar(10),         
@region varchar(10)                     
)                      
as          
                
select x.Loc_Name,              
x.fld_branch_id,                      
isnull(x.total,0) as total,                      
isnull(y.Active,0) as Active,                      
isnull(z.Disabled,0) as  Disabled from                       
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Total from V_IT_Staff_Rpt_new where yy like @yy and mm like @mm and Emp_region in (select fld_SrNo from tbl_region_master where fld_regcode=@region)  and Fld_Branch_id like @branch group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)x                      
left outer join                      
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Active from V_IT_Staff_Rpt_new where  yy like @yy and mm like @mm and status = 'A' and Fld_Branch_id like @branch  group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)y    
                        
on x.Loc_Name = y.Loc_Name                      
left outer join                      
(select fld_branch_id,upper(br_tag)+'-'+upper(br_Name) as Loc_Name,count(*) as Disabled from V_IT_Staff_Rpt_new where  yy like @yy and mm like @mm and status = 'D' and Fld_Branch_id like @branch  group by upper(br_tag)+'-'+upper(br_Name),fld_branch_id)z  
                          
on x.Loc_Name = z.Loc_Name                      
order by x.Loc_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Summ_Rpt2
-- --------------------------------------------------
CREATE proc [dbo].[USP_IT_Staff_Summ_Rpt2]                  
(                  
@yy varchar(10),                  
@mm varchar(10),            
@Fld_CSO as varchar(10),    
@fld_branch as varchar(10)                  
)                  
as            
  
create table #t            
(            
Sr_No int,            
Br_tag varchar(150),            
Br_Name varchar(500)            
)                         
         
if @fld_branch = '%%'            
            
begin            
 insert into #t            
 exec USP_WAN_Search_Branch @Fld_CSO           
end            
else            
begin            
 insert into #t            
 --select @fld_branch,'',''            
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from tbl_it_br_master (nolock) where Br_Tag = @fld_branch      
end       

select * from V_IT_Staff_Rpt_new where Fld_Branch_Id in (select Sr_No from #t) order by Emp_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IT_Staff_Summ_Rpt2_New
-- --------------------------------------------------
CREATE proc [dbo].[USP_IT_Staff_Summ_Rpt2_New]                  
(                  
@yy varchar(10),                  
@mm varchar(10),            
@Fld_CSO as varchar(10),    
@fld_branch as varchar(10)                  
)                  
as            
  
create table #t            
(            
Sr_No int,            
Br_tag varchar(150),            
Br_Name varchar(500)            
)                         
         
if @fld_branch = '%%'            
            
begin            
 insert into #t            
 exec USP_WAN_Search_Branch @Fld_CSO           
end            
else            
begin            
 insert into #t            
 --select @fld_branch,'',''            
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from tbl_it_br_master (nolock) where Br_Tag = @fld_branch      
end       

select * from V_IT_Staff_Rpt_New_rupali
 where Fld_Branch_Id in (select Sr_No from #t) order by Emp_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_it_Taxes
-- --------------------------------------------------
CREATE proc Usp_it_Taxes      
(      
@Fld_RequestID int,      
@Fld_Excise Float,      
@Fld_Edn_Cess Float,      
@Fld_CST Float,      
@Fld_VAT Float,      
@Fld_Service Float,      
@Fld_Frieght Float,      
@Fld_Octroi Float,      
@Fld_Discount Float,      
@Fld_Status Varchar(10)    
)      
as   

delete from tbl_it_Taxes where Fld_RequestId = @Fld_RequestID

/*
if (select count(*) from tbl_it_Taxes (nolock) where Fld_RequestId = @Fld_RequestId) = 0   
begin    */
insert into tbl_it_Taxes values(@Fld_RequestID,@Fld_Excise,@Fld_Edn_Cess,@Fld_CST,@Fld_VAT,@Fld_Service,@Fld_Frieght,@Fld_Octroi,@Fld_Discount,@Fld_Status)   

/*
end  
else  
begin   
  update tbl_it_Taxes set                                             
 Fld_Excise=@Fld_Excise,  
 Fld_Edn_Cess=@Fld_Edn_Cess,  
 Fld_CST=@Fld_CST,  
 Fld_VAT=@Fld_VAT,  
 Fld_Service=@Fld_Service,  
 Fld_Frieght=@Fld_Frieght,  
 Fld_Octroi=@Fld_Octroi,  
 Fld_Discount=@Fld_Discount,  
 Fld_Status=@Fld_Status              
  where Fld_RequestId = @Fld_RequestId   
end*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITAssetsData
-- --------------------------------------------------
  
CREATE Proc USP_ITAssetsData                                                                  
(                                                                  
@Fld_RequestId int,                                                  
@Fld_ProductType varchar(50),                                                     
@Fld_ProductName varchar(50),                                                  
@Fld_ProductModel varchar(50),                                
@Fld_ProductDesc  varchar(1000),                                       
@Fld_AssetName varchar(50),                                                
@Fld_AssetTag varchar(50),                                           
@Fld_PartNo varchar(20),                                                
@Fld_VendorName varchar(100),                                                  
@Fld_Qty int,                                                  
@Fld_Rate decimal,                                                  
@Fld_WarrantyFrom datetime,                                                  
@Fld_WarrantyTo datetime,                                                  
@Fld_BranchCode varchar(15),                                                  
@Fld_AssignToDept varchar(15),                                                  
@Fld_BillNo varchar(15),                                                  
@Fld_ChallanNo varchar(15),                                                  
@Fld_Purpose varchar(500),                                                  
@Fld_Status varchar(5),      
@Fld_Warrantytype varchar(20),  
@Fld_PId varchar(20),    
@RequestTableSrNo int                                                                                         
)                                                                  
as                                                                 
                       
exec usp_GenAssetTag @Fld_RequestId,@Fld_AssetName                                           
set @Fld_AssetTag=(select assettag from ##file1)                                                
                                                           
------------------------New Purchase Order-----------------                 
/*                                                         
if (select count(*) from tbl_ITAssetsData (nolock) where Fld_RequestId = @Fld_RequestId and Fld_AssetName = @Fld_AssetName) = 0                                                                  
Begin   */         
    select * from tbl_ITAssetsData                                                          
 insert into tbl_ITAssetsData values                                                                   
 (                                                                 
@Fld_RequestId,                                                   
@Fld_ProductType,                                                     
@Fld_ProductName,                                                  
@Fld_ProductModel,                                 
@Fld_ProductDesc,                                        
@Fld_AssetName,                                                 
@Fld_AssetTag,                                          
@Fld_PartNo,                                                  
@Fld_VendorName,                                                  
@Fld_Qty,                                                  
@Fld_Rate,                                                  
@Fld_WarrantyFrom,                                                  
@Fld_WarrantyTo,                                                  
@Fld_BranchCode,                                                  
@Fld_AssignToDept,                                                  
@Fld_BillNo,                                                  
@Fld_ChallanNo,                                                  
@Fld_Purpose,                                                  
@Fld_Status,                                                  
getdate(),                  
'',                              
@Fld_Warrantytype,      
@Fld_PId,    
@RequestTableSrNo                                       
)                                                                  
        
/*        
end                                                             
else                                                                
---------------------Edit--------------------------------                    
Begin                                    
update tbl_ITAssetsData set                                                                  
Fld_RequestId = @Fld_RequestId,                                           
Fld_ProductType = @Fld_ProductType,                                                     
Fld_ProductName = Fld_ProductName,                                                  
Fld_ProductModel = @Fld_ProductModel,                                 
Fld_ProductDesc= @Fld_ProductDesc,                                        
Fld_AssetName = @Fld_AssetName,                                        
--Fld_AssetTag = @Fld_AssetTag,                                          
Fld_PartNo=@Fld_PartNo,                                         
Fld_VendorName = @Fld_VendorName,                                                  
Fld_Qty = @Fld_Qty,                                                  
Fld_Rate = @Fld_Rate,                                  
Fld_WarrantyFrom = @Fld_WarrantyFrom,                                                  
Fld_WarrantyTo = @Fld_WarrantyTo,                                                  
--Fld_BranchCode = @Fld_BranchCode,                                    
Fld_AssignToDept = @Fld_AssignToDept,                                                  
Fld_BillNo = @Fld_BillNo,                                                  
Fld_ChallanNo = @Fld_ChallanNo,                                                  
Fld_Purpose = @Fld_Purpose,                                                
Fld_Status = @Fld_Status,                                     
Fld_SystemDate = getdate()                                                  
 where Fld_RequestId = @Fld_RequestId and Fld_AssetName = @Fld_AssetName                                                                 
end         
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITAssetsDataEntry
-- --------------------------------------------------

CREATE Proc USP_ITAssetsDataEntry                            
(                                         
@Fld_ProductModel varchar(50),      
@Fld_ProductDesc varchar(100),          
@Fld_AssetName varchar(50),              
@Fld_AssetTag varchar(50),              
@Fld_PartNo varchar(50),          
@Fld_VendorName varchar(100),              
@Fld_Qty numeric,              
@Fld_Rate numeric,              
@Fld_WarrantyFrom varchar(11),              
@Fld_WarrantyTo varchar(11),              
@Fld_BranchCode varchar(20),              
@Fld_AssignToDept varchar(20),              
@Fld_BillNo varchar(20),              
@Fld_ChallanNo varchar(20),              
@Fld_Purpose varchar(500),              
@Fld_Status varchar(4),       
@Fld_CapexName varchar(20),      
@Fld_WarrantyType varchar(30)                        
)                              
as                              
set @Fld_WarrantyFrom = convert(datetime,@Fld_WarrantyFrom,103)            
set @Fld_WarrantyTo = convert(datetime,@Fld_WarrantyTo,103)      
    
    
-----------------Generate Asset Tag--------------------    
declare @assetTag as  varchar(100)      
declare @Tag as varchar(50)     
set @Tag =@Fld_BranchCode+'/'+@Fld_AssetName+'/'    
if (select count(Fld_AssetTag) from tbl_ITAssetsData(nolock) where Fld_AssetTag like''+@Tag+'%') = 0              
begin                
set @assetTag = @Tag+'0001'              
end              
else              
begin     
declare @assetCount as varchar(4)              
set @assetCount =(select right(Max(Fld_AssetTag),4) from tbl_ITAssetsData(nolock) where Fld_AssetTag like ''+@Tag+'%')              
set @assetCount=replace(str(isnull(@assetCount+1,0),4),' ',0)              
--print @assetCount              
set @assetTag = @Tag+@assetCount     
end                           
------------------------New Request-----------------                              
if (select count(*) from tbl_ITAssetsData(nolock) where Fld_PartNo = @Fld_PartNo and Fld_AssetName=@Fld_AssetName) = 0                              
Begin                            
 insert into tbl_ITAssetsData values                               
 (                 
'',              
'',              
'',              
@Fld_ProductModel,      
@Fld_ProductDesc,           
@Fld_AssetName,             
@assetTag,            
@Fld_PartNo,            
@Fld_VendorName,              
@Fld_Qty,              
@Fld_Rate,              
@Fld_WarrantyFrom,              
@Fld_WarrantyTo,              
@Fld_BranchCode,              
@Fld_AssignToDept,              
@Fld_BillNo,              
@Fld_ChallanNo,              
@Fld_Purpose,              
@Fld_Status,              
getdate(),      
@Fld_CapexName,       
@Fld_WarrantyType,
'0',
'0'                           
 )                              
end                              
else                               
---------------------Edit----------------                             
Begin                              
  update tbl_ITAssetsData set                              
 --Fld_ProductType=@Fld_ProductType,              
 --Fld_ProductName=@Fld_ProductName,              
 Fld_ProductModel=@Fld_ProductModel,              
 Fld_AssetName=@Fld_AssetName,          
 Fld_AssetTag=@Fld_AssetTag,          
 Fld_PartNo=@Fld_PartNo,              
 Fld_VendorName=@Fld_VendorName,              
 Fld_Qty=@Fld_Qty,              
 Fld_Rate=@Fld_Rate,              
 Fld_WarrantyFrom=@Fld_WarrantyFrom,              
 Fld_WarrantyTo=@Fld_WarrantyTo,              
 Fld_BranchCode=@Fld_BranchCode,              
 Fld_AssignToDept=@Fld_AssignToDept,              
 Fld_BillNo=@Fld_BillNo,              
 Fld_ChallanNo=@Fld_ChallanNo,              
 Fld_Purpose=@Fld_Purpose,              
 Fld_Status=@Fld_Status                          
   where Fld_PartNo = @Fld_PartNo and Fld_AssetName=@Fld_AssetName                             
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITBRMaster_Reco_EMail
-- --------------------------------------------------
CREATE Proc [dbo].[USP_ITBRMaster_Reco_EMail]  
  
as  
  
BEGIN  
  
DECLARE @BODY nvarchar(max)  
DECLARE @HTMLBODY nvarchar(max)  
DECLARE @Record int    
DECLARE @Sub nvarchar(max)    
  
/***** SEND E-MAIL OF MISMATCH *****/    
  
select @Record=count(*) from [MIDDLEWARE].harmony.DBO.VLMSINhouse with (nolock)  
where department = 'IT' and ltrim(rtrim(costcode)) not in   
 (  
  select distinct ltrim(rtrim(Br_Tag)) from Tbl_IT_Br_Master with (nolock)  
 )  
group by costcode   
  
 IF @Record > 0    
  BEGIN   
    
 --select costcode, Emp=COUNT(distinct [emp no])   
 --into #Tmp  
 --from VLMSInhouse_Users with (nolock)  
 --where department = 'IT' and costcode not in   
 --(  
 -- select distinct Br_Tag from Tbl_IT_Br_Master with (nolock)  
 --) group by costcode order by costcode  
      
      
 select costcode as CostCode ,  
 [emp no] as EmpNo , Emp_Name as EmployeeName,Location,  
 Phone as Phone, convert(varchar(11),Joindate,113) as Joindate , Emailadd as EmailID , [Status] as Status  
    into #Tmp  
 From [MIDDLEWARE].harmony.DBO.VLMSINhouse with (nolock)  
 where department = 'IT' and ltrim(rtrim(Costcode)) not in   
 (  
  select distinct ltrim(rtrim(Br_Tag)) from Tbl_IT_Br_Master with (nolock)  
 )   
   
 exec DBA_admin.dbo.DBA_ConvertQueryInHTML  
 'select * from #Tmp', @BODY output    
   
 drop table #Tmp  
   
 SET @HTMLBODY = 'Following Branches not found in IT Branch Master : '+@BODY  
   
  END  
 ELSE    
  SET @HTMLBODY = 'All Branches of Employee Master for IT Employees are available in IT Branch Master.'  
    
 SET @Sub = 'IT Branch Master Reco - '+convert(varchar(11),GETDATE(),103)    
   
    
 EXEC msdb.dbo.sp_send_dbmail    
  @profile_name = 'DBA',    
  @recipients='RadhikaR.Sawant@angelbroking.com;Dhiraj.Waghle@angelbroking.com',  
  --@recipients='Rupali.Mayekar@AngelBroking.com',   
  @copy_recipients='Rupali.Mayekar@AngelBroking.com',    
  @subject = @Sub,    
  @body = @HTMLBODY,    
  @body_format = 'HTML'   
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ItPurchaseOrder
-- --------------------------------------------------
CREATE Proc USP_ItPurchaseOrder                                    
(                                      
@Fld_RequestId int,                
@Fld_VendorId int,                
@Fld_VendorName varchar(100),                
@Fld_PurchaseOrderNo varchar(50),                
@Fld_ShipTo varchar(200),                
@Fld_ShippingMethod varchar(20),                
@Fld_OrderTerms varchar(50),                
@Fld_CompID int,        
@Fld_Pid int,    
@POBranch varchar(20),
@PODeliveryTime varchar(20)            
)                                      
as                                     
        
--declare @str1 as  varchar(100)            
--set @str1='AKT/MUM/'+convert(varchar(11),getdate(),103)+'-'+convert(varchar,@Fld_RequestId)              
             
if (select count(*) from tbl_ItRequestPurchaseOrder(nolock) where Fld_PId = @Fld_Pid) = 0                                      
Begin                  
---------------------insert--------------------------------                                     
 insert into tbl_ItRequestPurchaseOrder values                                       
 (                                       
@Fld_RequestId,                
@Fld_VendorId,                 
@Fld_VendorName,                 
@Fld_PurchaseOrderNo,                 
@Fld_ShipTo,                 
@Fld_ShippingMethod ,                
@Fld_OrderTerms,                     
getdate(),          
@Fld_CompID,        
@Fld_Pid,    
@POBranch,
@PODeliveryTime                                    
)                                      
end                                      
else                                       
---------------------Edit--------------------------------                      
Begin                                      
update tbl_ItRequestPurchaseOrder set                                      
Fld_RequestId=@Fld_RequestId,                
Fld_VendorId=@Fld_VendorId,                 
Fld_VendorName=@Fld_VendorName,                 
--Fld_PurchaseOrderNo=@Fld_PurchaseOrderNo,                 
Fld_ShipTo=@Fld_ShipTo,                 
Fld_ShippingMethod =@Fld_ShippingMethod,                
Fld_OrderTerms=@Fld_OrderTerms,           
Fld_CompID=@Fld_CompID,    
POBranch=@POBranch,
PODeliveryTime=@PODeliveryTime                  
where Fld_PId = @Fld_Pid                                   
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITRecommandedPerson
-- --------------------------------------------------
CREATE proc Usp_ITRecommandedPerson      
(      
@access_code varchar(10)      
)      
as      
   
if @access_code='BOK'      
set @access_code='HO'      
if @access_code='CSO'      
set @access_code='HO'    

if  @access_code = 'DELHI'
begin 
select Emp_No,Emp_Name from intranet.risk.dbo.emp_info  where department='IT'--and designation='Desktop Engineer'       
and status='A' and (Branch_cd like @access_code or Branch_cd='DELRSO') order by  Emp_Name 
end
else 
begin 
select Emp_No,Emp_Name from intranet.risk.dbo.emp_info  where department='IT'--and designation='Desktop Engineer'       
and status='A' and Branch_cd like @access_code order by  Emp_Name 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITRecommandedPerson1
-- --------------------------------------------------

CREATE proc Usp_ITRecommandedPerson1      
(      
@access_code varchar(10)      
)      
as      
      
if @access_code='CSO'      
set @access_code='HO'  
declare  @Region as varchar(10)   
set @Region=(select Region from intranet.risk.dbo.region where code like @access_code)  
  
select Emp_No,Emp_Name from intranet.risk.dbo.emp_info where department='IT'--and designation='Desktop Engineer'       
and status='A' --and Region like @Region
 order by Emp_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITReports
-- --------------------------------------------------
CREATE Proc USP_ITReports    
as    
    
---------------Dacenters Report--------    
insert into Tbl_IT_Reports_details    
select x.Fld_SrNo,y.Br_tag,'P',getdate()+1,'','' from    
(select * from Tbl_IT_Reports_Master where Fld_Rpt_For = 'D')x    
cross join    
(select * from tbl_it_br_master where Br_type = 'Datacenter')y    
    
--------------Only CSO Reports---------    
insert into Tbl_IT_Reports_details    
select x.Fld_SrNo,y.Br_tag,'P',getdate()+1,'','' from    
(select * from Tbl_IT_Reports_Master where Fld_Rpt_For = 'CSO')x    
cross join    
(select * from tbl_it_br_master where Sr_No = 124)y    
    
--------------Branches---------    
insert into Tbl_IT_Reports_details    
select x.Fld_SrNo,y.Br_tag,'P',getdate()+1,'','' from    
(select * from Tbl_IT_Reports_Master where Fld_SrNo = 3)x    
cross join    
(select * from V_UPS_Report)y

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequest_Description
-- --------------------------------------------------
create proc usp_ITRequest_Description(@Fld_RequestId int,@Fld_RequestDesc varchar(5000))
as
if(select count(*) from tbl_ITRequest_Description(nolock) where Fld_RequestId=@Fld_RequestId )=0
--------------------insert----
Begin
insert into tbl_ITRequest_Description values( @Fld_RequestId,@Fld_RequestDesc) 
End
else               
---------------------Update-----              
Begin              
  update tbl_ITRequest_Description set Fld_RequestDesc = @Fld_RequestDesc where Fld_RequestId = @Fld_RequestId            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequest_Forwarded
-- --------------------------------------------------
CREATE proc usp_ITRequest_Forwarded(@status char(4))                                
as                    
/*               
---OLD QUERY      
select a.Name,b.* from                    
(select a.Name,b.emp_no from           
(select code,Name from intranet.risk.dbo.region union select 'CSO','HEAD OFFICE' union select 'BOK','BANK OF KARAD' )a          
inner join          
(select emp_no,Branch_cd from  intranet.risk.dbo.emp_info)b          
on a.code=b.Branch_cd)a                       
inner join                             
(select a.*,replace(str(a.fld_RequestId,6,0),' ','0') as fld_RequestId1,b.Fld_AssetName,                 
c.Emp_Name,[HOD Name],AttendanceLoc from                             
(select * from tbl_ITRequestMaster(nolock) where Fld_Status=@status)a                            
left outer join                             
(select * from tbl_it_assetmaster(nolock))b                            
on a.Fld_AssetType=b.Fld_AssetID                   
left outer join                  
(select [Emp No],Emp_Name,[HOD Name],AttendanceLoc from hrsoft.angelbroking.dbo.vlms)c                  
on a.Fld_RequestBy = c.[Emp No])b                
on a.emp_no=b.Fld_RequestBy         
order by Fld_RequestId      
*/      
   
select a.Name,b.* from                    
(select a.Name,b.emp_no from           
(select code,Name from intranet.risk.dbo.region union select 'CSO','HEAD OFFICE' union select 'BOK','BANK OF KARAD' )a          
inner join          
(select emp_no,Branch_cd from  intranet.risk.dbo.emp_info)b          
on a.code=b.Branch_cd)a                       
right outer join                             
(select a.*,replace(str(a.fld_RequestId,6,0),' ','0') as fld_RequestId1,b.Fld_AssetName,                 
c.Emp_Name,[HOD Name],AttendanceLoc from                             
(select * from tbl_ITRequestMaster(nolock) where Fld_Status=@status)a                            
left outer join                             
(select * from tbl_it_assetmaster(nolock))b                            
on a.Fld_AssetType=b.Fld_AssetID                   
left outer join                  
(select [Emp No],Emp_Name,[HOD Name],AttendanceLoc from [MIDDLEWARE].harmony.dbo.vlmsinhouse)c                  
on a.Fld_RequestBy = c.[Emp No])b                
on a.emp_no=b.Fld_RequestBy         
order by Fld_RequestId

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_itRequestAssetReport
-- --------------------------------------------------
CREATE proc Usp_itRequestAssetReport(@Branch as varchar(10))
as

if @Branch='CSO'
set @Branch ='HO'
select x.*,y.fld_branchcode as branch_code from 
(select * from Mis.Helpdesk.dbo.tbl_itAssetsdata with (nolock))x
inner join
(select b.Fld_SrNo,b.Fld_requestby,b.fld_branchcode from
(select emp_no from intranet.risk.dbo.emp_info with (nolock) where costCode=@Branch)a
inner join
(select Fld_SrNo,Fld_requestby,fld_branchcode from tbl_itRequestMaster(nolock))b
on a.emp_no=b.Fld_requestby)y
on x.Fld_RequestTableSrNo=y.Fld_SrNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_itRequestAssetReport_new
-- --------------------------------------------------
CREATE proc Usp_itRequestAssetReport_new(@Branch as varchar(10))            
as            
            
--if @Branch='CSO'        
--set @Branch ='HO'        
        
select a.*,b.emp_name from        
(select x.Fld_ProductType,x.Fld_ProductName,x.Fld_ProductModel,x.Fld_ProductDesc,        
x.Fld_AssetName,x.Fld_AssetTag,x.Fld_PartNo,x.Fld_VendorName,x.Fld_Rate,x.Fld_WarrantyFrom,x.Fld_WarrantyTo,        
x.Fld_AssignToDept,x.Fld_BillNo,x.Fld_ChallanNo,x.Fld_Purpose,x.Fld_SystemDate,        
x.Fld_CapexName,x.Fld_WarrantyType,x.Fld_Pid,x.Fld_RequestTableSrNo,y.* from        
(select * from tbl_itAssetsdata where fld_AssetTag like @Branch+'%' and (fld_status = 'U' or fld_status = ''))x         
left outer join         
(select * from tbl_itrequestmaster)y         
on x.fld_requestId=y.fld_requestId)a        
left outer join        
(select emp_name,emp_no from intranet.risk.dbo.emp_info)b        
on a.fld_requestby = b.emp_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITRequestCondition
-- --------------------------------------------------
CREATE proc Usp_ITRequestCondition    
(    
@TC1 as varchar(500),    
@TC2 as varchar(500),    
@TC3 as varchar(500),    
@TC4 as varchar(500),    
@TC5 as varchar(500)    
)    
as    
    
update tbl_ITRequestCondition set Fld_condition=@TC1 where Fld_srno='1'    
update tbl_ITRequestCondition set Fld_condition=@TC2 where Fld_srno='2'    
update tbl_ITRequestCondition set Fld_condition=@TC3 where Fld_srno='3'    
update tbl_ITRequestCondition set Fld_condition=@TC4 where Fld_srno='4'    
update tbl_ITRequestCondition set Fld_condition=@TC5 where Fld_srno='5'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestCondition_History
-- --------------------------------------------------
create Proc USP_ITRequestCondition_History
(
@POID as int,
@con1 as varchar(100),
@con2 as varchar(100),
@con3 as varchar(100),
@con4 as varchar(100),
@con5 as varchar(100)
)
as

IF(select count(*) from tbl_ITRequestCondition_History(nolock) where POID=@POID)=0
begin
insert into tbl_ITRequestCondition_History values
(@POID,@con1,@con2,@con3,@con4,@con5)
end
ELSE
begin
Update tbl_ITRequestCondition_History set 
con1=@con1,con2=@con2,con3=@con3,con4=@con4,con5=@con5
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequestEdit
-- --------------------------------------------------
create proc usp_ITRequestEdit(@Fld_RequestId as int,@Fld_Status as char(2))
as
select a.*,b.Fld_RequestDesc from 
(select * from tbl_ITRequestMaster(nolock) where Fld_RequestId=@Fld_RequestId and Fld_Status=@Fld_Status)a
left outer join
(select * from tbl_ITRequest_Description(nolock))b
on a.Fld_RequestId=b.Fld_RequestId

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMailToITHead
-- --------------------------------------------------
CREATE proc USP_ITRequestMailToITHead        
(            
 @Fld_RequestId int                                                         
)            
as         
------------------------Send Mails to Branch Head And CSO Head                                                                
             
declare @TotFld_QTY as int                                
declare @from as varchar(50)                                                   
declare @to as varchar(50)                                                     
declare @Recommended_By as varchar(100)                                                                    
declare @msg as varchar(5000)                                                                              
declare @Fld_RequestBy1 as varchar(50)          
declare @Fld_Recommended_By as varchar(50)                                                     
declare @Fld_Recommended_By1 as varchar(50)           
declare @AssetName as varchar(100)         
declare @Fld_AdminRemark as varchar(500)         
         
set @AssetName=(select Fld_AssetName from tbl_it_assetmaster(nolock) where Fld_AssetId in(select Fld_AssetType from tbl_ITRequestMaster(nolock) where Fld_RequestId =@Fld_RequestId ))                                                    
set @Fld_RequestBy1= (select person_name from intranet.risk.dbo.user_login where username in(select Fld_RequestBy from tbl_ITRequestMaster(nolock) where Fld_RequestId =@Fld_RequestId))                                                                       
  
    
      
set @TotFld_QTY=(select count(*)Qty from tbl_ITRequestMaster(nolock) where Fld_Status='PO' and Fld_requestId=@Fld_RequestId)      
set @Fld_AdminRemark=(select distinct Fld_AdminRemark from tbl_ITRequestMaster(nolock) where Fld_Status='PO' and Fld_requestId=@Fld_RequestId)      
set @Fld_Recommended_By1=(select person_name from intranet.risk.dbo.user_login where username=(select Distinct Fld_Recommended_By from tbl_ITRequestMaster(nolock) where Fld_RequestId =@Fld_RequestId))                                                     
                                                                                                               
set @msg = '<br><br>                                                                                                                                    
New IT Asset Request '+'<br><br>'+'Requester Name:'+''+@Fld_RequestBy1+''+'<br>'+'Asset Name: '+''+@AssetName+''+'<br>'+'Qantity: '+''+convert(varchar,@TotFld_QTY)+''+'<br>'+'Description: '+''+@Fld_AdminRemark+''+'<br>'+'Reccomended By: '+''+@Fld_Recommended_By1+''+'<br>                                            
'                                                                           
+'<br><br>Thank You<br> Angel Broking'        
      
print  @msg                                                                                            
                                
exec intranet.msdb.dbo.sp_send_dbmail                                                       
@profile_name = 'intranet',                                                                                                                                          
@recipients  =  'Atul.Sashittal@angeltrade.com',                                                                                 
--@copy_recipients =  @Recommended_By,                      
@blind_copy_recipients ='MaheshP.Chavan@angeltrade.com',                                                                                                                                             
--@from =@from,                                                                     
--@from = 'vinayk.pandey@angeltrade.com',                                                                                                         
@body_format ='html',                                                                                                                                                                    
@subject = 'IT Asset New Request',                         
--@server = 'angelmail.angelbroking.com',                                                                    
@body =@msg

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster
-- --------------------------------------------------
  
CREATE Proc USP_ITRequestMaster                                                                                            
(                                                                                                                      
 @Fld_AssetType int ,                                                                                       
 @Fld_Recommended_By varchar(200),                                                                               
 --@Fld_RequestDesc varchar(5000),                                                                                             
 @Fld_Status char(4),                                                                                                                        
 @Fld_BranchCode varchar(20),                                                                                            
 @Fld_RequestBy varchar(20),                                                                            
 @Fld_ForwardBy varchar(20),                                                                            
 @Fld_CompletedBy varchar(20),                                                                                                           
 @Fld_AdminRemark varchar(5000),                                                                        
 @Fld_CSOForwardBy varchar(20),                                                                        
 @Flag varchar(2),                                                                      
 @AssetName varchar(50),                                                              
 @Fld_QTY int,                                                           
 @TotFld_QTY varchar(20),                              
 @department varchar(50)                                                                                                        
)                                                                                            
as                                                        
set nocount on                                            
                                      
DECLARE @rc INT                                                         
IF NOT EXISTS (SELECT * FROM intranet.msdb.sys.service_queues                                                         
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                                                        
EXEC @rc = intranet.msdb.dbo.sysmail_start_sp                                       
                                          
                                          
declare @username as varchar(50)                                                        
set @username=(select [HOD NO] from V_IT_Staff_Rpt_New where Emp_No=@Fld_RequestBy)                                                        
if @username = 'P00226'                                                       
set  @Fld_Status='HODF'                                                       
else                                                         
set @Fld_Status='P'                                                                                
--set @Fld_ForwardTime = convert(datetime,@Fld_ForwardTime,103)                                                                                           
------------------------New Request-----------------                                                                                            
--if (select count(*) from tbl_ITRequestMaster (nolock) where Fld_RequestId = @Fld_RequestId and Fld_AssetType=@Fld_AssetType) = 0                                                                                            
Begin                                                         
declare @cnt as int                                                        
set  @cnt=1                         
declare @RequestId as int                    
select @RequestId=RequestId from V_ITRequestMaster                                                              
  while( @cnt<= convert(int,@TotFld_QTY))                                                  
Begin                         
                                                              
 insert into tbl_ITRequestMaster values                 
 (                  
  @RequestId,                     
  @Fld_AssetType,                                         
  getdate(),                                     
  getdate(),                             
  getdate(),                                                                                            
  @Fld_Status,                                                                                            
  @Fld_BranchCode,                                                                                            
  @Fld_BranchCode,                                                                                    
  @Fld_RequestBy,                                                                 
  '',                                
  '',                                                                            
  @Fld_AdminRemark,                                                              
  @Fld_Recommended_By,@Fld_CSOForwardBy,@Fld_QTY,@department,''                                 
 )                                                         
 set @cnt=@cnt+1                                                                                          
 End                                                                 
                                                                      
------------------------Send Mails to Branch Head And CSO Head                                                                      
                                                                   
declare @from as varchar(50)                                                         
declare @to as varchar(50)                                                           
declare @Recommended_By as varchar(100)                                                                          
declare @msg as varchar(5000)                                                           
                                                          
declare @Fld_RequestBy1 as varchar(50)                                                           
declare @Fld_Recommended_By1 as varchar(50)                                                           
set @AssetName=(select Fld_AssetName from tbl_it_assetmaster(nolock) where Fld_AssetId=@Fld_AssetType)          
--print  @AssetName                                                       
set @Fld_RequestBy1= (select person_name from intranet.risk.dbo.user_login where username = @Fld_RequestBy)             
--print @Fld_RequestBy1                                                                                  
set @Fld_Recommended_By1=(select person_name from intranet.risk.dbo.user_login where username = @Fld_Recommended_By)        
--print  @Fld_Recommended_By1                                                          
set @Recommended_By=(select Email from intranet.risk.dbo.user_login where username = @Fld_Recommended_By)        
--print  @Recommended_By                                                                
set @from = (select Email from intranet.risk.dbo.user_login where username = @Fld_RequestBy)         
--print @from                                                                    
set @to = (select email from intranet.risk.dbo.user_login where username =                                                                     
(select Senior from intranet.risk.dbo.emp_info where emp_no= @Fld_RequestBy) )         
--print @to                                                                  
set @msg = '<br>New IT Asset Request '+'<br><br>'+'Requester Name:'+''+@Fld_RequestBy1+''+'<br>'+'Asset Name: '+''+@AssetName+''+'<br>'+'Qantity: '+''+@TotFld_QTY+''+'<br>'+'Description: '+''+@Fld_AdminRemark+''+'<br>'+'Reccomended By: '+''+@Fld_Recommended_By1+''+'<br>     
     
                                                 
'              
                                                    
+'<br><br>Thank You<br> Angel Broking'                                                                       
--print @msg              
set @Recommended_By='Fatima.Kazi@angeltrade.com;'+@Recommended_By                              
exec intranet.msdb.dbo.sp_send_dbmail                                                             
@profile_name = 'intranet',      
--@profile_name = 'IThelpdeskAkruti',                                                                            
@recipients  =  @to,                                                                                          
@copy_recipients =  @Recommended_By,                            
@blind_copy_recipients ='Mahesh.Chavan@angeltrade.com',                                                                                                                                                                                                      
   
    
                                                 
@body_format ='html',                                                                                                                                                                          
@subject = 'IT Asset New Request',                                                                                                                                           
--@server = 'angelmail.angelbroking.com',                                                                          
@body =@msg                                                       
end                                                                       
                                                
set nocount on

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Report
-- --------------------------------------------------
CREATE Procedure USP_ITRequestMaster_Report(@Status varchar(5),@Hod varchar(15))                                        
as      
    
if (len(@Hod)>6)    
    
--declare @Hod varchar(15)                                 
--set @Hod='P00226'    
set @Hod =left(@Hod,charindex('_',@Hod)-1)            
    
    
----select * from tbl_ITRequestMaster (nolock)  where Fld_Status='P'                    
      
select case when a.Name is null or a.Name='NULL' then 'OTHER' else a.Name end as Name  ,b.* from                        
(select a.Name,b.emp_no from           
(select code,Name from intranet.risk.dbo.region union select 'CSO','HEAD OFFICE' union select 'BOK','BANK OF KARAD')a          
inner join          
(select emp_no,Branch_cd from intranet.risk.dbo.emp_info)b          
on a.code=b.Branch_cd)a                          
right outer join                        
(                    
select q.E_Name,p.* from                             
(select [Emp No],EMP_Name as E_Name from [MIDDLEWARE].harmony.dbo.vlmsinhouse)q                             
inner join                                  
(select x.EMP_Name,[HOD Name],Department,Attendanceloc,y.* from                                    
(                                    
select * from [MIDDLEWARE].harmony.dbo.vlmsinhouse where [HOD No] like @Hod                          
)x                                    
inner join                                    
(                                    
select a.*,b.Fld_RequestDesc1,c.Fld_AssetName from                                                          
(select Fld_RequestId,Fld_AssetType,Fld_BranchCode,Fld_RequestBy,Fld_AdminRemark,Fld_Recommended_By,convert(varchar(11),fld_requesttime,103) as RequestTime,replace(str(fld_RequestId,6,0),' ','0')                         
as fld_RequestId1,sum(Fld_QTY) as qty from tbl_ITRequestMaster (nolock)  where Fld_Status= @Status                      
group by Fld_RequestId,Fld_AssetType,Fld_BranchCode,Fld_RequestBy,Fld_AdminRemark,Fld_Recommended_By,convert(varchar(11),fld_requesttime,103))a                                                            
left outer join                                                    
(select Fld_RequestId,Fld_RequestDesc as Fld_RequestDesc1 from tbl_ITRequestMaster1(nolock))b                                                    
on a.Fld_RequestId=b.Fld_RequestId                                                    
left outer join                                                        
(select * from tbl_it_Assetmaster(nolock))c                                                          
on a.fld_AssetType=c.Fld_AssetID                                              
)y on x.[Emp No] = y.Fld_RequestBy)p                            
on q.[Emp No] = p.Fld_Recommended_By)b                        
on a.emp_no=b.Fld_RequestBy order by RequestTime Desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Report1
-- --------------------------------------------------

CREATE Procedure USP_ITRequestMaster_Report1(@fromdate varchar(11),@todate varchar(11),@status varchar(5),@username varchar(10))                                                
as                       
                    
--declare  @fromdate varchar(11),@todate varchar(11),@status varchar(5),@username varchar(10)                    
--set @fromdate='01/01/2010'                    
--set @todate='05/01/2010'                    
--set @status='%%'                    
--set @username='E07260'                     
if @status='R'                    
begin                     
set @status='%R'                    
end                    
if @username='E05626' or @username='E07260' or @username='E11920' or @username='E09202'                      
SET @username= '%%'                     
  
  
 select x.*,y.person_name as RecommendedBy from                 
(select a.*,b.Fld_RequestDesc1,c.Fld_AssetName,d.person_name,    
case when a.Fld_Status='P' then 'Pending'                     
when a.Fld_Status='P' then 'Pending'                    
when a.Fld_Status='HODF' then 'Approved by HOD'                    
when a.Fld_Status='CSOF' then 'Approved by CSO'                    
when a.Fld_Status='PO' then 'PO Generated'                    
when a.Fld_Status='HODR' then 'Rejected'     
when a.Fld_Status='CSOR' then 'Rejected'                 
when a.Fld_Status='C' then 'Completed'                     
end as [Status] from                                                
(select Fld_RequestId,Fld_AssetType,Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,Fld_ForwardBy,              
Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,sum(Fld_QTY)Fld_QTY,Department              
,replace(str(fld_RequestId,6,0),' ','0') as fld_RequestId1,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime                
from tbl_ITRequestMaster (nolock) where Fld_status<>'CA' and Fld_RequestBy like @username and Fld_Status like @status                       
and Fld_RequestTime>=Convert(datetime,@fromdate,103)                       
and  Fld_RequestTime<=Convert(datetime,@todate,103)+' 23:59:59'         
Group by Fld_RequestId,Fld_AssetType,convert(varchar(11),Fld_RequestTime,103),        
Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,              
Fld_ForwardBy,Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,Department)a                                             
left outer join                                        
(select Fld_RequestId,Fld_RequestDesc as Fld_RequestDesc1 from tbl_ITRequestMaster1(nolock))b                                        
on a.Fld_RequestId=b.Fld_RequestId                                        
left outer join                                            
(select * from tbl_it_Assetmaster(nolock))c                                              
on a.fld_AssetType=c.Fld_AssetID                                  
left outer join                                   
(select person_name,username from intranet.risk.dbo.user_login)d                                  
on a.Fld_RequestBy=d.username)x
left outer join                                   
(select person_name,username from intranet.risk.dbo.user_login)y                                 
on x.Fld_Recommended_By=y.username order by Fld_RequestTime desc  
                    
--select * from tbl_ITRequestMaster                      
--select * from tbl_ITRequestMaster1                    
--select * from tbl_it_Assetmaster                    
--select person_name,username from intranet.risk.dbo.user_login

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster_Report2
-- --------------------------------------------------
CREATE Procedure USP_ITRequestMaster_Report2(@fromdate varchar(11),@todate varchar(11),@BranchCode varchar(8))                                        
as    
--declare @fromdate varchar(11),@todate varchar(11),@BranchCode varchar(8)  
--set @fromdate='01/12/2009'                     
--set @todate='07/12/2009'  
--set @BranchCode='CSO'  
                               
select distinct a.Fld_RequestId,a.Fld_AssetType,--a.Fld_ForwardTime,a.Fld_CompletedTime,
a.Fld_Status,      
a.Fld_AccessCode,a.Fld_BranchCode,a.Fld_RequestBy,a.Fld_ForwardBy,a.Fld_CompletedBy,a.Fld_AdminRemark,      
a.Fld_Recommended_By,a.FLD_CSOForwardBY,a.Fld_QTY,a.Department,a.Fld_dummy5,a.fld_RequestId1,b.*,c.compName from                                      
(select *,replace(str(fld_RequestId,6,0),' ','0') as fld_RequestId1 from tbl_ITRequestMaster (nolock)        
where Fld_BranchCode like @BranchCode and (Fld_Status='PO' or Fld_Status='C') and Fld_CompletedTime>=Convert(datetime,@fromdate,103) and  Fld_CompletedTime<=Convert(datetime,@todate,103)+' 23:59:59' )a                                        
inner join                                
(select * from tbl_ItRequestPurchaseOrder(nolock))b  --where Fld_VendorName like @VendorCode)b                                
on a.Fld_RequestId=b.Fld_RequestId                    
inner join                   
(select CompId,compName from tbl_it_AngelGroupOfCompaniesMaster(nolock) where status='A')c                                      
on b.Fld_CompID=c.CompId order by Fld_PurchaseOrderNo Desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequestMaster1
-- --------------------------------------------------

CREATE proc usp_ITRequestMaster1(@Fld_AssetType varchar(50),@Fld_RequestDesc varchar(5000),@Fld_Status char(2))        
as   
declare @RequestId as int  
select @RequestId=RequestId-1 from V_ITRequestMaster       
if(select count(*) from tbl_ITRequestMaster1(nolock) where Fld_RequestId=@RequestId )=0        
Begin        
insert into tbl_ITRequestMaster1 values( @RequestId,@Fld_AssetType,@Fld_RequestDesc,@Fld_Status)         
End        
else                       
---------------------Update-----                      
Begin                      
  update tbl_ITRequestMaster1 set                      
   Fld_AssetType  = @Fld_AssetType,                      
   Fld_RequestDesc  = @Fld_RequestDesc,     
   Fld_Status = @Fld_Status                               
   where Fld_RequestId = @RequestId                    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestMaster2
-- --------------------------------------------------
CREATE proc USP_ITRequestMaster2  
(  
 @Fld_RequestId int ,                                  
 @Fld_AssetID int ,                                                             
 @Fld_Status char(4),                                                                                                             
 @Fld_ForwardBy varchar(20),                                                              
 @Fld_AdminRemark varchar(5000),                          
 @Flag varchar(2)            
)  
as  
if (@Flag='BR')               
Begin        
  update tbl_ITRequestMaster set                                    
 Fld_ForwardTime  = getdate(),                                  
 Fld_CompletedTime = getdate(),                               
 Fld_Status   = @Fld_Status,                                    
 Fld_ForwardBy  = @Fld_ForwardBy,                                                       
    Fld_AdminRemark  = @Fld_AdminRemark                            
    where Fld_RequestId = @Fld_RequestId                 
end              
 else               
Begin              
update tbl_ITRequestMaster set                                  
 Fld_ForwardTime  = getdate(),                                  
 Fld_CompletedTime = getdate(),                                  
 Fld_Status   = @Fld_Status,                                    
 FLD_CSOForwardBY =  @Fld_ForwardBy,                                                       
    Fld_AdminRemark  = @Fld_AdminRemark                            
    where Fld_RequestId = @Fld_RequestId                         
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestPOComplete
-- --------------------------------------------------
CREATE Procedure USP_ITRequestPOComplete(@access_to varchar(10),@access_code varchar(10),@status varchar(20),@username varchar(10))                                                    
as                             
DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200),@CONDITION1 AS VARCHAR(200)                          
/*,@access_to as varchar(50),@access_code as varchar(50),@status varchar(20),@username varchar(10)                                            
SET @access_to='BROKER'                                            
SET @access_code='CSO'                                            
SET @status='PO'       
SET @username='E22130' */    
      
if @access_to= 'BRANCH'                                                                                      
begin                                                                           
  SET @CONDITION='Fld_BranchCode ='''+@access_code+''''                                            
end                                                                           
if @access_to='BROKER'                                                            
begin                                                   
    SET  @CONDITION='Fld_BranchCode like ''%'''                                                                                        
end                                                                                                   
if @access_to='SB'                                                            
begin                                                      
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                                        
end                                                                            
if @access_to='BRMAST'                                                            
begin                                                      
  SET  @CONDITION='Fld_BranchCode in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                                                     
end                                                                            
if @access_to='SBMAST'                                                            
begin                                                                               
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                                            
end                                                                             
if @access_to='REGION'                                                            
begin                                                      
   SET  @CONDITION='Fld_BranchCode in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                                       
end                                                 
       
if @username='E05626' or @username='e07260' or @username='E11920' or @username='E09202'  
set @username='%%'             
if @status='All'                          
set @condition1=' Fld_Status like ''%'''                          
else                          
set @condition1=' Fld_Status = '''+@status+''''                          
--(select Distinct Fld_RequestId from tbl_ITRequestMaster(nolock) where '+@condition+' and '+@condition1+')a                                            
set @STR='select distinct a.Fld_RequestTime,b.*,c.*  from                              
(select distinct Fld_RequestId,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime from tbl_ITRequestMaster(nolock) where '+@condition+' and '+@condition1+' and Fld_RequestBy like '''+@username+''')a                              
inner join                                
(select Fld_RequestId as Fld_RequestIdPO,Fld_VendorId,Fld_purchaseOrderNo,convert(varchar(11),Fld_DeliveryDate,103)Fld_DeliveryDate from tbl_ItRequestPurchaseOrder(nolock))b                                    
on a.Fld_RequestId=b.Fld_RequestIdPO                             
inner join                            
(                        
select fld_requesttablesrno,Fld_Srno,Fld_RequestId,Fld_ProductModel,Fld_ProductDesc,Fld_AssetName,                        
Fld_PartNo,Fld_VendorName,Fld_Qty=sum(Fld_Qty),Fld_Rate,convert(varchar(11),Fld_WarrantyFrom,103) as Fdate,convert(varchar(11),Fld_WarrantyTo,103) as Tdate,                        
Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,Fld_Status,Fld_CapexName,Fld_WarrantyType                         
from tbl_ITAssetsData(nolock)                        
group by fld_requesttablesrno,Fld_Srno,Fld_AssetName,Fld_ProductModel,Fld_ProductDesc,Fld_PartNo,Fld_VendorName,Fld_Rate,fld_RequestId,Fld_WarrantyFrom,Fld_WarrantyTo,Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,Fld_Status,Fld_CapexName,Fld_WarrantyType)c                        
on b.Fld_RequestIdPO=c.Fld_RequestId'                        
                     
--print @STR                      
exec (@STR)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestPOComplete_CloseInGroup
-- --------------------------------------------------

CREATE Procedure USP_ITRequestPOComplete_CloseInGroup(@access_to varchar(10),@access_code varchar(10),@status varchar(20),@username varchar(10))                                                            
as                                     
DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200),@CONDITION1 AS VARCHAR(200)                                  
/*,@access_to as varchar(50),@access_code as varchar(50),@status varchar(20),@username varchar(10)                                                    
SET @access_to='BRoker'                                                    
SET @access_code='CSO'                                                    
SET @status='PO'               
SET @username='E08430' */              
              
if @access_to= 'BRANCH'                                                                                              
begin                                                                                   
  SET @CONDITION='Fld_BranchCode ='''+@access_code+''''                                                    
end                                                                                   
if @access_to='BROKER'                                                                    
begin                                                           
    SET  @CONDITION='Fld_BranchCode like ''%'''                                                                                                
end                                                                                                           
if @access_to='SB'                                                                    
begin                                                              
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                                                
end                                                                                    
if @access_to='BRMAST'                                                                    
begin                                                              
  SET  @CONDITION='Fld_BranchCode in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                                                             
end                                                                                    
if @access_to='SBMAST'                                                                    
begin                                                                                       
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                                                    
end                                                                                     
if @access_to='REGION'                                                                    
begin                                                              
   SET  @CONDITION='Fld_BranchCode in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                                               
end                                                         
                             
if @status='All'                                  
set @condition1=' Fld_Status like ''%'''                                  
else                                  
set @condition1=' Fld_Status = '''+@status+''''                                  
--(select Distinct Fld_RequestId from tbl_ITRequestMaster(nolock) where '+@condition+' and '+@condition1+')a                                                    
set @STR='select distinct a.Fld_RequestTime,c.Fld_RequestIdPO,c.Fld_VendorId,c.Fld_purchaseOrderNo,c.Fld_DeliveryDate,d.* into #tbl from                                       
(select distinct Fld_SrNo,Fld_RequestId,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime from tbl_ITRequestMaster(nolock) where '+@condition+' and '+@condition1+')a                                      
inner join  
(select distinct Fld_RequestId,Fld_Pid,Fld_RequestTableSrNo from tbl_ITAssetsData(nolock))b    
on b.Fld_RequestTableSrNo=a.Fld_SrNo  
inner join                                      
(select Fld_RequestId as Fld_RequestIdPO,Fld_VendorId,Fld_purchaseOrderNo,convert(varchar(11),Fld_DeliveryDate,103)Fld_DeliveryDate,fld_PId from tbl_ItRequestPurchaseOrder(nolock))c                                         
on b.Fld_Pid=c.fld_PId                                     
inner join                                      
(                                
select Fld_RequestId,Fld_ProductModel,Fld_ProductDesc,Fld_AssetName,                                
Fld_PartNo,Fld_VendorName,Fld_Qty=sum(Fld_Qty),Fld_Rate,convert(varchar(11),Fld_WarrantyFrom,103) as Fdate,  
convert(varchar(11),Fld_WarrantyTo,103) as Tdate,                                
Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,Fld_Status,Fld_CapexName,Fld_WarrantyType,fld_Pid                                 
from tbl_ITAssetsData(nolock)                                
group by Fld_AssetName,Fld_ProductModel,Fld_ProductDesc,Fld_PartNo,Fld_VendorName,  
Fld_Rate,fld_RequestId,Fld_WarrantyFrom,Fld_WarrantyTo,  
Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,Fld_Status,Fld_CapexName,Fld_WarrantyType,fld_Pid)d                                
on a.Fld_RequestId=d.Fld_RequestId        
        
select         
Fld_RequestTime,Fld_RequestIdPO,Fld_VendorId,Fld_purchaseOrderNo,Fld_DeliveryDate,        
Fld_RequestId,Fld_ProductModel,Fld_ProductDesc,Fld_AssetName,Fld_PartNo,Fld_VendorName,sum(Fld_Qty)Fld_Qty,Fld_Rate,        
Fdate,Tdate,Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,Fld_Status,Fld_CapexName,        
Fld_WarrantyType from #tbl         
group by Fld_RequestTime,Fld_RequestIdPO,Fld_VendorId,Fld_purchaseOrderNo,Fld_DeliveryDate,        
Fld_RequestId,Fld_ProductModel,Fld_ProductDesc,Fld_AssetName,Fld_PartNo,Fld_VendorName,Fld_Rate,        
Fdate,Tdate,Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,Fld_Status,Fld_CapexName,Fld_WarrantyType           
'                                
                             
--print @STR                              
exec (@STR)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestPOComplete1
-- --------------------------------------------------
CREATE Procedure USP_ITRequestPOComplete1(
@access_to varchar(10),@access_code varchar(10),@status varchar(20),@username varchar(10))                                         
as                                        
DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200),@CONDITION1 AS VARCHAR(200)                        
/*                                               
DECLARE @access_to as varchar(50),@access_code as varchar(50),@status varchar(20),@username varchar(10)                                                                    
SET @access_to='BROKER'                                                                    
SET @access_code='CSO'                         
SET @status='P'                                                                    
SET @username='E08430' */                      
                     
select emp_no,emp_name into #emp_info from intranet.risk.dbo.emp_info                                                          
if @access_to= 'BRANCH'                                                                                                              
begin                                                                                                   
  SET @CONDITION='Fld_BranchCode ='''+@access_code+''''                                                                    
end                                                                                                   
if @access_to='BROKER'                                                                                    
begin                                                                           
    SET  @CONDITION='Fld_BranchCode like ''%'''                                                                                                                
end                                                                                                                           
if @access_to='SB'                                                                                    
begin                                                                              
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                                                                
end                                                                                                    
if @access_to='BRMAST'                                                                                    
begin                                                                              
  SET  @CONDITION='Fld_BranchCode in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                                                                             
end                                                                                                    
if @access_to='SBMAST'                                                                                    
begin                                                                                                       
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                                                                    
end                                                                                                     
if @access_to='REGION'                                                                                    
begin                                                                              
   SET  @CONDITION='Fld_BranchCode in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                                                               
end                                                                         
                           
if @username='E05626' or @username='E07260' or @username='E11920' or @username='E09202'                      
SET @username= '%%'                        
                                
if @status='All'                   
set @condition1=' Fld_Status like ''%'''                         
else                                                  
set @condition1=' Fld_Status = '''+@status+''''                                                  
                             
                                          
if @status='P'                 
begin                                          
set @STR='select a.*,b.Fld_RequestDesc1,c.Fld_AssetName,d.emp_name,e.emp_name as RequestBy,''Pending'' as Flag from          
(select Fld_RequestId,Fld_AssetType,Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,Fld_ForwardBy,          
Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,sum(Fld_QTY)Fld_QTY,Department          
,replace(str(fld_RequestId,6,0),'' '',''0'') as fld_RequestId1,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime1            
from tbl_ITRequestMaster (nolock) where '+@condition+' and Fld_Status= ''P'' and Fld_RequestBy like '''+@username+'''          
Group by Fld_RequestId,Fld_AssetType,convert(varchar(11),Fld_RequestTime,103),Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,          
Fld_ForwardBy,Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,Department)a                          
left outer join                                                                  
(select Fld_RequestId,Fld_RequestDesc as Fld_RequestDesc1 from tbl_ITRequestMaster1(nolock))b                                                                  
on a.Fld_RequestId=b.Fld_RequestId                                                                  
left outer join                            
(select * from tbl_it_Assetmaster(nolock))c                             
on a.fld_AssetType=c.Fld_AssetID                                             
left outer join                                          
(select emp_no,emp_name from #emp_info)d                                          
on a.Fld_Recommended_By=d.emp_no               
left outer join                                          
(select emp_no,emp_name from #emp_info)e                                          
on a.Fld_RequestBy=e.emp_no'                                         
                                                                   
end                                          
else if @status='R'                                           
begin                                          
set @STR='select a.*,b.Fld_RequestDesc1,c.Fld_AssetName,d.emp_name,e.emp_name as RequestBy,''Rejected'' as Flag from        
(select Fld_RequestId,Fld_AssetType,Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,Fld_ForwardBy,          
Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,sum(Fld_QTY)Fld_QTY,Department          
,replace(str(fld_RequestId,6,0),'' '',''0'') as fld_RequestId1,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime1            
from tbl_ITRequestMaster (nolock) where '+@condition+' and (Fld_Status= ''HODR'' or Fld_Status= ''CSOR'') and Fld_RequestBy like '''+@username+'''        
Group by Fld_RequestId,Fld_AssetType,convert(varchar(11),Fld_RequestTime,103),Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,          
Fld_ForwardBy,Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,Department)a         
left outer join                                                                  
(select Fld_RequestId,Fld_RequestDesc as Fld_RequestDesc1 from tbl_ITRequestMaster1(nolock))b                                                 
on a.Fld_RequestId=b.Fld_RequestId                                                                  
left outer join                                                                      
(select * from tbl_it_Assetmaster(nolock))c                                                                        
on a.fld_AssetType=c.Fld_AssetID                                             
left outer join                                          
(select emp_no,emp_name  from #emp_info)d                                          
on a.Fld_Recommended_By=d.emp_no              
left outer join                                          
(select emp_no,emp_name from #emp_info)e                                         
on a.Fld_RequestBy=e.emp_no'                          
end                                          
else if @status='F'                                        
begin                                        
set @STR='select a.*,b.Fld_RequestDesc1,c.Fld_AssetName,d.emp_name,e.emp_name as RequestBy,''In Progress'' as Flag from         
(select Fld_RequestId,Fld_AssetType,Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,Fld_ForwardBy,          
Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,sum(Fld_QTY)Fld_QTY,Department          
,replace(str(fld_RequestId,6,0),'' '',''0'') as fld_RequestId1,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime1            
from tbl_ITRequestMaster (nolock) where '+@condition+' and (Fld_Status= ''CSOF'' or Fld_Status= ''HODF'') and Fld_RequestBy like '''+@username+'''        
Group by Fld_RequestId,Fld_AssetType,convert(varchar(11),Fld_RequestTime,103),Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,          
Fld_ForwardBy,Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,Department)a           
left outer join                                                                  
(select Fld_RequestId,Fld_RequestDesc as Fld_RequestDesc1 from tbl_ITRequestMaster1(nolock))b                                                 
on a.Fld_RequestId=b.Fld_RequestId                                                                  
left outer join                                                                      
(select * from tbl_it_Assetmaster(nolock))c                                                                        
on a.fld_AssetType=c.Fld_AssetID                                    
left outer join                                          
(select emp_no,emp_name  from #emp_info)d                                          
on a.Fld_Recommended_By=d.emp_no              
left outer join                                          
(select emp_no,emp_name from #emp_info)e                                          
on a.Fld_RequestBy=e.emp_no'                                              
 end                                      
else if @status='CA'                                        
begin                                          
set @STR='select a.*,b.Fld_RequestDesc1,c.Fld_AssetName,d.emp_name,e.emp_name as RequestBy,''Cancelled by user'' as Flag from                                                                        
(select Fld_RequestId,Fld_AssetType,Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,Fld_ForwardBy,          
Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,sum(Fld_QTY)Fld_QTY,Department          
,replace(str(fld_RequestId,6,0),'' '',''0'') as fld_RequestId1,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime1            
from tbl_ITRequestMaster (nolock) where '+@condition+' and  Fld_Status= ''CA'' and Fld_RequestBy like '''+@username+'''        
Group by Fld_RequestId,Fld_AssetType,convert(varchar(11),Fld_RequestTime,103),Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,          
Fld_ForwardBy,Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,Department)a           
                                                                
left outer join                                                                  
(select Fld_RequestId,Fld_RequestDesc as Fld_RequestDesc1 from tbl_ITRequestMaster1(nolock))b                                                 
on a.Fld_RequestId=b.Fld_RequestId                                                                  
left outer join                                                                      
(select * from tbl_it_Assetmaster(nolock))c                                                       
on a.fld_AssetType=c.Fld_AssetID                                             
left outer join                                          
(select emp_no,emp_name  from #emp_info)d                         
on a.Fld_Recommended_By=d.emp_no              
left outer join                                          
(select emp_no,emp_name from #emp_info)e                                          
on a.Fld_RequestBy=e.emp_no'                                              
 end                                      
else                                   
begin                                          
set @STR='select a.*,b.Fld_RequestDesc1,c.Fld_AssetName,d.emp_name,e.emp_name as RequestBy,                              
case when a.Fld_Status = ''P'' then ''Pending''                   
when a.Fld_Status = ''HODR''  then ''Rejected By HOD''                              
when a.Fld_Status = ''CSOR''  then ''Rejected By IT HEAD''                             
when a.Fld_Status = ''HODF'' or a.Fld_Status = ''CSOF'' then ''In Progress''                               
when a.Fld_Status = ''CA'' then ''Cancelled by user''                               
when a.Fld_Status = ''PO'' then ''Pending for Completion''                              
else ''Completed'' end as Flag                                               
from                              
(select Fld_RequestId,Fld_AssetType,Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,Fld_ForwardBy,          
Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,sum(Fld_QTY)Fld_QTY,Department          
,replace(str(fld_RequestId,6,0),'' '',''0'') as fld_RequestId1,convert(varchar(11),Fld_RequestTime,103)Fld_RequestTime1            
from tbl_ITRequestMaster (nolock) where '+@condition+' and  Fld_Status like ''%'' and Fld_RequestBy like '''+@username+'''      
Group by Fld_RequestId,Fld_AssetType,convert(varchar(11),Fld_RequestTime,103),Fld_Status,Fld_AccessCode,Fld_BranchCode,Fld_RequestBy,          
Fld_ForwardBy,Fld_CompletedBy,Fld_AdminRemark,Fld_Recommended_By,FLD_CSOForwardBY,Department)a        
 left outer join                                                                  
(select Fld_RequestId,Fld_RequestDesc as Fld_RequestDesc1 from tbl_ITRequestMaster1(nolock))b                                     
on a.Fld_RequestId=b.Fld_RequestId                                                                  
left outer join                                                                      
(select * from tbl_it_Assetmaster(nolock))c                                                                        
on a.fld_AssetType=c.Fld_AssetID                                 
left outer join                                          
(select emp_no,emp_name  from #emp_info)d                                          
on a.Fld_Recommended_By=d.emp_no              
left outer join                                          
(select emp_no,emp_name from #emp_info)e                                          
on a.Fld_RequestBy=e.emp_no'                                              
 end                                              
--print @STR                                              
exec (@STR)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ITRequestReport
-- --------------------------------------------------
  
CREATE proc Usp_ITRequestReport(@brcode varchar(10))  
as  
select a.*,b.Fld_AssetName from  
(select *,convert(varchar(11),Fld_WarrantyFrom,103) as Fdate,convert(varchar(11),Fld_WarrantyTo,103) as Tdate from tbl_ITAssetsData(nolock)where fld_branchcode=@brcode )a  
left outer join  
(select * from tbl_ITAssetType(nolock))b  
on a.Fld_ProductType=b.Fld_SrNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestStatus
-- --------------------------------------------------
CREATE  Procedure USP_ITRequestStatus(@access_to varchar(50),@access_code varchar(50),@username varchar(10))                    
as                    
/*========================================*/                    
                
drop table ITrequesttemp                
DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200)                
--SET @access_to='BROKER'                                      
--SET @access_code='CSO'                                      
if @access_to= 'BRANCH'                                                                                
begin                                                                     
  SET @CONDITION='Fld_BranchCode ='''+@access_code+''' and Fld_RequestBy = '''+@username+''''                                      
end                                                                     
if @access_to='Broker'                                                      
begin                                             
   SET @CONDITION='Fld_BranchCode ='''+@access_code+''' and Fld_RequestBy = '''+@username+''''                                                                                    
end                                                                                             
if @access_to='SB'                                                      
begin                                                
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                                  
end                                                                      
if @access_to='BRMAST'                                                      
begin                                                
  SET  @CONDITION='Fld_BranchCode in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                                               
end                                                                      
if @access_to='SBMAST'                                                      
begin                                                                         
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                                      
end                                                                       
if @access_to='REGION'                                                      
begin                                                
   SET  @CONDITION='Fld_BranchCode in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                                 
end                                           
                                       
/*==============================*/                                        
                    
--set @STR='select [Request Type]=case when Fld_status=''PO'' then ''Pending Request''                    
--when Fld_Status=''C'' then ''Completed Request'' end                     
-- ,[Total]=count(Fld_status) into #file1 from tbl_ITRequestMaster(nolock) where '+@CONDITION+'                    
--group by Fld_status                         
--select [Request Type],Total from #file1                    
--union                    
--select [Request Type]=''ALL Request'',Total=sum(Total) from #file1'                    
--                    
--                    
--exec (@STR)                    
                  
set @str='select RequestType=case when  Fld_status=''P'' then ''Pending Request''                  
when Fld_Status=''C'' then ''Completed Request''               
when Fld_status=''CSOR'' or Fld_status=''HODR'' then ''Rejected Request''             
when Fld_status=''CSOF'' or Fld_status=''HODF'' then ''In Progress''             
when Fld_status=''CA'' then ''Request Cancelled by user''                
when Fld_status=''PO'' then ''Pending for Completion''end                   
 ,Total=count(Fld_status) into ITrequesttemp from tbl_ITRequestMaster(nolock) where '+@CONDITION+'                
group by Fld_status '                
                
exec (@STR)                    
                
select RequestType,Total='<a href=/AngelInhouse/IT/frm_POcompletion.aspx?access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) +'&status='+                   
case when ltrim(rtrim(RequestType))='Pending Request' then 'P'              
when ltrim(rtrim(RequestType))='In Progress' then 'F'               
when ltrim(rtrim(RequestType))='Rejected Request' then 'R'             
when ltrim(rtrim(RequestType))='Pending for Completion' then 'PO'      
when ltrim(rtrim(RequestType))='Request Cancelled by user' then 'CA' else 'C' end+                                   
'>'+ ltrim(rtrim(sum(Total))) +'</a>'                  
from ITrequesttemp  group by RequestType             
union                  
select RequestType='ALL Request',Total=                  
'<a href=/AngelInhouse/IT/frm_POcompletion.aspx?access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) + '&status=ALL'+                    
'>'+ ltrim(rtrim(sum(Total))) +'</a>'                  
 from ITrequesttemp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestStatus_CloseInGroup
-- --------------------------------------------------
CREATE  Procedure USP_ITRequestStatus_CloseInGroup(@username varchar(10),@access_to varchar(50),@access_code varchar(50))                                  
as                                  
/*========================================*/                                  
                              
drop table ITrequesttemp                              
DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200)   
/*declare @username varchar(10),@access_to varchar(50),@access_code varchar(50)     
set @username='E08430'                           
SET @access_to='BROKER'                                                    
SET @access_code='CSO'*/                                                    
if @access_to= 'BRANCH'                                                                                              
begin                                                                                   
  SET @CONDITION='Fld_BranchCode ='''+@access_code+''' and Fld_RequestBy = '''+@username+''''                                                    
end                                                                                   
if @access_to='BROKER'                                                                    
begin                                                           
   SET @CONDITION='Fld_BranchCode ='''+@access_code+''' and Fld_RequestBy = '''+@username+''''                                                                                                  
end                                                                                                           
if @access_to='SB'                                                                    
begin                                                              
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                                                
end                                                                                    
if @access_to='BRMAST'                                                                    
begin                                                              
  SET  @CONDITION='Fld_BranchCode in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                                                             
end                                                                                    
if @access_to='SBMAST'                                                                    
begin                                                                                       
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                                                    
end                                                                                     
if @access_to='REGION'                                                                    
begin                                                              
   SET  @CONDITION='Fld_BranchCode in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                                               
end                 
if @username='E05626' or @username='E07260' or @username='E11920' or @username='E09202'            
SET @CONDITION='Fld_BranchCode like ''%%'' and Fld_RequestBy like ''%%'''                                                      
                                                     
/*==============================*/                                                      
                                  
--set @STR='select [Request Type]=case when Fld_status=''PO'' then ''Pending Request''                                  
--when Fld_Status=''C'' then ''Completed Request'' end                                   
-- ,[Total]=count(Fld_status) into #file1 from tbl_ITRequestMaster(nolock) where '+@CONDITION+'                                
--group by Fld_status                                       
--select [Request Type],Total from #file1                                  
--union            
--select [Request Type]=''ALL Request'',Total=sum(Total) from #file1'                           
--                                  
--                                  
--exec (@STR)                                  
                                
set @str='select RequestType=case when Fld_status=''PO'' then ''Pending for Completion''end                                 
 ,Total=count(Fld_status) into ITrequesttemp from tbl_ITRequestMaster(nolock) where Fld_status =''PO'' and '+@CONDITION+'                              
group by Fld_status '                              
             
               
exec (@STR)                                  
set nocount on                  
select RequestType,Total='<a href=/AngelInhouse/IT/frm_POcompletionclose_Ingroup.aspx?access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) +'&status='+                                 
case                            
when ltrim(rtrim(RequestType))='Pending for Completion' then 'PO' end+                                                 
'>'+ ltrim(rtrim(sum(Total))) +'</a>'                                
from ITrequesttemp  group by RequestType                           
union                                
select RequestType='ALL Request',Total=                                
'<a href=/AngelInhouse/IT/frm_POcompletionclose_Ingroup.aspx?access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) + '&status=ALL'+                                  
'>'+ ltrim(rtrim(sum(Total))) +'</a>'                                
 from ITrequesttemp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ITRequestStatus_temp
-- --------------------------------------------------
CREATE  Procedure USP_ITRequestStatus_temp(@username varchar(10),@access_to varchar(50),@access_code varchar(50))                        
as                        
/*========================================*/                        
                    
drop table ITrequesttemp                    
DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200)                    
--SET @access_to='BROKER'                                          
--SET @access_code='CSO'                                          
if @access_to= 'BRANCH'                                                                                    
begin                                                                         
  SET @CONDITION='Fld_BranchCode ='''+@access_code+''' and Fld_RequestBy = '''+@username+''''                                          
end                                                                         
if @access_to='BROKER'                                                          
begin                                                 
   SET @CONDITION='Fld_BranchCode ='''+@access_code+''' and Fld_RequestBy = '''+@username+''''                                                                                        
end                                                                                                 
if @access_to='SB'                                                          
begin                                                    
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                                      
end                                                                          
if @access_to='BRMAST'                                                          
begin                                                    
  SET  @CONDITION='Fld_BranchCode in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                                                   
end                                                                          
if @access_to='SBMAST'                                                          
begin                                                                             
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                                          
end                                                                           
if @access_to='REGION'                                                          
begin                                                    
   SET  @CONDITION='Fld_BranchCode in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                                     
end       
if @username='E05626' or @username='E07260' or @username='E11920' or @username='E09202'  
SET @CONDITION='Fld_BranchCode like ''%%'' and Fld_RequestBy like ''%%'''                                            
                                           
/*==============================*/                                            
                        
--set @STR='select [Request Type]=case when Fld_status=''PO'' then ''Pending Request''                        
--when Fld_Status=''C'' then ''Completed Request'' end                         
-- ,[Total]=count(Fld_status) into #file1 from tbl_ITRequestMaster(nolock) where '+@CONDITION+'                        
--group by Fld_status                             
--select [Request Type],Total from #file1                        
--union                        
--select [Request Type]=''ALL Request'',Total=sum(Total) from #file1'                        
--                        
--                        
--exec (@STR)                        
                      
set @str='select RequestType=case when  Fld_status=''P'' then ''Pending Request''                      
when Fld_Status=''C'' then ''Completed Request''                   
when Fld_status=''CSOR'' or Fld_status=''HODR'' then ''Rejected Request''                 
when Fld_status=''CSOF'' or Fld_status=''HODF'' then ''In Progress''                 
when Fld_status=''CA'' then ''Request Cancelled by user''             
when Fld_status=''PO'' then ''Pending for Completion''end                       
 ,Total=count(Fld_status) into ITrequesttemp from tbl_ITRequestMaster(nolock) where '+@CONDITION+'                    
group by Fld_status '                    
                    
exec (@STR)                        
                    
select RequestType,Total='<a href=/AngelInhouse/IT/frm_POcompletion.aspx?access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) +'&status='+                       
case when ltrim(rtrim(RequestType))='Pending Request' then 'P'                  
when ltrim(rtrim(RequestType))='In Progress' then 'F'                   
when ltrim(rtrim(RequestType))='Rejected Request' then 'R'                 
when ltrim(rtrim(RequestType))='Pending for Completion' then 'PO'          
when ltrim(rtrim(RequestType))='Request Cancelled by user' then 'CA' else 'C' end+                                       
'>'+ ltrim(rtrim(sum(Total))) +'</a>'                      
from ITrequesttemp  group by RequestType                 
union                      
select RequestType='ALL Request',Total=                      
'<a href=/AngelInhouse/IT/frm_POcompletion.aspx?access_to='+ ltrim(rtrim(@access_to)) +'&access_code='+ ltrim(rtrim(@access_code)) + '&status=ALL'+                        
'>'+ ltrim(rtrim(sum(Total))) +'</a>'                      
 from ITrequesttemp

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequestView
-- --------------------------------------------------
CREATE proc usp_ITRequestView(@Fld_RequestBy varchar(7))        
as        
select a.*,b.fld_assetname from         
(select convert(varchar(11),fld_requesttime,103) as reqdate,sum(fld_QTY) as fld_QTY,Fld_AssetType,fld_status,replace(str(Fld_RequestId,6,0),' ','0')Fld_RequestId,department from tbl_ITRequestMaster(nolock) where fld_status = 'P' and Fld_RequestBy=@Fld_RequestBy        
group by Fld_QTY,Fld_RequestId,Fld_AssetType, convert(varchar(11),fld_requesttime,103),fld_status,department        
)a        
left outer join        
(select Fld_AssetID,fld_assetname from tbl_it_assetmaster(nolock))b        
on a.Fld_AssetType=b.Fld_AssetID order by Fld_requestId

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITRequestView_admin
-- --------------------------------------------------
CREATE proc usp_ITRequestView_admin          
as          

select a.*,b.fld_assetname from           
(select convert(varchar(11),fld_requesttime,103) as reqdate,sum(fld_QTY) as fld_QTY,Fld_AssetType,fld_status,replace(str(Fld_RequestId,6,0),' ','0')Fld_RequestId,department from tbl_ITRequestMaster(nolock) where fld_status = 'HODF' and Fld_RequestBy in ('E05626','E07260','E11920','E09202','P00226')         
group by Fld_QTY,Fld_RequestId,Fld_AssetType, convert(varchar(11),fld_requesttime,103),fld_status,department          
)a          
left outer join          
(select Fld_AssetID,fld_assetname from tbl_it_assetmaster(nolock))b          
on a.Fld_AssetType=b.Fld_AssetID order by Fld_requestId

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITStockReassign_New
-- --------------------------------------------------
CREATE proc usp_ITStockReassign_New              
(              
@Fld_SrNo varchar(50),              
@Fld_AssetID varchar(100)              
)                      
as               
                  
select x.Fld_RequestId,x.Fld_Branchcode,y.Fld_AssetName into #temp1               
from                      
(              
select Fld_RequestId,Fld_AssetType,Fld_Branchcode from tbl_itrequestmaster(nolock) where               
Fld_SrNo in (select * from [dbo].[function_string_to_table](@Fld_SrNo,','))              
)x                    
left outer join                       
(select Fld_AssetId,Fld_AssetName from tbl_IT_Assetmaster(nolock))y                     
 on x.Fld_AssetType=y.Fld_AssetId              
              
              
select x.*,y.Fld_SrNo into #temp2 from              
(select * from #temp1) x              
left outer join              
(              
select * from tbl_itassetsdata where Fld_SrNo in (select * from [dbo].[function_string_to_table](@Fld_AssetID,','))              
)y on x.Fld_AssetName = y.Fld_Assetname              
                  
DECLARE @Fld_BranchCode varchar(25)                  
DECLARE @Fld_AssetName varchar(25)       
DECLARE @Fld_RequestId varchar(25)                 
                
DECLARE fatchRecords CURSOR READ_ONLY FORWARD_ONLY LOCAL FOR                   
select Fld_RequestId,Fld_BranchCode,Fld_AssetName,Fld_SrNo from #temp2                     
                  
OPEN fatchRecords                   
FETCH NEXT FROM fatchRecords INTO @Fld_RequestId,@Fld_BranchCode,@Fld_AssetName,@Fld_AssetID                   
                  
WHILE @@FETCH_STATUS <> -1                   
BEGIN                   
-----------------Generate Asset Tag--------------------                       
                      
declare @assetTag as  varchar(100)                            
declare @Tag as varchar(50)                        
                      
select @Tag=Fld_BranchCode+'/'+Fld_AssetName+'/' from                       
(select distinct Fld_AssetType,Fld_BranchCode from tbl_itrequestmaster(nolock) where Fld_RequestId=@Fld_RequestId)a                      
left outer join                       
(select Fld_AssetId,Fld_AssetName from tbl_IT_Assetmaster(nolock))b                      
on a.Fld_AssetType=b.Fld_AssetId                     
          
if (select count(Fld_AssetTag) from tbl_ITAssetsData(nolock) where Fld_AssetTag like''+@Tag+'%') = 0                                    
 begin                                      
  set @assetTag = @Tag+'0001'                                    
 end                                    
else                                    
 begin                           
  declare @assetCount as varchar(4)                                    
  set @assetCount =(select right(Max(Fld_AssetTag),4) from tbl_ITAssetsData(nolock) where Fld_AssetTag like ''+@Tag+'%')                                    
  set @assetCount=replace(str(isnull(@assetCount+1,0),4),' ',0)                                                
  set @assetTag = @Tag+@assetCount                        
 end                       
--print @assetTag        
               
update tbl_itassetsdata set Fld_RequestID=@Fld_RequestId,Fld_AssetTag=@assetTag,Fld_Status='U' where Fld_SrNo = @Fld_AssetID              
update tbl_itrequestmaster set Fld_Status='PO' where Fld_SrNo=@Fld_SrNo and Fld_Status='CSOF'                
                   
FETCH NEXT FROM fatchRecords INTO @Fld_RequestId,@Fld_BranchCode,@Fld_AssetName,@Fld_AssetID                   
END                   
CLOSE fatchRecords                   
DEALLOCATE fatchRecords

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ITStockReassign_New1
-- --------------------------------------------------
CREATE proc [usp_ITStockReassign_New1]
(
@Fld_RequestId varchar(50),
@Fld_AssetID varchar(100)
)        
as 
    
select x.Fld_RequestId,x.Fld_Branchcode,y.Fld_AssetName into #temp1 
from        
(
select Fld_RequestId,Fld_AssetType,Fld_Branchcode from tbl_itrequestmaster(nolock) where 
Fld_RequestId in (select * from [dbo].[function_string_to_table](@Fld_RequestId,','))
)x      
left outer join         
(select Fld_AssetId,Fld_AssetName from tbl_IT_Assetmaster(nolock))y       
 on x.Fld_AssetType=y.Fld_AssetId


select x.*,y.Fld_SrNo into #temp2 from
(select * from #temp1) x
left outer join
(
select * from tbl_itassetsdata where Fld_SrNo in (select * from [dbo].[function_string_to_table](@Fld_AssetID,','))
)y on x.Fld_AssetName = y.Fld_Assetname
    
DECLARE @Fld_BranchCode varchar(25)    
DECLARE @Fld_AssetName varchar(25)    
  
DECLARE fatchRecords CURSOR READ_ONLY FORWARD_ONLY LOCAL FOR     
select Fld_RequestId,Fld_BranchCode,Fld_AssetName,Fld_SrNo from #temp2       
    
OPEN fatchRecords     
FETCH NEXT FROM fatchRecords INTO @Fld_RequestId,@Fld_BranchCode,@Fld_AssetName,@Fld_AssetID     
    
WHILE @@FETCH_STATUS <> -1     
BEGIN     
-----------------Generate Asset Tag--------------------         
        
declare @assetTag as  varchar(100)              
declare @Tag as varchar(50)          
        
select @Tag=Fld_BranchCode+'/'+Fld_AssetName+'/' from         
(select Fld_AssetType,Fld_BranchCode from tbl_itrequestmaster(nolock) where Fld_RequestId=@Fld_RequestId)a        
left outer join         
(select Fld_AssetId,Fld_AssetName from tbl_IT_Assetmaster(nolock))b        
on a.Fld_AssetType=b.Fld_AssetId        
           
--print  @Tag          
        
--set @Tag =Fld_BranchCode+'/'+Fld_AssetName+'/'            
if (select count(Fld_AssetTag) from tbl_ITAssetsData(nolock) where Fld_AssetTag like''+@Tag+'%') = 0                      
begin                        
set @assetTag = @Tag+'0001'                      
end                      
else                      
begin             
declare @assetCount as varchar(4)                      
set @assetCount =(select right(Max(Fld_AssetTag),4) from tbl_ITAssetsData(nolock) where Fld_AssetTag like ''+@Tag+'%')                      
set @assetCount=replace(str(isnull(@assetCount+1,0),4),' ',0)                                  
set @assetTag = @Tag+@assetCount          
end         
--print @assetTag      
    
update tbl_itassetsdata set Fld_RequestID=@Fld_RequestId,Fld_AssetTag=@assetTag,Fld_Status='U' where Fld_SrNo = @Fld_AssetID
update tbl_itrequestmaster set Fld_Status='PO' where Fld_RequestId=@Fld_RequestId    
     
FETCH NEXT FROM fatchRecords INTO @Fld_RequestId,@Fld_BranchCode,@Fld_AssetName,@Fld_AssetID     
END     
CLOSE fatchRecords     
DEALLOCATE fatchRecords    
    
--select * from tbl_itassetsdata(nolock) where Fld_AssetName in(select * from [dbo].[function_string_to_table](@Fld_AssetName2,',')) and Fld_AssetTag in(select * from [dbo].[function_string_to_table](@Fld_AssetTag,','))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_KYCCheckDay
-- --------------------------------------------------
CREATE proc usp_KYCCheckDay --'01/08/2009','12/08/2009','%'     
(        
@Fd as varchar(25),        
@Td as varchar(25),        
@status as varchar(5)        
)        
as        
create table #t        
(        
Fld_srno int,        
Fld_Complaint_date varchar(25),        
Fld_mark_time varchar(25),        
Fld_Count int,  
RowId int primary key identity(1,1)         
)        
select fld_srno,Fld_Emp_Code,emp_name,Region,branch_cd,Fldsubcatname,fld_query,fld_solution,      
Fld_Complaint_Date,Fld_Mark_Time,Solved_by into #temp from V_Mis_Rpt_New(nolock) where Fld_Complaint_date >=  convert(varchar(11), convert(datetime, @Fd, 103))       
and Fld_Complaint_date <= convert(varchar(11), convert(datetime, @Td, 103)) +' 23:59:59'        
and Fld_Status like @status order by Fld_Complaint_date  
  
insert into #t        
select fld_srno,Fld_Complaint_date,Fld_mark_time,'0' from #temp(nolock)       
           
DECLARE @fld_srno int,@Fld_Complaint_date varchar(25),@Fld_mark_time varchar(25)        
      
Declare @MinRowId int,@MaxRowId int,@CurrRowId int  
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #t  
set @CurrRowId=@MinRowId  
while(@CurrRowId <=@MaxRowId)  
Begin  
select @fld_srno=Fld_srno,@Fld_Complaint_date=Fld_Complaint_date,@Fld_mark_time=Fld_mark_time from #t(nolock)  
where RowId=@CurrRowId  
  
declare @day int,@HH int,@Flag int,@Fdate datetime,@Tdate datetime           
set @Flag=0        
set @Fdate=@Fld_Complaint_date        
set @Tdate=@Fld_mark_time        
        
while(convert(datetime,convert(varchar(11),@Fdate),102) <> convert(datetime,convert(varchar(11),@Tdate),102))      
begin       
 if(select datename(dw,@Fdate)) = 'Sunday'      
 begin     
  set @Flag = (select datediff(hh,@Fdate,convert(varchar(11),@Fdate)+' 23:59:59.999'))    
  set @Flag=@Flag+@Flag      
 end      
 set @Fdate=  convert(datetime,dateadd(dd,1,@Fdate),102)      
end        
set @day = (select datediff(hh,@Fld_Complaint_date,@Fld_mark_time))        
set @HH = (@day-@Flag)      
--print @HH      
       
update #T set Fld_Count=@HH where Fld_srno= @fld_srno    
  
set @CurrRowId=@CurrRowId+1   
end  
       
select a.fld_srno,a.Fld_Emp_Code,a.emp_name,a.Region,branch_cd,a.Fldsubcatname,a.fld_query,a.fld_solution,        
a.Fld_Complaint_Date,a.Fld_Mark_Time,a.Solved_by,b.Fld_Count as compltedtime from        
(select * from #temp(nolock))a        
left outer join        
(select Fld_srno,Fld_Count from #t(nolock))b          
on a.fld_srno=b.Fld_srno        
order by Fld_Complaint_date

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Mail_Mapping
-- --------------------------------------------------
CREATE  Proc USP_Mail_Mapping(@Fld_Gc_Guid varchar(100),@Fld_Req_Id int)  
as

if (select count(*) from tbl_Mail_Mapping where Fld_Gc_Guid = @Fld_Gc_Guid ) >= 1  
	update tbl_Mail_Mapping set Fld_Req_id = @Fld_Req_Id where Fld_Gc_Guid = @Fld_Gc_Guid 
else 
	insert into tbl_Mail_Mapping values (@Fld_Gc_Guid,@Fld_Req_Id,getdate())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MAILS_MIS
-- --------------------------------------------------
CREATE proc USP_MAILS_MIS(@fdate as varchar(11),@tdate as varchar(11))  
AS    
  
set @fdate = convert(varchar(11),@fdate,103)  
set @tdate = convert(varchar(11),@tdate,103)  
  
select a.Inbox_Mails,b.Forward_Mails,c.Replied_Mail,Not_Replied=(a.Inbox_Mails-(b.Forward_Mails + c.Replied_Mail)) from    
(select Inbox_Mails=count(*) from mailreader where status = 'inbox' and dateHeader >= @fdate and dateHeader <= @tdate+ ' 23:59:59' ) a      
left outer join (select Forward_Mails=count(*) from mailreader  where status = 'sentmail' and left(ltrim(subjectHeader),3) like '%FW:%' and     
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59' ) b on a.Inbox_Mails = a.Inbox_Mails    
left outer join (select Replied_Mail=count(*) from mailreader where status = 'sentmail' and left(ltrim(subjectHeader),3) not like '%FW:%' and     
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59') c on a.Inbox_Mails = a.Inbox_Mails

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MAILS_MIS_HARMONY
-- --------------------------------------------------
CREATE proc USP_MAILS_MIS_HARMONY(@fdate as varchar(11),@tdate as varchar(11))    
AS      
    
set @fdate = convert(varchar(11),@fdate,103)    
set @tdate = convert(varchar(11),@tdate,103)    
    
select a.Inbox_Mails,b.Forward_Mails,c.Replied_Mail,Not_Replied=(a.Inbox_Mails-(b.Forward_Mails + c.Replied_Mail)) from      
(select Inbox_Mails=count(*) from mail_reader where status = 'inbox' and dateHeader >= @fdate and dateHeader <= @tdate+ ' 23:59:59' ) a        
left outer join (select Forward_Mails=count(*) from mail_reader  where status = 'sentmail' and left(ltrim(subjectHeader),3) like '%FW:%' and       
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59' ) b on a.Inbox_Mails = a.Inbox_Mails      
left outer join (select Replied_Mail=count(*) from mail_reader where status = 'sentmail' and left(ltrim(subjectHeader),3) not like '%FW:%' and       
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59') c on a.Inbox_Mails = a.Inbox_Mails

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MAILS_MIS_HARMONY1
-- --------------------------------------------------
CREATE proc USP_MAILS_MIS_HARMONY1(@fdate as varchar(11),@tdate as varchar(11))    
AS      
    
set @fdate = convert(varchar(11),@fdate,103)    
set @tdate = convert(varchar(11),@tdate,103)    
    
select a.Inbox_Mails,b.Forward_Mails,c.Replied_Mail,Not_Replied=(a.Inbox_Mails-(b.Forward_Mails + c.Replied_Mail)) from      
(select Inbox_Mails=count(*) from mailreader where status = 'inbox' and dateHeader >= @fdate and dateHeader <= @tdate+ ' 23:59:59' ) a        
left outer join (select Forward_Mails=count(*) from mailreader  where status = 'sentmail' and left(ltrim(subjectHeader),3) like '%FW:%' and       
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59' ) b on a.Inbox_Mails = a.Inbox_Mails      
left outer join (select Replied_Mail=count(*) from mailreader where status = 'inbox' and left(ltrim(subjectHeader),3) like '%RE:%' and       
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59') c on a.Inbox_Mails = a.Inbox_Mails

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MAILS_MIS_HELPDESK
-- --------------------------------------------------
CREATE proc USP_MAILS_MIS_HELPDESK(@fdate as varchar(11),@tdate as varchar(11))    
AS      
    
set @fdate = convert(varchar(11),@fdate,103)    
set @tdate = convert(varchar(11),@tdate,103)    
    
select a.Inbox_Mails,b.Forward_Mails,c.Replied_Mail,Not_Replied=(a.Inbox_Mails-(b.Forward_Mails + c.Replied_Mail)) from      
(select Inbox_Mails=count(*) from mailreader where status = 'inbox' and dateHeader >= @fdate and dateHeader <= @tdate+ ' 23:59:59' ) a        
left outer join (select Forward_Mails=count(*) from mailreader  where status = 'sentmail' and left(ltrim(subjectHeader),3) like '%FW:%' and       
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59' ) b on a.Inbox_Mails = a.Inbox_Mails      
left outer join (select Replied_Mail=count(*) from mailreader where status = 'sentmail' and left(ltrim(subjectHeader),3) like '%RE:%' and       
dateHeader >= @fdate and dateHeader <= @tdate +' 23:59:59') c on a.Inbox_Mails = a.Inbox_Mails

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Manager_Id
-- --------------------------------------------------
CREATE Proc USP_Manager_Id(@server as varchar(50),@segment as varchar(50),@ManagerID as varchar(50))  
as  

declare @str as varchar(1000)   
/*
declare @server as varchar(50)  
declare @segment as varchar(50)  
declare @ManagerID as varchar(50)  

set @server = 'ALL'  
set @segment = 'ACDLCM'  
set @ManagerID = ''
*/  
  
set @server = case when @server = 'ALL' then 'Like ''%%''' else '='''+@server+'''' end  
set @segment = case when @segment = 'ALL' then 'Like ''%%''' else '='''+@segment+'''' end  
set @ManagerID = case when @ManagerID = '' then 'Like ''%%'''  else '='''+@ManagerID+'''' end  
  
set @str = 'select Server,Odin_Id,Segment,convert(varchar(11),sdate) as sdate,
case when convert(varchar(11),edate) = ''Dec 31 2070'' then '''' else convert(varchar(11),edate) end as edate
from terminals (nolock) where server '+@server+' and Segment '+@segment+' and odin_id '+@ManagerID+''
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Manager_Insert_Id
-- --------------------------------------------------
CREATE Proc USP_Manager_Insert_Id(@server as varchar(50),@segment as varchar(50),@date as varchar(11),@ManagerID as varchar(50))

as
set @date = convert(datetime,@date,103)
INSERT INTO terminals VALUES (@server,@ManagerID,@segment,@date,'Dec 31 2070')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Manager_Master
-- --------------------------------------------------

----------------------------------------
--Modified By :  Harshal Mahadik(Unistanz)
--Modified Date : 5 Feb 2013
--Description : Changes if condition for uniqueness on fld id i.e. server , segment,manager id.
---------------------------------------

CREATE PROC USP_Manager_Master    
(    
@Fld_SrNo INT,    
@Fld_Id AS INT,    
@Fld_Segment AS VARCHAR(10),    
@Fld_Manager_Id AS VARCHAR(50),    
@Fld_From_Date AS DATETIME,    
@Fld_To_Date AS DATETIME
)    
AS    
  
SET @Fld_From_Date = CONVERT(VARCHAR(11),CONVERT(DATETIME,@Fld_From_Date,103))  
SET @Fld_To_Date = CONVERT(VARCHAR(11),CONVERT(DATETIME,@Fld_To_Date,103))  
    
IF (SELECT COUNT(*) FROM Tbl_Manager_Master WHERE Fld_Manager_Id = @Fld_Manager_Id and Fld_Segment = @Fld_Segment and Fld_Id = @Fld_Id) > 0    
		BEGIN    
			UPDATE Tbl_Manager_Master 
			SET Fld_Id = @Fld_Id,
			Fld_Segment = @Fld_Segment,
			Fld_Manager_Id = @Fld_Manager_Id,
			Fld_From_Date = @Fld_From_Date,    
			Fld_To_Date = @Fld_To_Date 
			WHERE Fld_SrNo = @Fld_SrNo     
			IF @Fld_To_Date <> 'Dec 31 2049'    
				BEGIN
				 SELECT 'Manager ID Deactivated !' AS MSG    
				END  
			ELSE 
				BEGIN    
				SELECT 'Duplicate Data!'   AS MSG  
				END
		END     
Else    
		BEGIN
			INSERT INTO Tbl_Manager_Master VALUES (@Fld_Id,@Fld_Segment,@Fld_Manager_Id,@Fld_From_Date,@Fld_To_Date)    
			SELECT 'Record Saved !'   AS MSG  
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Manager_Validity
-- --------------------------------------------------
CREATE proc USP_Manager_Validity
(          
@filename as varchar(100)          
)           
as              
set transaction  isolation  level read uncommitted              
declare @path as varchar(100)          
declare @sql as varchar(1000)    

truncate table Manager_Cert      
        
set @path='d:\upload1\' + @filename          
SET @SQL = 'BULK INSERT Manager_Cert FROM '''+@Path+''' WITH (FIELDTERMINATOR = '','', FirstRow=2,KeepNULLS)'          
exec (@sql)          

insert into Tbl_Manager_Cert_Validity
select y.fld_id,Segment,CTCL_ID,convert(datetime,Start_Date),convert(datetime,End_Date)
from Manager_Cert x,Tbl_server_master y where x.Server_name = y.Fld_Server

select @@rowcount as Total

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MappingDetails
-- --------------------------------------------------
CREATE Proc USP_MappingDetails    
(@Fld_EmpId as varchar(25))    
as    
Select Fld_EmpID,Fld_DeptName,EMP_NAME from    
(Select Fld_EmpID, Fld_DeptName from tbl_dept_mapping (nolock) where Fld_EmpId= @Fld_EmpId)A    
Left outer JOIN     
(SELECT EMP_NO,EMP_NAME FROM INTRANET.RISK.DBO.EMP_INFO)B    
ON A.Fld_EmpId = B.EMP_NO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MIS_Report
-- --------------------------------------------------

CREATE Proc USP_MIS_Report(
@fdate as varchar(11),@tdate as varchar(25),@status as varchar(25),
@category as varchar(50),@code as varchar(50),
@entry_by as varchar(50),@grp_id as varchar(50),@call_type as varchar(50))

/*
Declare @fdate as varchar(11)
Declare @tdate as varchar(25)
Declare @status as varchar(25)

Declare @category as varchar(50)
declare @code as varchar(50)
declare @entry_by as varchar(50)
declare @grp_id as varchar(50)
declare @call_type as varchar(50)



set @status = 'Pending'
set @category = 'All'
set @code = '  '
set @entry_by = 'All'
set @grp_id = 'All'
set @call_type = 'All'
*/

as

Declare @str as varchar(5000)

set @fdate = convert(datetime,@fdate,103)
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))+ ' 23:59:59'

set @status = case when @status = 'All' then 'like ''%%''' else '= '+''''+@status+'''' end
set @category = case when @category = 'All' then 'like ''%%''' else '= '+''''+@category+'''' end
set @code = case when @code = '' then 'like ''%%''' else '= '+''''+ltrim(rtrim(@code))+'''' end
set @entry_by = case when @entry_by = 'All' then 'like ''%%''' else '= '+''''+ltrim(rtrim(@entry_by))+'''' end
set @grp_id = case when @grp_id = 'All' then 'like ''%%''' else '= '+''''+ltrim(rtrim(@grp_id))+'''' end
set @call_type = case when @call_type = 'All' then 'like ''%%''' else '= '+''''+ltrim(rtrim(@call_type))+'''' end

set @str = 'select distinct complaint_date,subject,code,TIme_Limit,department,dsection, queryfrom,cat_city=city, 
contact_person,problem,suggestion,remark,completed_on, status,complaintno, party_code,category,dremark,
helpdeskmarkcompleteddate, entry_by,it_conn,deptmarkcompleteddate,cast(datediff(Minute,complaint_date, 
deptmarkcompleteddate) as varchar(50)) + ''Minutes'' as Minutes from complaint_table 
where complaint_date >= '''+@fdate+''' and complaint_date <= '''+@tdate+'''  and 
entered_through = ''IT'' and status '+@status+' and category '+@category+' and code '+@code+'
and entry_by '+@entry_by+' and grp_id '+@grp_id+' and call_type '+@call_type+''
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MIS_REPORT_HELPDESK
-- --------------------------------------------------
CREATE  PROC [dbo].[USP_MIS_REPORT_HELPDESK] --'08/01/2012','08/06/2012','All','All','All','Broker','CSO'
    (
      @fromdate VARCHAR(11) ,
      @ToDate VARCHAR(11) ,
      @status VARCHAR(20) ,
      @dept VARCHAR(20) ,
      @Username VARCHAR(20) ,
      @access_to VARCHAR(20) ,
      @access_code VARCHAR(20)
    )
AS 
    DECLARE @str VARCHAR(MAX)
    BEGIN
        IF UPPER(@dept) = 'ALL' 
            BEGIN
                SET @dept = '%'
            END
     
    
        IF UPPER(@status) = 'ALL' 
            BEGIN
                SET @status = '%'
            END
    
        IF UPPER(@Username) = 'ALL' 
            BEGIN
            SET @Username = '%'
                IF UPPER(@access_to) = 'BROKER' 
                    BEGIN
                        SET @access_to = ''
                    END
			--ELSE
			--BEGIN
			--SET @access_to = 'exists(select * from (select distinct fldpartycode=entry_by,emp_name from complaint_table a (nolock),(select distinct emp_no,emp_name from intranet.risk.dbo.emp_info where branch_cd in (select branch_cd from intranet.risk.dbo.emp_info WHERE EMP_NO=' + entry_by ' )) b  where a.entry_by=b.emp_no)b where a.entry_by=b.fldpartycode)'''
			--END
            END
    
 
        SELECT  complaint_date = a.complaint_date ,
                a.code AS Code ,
                a.call_type AS Call_Type ,
                a.department AS Department,
                a.dsection AS DSection,
                a.queryfrom AS Queryfrom,
                a.contact_person AS [contact_person] ,
                LTRIM(RTRIM(LOWER(a.problem))) AS Problem ,
                LTRIM(RTRIM(a.suggestion))AS  Suggestion,
                LTRIM(RTRIM(a.remark)) AS Remark,
                a.completed_on  AS [completed_on],
                a.status AS Status,
                a.complaintno AS [Complaintno],
                a.party_code AS [Party code] ,
                a.category AS Category,
                a.dremark AS DRemark,
                a.helpdeskmarkcompleteddate AS [Helpdeskmarkcompleteddate],
                E.emp_name AS [Entry_by] ,
                a.subject AS [Subject],
                b.departmentname AS DepartmentName,
                c.branch AS Branch,
                c.region AS Region
        --INTO    #HelpdeskTemp
        FROM    mis.helpdeskn.dbo.complaint_table a
                INNER JOIN mis.helpdeskn.dbo.departmentmaster b ON a.department = b.deptno
                INNER JOIN Complaint_BR2 c ON a.code = c.code
                                              AND a.complaint_date = c.complaint_date
                INNER JOIN [INTRANET].risk.dbo.emp_info E ON E.emp_no = a.entry_by
        WHERE   a.complaint_date >= @fromdate 
                AND a.complaint_date <=  @ToDate 
                AND a.department like  @dept 
                AND a.status like  @status 
                AND a.entry_by like  @Username 
                
                
                
        END
   
--str = str + ";Delete from VW_RMS_CLIENT_VERTICAL ;Insert into VW_RMS_CLIENT_VERTICAL SELECT * FROM   [196.1.115.182].General.dbo.VW_RMS_CLIENT_VERTICAL"

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_OPHELPDESK
-- --------------------------------------------------
CREATE proc USP_MISREPORT_OPHELPDESK
 (    
 @deptid as varchar(15),    
 @fdate as varchar(11),    
 @tdate as varchar(11)    
 )    
 as  
 set @fdate = convert(datetime,@fdate,103)    
 set @tdate = convert(datetime,@tdate,103)+' 23:59:59.999'
select a.*,Subdesc=b.subject into #tt from 
(Select * from tbl_complaint(nolock) where dept_id =@deptid  
 and Complaint_Date >=@fdate and Complaint_Date <= @tdate)a left outer join
(select * from tbl_subject(nolock)) b on a.subject=b.srno

Select Subdesc,complaint_id,max(Complaint_Date) as dt into #t from #tt where dept_id = @deptid  
 and Complaint_Date >= @fdate and Complaint_Date <= @tdate   
 group by Subdesc,complaint_id

select  a.*,Pending=isnull(b.Pending,0),Inprocess=isnull(c.Inprocess,0) ,Hold=isnull(d.Hold,0),Completed=isnull(e.Completed,0) into #final  from
(select subject=Subdesc,complaint_id,Total=count(*) from #tt where convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)  
group by Subdesc,complaint_id)a
left outer join
(Select subject=Subdesc,complaint_id,Pending=count(*) from #tt where  
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)  
and status='P' group by Subdesc,complaint_id )b on a.subject=b.subject and a.complaint_id=b.complaint_id
left outer join
(Select subject=Subdesc,complaint_id,Inprocess=count(*) from #tt where 
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)  
and status in ('IP','C','F') group by Subdesc,complaint_id )c on a.subject=c.subject and a.complaint_id=c.complaint_id
left outer join
(Select subject=Subdesc,complaint_id,Hold=count(*) from #tt where  
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t) 
and status='H' group by Subdesc,complaint_id )d on a.subject=d.subject and a.complaint_id=d.complaint_id
left outer join
(Select subject=Subdesc,complaint_id,Completed=count(*) from #tt where  
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)  
and status='BC' group by Subdesc,complaint_id )e on a.subject=e.subject and a.complaint_id=e.complaint_id

select subject,Total=sum(Total),Pending=sum(Pending),Inprocess=sum(Inprocess) ,Hold=sum(Hold),Completed=sum(Completed) from #final
group by subject

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_OPHELPDESK_new
-- --------------------------------------------------
CREATE proc USP_MISREPORT_OPHELPDESK_new
 (    
 @deptid as varchar(15),    
 @fdate as varchar(11),    
 @tdate as varchar(11)    
 )    
 as  

--declare    @deptid as varchar(15), @fdate as varchar(11), @tdate as varchar(11) 
--set @deptid='3'
--set @fdate='02/11/2009'
--set @tdate='03/11/2009'

 set @fdate = convert(datetime,@fdate,103)    
 set @tdate = convert(datetime,@tdate,103)+' 23:59:59.999'
      

Select distinct subject into #tbl from tbl_complaint where dept_id = @deptid  
 and Complaint_Date >= @fdate and Complaint_Date < @tdate    
 group by subject

Select distinct subject into #pending from tbl_complaint     
 where dept_id = @deptid and Status = 'P' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject


Select distinct subject into #InProgress from tbl_complaint     
 where dept_id = @deptid and Status IN ('IP','C','F') and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject

Select distinct subject into #Hold from tbl_complaint     
 where dept_id = @deptid and Status = 'H' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject

Select distinct subject into #Completed from tbl_complaint     
 where dept_id = @deptid and Status = 'BC' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject


 Select a.subject,isnull(a.Total,0)Total,isnull(b.Pending,0)Pending,isnull(c.InProcess,0)InProcess,    
 isnull(d.Hold,0)Hold,isnull(e.Completed,0)Completed from    
 (Select y.subject,x.Total  from    
 (select subject,count(subject)as total from #tbl  group by subject )x    
 right outer join    
 (Select * from tbl_subject where fld_deptid = @deptid)y    
 on x.subject=y.srno)a    
     
 left outer join    
     
 (Select y.subject,x.Pending  from    
 (select subject,count(subject)as Pending from #pending group by subject)x    
 right outer join    
 (Select * from tbl_subject where fld_deptid = @deptid)y    
 on x.subject=y.srno)b    
     
 on a.subject = b.subject    
     
 left outer join    
     
 (Select y.subject,x.InProcess  from    
 (select subject,count(subject)as InProcess from #InProgress group by subject)x    
 right outer join    
 (Select * from tbl_subject where fld_deptid = @deptid)y    
 on x.subject=y.srno)c    
 on a.subject = c.subject    
     
 left outer join    
     
 (Select y.subject,x.Hold  from    
 (select subject,count(subject)as Hold from #Hold group by subject)x    
 right outer join    
 (Select * from tbl_subject where fld_deptid = @deptid)y    
 on x.subject=y.srno)d    
     
 on a.subject = d.subject    
     
 left outer join    
     
 (Select y.subject,x.Completed  from    
 (select subject,count(subject)as Completed from #Completed group by subject)x    
 right outer join    
 (Select * from tbl_subject where fld_deptid = @deptid)y    
 on x.subject=y.srno)e    
     
 on a.subject = e.subject    
     
 order by a.Total desc ,b.Pending desc,c.InProcess desc,d.Hold desc ,e.Completed desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_OPHELPDESK_NEW_15122010
-- --------------------------------------------------
CREATE PROC USP_MISREPORT_OPHELPDESK_NEW_15122010 
 (      
	 @deptid as varchar(15),      
	 @fdate as varchar(11),      
	 @tdate as varchar(11)      
 )      
 as    
  
	--declare    @deptid as varchar(15), @fdate as varchar(11), @tdate as varchar(11)   
	--set @deptid='3'  
	--set @fdate='02/11/2009'  
	--set @tdate='03/11/2009'  
  
	set @fdate = convert(datetime,@fdate,103)      
	set @tdate = convert(datetime,@tdate,103)+' 23:59:59.999'  

	Select distinct subject into #tbl from tbl_complaint where dept_id = @deptid    
	and Complaint_Date >= @fdate and Complaint_Date < @tdate      
	group by subject  

	Select distinct subject into #pending from tbl_complaint       
	where dept_id = @deptid and Status = 'P' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #InProgress from tbl_complaint       
	where dept_id = @deptid and Status IN ('IP','C','F') and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #Hold from tbl_complaint       
	where dept_id = @deptid and Status = 'H' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #Completed from tbl_complaint       
	where dept_id = @deptid and Status = 'BC' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	-- [+] ADDED CREATION OF TEMPORARY TABLES 15-12-2010
	
	Select y.subject,x.Total  
	into #temp1
	from      
	(
		select subject,count(subject)as total 
		from #tbl  
		group by subject 
	)x      
	right outer join      
	(
		Select * from tbl_subject 
		where fld_deptid = @deptid
	)y      
	on x.subject=y.srno
	
	Select y.subject,x.Pending  
	INTO #TEMP2
	from      
	(
		select subject,count(subject)as Pending 
		from #pending 
		group by subject
	)x      
	right outer join      
	(
		Select * 
		from tbl_subject 
		where fld_deptid = @deptid
	)y on x.subject=y.srno
	
	
	Select y.subject,x.InProcess 
	INTO #TEMP3
	from      
	(
		select subject,count(subject)as InProcess 
		from #InProgress 
		group by subject
	)x      
	right outer join      
	(
		Select * 
		from tbl_subject 
		where fld_deptid = @deptid
	)y 
	on x.subject=y.srno
	
	Select y.subject,x.Hold 
	INTO #TEMP4
	from      
	(
		select subject,count(subject)as Hold 
		from #Hold 
		group by subject
	)x      
	right outer join      
	(
		Select * 
		from tbl_subject 
		where fld_deptid = @deptid
	)y      
	on x.subject=y.srno
	
	Select y.subject,x.Completed 
	INTO #TEMP5
	from      
	(
		select subject,count(subject)as Completed 
		from #Completed 
		group by subject
	)x      
	right outer join      
	(
		Select * 
		from tbl_subject 
		where fld_deptid = @deptid
	)y      
	on x.subject=y.srno
	
	DROP TABLE #tbl
	DROP TABLE #Completed
	DROP TABLE #Hold
	DROP TABLE #InProgress
	DROP TABLE #pending
	
	-- [-] END
		
	Select a.subject,isnull(a.Total,0)Total,isnull(b.Pending,0)Pending,isnull(c.InProcess,0)InProcess,      
		isnull(d.Hold,0)Hold,isnull(e.Completed,0)Completed 
	from      
	
	#TEMP1 a left outer join #TEMP2 b on a.subject = b.subject      
	left outer join #TEMP3 c on a.subject = c.subject    
	left outer join #TEMP4 d on a.subject = d.subject   
	left outer join #TEMP5 e on a.subject = e.subject 
	
	order by #TEMP1.Total desc ,#TEMP2.Pending desc,#TEMP3.InProcess desc,#TEMP4.Hold desc ,#TEMP5.Completed desc      
	
	--(
		--Select y.subject,x.Total  from      
		--(
		--	select subject,count(subject)as total 
		--	from #tbl  
		--	group by subject 
		--)x      
		--right outer join      
		--(
		--	Select * from tbl_subject 
		--	where fld_deptid = @deptid
		--)y      
		--on x.subject=y.srno
	--)a      
	   
	--left outer join      
	   
	--(
		--Select y.subject,x.Pending  
		--from      
		--	(
		--		select subject,count(subject)as Pending 
		--		from #pending 
		--		group by subject
		--	)x      
		--	right outer join      
		--	(
		--		Select * 
		--		from tbl_subject 
		--		where fld_deptid = @deptid
		--	)y on x.subject=y.srno
	--)b      
	   
	--on a.subject = b.subject      
	   
	--left outer join      
	   
	--(
		--Select y.subject,x.InProcess 
		--from      
		--(
		--	select subject,count(subject)as InProcess 
		--	from #InProgress 
		--	group by subject
		--)x      
		--right outer join      
		--(
		--	Select * 
		--	from tbl_subject 
		--	where fld_deptid = @deptid
		--)y 
		--on x.subject=y.srno
	--)c      
	--on a.subject = c.subject      
		   
	--left outer join      
	   
	--(
		--Select y.subject,x.Hold 
		--from      
		--(
		--	select subject,count(subject)as Hold 
		--	from #Hold 
		--	group by subject
		--)x      
		--right outer join      
		--(
		--	Select * 
		--	from tbl_subject 
		--	where fld_deptid = @deptid
		--)y      
		--on x.subject=y.srno
	--)d      
		   
	--on a.subject = d.subject      
	   
	--left outer join      
	   
	--(
		--Select y.subject,x.Completed 
		--from      
		--(
		--	select subject,count(subject)as Completed 
		--	from #Completed 
		--	group by subject
		--)x      
		
		--right outer join      
		
		--(
		--	Select * 
		--	from tbl_subject 
		--	where fld_deptid = @deptid
		--)y      
		
		--on x.subject=y.srno
	--)e      
	   
	--on a.subject = e.subject      
	   
	--order by a.Total desc ,b.Pending desc,c.InProcess desc,d.Hold desc ,e.Completed desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_OPHELPDESK_NEW_31122010
-- --------------------------------------------------
CREATE PROC USP_MISREPORT_OPHELPDESK_NEW_31122010  
 (      
	 @DEPTID AS VARCHAR(15),      
	 @FDATE AS VARCHAR(11),      
	 @TDATE AS VARCHAR(11)      
 )   
    
 AS    

	--DECLARE    @DEPTID AS VARCHAR(15), @FDATE AS VARCHAR(11), @TDATE AS VARCHAR(11)   
	--SET @DEPTID='3'  
	--SET @FDATE='02/11/2009'  
	--SET @TDATE='03/11/2009'  

	SET @FDATE = CONVERT(DATETIME,@FDATE,103)      
	SET @TDATE = CONVERT(DATETIME,@TDATE,103)+' 23:59:59.999'  


	SELECT DISTINCT SUBJECT INTO #TBL FROM TBL_COMPLAINT WHERE DEPT_ID = @DEPTID    
	AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE      
	GROUP BY SUBJECT  

	SELECT DISTINCT SUBJECT INTO #PENDING FROM TBL_COMPLAINT       
	WHERE DEPT_ID = @DEPTID AND STATUS = 'P' AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT  


	SELECT DISTINCT SUBJECT INTO #INPROGRESS FROM TBL_COMPLAINT       
	WHERE DEPT_ID = @DEPTID AND STATUS IN ('IP','C','F') AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT  

	SELECT DISTINCT SUBJECT INTO #HOLD FROM TBL_COMPLAINT       
	WHERE DEPT_ID = @DEPTID AND STATUS = 'H' AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT  

	SELECT DISTINCT SUBJECT INTO #COMPLETED FROM TBL_COMPLAINT       
	WHERE DEPT_ID = @DEPTID AND STATUS = 'BC' AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT  


	SELECT A.SUBJECT,TOTAL=ISNULL(A.TOTAL,0),
		PENDING=ISNULL(B.PENDING,0),
		INPROCESS=ISNULL(C.INPROCESS,0),      
		HOLD=ISNULL(D.HOLD,0),
		COMPLETED=ISNULL(E.COMPLETED,0)
	FROM      
	(SELECT Y.SUBJECT,X.TOTAL  FROM      
	(SELECT SUBJECT,COUNT(SUBJECT)AS TOTAL FROM #TBL  GROUP BY SUBJECT )X      
	RIGHT OUTER JOIN      
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y      
	ON X.SUBJECT=Y.SRNO)A      

	LEFT OUTER JOIN      

	(SELECT Y.SUBJECT,X.PENDING  FROM      
	(SELECT SUBJECT,COUNT(SUBJECT)AS PENDING FROM #PENDING GROUP BY SUBJECT)X      
	RIGHT OUTER JOIN      
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y      
	ON X.SUBJECT=Y.SRNO)B      

	ON A.SUBJECT = B.SUBJECT      

	LEFT OUTER JOIN      

	(SELECT Y.SUBJECT,X.INPROCESS  FROM      
	(SELECT SUBJECT,COUNT(SUBJECT)AS INPROCESS FROM #INPROGRESS GROUP BY SUBJECT)X      
	RIGHT OUTER JOIN      
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y      
	ON X.SUBJECT=Y.SRNO)C      
	ON A.SUBJECT = C.SUBJECT      

	LEFT OUTER JOIN      

	(SELECT Y.SUBJECT,X.HOLD  FROM      
	(SELECT SUBJECT,COUNT(SUBJECT)AS HOLD FROM #HOLD GROUP BY SUBJECT)X      
	RIGHT OUTER JOIN      
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y      
	ON X.SUBJECT=Y.SRNO)D      

	ON A.SUBJECT = D.SUBJECT      

	LEFT OUTER JOIN      

	(SELECT Y.SUBJECT,X.COMPLETED  FROM      
	(SELECT SUBJECT,COUNT(SUBJECT)AS COMPLETED FROM #COMPLETED GROUP BY SUBJECT)X      
	RIGHT OUTER JOIN      
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y      
	ON X.SUBJECT=Y.SRNO)E      

	ON A.SUBJECT = E.SUBJECT      

	ORDER BY TOTAL DESC ,PENDING DESC,INPROCESS DESC,HOLD DESC ,COMPLETED DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_OPHELPDESK_temp
-- --------------------------------------------------
  
CREATE PROCEDURE USP_MISREPORT_OPHELPDESK_TEMP
(      
	@deptid as varchar(15),      
	@fdate as varchar(11),      
	@tdate as varchar(11)      
)      

as    
  
	--declare @deptid as varchar(15), @fdate as varchar(11), @tdate as varchar(11)   
	--set @deptid='3'  
	--set @fdate='02/11/2009'  
	--set @tdate='03/11/2009'  
  
	set @fdate = convert(datetime,@fdate,103)      
	set @tdate = convert(datetime,@tdate,103)+' 23:59:59.999'  

	Select distinct subject into #tbl from tbl_complaint where dept_id = @deptid    
	and Complaint_Date >= @fdate and Complaint_Date < @tdate      
	group by subject  

	Select distinct subject into #pending from tbl_complaint       
	where dept_id = @deptid and Status = 'P' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #InProgress from tbl_complaint       
	where dept_id = @deptid and Status IN ('IP','C','F') and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #Hold from tbl_complaint       
	where dept_id = @deptid and Status = 'H' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #Completed from tbl_complaint       
	where dept_id = @deptid and Status = 'BC' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select a.subject,isnull(a.Total,0)Total,isnull(b.Pending,0)Pending,isnull(c.InProcess,0)InProcess,      
	isnull(d.Hold,0)Hold,isnull(e.Completed,0)Completed 
	from      
		
		(
			Select y.subject,x.Total  
			from      
				(select subject,count(subject)as total from #tbl  group by subject )x      
				right outer join      
				(Select * from tbl_subject where fld_deptid = @deptid)y      
			on x.subject=y.srno
		)a      
		   
		left outer join      
		   
		(
			Select y.subject,x.Pending  from      
			(select subject,count(subject)as Pending from #pending group by subject)x      
			right outer join      
			(Select * from tbl_subject where fld_deptid = @deptid)y      
			on x.subject=y.srno
		)b      
		   
		on a.subject = b.subject      
		   
		left outer join      
		   
		(
			Select y.subject,x.InProcess  from      
			(select subject,count(subject)as InProcess from #InProgress group by subject)x      
			right outer join      
			(Select * from tbl_subject where fld_deptid = @deptid)y      
			on x.subject=y.srno
		)c      
		
		on a.subject = c.subject      
		   
		left outer join      
		   
		(
			Select y.subject,x.Hold  from      
			(select subject,count(subject)as Hold from #Hold group by subject)x      
			right outer join      
			(Select * from tbl_subject where fld_deptid = @deptid)y      
			on x.subject=y.srno
		)d      
		   
		on a.subject = d.subject      
		   
		left outer join      
		   
		(
			Select y.subject,x.Completed  from      
			(select subject,count(subject)as Completed from #Completed group by subject)x      
			right outer join      
			(Select * from tbl_subject where fld_deptid = @deptid)y      
			on x.subject=y.srno
		)e      
		   
		on a.subject = e.subject      
	   
	order by a.Total desc ,b.Pending desc,c.InProcess desc,d.Hold desc ,e.Completed desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_OPHELPDESK_TEMP_15122010
-- --------------------------------------------------
  
CREATE PROCEDURE USP_MISREPORT_OPHELPDESK_TEMP_15122010
(      
	@deptid as varchar(15),      
	@fdate as varchar(11),      
	@tdate as varchar(11)      
)      

as    
  
	--declare @deptid as varchar(15), @fdate as varchar(11), @tdate as varchar(11)   
	--set @deptid='3'  
	--set @fdate='02/11/2009'  
	--set @tdate='03/11/2009'  
  
	set @fdate = convert(datetime,@fdate,103)      
	set @tdate = convert(datetime,@tdate,103)+' 23:59:59.999'  

	Select distinct subject into #tbl from tbl_complaint where dept_id = @deptid    
	and Complaint_Date >= @fdate and Complaint_Date < @tdate      
	group by subject  

	Select distinct subject into #pending from tbl_complaint       
	where dept_id = @deptid and Status = 'P' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #InProgress from tbl_complaint       
	where dept_id = @deptid and Status IN ('IP','C','F') and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #Hold from tbl_complaint       
	where dept_id = @deptid and Status = 'H' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  

	Select distinct subject into #Completed from tbl_complaint       
	where dept_id = @deptid and Status = 'BC' and Complaint_Date >= @fdate and Complaint_Date < @tdate group by subject  
	
	
	
	-- [+] CREATION OF TEMPORARY TABLE 
	
	Select y.subject,x.Total  
	INTO #TEMP1
	from      
		(select subject,count(subject)as total from #tbl  group by subject )x      
		right outer join      
		(Select * from tbl_subject where fld_deptid = @deptid)y      
	on x.subject=y.srno
	
	
	Select y.subject,x.Pending 
	INTO #TEMP2
	from      
	(select subject,count(subject)as Pending from #pending group by subject)x      
	right outer join      
	(Select * from tbl_subject where fld_deptid = @deptid)y      
	on x.subject=y.srno
	
	Select y.subject,x.InProcess 
	into #temp3
	from      
	(select subject,count(subject)as InProcess from #InProgress group by subject)x      
	right outer join      
	(Select * from tbl_subject where fld_deptid = @deptid)y      
	on x.subject=y.srno
	
	Select y.subject,x.Hold 
	into #temp4
	from      
	(select subject,count(subject)as Hold from #Hold group by subject)x      
	right outer join      
	(Select * from tbl_subject where fld_deptid = @deptid)y      
	on x.subject=y.srno
	
	Select y.subject,x.Completed 
	into #temp5
	from      
	(select subject,count(subject)as Completed from #Completed group by subject)x      
	right outer join      
	(Select * from tbl_subject where fld_deptid = @deptid)y      
	on x.subject=y.srno
	
	DROP TABLE #tbl
	DROP TABLE #pending
	DROP TABLE #Hold
	DROP TABLE #Completed
	DROP TABLE #InProgress
		
	Select a.subject,isnull(a.Total,0)Total,isnull(b.Pending,0)Pending,isnull(c.InProcess,0)InProcess,      
	isnull(d.Hold,0)Hold,isnull(e.Completed,0)Completed 
	from      
		
		#TEMP1 A LEFT OUTER JOIN #TEMP2 b ON A.SUBJECT = B.SUBJECT
		LEFT OUTER JOIN #TEMP3 C ON A.SUBJECT = C.SUBJECT      
		LEFT OUTER JOIN #TEMP4 D ON A.SUBJECT = D.SUBJECT 
		LEFT OUTER JOIN #TEMP5 E ON A.SUBJECT = E.SUBJECT      
	   
	order by #TEMP1.Total desc ,#TEMP2.Pending desc,#TEMP3.InProcess desc,#TEMP4.Hold desc ,#TEMP5.Completed desc    
	
	-- [-] END

	--Select a.subject,isnull(a.Total,0)Total,isnull(b.Pending,0)Pending,isnull(c.InProcess,0)InProcess,      
	--isnull(d.Hold,0)Hold,isnull(e.Completed,0)Completed 
	--from      
		
	--	(
	--		Select y.subject,x.Total  
	--		from      
	--			(select subject,count(subject)as total from #tbl  group by subject )x      
	--			right outer join      
	--			(Select * from tbl_subject where fld_deptid = @deptid)y      
	--		on x.subject=y.srno
	--	)a      
		   
	--	left outer join      
		   
	--	(
	--		Select y.subject,x.Pending  from      
	--		(select subject,count(subject)as Pending from #pending group by subject)x      
	--		right outer join      
	--		(Select * from tbl_subject where fld_deptid = @deptid)y      
	--		on x.subject=y.srno
	--	)b      
		   
	--	on a.subject = b.subject      
		   
	--	left outer join      
		   
	--	(
	--		Select y.subject,x.InProcess  from      
	--		(select subject,count(subject)as InProcess from #InProgress group by subject)x      
	--		right outer join      
	--		(Select * from tbl_subject where fld_deptid = @deptid)y      
	--		on x.subject=y.srno
	--	)c      
		
	--	on a.subject = c.subject      
		   
	--	left outer join      
		   
	--	(
	--		Select y.subject,x.Hold  from      
	--		(select subject,count(subject)as Hold from #Hold group by subject)x      
	--		right outer join      
	--		(Select * from tbl_subject where fld_deptid = @deptid)y      
	--		on x.subject=y.srno
	--	)d      
		   
	--	on a.subject = d.subject      
		   
	--	left outer join      
		   
	--	(
	--		Select y.subject,x.Completed  from      
	--		(select subject,count(subject)as Completed from #Completed group by subject)x      
	--		right outer join      
	--		(Select * from tbl_subject where fld_deptid = @deptid)y      
	--		on x.subject=y.srno
	--	)e      
		   
	--	on a.subject = e.subject      
	   
	--order by a.Total desc ,b.Pending desc,c.InProcess desc,d.Hold desc ,e.Completed desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_OPHELPDESK_TEMP_31122010
-- --------------------------------------------------
    
CREATE PROCEDURE USP_MISREPORT_OPHELPDESK_TEMP_31122010
(        
	 @DEPTID AS VARCHAR(15),        
	 @FDATE AS VARCHAR(11),        
	 @TDATE AS VARCHAR(11)        
)        
  
AS      
    
	--DECLARE @DEPTID AS VARCHAR(15), @FDATE AS VARCHAR(11), @TDATE AS VARCHAR(11)     
	--SET @DEPTID='3'    
	--SET @FDATE='02/11/2009'    
	--SET @TDATE='03/11/2009'    

	SET @FDATE = CONVERT(DATETIME,@FDATE,103)        
	SET @TDATE = CONVERT(DATETIME,@TDATE,103)+' 23:59:59.999'    

	SELECT DISTINCT SUBJECT INTO #TBL FROM TBL_COMPLAINT WHERE DEPT_ID = @DEPTID      
	AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE        
	GROUP BY SUBJECT    

	SELECT DISTINCT SUBJECT INTO #PENDING FROM TBL_COMPLAINT         
	WHERE DEPT_ID = @DEPTID AND STATUS = 'P' AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT    

	SELECT DISTINCT SUBJECT INTO #INPROGRESS FROM TBL_COMPLAINT         
	WHERE DEPT_ID = @DEPTID AND STATUS IN ('IP','C','F') AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT    

	SELECT DISTINCT SUBJECT INTO #HOLD FROM TBL_COMPLAINT         
	WHERE DEPT_ID = @DEPTID AND STATUS = 'H' AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT    

	SELECT DISTINCT SUBJECT INTO #COMPLETED FROM TBL_COMPLAINT         
	WHERE DEPT_ID = @DEPTID AND STATUS = 'BC' AND COMPLAINT_DATE >= @FDATE AND COMPLAINT_DATE < @TDATE GROUP BY SUBJECT    

	SELECT A.SUBJECT,TOTAL=ISNULL(A.TOTAL,0),PENDING=ISNULL(B.PENDING,0),INPROCESS=ISNULL(C.INPROCESS,0),        
	HOLD=ISNULL(D.HOLD,0),COMPLETED=ISNULL(E.COMPLETED,0)   
	FROM        

	(  
	SELECT Y.SUBJECT,X.TOTAL    
	FROM        
	(SELECT SUBJECT,COUNT(SUBJECT)AS TOTAL FROM #TBL  GROUP BY SUBJECT )X        
	RIGHT OUTER JOIN        
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y        
	ON X.SUBJECT=Y.SRNO  
	)A        

	LEFT OUTER JOIN        

	(  
	SELECT Y.SUBJECT,X.PENDING  FROM        
	(SELECT SUBJECT,COUNT(SUBJECT)AS PENDING FROM #PENDING GROUP BY SUBJECT)X        
	RIGHT OUTER JOIN        
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y        
	ON X.SUBJECT=Y.SRNO  
	)B        

	ON A.SUBJECT = B.SUBJECT        

	LEFT OUTER JOIN        

	(  
	SELECT Y.SUBJECT,X.INPROCESS  FROM        
	(SELECT SUBJECT,COUNT(SUBJECT)AS INPROCESS FROM #INPROGRESS GROUP BY SUBJECT)X        
	RIGHT OUTER JOIN        
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y        
	ON X.SUBJECT=Y.SRNO  
	)C        

	ON A.SUBJECT = C.SUBJECT        

	LEFT OUTER JOIN        

	(  
	SELECT Y.SUBJECT,X.HOLD  FROM        
	(SELECT SUBJECT,COUNT(SUBJECT)AS HOLD FROM #HOLD GROUP BY SUBJECT)X        
	RIGHT OUTER JOIN        
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y        
	ON X.SUBJECT=Y.SRNO  
	)D        

	ON A.SUBJECT = D.SUBJECT        

	LEFT OUTER JOIN        

	(  
	SELECT Y.SUBJECT,X.COMPLETED  FROM        
	(SELECT SUBJECT,COUNT(SUBJECT)AS COMPLETED FROM #COMPLETED GROUP BY SUBJECT)X        
	RIGHT OUTER JOIN        
	(SELECT * FROM TBL_SUBJECT WHERE FLD_DEPTID = @DEPTID)Y        
	ON X.SUBJECT=Y.SRNO  
	)E        

	ON A.SUBJECT = E.SUBJECT        

	ORDER BY TOTAL DESC ,PENDING DESC,INPROCESS DESC,HOLD DESC,COMPLETED DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_MISREPORT_SUBJECTOPHELPDESK
-- --------------------------------------------------
CREATE proc USP_MISREPORT_SUBJECTOPHELPDESK 
(
 @fdate as varchar(11),      
 @tdate as varchar(11),
 @deptid as varchar(15),      
 @regcode as varchar(25),
 @brcode as varchar(25)
) 
as
/*
 declare  @deptid as varchar(15),      
 @fdate as varchar(11),      
 @tdate as varchar(11),
 @regcode as varchar(25),
 @brcode as varchar(25)
 
 set @regcode = 'MUM'
 set @brcode = '%%' 
 set @deptid = '2'
 set @fdate = convert(datetime,'01/02/2010',103)      
 set @tdate = convert(datetime,'21/02/2010',103)+' 23:59:59.999'  
 */
 
 
 set @fdate = convert(datetime,@fdate,103)      
 set @tdate = convert(datetime,@tdate,103)+' 23:59:59.999'  
 
 select a.*,Subdesc=b.subject into #tt1 from   
(Select * from tbl_complaint(nolock) where dept_id =@deptid    
 and Complaint_Date >=@fdate and Complaint_Date <= @tdate)a left outer join  
(select * from tbl_subject(nolock)) b on a.subject=b.srno  

select c.*,d.reg_code into #tt from 
(select * from #tt1 a left outer join    
(select emp_no,brcd=costcode from intranet.risk.dbo.emp_info)b    
on a.fld_entryby=b.emp_no
)c left outer join intranet.risk.dbo.region d on c.brcd = d.code

 
 Select Subdesc,complaint_id,max(Complaint_Date) as dt into #t from #tt where dept_id = @deptid    
 and Complaint_Date >= @fdate and Complaint_Date <= @tdate  and brcd like @brcode and reg_code like @regcode   
 group by Subdesc,complaint_id  
 
 select  a.*,Pending=isnull(b.Pending,0),Inprocess=isnull(c.Inprocess,0) ,Hold=isnull(d.Hold,0),Completed=isnull(e.Completed,0) into #final  from  
(select subject=Subdesc,complaint_id,Total=count(*) from #tt where convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in  
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)    
group by Subdesc,complaint_id)a  
left outer join  
(Select subject=Subdesc,complaint_id,Pending=count(*) from #tt where    
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in  
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)    
and status='P' group by Subdesc,complaint_id )b on a.subject=b.subject and a.complaint_id=b.complaint_id  
left outer join  
(Select subject=Subdesc,complaint_id,Inprocess=count(*) from #tt where   
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in  
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)    
and status in ('IP','C','F') group by Subdesc,complaint_id )c on a.subject=c.subject and a.complaint_id=c.complaint_id  
left outer join  
(Select subject=Subdesc,complaint_id,Hold=count(*) from #tt where    
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in  
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)   
and status='H' group by Subdesc,complaint_id )d on a.subject=d.subject and a.complaint_id=d.complaint_id  
left outer join  
(Select subject=Subdesc,complaint_id,Completed=count(*) from #tt where    
  convert(varchar(25),Complaint_Date,121)+Subdesc+complaint_id in  
(select convert(varchar(25),dt,121)+Subdesc+complaint_id from #t)    
and status='BC' group by Subdesc,complaint_id )e on a.subject=e.subject and a.complaint_id=e.complaint_id  
  
select subject,Total=sum(Total),Pending=sum(Pending),Inprocess=sum(Inprocess) ,Hold=sum(Hold),Completed=sum(Completed) from #final  
group by subject

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_modify_po_CancelReq
-- --------------------------------------------------
CREATE proc Usp_modify_po_CancelReq(@ReqId varchar(50),@Srno varchar(1000))                
as                
               
update tbl_itrequestmaster set fld_status='P'         
where Fld_status='PO' and Fld_SrNo in(select * from  function_string_to_table(@Srno,','))          
            
delete from tbl_itrequestPurchaseOrder where Fld_PId in(Select Fld_Pid from tbl_itAssetsData where Fld_RequestTableSrNo in(select * from  function_string_to_table(@Srno,',')) )--(select * from  function_string_to_table(@ReqId,','))                  
            
delete from tbl_itAssetsData where Fld_Pid in (Select Fld_Pid from tbl_itAssetsData where Fld_RequestTableSrNo in(select * from  function_string_to_table(@Srno,',')) )--(select * from  function_string_to_table(@ReqId,','))                  
                       
--delete from tbl_itAssetsData where Fld_RequestId in (select * from  function_string_to_table(@ReqId,','))                 
                
--update tbl_ItRequestmaster set fld_status='PO' where Fld_requestid in (select * from  function_string_to_table(@ReqId,','))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_modify_po_no
-- --------------------------------------------------
CREATE proc usp_modify_po_no(@pono as varchar(35))              
as              
              
select a.*,b.compname from               
(select  * from tbl_itrequestpurchaseorder(nolock) where fld_purchaseorderno=@pono)a              
left outer join              
(select compid,compname from tbl_it_angelgroupofcompaniesmaster(nolock) where status='A')b              
on a.fld_compid=b.compid              
              
select a.*,b.fld_adminremark from              
(select fld_requestid,fld_assetname,fld_productmodel,fld_productdesc,fld_partno,sum(fld_qty) as qty,sum(fld_rate) as rate,Fld_RequestTableSrNo,Fld_WarrantyType              
from tbl_itassetsdata where Fld_PId in              
((select  Fld_PId from tbl_itrequestpurchaseorder(nolock) where fld_purchaseorderno=@pono))              
 group by fld_requestid,fld_assetname,fld_productmodel,fld_productdesc,fld_partno,Fld_RequestTableSrNo,Fld_WarrantyType)a              
left outer join              
(select distinct fld_requestid,fld_adminremark from tbl_itrequestmaster(nolock))b              
on a.fld_requestid=b.fld_requestid order by Fld_requestId            
              
              
select distinct * from tbl_it_taxes(nolock) where fld_requestid in              
(select  fld_PId from tbl_itrequestpurchaseorder(nolock) where fld_purchaseorderno=@pono)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_modify_po_no1
-- --------------------------------------------------
        
        
CREATE proc Usp_modify_po_no1(@ReqId varchar(50),@Srno varchar(1000))    
                     
as                
     
update tbl_itrequestmaster set fld_status='CSOF'         
where Fld_status='PO' and Fld_SrNo in(select data from  function_string_to_table(@Srno,','))          
            
delete from tbl_itrequestPurchaseOrder where Fld_PId in(Select Fld_Pid from tbl_itAssetsData where Fld_RequestTableSrNo in(select * from  function_string_to_table(@Srno,',')) )--(select * from  function_string_to_table(@ReqId,','))                  
            
delete from tbl_itAssetsData where Fld_Pid in (Select Fld_Pid from tbl_itAssetsData where Fld_RequestTableSrNo in(select * from  function_string_to_table(@Srno,',')) )--(select * from  function_string_to_table(@ReqId,','))                  
                       
--delete from tbl_itAssetsData where Fld_RequestId in (select * from  function_string_to_table(@ReqId,','))                 
                
--update tbl_ItRequestmaster set fld_status='PO' where Fld_requestid in (select * from  function_string_to_table(@ReqId,','))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_modify_po_no2
-- --------------------------------------------------
CREATE proc usp_modify_po_no2(@pono as varchar(35))          
as          
          
--select x.*,y.Fld_AssetName,replace(str(Fld_RequestId,6),' ',0) as RequestID  from          
--(select * from tbl_ITRequestMaster(nolock))x          
--left outer join          
--(select  * from tbl_it_assetmaster (nolock))y          
--on x.Fld_AssetType = y.Fld_AssetID   
  
select x.*,y.Fld_AssetName,replace(str(Fld_RequestId,6),' ',0) as RequestID  from   
(select * from tbl_itrequestmaster where Fld_srno in  
(select Fld_RequestTableSrno from tbl_itassetsdata where Fld_Pid in   
(select Fld_PID from tbl_itrequestpurchaseorder where fld_purchaseorderno=@pono)))x  
left outer join          
(select  * from tbl_it_assetmaster (nolock))y          
on x.Fld_AssetType = y.Fld_AssetID  order by Fld_requestId

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_namephemai
-- --------------------------------------------------
CREATE procedure usp_namephemai (@clname as varchar(10))
as
select short_name,ph=COALESCE(res_phone1,res_phone2,off_phone1,off_phone2),email  from anand1.msajag.dbo.client1  where cl_code=@clname
union all
select short_name,ph=COALESCE(res_phone1,res_phone2,off_phone1,off_phone2),email  from angelfo.nsefo.dbo.client1  where cl_code=@clname
union all
select short_name,ph=COALESCE(res_phone1,res_phone2,off_phone1,off_phone2),email  from angelcommodity.mcdx.dbo.client1  where cl_code=@clname
union all
select short_name,ph=COALESCE(res_phone1,res_phone2,off_phone1,off_phone2),email  from angelcommodity.ncdx.dbo.client1  where cl_code=@clname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Ncfm_CodeGen
-- --------------------------------------------------
CREATE Proc Usp_Ncfm_CodeGen (@ExamType VARCHAR(15),@ExamModule VARCHAR(100),@RegNo VARCHAR(50),            
@PrefLoc VARCHAR(50),@PrefDate varchar(11),@MOnth varchar(25),@PrefTime VARCHAR(15),    
@EmpCode VARCHAR(20),@Location VARCHAR(50))            
            
As             
            
DECLARE @MaxNo as NUMERIC            
DECLARE @NcfmCode as VARCHAR(10)            
            
SET @PrefDate = CONVERT(datetime,@PrefDate,103)            
            
SET @MaxNo = (Select Isnull(Max(Convert(Numeric,SUBSTRING(Fld_NcfmCode,6,20))),0) from tbl_Ncfm_Exam_Master)            
            
IF @MaxNo < 100            
 SET @NcfmCode = (Select 'NCFM-'+replace(str(@MaxNo+1,3,0),' ','0'))                                                            
ELSE             
 SET @NcfmCode = (Select 'NCFM-'+@MaxNo+1)                                                            
            
INSERT INTO tbl_Ncfm_Exam_Master VALUES(@NcfmCode,@ExamType,@ExamModule,@RegNo,@PrefLoc,@PrefDate,'',@MOnth,@PrefTime,getdate(),@EmpCode,@Location,'N','')            
            
SELECT @NcfmCode as NcfmCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_NCFM_EXAM
-- --------------------------------------------------
Create proc USP_NCFM_EXAM
(
@Fld_NcfmCode varchar(10),
@Fld_Examtype varchar(50),    
@Fld_exammodule varchar(50),    
@Fld_registration_no Varchar(50),      
@Fld_preferredl_loc varchar(15),      
@Fld_preferred_date Varchar(15),      
@Fld_preferred_time varchar(15),      
@Fld_EmpCode varchar(50),      
@Fld_Location varchar(10)
)  
as
 insert into tbl_ncfm_exam_master
values
(    
@Fld_NcfmCode,
@Fld_Examtype,    
@Fld_exammodule,    
@Fld_registration_no,      
@Fld_preferredl_loc,      
@Fld_preferred_date,      
@Fld_preferred_time,
 getdate(),       
@Fld_EmpCode ,      
@Fld_Location 
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Ncfm_Mail
-- --------------------------------------------------
CREATE proc usp_Ncfm_Mail(@TO as varchar(50),@CC as varchar(50),@NcfmCode as varchar(15))                                    
as                                                                                             
      
DECLARE @rc INT                   
IF NOT EXISTS (SELECT * FROM intranet.msdb.sys.service_queues                   
WHERE name = N'ExternalMailQueue' AND is_receive_enabled = 1)                  
EXEC @rc = intranet.msdb.dbo.sysmail_start_sp

Declare @Msg as varchar(5000)    
Declare @Sub as varchar(50)    
    
set @Msg = '<br>Dear Angelite,<br>'    
set @Msg = @Msg+'<P>Thank you for updating your NSE exam preferences. Your unique code is: '+@NcfmCode+'</P>'    
set @Msg = @Msg+'<P>Please save this email as you need to quote this code in any future correspondence.</P>'     
set @Msg = @Msg+'<P>We urge you to avail of our training facilities and our in house online exam modules.</P>'      
set @Msg = @Msg+'<P>Ensure that your result is uploaded within 5 working days of clearing the exam otherwise your salary will be deducted to the extent of the exam fee. </P>'     
set @Msg = @Msg+'<P>For any queries please contact NCFM team at ncfm@angeltrade.com.</P><br>'     
set @Msg = @Msg+'Regards,<br>'    
set @Msg = @Msg+'NCFM team'    
    
Set @Sub = 'NCFM: Your registration is complete Candidate Code: '+@NcfmCode    
    
EXEC intranet.msdb.dbo.sp_send_dbmail                               
@recipients  = @TO,    
@profile_name = 'intranet',                                         
--@from = 'soft@angeltrade.com',                                            
--@cc = @CC,                                         
@body  = @Msg,                                                              
@subject = @Sub,                                                         
@body_format  = 'html'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_New_Branch
-- --------------------------------------------------

Create Proc Usp_New_Branch(@Branchcode as varchar(10),@BranchName as varchar(50),@Type as varchar(10))
as 
set nocount on

insert into tbl_branch_master values(@branchcode,@BranchName,'IT',@Type)
select Fld_Branch_Tag,Fld_Branch_Name from tbl_branch_master

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_New_SBS
-- --------------------------------------------------
CREATE Proc USP_New_SBS(@Fld_Sbs_id int,@Fld_Sbs_name varchar(50),@Fld_SBS_ip as varchar(15),@Fld_Remark as varchar(50))  
as  
  
set nocount on  
  
if (select count(*) from Tbl_SBS_Mast where Fld_Sbs_id = @Fld_Sbs_id) > 0   
begin   	
	
 update Tbl_SBS_Mast set Fld_SBS_ip = @Fld_SBS_ip,Fld_Remark = @Fld_Remark,Fld_SBS_Name = @Fld_SBS_Name
 where Fld_Sbs_id = @Fld_Sbs_id
 select @Fld_Sbs_name + ' Record Updated'  as Mess  
end  
else  
begin  
 insert into Tbl_SBS_Mast values (@Fld_Sbs_name,@Fld_SBS_ip,@Fld_Remark)  
 select 'NEW SBS/MIS UPDATED' as Mess  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_odinchecklist
-- --------------------------------------------------
CREATE proc usp_odinchecklist(@serverid as varchar(5),@date as varchar(11),@branch as varchar(11))      
as      
    
select * from tbl_odin_checklist(nolock) where fld_server_id=@serverid and    
 entrydate=convert(datetime,@date,103)    
  
select * from   
(select * from odinchecklist_procedures(nolock) where flag='A'  )a  
left outer join  
(select procedureid,cutofftime from   tbl_odinchecklist_cutofftime(nolock))b  
on a.fld_id=b.procedureid  
    
select * from v_tbl_server_master(nolock) where fld_id =@serverid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_odinchecklist_report
-- --------------------------------------------------
CREATE proc usp_odinchecklist_report(@serverid as varchar(5),@date as varchar(11),@branch as varchar(25),@type as varchar(11))              
as              
if @serverid='All'            
begin             
set @serverid='%%'            
end            
if @type='Select'            
begin             
set @type=''            
end            
          
select * from tbl_odin_checklist(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)            
and fld_branch_id=@branch   and fld_server_id in      
(select fld_id from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd=@branch            
and fld_server like  '%'+@type+'%')          
    
select * from     
(select * from odinchecklist_procedures(nolock) where flag='A')a    
left outer join    
(select procedureid,cutofftime,replace(replace(cutofftime,'AM',''),' ','') as time from   
 tbl_odinchecklist_cutofftime(nolock) )b    
on a.fld_id=b.procedureid             
    
select * from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd=@branch            
and fld_server like  '%'+@type+'%'   and fld_id in          
(select distinct fld_server_id from tbl_odin_checklist(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)            
and fld_branch_id=@branch  )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_odinchecklist_sbs
-- --------------------------------------------------
CREATE proc usp_odinchecklist_sbs(@serverid as varchar(5),@date as varchar(11),@branch as varchar(11))      
as      
    
select * from tbl_sbschecklist(nolock) where fld_server_id=@serverid and    
 entrydate=convert(datetime,@date,103)    
  
select * from odinchecklist_sbs_procedures(nolock) 

select fld_sbs_id as fld_id,fld_sbs_name as fld_server,fld_sbs_ip as Fld_odin_Ip From V_SBS_Master(nolock) 
where fld_sbs_id =@serverid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_odinchecklist_sbsreport
-- --------------------------------------------------
CREATE proc usp_odinchecklist_sbsreport(@serverid as varchar(5),@date as varchar(11),@branch as varchar(25),@type as varchar(11))              
as              
if @serverid='All'            
begin             
set @serverid='%%'            
end            
if @type='Select'            
begin             
set @type=''            
end            
          
select * from tbl_sbschecklist(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)            
  
select *,replace(replace(replace(cutofftime,'AM',''),'PM',''),':','.') as time  from odinchecklist_sbs_procedures(nolock)           
  
select fld_sbs_id as fld_id,fld_sbs_name as fld_server,fld_sbs_ip as Fld_odin_Ip From V_SBS_Master(nolock)   
where fld_sbs_id  in (select distinct fld_server_id  from tbl_sbschecklist(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103))

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OH_RP
-- --------------------------------------------------
 
	   CREATE PROC  USP_OH_RP  
	   (  
		@FDATE AS VARCHAR(11),        
		@TDATE AS VARCHAR(11),        
		@FLAG AS VARCHAR(5),        
		@EMPNO AS VARCHAR(10),        
		@BRANCH_TAG AS VARCHAR(100)        
	   )        
	   AS        
	   SET NOCOUNT ON     
	   DECLARE @I INT SET @I = 1    
	      
	   SELECT *  
	   INTO #V_OPSSTATUS   
	   FROM V_OPSSTATUS 
	  
	       
		--DECLARE @FLAG AS VARCHAR(5)          
	   SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12')  
	   INTO #TAT   
	   FROM        
	   (SELECT * FROM #V_OPSSTATUS WHERE @I=1 AND  SR_NUM IN       
	   (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND STAT_FLAG LIKE @FLAG)A      
	    LEFT OUTER JOIN  
	    (SELECT * FROM OPHELPDESKTAT)B        
	    ON A.COMPLAINT_ID=B.COMPLAINT_ID AND B.STAT_FLAG LIKE @FLAG        
	           
	           
	   SELECT * INTO #FINAL123   
	   FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO AND @I = 1)  
	   AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103) 
	   AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)        
	   OPTION(OPTIMIZE FOR(@I = '-1') )        
	           
	   SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,  
	   EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL INTO #ADMINFINAL 
	   FROM #FINAL123        
	   WHERE @I=1 AND BRANCH_TAG LIKE @BRANCH_TAG        
	   GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,        
	   EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT ORDER BY COMPLAINT_DATE DESC        
	   OPTION(OPTIMIZE FOR(@I = '-1') )        
	           
	   -- BELOW QUERY USED TO HIGHLIGHT THE FORWARDED MAILS ----------        
	   --        
	   --SELECT X.*,FORWARDED=CASE WHEN Y.SR_NUM IS NULL THEN 'NO' ELSE 'YES' END FROM        
	   --(SELECT * FROM #ADMINFINAL)X        
	   --LEFT OUTER JOIN        
	   --(SELECT * FROM TBL_COMPLAINT WITH (NOLOCK) WHERE SR_NUM IN        
	   --(SELECT MAX(SR_NUM) FROM TBL_COMPLAINT        
	   --WHERE STATUS ='F'AND SOLUTION LIKE 'FORWARDED%' GROUP BY COMPLAINT_ID))Y        
	   --ON X.COMPLAINT_ID=Y.COMPLAINT_ID ORDER BY COMPLAINT_DATE DESC        
	   SELECT * FROM #ADMINFINAL WHERE @I=1 
	   OPTION(OPTIMIZE FOR(@I = '-1') )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OHD_AUTOMAIL
-- --------------------------------------------------
			CREATE PROC USP_OHD_AUTOMAIL      
			AS      
			SET NOCOUNT ON      
    
      
                                               
			IF NOT EXISTS 
						(
									SELECT * FROM MSDB.SYS.SERVICE_QUEUES                                           
									WHERE NAME = N'EXTERNALMAILQUEUE' AND IS_RECEIVE_ENABLED = 1
						)  
            DECLARE @RC VARCHAR(500)                           
			EXEC @RC = MSDB.DBO.SYSMAIL_START_SP       
		


			SELECT * INTO #T2     
			FROM TBL_COMPLAINT 
			WHERE STATUS='C'         
			 
              
            SELECT A.*,B.SUBJECT AS SUBNAME INTO #EMAIL 
			FROM   
					(
						SELECT X.*,Y.EMAIL  FROM     
							(  
								SELECT * FROM #T2 WITH (NOLOCK)
							)X    
						INNER JOIN    
							(
								SELECT * FROM INTRANET.RISK.DBO.EMP_INFO WITH (NOLOCK) 
							)Y    
						ON X.FLD_ENTRYBY=Y.EMP_NO
					) A    
			INNER JOIN   
			TBL_SUBJECT B WITH (NOLOCK)  
			ON A.SR_NUM=B.SUBJECT

			DECLARE @MESS VARCHAR(5000),
					@SUB VARCHAR(100),  
					@REQID VARCHAR(100),
					@EMAIL varchar(200)  
					  
			SELECT @REQID=COMPLAINT_ID,@EMAIL=EMAIL,@SUB=SUBJECT  
			FROM #EMAIL
			WHERE STATUS='C'     

			SET @MESS='<BR><BR><BR>                                                                        
			               
								  THE REQUEST'+ @REQID +'HAS BEEN RESOLVED.  
			                                                                                                
			                                                                                  
			THIS IS A SYSTEM GENERATED MESSAGE.                                                              
			<BR>                                                                              
			<BR>'            

			PRINT @MESS                                                                                                                 
			EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                      
			@RECIPIENTS ='RUTVIJ.PATIL@ANGELTRADE.COM',      
			@BLIND_COPY_RECIPIENTS='',     
			@PROFILE_NAME = 'OperationHelpdesk ',                        
			@BODY_FORMAT ='HTML',                                                                                            
			@SUBJECT =@SUB ,                                                                      
			@FILE_ATTACHMENTS ='',                                                                                                      
			@BODY =@MESS                             
            
			SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OHD_AUTOMAIL_new
-- --------------------------------------------------
CREATE PROCEDURE  USP_OHD_AUTOMAIL_NEW --'E314136','SOFTWARE PROBLEM'          
          
    ( @ComplaintId varchar(15),          
      @Subject     varchar(100)          
    )              
    AS              
    BEGIN              
          
        select Fld_EntryBy into #Email5          
  from tbl_complaint           
  where Complaint_Id = @ComplaintId          
          
   select EMAIL  into #EMAIL6          
   from INTRANET.RISK.DBO.EMP_INFO a , #Email5 b          
   where a.emp_no = b.fld_entryBy          
                
              
              
     DECLARE   @CID VARCHAR(100),  --PURPOSE- @CID IS USED FOR COMPLAIN ID               
      @SUB VARCHAR(100),  --PERPOSE- @SUB IS USED FOR SUBJECT              
      @EMAIL VARCHAR(50),  --PURPOSE- @EMAIL IS USED FOR EMAILID               
      @MESS VARCHAR(4000)  --PURPOSE- @MESS IS USED FOR MESSAGE                
              
     SET       @CID=@ComplaintId          
     SET       @SUB=@Subject          
               
     select  @EMAIL=EMAIL from #EMAIL6                
              
              
     SET @MESS='<BR><BR>    
     
  Dear Sir/Madam,       
                                                                                   
  <BR><BR>            
               
  The request  '+ @CID +' has been resolved.    
    
  <BR><BR>     
             
                                                                                                                   
  This is a System Generated Message.                                                                            
     <BR>                                                                                            
     <BR>'                
                                   
                                  
     EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                                    
     @RECIPIENTS = @EMAIL,                    
     @BLIND_COPY_RECIPIENTS='',              
     @PROFILE_NAME = 'OPERATIONHELPDESK' ,                                     
     @BODY_FORMAT ='HTML',                                                                                                          
     @SUBJECT =@SUB ,                                                                                    
     @FILE_ATTACHMENTS ='',                                                                                                                    
     @BODY =@MESS                    
              
              
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OHD_AUTOMAIL_reply
-- --------------------------------------------------
 CREATE PROCEDURE  USP_OHD_AUTOMAIL_reply(@compid varchar(10))    
   AS    
  
   BEGIN    
  
   DECLARE @SRNO AS INT  
   SELECT @SRNO=MAX(SR_NUM) FROM TBL_COMPLAINT WHERE COMPLAINT_ID='@comid'  
   SELECT SR_NUM,COMPLAINT_ID,SUBJECT,FLD_ENTRYBY INTO #EMAIL     
   FROM TBL_COMPLAINT     
   WHERE SR_NUM=@SRNO  
  
   SELECT X.*,Y.EMAIL INTO #EMAIL1     
   FROM    
   (      
   SELECT X.*,Y.SUBJECT AS SUBNAME     
   FROM #EMAIL X    
   INNER JOIN TBL_SUBJECT Y    
   ON X.SUBJECT=Y.SRNO    
   ) X      
    INNER JOIN INTRANET.RISK.DBO.EMP_INFO Y WITH(NOLOCK)    
    ON X.FLD_ENTRYBY=Y.EMP_NO   
  
  
   DECLARE @CID VARCHAR(100),  --PURPOSE- @CID IS USED FOR COMPLAIN ID     
   @SUB VARCHAR(100),  --PERPOSE- @SUB IS USED FOR SUBJECT    
   @EMAIL VARCHAR(50),  --PURPOSE- @EMAIL IS USED FOR EMAILID     
   @MESS VARCHAR(4000)  --PURPOSE- @MESS IS USED FOR MESSAGE      
  
    SELECT @CID=COMPLAINT_ID,@SUB=SUBNAME,@EMAIL=EMAIL     
    FROM #EMAIL1    
  
    SET @MESS='<BR><BR><BR>                                                                            
                       
     The request '+ @CID +' has been resolved.  <BR><BR><BR>    
                                                                                                        
                                                                                          
    This is a system generated message.                                                                  
    <BR>                                                                                  
    <BR>'      
                        
                       
    EXEC MSDB.DBO.SP_SEND_DBMAIL                                                                                          
    @RECIPIENTS ='ROOPALI.PANDEY@ANGELTRADE.COM',          
    @BLIND_COPY_RECIPIENTS='',         
    @PROFILE_NAME = 'OPERATIONHELPDESK ',                            
    @BODY_FORMAT ='HTML',                                                                                                
--    @SUBJECT =@SUB ,    
    @SUBJECT ='HJKHBJ' ,                                                                         
    @FILE_ATTACHMENTS ='',                                                                                                          
    @BODY =@MESS          
  
  
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_OP_AttachCheck
-- --------------------------------------------------
 CREATE procedure Usp_OP_AttachCheck  --'E314130'
 (   
    @id as varchar(15)  
 )  
 as  
 select distinct Attachment from tbl_complaint where complaint_id = @id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_OP_Attachment
-- --------------------------------------------------
CREATE proc Usp_OP_Attachment
as
select * from tbl_complaint  where attachment <>''and Complaint_id like 'E31413%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_CHK_SOLUTION_EXIST
-- --------------------------------------------------
  
/******************************************************************************                
CREATED BY: SHIVA L           
DATE: 21/10/2010         
PURPOSE: USE TO CHECK WHETHER SOLUTION EXIST FOR FWD EMAIL  
   IN OPERATION HELPDESK  
                
MODIFIED BY: PROGRAMMER NAME                
DATED: DD/MM/YYYY                
REASON: REASON TO CHANGE STORE PROCEDURE                
******************************************************************************/   

CREATE PROCEDURE USP_OP_CHK_SOLUTION_EXIST
  
	 @COMPLAINT_ID VARCHAR(50) -- USE TO STORE COMPLAINT ID   
 
AS  
BEGIN  
  
	SELECT * FROM TBL_COMPLAINT WHERE COMPLAINT_ID = @COMPLAINT_ID AND SOLUTION = ''

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_Complaint_id_InboxTAT
-- --------------------------------------------------
CREATE ProC USP_OP_Complaint_id_InboxTAT --'E2553352','E02031'                       
(                        
@Complaintid as varchar(25),      
@empno as varchar(15)                   
)                        
as                        
begin 
  
select a.*,OpTAT=isnull(b.OpTAT,'<48 Hr'),TAT=isnull(b.TAT,'12') into #tat from                                 
(select * from V_OpsStatus where sr_num in                 
(select max_srno from V_OP_Complaintid_serailno(nolock))and complaint_id=@Complaintid)a                                
left outer join                                
 (select * from OphelpdeskTAT)b                                 
on a.Complaint_id=b.Complaint_id                      
           
                  

  
  
select * into #final123                                
from #tat where dept_id in (select fld_deptid from tbl_dept_mapping where fld_empID=@empno)                                
            

select Convert(varchar(17),Complaint_date,113)Complaint_date,a.Complaint_id,Fld_Query,Stat_Flag,status,                                
Emp_name,Branch_Tag,subject,DEPT_NAME,fld_entryby,sr_num,OpTAT,max(TAT)TAT,clt_subdetl, forwarded = case when b.complaint_id is null then 'N'
                              else 'Y' end 
from #final123 a      
left join
(select distinct complaint_id  from tbl_complaint (nolock) WHERE STATUS ='F') b
on a.complaint_id = b.complaint_id               
group by a.Complaint_id,complaint_date,Fld_Query,Stat_Flag,status,                                
Emp_name,Branch_Tag,subject,DEPT_NAME,fld_entryby,sr_num,clt_subdetl,OpTAT,b.complaint_id  order by complaint_date desc 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_Complaint_id_InboxTAT_client
-- --------------------------------------------------
CREATE PROC USP_OP_COMPLAINT_ID_INBOXTAT_CLIENT  --'AKP','E31413'                                
(                                  
	@COMPLAINTID AS VARCHAR(25),                
	@EMPNO AS VARCHAR(15)                             
)                                                              
AS                                  
                                                                                                              
BEGIN
                              
SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM                                   
(SELECT * FROM V_OPSSTATUS WHERE SR_NUM IN                   
(SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND CLT_SUBDETL LIKE '%'+@COMPLAINTID+'%')A                                  
LEFT OUTER JOIN                                  
 (SELECT * FROM OPHELPDESKTAT)B                                   
ON A.COMPLAINT_ID=B.COMPLAINT_ID                               
                     
                            
SELECT * INTO #FINAL123                                  
FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)                                  
                         
                           

SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,A.COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,                                
EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL, FORWARDED = CASE WHEN B.COMPLAINT_ID IS NULL THEN 'N'
                              ELSE 'Y' END 
FROM #FINAL123 A      
LEFT JOIN
(SELECT DISTINCT COMPLAINT_ID  FROM TBL_COMPLAINT (NOLOCK) WHERE STATUS ='F') B
ON A.COMPLAINT_ID = B.COMPLAINT_ID               
GROUP BY A.COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,                                
EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT,B.COMPLAINT_ID  ORDER BY COMPLAINT_DATE DESC 

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_Complaint_id_Subjectwise
-- --------------------------------------------------
    
    
 CREATE PROC USP_OP_COMPLAINT_ID_SUBJECTWISE  --'ECN','E31413'                            
(                                
@SUBJECT AS VARCHAR(25),              
@EMPNO AS VARCHAR(15)                           
)      
AS                                
set nocount on     
      
SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM                                         
(SELECT * FROM V_OPSSTATUS WHERE SR_NUM IN                         
(SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND SUBJECT LIKE '%'+RTRIM(@SUBJECT)+'%')A                                        
LEFT OUTER JOIN                                        
(SELECT * FROM OPHELPDESKTAT)B                                         
ON A.COMPLAINT_ID=B.COMPLAINT_ID                              
                            
      
SELECT * INTO #FINAL123                                        
FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)                                        
                
SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,A.COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,                                
EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL, FORWARDED = CASE WHEN B.COMPLAINT_ID IS NULL THEN 'N'
                              ELSE 'Y' END 
FROM #FINAL123 A      
LEFT JOIN
(SELECT DISTINCT COMPLAINT_ID  FROM TBL_COMPLAINT (NOLOCK) WHERE STATUS ='F') B
ON A.COMPLAINT_ID = B.COMPLAINT_ID               
GROUP BY A.COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,                                
EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT,B.COMPLAINT_ID  ORDER BY COMPLAINT_DATE DESC 

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_FORWARD_CHECK
-- --------------------------------------------------
/******************************************************************************                  
CREATED BY: SHIVAKUMAR LAKKAMPELLI             
DATE: 29/10/2010           
PURPOSE: USE TO CHECK WHETHER REQUEST FORWARDED OR NOT     
   IN OPERATION HELPDESK    
                  
MODIFIED BY: PROGRAMMER NAME                  
DATED: DD/MM/YYYY                  
REASON: REASON TO CHANGE STORE PROCEDURE                  
******************************************************************************/  
CREATE PROC USP_OP_FORWARD_CHECK  --'E3267687'
(  
  @COMPLAINT_ID VARCHAR(9)   
)  
AS  
SELECT  
       CASE WHEN MAX(SR_NUM) IS NULL THEN 'NO'  
            ELSE 'YES'
       END  AS FORWARD 
FROM  TBL_COMPLAINT   
WHERE STATUS ='F'AND COMPLAINT_ID = @COMPLAINT_ID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_OP_ForwardConfirm
-- --------------------------------------------------

create procedure Usp_OP_ForwardConfirm
as
select  complaint_Id , Forward = case 
					 when max(sr_num) is null then 'NO'
							  
                     else
                          'YES'
                     end
--into #table
from  tbl_complaint 
where status ='f'and solution like 'forwarded%' group by complaint_id
order by Complaint_Id desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_OP_ForwardConfirm2
-- --------------------------------------------------
CREATE proc Usp_OP_ForwardConfirm2 -- 'E3267684'
(  
  @complaint_Id varchar(9)   
)  
as  
select  
       case when max(sr_num) is null then 'NO'  
            else 'YES'
       end  as Forward 
from  tbl_complaint   
where status ='f'and complaint_Id = @complaint_Id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_OP_GridviewFill
-- --------------------------------------------------
CREATE proc Usp_OP_GridviewFill
as
begin
select Fld_Srno,Fld_Query from query_type24 where dummy1 ='n'
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_InboxTAT
-- --------------------------------------------------
CREATE PROC USP_OP_INBOXTAT --'01/11/2010','16/11/2010','%','E31413','CSO'          
  (          
  @FDATE AS VARCHAR(11),          
  @TDATE AS VARCHAR(11),          
  @FLAG AS VARCHAR(5),          
  @EMPNO AS VARCHAR(10),          
  @BRANCH_TAG AS VARCHAR(100)          
  )          
  AS          
  SET NOCOUNT ON          
            
  --SELECT * INTO #V_OPSSTATUS FROM V_OPSSTATUS_NEW      
      
  /*          
  SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM          
  (SELECT * FROM #V_OPSSTATUS WHERE SR_NUM IN          
  (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND STAT_FLAG LIKE @FLAG)A          
  LEFT OUTER JOIN          
  (SELECT * FROM OPHELPDESKTAT)B          
  ON A.COMPLAINT_ID=B.COMPLAINT_ID AND B.STAT_FLAG LIKE @FLAG          
            
            
  SELECT * INTO #FINAL123          
  FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)          
  AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103)          
  AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)          
            
            
  SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,          
  EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL INTO #ADMINFINAL FROM #FINAL123          
  WHERE BRANCH_TAG LIKE @BRANCH_TAG          
  GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,          
  EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT ORDER BY COMPLAINT_DATE DESC          
            
            
  -- BELOW QUERY USED TO HIGHLIGHT THE FORWARDED MAILS ----------          
  --          
  --SELECT X.*,FORWARDED=CASE WHEN Y.SR_NUM IS NULL THEN 'NO' ELSE 'YES' END FROM          
  --(SELECT * FROM #ADMINFINAL)X          
  --LEFT OUTER JOIN          
  --(SELECT * FROM TBL_COMPLAINT WITH (NOLOCK) WHERE SR_NUM IN          
  --(SELECT MAX(SR_NUM) FROM TBL_COMPLAINT          
  --WHERE STATUS ='F'AND SOLUTION LIKE 'FORWARDED%' GROUP BY COMPLAINT_ID))Y          
  --ON X.COMPLAINT_ID=Y.COMPLAINT_ID ORDER BY COMPLAINT_DATE DESC          
  SELECT a.*,Forwarded = case when b.complaint_id is null then 'N'    
                              else 'Y' end     
  FROM #ADMINFINAL  a    
  left join     
  (select distinct complaint_id  from tbl_complaint (nolock) WHERE STATUS ='F') b    
  on a.complaint_id = b.complaint_id order by Complaint_Date desc*/
  
  /*
  
  SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM          
  (SELECT * FROM #V_OPSSTATUS WHERE SR_NUM IN          
  (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND STAT_FLAG LIKE @FLAG)A          
  LEFT OUTER JOIN          
  (SELECT * FROM OPHELPDESKTAT)B          
  ON A.COMPLAINT_ID=B.COMPLAINT_ID AND B.STAT_FLAG LIKE @FLAG          
            
            
  SELECT * INTO #FINAL123          
  FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)          
  AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103)          
  AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)          
            
            
  SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,          
  BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL INTO #ADMINFINAL FROM #FINAL123          
  WHERE BRANCH_TAG LIKE @BRANCH_TAG          
  GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,          
  BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT ORDER BY COMPLAINT_DATE DESC          
            
            
  -- BELOW QUERY USED TO HIGHLIGHT THE FORWARDED MAILS ----------          
  --          
  --SELECT X.*,FORWARDED=CASE WHEN Y.SR_NUM IS NULL THEN 'NO' ELSE 'YES' END FROM          
  --(SELECT * FROM #ADMINFINAL)X          
  --LEFT OUTER JOIN          
  --(SELECT * FROM TBL_COMPLAINT WITH (NOLOCK) WHERE SR_NUM IN          
  --(SELECT MAX(SR_NUM) FROM TBL_COMPLAINT          
  --WHERE STATUS ='F'AND SOLUTION LIKE 'FORWARDED%' GROUP BY COMPLAINT_ID))Y          
  --ON X.COMPLAINT_ID=Y.COMPLAINT_ID ORDER BY COMPLAINT_DATE DESC          
  SELECT a.*,Forwarded = case when b.complaint_id is null then 'N'    
                              else 'Y' end     
  FROM #ADMINFINAL  a    
  left join     
  (select distinct complaint_id  from tbl_complaint (nolock) WHERE STATUS ='F') b    
  on a.complaint_id = b.complaint_id order by Complaint_Date desc
*/

  SELECT * INTO #V_OPSSTATUS FROM V_OPSSTATUS_NEW x (nolock) WHERE EXISTS 
  (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO y (NOLOCK) where x.SR_NUM=y.MAX_SRNO) and          
   DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING (nolock) WHERE FLD_EMPID=@EMPNO)          
  AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103)          
  AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)  
            
  SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM          
  #V_OPSSTATUS A          
  LEFT OUTER JOIN          
  (SELECT * FROM OPHELPDESKTAT)B          
  ON A.COMPLAINT_ID=B.COMPLAINT_ID AND B.STAT_FLAG LIKE @FLAG          
            
            
 -- SELECT * INTO #FINAL123  FROM #TAT 
  --WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)          
  --AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103)          
  --AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)          
            
            
  SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,          
  BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL INTO #ADMINFINAL FROM #TAT          
  WHERE BRANCH_TAG LIKE @BRANCH_TAG          
  GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,          
  BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT ORDER BY COMPLAINT_DATE DESC          
            
            
  -- BELOW QUERY USED TO HIGHLIGHT THE FORWARDED MAILS ----------          
  --          
  --SELECT X.*,FORWARDED=CASE WHEN Y.SR_NUM IS NULL THEN 'NO' ELSE 'YES' END FROM          
  --(SELECT * FROM #ADMINFINAL)X          
  --LEFT OUTER JOIN          
  --(SELECT * FROM TBL_COMPLAINT WITH (NOLOCK) WHERE SR_NUM IN          
  --(SELECT MAX(SR_NUM) FROM TBL_COMPLAINT          
  --WHERE STATUS ='F'AND SOLUTION LIKE 'FORWARDED%' GROUP BY COMPLAINT_ID))Y          
  --ON X.COMPLAINT_ID=Y.COMPLAINT_ID ORDER BY COMPLAINT_DATE DESC          
  SELECT a.*,Forwarded = case when b.complaint_id is null then 'N'    
                              else 'Y' end     
  FROM #ADMINFINAL  a    
  left join     
  (select distinct complaint_id  from tbl_complaint (nolock) WHERE STATUS ='F') b    
  on a.complaint_id = b.complaint_id order by Complaint_Date desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_INBOXTAT_complaintid
-- --------------------------------------------------
CREATE PROC USP_OP_INBOXTAT_complaintid --'01/11/2010','16/11/2010','%','E31413','CSO'      
  (      
  @FDATE AS VARCHAR(11),      
  @TDATE AS VARCHAR(11),      
  @FLAG AS VARCHAR(5),      
  @EMPNO AS VARCHAR(10),      
  @BRANCH_TAG AS VARCHAR(100)      
  )      
  AS      
  SET NOCOUNT ON      
        
  SELECT * INTO #V_OPSSTATUS FROM V_OPSSTATUS      
        
  SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM      
  (SELECT * FROM #V_OPSSTATUS WHERE SR_NUM IN      
  (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND STAT_FLAG LIKE @FLAG)A      
  LEFT OUTER JOIN      
  (SELECT * FROM OPHELPDESKTAT)B      
  ON A.COMPLAINT_ID=B.COMPLAINT_ID AND B.STAT_FLAG LIKE @FLAG      
        
        
  SELECT * INTO #FINAL123      
  FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)      
  AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103)      
  AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)      
        
        
  SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,      
  EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL INTO #ADMINFINAL FROM #FINAL123      
  WHERE BRANCH_TAG LIKE @BRANCH_TAG      
  GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,      
  EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT ORDER BY COMPLAINT_DATE DESC      
        
        
   
  SELECT complaint_id FROM #ADMINFINAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_InboxTAT_dummy
-- --------------------------------------------------
CREATE ProC USP_OP_InboxTAT_dummy --'20/02/2010','12/04/2010','p','e02031','%%'                      
(                      
@fdate as varchar(11),                      
@tdate as varchar(11),                      
@flag as varchar(5),                      
@empno as varchar(10),                  
@Branch_Tag as varchar(100)                  
)                      
AS     
               
select a.*,isnull(b.TAT,'12')TAT, isnull(b.optat,'< 24Hr')optat into #tat 
from                       
(select * from V_OpsStatus where sr_num in       
(select max_srno from V_OP_Complaintid_serailno(nolock))and stat_flag like @flag)a                      
left outer join                      
 (select * from OphelpdeskTAT)b                       
on a.Complaint_id=b.Complaint_id and b.stat_flag like @flag                    
                      
select * into #final123                      
from #tat where dept_id in (select fld_deptid from tbl_dept_mapping where fld_empID=@empno)                      
and stat_flag like @flag and convert(char(11),Complaint_Date) >= convert(datetime,@fdate,103)      
 and convert(char(11),Complaint_Date) <= convert(datetime,@tdate,103)                     
      
       
select Convert(varchar(17),Complaint_date,113)Complaint_date,Complaint_id,Fld_Query,Stat_Flag,status,                      
Emp_name,Branch_Tag,subject,DEPT_NAME,fld_entryby,sr_num,max(TAT)TAT,clt_subdetl,optat from #final123   
--where Branch_Tag like @Branch_Tag              
group by Complaint_id,complaint_date,Fld_Query,Stat_Flag,status,                      
Emp_name,Branch_Tag,optat,subject,DEPT_NAME,fld_entryby,sr_num,clt_subdetl 
order by complaint_date desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_InboxTAT1
-- --------------------------------------------------
CREATE ProC USP_OP_InboxTAT1    
(      
@fdate as varchar(11),      
@tdate as varchar(11),      
@flag as varchar(5),      
@empno as varchar(10)      
)      
    
 as      
     
/*declare @fdate as varchar(11),@tdate as varchar(11)      
set @fdate='20/02/2010'      
set @tdate='21/02/2010' */    
set @fdate =convert(datetime,@fdate,103)        
set @tdate =convert(datetime,@tdate,103)      
select complaint_id,max(sr_num) sr_num into #tt     
from tbl_complaint(nolock) where complaint_date>=@fdate        
and complaint_date<=@tdate+' 23:59:59' group by complaint_id       
    
create table #Complaint_ComplaintNSolution    
(sr_num int,Complaint_Id varchar(15),status varchar(10),Complaint_Date datetime,    
solution_date datetime,cdays int,sdays int)    
    
insert into #Complaint_ComplaintNSolution     
select sr_num,Complaint_Id,status,Complaint_Date      
,Solution_date=case when Solution_date is NULL then getdate() else Solution_date end,cdays=0,sdays=0        
from tbl_complaint(nolock) where sr_num in    
(select sr_num from #tt)    
      
--drop table #Complaint_ComplaintNSolution      
    
declare @Complaint_Id varchar(25),@rec int,@cdate varchar(25),@sdate varchar(25),@daysS int,    
@srnum int ,@status varchar(5)       
DECLARE OPTAT_cursor CURSOR FOR                                                                                 
select Complaint_Id,status,sr_num from #Complaint_ComplaintNSolution                                                                                                                                   
OPEN OPTAT_cursor                                                                                                                                                 
FETCH NEXT FROM OPTAT_cursor                                                                                                                                                                     
INTO @Complaint_Id,@status,@srnum                                     
WHILE @@FETCH_STATUS = 0                                                                                                                               
BEGIN                                                                               
                                                                                                                                                                               
if @status ='BC'                                                                                  
BEGIN        
delete from #Complaint_ComplaintNSolution where complaint_id=@Complaint_Id  
    
insert into #Complaint_ComplaintNSolution    
select sr_num=0,Complaint_Id,status='',Complaint_Date=min(Complaint_Date),Solution_date=max(case when Solution_date is NULL then getdate() else Solution_date end),    
cdays=datediff(dd,min(Complaint_Date),max(case when Solution_date is NULL then getdate() else Solution_date end))+1,      
sdays=datediff(dd,min(Complaint_Date),max(case when Solution_date is NULL then getdate() else Solution_date end))    
from tbl_complaint  where Complaint_Id=@Complaint_Id group by Complaint_Id    
end      
else    
begin    
update #Complaint_ComplaintNSolution set    
cdays=datediff(dd,Complaint_Date,Solution_date)+1,      
sdays=datediff(dd,Complaint_Date,Solution_date)    
from #Complaint_ComplaintNSolution  where Complaint_Id= @Complaint_Id    
    
end      
    
select @cdate=Convert(varchar(11),Complaint_Date,103),@sdate=Convert(varchar(11),Solution_date,103) from  #Complaint_ComplaintNSolution  where Complaint_Id=@Complaint_Id       
select @daysS=COUNT(TDATE) from mis.helpdesk.dbo.op_sett_mst where tdate>=Convert(datetime,@cdate,103) and tdate<=Convert(datetime,@sdate,103)        
update #Complaint_ComplaintNSolution set sdays=@daysS where Complaint_Id=@Complaint_Id       
               
    
FETCH NEXT FROM OPTAT_cursor                                                                                                                                       
INTO @Complaint_Id,@status,@srnum                                                                        
END                                                                                 
CLOSE OPTAT_cursor                                                                                                                                                        
DEALLOCATE OPTAT_cursor          
      
select Complaint_Id,Complaint_Date,Solution_date,cdays,sdays,Diff= case when sdays=0 then 0 else cdays-sdays end,    
TAT=datediff(hh,Complaint_date,Solution_date)-((case when sdays=0 then 0 else cdays-sdays end)*24) into #Complaint_ComplaintNSolution2       
from #Complaint_ComplaintNSolution   
    
select a.*,b.TAT into #tat from     
(select * from V_OpsStatus_dummy where sr_num in (select max_srno from V_OP_Complaintid_serailno(nolock)))a    
inner join    
 (select * from #Complaint_ComplaintNSolution2)b     
on a.Complaint_id=b.Complaint_id     
    
select * into #final123    
from #tat where dept_id in (select fld_deptid from tbl_dept_mapping where fld_empID=@empno)    
and stat_flag like @flag order by Complaint_date    
    
    
select Convert(varchar(17),Complaint_date,113)Complaint_date,Complaint_id,Fld_Query,Stat_Flag,status,    
Emp_name,Branch_Tag,subject,DEPT_NAME,fld_entryby,sr_num,TAT from #final123

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_Remainder_Mail
-- --------------------------------------------------
CREATE proc USP_OP_Remainder_Mail            
--(@complaint varchar(20))            
as             
--select distinct email from  --intranet.risk.dbo.emp_info where emp_no='E19323'    
--(select fld_empid from              
--(select dept_id from tbl_complaint where complaint_id = @complaint) a    
--inner join    
--(select * from tbl_dept_mapping where flag='Y') b    
--on a.dept_id = b.fld_deptid ) c inner join intranet.risk.dbo.emp_info d    
--on c.fld_empid = d.emp_no

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_SEARCH_SUBJECT
-- --------------------------------------------------
/******************************************************************************
CREATED BY: Shivakumar Lakkampelli
DATE: 25/11/2010
PURPOSE: Search complaint by Subject Name
MODIFIED BY: PROGRAMMER NAME
DATED: DD/MM/YYYY
REASON: REASON TO CHANGE STORE PROCEDURE
******************************************************************************/

  
CREATE PROCEDURE  USP_OP_SEARCH_SUBJECT                               
(                                
	@SUBJECT AS VARCHAR(200),              
	@EMPNO AS VARCHAR(15)                           
)
AS

	SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') 
	INTO #TAT 
	FROM (SELECT * FROM V_OPSSTATUS WHERE SR_NUM IN                 
	     (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND SUBJECT LIKE '%'+@SUBJECT+'%')A                                
	LEFT OUTER JOIN                                
	     (SELECT * FROM OPHELPDESKTAT)B                                 
	ON A.COMPLAINT_ID=B.COMPLAINT_ID                             
	                   
	                          
	SELECT * INTO #FINAL123                                
	FROM #TAT 
	WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)                                
	                       
	                
	                     
	SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,                                
	       EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL 
    FROM #FINAL123 --WHERE STAT_FLAG='P'                     
	GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,                                
	         EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT  
	ORDER BY COMPLAINT_DATE DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_op_selectdata
-- --------------------------------------------------
create proc Usp_op_selectdata
as
Select distinct Branch_Code from branches order by Branch_Code

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OP_test
-- --------------------------------------------------
CREATE PROC USP_OP_test--'01/11/2010','16/11/2010','%','E31413','CSO'            
  (            
  @FDATE AS VARCHAR(11),            
  @TDATE AS VARCHAR(11),            
  @FLAG AS VARCHAR(5),            
  @EMPNO AS VARCHAR(10),            
  @BRANCH_TAG AS VARCHAR(100)            
  )            
  AS            
  SET NOCOUNT ON            
              
  SELECT * INTO #V_OPSSTATUS FROM V_OPSSTATUS_NEW        
        
  /*            
  SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM            
  (SELECT * FROM #V_OPSSTATUS WHERE SR_NUM IN            
  (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND STAT_FLAG LIKE @FLAG)A            
  LEFT OUTER JOIN            
  (SELECT * FROM OPHELPDESKTAT)B            
  ON A.COMPLAINT_ID=B.COMPLAINT_ID AND B.STAT_FLAG LIKE @FLAG            
              
              
  SELECT * INTO #FINAL123            
  FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)            
  AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103)            
  AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)            
              
              
  SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,            
  EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL INTO #ADMINFINAL FROM #FINAL123            
  WHERE BRANCH_TAG LIKE @BRANCH_TAG            
  GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,            
  EMP_NAME,BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT ORDER BY COMPLAINT_DATE DESC            
              
              
  -- BELOW QUERY USED TO HIGHLIGHT THE FORWARDED MAILS ----------            
  --            
  --SELECT X.*,FORWARDED=CASE WHEN Y.SR_NUM IS NULL THEN 'NO' ELSE 'YES' END FROM            
  --(SELECT * FROM #ADMINFINAL)X            
  --LEFT OUTER JOIN            
  --(SELECT * FROM TBL_COMPLAINT WITH (NOLOCK) WHERE SR_NUM IN            
  --(SELECT MAX(SR_NUM) FROM TBL_COMPLAINT            
  --WHERE STATUS ='F'AND SOLUTION LIKE 'FORWARDED%' GROUP BY COMPLAINT_ID))Y            
  --ON X.COMPLAINT_ID=Y.COMPLAINT_ID ORDER BY COMPLAINT_DATE DESC            
  SELECT a.*,Forwarded = case when b.complaint_id is null then 'N'      
                              else 'Y' end       
  FROM #ADMINFINAL  a      
  left join       
  (select distinct complaint_id  from tbl_complaint (nolock) WHERE STATUS ='F') b      
  on a.complaint_id = b.complaint_id order by Complaint_Date desc*/  
    
    
    
  SELECT A.*,OPTAT=ISNULL(B.OPTAT,'<48 HR'),TAT=ISNULL(B.TAT,'12') INTO #TAT FROM            
  (SELECT * FROM #V_OPSSTATUS WHERE SR_NUM IN            
  (SELECT MAX_SRNO FROM V_OP_COMPLAINTID_SERAILNO(NOLOCK))AND STAT_FLAG LIKE @FLAG)A            
  LEFT OUTER JOIN            
  (SELECT * FROM OPHELPDESKTAT)B            
  ON A.COMPLAINT_ID=B.COMPLAINT_ID AND B.STAT_FLAG LIKE @FLAG            
              
              
  SELECT * INTO #FINAL123            
  FROM #TAT WHERE DEPT_ID IN (SELECT FLD_DEPTID FROM TBL_DEPT_MAPPING WHERE FLD_EMPID=@EMPNO)            
  AND STAT_FLAG LIKE @FLAG AND CONVERT(CHAR(11),COMPLAINT_DATE) >= CONVERT(DATETIME,@FDATE,103)            
  AND CONVERT(CHAR(11),COMPLAINT_DATE) <= CONVERT(DATETIME,@TDATE,103)            
              
              
  SELECT CONVERT(VARCHAR(17),COMPLAINT_DATE,113)COMPLAINT_DATE,COMPLAINT_ID,FLD_QUERY,STAT_FLAG,STATUS,            
  BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,OPTAT,MAX(TAT)TAT,CLT_SUBDETL INTO #ADMINFINAL FROM #FINAL123            
  WHERE BRANCH_TAG LIKE @BRANCH_TAG            
  GROUP BY COMPLAINT_ID,COMPLAINT_DATE,FLD_QUERY,STAT_FLAG,STATUS,            
  BRANCH_TAG,SUBJECT,DEPT_NAME,FLD_ENTRYBY,SR_NUM,CLT_SUBDETL,OPTAT ORDER BY COMPLAINT_DATE DESC            
              
              
  -- BELOW QUERY USED TO HIGHLIGHT THE FORWARDED MAILS ----------            
  --            
  --SELECT X.*,FORWARDED=CASE WHEN Y.SR_NUM IS NULL THEN 'NO' ELSE 'YES' END FROM            
  --(SELECT * FROM #ADMINFINAL)X            
  --LEFT OUTER JOIN            
  --(SELECT * FROM TBL_COMPLAINT WITH (NOLOCK) WHERE SR_NUM IN            
  --(SELECT MAX(SR_NUM) FROM TBL_COMPLAINT            
  --WHERE STATUS ='F'AND SOLUTION LIKE 'FORWARDED%' GROUP BY COMPLAINT_ID))Y            
  --ON X.COMPLAINT_ID=Y.COMPLAINT_ID ORDER BY COMPLAINT_DATE DESC            
  SELECT a.*,Forwarded = case when b.complaint_id is null then 'N'      
                              else 'Y' end       
  FROM #ADMINFINAL  a      
  left join       
  (select distinct complaint_id  from tbl_complaint (nolock) WHERE STATUS ='F') b      
  on a.complaint_id = b.complaint_id order by Complaint_Date desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_op_yes
-- --------------------------------------------------
CREATE procedure Usp_op_yes
as
select top  1 complaint_Id , Forward = case 
					 when max(sr_num) is null then 'NO'
							  
                     else
                          'YES'
                     end
from  tbl_complaint 
where status ='f'and solution like 'forwarded%' group by complaint_id
order by Complaint_Id desc

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPERATION_AUTOMAIL
-- --------------------------------------------------
   CREATE PROC USP_OPERATION_AUTOMAIL                
AS                
            
/*ESCALTION LEVEL*/                
            
 SELECT ID,DEPARTMENT,ESCALATIONLEVEL,PERSONNAME,                
 EMAIL,LEVEL=SUBSTRING(ESCALATIONLEVEL,CHARINDEX('-',ESCALATIONLEVEL)+1,LEN(ESCALATIONLEVEL))                
 INTO #FILE1                
 FROM INTRANET.MISC.DBO.DEPT_INFO WITH (NOLOCK) WHERE                
 SUBSTRING(ESCALATIONLEVEL,CHARINDEX('-',ESCALATIONLEVEL)+1,LEN(ESCALATIONLEVEL))>=1                
 AND EMAIL IS NOT NULL                
 ORDER BY DEPARTMENT,ESCALATIONLEVEL                
                
             
--SELECT * FROM  #file1                 
-- drop table #file1             
          
            
/*PENDING QUERIES*/                
             
 SELECT STAT_FLAG,OPTAT,TAT,DEPT_ID,B.COMPLAINT_ID,QUERY_TYPE,                
 SUBJECT,COMPLAINT,COMPLAINT_DATE,FLD_ENTRYBY,LEVEL INTO #PENDINGQURIES                
  FROM                 
 (SELECT *,LEVEL=CASE WHEN TAT>24 AND TAT<48 THEN 1            
       WHEN TAT>48 AND TAT<=72 THEN 2                
       WHEN TAT>72 AND TAT<=240 THEN 3             
       WHEN TAT>240 THEN 4 ELSE 0             
     END                
  FROM OPHELPDESKTAT WHERE STAT_FLAG='P' AND                 
                    CONVERT(VARCHAR(11),UPDDATE,103)=CONVERT(VARCHAR(11),GETDATE(),103) /*TAT CALCULATED*/)A                
 INNER JOIN                
 (SELECT Y.* FROM                 
 (SELECT A.* FROM TBL_COMPLAINT A WITH (NOLOCK), V_COMPLAINT_MAXSRNO B WITH (NOLOCK)                
 WHERE A.SR_NUM=B.SR_NUM AND A.STATUS='P'/*PENDING QUERIES MAX  SRNO WITH STATUS STILL PENDING*/)X                
 LEFT OUTER JOIN                
 (SELECT A.* FROM TBL_COMPLAINT A WITH (NOLOCK),V_COMPLAINT_MINSRNO B WITH (NOLOCK)                 
 WHERE A.SR_NUM=B.SR_NUM /*PENDING QUERIES MIN  SRNO FOR QUERY RAISED AND DATE*/)Y                
 ON X.COMPLAINT_ID=Y.COMPLAINT_ID)B                
 ON A.COMPLAINT_ID=B.COMPLAINT_ID                
           
           
--SELECT * FROM #PENDINGQURIES                
--DROP TABLE #PENDINGQURIES          
                 
                
 SELECT ID,DEPARTMENT=B.DEPT_NAME,ESCALATIONLEVEL,PERSONNAME,EMAIL,LEVEL,                
   DEPT_ID,DEPT_NAME             
 INTO #ESCALTIONLEVEL            
    FROM #FILE1 A ,DEPARTMENT_MASTER B             
    WHERE A.DEPARTMENT=B.DUMMY5                
                 
 SELECT * FROM #ESCALTIONLEVEL                
             
 UPDATE #ESCALTIONLEVEL SET LEVEL=4 WHERE LEVEL>4                
                 
                                  
 SELECT DISTINCT DEPARTMENT, LEVEL,EMAIL=                                      
     REPLACE(REPLACE(                                      
     ( SELECT REPLACE (EMAIL, ' ', '~') AS [data()]                 
      FROM #ESCALTIONLEVEL X  WHERE X.DEPARTMENT=A.DEPARTMENT AND  X.LEVEL=A.LEVEL                
    FOR XML PATH ('')                                      
     ), ' ', ';'), '~', ' ') INTO #ESC1                                   
     --AS NAMELIST                                      
 FROM #ESCALTIONLEVEL A                   
                 
  --SELECT * FROM #ESC1            
                 
 --SELECT DEPARTMENT,[2],[3],[4] INTO #ESCALTE1                
 -- FROM                 
 --(SELECT DEPARTMENT,LEVEL ,EMAIL FROM  #ESC1)sa                 
 --PIVOT                
 --(MAX(EMAIL)FOR LEVEL IN( [2],[3],[4]) ) AS pvt                
 --                
                 
                
SELECT A.*,B.EMAIL INTO #FINAL_TAT_ESCALTION                 
FROM                 
(  SELECT A.*,B.DEPT_NAME,C.EMP_NAME FROM #PENDINGQURIES A ,            
                                          DEPARTMENT_MASTER B,            
                                          INTRANET.RISK.DBO.EMP_INFO C WITH(NOLOCK)                
 WHERE A.Dept_ID=B.Dept_ID AND A.FLD_ENTRYBY=C.EMP_NO                
       )A                
  JOIN                
(SELECT DEPARTMENT,LEVEL ,EMAIL FROM  #ESC1)B                
ON A.LEVEL=B.LEVEL AND B.DEPARTMENT=A.DEPT_NAME                 
ORDER BY DEPT_NAME,TAT                
---< 48 Hr                
--> 48 Hr                
-->240 Hr                
-->72 Hr                 
                
/**/                
            
-- SELECT * FROM #FINAL_TAT_ESCALTION            
-- DROP TABLE  #FINAL_TAT_ESCALTION               
           
 UPDATE  #FINAL_TAT_ESCALTION SET OPTAT ='>24 Hr' WHERE OPTAT ='< 48 Hr'          
            
DECLARE OPHELPDESK_CURSOR CURSOR FOR                
SELECT DISTINCT EMAIL FROM #FINAL_TAT_ESCALTION                
OPEN OPHELPDESK_CURSOR                
DECLARE @EMAIL AS VARCHAR(1000)           
FETCH NEXT FROM OPHELPDESK_CURSOR                
INTO @EMAIL WHILE @@FETCH_STATUS = 0                
BEGIN                
                
DECLARE @SQL AS VARCHAR(5000)                
DECLARE @S AS VARCHAR(5000)                
DECLARE @S1 AS VARCHAR(5000)                
DECLARE @FILE AS VARCHAR(5000)                
DECLARE @FILE1 AS VARCHAR(500)                
DECLARE @NAME AS VARCHAR(200)                
DECLARE @MESS AS VARCHAR(2000)                
DECLARE @OPTAT AS VARCHAR(2000)                
DECLARE @DEPARTMENT AS VARCHAR(2000)  
DECLARE @CC AS VARCHAR(5000)  
                
                
                
                
SELECT @OPTAT=OPTAT FROM #FINAL_TAT_ESCALTION WHERE EMAIL=@EMAIL                
  
SELECT @DEPARTMENT=DEPT_NAME FROM #FINAL_TAT_ESCALTION WHERE EMAIL=@EMAIL  
                
TRUNCATE TABLE FINAL_TAT_ESCALTION                
                
INSERT INTO FINAL_TAT_ESCALTION                
SELECT DISTINCT COMPLAINTID=COMPLAINT_ID,[RAISED_TO_DEPT]=DEPT_NAME,[RAISED_DATE]=CONVERT(VARCHAR(11),COMPLAINT_DATE,103),                
[RAISED_BY_EMPNM]=EMP_NAME,SUBJECT,[COMPLAINT_DETAILS]=COMPLAINT,[PENDING_SINCE_HOURS]=OPTAT FROM #FINAL_TAT_ESCALTION WHERE EMAIL=@EMAIL                
                 
IF @DEPARTMENT='Software'  
BEGIN  
 SET @CC='RENIL.PILLAI@ANGELTRADE.COM'  
END  
ELSE  
  
BEGIN  
 SET @CC='santanu.syam@angeltrade.com;Anil.Ranka@angeltrade.com;'  
-- SET @CC='SHIVAKUMAR.L@ANGELTRADE.COM'  
END  
  
                
SET @MESS='DEAR SIR/MADAM,<BR><BR>                
KINDLY FIND THE FOLLOWING PENDING QUERIES RELATED TO YOUR PROCESS.                
<BR><BR><BR>                
'                
                
DECLARE @HTMLBODY1 AS NVARCHAR(MAX)                
SET @HTMLBODY1=''               
EXEC DBA_CONVERTQUERYINHTMP_PAGE                
'SELECT * FROM FINAL_TAT_ESCALTION', @HTMLBODY1 OUTPUT                
                
DECLARE @SUB VARCHAR(500)                
SELECT TOP 1 @SUB=RAISED_TO_DEPT FROM TAT                
SET @SUB = 'PENDING QUERY - ['+@OPTAT +']'                
                
                
                
SET @HTMLBODY1=@MESS+@HTMLBODY1+'<BR><BR><BR><BR>AWAITING FOR YOUR PROMPT ACTION ON THIS.<BR><BR>                
YOUR FEEDBACK AND ACTION IS VALUABLE FOR US AND WILL SURELY EXPEDITE ON THE CLOSURE OF THIS QUERY.                
<BR><BR>                
FROM,                
<BR>                
OPERATIONS HELPDESK.<BR><BR> '                
                
                
EXEC MIS.MSDB.DBO.SP_SEND_DBMAIL                
          
@RECIPIENTS =@EMAIL,                
--@RECIPIENTS ='SHIVAKUMAR.L@ANGELTRADE.COM',                
@COPY_RECIPIENTS = @CC,                
--@TO = 'SHIVAKUMAR.L@ANGELTRADE.COM',                
@BLIND_COPY_RECIPIENTS= 'SHIVAKUMAR.L@ANGELTRADE.COM;RENIL.PILLAI@ANGELTRADE.COM;',                
@PROFILE_NAME = 'OPERATIONHELPDESK',                
--@FROM ='OPERATIONHELPDESK@ANGELTRADE.COM',                
@BODY_FORMAT ='HTML',                
@SUBJECT = @SUB,                
--@FILE_ATTACHMENTS =@ATTACH,                
@BODY=@HTMLBODY1                
                
                
FETCH NEXT FROM OPHELPDESK_CURSOR                
INTO @EMAIL                
END                
CLOSE OPHELPDESK_CURSOR                
DEALLOCATE OPHELPDESK_CURSOR                
                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPHELP_MANMIS1
-- --------------------------------------------------
CREATE proc USP_OPHELP_MANMIS1  -- '1/11/2010','24/11/2010','%%','BRMAST','DELHI_10','%%'         
(            
@fdate as varchar(11),            
@tdate as varchar(11),            
@Dept_id as varchar(11),          
@access_to as varchar(11),            
@regcode as varchar(11),    
@brcd as varchar(11)              
)            
as            
SET NOCOUNT ON            
    
declare @CONDITION as varchar(2000)    
declare @STR as varchar(7000)    
    
if @access_to='BROKER'                                                
begin                                                                            
 if @regcode<>'%%' and @brcd='%%'                                                                                    
      SET  @CONDITION='brcd in(Select code from intranet.risk.dbo.region  where reg_Code='''+@regcode+''')'                                                                             
 if @regcode<>'%%' and @brcd<>'%%'                                                                                     
    SET   @CONDITION='brcd='''+@brcd+''' '                                                                                  
 if @regcode='%%'                                                                                   
    SET   @CONDITION='brcd like '''+@brcd+''' '                                                                            
end    
    
if @access_to='REGION'                                                
begin       
 if @brcd='%%'                                                                                    
       SET  @CONDITION='brcd in(Select code from intranet.risk.dbo.region  where reg_Code='''+@regcode+''')'                                                                          
 if @brcd<>'%%'                                                                                     
       SET   @CONDITION='brcd='''+@brcd+''''                                                                        
end       
                                 
if @access_to='BRMAST'                                                
begin     
 if @brcd='%%'                                           
  --SET  @CONDITION='brcd in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@brcd+''')'                                                                         
  
   SET  @CONDITION='brcd in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd like '''+@brcd+''')'                                                                         
 if @brcd<>'%%'                                                                                     
  SET   @CONDITION='brcd='''+@brcd+''''         
end      
                                                                                                                
if @access_to='BRANCH'                                                
SET  @CONDITION='brcd='''+@brcd+''''    
    
set @fdate=convert(datetime,@fdate,103)    
set @tdate=convert(datetime,@tdate,103)    
    
set @STR='select a.*,b.brcd into #tt from    
(select  sr_num,complaint_id,dept_id,fld_entryby,status,complaint_date from tbl_complaint(nolock)     
where complaint_date>='''+@fdate+''' and complaint_date<='''+@tdate+''+' 23:59:59'')a    
left outer join    
(select emp_no,brcd=costcode from intranet.risk.dbo.emp_info)b    
on a.fld_entryby=b.emp_no;    
select complaint_id,max(sr_num) sr_num into #t from #tt where '+ @CONDITION +' and dept_id like '''+@Dept_id+''' group by complaint_id;    
    
declare @table as table  (Dept_id varchar(50),Dept_Name varchar(50),Branch_Completed int,CSO_Completed int,In_Process int,Pending int,Hold int) insert into @table select dept_id,Dept_Name,            
Branch_Completed=case when sum(Branch_Completed) is null then 0 else sum(Branch_Completed) end,            
CSO_Completed=case when sum(CSO_Completed) is null then 0 else sum(CSO_Completed) end,            
In_Process=case when sum(In_Process) is null then 0 else sum(In_Process) end,            
Pending=case when sum(Pending) is null then 0 else sum(Pending) end ,    
Hold=case when sum(Hold) is null then 0 else sum(Hold) end             
--TotalCount=sum(TotalCount)            
 from            
(            
select dept_id,Dept_Name,            
[Branch Completed] as Branch_Completed,            
[CSO Completed] as CSO_Completed,            
[In-Process] as In_Process,            
[Pending] as Pending,    
[Hold] as Hold,            
TotalCount=[Branch Completed]+[CSO Completed]+[In-Process]+[Pending]+[Hold] from            
(            
select y.dept_id,Status=            
case             
when status = ''BC'' then ''Branch Completed''            
when status = ''C'' then ''CSO Completed''            
when status in (''F'',''IP'')  then ''In-Process''    
When status =''H'' then ''Hold''            
when status = ''P'' then ''Pending'' end,y.Dept_Name,Total=count(*) from #tt (nolock) x,             
department_master y where x.dept_id = y.dept_id and             
Sr_num in (select Sr_num from #t)          
group by Status,y.Dept_Name,y.dept_id            
)x            
pivot               
(              
max(Total) for Status in              
(            
[Branch Completed],[CSO Completed],[In-Process],[Pending],[HOLD]            
)) as pvt       
)x group by dept_id,Dept_Name  select * from @table'      
     
exec(@STR)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPHELP_MANMIS2
-- --------------------------------------------------
CREATE PROC USP_OPHELP_MANMIS2                
(                
@FDATE AS VARCHAR(11),                
@TDATE AS VARCHAR(11),                     
@ACCESS_TO AS VARCHAR(11),                
@REGCODE AS VARCHAR(11),        
@BRCD AS VARCHAR(11) ,        
@STATUS AS VARCHAR(11),        
@DEPT_ID AS VARCHAR(11)                  
)                
AS                
SET NOCOUNT ON            
      

/*DECLARE @FDATE AS VARCHAR(11),@TDATE AS VARCHAR(11),      
@ACCESS_TO AS VARCHAR(11),@REGCODE AS VARCHAR(11),@BRCD AS VARCHAR(11) ,       
@STATUS AS VARCHAR(11),  @DEPT_ID AS VARCHAR(11)       
      
SET @FDATE = '01/12/2010'      
SET @TDATE = '23/12/2010'      
SET @ACCESS_TO = 'BROKER'      
SET @REGCODE = 'UP'      
SET @BRCD = 'AGRA'      
SET @STATUS = 'BC'      
SET @DEPT_ID =  '6'   */     
       
DECLARE @CONDITION AS VARCHAR(2000)  
DECLARE @CONDITION1 AS VARCHAR(2000)           
DECLARE @STR AS VARCHAR(7000)        
        
IF @ACCESS_TO='BROKER'                                                    
BEGIN                                                                                
 IF @REGCODE<>'%%' AND @BRCD='%%'                                                                                        
      SET  @CONDITION='BRCD IN(SELECT CODE FROM INTRANET.RISK.DBO.REGION  WHERE REG_CODE='''+@REGCODE+''')'                                                                                 
 IF @REGCODE<>'%%' AND @BRCD<>'%%'                                                                                         
    SET   @CONDITION='BRCD='''+@BRCD+''' '                                                                                      
 IF @REGCODE='%%'                                                                                       
    SET   @CONDITION='BRCD LIKE '''+@BRCD+''''  
    SET   @CONDITION1='ACCESS_CODE ='''+@BRCD+''''                                                                        
END        
        
IF @ACCESS_TO='REGION'                                                    
BEGIN           
 IF @BRCD='%%'                                                                                        
       SET  @CONDITION='BRCD IN(SELECT CODE FROM INTRANET.RISK.DBO.REGION  WHERE REG_CODE='''+@REGCODE+''')'                                                                              
 IF @BRCD<>'%%'                                                                                         
       SET   @CONDITION='BRCD='''+@BRCD+''' '
        SET   @CONDITION1='ACCESS_CODE ='''+@BRCD+''''                                                                           
END           
                                     
IF @ACCESS_TO='BRMAST'                                                    
BEGIN         
 IF @BRCD='%%'                                               
  SET  @CONDITION='BRCD IN (SELECT BRANCH_CD FROM INTRANET.RISK.DBO.BRANCH_MASTER  WHERE BRMAST_CD='''+@BRCD+''')'                                                                             
 IF @BRCD<>'%%'                                                                                         
  SET   @CONDITION='BRCD='''+@BRCD+'''' 
         SET   @CONDITION1='ACCESS_CODE ='''+@BRCD+''''                
END          
                                                                                                                    
IF @ACCESS_TO='BRANCH'                                                    
SET  @CONDITION='BRCD='''+@BRCD+''''  
SET   @CONDITION1='ACCESS_CODE ='''+@BRCD+''''  
     
        
SET @FDATE=CONVERT(DATETIME,@FDATE,103)        
SET @TDATE=CONVERT(DATETIME,@TDATE,103)        
        
/*SET @STR='SELECT A.*,B.BRCD INTO #TT FROM        
(SELECT  SR_NUM,COMPLAINT_ID,DEPT_ID,FLD_ENTRYBY,STATUS,COMPLAINT_DATE FROM TBL_COMPLAINT(NOLOCK)         
WHERE COMPLAINT_DATE>='''+@FDATE+''' AND COMPLAINT_DATE<='''+@TDATE+''+' 23:59:59'')A        
LEFT OUTER JOIN        
(SELECT EMP_NO,BRCD=COSTCODE FROM INTRANET.RISK.DBO.EMP_INFO)B        
ON A.FLD_ENTRYBY=B.EMP_NO;        
SELECT COMPLAINT_ID,MAX(SR_NUM) SR_NUM INTO #T FROM #TT WHERE '+ @CONDITION +' AND DEPT_ID LIKE '''+@DEPT_ID+''' GROUP BY COMPLAINT_ID;        
        
SELECT * FROM TBL_COMPLAINT(NOLOCK) WHERE DEPT_ID='''+@DEPT_ID+''' AND REPLACE(STATUS,''F'',''IP'') IN('''+@STATUS+''') AND SR_NUM IN        
(SELECT SR_NUM FROM #T)'    */      
      
SET @STR=      
'SELECT A.*,B.BRCD INTO #TT FROM        
(SELECT  SR_NUM,COMPLAINT_ID,ACCESS_CODE,DEPT_ID,FLD_ENTRYBY,STATUS,COMPLAINT_DATE FROM TBL_COMPLAINT(NOLOCK)         
WHERE COMPLAINT_DATE>='''+@FDATE+''' AND COMPLAINT_DATE<='''+@TDATE+''+' 23:59:59'')A        
LEFT OUTER JOIN        
(SELECT EMP_NO,BRCD=COSTCODE FROM INTRANET.RISK.DBO.EMP_INFO)B        
ON A.FLD_ENTRYBY=B.EMP_NO;        
SELECT COMPLAINT_ID,MAX(SR_NUM) SR_NUM INTO #T FROM #TT WHERE '+ @CONDITION +' AND DEPT_ID LIKE '''+@DEPT_ID+''' GROUP BY COMPLAINT_ID;        
        
SELECT X.*,C.FLD_QUERY FROM      
(      
SELECT A.*,CONVERT(VARCHAR(17),A.COMPLAINT_DATE,113) AS COMPLAINTDATE,B.DEPT_NAME FROM       
(SELECT * FROM TBL_COMPLAINT(NOLOCK) WHERE DEPT_ID ='''+@DEPT_ID+''' AND REPLACE(STATUS,''F'',''IP'') IN('''+@STATUS+''') AND SR_NUM IN        
(SELECT SR_NUM FROM #T)AND '+ @CONDITION1 +')A LEFT OUTER JOIN DEPARTMENT_MASTER B ON A.DEPT_ID = B.DEPT_ID      
)X LEFT OUTER JOIN QUERY_TYPE C ON X.QUERY_TYPE = C.FLD_SRNO      
'       
        
--PRINT @STR              
EXEC(@STR)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPHELPDESK_CLIENTCODE
-- --------------------------------------------------
CREATE PROC USP_OPHELPDESK_CLIENTCODE  
(  
@USER_NAME AS VARCHAR(15) ,
@ACCESS_TO AS VARCHAR(20),
@access_code as varchar(20)
)  
as  
SET NOCOUNT ON 

DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200)                      
--SET @access_to='REGION'                      
--SET @access_code='MAH'                      
if @access_to= 'BRANCH'                                                                
begin                                                     
  SET @CONDITION='branch_cd ='''+@access_code+''''                      
end                                                     
if @access_to='Broker'                                      
begin                             
    SET  @CONDITION='branch_cd like ''%'''                                                                  
end                                                                             
if @access_to='SB'                                      
begin                                
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                  
end                                   
if @access_to='BRMAST'                                      
begin                                
  SET  @CONDITION='branch_cd in (select branch_cd from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                               
end                                                      
if @access_to='SBMAST'                                      
begin                                                         
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                      
end                                                       
if @access_to='REGION'                                      
begin                                
   SET  @CONDITION='branch_cd in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                 
end                           
                       
set @STR='select party_code,long_name from intranet.risk.dbo.client_details with (nolock) where party_code='''+ @USER_NAME +''' and '+@CONDITION+''             
                
exec (@str)    
    
--print @str    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Ophelpdesk_sb
-- --------------------------------------------------
CREATE Procedure USP_Ophelpdesk_sb(@access_to varchar(20),@access_code varchar(20))    
as    
-----------------------------Branchwise Access------------------------------------------------                    
DECLARE @STR AS VARCHAR(5000),@CONDITION AS VARCHAR(200)                          
--SET @access_to='REGION'                          
--SET @access_code='MAH'                          
if @access_to= 'BRANCH'                                                                    
begin                                                         
  SET @CONDITION='branch_code ='''+@access_code+''''                          
end                                                         
if @access_to='Broker'                                          
begin                                 
    SET  @CONDITION='branch_code like ''%'''                                                                      
end                                                                                 
if @access_to='SB'                                          
begin                                    
   SET   @CONDITION='sub_broker='''+@access_code+''' '                                                                      
end                                       
if @access_to='BRMAST'                                          
begin                                    
  SET  @CONDITION='branch_code in (select branch_code from intranet.risk.dbo.branch_master  where brMast_cd='''+@access_code+''')'                                                                   
end                                                          
if @access_to='SBMAST'                                          
begin                                                             
  SET   @CONDITION='sub_broker in (Select sub_Broker from intranet.risk.dbo.sb_master  where sbMast_cd ='''+@access_code+''')'                          
end                                                           
if @access_to='REGION'                                          
begin                                    
   SET  @CONDITION='branch_code in(Select code from intranet.risk.dbo.region  where reg_Code='''+@access_code+''')'                                                                     
end                               
         
    
    
set @STR='select Sub_broker,name from anand1.msajag.dbo.subbrokers with (nolock) where Sub_broker is not null and Sub_broker<>'''' and '+@CONDITION+' order by Sub_broker'                 
    
                 
exec (@STR)        
        
--print @str        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_OPhelpdesk_travelbooking
-- --------------------------------------------------
CREATE proc usp_OPhelpdesk_travelbooking   
(  
@empno as varchar(10)  
)  
as  
select emp_no,emp_name,department,designation,sex,convert(varchar(11),birthdate,113),  
phone,sr_name,company,location,panno,sbu,costcode  
from intranet.risk.dbo.emp_info where emp_no=@empno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPMail
-- --------------------------------------------------
CREATE proc USP_OPMail    
as  
  
select Complaint_Id,Complaint_Date=min(Complaint_Date),    
Solution_date=case when Solution_date is NULL then getdate() else max(Solution_date) end,status                      
into #Complaint_ComplaintNSolution from tbl_complaint(nolock) where status='p'  
group by Complaint_Id,Solution_date,    
status    
  
select Complaint_Id,Complaint_Date,Solution_date,daysC=datediff(dd,Complaint_Date,Solution_date)+1,                    
daysS=datediff(dd,Complaint_Date,Solution_date),status into #Complaint_ComplaintNSolution1                    
 from #Complaint_ComplaintNSolution   
   
declare @Complaint_Id varchar(25),@rec int,@cdate varchar(25),@sdate varchar(25),@daysS int     
   
DECLARE OPTAT_cursor CURSOR FOR                                                                                               
select Complaint_Id from #Complaint_ComplaintNSolution1                    
                                                                                                                                            
                                                                                                                                                           
OPEN OPTAT_cursor                                                                                                                                                               
FETCH NEXT FROM OPTAT_cursor                                                                                                                                                                                   
INTO @Complaint_Id                                                   
WHILE @@FETCH_STATUS = 0                                                                                                                                             
BEGIN                                                                                             
                                                                                                    
                    
select @rec=count(1) from #Complaint_ComplaintNSolution1  where Complaint_Id=@Complaint_Id                                                                                                             
if @rec > 0                                                                                                
 BEGIN                          
select @cdate=Convert(varchar(11),Complaint_Date,103),@sdate=Convert(varchar(11),Solution_date,103)     
from  #Complaint_ComplaintNSolution1  where Complaint_Id=@Complaint_Id                     
                    
 select @daysS=COUNT(TDATE) from sett_mst(NOLOCK) where tdate>=Convert(datetime,@cdate,103) and    
  tdate<=Convert(datetime,@sdate,103)                    
                     
 update #Complaint_ComplaintNSolution1 set daysS=@daysS where Complaint_Id=@Complaint_Id                     
                             
 END                    
 FETCH NEXT FROM OPTAT_cursor                                                                                                                                                     
INTO @Complaint_Id                                                                                               
END                   
CLOSE OPTAT_cursor                                                                                                         
DEALLOCATE OPTAT_cursor   
    
  
 select Complaint_Id,Complaint_Date,Solution_date,daysC,daysS,Diff=daysC-daysS,    
status into #Complaint_ComplaintNSolution2                     
from #Complaint_ComplaintNSolution1                    
                    
select Complaint_Id,Complaint_Date,Solution_date,daysC,daysS,Diff,                    
TAT=datediff(hh,Complaint_date,Solution_date)-(diff*24),status into #final                    
from #Complaint_ComplaintNSolution2     
  
  
select distinct x.complaint_id,Fld_DeptName,Subject,Complaint, TAT,Fld_EmpId into #fin1 from     
#final x inner join tbl_complaint y on x.complaint_id = y.Complaint_Id    
inner join tbl_dept_mapping z on y.dept_id = z.fld_deptid and flag = 'Y' and y.status='p'  
    
select x.*,y.subject as SubName into #fin2 from #fin1 x inner join tbl_subject y on x.subject = y.srno    
    
truncate table tbl_final_mail    
    
    
select x.*,y.senior,z.email as Hr24,a.email as hr48,b.email as hr72,    
'mangesh.wangane@angeltrade.com' as more72 --into #fin    
--c.email as hr72     
--into tbl_final_mail    
into #abcd 
from #fin2 x inner join     
intranet.risk.dbo.emp_info y on x.Fld_EmpId = y.emp_no     
inner join intranet.risk.dbo.emp_info z on y.senior = z.emp_no    
inner join intranet.risk.dbo.emp_info a on z.senior = a.emp_no    
inner join intranet.risk.dbo.emp_info b on a.senior = b.emp_no    
inner join intranet.risk.dbo.emp_info c on b.senior = c.emp_no   
  
 


insert into tbl_final_mail
select distinct complaint_id,fld_deptname,complaint,tat,subname,hr24,hr48,hr72,more72
from #abcd 

update tbl_final_mail set complaint =replace(replace(replace(complaint,'  
',''),',','  '),'

',' ')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPMail_240
-- --------------------------------------------------
CREATE PROC USP_OPMAIL_240                              
AS                          
                   
SELECT DISTINCT COMPLAINTID,[RAISED_TO_DEPT]=CONVERT(VARCHAR(20),[RAISED_TO_DEPT]),                              
[RAISED_DATE]=CONVERT(VARCHAR(11),[RAISED_DATE],103),[RAISED_BY_EMPNM]=CONVERT(VARCHAR(100),[RAISED_BY_EMPNM]),                              
SUBJECT=CONVERT(VARCHAR(1000),SUBJECT),[COMPLAINT_DETAILS]=CONVERT(VARCHAR(1000),[COMPLAINT_DETAILS]),                              
[PENDING_SINCE_HOURS]=CONVERT(VARCHAR(15),[PENDING_SINCE_HOURS]),HR240 INTO #HR240       
FROM AUTOMAIL_TAT WHERE PENDING_SINCE_HOURS>240      
GROUP BY  COMPLAINTID,RAISED_TO_DEPT,RAISED_DATE,RAISED_BY_EMPNM,SUBJECT,COMPLAINT_DETAILS,      
 PENDING_SINCE_HOURS,HR240      
       
              
DECLARE OPHELPDESK_CURSOR CURSOR FOR                         
SELECT DISTINCT  HR240 FROM AUTOMAIL_TAT WHERE [PENDING_SINCE_HOURS]>240                                                                              
OPEN OPHELPDESK_CURSOR                             
DECLARE @EMAIL AS VARCHAR(1000)                                                                           
FETCH NEXT FROM OPHELPDESK_CURSOR                                                                              
INTO @EMAIL                                                                              
WHILE @@FETCH_STATUS = 0                                                           
BEGIN                                                                                                      
                          
DECLARE @SQL AS VARCHAR(5000)                            
DECLARE @S AS VARCHAR(5000)                               
DECLARE @S1 AS VARCHAR(5000)                               
DECLARE @FILE AS VARCHAR(5000)                            
DECLARE @FILE1 AS VARCHAR(500)                          
DECLARE @NAME AS VARCHAR(200)                          
DECLARE @MESS AS VARCHAR(2000)                          
                        
       
--DECLARE OPHELPDESK_CURSOR1 CURSOR FOR                         
--SELECT  DISTINCT RAISED_TO_DEPT FROM AUTOMAIL_TAT                         
--WHERE [PENDING_SINCE_HOURS]>240                          
--AND HR240=@EMAIL                        
--OPEN OPHELPDESK_CURSOR1                             
--DECLARE @DEPT AS VARCHAR(1000)                                                                           
--FETCH NEXT FROM OPHELPDESK_CURSOR1                                                                              
--INTO @DEPT                                                                              
--WHILE @@FETCH_STATUS = 0                                                           
--BEGIN                         
                        
SET @MESS='DEAR SIR/MADAM,<BR><BR>                                                    
KINDLY FIND THE FOLLOWING PENDING QUERIES RELATED TO YOUR PROCESS.                        
<BR><BR><BR>                                              
'                                     
                       
SELECT DISTINCT COMPLAINTID,[RAISED_TO_DEPT],[RAISED_DATE],[RAISED_BY_EMPNM],SUBJECT,                      
[COMPLAINT_DETAILS],[PENDING_SINCE_HOURS]  INTO #TAT1 FROM  #HR240 WHERE [PENDING_SINCE_HOURS]>240                         
AND HR240=@EMAIL   
--AND RAISED_TO_DEPT=@DEPT                        
                                                                    
DECLARE @HTMLBODY1 AS NVARCHAR(MAX)                          
SET @HTMLBODY1=''                          
EXEC DBA_CONVERTQUERYINHTMP_PAGE                           
'SELECT COMPLAINTID,[RAISED_TO_DEPT],[RAISED_DATE],[RAISED_BY_EMPNM],SUBJECT,[COMPLAINT_DETAILS],[PENDING_SINCE_HOURS] FROM  #TAT1', @HTMLBODY1 OUTPUT                            
                        
DECLARE @SUB VARCHAR(500)                        
--SET @SUB = @DEPT+' - PENDING QUERY - [>240 HOURS]'     
SET @SUB = ' PENDING QUERY - [>240 HOURS]'                        
                     
                        
         
                          
SET @HTMLBODY1=@MESS+@HTMLBODY1+'<BR><BR><BR><BR>AWAITING FOR YOUR PROMPT ACTION ON THIS.<BR><BR>                                                    
YOUR FEEDBACK AND ACTION IS VALUABLE FOR US AND WILL SURELY EXPEDITE ON THE CLOSURE OF THIS QUERY.        
<BR><BR>                          
FROM,                          
<BR>                          
OPERATIONS HELPDESK.<BR><BR>  '                          
                        
EXEC MIS.MSDB.DBO.SP_SEND_DBMAIL                                                           
@RECIPIENTS =@EMAIL,                        
--@RECIPIENTS ='ATULB.DIVEKAR@ANGELTRADE.COM',                                                 
--@COPY_RECIPIENTS = 'ATULB.DIVEKAR@ANGELTRADE.COM',                                                
--@TO = 'ATULB.DIVEKAR@ANGELTRADE.COM',                     
@BLIND_COPY_RECIPIENTS= 'SHIVAKUMAR.L@ANGELTRADE.COM;RENIL.PILLAI@ANGELTRADE.COM;MILAND.SHAH@ANGELTRADE.COM',                                                                        
@PROFILE_NAME = 'OPERATIONHELPDESK',                              
--@FROM ='OPERATIONHELPDESK@ANGELTRADE.COM',                                                          
@BODY_FORMAT ='HTML',                                                                   
@SUBJECT = @SUB,                                                      
--@FILE_ATTACHMENTS =@ATTACH,                                                                                                 
@BODY=@HTMLBODY1                          
--FETCH NEXT FROM OPHELPDESK_CURSOR1                                                                    
--INTO @DEPT                                                                           
--END                                           
--CLOSE OPHELPDESK_CURSOR1                          
--DEALLOCATE OPHELPDESK_CURSOR1                        
                        
                         
FETCH NEXT FROM OPHELPDESK_CURSOR                                                                    
INTO @EMAIL                                                                                          
END                                           
CLOSE OPHELPDESK_CURSOR                          
DEALLOCATE OPHELPDESK_CURSOR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPMail_48
-- --------------------------------------------------
CREATE proc USP_OPMail_48                      
as                  
                
DECLARE OPHelpdesk_cursor CURSOR FOR                 
select  distinct hr48 from automail_tat where [Pending_since_Hours]>48 and [Pending_since_Hours]<=72                                                                      
OPEN OPHelpdesk_cursor                     
declare @Email as varchar(1000)                                                                   
FETCH NEXT FROM OPHelpdesk_cursor                                                                      
INTO @Email                                                                      
WHILE @@FETCH_STATUS = 0                                                   
BEGIN                                                                                              
                  
declare @sql as varchar(5000)                    
declare @s as varchar(5000)                       
declare @s1 as varchar(5000)                       
declare @file as varchar(5000)                    
declare @file1 as varchar(500)                  
declare @name as varchar(200)                  
declare @mess as varchar(2000)     
declare @attach as varchar(2000)               
                
                 
--DECLARE OPHelpdesk_cursor1 CURSOR FOR                 
--select  distinct Raised_to_Dept from automail_tat where [Pending_since_Hours]>48 and [Pending_since_Hours]<=72             
--and hr48=@Email                
--OPEN OPHelpdesk_cursor1                     
--declare @dept as varchar(1000)                                                                   
--FETCH NEXT FROM OPHelpdesk_cursor1                                                                      
--INTO @dept                                                                      
--WHILE @@FETCH_STATUS = 0                                                   
--BEGIN                 
                
set @mess='Dear Sir/Madam,<br><br>                                            
Kindly find the following pending queries related to your process.                
<br><br><br>                                      
'        
select distinct ComplaintID,[Raised_to_Dept],[Raised_Date],[Raised_by_EmpNm],Subject,[Complaint_Details],[Pending_since_Hours] into tat from  automail_tat where [Pending_since_Hours]>48 and [Pending_since_Hours]<=72                 
 and hr48<>'Santanu.Syam@angeltrade.com'and  hr48=@Email

--Raised_to_Dept=@dept and  and               
                                                            
declare @HTMLBODY1 as nvarchar(max)                  
set @HTMLBODY1=''                  
exec DBA_ConvertQueryInHTMP_Page                   
'select ComplaintID,[Raised_to_Dept],[Raised_Date],[Raised_by_EmpNm],Subject,[Complaint_Details],[Pending_since_Hours] from  tat', @HTMLBODY1 output                    
                
declare @sub varchar(500)                
--set @sub = @dept+' - Pending Query - [>48 Hours]'    
set @sub = ' - Pending Query - [>48 Hours]'             
                
drop table tat                  
                  
set @HTMLBODY1=@mess+@HTMLBODY1+'<br><br><br><br>Awaiting for your prompt action on this.<br><br>                                            
Your feedback and action is valuable for us and will surely expedite on the closure of this query.                                           
<br><br>                  
From,                  
<br>                  
Operations Helpdesk.<br><br>  '                  
                
exec mis.msdb.dbo.sp_send_dbmail   
                                                  
@recipients =@Email,                
--@copy_recipients = 'Shivakumar.L@angeltrade.com',                                        
@blind_copy_recipients= 'Shivakumar.L@angeltrade.com;Renil.Pillai@angeltrade.com',                                                               
@profile_name = 'OperationHelpdesk',                      
--@from ='OperationHelpdesk@angeltrade.com',                            
@body_format ='html',               
@subject = @sub,                                              
@file_attachments =@attach,                                                                            
@body=@HTMLBODY1     
               
--FETCH NEXT FROM OPHelpdesk_cursor1                    
--INTO @dept                                                                                                               
--END                           
--CLOSE OPHelpdesk_cursor1                  
--DEALLOCATE OPHelpdesk_cursor1                
                
                 
FETCH NEXT FROM OPHelpdesk_cursor                                             
INTO @Email                                                                                                               
END                                   
CLOSE OPHelpdesk_cursor                  
DEALLOCATE OPHelpdesk_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPMail_72
-- --------------------------------------------------
CREATE PROC USP_OPMAIL_72                            
AS        
      
                      
SELECT DISTINCT COMPLAINTID,[RAISED_TO_DEPT]=CONVERT(VARCHAR(20),[RAISED_TO_DEPT]),                              
[RAISED_DATE]=CONVERT(VARCHAR(11),[RAISED_DATE],103),[RAISED_BY_EMPNM]=CONVERT(VARCHAR(100),[RAISED_BY_EMPNM]),                              
SUBJECT=CONVERT(VARCHAR(1000),SUBJECT),[COMPLAINT_DETAILS]=CONVERT(VARCHAR(1000),[COMPLAINT_DETAILS]),                              
[PENDING_SINCE_HOURS]=CONVERT(VARCHAR(15),[PENDING_SINCE_HOURS]),HR72 INTO #HR72       
FROM AUTOMAIL_TAT WHERE PENDING_SINCE_HOURS>72 AND PENDING_SINCE_HOURS<=240      
GROUP BY  COMPLAINTID,RAISED_TO_DEPT,RAISED_DATE,RAISED_BY_EMPNM,SUBJECT,COMPLAINT_DETAILS,      
 PENDING_SINCE_HOURS,HR72      
    
    
                      
DECLARE OPHELPDESK_CURSOR CURSOR FOR                       
SELECT  DISTINCT HR72 FROM AUTOMAIL_TAT WHERE [PENDING_SINCE_HOURS]>72 AND [PENDING_SINCE_HOURS]<=240                                                                            
OPEN OPHELPDESK_CURSOR                           
DECLARE @EMAIL AS VARCHAR(1000)                                                                         
FETCH NEXT FROM OPHELPDESK_CURSOR                                                                            
INTO @EMAIL                                                                            
WHILE @@FETCH_STATUS = 0                                                         
BEGIN                                                                                                    
                        
DECLARE @SQL AS VARCHAR(5000)                          
DECLARE @S AS VARCHAR(5000)                             
DECLARE @S1 AS VARCHAR(5000)                             
DECLARE @FILE AS VARCHAR(5000)                          
DECLARE @FILE1 AS VARCHAR(500)                        
DECLARE @NAME AS VARCHAR(200)                        
DECLARE @MESS AS VARCHAR(2000)                        
                  
                       
--DECLARE OPHELPDESK_CURSOR1 CURSOR FOR                       
--SELECT  DISTINCT RAISED_TO_DEPT FROM AUTOMAIL_TAT                       
--WHERE [PENDING_SINCE_HOURS]>72 AND [PENDING_SINCE_HOURS]<=240                      
--AND HR72=@EMAIL                      
--OPEN OPHELPDESK_CURSOR1                           
--DECLARE @DEPT AS VARCHAR(1000)                                                                         
--FETCH NEXT FROM OPHELPDESK_CURSOR1                                                                            
--INTO @DEPT                                                                            
--WHILE @@FETCH_STATUS = 0                                                         
--BEGIN                       
                      
SET @MESS='DEAR SIR/MADAM,<BR><BR>                                                  
KINDLY FIND THE FOLLOWING PENDING QUERIES RELATED TO YOUR PROCESS.                      
<BR><BR><BR>                                            
'                                   
                                                                
DECLARE @HTMLBODY1 AS NVARCHAR(MAX)                        
SET @HTMLBODY1=''                        
EXEC DBA_CONVERTQUERYINHTMP_PAGE                         
'SELECT DISTINCT COMPLAINTID,[RAISED_TO_DEPT],[RAISED_DATE],[RAISED_BY_EMPNM],SUBJECT,[COMPLAINT_DETAILS],[PENDING_SINCE_HOURS] FROM  #HR72', @HTMLBODY1 OUTPUT                          
                      
DECLARE @SUB VARCHAR(500)                      
--SET @SUB = @DEPT+' - PENDING QUERY - [>72 HOURS]'  
SET @SUB = 'PENDING QUERY - [>72 HOURS]'    
                      
                      
                     
                        
SET @HTMLBODY1=@MESS+@HTMLBODY1+'<BR><BR><BR><BR>AWAITING FOR YOUR PROMPT ACTION ON THIS.<BR><BR>                                                  
YOUR FEEDBACK AND ACTION IS VALUABLE FOR US AND WILL SURELY EXPEDITE ON THE CLOSURE OF THIS QUERY.                                                 
<BR><BR>                        
FROM,                        
<BR>                        
OPERATIONS HELPDESK.<BR><BR>  '                        
                      
EXEC MIS.MSDB.DBO.SP_SEND_DBMAIL                                                     
@RECIPIENTS =@EMAIL,                      
--@RECIPIENTS ='ATULB.DIVEKAR@ANGELTRADE.COM',                                               
--@COPY_RECIPIENTS = 'ATULB.DIVEKAR@ANGELTRADE.COM',                   
@BLIND_COPY_RECIPIENTS= 'SHIVAKUMAR.L@ANGELTRADE.COM;RENIL.PILLAI@ANGELTRADE.COM;MILAND.SHAH@ANGELTRADE.COM',                                             
--@TO = 'ATULB.DIVEKAR@ANGELTRADE.COM',                                                                      
@PROFILE_NAME = 'OPERATIONHELPDESK',            
--@FROM ='OPERATIONHELPDESK@ANGELTRADE.COM',                                                        
@BODY_FORMAT ='HTML',                                                                                
@SUBJECT = @SUB,                                                    
--@FILE_ATTACHMENTS =@ATTACH,                                                                                               
@BODY=@HTMLBODY1                
--FETCH NEXT FROM OPHELPDESK_CURSOR1                                                                  
--INTO @DEPT                                
--END                                         
--CLOSE OPHELPDESK_CURSOR1                        
--DEALLOCATE OPHELPDESK_CURSOR1                      
                      
                       
FETCH NEXT FROM OPHELPDESK_CURSOR                                                                  
INTO @EMAIL                                                                                                                     
END                                         
CLOSE OPHELPDESK_CURSOR                        
DEALLOCATE OPHELPDESK_CURSOR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPMail_new
-- --------------------------------------------------
CREATE PROC USP_OPMAIL_NEW                                                  
 AS                                                
 SET NOCOUNT ON                                    
 BEGIN                                               
EXEC USP_OPERATION_AUTOMAIL                               


---****************************************************************************************
/*
/*------------------------------------------------------------------------------------*/          

-- THE FOLLOWING STATEMENT INSERT ID,DEPARTMENT,ESCALATIONLEVEL,PERSONNAME,EMAIL,    
-- AND LEVEL INTO #FILE1 WHERE LEVELINDEX IS GREATER THAN 1    

SELECT ID,DEPARTMENT,ESCALATIONLEVEL,PERSONNAME,                              
EMAIL,LEVEL=SUBSTRING(ESCALATIONLEVEL,CHARINDEX('-',ESCALATIONLEVEL)+1,LEN(ESCALATIONLEVEL))                              
INTO #FILE1                              
FROM INTRANET.MISC.DBO.DEPT_INFO WITH (NOLOCK) WHERE                               
SUBSTRING(ESCALATIONLEVEL,CHARINDEX('-',ESCALATIONLEVEL)+1,LEN(ESCALATIONLEVEL))>1                              
ORDER BY DEPARTMENT,ESCALATIONLEVEL                     

----- SELECT * FROM #FILE1    
/*------------------------------------------------------------------------------------*/    
-- IT INSERTS DEPARTMENT AND MAXLEVEL INTO #LEVEL4       


SELECT DEPARTMENT,LEVEL=MAX(LEVEL) INTO #LEVEL4 FROM #FILE1 GROUP BY DEPARTMENT    

--- SELECT * FROM #LEVEL4    

/*------------------------------------------------------------------------------------*/    

--- IT SELECT THE ALL DETAILS BY COMPARING #FILE1 AND #FILE4 WHERE LEVELS R SAME (HIGH)    


SELECT ID,A.DEPARTMENT,ESCALATIONLEVEL,PERSONNAME,EMAIL,A.LEVEL,LEVELNAME='HIGH'     
INTO #FILE2                              
FROM #FILE1 A , #LEVEL4 B     
WHERE A.DEPARTMENT=B.DEPARTMENT AND A.LEVEL=B.LEVEL        

-- SELECT * FROM #FILE2    

/*------------------------------------------------------------------------------------*/    

-- IT SELECTS THE ALL DETAILS WHERE SECOND MAXIMUM LEVEL                             

SELECT A.DEPARTMENT,LEVEL=MAX(A.LEVEL)    
INTO #LEVEL3                               
FROM #FILE1 A    
WHERE ID NOT IN (SELECT ID FROM #FILE2)                              
GROUP BY A.DEPARTMENT                   

-- SELECT * FROM #FILE2    
-- SELECT * FROM #LEVEL3    


/*------------------------------------------------------------------------------------*/    
-- IT SELECTS THE ALL DETAILS BY COMPARING #FILE A AND #FILE B (MEDIUM LEVEL)    


SELECT ID,A.DEPARTMENT,ESCALATIONLEVEL,PERSONNAME,EMAIL,A.LEVEL,LEVELNAME='MEDIUM'     
INTO #FILE3                              
FROM #FILE1 A , #LEVEL3 B     
WHERE A.DEPARTMENT=B.DEPARTMENT AND A.LEVEL=B.LEVEL               


-- SELECT * FROM #FILE3    
/*------------------------------------------------------------------------------------*/    

-- IT SELECTS THE ALL DETAILS BY COMPARING #FILE A AND #FILE B (LOW LEVEL)                            

SELECT ID,DEPARTMENT,ESCALATIONLEVEL,PERSONNAME,EMAIL,LEVEL,LEVELNAME='LOW'    
INTO #FILE4                              
FROM #FILE1     
WHERE ID NOT IN (SELECT ID FROM #FILE2) AND ID NOT IN (SELECT ID FROM #FILE3)        

-- SELECT * FROM #FILE4    

/*------------------------------------------------------------------------------------*/    
--INSERT HIGH,MEDIUM,LOW IN ONE TABLE                

SELECT * INTO #ESCALTIONLEVEL FROM #FILE2                              
UNION                              
SELECT * FROM #FILE3                              
UNION                              
SELECT * FROM #FILE4          

--select * from #ESCALTIONLEVEL  
/*------------------------------------------------------------------------------------*/    
-- SELECTING DEPT,AND DEPT_ID AND ALL COLUMNS FROM #ESCALATION TABLE    
-- BY MATCHING THE DEPARTMENT NAMES IN TWO TABLES    


SELECT X.DEPT_ID,X.DEPT_NAME,Y.* INTO #MAIL                
FROM                               
(SELECT * FROM DEPARTMENT_MASTER)X                              
INNER JOIN                              
(SELECT * FROM #ESCALTIONLEVEL)Y                              
ON X.DUMMY5=Y.DEPARTMENT                              
-- SELECT * FROM #MAIL    

/*-------------------------------------------------*/    

--SELECT THE DETAILS BY JOINING THE THREE TABLES WHERE COMPLAINT_ID IS COMMON AND DEPT IS COMMON    
-- AND FLAG IS P    


SELECT DISTINCT X.COMPLAINT_ID,DEPT_NAME,SUBJECT,COMPLAINT, TAT,FLD_EMPID=EMAIL,LEVELNAME,Y.FLD_ENTRYBY,                              
MAX(Y.COMPLAINT_DATE)AS COMPLAINT_DATE                                            
INTO #FIN1                              
FROM                                                   
OPHELPDESKTAT X INNER JOIN TBL_COMPLAINT Y ON X.COMPLAINT_ID = Y.COMPLAINT_ID                                                  
INNER JOIN #MAIL Z ON Y.DEPT_ID = Z.DEPT_ID WHERE X.STAT_FLAG='P'                              
GROUP BY X.COMPLAINT_ID,DEPT_NAME,SUBJECT,COMPLAINT, TAT,EMAIL ,LEVELNAME,Y.FLD_ENTRYBY         

-- SELECT  *  FROM #FIN1   



/*-------------------------------------------------*/    

-- SELECTING ALL THE DETAIL BY MATCHING THE SUBJECT    


SELECT X.*,Y.SUBJECT AS SUBNAME     
INTO #FIN2                               
FROM #FIN1 X INNER JOIN TBL_SUBJECT Y ON X.SUBJECT = Y.SRNO        


-- SELECT * FROM #FIN2    

/*-------------------------------------------------*/    
--SELECT * FROM TBL_FINAL_MAIL                                      

TRUNCATE TABLE TBL_FINAL_MAIL                                                  

SELECT X.*,CASE WHEN LEVELNAME='LOW' THEN FLD_EMPID ELSE 'SANJAY.GHOSH@ANGELTRADE.COM;FATIMA.SHAIKH@ANGELTRADE.COM;KUMUD.UPADHAYA@ANGELTRAE.COM' END                               
AS HR48,CASE WHEN LEVELNAME='MEDIUM' THEN FLD_EMPID ELSE 'SANJAY.GHOSH@ANGELTRADE.COM;FATIMA.SHAIKH@ANGELTRADE.COM;KUMUD.UPADHAYA@ANGELTRAE.COM' END AS HR72,                              
CASE WHEN LEVELNAME='HIGH' THEN FLD_EMPID ELSE 'SANTANU.SYAM@ANGELTRADE.COM' END  AS HR240                              
--C.EMAIL AS HR72                                                   
--INTO TBL_FINAL_MAIL                                                  
INTO #ABCD                                               
FROM #FIN2 X       

-- SELECT * FROM #ABCD        
-- DROP TABLE #EMAILDATA    

/*---------------------------------------------------------------------------------------------------------------------*/    


SELECT DISTINCT COMPLAINT_ID AS COMPLAINTID,  
DEPT_NAME    AS [RAISED_TO_DEPT],                                            
COMPLAINT    AS [COMPLAINT_DETAILS],  
TAT          AS [PENDING_SINCE_HOURS],  
SUBNAME       AS SUBJECT,  
COMPLAINT_DATE AS [RAISED_DATE],  
B.EMP_NAME    AS [RAISED_BY_EMPNM],                                            
HR48,HR72,HR240   
INTO #EMAILDATA                                            
FROM #ABCD A, INTRANET.RISK.DBO.EMP_INFO B   
WHERE  A.FLD_ENTRYBY = B.EMP_NO                                              

CREATE TABLE #HOURS(TAT  VARCHAR(11))                                            
INSERT INTO #HOURS VALUES('1')                                            
INSERT INTO #HOURS VALUES('2')                     
INSERT INTO #HOURS VALUES('3')                                            
INSERT INTO #HOURS VALUES('4')                 



UPDATE #EMAILDATA SET [COMPLAINT_DETAILS] =REPLACE(REPLACE([COMPLAINT_DETAILS],'                                              
',''),',','  ')           

DROP TABLE AUTOMAIL_TAT                                            

SELECT COMPLAINTID,  
[RAISED_TO_DEPT]=CONVERT(VARCHAR(20),[RAISED_TO_DEPT]),                                            
[RAISED_DATE]=CONVERT(VARCHAR(11),[RAISED_DATE],103),  
[RAISED_BY_EMPNM]=CONVERT(VARCHAR(100),[RAISED_BY_EMPNM]),                                            
SUBJECT=CONVERT(VARCHAR(1000),SUBJECT),  
[COMPLAINT_DETAILS]=CONVERT(VARCHAR(1000),[COMPLAINT_DETAILS]),                                            
[PENDING_SINCE_HOURS]=CONVERT(VARCHAR(15),[PENDING_SINCE_HOURS]),HR48,HR72,HR240   
INTO AUTOMAIL_TAT                                             
FROM  #EMAILDATA                                 



SELECT DISTINCT COMPLAINTID,[RAISED_TO_DEPT]=CONVERT(VARCHAR(20),[RAISED_TO_DEPT]),                                            
[RAISED_DATE]  =CONVERT(VARCHAR(11),[RAISED_DATE],103),  
[RAISED_BY_EMPNM]=CONVERT(VARCHAR(100),[RAISED_BY_EMPNM]),                                            
SUBJECT=CONVERT(VARCHAR(1000),SUBJECT),  
[COMPLAINT_DETAILS]=CONVERT(VARCHAR(1000),[COMPLAINT_DETAILS]),                                            
[PENDING_SINCE_HOURS]=CONVERT(VARCHAR(15),  
[PENDING_SINCE_HOURS]),HR48 INTO #HR48                     
FROM AUTOMAIL_TAT WHERE PENDING_SINCE_HOURS>48 AND PENDING_SINCE_HOURS<=72                    
GROUP BY  COMPLAINTID,RAISED_TO_DEPT,RAISED_DATE,RAISED_BY_EMPNM,SUBJECT,COMPLAINT_DETAILS,                    
PENDING_SINCE_HOURS,HR48                    



/*=========================*/                                      
DECLARE OPHELPDESK_CURSOR CURSOR FOR                                             
SELECT  DISTINCT HR48 FROM  #EMAILDATA WHERE [PENDING_SINCE_HOURS]>48 AND [PENDING_SINCE_HOURS]<=72                                                                                                 
OPEN OPHELPDESK_CURSOR                          
DECLARE @EMAIL AS VARCHAR(1000)                          
FETCH NEXT FROM OPHELPDESK_CURSOR                                           
INTO @EMAIL WHILE @@FETCH_STATUS = 0                                                                     
BEGIN                                                                                                         

DECLARE @SQL AS VARCHAR(5000)         
DECLARE @S AS VARCHAR(5000)                                                   
DECLARE @S1 AS VARCHAR(5000)                                                   
DECLARE @FILE AS VARCHAR(5000)                                                
DECLARE @FILE1 AS VARCHAR(500)                                              
DECLARE @NAME AS VARCHAR(200)                                              
DECLARE @MESS AS VARCHAR(2000)                                              



DROP TABLE TAT                          
SELECT * INTO TAT FROM AUTOMAIL_TAT WHERE [PENDING_SINCE_HOURS]>48 AND [PENDING_SINCE_HOURS]<=72                            
AND HR48=@EMAIL                                            

SET @MESS='DEAR SIR/MADAM,<BR><BR>                                                              
KINDLY FIND THE FOLLOWING PENDING QUERIES RELATED TO YOUR PROCESS.                                            
<BR><BR><BR>                                                          
'                                                         
  
DECLARE @HTMLBODY1 AS NVARCHAR(MAX)                                              
SET @HTMLBODY1=''                                              
EXEC DBA_CONVERTQUERYINHTMP_PAGE                                               
'SELECT DISTINCT COMPLAINTID,[RAISED_TO_DEPT],[RAISED_DATE],[RAISED_BY_EMPNM],SUBJECT,[COMPLAINT_DETAILS],[PENDING_SINCE_HOURS] FROM  #HR48', @HTMLBODY1 OUTPUT                                                

DECLARE @SUB VARCHAR(500)                                            
SELECT TOP 1 @SUB=RAISED_TO_DEPT FROM TAT                          
SET @SUB = 'PENDING QUERY - [>48 HOURS]'                                            



SET @HTMLBODY1=@MESS+@HTMLBODY1+'<BR><BR><BR><BR>AWAITING FOR YOUR PROMPT ACTION ON THIS.<BR><BR>                                                                        
YOUR FEEDBACK AND ACTION IS VALUABLE FOR US AND WILL SURELY EXPEDITE ON THE CLOSURE OF THIS QUERY.                                                                       
<BR><BR>                                              
FROM,                                              
<BR>                                              
OPERATIONS HELPDESK.<BR><BR>  '                                              


EXEC MIS.MSDB.DBO.SP_SEND_DBMAIL                                                                               
@RECIPIENTS =@EMAIL,                                            
--@RECIPIENTS ='SHIVAKUMAR.L@ANGELTRADE.COM',                                                                     
--@COPY_RECIPIENTS = 'SHIVAKUMAR.L@ANGELTRADE.COM',                                                                    
--@TO = 'SHIVAKUMAR.L@ANGELTRADE.COM',                                          
@BLIND_COPY_RECIPIENTS= 'SHIVAKUMAR.L@ANGELTRADE.COM;RENIL.PILLAI@ANGELTRADE.COM;',                                                                                             
@PROFILE_NAME = 'OPERATIONHELPDESK',                                                  
--@FROM ='OPERATIONHELPDESK@ANGELTRADE.COM',                                                                              
@BODY_FORMAT ='HTML',                                                                                                        
@SUBJECT = @SUB,                                                                          
--@FILE_ATTACHMENTS =@ATTACH,                                                                                                                     
@BODY=@HTMLBODY1                                              


FETCH NEXT FROM OPHELPDESK_CURSOR                                                                                        
INTO @EMAIL                                                                                  
END                                              
CLOSE OPHELPDESK_CURSOR                                              
DEALLOCATE OPHELPDESK_CURSOR                                            



--EXEC USP_OPMAIL_48      //NO NEED OF THIS BCOZ ALREADY WE DECLARED IN THE ABOVE FOR 48                                 

EXEC USP_OPMAIL_72              

EXEC USP_OPMAIL_240                                    

*/
END 
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPOffline_TAT
-- --------------------------------------------------
CREATE proc USP_OPOffline_TAT      
as      
SET NOCOUNT ON      
      
select max(sr_num)sr_num,Complaint_Id,Complaint_Date=min(Complaint_Date),            
Solution_date=case when Solution_date is NULL then getdate() else max(Solution_date) end,status                             
into #Complaint_ComplaintNSolution       
from tbl_complaint(nolock) where status<>'BC'      
group by Complaint_Id,Solution_date,status                           
      
 select complaint_id,max(Complaint_Date)Complaint_Date,max(Solution_date)Solution_date into #date from       
 #Complaint_ComplaintNSolution group by complaint_id order by complaint_id      
      
select Complaint_Id,Complaint_Date,Solution_date,daysC=datediff(dd,Complaint_Date,Solution_date)+1,                            
daysS=datediff(dd,Complaint_Date,Solution_date) into #Complaint_ComplaintNSolution1                            
 from #date      
      
select * into #tatdays from sett_mst where tdate>'2010-01-15 00:00:00.000'                         
                              
declare @Complaint_Id varchar(25),@rec int,@cdate varchar(25),@sdate varchar(25),@daysS int                            
                              
DECLARE OPTAT_cursor CURSOR FOR                                                                                                       
select Complaint_Id from #Complaint_ComplaintNSolution1                            
                                                                                                                                                    
                                                                                                                                                                   
OPEN OPTAT_cursor                                                                                                                                                                       
FETCH NEXT FROM OPTAT_cursor                                                                                                                                                                                           
INTO @Complaint_Id                                                           
WHILE @@FETCH_STATUS = 0                                                                                                                                                     
BEGIN                                                                                                     
                                                                                                            
                            
select @rec=count(1) from #Complaint_ComplaintNSolution1  where Complaint_Id=@Complaint_Id                                                                                                                     
if @rec > 0                                                                                                        
 BEGIN                                  
select @cdate=Convert(varchar(11),Complaint_Date,103),@sdate=Convert(varchar(11),Solution_date,103)             
from  #Complaint_ComplaintNSolution1  where Complaint_Id=@Complaint_Id                             
                            
 select @daysS=COUNT(TDATE) from sett_mst(NOLOCK) where tdate>=Convert(datetime,@cdate,103) and            
  tdate<=Convert(datetime,@sdate,103)                            
                             
 update #Complaint_ComplaintNSolution1 set daysS=@daysS where Complaint_Id=@Complaint_Id                             
                                     
 END                            
 FETCH NEXT FROM OPTAT_cursor                                                                                                                                                             
INTO @Complaint_Id                                                                                                       
END                           
CLOSE OPTAT_cursor               
DEALLOCATE OPTAT_cursor            
       
select Complaint_Id,Complaint_Date,Solution_date,daysC,daysS,Diff=daysC-daysS      
into #Complaint_ComplaintNSolution2                             
from #Complaint_ComplaintNSolution1                      
                            
select Complaint_Id,Complaint_Date,Solution_date,daysC,daysS,Diff,                            
TAT=datediff(hh,Complaint_date,Solution_date)-(diff*24) into #final                            
from #Complaint_ComplaintNSolution2       
      
select a.*,b.stat_flag into #finaltatdata from      
(select * from #final)a      
inner join       
(select complaint_date,complaint_id,stat_flag from V_OpsStatus      
where complaint_date in (select max(complaint_date) from V_OpsStatus group by complaint_id))b      
on a.complaint_id=b.complaint_id order by a.complaint_id      
      
Truncate table OphelpdeskTAT      
      
insert into OphelpdeskTAT      
select complaint_id,stat_flag,      
OpTAT=case     
--when tat<24 then '< 24Hr'     
--tat>=24 and     
when tat<=48 then '< 48 Hr' when tat>48 and tat<=72 then '> 48 Hr'      
when tat>72 and tat<=240 then '>72 Hr' when tat>240 then '>240 Hr'      
end ,tat,getdate() from #finaltatdata

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_OPRATIONHELPDESK_LOGIN
-- --------------------------------------------------
CREATE proc USP_OPRATIONHELPDESK_LOGIN          
(          
@UserName as varchar(15),          
@AccessTo as varchar(30)          
)          
as          
if @AccessTo='SB'          
begin           
select emp_name=name, Department='-',Attendanceloc=branch_code from intranet.risk.dbo.subbrokers where sub_broker=@UserName          
end          
else          
begin          
--select emp_Name,Department,Attendanceloc from [MIDDLEWARE].harmony.dbo.vlmsinhouse  where [Emp no] =@UserName        
  
select x.emp_Name,Department=isnull(Department,'-'),x.Attendanceloc from   
(select username,emp_Name=person_name,Attendanceloc=access_code from intranet.risk.dbo.user_login with (nolock) where username=@UserName )x  
 left outer join  
 (select [Emp no],emp_Name,Department,Attendanceloc from [MIDDLEWARE].harmony.dbo.vlmsinhouse  where [Emp no] =@UserName      )y  
 on x.username=y.[Emp no]  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Order_Confirmation
-- --------------------------------------------------
CREATE proc USP_Order_Confirmation      
(      
@Fld_SrNo int,      
@Fld_Branch_id int,    
@Fld_Contact_Person varchar(100),    
@Fld_Confimation_Time varchar(15),      
@Fld_Staus varchar(1000),      
@Fld_Reason varchar(1000),      
@Fld_UPD_By varchar(15),  
@fld_date varchar(11)  
)      
as      
  
set @fld_date = convert(datetime,@fld_date,103)  
  
      
if (select count(*) from tbl_Order_Confirmation where Fld_SrNo = @Fld_SrNo) = 0      
begin      
 insert into tbl_Order_Confirmation values      
 (      
 @Fld_Branch_id,      
 @Fld_Contact_Person,    
 @Fld_Confimation_Time,      
 @Fld_Staus,      
 @Fld_Reason,      
 @Fld_UPD_By,      
 @fld_date     
 )      
end      
else      
Begin      
 update tbl_Order_Confirmation set       
 Fld_Branch_id = @Fld_Branch_id,    
 Fld_Contact_Person = @Fld_Contact_Person,      
 Fld_Confimation_Time = @Fld_Confimation_Time,      
 Fld_Staus = @Fld_Staus,      
 Fld_Reason = @Fld_Reason,      
 Fld_UPD_By = @Fld_UPD_By  
/* Fld_UPD_Time = getdate()*/      
 where Fld_SrNo = @Fld_SrNo      
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Printer_Master
-- --------------------------------------------------
CREATE proc USP_Printer_Master  
(  
@Fld_SrNo int,  
@Fld_Mfg_id int,  
@Fld_Model_No varchar(50),  
@Fld_Serial_No varchar(50),  
@Fld_Branch_id int,  
@Fld_User_Name varchar(50),  
@Fld_Upd_By varchar(15)  
)  
as  
  
if(select count(*) from tbl_Printer_Master (nolock) where Fld_SrNo = @Fld_SrNo) = 0  
begin  
 insert into tbl_Printer_Master values   
 (  
 @Fld_Mfg_id,  
 @Fld_Model_No,  
 @Fld_Serial_No,  
 @Fld_Branch_id,  
 @Fld_User_Name,  
 @Fld_Upd_By,  
 getdate()  
 )  
Select 'Record Saved !' as Msg
end  
else
Begin  
 update tbl_Printer_Master set   
 Fld_Mfg_id = @Fld_Mfg_id,  
 Fld_Model_No = @Fld_Model_No,  
 Fld_Serial_No = @Fld_Serial_No,  
 Fld_Branch_id = @Fld_Branch_id,  
 Fld_User_Name = @Fld_User_Name,  
 Fld_Upd_By = @Fld_Upd_By,  
 Fld_Upd_Date = getdate() where Fld_SrNo = @Fld_SrNo   

Select 'Record Updated!' as Msg
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Printer_Updates
-- --------------------------------------------------
CREATE proc USP_Printer_Updates
(
@Fld_SrNo int,
@Fld_Printer_Id int,
@Fld_DT_Date datetime,
@Fld_DT_From varchar(10),
@Fld_DT_To varchar(10),
@Fld_Total_DT varchar(10),
@Fld_Problem varchar(200),
@Fld_Solution varchar(200),
@Fld_Status varchar(50),
@Fld_Part_Name varchar(50),
@Fld_Port_No varchar(50),
@Fld_Serial_No varchar(50),
@Fld_Upd_By varchar(15),
@Fld_Upd_Date datetime
)
as

if(select count(*) from tbl_Printer_Updates (nolock) where Fld_SrNo = @Fld_SrNo) = 0
Begin
	insert into tbl_Printer_Updates values
	(
		@Fld_Printer_Id,
		@Fld_DT_Date,
		@Fld_DT_From,
		@Fld_DT_To,
		@Fld_Total_DT,
		@Fld_Problem,
		@Fld_Solution,
		@Fld_Status,
		@Fld_Part_Name,
		@Fld_Port_No,
		@Fld_Serial_No,
		@Fld_Upd_By,
		getdate()
	)

end
else
Begin
	update tbl_Printer_Updates set
		Fld_Printer_Id = @Fld_Printer_Id,
		Fld_DT_Date = @Fld_DT_Date,
		Fld_DT_From = @Fld_DT_From,
		Fld_DT_To = @Fld_DT_To,
		Fld_Total_DT = @Fld_Total_DT,
		Fld_Problem = @Fld_Problem,
		Fld_Solution = @Fld_Solution,
		Fld_Status = @Fld_Status,
		Fld_Part_Name =	@Fld_Part_Name,
		Fld_Port_No = @Fld_Port_No,
		Fld_Serial_No = @Fld_Serial_No,
		Fld_Upd_By = @Fld_Upd_By,
		Fld_Upd_Date = getdate() 
	where Fld_SrNo = @Fld_SrNo

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_PurchaseOrderWiseReport
-- --------------------------------------------------


CREATE proc usp_PurchaseOrderWiseReport(@purchaseorderNo as varchar(50))    
as    
if @purchaseorderNo=''  
set @purchaseorderNo= '%%'  
select a.*,b.Fld_PurchaseOrderNo from     
((select * from tbl_itassetsdata(nolock))a    
inner join    
(select fld_Requestid,Fld_PurchaseOrderNo from tbl_ItRequestPurchaseOrder(nolock) where Fld_PurchaseOrderNo like @purchaseorderNo)b    
on    
a.fld_requestid=b.fld_Requestid) order by Fld_PurchaseOrderNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_PurchaseOrderWiseReport1
-- --------------------------------------------------
create proc usp_PurchaseOrderWiseReport1(@fdate as varchar(11),@tdate as varchar(11), @purchaseorderNo as varchar(50))  
as  
if @purchaseorderNo=''
set @purchaseorderNo= '%%'
select a.*,b.Fld_PurchaseOrderNo from   
((select * from tbl_itassetsdata(nolock)where fld_SystemDate>=convert(datetime,@fdate,103) and fld_SystemDate<=convert(datetime,@tdate,103)+' 23:59:59.999')a  
inner join  
(select fld_Requestid,Fld_PurchaseOrderNo from tbl_ItRequestPurchaseOrder(nolock) where Fld_PurchaseOrderNo like @purchaseorderNo)b  
on  
a.fld_requestid=b.fld_Requestid)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_QA_DEPT_Master
-- --------------------------------------------------
create proc USP_QA_DEPT_Master
as

select distinct deptno,departmentname from departmentmaster where deptno not in ('EBR','HR','SW','CMS','HD','IT') ORDER BY departmentname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_querytype_insert
-- --------------------------------------------------
create proc usp_querytype_insert 
(   
    @fld_dep_id varchar(50),
	@querytype varchar(100)  
	
)
as  
begin  
insert into query_type14(Fld_Dep_Id ,Fld_Query,dummy1) values (@fld_dep_id,@querytype,'N')  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Region_Master
-- --------------------------------------------------
CREATE Proc USP_Region_Master(@Fld_SrNo int,@Fld_RegCode varchar(20),@Fld_RegName varchar(50))
as

if (select count(*) from Tbl_Region_Master (nolock) where Fld_SrNo = @Fld_SrNo) = 0
begin
	insert into Tbl_Region_Master values (@Fld_RegCode,@Fld_RegName)
end 
else
begin
	update Tbl_Region_Master set Fld_RegCode = @Fld_RegCode, Fld_RegName = @Fld_RegName where Fld_SrNo = @Fld_SrNo
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RegionWiseReport
-- --------------------------------------------------
CREATE proc  USP_RegionWiseReport(@fdate as varchar(11),@tdate as varchar(11))    
as     
begin
Set NOCount ON    
set @fdate =convert(datetime,@fdate,103)    
set @tdate =convert(datetime,@tdate,103)  
  
select complaint_id,max(sr_num) sr_num into #t from tbl_complaint(nolock) 
where complaint_date>=@fdate    
and complaint_date<=@tdate+' 23:59:59' group by complaint_id    
  
 select a.*,b.access_code into #tt from    
(select v_opsstatus.* from v_opsstatus inner join #t on v_opsstatus.sr_num=#t.sr_num)a    
 left outer join    
(select distinct access_code from tbl_complaint)b    
 on a.branch_tag=b.access_code
 
--select a.*,isnull(b.Pend,0) Pending ,isnull(c.ip,0) InProcess,isnull(d.hld,0) Hold,    
--isnull(e.Comp,0)Completed,isnull(f.BC,0) Branch_Completed from    
--(select access_code,Total=count(*) from #tt group by access_code)a     
--left outer join    
--(select access_code,Pend=count(*) from #tt where stat_flag ='P' group by access_code)b
--on a.access_code=b.access_code    
--left outer join    
--(select access_code,ip=count(*) from #tt where stat_flag in('IP','F') group by access_code)c 
--on a.access_code=c.access_code    
--left outer join    
--(select access_code,Hld=count(*) from #tt where stat_flag='H' group by access_code)d 
--on a.access_code=d.access_code    
--left outer join    
--(select access_code,Comp=count(*) from #tt where stat_flag='C' group by access_code)e 
--on a.access_code=e.access_code    
--left outer join    
--(select access_code,BC=count(*) from #tt where stat_flag='BC' group by access_code)f    
--on a.access_code=f.access_code
--where a.access_code is not null

select a.*,b.region into #regionwise from #tt a left outer join intranet.risk.dbo.region b on a.access_code = b.code   


select a.*,isnull(b.Pend,0) Pending ,isnull(c.ip,0) InProcess,isnull(d.hld,0) Hold,    
isnull(e.Comp,0)Completed,isnull(f.BC,0) Branch_Completed from    
(select region,Total=count(*) from #regionwise group by region)a     
left outer join    
(select region,Pend=count(*) from #regionwise where stat_flag ='P' group by region)b
on a.region=b.region    
left outer join    
(select region,ip=count(*) from #regionwise where stat_flag in('IP','F') group by region)c 
on a.region=c.region    
left outer join    
(select region,Hld=count(*) from #regionwise where stat_flag='H' group by region)d 
on a.region=d.region    
left outer join    
(select region,Comp=count(*) from #regionwise where stat_flag='C' group by region)e 
on a.region=e.region    
left outer join    
(select region,BC=count(*) from #regionwise where stat_flag='BC' group by region)f    
on a.region=f.region
where a.region is not null
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Report_banking
-- --------------------------------------------------
CREATE proc Usp_Report_banking                  
(@fdate as varchar(11),@tdate as varchar(11),                  
@branch as varchar(15),@status as varchar(10),        
@UserType as varchar(50),@Access_Code as varchar(15),@userName as varchar(50))                  
                  
as                
      
/*      
declare @fdate as varchar(11),@tdate as varchar(11),                  
@branch as varchar(15),@status as varchar(10),        
@UserType as varchar(50),@Access_Code as varchar(15),@userName as varchar(50)      
        
set @fdate = '01/01/2008'      
set @tdate = '15/01/2008'      
set @branch = 'ALL'      
set @status = 'FORWARD'      
set @UserType = 'USER'      
set @Access_Code = 'CSO'      
set @username = 'E02031'      
*/      
                  
declare @str as varchar(5000)                  
declare @status1 as varchar(10)      
                  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                  
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                  
        
set @status1 = (        
case         
when @status = 'ALL' then 'like ''%%'''         
when @status = 'PENDING' then ' = ''P'''         
when @status = 'FORWARD' then ' = ''F'''         
else ' = ''C''' end)                  
        
set @branch = (case when @branch = 'ALL' then 'like ''%%''' else '= '''+@branch+'''' end)           
      
if @UserType = 'USER' and @status = 'FORWARD'      
begin      
 set @str = 'select Fld_Segment,Fld_Date,Fld_Cheque,Fld_Amount,Fld_AccNo,Fld_Party_Code,Fld_Remarks,Fld_Complaint_No,''VIEW'' as VIEWg from                   
 tbl_Query_entry(nolock) where Fld_Access_Code '+@branch+' and Fld_Status '+@status1+' and Fld_Entry_Time >= '''+@fdate+''' and                   
 Fld_Entry_Time <= '''+@tdate+'  23:59:59'' and Fld_Forward_To = '''+@userName+''''                      
end      
else      
begin             
/*  
 set @str = 'select Fld_Segment,Fld_Date,Fld_Cheque,Fld_Amount,Fld_AccNo,Fld_Party_Code,Fld_Remarks,Fld_Complaint_No,''VIEW'' as VIEWg from                   
 tbl_Query_entry(nolock) where Fld_Access_Code '+@branch+' and Fld_Status '+@status1+' and Fld_Entry_Time >= '''+@fdate+''' and                   
 Fld_Entry_Time <= '''+@tdate+'  23:59:59'''                  
*/  
  
set @str = 'select x.Fld_Segment,x.Fld_Date,x.Fld_Cheque,x.Fld_Amount,x.Fld_AccNo,x.Fld_Party_Code,x.Fld_Remarks,x.Fld_Complaint_No,Emp_Name,VIEWg from  
(select Fld_Segment,Fld_Date,Fld_Cheque,Fld_Amount,Fld_AccNo,Fld_Party_Code,Fld_Remarks,Fld_Complaint_No,Fld_Forward_To,''VIEW'' as VIEWg from tbl_Query_entry(nolock) where Fld_Access_Code   
'+@branch+'and Fld_Status  '+@status1+' and Fld_Entry_Time >= '''+@fdate+'''and Fld_Entry_Time <= '''+@tdate+'  23:59:59'') x left outer join (select * from intranet.risk.dbo.emp_info) y  
on x.Fld_Forward_To = y.Emp_no'  
end               
             
--print @str                  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_reqtype
-- --------------------------------------------------

CREATE proc usp_reqtype (@reqtype as varchar(200))
as

Insert into Tbl_Request_Master values('HR',@reqtype,'')

select fld_srno from tbl_request_master where fld_request = @reqtype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Request_ForwardMail
-- --------------------------------------------------
CREATE procedure Usp_Request_ForwardMail  ---'E31413','Software Problem','Shivakumar.L@angeltrade.com','Roopali.Pandey@angeltrade.com','Ajaxsuccessfully implemented','E31452'                            
                                                
                    
(                     
       @ComplaintId    as varchar(100),                                
       @Subject        as varchar(500),                                
       @mailto         as varchar(1000),                                
       @mailcc         as varchar(1000),                      
       @Message        as varchar(5000),                       
       @repliedby      as varchar(100)                         
 )                     
                    
as                                
                          
                              
   -- select  emp_no from intranet.risk.dbo.emp_info  with(nolock)                     
   --    where email=@mailto                        
                       
--   drop table #Emp_info1                  
                   
        declare @emp_no varchar(30)              
            
     select   emp_no  into #Emp_info1                    
     from intranet.risk.dbo.emp_info  with(nolock)                    
     where email =@mailto            
                       
                           
                            
         select @emp_no =(select top 1 emp_no from #Emp_info1)                    
                    
----      print @emp_no                    
                    
         update tbl_complaint                
         set Solution='Forwarded to'+( select top 1 emp_no from #Emp_info1) ,                    
                      Solution_by = @repliedby ,                    
                      status='f',                    
                      Solution_Date=getdate()                           
         where Sr_num in                           
        (select Sr_num=max(Sr_num)                     
         from tbl_complaint with (nolock)                    
         where  complaint_id=@ComplaintId                     
         group by complaint_id)       
  
         insert into Mail_totaldata values (@ComplaintId,@Subject, @mailto ,  @mailcc , @Message , @repliedby   )            
                    
         insert into tbl_complaint                          
         select                           
         Dept_ID,Complaint_ID,Query_Type,Subject,Complaint,Solution='',                          
         Access_code,Solution_By=@emp_no,Complaint_Date,Solution_Date='',                          
         Attachment,Status='p',Fld_EntryBy,cso_attch,fld_hold_Reason,                          
         compl_abt,clt_subdetl                          
         from tbl_complaint                          
         where status ='f' and Sr_num in                           
        (select Sr_num=max(Sr_num) from tbl_complaint with (nolock)                           
         where  complaint_id=@ComplaintId group by complaint_id)                          
                          
                    
      begin                  
                               
 DECLARE   @CID     VARCHAR(100),      -- @CID IS USED FOR COMPLAIN ID                                     
     @SUB     VARCHAR(500),      -- @SUB IS USED FOR SUBJECT                                    
     @EMAIL   VARCHAR(1000),     -- @EMAIL IS USED FOR EMAILID                                     
     @EMAILCC varchar(1000) ,    -- @EMAILCC is used for CCEmailId                    
     @MESS    VARCHAR(4000)      -- @MESS IS USED FOR MESSAGE                                     
                                        
                                  
    set  @CID=@ComplaintId                              
    set  @SUB=@Subject                              
    set  @EMAIL=@mailto                               
    set  @EMAILCC =  @mailcc                                  
                                            
                                          
     SET @MESS='<BR>            
              <BR>           
              <BR>         
<BR>                                 
                                    
     Kindly revert us through below mentioned link :  https://196.1.115.172/AngelInHouse/OperationHelpdesk/frmcheckreply.aspx?id='+ ltrim(rtrim(@CID)) +'&username='+ ltrim(rtrim(@emp_no)) +'                                  
     <BR>            
     <BR>         
                  
      '+@Message+'             
             
     <BR>                
     <BR>            
                  
     This is a System Generated Mail kindly do not reply. To understand and reply the query, kindly click on the above link and click on reply & send.  <BR><BR>                       
                  
     For any further clarification, please feel free to contact feedback team.   <BR><BR>                   
                  
     Thank you for giving us the opportunity to serve you.                
                               
                                                                                                             
    <BR>'                                    
  -- print  @MESS                                                       
                                                          
   EXEC MSDB.DBO.SP_SEND_DBMAIL                               
   @RECIPIENTS = @EMAIL,                                          
   @COPY_RECIPIENTS=@EMAILCC,                                  
   @PROFILE_NAME = 'OPERATIONHELPDESK ',                                                            
   @BODY_FORMAT ='HTML',                                                                                              
   @SUBJECT =@SUB ,                                                                                                          
   @FILE_ATTACHMENTS ='',                                                                                                                                          
   @BODY =@MESS                                          
                          
                                      
                                        
     END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_reset_Pwd_mail
-- --------------------------------------------------
CREATE proc usp_reset_Pwd_mail(@userid as varchar(50),@dept as varchar(50))      
as      
      
declare @email as varchar(50)      
declare @Password as varchar(50)      
declare @sub as varchar(50)      
declare @msg as varchar(500)      
      
set @email = (select Emailid from logintablecopy where fldpartycode = @userid and flddepartment = @dept and Status = 0)      
set @Password = (select fldpassword from logintablecopy where fldpartycode = @userid and flddepartment = @dept and Status = 0)      
set @sub = 'Request For Password Reset'      
set @msg = '<font face=verdana size=2>Dear <b>'+ upper(@userid) +'</b>,<br><br>Please note that your password has been reset & the new password is <b>'+ @Password +'.</b>      
<br><br><font face=verdana size=2>Thanks & Regards,<br><BR><b>Bharti Mane<Br></font>'                  
      
exec mis.master.dbo.usp_AutoMail @email,'Bharti.Mane@angeltrade.com', @sub,@msg

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_RO_Report
-- --------------------------------------------------
CREATE Proc USP_RO_Report(@tag as varchar(15),@flag as char(2))    
as    
set @tag = (case when @tag = 'ALL' then 'Br_tag Like ''%%''' else 'Br_tag ='+''''+@tag+'' end)    
    
declare @sql as varchar(1000)    
    
set @sql = 'select Br_Tag,''<A href=\Upload1\IT_Diagram\''+Br_Attachment+''>''+Br_Attachment+''</a>'' as  Br_Attachment from Tbl_IT_Attachment where '+@tag+'''and br_head = '''+@flag+''''    
exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SBS_DETAILS
-- --------------------------------------------------
CREATE Proc USP_SBS_DETAILS(@Branch_id varchar(15))          
as          
          
select * from Tbl_SBS_Mast x (nolock)  where not exists          
(select * from V_SBS_Master y where x.Fld_Sbs_id = y.Fld_Sbs_id /*and y.Branch_id = @Branch_id*/ )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_Calls_Data
-- --------------------------------------------------
CREATE Proc USP_Search_Calls_Data      
(      
@Fld_Gateway_ip varchar(15),      
@Fld_Upd_date varchar(11)      
)      
as      
      
set @Fld_Upd_date = convert(varchar(11),convert(datetime,@Fld_Upd_date,103))        
      
if (select count(*) from tbl_call_rpt (nolock) where Fld_Gateway_ip =@Fld_Gateway_ip and Fld_Upd_date = @Fld_Upd_date) > 0      
Begin      
    
select x.*,y.Fld_Location,y.Fld_Server_ip from     
(select Fld_Gateway_ip,Fld_Call_Type,Fld_Dealer_Name,Fld_First_Confirmation,Fld_First_Frq,Fld_Second_Confirmation,    
Fld_Second_Frq,Fld_First_Entered_By,Fld_Second_Entered_By from tbl_call_rpt (nolock) where Fld_Gateway_ip = @Fld_Gateway_ip and Fld_Upd_date = @Fld_Upd_date       
)x inner join    
(select * from v_tbl_it_site_data) y on x.Fld_Gateway_ip = y.Fld_Def_Gateway    
    
end      
else      
Begin      
   select Fld_Def_Gateway,'' as a,'' as b, '' as c,'' as d,'' as e,'' as f,'' as f,'' as h,Fld_Location,Fld_Server_ip from v_tbl_it_site_data (nolock) where Fld_Def_Gateway = @Fld_Gateway_ip       
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_Note
-- --------------------------------------------------
CREATE proc USP_Search_Note(@FDate as varchar(11),@tdate as varchar(11))  
as  
  
set @FDate = convert(varchar(11),convert(datetime,@FDate,103))  
set @tdate =  convert(varchar(11),convert(datetime,@tdate,103))  
  
Select convert(varchar(11),Fld_date,103) as Fld_date,Fld_Remark from tbl_Call_Note (nolock) where Fld_Date >= @FDate and Fld_Date <= @tdate + ' 23:59:59'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_ODin_Report
-- --------------------------------------------------
CREATE Proc USP_Search_ODin_Report(@Code as varchar(100),@Type as varchar(15))    
as    
declare @str as varchar(1000)    
    
set @Code = (case when @Code = 'All' then 'like ''%%''' else '= '''+@Code+'''' end)      
    
set @str = case     
when @Type = 'C' then 'select *  from V_Server_Master where Fld_Branch_cd '+@Code+''    
when @Type = 'S' then 'select *  from V_Server_Master where Fld_server '+@Code+''    
when @Type = 'N' then 'select *  from V_Server_Master where Br_Name '+@Code+''    
end    
    
--print @str  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_ODin_Server
-- --------------------------------------------------
CREATE Proc USP_Search_ODin_Server(@Type as varchar(15),@Br_type as varchar(20))      
as      
      
declare @str as varchar(500)      
      
set @str = case       
when @Type = 'C' then 'select distinct br_tag as Br_tag from tbl_it_br_master where Br_Type like '''+@Br_type+''' order by br_tag'      
when @Type = 'N' then 'select distinct br_Name  as Br_tag from tbl_it_br_master where Br_Type like '''+@Br_type+'''  order by br_Name'      
when @Type = 'S' then 'select distinct Fld_server as Br_tag from Tbl_Server_Master order by Fld_server'     
when @Type = 'SEG' then 'select Fld_Segments as Br_tag from Tbl_Segment_Master'     
when @Type = 'R' then 'select Fld_Regcode as Br_tag from Tbl_Region_Master order by Fld_Regcode'    
when @Type = 'A' then 'select Fld_Sbs_Name as Br_tag from tbl_sbs_mast'    
end      
      
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_SBS_Report
-- --------------------------------------------------
CREATE Proc USP_Search_SBS_Report(@Code as varchar(50),@Type as varchar(15))  
as  
declare @str as varchar(500)  
  
set @Code = (case when @Code = 'All' or @Code = '' then 'like ''%%''' else '= '''+@Code+'''' end)    
  
set @str = case   
when @Type = 'C' then 'select * from V_SBS_Master where Br_Tag '+@Code+''  
when @Type = 'N' then 'select * from V_SBS_Master where Br_Name '+@Code+''  
when @Type = 'A' then 'select * from V_SBS_Master where Fld_SBS_Name '+@Code+''  
end  

exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_Server
-- --------------------------------------------------
CREATE Proc USP_Search_Server(@location as varchar(25))
as

select distinct upper(server) as server from terminals (nolock) where server  in
(select server from server_users (nolock) where location = @location)
and edate > getdate()

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_Terminal_Report
-- --------------------------------------------------
CREATE Proc USP_Search_Terminal_Report(@Code as varchar(50),@Type as varchar(15),@order_by_column varchar(50),@Sort varchar(10))        
as        
declare @str as varchar(500)        
       
set @Code = (case when @Code = 'All' or @Code = '' then 'like ''%%''' else '= '''+@Code+'''' end)  
          
set @str = case         
when @Type = 'C' then 'select *  from V_Manager_Details where Fld_Branch_cd '+@Code+' order by '+@order_by_column+' '+@Sort        
when @Type = 'N' then 'select *  from V_Manager_Details where Br_Name '+@Code+' order by '+@order_by_column+' '+@Sort        
when @Type = 'S' then 'select *  from V_Manager_Details where Fld_server'+@Code+' order by '+@order_by_column+' '+@Sort        
when @Type = 'SEG' then 'select * from V_Manager_Details where Fld_Segment '+@Code+' order by '+@order_by_column+' '+@Sort        
when @Type = 'T' then 'select * from V_Manager_Details where Fld_Manager_Id '+@Code+' order by '+@order_by_column+' '+@Sort        
end        
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_Terminal_Report1
-- --------------------------------------------------
CREATE Proc USP_Search_Terminal_Report1( @status as varchar(20),@Code as varchar(50),@Type as varchar(15),@order_by_column varchar(50),@Sort varchar(10))          
as          
declare @str as varchar(500)          
          
  set @Code = (case when @Code = 'ALL' or @Code = '' then 'like ''%%''' else '= '''+@Code+'''' end)    
set @status = (case when @status = 'ALL' or @status = '' then 'like ''%%''' else '= '''+@status+'''' end)     
              
set @str = case           
when @Type = 'C' then 'select *  from V_Manager_Details where Fld_Branch_cd '+@Code+' and Manager_status '+@status+' order by '+@order_by_column+' '+@Sort          
when @Type = 'N' then 'select *  from V_Manager_Details where Br_Name '+@Code+' and Manager_status '+@status+' order by '+@order_by_column+' '+@Sort          
when @Type = 'S' then 'select *  from V_Manager_Details where Fld_server '+@Code+' and Manager_status '+@status+' order by '+@order_by_column+' '+@Sort          
when @Type = 'SEG' then 'select * from V_Manager_Details where Fld_Segment '+@Code+' and Manager_status '+@status+' order by '+@order_by_column+' '+@Sort          
when @Type = 'T' then 'select * from V_Manager_Details where Fld_Manager_Id '+@Code+' and Manager_status '+@status+' order by '+@order_by_column+' '+@Sort          
end          
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Search_Validity_Report
-- --------------------------------------------------

CREATE Proc USP_Search_Validity_Report(@Code as varchar(50),@Type as varchar(15),@order_by_column varchar(50),@Sort varchar(10))      
as      
declare @str as varchar(500)      
      
set @Code = (case when @Code = 'All' or @Code = '' then 'like ''%%''' else '= '''+@Code+'''' end)        
      
set @str = case       
when @Type = 'C' then 'select *  from V_Manager_Cert_Validity where Fld_Branch_cd '+@Code+' order by '+@order_by_column+' '+@Sort      
when @Type = 'N' then 'select *  from V_Manager_Cert_Validity where Br_Name '+@Code+' order by '+@order_by_column+' '+@Sort      
when @Type = 'S' then 'select *  from V_Manager_Cert_Validity where Fld_server '+@Code+' order by '+@order_by_column+' '+@Sort      
when @Type = 'SEG' then 'select * from V_Manager_Cert_Validity where Fld_Segment '+@Code+' order by '+@order_by_column+' '+@Sort      
when @Type = 'T' then 'select * from V_Manager_Cert_Validity where Fld_Manager_Id '+@Code+' order by '+@order_by_column+' '+@Sort      
end      
--print @str
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_sel_mas
-- --------------------------------------------------
create proc usp_sel_mas
as
select Id,Name from OP_masterdata (nolock) order by Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Server_Brok
-- --------------------------------------------------
--USP_Server_Brok '16/07/2012','16/07/2012','ALL'
CREATE proc [dbo].[USP_Server_Brok](@fdate as varchar(11),@tdate as varchar(11),@server as varchar(20))                      
as                    
                
Declare @opt as varchar(15)                          
Declare @opt1 as varchar(15)                          
Declare @str as varchar(2000)                    
-- Declare @fdate as varchar(15)                          
-- Declare @tdate as varchar(15)                          
-- Declare @server as varchar(15)     
-- 
-- set    @fdate = 'Jun 01 2008'                  
-- set    @tdate = 'Jun 16 2008'                  
-- set 	@server = 'ALL'

                    
set @opt = (select  (case when @server = 'ALL' then 'like' else '=' end ))                                       
        
truncate table Server_Summary        
      
/*        
set @str = ('insert into Server_Summary  select server=upper(b.server),company,Delivery_TO=sum(to_del_opt),Trading_TO=sum(To_trd_fut),Delivery_brok=sum(bk_del_opt),                      
    Trading_brok=sum(bk_trd_fut),Total_brok=sum(brokerage) from intranet.bsedb_ab.dbo.mis_to_terminal a  inner join terminals  b (nolock) on a.terminal_id = b.odin_id and                     
    sauda_date >= convert(datetime,'''+@fdate+''',103) and sauda_date <= convert(datetime,'''+@tdate+''',103) and b.server '+@opt+' replace('''+@server+''',''ALL'',''%'') and company like ''%'' group by server,company order by server,company')                       
*/      
      
set @str = ('insert into Server_Summary select server=upper(b.Fld_server),company,Delivery_TO=sum(to_del_opt),Trading_TO=sum(To_trd_fut),Delivery_brok=sum(bk_del_opt),                      
Trading_brok=sum(bk_trd_fut),Total_brok=sum(brokerage) from intranet.bsedb_ab.dbo.MIS_TO a  inner join V_Manager_Details  b (nolock) on a.terminal_id = b.Fld_Manager_id and                     
sauda_date >= convert(datetime,'''+@fdate+''',103) and sauda_date <= convert(datetime,'''+@tdate+''',103) and b.Fld_Id like replace('''+@server+''',''ALL'',''%'') and company like ''%''       
and sauda_date >= sdate and sauda_date <= tdate group by Fld_server, company')              
exec (@str)                          
                
select '<a href= \kyc_tracker\frmServerReport.aspx?val=A'+'&Server='+LTrim(RTrim(replace(server,' ','_')))+'><b>'+replace(server,' ','_')+'</b></a>' as server ,                
Delivery_To=sum(Delivery_To),Trading_To=sum(Trading_To),Total_brok=sum(Total_brok)  from Server_Summary group by server 

select server as [Server] , company as [Segment],              
Delivery_To=sum(Delivery_To),Trading_To=sum(Trading_To),SUM(Delivery_brok) as [Delivery Brokerage],
[Total Brokerage]=sum(Total_brok),[Trading Brokerage]=SUM(Trading_brok)
from Server_Summary group by server,company

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Server_Brok_Bkup
-- --------------------------------------------------
CREATE proc [dbo].[USP_Server_Brok_Bkup](@fdate as varchar(11),@tdate as varchar(11),@server as varchar(20))                      
as                    
                
Declare @opt as varchar(15)                          
Declare @opt1 as varchar(15)                          
Declare @str as varchar(2000)                    
-- Declare @fdate as varchar(15)                          
-- Declare @tdate as varchar(15)                          
-- Declare @server as varchar(15)     
-- 
-- set    @fdate = 'Jun 01 2008'                  
-- set    @tdate = 'Jun 16 2008'                  
-- set 	@server = 'ALL'

                    
set @opt = (select  (case when @server = 'ALL' then 'like' else '=' end ))                                       
        
truncate table Server_Summary        
      
/*        
set @str = ('insert into Server_Summary  select server=upper(b.server),company,Delivery_TO=sum(to_del_opt),Trading_TO=sum(To_trd_fut),Delivery_brok=sum(bk_del_opt),                      
    Trading_brok=sum(bk_trd_fut),Total_brok=sum(brokerage) from intranet.bsedb_ab.dbo.mis_to_terminal a  inner join terminals  b (nolock) on a.terminal_id = b.odin_id and                     
    sauda_date >= convert(datetime,'''+@fdate+''',103) and sauda_date <= convert(datetime,'''+@tdate+''',103) and b.server '+@opt+' replace('''+@server+''',''ALL'',''%'') and company like ''%'' group by server,company order by server,company')                       
*/      
      
set @str = ('insert into Server_Summary select server=upper(b.Fld_server),company,Delivery_TO=sum(to_del_opt),Trading_TO=sum(To_trd_fut),Delivery_brok=sum(bk_del_opt),                      
Trading_brok=sum(bk_trd_fut),Total_brok=sum(brokerage) from intranet.bsedb_ab.dbo.mis_to_terminal a  inner join V_Manager_Details  b (nolock) on a.terminal_id = b.Fld_Manager_id and                     
sauda_date >= convert(datetime,'''+@fdate+''',103) and sauda_date <= convert(datetime,'''+@tdate+''',103) and b.Fld_Id like replace('''+@server+''',''ALL'',''%'') and company like ''%''       
and sauda_date >= sdate and sauda_date <= tdate group by Fld_server, company')              
exec (@str)                          
                
select '<a href= \kyc_tracker\frmServerReport.aspx?val=A'+'&Server='+LTrim(RTrim(replace(server,' ','_')))+'><b>'+replace(server,' ','_')+'</b></a>' as server ,                
Delivery_To=sum(Delivery_To),Trading_To=sum(Trading_To),Total_brok=sum(Total_brok)  from Server_Summary group by server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Server_Mapp
-- --------------------------------------------------
CREATE Proc USP_Server_Mapp(@Fld_Branch_cd varchar(15))      
as      
      
select * from tbl_server_master where Fld_id not in       
(      
select Fld_Server_id from Tbl_Server_Mapp /*where Fld_Branch_cd = @Fld_Branch_cd*/     
) and Fld_Branch_cd <> '' order by Fld_Server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Server_Master
-- --------------------------------------------------
CREATE Proc USP_Server_Master    
(   
@Fld_Id  int,
@Fld_Branch_cd	varchar(50),
@Fld_Server	varchar(50),
@Fld_Odin_Ip	varchar(50),
@Fld_DB_Ip	varchar(50)
)    
as    
  
if (select count(*) from Tbl_server_master where Fld_Server = @Fld_Server) = 1   
begin  

update Tbl_server_master set Fld_Branch_cd = @Fld_Branch_cd,Fld_Server = @Fld_Server,
Fld_Odin_Ip =@Fld_Odin_Ip,Fld_DB_Ip = @Fld_DB_Ip where Fld_Id = @Fld_Id
  
 Select 'Record Updated ' as MSG  
end  
else  
begin  

 insert into Tbl_server_master values    
 (    
	@Fld_Branch_cd,@Fld_Server,@Fld_Odin_Ip,@Fld_DB_Ip
 )     
 Select 'Record Saved ' as MSG  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Server_Shrink_Master
-- --------------------------------------------------
  
CREATE Proc Usp_Server_Shrink_Master @ServerId varchar(15),@BrCode varchar(15),@date varchar(11)        
as    
set @date =convert(datetime,@date,103)  
    
select * from       
(select * from V_Tbl_server_master(nolock) where status ='Active' and fld_id like @ServerId and fld_branch_cd<>'CMBTR' and fld_branch_cd like @BrCode)a        
left outer join(select * from tbl_DB_Shrink_Data_new(nolock) where fld_upd_date = @date) b         
on a.fld_id  = b.fld_server_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Serverwise_Performance_RPT
-- --------------------------------------------------
--USP_Serverwise_Performance_RPT 'ALL','ALL','02/07/2012','30/07/2012'
CREATE proc [dbo].[USP_Serverwise_Performance_RPT](@server as varchar(100),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))                              
as               
          
set nocount on         
                 
declare @sql as varchar(5000)                                  
declare @opt as varchar(500)                                 
declare @opt1 as varchar(500)                                       

/*
declare @fdate as varchar(11)                                  
declare @tdate as varchar(11)                                  
declare @server as varchar(500)    
declare @branch as varchar(50)                                  
                  
set @fdate = 'Jun 02 2008'                                  
set @tdate = 'Jun 30 2008'                                            
set @server = 'All'                                  
set @branch = 'All'    
*/
    
                                  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                
                
set  @opt = (select                                                        
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                                   
          
set  @opt1 = (select                                                      
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end ))               
                    
          
set @sql = 'select y.Fld_Server as server,y.br_name,issues,Fld_Branch_cd,Fld_id,dt,Total_dt,uptime,dt_per,brk_loss,Total_Brok_loss,Total_DownTime_Per,Total_Brokerage into #t from (select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,      
p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage from                  
(select z.*,v.Total_DownTime_Per from (select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from                  
(select g.Total_Brok_Loss,h.* from( select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0            
group by server)g inner join (select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from(select server,issues,dt=sum(convert(dec,dt)),                  
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues          
)e inner join( select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                   
and dt <> 0  group by server )f on e.server = f.server) h on g.server = h.server )c inner join (select a.Fld_id,uptime=sum(convert(dec,b.uptime)) from                   
(select distinct Fld_id,FLD_segment from V_Manager_Details where Fld_id in '+@opt+')a inner join (select segment,uptime from(select * from  V_Segment_Master where tdate >= '''+@fdate+''' and           
tdate <= '''+@tdate+''')x ) b on a.FLD_segment = b.segment group by a.Fld_id)d           
on c.server = d.Fld_id ) z inner join(select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from                  
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                  
inner join (select a.Fld_id as server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_id,Fld_segment from V_Manager_Details where Fld_id in '+@opt+') a inner join(           
select segment,uptime from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''') b on a.Fld_segment = b.segment group by a.Fld_id        
) uptime on dt_per.server = uptime.server) v on z.server = v.server) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where           
sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                  
on p.server = q.server) x inner join (select * from V_Server_Master (nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by y.Fld_Server;      
select Fld_Branch_cd,br_name,sum(dt_per)/count(Distinct Fld_id) as dt_per into #t1 from #t group by Fld_Branch_cd,br_name order by sum(dt_per)/count(Distinct Fld_id);
insert into #t1 select distinct Fld_Branch_cd,br_name,0 from V_Server_Master where Fld_Branch_cd not in (select Fld_Branch_cd from #t1);select * from #t1 order by dt_per'        
Print (@sql)
Exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Serverwise_Performance_RPT_New
-- --------------------------------------------------
--USP_Serverwise_Performance_RPT_New  'ALL','ALL','02/07/2012','30/07/2012'
CREATE proc [dbo].[USP_Serverwise_Performance_RPT_New](@server as varchar(100),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))                              
as               
          
set nocount on         
                 
declare @sql as varchar(5000)                                  
declare @opt as varchar(500)                                 
declare @opt1 as varchar(500)                                       

/*
declare @fdate as varchar(11)                                  
declare @tdate as varchar(11)                                  
declare @server as varchar(500)    
declare @branch as varchar(50)                                  
                  
set @fdate = 'Jun 02 2008'                                  
set @tdate = 'Jun 30 2008'                                            
set @server = 'All'                                  
set @branch = 'All'    
*/
    
                                  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                
                
set  @opt = (select                                                        
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                                   
          
set  @opt1 = (select                                                      
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end ))               
                    
          
set @sql = 

	'select y.Fld_Server as server,y.br_name,issues,Fld_Branch_cd,Fld_id,dt,Total_dt,uptime,dt_per,brk_loss,Total_Brok_loss,
	Total_DownTime_Per,Total_Brokerage into #t from (select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,      
	p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage 
	from                  
				(select z.*,v.Total_DownTime_Per from (select c.server,c.issues,c.dt,c.Total_dt,d.uptime,dt_per=(c.dt*100)/d.uptime,
				c.brk_loss,c.Total_Brok_loss 
				from                  
						(select g.Total_Brok_Loss,h.* from( select server,sum(brk_loss) as Total_Brok_Loss 
						from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0            
						group by server)g 
							inner join 
					    (select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from(select server,issues,dt=sum(convert(dec,dt)),                  
						brk_loss=convert(varchar(15),sum(brk_loss))
						from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues          
						)e inner join
						(select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                   
						and dt <> 0  group by server )f on e.server = f.server) h on g.server = h.server 
						)c inner join (select a.Fld_id,uptime=sum(convert(dec,b.uptime)) 
						from                   
						(select distinct Fld_id,FLD_segment 
						from V_Manager_Details where Fld_id in '+@opt+')a
						inner join 
						(select segment,uptime from(select * from  V_Segment_Master where tdate >= '''+@fdate+''' and           
						tdate <= '''+@tdate+''')x ) b on a.FLD_segment = b.segment group by a.Fld_id)d           
					   on c.server = d.Fld_id ) z 
					   inner join
					  (select dt_per.server,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime 
					  from                  
					  (select Server,sum(convert(int,dt)) as Total_Down_Time_Per 
					  from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                  
					  inner join
					  (select a.Fld_id as server,uptime=sum(convert(dec,b.uptime)) from (select distinct Fld_id,Fld_segment
					  from V_Manager_Details where Fld_id in '+@opt+') a 
					  inner join(           
					 select segment,uptime from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''') b 
					 on a.Fld_segment = b.segment group by a.Fld_id        
					) uptime on dt_per.server = uptime.server) v 
					on z.server = v.server) p 
					inner join
						 (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where           
						sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                  
						on p.server = q.server) x 
						inner join 
						(select * from V_Server_Master (nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by y.Fld_Server;      

select Fld_Branch_cd,br_name,sum(dt_per)/count(Distinct Fld_id) as dt_per into #t1 from #t group by Fld_Branch_cd,br_name order by sum(dt_per)/count(Distinct Fld_id);

insert into #t1 select distinct Fld_Branch_cd,br_name,0 from V_Server_Master where Fld_Branch_cd not in (select Fld_Branch_cd from #t1);
select * from #t1 order by dt_per'        
Exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Serverwise_RPT
-- --------------------------------------------------
--USP_Serverwise_RPT 'All','All','01/07/2012','18/07/2012'
CREATE proc [dbo].[USP_Serverwise_RPT](@server as varchar(100),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))                            
as             
        
set nocount on       
               
declare @sql as varchar(5000)                                
declare @opt as varchar(500)                               
declare @opt1 as varchar(500)                      
        
/*
declare @fdate as varchar(11)                                
declare @tdate as varchar(11)                                
declare @server as varchar(500)                                
declare @branch as varchar(500)                                
                

set @fdate = 'Feb 02 2010'                                
set @tdate = 'Feb 02 2010'                                          
set @server = '24'  
set @branch = 'HO'                                
*/
                                
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                        
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                              
              
set  @opt = (select                                                      
(case when @server = 'All' then '(select distinct server from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0)' else '('''+@server+''')' end ))                                 
        
set  @opt1 = (select                                                    
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end ))             
                  
        
set @sql = 'select y.Fld_Server as server,issues,Fld_Branch_cd,Fld_id,dt,Total_dt,uptime,dt_per,brk_loss,Total_Brok_loss,Total_DownTime_Per,Total_Brokerage into #t from (select upper(p.server) as server,upper(p.issues) as issues,p.dt,p.Total_dt,        
p.uptime,p.dt_per,p.brk_loss,p.Total_Brok_loss,p.Total_DownTime_Per,q.Total_Brokerage from                
(select z.*,v.Total_DownTime_Per,v.uptime from (select c.server,c.issues,c.dt,c.Total_dt,dt_per=(c.dt*100)/d.uptime,c.brk_loss,c.Total_Brok_loss from                
(select g.Total_Brok_Loss,h.* from( select server,sum(brk_loss) as Total_Brok_Loss from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0          
group by server)g inner join (select e.server,e.issues,e.dt,f.dt as Total_dt,e.brk_loss from(select server,issues,dt=sum(convert(dec,dt)),                
brk_loss=convert(varchar(15),sum(brk_loss))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and dt <> 0  group by server,issues        
)e inner join( select server,dt=sum(convert(dec,dt))from terminal_brok_loss where  sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''                 
and dt <> 0  group by server )f on e.server = f.server) h on g.server = h.server )c inner join (select a.Fld_id,uptime=sum(convert(dec,b.uptime)) from                 
(select distinct Fld_id,FLD_segment from V_Manager_Details where Fld_id in '+@opt+')a inner join (select segment,uptime from(select * from  V_Segment_Master where tdate >= '''+@fdate+''' and         
tdate <= '''+@tdate+''')x ) b on a.FLD_segment = b.segment group by a.Fld_id)d         
on c.server = d.Fld_id ) z inner join(select dt_per.server,uptime,Total_DownTime_Per=(dt_per.Total_Down_Time_Per*100)/uptime.uptime from                
(select Server,sum(convert(int,dt)) as Total_Down_Time_Per from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+'''  group by Server) dt_per                
inner join (select a.Fld_id as server,uptime=sum(convert(dec,b.uptime)) from (  
select distinct fld_id=server,fld_segment=segment from terminal_brok_loss where server in ('+@opt+') 
--and sauda_date = '''+@fdate+'''
 ) a inner join(         
select segment,uptime from V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''') b on a.Fld_segment = b.segment group by a.Fld_id        
) uptime on dt_per.server = uptime.server) v on z.server = v.server) p inner join (select server,sum(distinct Brokerage) as Total_Brokerage from terminal_brok_loss where         
sauda_date >=  '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) q                
on p.server = q.server) x inner join (select * from V_Server_Master (nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by y.Fld_Server;    
select x.*,y.max_val from(select x.*,isnull(y.min_val,0) as min_val from(select * from #t) x    
left outer join(select isnull(min(total_Downtime_per),0) as min_val from #t)y on x.total_Downtime_per = y.min_val    
) x left outer join (select distinct Fld_Id,isnull(max_val,0) as max_val from (select * from #t) x left outer join    
(select max(total_Downtime_per) as max_val from #t)y on x.total_Downtime_per = y.max_val )y on x.Fld_Id = y.Fld_Id'    
--print @sql  
    
   print (@sql)       
Exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Graph_rpt
-- --------------------------------------------------
CREATE proc USP_SHOW_Graph_rpt(@server as varchar(60),@fdate as varchar(15),@tdate as varchar(15))                                
as                  
--         
-- declare @fdate as varchar(11)        
-- declare @tdate as varchar(11)        
-- declare @server as varchar(60)        
declare @sql as varchar(2000)        
declare @opt as varchar(500)        
--         
-- set @fdate = 'Jun 11 2007'        
-- set @tdate = 'Jun 15 2007'        
-- set @server = 'All'        
        
set  @opt = (select                              
(case when @server = 'All' then 'like' else '=' end ) )         
        
-- set @sql = 'select distinct a.server,a.segment,abrokerage=sum(a.brokerage),abrk_loss=sum(a.brk_loss),uptime=sum(convert(int,a.uptime)),dt=sum(convert(int,a.dt)),b.brokerage,b.brk_loss,         
-- b.dt_per,b.uptime_per from terminal_brok_loss a (nolock) inner join (select server,brokerage=sum(brokerage),brk_loss=sum(brk_loss),         
-- dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)         
-- from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) b on a.server = b.server         
-- and a.sauda_date >= '''+@fdate+''' and a.sauda_date <= '''+@tdate+''' and ltrim(rtrim(a.server)) in (select distinct ltrim(rtrim(Location)) from newtab1         
-- where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' '''+replace(@server,'All','%')+''') group by a.server,a.segment,dt_per,uptime_per,b.brokerage,b.brk_loss order by a.server'         
--         
      
set @sql = 'select a.server,b.brokerage,b.brk_loss,         
b.dt_per,b.uptime_per from terminal_brok_loss a (nolock) inner join (select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),         
dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)         
from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) b on a.server = b.server         
and a.sauda_date >= '''+@fdate+''' and a.sauda_date <= '''+@tdate+''' and ltrim(rtrim(a.server)) in (select distinct ltrim(rtrim(Location)) from newtab1         
where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' '''+replace(@server,'All','%')+''') group by a.server,dt_per,uptime_per,b.brokerage,b.brk_loss order by a.server'         
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Report
-- --------------------------------------------------
CREATE proc uSP_SHOW_Report(@server as varchar(200),@segment as varchar(200))    
as    
    
Declare @tname as varchar(200)    
Declare @opt as varchar(15)    
Declare @opt1 as varchar(15)    
Declare @str as varchar(400)    
    
-- Declare @server as varchar(200)    
-- Declare @segment varchar(200)    
 -- set @server = 'All'    
-- set @segment = 'BSE_+_CM_+_FO'    
    
Set @tname = (Select                                                             
 (case                                                             
 when @segment = 'BSE' then '(''ABLCM'')'                                                             
 when @segment = 'NSE' then '(''ACDLCM'')'                                              
 when @segment = 'FO' then '(''ACDLFO'')'                                                                            
 when @segment = 'All_Segments' then '''%'''                                                           
 when @segment = 'ALL' then  '''%'''                            
 when @segment = 'CM' then  '(''ACDLCM'')'     
 when @segment = 'BSE_+_CM_+_FO'then  '(''ABLCM'''+','+'''ACDLCM'''+','+'''ACDLFO'')'                                                      
 when @segment = 'CM_+_FO' then  '(''ACDLCM'''+','+'''ACDLFO'')'                                              
 when @segment = 'MCX' then '(''ACPLMCX'')'                                                             
 when @segment = 'NCDEX' then '(''ACPLNCDEX'')'                                              
 when @segment = 'MCX_+_NCDEX' then  '(''ACPLMCX'''+','+'''ACPLNCDEX'')'                                                            
 when @segment = 'BSE_+__MCX_+_NCDEX' then  '(''ACPLMCX'''+','+'''ABLCM'''+','+'''ACPLNCDEX'')'                                                            
 when @segment = 'CM_+_FO_+_NCDEX' then  '(''ACDLCM'''+','+'''ACDLFO'''+','+'''ACPLNCDEX'')'                                                            
 else '''NONE''' end))       
    
    
set  @opt = (select        
(case when @server = 'All' then 'like' else '=' end ) )    
    
set  @opt1 = (select        
(case when @segment = 'All' or @segment = 'All_Segments' then 'like' else  'in' end ))    
    
--select * from Terminal_Brok_Loss where server @opt @server and segment @opt1 @tname    
set @str = ('select server,dt=(sum(convert(dec,dt))/sum(convert(dec,uptime)))*100,uptime=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100),Brk_Loss=sum(Brk_Loss),Brokerage=sum(Brokerage) from Terminal_Brok_Loss where server '+@opt+' '''+replace(@server,'All','%')+''' and segment '+@opt1+' '+@tname+'group by server')    
--print @str    
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_newrpt4
-- --------------------------------------------------
CREATE proc USP_SHOW_Terminal_newrpt4(@server as varchar(60),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))                                                      
as                                        
--                               
          
          
declare @sql as varchar(5000)                              
declare @opt as varchar(500)                              
declare @opt1 as varchar(500)           
--                               
         
/*          
declare @fdate as varchar(11)                              
declare @tdate as varchar(11)      
declare @branch as varchar(50)                            
declare @server as varchar(60)                              
         
     
          
set @fdate = 'May 31 2008'                              
set @tdate = 'May 31 2008'                              
set @branch = 'All'    
set @server = 'All'                              
*/    
    
            
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                      
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                      
                              
set  @opt = (select                                                    
(case when @server = 'All' then 'like ''%%''' else '= '''+@server+'''' end ))                               
          
set  @opt1 = (select                                                    
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end ))                               
                              
                     
set @sql = 'select distinct Fld_Server as server,segment,abrokerage,abrk_loss,uptime,dt,brokerage,brk_loss,dt_per,uptime_per from(          
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,                      
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),                      
DT=case when dt <> 0 then (sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) else 0 end,Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,                      
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))                      
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),                               
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment )a                       
inner join ( select segment,sum(uptime) as uptime from  V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment) b on a.segment = b.segment and a.server '+@opt+' group by a.server,a.segment,b.uptime ) c inner join      
  
                
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss where sauda_date >= '''+@fdate+'''                      
and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss,dt                      
) f inner join ( select c.server,Total_dt=    
case when dt <> 0 then (sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) else 0 end    
from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),                      
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),                           
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment                      
) a inner join ( select segment,sum(uptime) as uptime from  V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment ) b on a.segment = b.segment and a.server '+@opt+'group by a.server,a.segment,b.uptime ) c             
  
        
inner join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))                      
from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server                      
)d on c.server = d.server group by c.server,c.dt) g on f.server = g.server) x inner join (select * from V_Server_Master (nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by Fld_Server,segment'                    
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt
-- --------------------------------------------------
CREATE proc USP_SHOW_Terminal_rpt(@server as varchar(60),@Issues as varchar(60),@Exchanges as varchar(60),@fdate as varchar(15),@tdate as varchar(15))  
  
as  
    
Declare @opt as varchar(15)        
Declare @str as varchar(500)    
--Declare @opt1 as varchar(15)   
  
set  @opt = (select            
(case when @server = 'All'  or @Issues = 'All' or @Exchanges = 'All' then 'like' else '=' end ) )        
        
-- set  @opt1 = (select            
-- (case when @Exchanges = 'All' then 'like' else  '=' end ))     
  
set @str =  ('select server,dt=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100),brokerage=sum(distinct brokerage),brk_loss=sum(brk_loss) from   
Terminal_Brok_Loss where server '+@opt+' '''+replace(@server,'All','%')+'''and Issues '+@opt+' '''+replace(@Issues,'All','%')+''' and Exchanges '+@opt+' '''+replace(@Exchanges,'All','%')+'''and sauda_date >= '''+@fdate+'''   
and sauda_date <= '''+@tdate+''' and dt <> 0 group by server')  
exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt_
-- --------------------------------------------------
CREATE proc USP_SHOW_Terminal_rpt_(@server as varchar(60),@Issues as varchar(60),@Exchanges as varchar(60),@fdate as varchar(15),@tdate as varchar(15))  
  
as  
    
Declare @opt as varchar(15)        
Declare @str as varchar(500)    
--Declare @opt1 as varchar(15)   
  
set  @opt = (select            
(case when @server = 'All'  or @Issues = 'All' or @Exchanges = 'All' then 'like' else '=' end ) )        
        
-- set  @opt1 = (select            
-- (case when @Exchanges = 'All' then 'like' else  '=' end ))     
  
set @str =  ('select server,dt=sum(convert(int,dt)),uptime=sum(convert(int,uptime)),dt1=(sum(convert(dec,dt))/sum(convert(dec,uptime)))*100, uptime=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100),brokerage=sum(brokerage),brk_loss=sum(brk_loss) from   
Terminal_Brok_Loss where server '+@opt+' '''+replace(@server,'All','%')+'''and Issues '+@opt+' '''+replace(@Issues,'All','%')+''' and Exchanges '+@opt+' '''+replace(@Exchanges,'All','%')+'''and sauda_date >= '''+@fdate+'''   
and sauda_date <= '''+@tdate+''' and dt <> 0 group by server')  
exec (@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt1
-- --------------------------------------------------
CREATE proc USP_SHOW_Terminal_rpt1(@server as varchar(60),/*,@Issues as varchar(60),@Exchanges as varchar(60),*/@fdate as varchar(15),@tdate as varchar(15))          
          
as          
          
--       
-- Declare @server as varchar(60)      
-- Declare @Issues as varchar(60)      
-- Declare @Exchanges as varchar(60)      
-- Declare @fdate as varchar(15)      
-- Declare @tdate as varchar(15)        
Declare @opt as varchar(15)                
Declare @str as varchar(500)            
--Declare @opt1 as varchar(15)           
      
-- set @server = 'All'      
-- set @Issues = 'All'      
-- set @Exchanges = 'All'      
-- set @fdate = 'Aug 24 2006'      
-- set @tdate = 'Aug 24 2006'      
          
set  @opt = (select                    
(case when @server = 'All' then 'like' else '=' end ) )                
                
-- set  @opt1 = (select                    
-- (case when @Exchanges = 'All' then 'like' else  '=' end ))             
          
-- set @str =  ('select server,dt=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100),brokerage=sum(distinct brokerage),brk_loss=sum(brk_loss) from           
-- Terminal_Brok_Loss where server '+@opt+' '''+replace(@server,'All','%')+'''and Issues '+@opt+' '''+replace(@Issues,'All','%')+''' and Exchanges '+@opt+' '''+replace(@Exchanges,'All','%')+'''and sauda_date >= '''+@fdate+'''           
-- and sauda_date <= '''+@tdate+''' and dt <> 0 group by server')          
      
set @str =  ('select server,dt=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100),brokerage=sum(distinct brokerage),brk_loss=sum(brk_loss) from           
Terminal_Brok_Loss where server in (select distinct Location from newtab1 where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' '''+replace(@server,'All','%')+''') and sauda_date >= '''+@fdate+'''           
and sauda_date <= '''+@tdate+''' group by server order by server' )          
exec (@str)          
--print @str

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt2
-- --------------------------------------------------
CREATE proc USP_SHOW_Terminal_rpt2(@server as varchar(60),@fdate as varchar(15),@tdate as varchar(15))                              
as                
      
-- declare @fdate as varchar(11)      
-- declare @tdate as varchar(11)      
-- declare @server as varchar(60)      
declare @sql as varchar(2000)      
declare @opt as varchar(500)      
--       
-- set @fdate = 'May 01 2007'      
-- set @tdate = 'May 30 2007'      
-- set @server = 'surat'      
      
set  @opt = (select                            
(case when @server = 'All' then 'like' else '=' end ) )       
      
-- set @sql = 'select distinct a.server,a.segment,abrokerage=sum(a.brokerage),abrk_loss=sum(a.brk_loss),uptime=sum(convert(int,a.uptime)),dt=sum(convert(int,a.dt)),b.brokerage,b.brk_loss,       
-- b.dt_per,b.uptime_per from terminal_brok_loss a (nolock) inner join (select server,brokerage=sum(brokerage),brk_loss=sum(brk_loss),       
-- dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)       
-- from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) b on a.server = b.server       
-- and a.sauda_date >= '''+@fdate+''' and a.sauda_date <= '''+@tdate+''' and ltrim(rtrim(a.server)) in (select distinct ltrim(rtrim(Location)) from newtab1       
-- where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' '''+replace(@server,'All','%')+''') group by a.server,a.segment,dt_per,uptime_per,b.brokerage,b.brk_loss order by a.server'       
--       
    
set @sql = 'select a.server,a.segment,abrokerage=convert(varchar(15),sum(distinct a.brokerage)),abrk_loss=convert(varchar(15),sum(a.brk_loss)),uptime=sum(convert(int,a.uptime)),dt=sum(convert(int,a.dt)),b.brokerage,b.brk_loss,       
b.dt_per,b.uptime_per from terminal_brok_loss a (nolock) inner join (select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)       
from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) b on a.server = b.server       
and a.sauda_date >= '''+@fdate+''' and a.sauda_date <= '''+@tdate+''' and ltrim(rtrim(a.server)) in (select distinct ltrim(rtrim(Location)) from newtab1       
where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' '''+replace(@server,'All','%')+''') group by a.server,a.segment,dt_per,uptime_per,b.brokerage,b.brk_loss order by a.server'       
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt3
-- --------------------------------------------------
CREATE proc USP_SHOW_Terminal_rpt3(@server as varchar(60),@fdate as varchar(15),@tdate as varchar(15))                                          
as                            
--                   
/*  
declare @fdate as varchar(11)                  
declare @tdate as varchar(11)                  
declare @server as varchar(60)                  
*/  
declare @sql as varchar(5000)                  
declare @opt as varchar(500)                  
--                   
-- set @fdate = 'Jun 01 2007'                  
-- set @tdate = 'Jun 15 2007'                  
-- set @server = 'All'                  

set @fdate = convert(varchar(11),convert(datetime,@fdate,103))          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))          
                  
set  @opt = (select                                        
(case when @server = 'All' then 'like ''%%''' else '= '''+@server+'''' end ) )                   
                  
-- set @sql = 'select distinct a.server,a.segment,abrokerage=sum(a.brokerage),abrk_loss=sum(a.brk_loss),uptime=sum(convert(int,a.uptime)),dt=sum(convert(int,a.dt)),b.brokerage,b.brk_loss,                   
-- b.dt_per,b.uptime_per from terminal_brok_loss a (nolock) inner join (select server,brokerage=sum(brokerage),brk_loss=sum(brk_loss),                   
-- dt_per=(sum(convert(dec,dt))/sum(convert(dec, uptime)))*100, uptime_per=100-((sum(convert(dec,dt))/sum(convert(dec,uptime)))*100)                   
-- from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server) b on a.server = b.server                   
-- and a.sauda_date >= '''+@fdate+''' and a.sauda_date <= '''+@tdate+''' and ltrim(rtrim(a.server)) in (select distinct ltrim(rtrim(Location)) from newtab1                   
-- where dt >= '''+@fdate+''' and dt <= '''+@tdate+''' and Location '+@opt+' '''+replace(@server,'All','%')+''') group by a.server,a.segment,dt_per,uptime_per,b.brokerage,b.brk_loss order by a.server'                   
--                   
          
          
set @sql = 'select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,          
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),          
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,          
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))          
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),                   
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment )a           
inner join ( select segment,uptime from ( select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
) x ) b on a.segment = b.segment and a.server '+@opt+' group by a.server,a.segment,b.uptime ) c inner join          
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss where sauda_date >= '''+@fdate+'''          
and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss          
) f inner join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),          
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),               
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment          
) a inner join ( select segment,uptime from ( select ''ABLCM'' as segment, Uptime=sum(bse) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACDLCM'' as segment, sum(cm) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACDLFO'' as segment,sum(fo) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACPLMCX'' as segment, sum(mcx) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
union SELECT ''ACPLNCDEX'' as segment, sum(NCDEX) from sett_mst where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+'''          
) x ) b on a.segment = b.segment and a.server '+@opt+'group by a.server,a.segment,b.uptime ) c          
inner join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))          
from terminal_brok_loss where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server          
)d on c.server = d.server group by c.server ) g on f.server = g.server'        
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt4
-- --------------------------------------------------
CREATE proc [dbo].[USP_SHOW_Terminal_rpt4](@server as varchar(60),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))    
as
-- 
Set NoCount On      

--exec USP_SHOW_Terminal_rpt4 'ALL','ALL','Sep 01 2010','Sep 01 2010'
--exec USP_SHOW_Terminal_rpt4 'ALL','ALL','Sep 15 2010','Sep 15 2010'

declare @sql as varchar(5000)
declare @opt as varchar(500)
declare @opt1 as varchar(500) 
-- 
/*
declare @fdate as varchar(11)
declare @tdate as varchar(11)
declare @server as varchar(60)
declare @branch as varchar(60)

set @fdate = 'Jun 09 2008'
set @tdate = 'Jun 09 2008'
set @server = 'All'
set @branch = 'All'
*/
  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))  
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))  

set  @opt = (select  
(case when @server = 'All' then 'like ''%%''' else '= '''+@server+'''' end )) 

set  @opt1 = (select  
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end )) 

 
set @sql = 'select Fld_Server as server,segment,abrokerage,abrk_loss,uptime,dt,brokerage,brk_loss,dt_per,uptime_per from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment )a   
inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment) b on a.segment = b.segment and a.server '+@opt+' group by a.server,a.segment,b.uptime ) c inner merge join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss with(nolock) where sauda_date >= '''+@fdate+'''  
and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner merge join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment  
) a inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment ) b on a.segment = b.segment and a.server '+@opt+'group by a.server,a.segment,b.uptime ) c   
inner merge join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss with(nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner merge join (select * from V_Server_Master with(nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by Fld_Server,segment'

/*
/***** Modified on 30/09/2011 to take care of no data dates *****/
/***** Commented above SET SQL statement & inserted below statement *****/

set @sql = 'select server=y.Fld_server,
segment=isnull(x.segment,''''),abrokerage=isnull(x.abrokerage,0),abrk_loss=isnull(x.abrk_loss,0),
uptime=isnull(x.uptime,0),dt=isnull(dt,0),brokerage=isnull(x.brokerage,0),brk_loss=isnull(x.brk_loss,0),
dt_per=isnull(x.dt_per,0),uptime_per=isnull(x.uptime_per,0)
from(
	select upper(f.server) as server,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,
	uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,
	brk_loss=f.Total_Brok_Loss,dt_per=isnull(g.Total_dt,0),uptime_per=100-isnull(g.Total_dt,0) 
	from (
			select server=isnull(c.server,''''),c.segment,brokerage=isnull(c.brokerage,0),brk_loss=isnull(c.brk_loss,0),
			Total_uptime=sum(uptime),Total_Downtime=sum(dt),DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),
			Total_brok=isnull(d.brokerage,0),Total_Brok_Loss=isnull(d.brk_loss,0)
			from	(
					select a.server,
					b.segment,brokerage=sum(convert(dec,a.brokerage)),
					brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,isnull(a.Total_dt,0)))
					from (
							select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),
							brk_loss=convert(varchar(15),sum(brk_loss)),Total_dt=sum(convert(dec,dt)) 
							from terminal_brok_loss (nolock) 
							where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment 
						)a 
						Right Outer join ( 
							select segment,sum(uptime) as uptime from  V_Segment_Master 
							where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment
						) b on a.segment = b.segment and a.server '+@opt+' group by a.server,b.segment,b.uptime 
					) c 
			Left Outer join
				(	select server,brokerage=convert(varchar(15),sum(distinct brokerage)),
					brk_loss=convert(varchar(15),sum( brk_loss)) 
					from terminal_brok_loss where sauda_date >= '''+@fdate+'''
					and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server 
				)d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss
		) f 
	Left outer join (
					select server=isnull(c.server,''''),Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) 
					from	(
							select a.server,b.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),
							b.uptime,dt=sum(convert(int,isnull(a.Total_dt,0))) 
							from ( 	select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),
									brk_loss=convert(varchar(15),sum(brk_loss)),Total_dt=sum(convert(dec,dt)) 
									from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' 
									group by server,segment
								) a 
							Right Outer join	( select segment,sum(uptime) as uptime from  V_Segment_Master 
												where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment 
												) b on a.segment = b.segment and a.server '+@opt+'group by a.server,b.segment,b.uptime 
							) c    
						Left Outer join ( 
											select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))
											from terminal_brok_loss (nolock) 
											where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+' 
											group by server
										)d on c.server = d.server group by c.server 
					) g on f.server = g.server
) x 
RIGHT Outer join (
					select * from V_Server_Master (nolock)
				) y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+'
order by Fld_Server,segment'
*/
print (@sql)         
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt4_2Feb2012
-- --------------------------------------------------
CREATE proc [dbo].[USP_SHOW_Terminal_rpt4_2Feb2012](@server as varchar(60),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))    
as
-- 
Set NoCount On      

--exec USP_SHOW_Terminal_rpt4 'ALL','ALL','Sep 01 2010','Sep 01 2010'
--exec USP_SHOW_Terminal_rpt4 'ALL','ALL','Sep 15 2010','Sep 15 2010'

declare @sql as varchar(5000)
declare @opt as varchar(500)
declare @opt1 as varchar(500) 
-- 
/*
declare @fdate as varchar(11)
declare @tdate as varchar(11)
declare @server as varchar(60)
declare @branch as varchar(60)

set @fdate = 'Jun 09 2008'
set @tdate = 'Jun 09 2008'
set @server = 'All'
set @branch = 'All'
*/
  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))  
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))  

set  @opt = (select  
(case when @server = 'All' then 'like ''%%''' else '= '''+@server+'''' end )) 

set  @opt1 = (select  
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end )) 

 
set @sql = 'select Fld_Server as server,segment,abrokerage,abrk_loss,uptime,dt,brokerage,brk_loss,dt_per,uptime_per from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment )a   
inner join ( select segment,sum(uptime) as uptime from  V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment) b on a.segment = b.segment and a.server '+@opt+' group by a.server,a.segment,b.uptime ) c inner join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss where sauda_date >= '''+@fdate+'''  
and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment  
) a inner join ( select segment,sum(uptime) as uptime from  V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment ) b on a.segment = b.segment and a.server '+@opt+'group by a.server,a.segment,b.uptime ) c   
inner join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner join (select * from V_Server_Master (nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by Fld_Server,segment'

/*
/***** Modified on 30/09/2011 to take care of no data dates *****/
/***** Commented above SET SQL statement & inserted below statement *****/

set @sql = 'select server=y.Fld_server,
segment=isnull(x.segment,''''),abrokerage=isnull(x.abrokerage,0),abrk_loss=isnull(x.abrk_loss,0),
uptime=isnull(x.uptime,0),dt=isnull(dt,0),brokerage=isnull(x.brokerage,0),brk_loss=isnull(x.brk_loss,0),
dt_per=isnull(x.dt_per,0),uptime_per=isnull(x.uptime_per,0)
from(
	select upper(f.server) as server,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,
	uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,
	brk_loss=f.Total_Brok_Loss,dt_per=isnull(g.Total_dt,0),uptime_per=100-isnull(g.Total_dt,0) 
	from (
			select server=isnull(c.server,''''),c.segment,brokerage=isnull(c.brokerage,0),brk_loss=isnull(c.brk_loss,0),
			Total_uptime=sum(uptime),Total_Downtime=sum(dt),DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),
			Total_brok=isnull(d.brokerage,0),Total_Brok_Loss=isnull(d.brk_loss,0)
			from	(
					select a.server,
					b.segment,brokerage=sum(convert(dec,a.brokerage)),
					brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,isnull(a.Total_dt,0)))
					from (
							select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),
							brk_loss=convert(varchar(15),sum(brk_loss)),Total_dt=sum(convert(dec,dt)) 
							from terminal_brok_loss (nolock) 
							where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment 
						)a 
						Right Outer join ( 
							select segment,sum(uptime) as uptime from  V_Segment_Master 
							where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment
						) b on a.segment = b.segment and a.server '+@opt+' group by a.server,b.segment,b.uptime 
					) c 
			Left Outer join
				(	select server,brokerage=convert(varchar(15),sum(distinct brokerage)),
					brk_loss=convert(varchar(15),sum( brk_loss)) 
					from terminal_brok_loss where sauda_date >= '''+@fdate+'''
					and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server 
				)d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss
		) f 
	Left outer join (
					select server=isnull(c.server,''''),Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) 
					from	(
							select a.server,b.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),
							b.uptime,dt=sum(convert(int,isnull(a.Total_dt,0))) 
							from ( 	select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),
									brk_loss=convert(varchar(15),sum(brk_loss)),Total_dt=sum(convert(dec,dt)) 
									from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' 
									group by server,segment
								) a 
							Right Outer join	( select segment,sum(uptime) as uptime from  V_Segment_Master 
												where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment 
												) b on a.segment = b.segment and a.server '+@opt+'group by a.server,b.segment,b.uptime 
							) c    
						Left Outer join ( 
											select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))
											from terminal_brok_loss (nolock) 
											where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+' 
											group by server
										)d on c.server = d.server group by c.server 
					) g on f.server = g.server
) x 
RIGHT Outer join (
					select * from V_Server_Master (nolock)
				) y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+'
order by Fld_Server,segment'
*/
print (@sql)         
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt4_BKUP
-- --------------------------------------------------
Create proc [dbo].[USP_SHOW_Terminal_rpt4_BKUP](@server as varchar(60),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))                                                      
as                                        
--                               
Set NoCount On      
          
declare @sql as varchar(5000)                              
declare @opt as varchar(500)                              
declare @opt1 as varchar(500)           
--                               
/*          
          
declare @fdate as varchar(11)                              
declare @tdate as varchar(11)                              
declare @server as varchar(60)                              
          
          
set @fdate = 'Jun 09 2008'                              
set @tdate = 'Jun 09 2008'                              
set @server = 'All'                              
*/          
            
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                      
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                      
                              
set  @opt = (select                                                    
(case when @server = 'All' then 'like ''%%''' else '= '''+@server+'''' end ))                               
          
set  @opt1 = (select                                                    
(case when @branch = 'All' then 'like ''%%''' else '= '''+@branch+'''' end ))                               
                              
                     
set @sql = 'select Fld_Server as server,segment,abrokerage,abrk_loss,uptime,dt,brokerage,brk_loss,dt_per,uptime_per from(          
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,                      
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),                      
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,                      
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))                      
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),                               
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment )a                       
inner join ( select segment,sum(uptime) as uptime from  V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment) b on a.segment = b.segment and a.server '+@opt+' group by a.server,a.segment,b.uptime ) c inner join      
  
    
                
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss where sauda_date >= '''+@fdate+'''                      
and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss                      
) f inner join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),                      
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),                           
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' group by server,segment                      
) a inner join ( select segment,sum(uptime) as uptime from  V_Segment_Master where tdate >= '''+@fdate+''' and tdate <= '''+@tdate+''' group by segment ) b on a.segment = b.segment and a.server '+@opt+'group by a.server,a.segment,b.uptime ) c             
  
    
         
inner join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))                      
from terminal_brok_loss (nolock) where sauda_date >= '''+@fdate+''' and sauda_date <= '''+@tdate+''' and server '+@opt+' group by server                      
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner join (select * from V_Server_Master (nolock))  y on x.server = y.Fld_Id and Fld_Branch_cd '+@opt1+' order by Fld_Server,segment'                    
print (@sql)         
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHOW_Terminal_rpt4_Modified_08102011
-- --------------------------------------------------
CREATE proc [dbo].[USP_SHOW_Terminal_rpt4_Modified_08102011](@server as varchar(60),@branch as varchar(50),@fdate as varchar(15),@tdate as varchar(15))    
as
--exec USP_SHOW_Terminal_rpt4_Modified_08102011 'ALL','ALL','Sep 01 2010','Sep 15 2010' 
--exec USP_SHOW_Terminal_rpt4_Modified_08102011 'ALL','ALL','Sep 01 2011','Sep 01 2011'
--exec USP_SHOW_Terminal_rpt4_Modified_08102011 'ALL','ALL','Oct 01 2011','Oct 12 2011'
--exec USP_SHOW_Terminal_rpt4_Modified_08102011 'ALL','ALL','Oct 01 2011','Oct 01 2011'
--exec USP_SHOW_Terminal_rpt4 'ALL','ALL','Sep 15 2010','Sep 15 2010'
Set NoCount On    

BEGIN

	DECLARE @opt as varchar(500)
	DECLARE @opt1 as varchar(500) 
	DECLARE @count int
	DECLARE @count1 int
/*
	DECLARE @fdate as varchar(11)
	DECLARE @tdate as varchar(11)
	DECLARE @server as varchar(60)
	DECLARE @branch as varchar(60)

	SET @fdate = 'Sep 01 2011'
	SET @tdate = 'Sep 01 2011'
	SET @server = 'All'
	SET @branch = 'All'
*/
	  
	SET @fdate = convert(varchar(11),convert(datetime,@fdate,103))  
	SET @tdate = convert(varchar(11),convert(datetime,@tdate,103))  
	SET @opt = (select (case when @server = 'All' then '%%' else @server end )) 
	SET @opt1 = (select (case when @branch = 'All' then '%%' else @branch end )) 

	--drop table #Report
/*
    SELECT distinct Segment, Fld_Id,server=Fld_server,aBrokerage=convert(int,0),abrk_loss=convert(int,0),
	UpTime=sum(convert(decimal(10,0),isnull(uptime,0))),DT=convert(int,0),Brokerage=convert(decimal(9,2),0),
	brk_loss=convert(decimal(9,2),0),dt_per=convert(decimal(10,6),0),uptime_per=convert(decimal(10,6),0),
	Flag='N'
	INTO #Report
	FROM V_MANAGER_DETAILS with (nolock)
	Full Outer JOIN V_SEGMENT_MASTER with (nolock) ON segment=Fld_Segment
	WHERE Fld_Branch_cd like @opt1 and Fld_server like @opt	
	and V_SEGMENT_MASTER.tdate >= @fdate and V_SEGMENT_MASTER.tdate <= @tdate 
	and V_MANAGER_DETAILS.Status='Active'
	GROUP BY Fld_Id,Fld_server,segment--,uptime
*/
	SELECT DISTINCT Segment=Fld_Segment, Fld_Id,server=Fld_server,
	aBrokerage=CONVERT(MONEY,0),abrk_loss=CONVERT(MONEY,0),
	UpTime=CONVERT(DECIMAL(10,0),0),DT=CONVERT(DECIMAL(10,0),0),Brokerage=CONVERT(MONEY,0),
	brk_loss=CONVERT(MONEY,0),dt_per=CONVERT(DECIMAL(10,6),0),
	uptime_per=CONVERT(DECIMAL(10,6),0),dtper=CONVERT(DECIMAL(10,6),0),Flag='N'
	INTO #Report
	FROM V_MANAGER_DETAILS WITH (NOLOCK)
	WHERE [status] = 'Active' and Fld_Branch_cd like @opt1 and Fld_server like @opt	

	SELECT Seg=segment,upt=SUM(ISNULL(uptime,0)) 
	INTO #Rep1
	FROM V_SEGMENT_MASTER WITH (NOLOCK) 
	WHERE V_SEGMENT_MASTER.tdate >= @fdate and V_SEGMENT_MASTER.tdate <= @tdate
	GROUP BY segment

	UPDATE #Report SET UpTime = upt FROM #Rep1 WITH (NOLOCK) WHERE Segment = Seg
	
	SELECT @Count=COUNT(*) FROM TERMINAL_BROK_LOSS with (nolock) 
	WHERE Sauda_date >= @fdate and Sauda_date <= @tdate

	IF @count > 0
	BEGIN
	--	drop table #A
		SELECT server,seg=segment,brokerage=sum(distinct brokerage),brk_loss=sum(brk_loss),Total_dt=sum(convert(dec,dt))
		INTO #A
		FROM TERMINAL_BROK_LOSS with (nolock) 
		WHERE sauda_date >= @fdate and sauda_date <= @tdate group by server,segment 

		UPDATE #Report SET DT=#A.Total_dt,aBrokerage=round(#A.brokerage,0),abrk_loss=round(#A.brk_loss,0),Flag='Y'
		FROM #A WHERE #A.server=Fld_id and seg=segment
		
	--	drop table #AA
		SELECT server,brokerage=round(sum(distinct brokerage),2),brk_loss=round(sum(brk_loss),2)
		INTO #AA
		FROM TERMINAL_BROK_LOSS with (nolock) 
		WHERE sauda_date >= @fdate and sauda_date <= @tdate group by server
		
		--convert(varchar(15),
		--	SELECT server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss))
		--INTO #AA
		--FROM TERMINAL_BROK_LOSS with (nolock) 
		--WHERE sauda_date >= @fdate and sauda_date <= @tdate group by server
		
		UPDATE #Report SET Brokerage=#AA.brokerage,brk_loss=#AA.brk_loss
		FROM #AA WHERE #AA.server=Fld_id
		
		SELECT serv_Name=Fld_Id,Total_DT=SUM(DT),Total_Uptime=SUM(Uptime)
		INTO #AAA
		FROM #Report with (nolock) where Flag ='Y' group by Fld_Id
		
		UPDATE #Report SET dt_per = round(Total_DT*100/Total_Uptime,6)
		from #AAA where Fld_Id = serv_Name and Total_Uptime <> 0
	END
	ELSE
	BEGIN
		SELECT serv_Name=Fld_Id,Total_DT=SUM(DT),Total_Uptime=SUM(Uptime)
		INTO #AAAA
		FROM #Report with (nolock) group by Fld_Id
		
		UPDATE #Report SET dt_per = round(Total_DT*100/Total_Uptime,6)
		from #AAAA where Fld_Id = serv_Name and Total_Uptime <> 0
	END

	UPDATE #Report SET uptime_per=convert(decimal(10,6),100)-convert(decimal(10,6),dt_per)
	---- Added 31/10/2011
	UPDATE #Report SET dtper = (case when uptime > 0 then dt*100/uptime else 0 end)
		
	SELECT @count1=COUNT(*) from #Report with (nolock) where Flag ='Y'

	IF @count > 0
	BEGIN
        SELECT server,segment,aBrokerage,abrk_loss,uptime,dt,dtper,brokerage,brk_loss,dt_per,uptime_per
		FROM #Report with (nolock) where Flag = 'Y'
	order by server,segment
	END
	ELSE
	BEGIN
        SELECT server,segment,aBrokerage,abrk_loss,uptime,dt,dtper,brokerage,brk_loss,dt_per,uptime_per
		FROM #Report with (nolock) order by server,segment
	END

--Set NoCount off
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SHRINKDATACENTER_BIND
-- --------------------------------------------------
CREATE PROC USP_SHRINKDATACENTER_BIND(@tdate as varchar(25))   
as   
(select Sr_No,upper(Br_Name+'-'+Br_Tag) as br_name,br_tag from tbl_it_br_master   
where br_type = 'DATACENTER')  
UNION  
(select Sr_No,upper(Br_Name+'-'+Br_Tag) as br_name,br_tag from tbl_it_br_master   
where fdate >= convert(datetime,'01/01/1900',103) and tdate > convert(datetime,@tdate,103))  
 order by br_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_STATUS
-- --------------------------------------------------
CREATE PROC USP_STATUS
(
	@REGION VARCHAR(30),
	@STATUS VARCHAR(20)
)
AS
BEGIN
select A.cOMPLAINT_ID,C.DEPT_NAME from tbl_complaint A INNER JOIN 
intranet.risk.dbo.region B ON A.ACCESS_CODE=B.CODE
INNER JOIN DEPARTMENT_MASTER C ON A.DEPT_ID=C.DEPT_ID
where status=@STATUS AND REGION=@REGION
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_status_count
-- --------------------------------------------------
CREATE proc usp_status_count          
(          
@username  varchar(10),          
@branch_code varchar(100)          
)            
as                      
select sr_num=max(sr_num),complaint_id  into #t                      
 from tbl_complaint where dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username)                
and                 
complaint_date >= CONVERT(VARCHAR(25),DATEADD(dd,-(DAY(getdate())-1),getdate()),101) AND                 
complaint_date <=convert(datetime,convert(varchar,GETDATE(),103),103)+' 23:59:59.989'            
and Access_Code like '%%'            
group by complaint_id                      
        
select Total=count(*) from tbl_complaint  where                     
sr_num in (select sr_num from #t) and status like '%%'                     
                      
select HOLD=count(*)  from tbl_complaint  where                     
 sr_num in (select sr_num from #t) and status='H'                      
                      
select Pending=count(*) from tbl_complaint where                    
sr_num in(select sr_num from #t) and status='P' 
                      
select InProcess=count(*)  from tbl_complaint  where                    
 sr_num in (select sr_num from #t) and status in('IP','F')     
           
select Completed=count(*)  from tbl_complaint  where                    
sr_num in (select sr_num from #t) and status='BC'   
  
select CSOCompleted=count(*)  from tbl_complaint  where                    
sr_num in (select sr_num from #t) and status='C'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_status_count1
-- --------------------------------------------------
CREATE proc usp_status_count1      
(@username  varchar(10),      
@fdate varchar(11),@tdate varchar(11),      
@Branch_code varchar(100)      
)        
as                  
select sr_num=max(sr_num),complaint_id  into #td                  
 from tbl_complaint where dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username)            
and             
complaint_date >=convert(datetime,@fdate,103) AND             
complaint_date <=convert(datetime,@tdate,103)+' 23:59:59.989'           
and Access_code like @Branch_code        
group by complaint_id                  
              
select Total=count(*) from tbl_complaint  where                 
dept_id in(select fld_DeptId from tbl_dept_mapping(nolock)                 
where Fld_EmpId=@username)            
and sr_num in (select sr_num from #td) and status like '%%'                  
                  
select HOLD=count(*)  from tbl_complaint  where                 
dept_id in(select fld_DeptId from tbl_dept_mapping(nolock)                 
where Fld_EmpId=@username)            
and sr_num in (select sr_num from #td) and status='H'                  
                  
select Pending=count(*)  from tbl_complaint where                
 dept_id in(select fld_DeptId from tbl_dept_mapping(nolock)                 
where Fld_EmpId=@username)            
and sr_num in(select sr_num from #td) and status='P'                  
                  
select InProcess=count(*)  from tbl_complaint  where                
 dept_id in(select fld_DeptId from tbl_dept_mapping(nolock)                
 where Fld_EmpId=@username)            
and sr_num in (select sr_num from #td) and status in('IP','F')                  
                
select Completed=count(*)  from tbl_complaint  where                
 dept_id in(select fld_DeptId from tbl_dept_mapping(nolock)                
 where Fld_EmpId=@username)            
and sr_num in (select sr_num from #td) and status='BC'

select InProcess=count(*)  from tbl_complaint  where                
 dept_id in(select fld_DeptId from tbl_dept_mapping(nolock)                
 where Fld_EmpId=@username)            
and sr_num in (select sr_num from #td) and status ='C'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_status_display
-- --------------------------------------------------
CREATE proc usp_status_display(@username  varchar(10),@status varchar(10),@fdate varchar(11),@tdate varchar(11))       
as   

create table #t1(sr_num int,complaint_id varchar(15))  
  
if @fdate='' and @tdate=''  
begin  
insert into #t1  
select sr_num=max(sr_num),complaint_id        
 from tbl_complaint where dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username)      
group by complaint_id      
end   
else  
begin  
insert into #t1  
select sr_num=max(sr_num),complaint_id       
 from tbl_complaint where dept_id in(select fld_DeptId from tbl_dept_mapping(nolock) where Fld_EmpId=@username)   
and Complaint_Date >= convert(datetime,@fdate,103) and Complaint_Date <= convert(datetime,@tdate,103)+' 23:59:59.989'     
group by complaint_id   
end  
  
if @status='%%'  
begin       
select * from V_OpsStatus  where   sr_num in      
(select sr_num from #t1) and stat_flag like '%%'  
end      
  
if @status='H'  
begin      
select *  from V_OpsStatus  where  sr_num in      
(select sr_num from #t1) and stat_flag='H'      
end  
  
if @status='p'  
begin      
select *  from V_OpsStatus where  sr_num in      
(select sr_num from #t1) and stat_flag='P'      
end  
  
if @status='IP'  
begin      
select *  from V_OpsStatus  where  sr_num in      
(select sr_num from #t1) and stat_flag in('IP','F','C')      
end  
  
if @status='BC'  
begin    
select *  from V_OpsStatus  where  sr_num in      
(select sr_num from #t1) and stat_flag='BC'  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Statuswise_OHDReport
-- --------------------------------------------------
CREATE proc USP_Statuswise_OHDReport    
(    
@username as varchar(50),    
@status as varchar(50),    
@fdate as varchar(50),    
@tdate as varchar(50)    
)    
as    
    
declare @sql as varchar(5000)  
  
if @status = 'IP'  
begin  
set @status = 'stat_flag in' +(Select '(''IP'',''F'',''C'')')  
end  
else  
begin  
set @status = 'stat_flag like' +(Select ''''+@status+'''')  
end  
  
if @fdate = '' or @tdate = ''    
begin    
  
set @sql='select * from V_OpsStatus (nolock) where    
dept_id in(select fld_deptid from tbl_dept_mapping (nolock)   
where fld_empID='''+@username+'''  
) and '+@status+'  
order by complaint_date'  
exec (@sql)  
  
end    
else    
begin    
  
set @sql='select * from V_OpsStatus (nolock) where    
dept_id in(select fld_deptid from tbl_dept_mapping (nolock) where     
fld_empID='+@username+')  
and '+@status+'  
and complaint_date >= '+@fdate+' and complaint_date <= '+@tdate+'  
order by complaint_date'  
--print @sql
exec (@sql)
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_stud_demo
-- --------------------------------------------------
CREATE proc usp_stud_demo
(
@flag as int,
@id as int,
@name as varchar(20)
)
as
if @flag=1
begin
update stud_demo set name=@name where id like @id
end
else if @flag=0
begin  
insert into stud_demo values(@id,@name)
end
else 
begin
select name from stud_demo where id=@id
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Subject_insert
-- --------------------------------------------------
CREATE proc usp_Subject_insert  
(       
 @fld_dep_id varchar(3)  ,
 @fld_queryid varchar(3),
 @subject varchar(100),   
 @Mandatoryrequirement varchar(200)      
 )    
as      
begin      
insert into tbl_subject14  values (@fld_dep_id,@fld_queryid,@subject, @Mandatoryrequirement,'N')  
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_TB_SendMail
-- --------------------------------------------------
Create Proc Usp_TB_SendMail
(
@Requestid as varchar(25)
)
as
select distinct b.email from 
(Select * from Travelbooking) a 
left outer join 
(select emp_no,email from intranet.risk.dbo.emp_info)b
on a.hod=b.emp_no
where complaint_id=@Requestid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Tbl_Attach
-- --------------------------------------------------

CREATE Proc Usp_Tbl_Attach (@EmpCode Varchar(20),@Attach image,@Type varchar(10),@FName Varchar(20))    
as    
  
insert into tbl_attach values ('',@EmpCode,@Attach,@Type,@FName)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_tbl_Call_Note
-- --------------------------------------------------
CREATE proc USP_tbl_Call_Note
(
@Fld_Date varchar(11),
@Fld_Remark varchar(500)
)
as

set @Fld_Date = convert(datetime,@Fld_Date,103)

if (select count(*) from tbl_Call_Note (nolock) where Fld_Date = @Fld_Date) = 0
begin
	insert into tbl_Call_Note values (@Fld_Date,@Fld_Remark)
end
else
begin
	update tbl_Call_Note set Fld_Remark = @Fld_Remark where Fld_Date = @Fld_Date
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_tbl_call_rpt
-- --------------------------------------------------
CREATE Proc USP_tbl_call_rpt      
(      
/*@Fld_SrNo int,*/      
@Fld_Gateway_ip varchar(15),    
@Fld_Call_Type char(1),    
@Fld_Dealer_Name varchar(50),    
@Fld_First_Confirmation varchar(15),    
@Fld_First_Frq varchar(15),    
@Fld_First_Entered_By varchar(15),    
@Fld_Second_Confirmation varchar(15),    
@Fld_Second_Frq varchar(15),    
@Fld_Second_Entered_By varchar(15),    
@Fld_Upd_date varchar(11),  
@Fld_Upd_By varchar(11)    
)      
as      
      
set @Fld_Upd_date = convert(varchar(11),convert(datetime,@Fld_Upd_date,103))  
  
if (select count(*) from tbl_call_rpt (nolock) where Fld_Gateway_ip =@Fld_Gateway_ip and Fld_Upd_date = @Fld_Upd_date) = 0    
  
Begin      
 insert into tbl_call_rpt values      
 (      
 @Fld_Gateway_ip,      
 @Fld_Call_Type,      
 @Fld_Dealer_Name,    
 @Fld_First_Confirmation,      
 @Fld_First_Frq,      
 @Fld_First_Entered_By,      
 @Fld_Second_Confirmation,      
 @Fld_Second_Frq,      
 @Fld_Second_Entered_By,      
 @Fld_Upd_date,  
 @Fld_Upd_By      
 )   
  
 Select 'Record Saved !' as msg     
End  
Else  
Begin  
 update tbl_call_rpt set   
 Fld_Gateway_ip = @Fld_Gateway_ip,      
 Fld_Call_Type = @Fld_Call_Type,      
 Fld_Dealer_Name = @Fld_Dealer_Name,    
 Fld_First_Confirmation = @Fld_First_Confirmation,      
 Fld_First_Frq = @Fld_First_Frq,      
 Fld_First_Entered_By = @Fld_First_Entered_By,      
 Fld_Second_Confirmation = @Fld_Second_Confirmation,      
 Fld_Second_Frq = @Fld_Second_Frq,      
 Fld_Second_Entered_By = @Fld_Second_Entered_By   
 where Fld_Gateway_ip =@Fld_Gateway_ip and Fld_Upd_date = @Fld_Upd_date  
   
 Select 'Record Updated !' as msg     
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_tbl_IT_Staff
-- --------------------------------------------------
CREATE Proc USP_tbl_IT_Staff      
(      
@Fld_Emp_No varchar(15),      
@Fld_Emp_Name varchar(100),      
@Fld_Phone varchar(50),      
@Fld_JoinDate varchar(11),      
@Fld_emailadd varchar(50),      
@Fld_DeptId int,      
@Fld_Branch_Id int,      
@Fld_Status char(1),      
@Fld_EmpType varchar(15)      
)      
as      
  
  
set @Fld_JoinDate = convert(datetime,@Fld_JoinDate,103)  
  
      
if (select count(*) from V_IT_Staff_Rpt_New where Emp_No = @Fld_Emp_No) = 0      
Begin      
 insert into tbl_IT_Staff values      
 (      
 @Fld_Emp_No,      
 @Fld_Emp_Name,      
 @Fld_Phone,      
 @Fld_JoinDate,      
 @Fld_emailadd,      
 @Fld_DeptId,      
 @Fld_Branch_Id,      
 @Fld_Status,      
 @Fld_EmpType,      
 getdate()      
 )      
       
 select 'Record Saved !' as Msg      
End      
else if (select count(*) from tbl_IT_Staff (nolock) where Fld_Emp_No = @Fld_Emp_No) = 0      
Begin      
 insert into tbl_IT_Staff (Fld_Emp_No,Fld_Phone,Fld_emailadd,Fld_Branch_Id,Fld_Upd_date)values      
 (      
 @Fld_Emp_No,       
 @Fld_Phone,      
 @Fld_emailadd,      
 @Fld_Branch_Id,      
 getdate()      
 )      
      
 select 'Record Updated !' as Msg      
End      
else      
Begin      
 update tbl_IT_Staff set      
 Fld_Phone = @Fld_Phone,       
 Fld_emailadd = @Fld_emailadd,      
 Fld_Branch_Id = @Fld_Branch_Id where Fld_Emp_No = @Fld_Emp_No      
      
 select 'Record Updated !' as Msg      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_tbl_IT_Staff_Test
-- --------------------------------------------------
  
  
CREATE Proc [dbo].[USP_tbl_IT_Staff_Test]          
(          
@Fld_Emp_No as varchar(15),          
@Fld_Emp_Name as  varchar(50),          
@Fld_Phone as varchar(50),          
@Fld_JoinDate as varchar(11),          
@Fld_emailadd as varchar(50),          
@Fld_DeptId as int,          
@Fld_Branch_Id as int,          
@Fld_Status as char(1),          
@Fld_EmpType as varchar(15),    
@Option as varchar(20)   
)          
as          
      
      
Set @Fld_JoinDate = convert(datetime,@Fld_JoinDate,103)      
      
                
Begin     
  If(@Option = '1')  
    Begin  
       Insert Into tbl_IT_Staff values          
         (          
             @Fld_Emp_No,          
             @Fld_Emp_Name,          
             @Fld_Phone,          
             @Fld_JoinDate,          
             @Fld_emailadd,          
             @Fld_DeptId,          
             @Fld_Branch_Id,          
             @Fld_Status,          
             @Fld_EmpType,          
             getdate()          
            )        
    End       
  Else If(@Option = '2')  
     Begin  
        Update tbl_IT_Staff set          
                   Fld_Phone = @Fld_Phone,           
                   Fld_emailadd = @Fld_emailadd,          
                   Fld_Branch_Id = @Fld_Branch_Id where Fld_Emp_No = @Fld_Emp_No          
     End    
  Else If(@Option = 'Add')  
     Begin  
         Select * from tbl_IT_Staff where Fld_Emp_No=@Fld_Emp_No  
     End  
  Else If(@Option = '3')  
     Begin  
         Select Vlms.[EMP No] as Emp_no, Vlms.Emp_Name as Emp_Name,   
              (case when Vlms.Phone <> '' then Vlms.Phone else '' End) as Phone ,  Designation as DesgJobDesc,  
              convert(varchar(12),Vlms.[Join Date]) as Joindate, Vlms.emailadd as emailadd, Vlms.Designation , Br.Br_Name as Branch ,  
              (Case when vlms.Status  = 'A' Then 'Active' Else 'Disabled' End) as [Status]  
          From VLMSInhouse  Vlms , Tbl_IT_Br_Master Br   
          where  Vlms.CostCode = Br.Br_Tag  and [EMP No]=@Fld_Emp_No  
            
           Select  br_name, Sr_no  from tbl_it_br_master(nolock)  
       Where Br_Tag  in    
                     (Select costcode from VLMSInhouse  
                            Where  [EMP No] = @Fld_Emp_No)  
                              
           Select Jobdesc , JobDesCid  from [MIDDLEWARE].harmony.dbo.jobdescriptionmaster  
     Where Jobdesc in   
                     (Select designation from VLMSInhouse   
                      where   [EMP No] = @Fld_Emp_No)    
     End  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Tbl_IT_Wanlink_Data
-- --------------------------------------------------




CREATE Proc USP_Tbl_IT_Wanlink_Data
(
@Fld_Id int,
@Fld_Link char(1),
@Fld_Connectivity_Type varchar(50),
@Fld_Chk_Id varchar(50),
@Fld_Provider varchar(50),
@Fld_BandWidth Varchar(50),
@Fld_Purpose varchar(50),
@Fld_CSO varchar(50),
@Fld_Branch Varchar(50),
@Fld_Entry_By varchar(50),
@Fld_Status char(1),
@Fld_Type varchar(50)
)
as
                  
--if (select count(*) from Tbl_IT_Wanlink_Data where Fld_id = @Fld_id) = 0                  
                  
Begin                  

DECLARE @COUNT INT
DECLARE @COUNT1 INT

	IF @Fld_id = ''
		BEGIN
		SELECT @COUNT = COUNT(*) From Tbl_IT_Wanlink_Data where Fld_Chk_Id = @Fld_Chk_Id
		IF @COUNT > 0
		BEGIN
			select 'Circuit ID Already exists !' as  Msg  
		END
		ELSE
		BEGIN
			insert into Tbl_IT_Wanlink_Data Values 
			(
			@Fld_Link,
			@Fld_Connectivity_Type,
			@Fld_Chk_Id,       
			@Fld_Provider,
			@Fld_BandWidth,
			@Fld_Purpose,
			@Fld_CSO,
			@Fld_Branch,
			@Fld_Entry_By,
			getdate(),
			@Fld_Status,
			@Fld_Type,
			'Active',
			'2049-12-30 14:20:49.483'
			)
			 SET @Fld_id = @@identity
			 select 'Record Saved !' as  Msg	
		END
		END
	ELSE
		BEGIN
			update Tbl_IT_Wanlink_Data set                  
			Fld_Link = @Fld_Link,
			Fld_Connectivity_Type = @Fld_Connectivity_Type,
			Fld_Chk_Id = @Fld_Chk_Id,
			Fld_Provider = @Fld_Provider,
			Fld_BandWidth = @Fld_BandWidth,
			Fld_Purpose = @Fld_Purpose,
			Fld_CSO = @Fld_CSO,
			Fld_Branch = @Fld_Branch,
			Fld_Entry_By = @Fld_Entry_By,
			Fld_Entry_Date = getdate(),
			Fld_Status =@Fld_Status,
			Fld_Type = @Fld_Type,
			InactiveDate =Case WHEN @Fld_Status ='U' THEN '2049-12-30 14:20:49.483' ELSE GETDATE() END
			where Fld_id = @Fld_id 		
			select 'Record Updated !' as  Msg
		END
	End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Tbl_Tcp_Count
-- --------------------------------------------------
CREATE Proc [dbo].[USP_Tbl_Tcp_Count]                            
(                            
@Fld_Branch_Code char(50),                            
@Fld_Server_Id varchar(15),                            
@Fld_Tcp_1015 int,                            
@Fld_Tcp_0115 int,                            
@Fld_Tcp_0315 int,                            
@Fld_Sur_Cnt int,                            
@Fld_Remark varchar(200),                            
@Fld_FldDate datetime,                            
@Fld_Flag char(2),                
@Fld_Upd_By varchar(15)                            
)                            
as        
Begin                          
                          
 Begin tran                           
                          
/*                        
if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate) = 1                          
begin                           
 delete from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate                          
end                           
*/                        
declare @count int                        
 if(@Fld_Branch_Code='DHO')
 Begin
 set @Fld_Server_Id =                    
 case                   
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'AS' then right(@Fld_Server_Id,1)                      
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'A' then right(@Fld_Server_Id,2)                        
 when len(@Fld_Server_Id) = 4 and @Fld_Flag = 'AS' then right(@Fld_Server_Id,2) 
 when len(@Fld_Server_Id) = 4 then right(@Fld_Server_Id,3)                      
 when len(@Fld_Server_Id) = 2 then right(@Fld_Server_Id,1)                      
 end                   
 End
 else
 Begin
 set @Fld_Server_Id =                    
 case                   
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'AS' then right(@Fld_Server_Id,1)                      
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'A' then right(@Fld_Server_Id,2)                      
 when len(@Fld_Server_Id) = 4 then right(@Fld_Server_Id,2)                      
 when len(@Fld_Server_Id) = 2 then right(@Fld_Server_Id,1)                      
 end                   
 End                 
                      
--                       
-- print @Fld_Server_Id                      
-- print @Fld_Flag                      
 --         
         
 if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate and Fld_Server_Id=@Fld_Server_Id and Fld_Flag=@Fld_Flag) =0                   
 Begin    
     insert into Tbl_Tcp_Count values                             
   (                            
   @Fld_Branch_Code,                            
   @Fld_Server_Id,                      
   @Fld_Tcp_1015,                            
   @Fld_Tcp_0115,                            
   @Fld_Tcp_0315,                            
   @Fld_Sur_Cnt,                            
   @Fld_Remark,                            
   @Fld_FldDate,                            
   getdate(),                            
   @Fld_Flag,                            
   @Fld_Upd_By                
   )       
                 
   update Tbl_IT_Reports_details set Fld_upd_date = getdate(),                
   Fld_Upd_By = @Fld_Upd_By,Fld_Status = 'C'                 
   where Fld_Status = 'P' and Fld_Br_Code = @Fld_Branch_Code and                 
   convert(varchar(11),Fld_Fet_Date) = convert(varchar(11),getdate()) and Fld_Id = 1     
      
      --Select * from  Tbl_Tcp_Count_Log from Tbl_Tcp_Count     
      insert into Tbl_Tcp_Count_Log values                             
   (                            
   @Fld_Branch_Code,                            
   @Fld_Server_Id,                      
   @Fld_Tcp_1015,                            
   @Fld_Tcp_0115,                            
   @Fld_Tcp_0315,                            
   @Fld_Sur_Cnt,                            
   @Fld_Remark,                            
   @Fld_FldDate,                            
   getdate(),                            
   @Fld_Flag,                            
   @Fld_Upd_By                
   )     
  End    
    
if (select usertype from intranet.risk.dbo.user_login with(nolock) where username=@Fld_Upd_By) = 'ADMIN'       
Begin                
    update Tbl_Tcp_Count                
    set Fld_Tcp_1015 = @Fld_Tcp_1015,Fld_Tcp_0115 = @Fld_Tcp_0115,Fld_Tcp_0315 = @Fld_Tcp_0315,                
        Fld_Sur_Cnt =@Fld_Sur_Cnt,Fld_Remark = @Fld_Remark,Fld_SysDate=GETDATE() ,Fld_EmpCode  =@Fld_Upd_By     
 where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate and Fld_Server_Id=@Fld_Server_Id and Fld_Flag=@Fld_Flag    
     
      
End         
                   
 if @@ERROR <> 0                          
 begin                          
  rollback tran                          
 end                          
 else                          
 begin                          
  commit                          
 end       
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Tbl_Tcp_Count_5AUGBKUP
-- --------------------------------------------------
--Exec USP_Tbl_Tcp_Count 'YA','A43','64','','70','17138','','8/4/2011 12:00:00 AM','A ','E30252'
--select * from Tbl_Tcp_Count
Create Proc [dbo].[USP_Tbl_Tcp_Count_5AUGBKUP]                        
(                        
@Fld_Branch_Code char(50),                        
@Fld_Server_Id varchar(15),                        
@Fld_Tcp_1015 int,                        
@Fld_Tcp_0115 int,                        
@Fld_Tcp_0315 int,                        
@Fld_Sur_Cnt int,                        
@Fld_Remark varchar(200),                        
@Fld_FldDate datetime,                        
@Fld_Flag char(2),            
@Fld_Upd_By varchar(15)                        
)                        
as    
Begin                      
                      
 Begin tran                       
                      
/*                    
if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate) = 1                      
begin                       
 delete from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate                      
end                       
*/                    
 declare @count int                    
 set @Fld_Server_Id =                
 case               
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'AS' then right(@Fld_Server_Id,1)                  
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'A' then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 4 then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 2 then right(@Fld_Server_Id,1)                  
 end               
              
                  
--                   
-- print @Fld_Server_Id                  
-- print @Fld_Flag                  
 --     
select @count=count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate         
if @count >= 1            
Begin        
    if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@Fld_Upd_By) = 'ADMIN'
     Begin  
		 Update Tbl_Tcp_Count set
		 Fld_Tcp_1015 =@Fld_Tcp_1015  , Fld_Tcp_0315 =@Fld_Tcp_0315,
		 Fld_Sur_Cnt=@Fld_Sur_Cnt ,Fld_Remark =@Fld_Remark , fld_EmpCode=@Fld_Upd_By
		 where Fld_Branch_Code=@Fld_Branch_code 
		 and Fld_FldDate=@Fld_Flddate 
		 and Fld_Server_Id=@Fld_Server_Id
		 
		 select Fld_Server_Id from Tbl_Tcp_Count where 
		 Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate  and Fld_Server_Id=@Fld_Server_Id
     End
End
Else
Begin
   if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@Fld_Upd_By) = 'ADMIN'
   Begin   
     Insert into Tbl_Tcp_Count values                         
	  (                        
	  @Fld_Branch_Code,                        
	  @Fld_Server_Id,                  
	  @Fld_Tcp_1015,                        
	  @Fld_Tcp_0115,                        
	  @Fld_Tcp_0315,                        
	  @Fld_Sur_Cnt,                        
	  @Fld_Remark,                        
	  @Fld_FldDate,                        
	  getdate(),                        
	  @Fld_Flag,                        
	  @Fld_Upd_By            
	  )   
             
	  Update Tbl_IT_Reports_details set Fld_upd_date = getdate(),            
	  Fld_Upd_By = @Fld_Upd_By,Fld_Status = 'C'             
	  where Fld_Status = 'P' and Fld_Br_Code = @Fld_Branch_Code and             
	  convert(varchar(11),Fld_Fet_Date) = convert(varchar(11),getdate()) and Fld_Id = 1 
  
      --Select 'Insert'  
   End 
 Else
    Begin
		insert into Tbl_Tcp_Count values                         
		(                        
		@Fld_Branch_Code,                        
		@Fld_Server_Id,                  
		@Fld_Tcp_1015,                        
		@Fld_Tcp_0115,                        
		@Fld_Tcp_0315,                        
		@Fld_Sur_Cnt,                        
		@Fld_Remark,                        
		@Fld_FldDate,                        
		getdate(),                        
		@Fld_Flag,                        
		@Fld_Upd_By            
		)   
		 
		update Tbl_IT_Reports_details set Fld_upd_date = getdate(),            
		Fld_Upd_By = @Fld_Upd_By,Fld_Status = 'C'             
		where Fld_Status = 'P' and Fld_Br_Code = @Fld_Branch_Code and             
		convert(varchar(11),Fld_Fet_Date) = convert(varchar(11),getdate()) and Fld_Id = 1 

    End  
End          

               
 if @@ERROR <> 0                      
 begin                      
  rollback tran                      
 end                      
 else                      
 begin                      
  commit                      
 end   
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Tbl_Tcp_Count_BKUP5AUG
-- --------------------------------------------------
--Exec USP_Tbl_Tcp_Count 'YA','A43','64','','70','17138','','8/4/2011 00:00:00 AM','A ','E30252'

CREATE Proc [dbo].[USP_Tbl_Tcp_Count_BKUP5AUG]                        
(                        
@Fld_Branch_Code char(50),                        
@Fld_Server_Id varchar(15),                        
@Fld_Tcp_1015 int,                        
@Fld_Tcp_0115 int,                        
@Fld_Tcp_0315 int,                        
@Fld_Sur_Cnt int,                        
@Fld_Remark varchar(200),                        
@Fld_FldDate datetime,                        
@Fld_Flag char(2),            
@Fld_Upd_By varchar(15)                        
)                        
as    
Begin                      
                      
 Begin tran                       
                      
/*                    
if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate) = 1                      
begin                       
 delete from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate                      
end                       
*/                    
 declare @count int                    
 set @Fld_Server_Id =                
 case               
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'AS' then right(@Fld_Server_Id,1)                  
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'A' then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 4 then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 2 then right(@Fld_Server_Id,1)                  
 end               
              
                  
--                   
-- print @Fld_Server_Id                  
-- print @Fld_Flag                  
 --     
     
 if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate and Fld_Server_Id=@Fld_Server_Id and Fld_Flag=@Fld_Flag) =0               
 Begin
     insert into Tbl_Tcp_Count values                         
	  (                        
	  @Fld_Branch_Code,                        
	  @Fld_Server_Id,                  
	  @Fld_Tcp_1015,                        
	  @Fld_Tcp_0115,                        
	  @Fld_Tcp_0315,                        
	  @Fld_Sur_Cnt,                        
	  @Fld_Remark,                        
	  @Fld_FldDate,                        
	  getdate(),                        
	  @Fld_Flag,                        
	  @Fld_Upd_By            
	  )   
             
	  update Tbl_IT_Reports_details set Fld_upd_date = getdate(),            
	  Fld_Upd_By = @Fld_Upd_By,Fld_Status = 'C'             
	  where Fld_Status = 'P' and Fld_Br_Code = @Fld_Branch_Code and             
	  convert(varchar(11),Fld_Fet_Date) = convert(varchar(11),getdate()) and Fld_Id = 1 
  
               
  End



               
 if @@ERROR <> 0                      
 begin                      
  rollback tran                      
 end                      
 else                      
 begin                      
  commit                      
 end   
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Tbl_Tcp_Count_BKUP8AUG
-- --------------------------------------------------
--Exec USP_Tbl_Tcp_Count 'YA','A43','64','','70','17138','','8/4/2011 12:00:00 AM','A ','E30252'
--select * from Tbl_Tcp_Count
CREATE Proc [dbo].[USP_Tbl_Tcp_Count_BKUP8AUG]                        
(                        
@Fld_Branch_Code char(50),                        
@Fld_Server_Id varchar(15),                        
@Fld_Tcp_1015 int,                        
@Fld_Tcp_0115 int,                        
@Fld_Tcp_0315 int,                        
@Fld_Sur_Cnt int,                        
@Fld_Remark varchar(200),                        
@Fld_FldDate datetime,                        
@Fld_Flag char(2),            
@Fld_Upd_By varchar(15)                        
)                        
as    
Begin                      
                      
 Begin tran                       
                      
/*                    
if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate) = 1                      
begin                       
 delete from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate                      
end                       
*/                    
 declare @count int                    
 set @Fld_Server_Id =                
 case               
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'AS' then right(@Fld_Server_Id,1)                  
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'A' then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 4 then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 2 then right(@Fld_Server_Id,1)                  
 end               
              
                  
--                   
-- print @Fld_Server_Id                  
-- print @Fld_Flag                  
 --     
select @count=count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate         
if @count >= 1            
Begin        
    if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@Fld_Upd_By) = 'ADMIN'
     Begin  
		 Update Tbl_Tcp_Count set
		 Fld_Tcp_1015 =@Fld_Tcp_1015  , Fld_Tcp_0315 =@Fld_Tcp_0315,
		 Fld_Sur_Cnt=@Fld_Sur_Cnt ,Fld_Remark =@Fld_Remark , fld_EmpCode=@Fld_Upd_By
		 where Fld_Branch_Code=@Fld_Branch_code 
		 and Fld_FldDate=@Fld_Flddate 
		 and Fld_Server_Id=@Fld_Server_Id
		 
		 select Fld_Server_Id from Tbl_Tcp_Count where 
		 Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate  and Fld_Server_Id=@Fld_Server_Id
     End
End
Else
Begin
   if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@Fld_Upd_By) = 'ADMIN'
   Begin   
     Insert into Tbl_Tcp_Count values                         
	  (                        
	  @Fld_Branch_Code,                        
	  @Fld_Server_Id,                  
	  @Fld_Tcp_1015,                        
	  @Fld_Tcp_0115,                        
	  @Fld_Tcp_0315,                        
	  @Fld_Sur_Cnt,                        
	  @Fld_Remark,                        
	  @Fld_FldDate,                        
	  getdate(),                        
	  @Fld_Flag,                        
	  @Fld_Upd_By            
	  )   
             
	  Update Tbl_IT_Reports_details set Fld_upd_date = getdate(),            
	  Fld_Upd_By = @Fld_Upd_By,Fld_Status = 'C'             
	  where Fld_Status = 'P' and Fld_Br_Code = @Fld_Branch_Code and             
	  convert(varchar(11),Fld_Fet_Date) = convert(varchar(11),getdate()) and Fld_Id = 1 
  
      Select 'Insert'  
   End 
 Else
    Begin
		insert into Tbl_Tcp_Count values                         
		(                        
		@Fld_Branch_Code,                        
		@Fld_Server_Id,                  
		@Fld_Tcp_1015,                        
		@Fld_Tcp_0115,                        
		@Fld_Tcp_0315,                        
		@Fld_Sur_Cnt,                        
		@Fld_Remark,                        
		@Fld_FldDate,                        
		getdate(),                        
		@Fld_Flag,                        
		@Fld_Upd_By            
		)   
		 
		update Tbl_IT_Reports_details set Fld_upd_date = getdate(),            
		Fld_Upd_By = @Fld_Upd_By,Fld_Status = 'C'             
		where Fld_Status = 'P' and Fld_Br_Code = @Fld_Branch_Code and             
		convert(varchar(11),Fld_Fet_Date) = convert(varchar(11),getdate()) and Fld_Id = 1 

    End  
End          

               
 if @@ERROR <> 0                      
 begin                      
  rollback tran                      
 end                      
 else                      
 begin                      
  commit                      
 end   
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Tbl_Tcp_Count_Check
-- --------------------------------------------------
CREATE Proc [dbo].[USP_Tbl_Tcp_Count_Check]        
(        
@Fld_Branch_Code char(50),        
@Fld_FldDate datetime,
@username varchar(10)    
)        
as        
      
Begin tran       
      
if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate) >= 1      
begin  
if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@username) = 'ADMIN'      
Begin      
 delete from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate   
End   
end       
      
/*    
insert into Tbl_Tcp_Count values         
(        
@Fld_Branch_Code,        
@Fld_Server_Id,        
@Fld_Tcp_1015,        
@Fld_Tcp_0115,        
@Fld_Tcp_0315,        
@Fld_Sur_Cnt,        
@Fld_Remark,        
@Fld_FldDate,        
getdate(),        
@Fld_Flag         
)       
*/      
      
if @@ERROR <> 0      
begin      
 rollback tran      
end      
else      
begin      
 commit      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Tbl_Tcp_Count_New
-- --------------------------------------------------
--Exec USP_Tbl_Tcp_Count 'YA','A43','64','','70','17138','','8/4/2011 00:00:00 AM','A ','E30252'

CREATE Proc USP_Tbl_Tcp_Count_New                        
(                        
@Fld_Branch_Code char(50),                        
@Fld_Server_Id varchar(15),                        
@Fld_Tcp_1015 int,                        
@Fld_Tcp_0115 int,                        
@Fld_Tcp_0315 int,                        
@Fld_Sur_Cnt int,                        
@Fld_Remark varchar(200),                        
@Fld_FldDate datetime,                        
@Fld_Flag char(2),            
@Fld_Upd_By varchar(15)                        
)                        
as    
Begin                      
                      
 Begin tran                       
                      
/*                    
if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate) = 1                      
begin                       
 delete from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate                      
end                       
*/                    
 declare @count int                    
 set @Fld_Server_Id =                
 case               
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'AS' then right(@Fld_Server_Id,1)                  
 when len(@Fld_Server_Id) = 3 and @Fld_Flag = 'A' then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 4 then right(@Fld_Server_Id,2)                  
 when len(@Fld_Server_Id) = 2 then right(@Fld_Server_Id,1)                  
 end               
              
                  
--                   
-- print @Fld_Server_Id                  
-- print @Fld_Flag                  
 --     
select @count=count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate         
if @count >=  1            
begin       
 if (select count(*) from Tbl_Tcp_Count where Fld_Branch_code = @Fld_Branch_code and Fld_Flddate = @Fld_Flddate and Fld_Server_Id=@Fld_Server_Id and Fld_Flag=@Fld_Flag) =0               
 Begin
  if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@Fld_Upd_By) = 'ADM'
   Begin
             
	  update Tbl_IT_Reports_details set Fld_upd_date = getdate(),            
	  Fld_Upd_By = @Fld_Upd_By,Fld_Status = 'C'             
	  where Fld_Status = 'P' and Fld_Br_Code = @Fld_Branch_Code and             
	  convert(varchar(11),Fld_Fet_Date) = convert(varchar(11),getdate()) and Fld_Id = 1 
	  
	  Select 'Update'               
  End 
 End 
End   
Else  
  Begin   
                     
	  insert into Tbl_Tcp_Count values                         
	  (                        
	  @Fld_Branch_Code,                        
	  @Fld_Server_Id,                  
	  @Fld_Tcp_1015,                        
	  @Fld_Tcp_0115,                        
	  @Fld_Tcp_0315,                        
	  @Fld_Sur_Cnt,                        
	  @Fld_Remark,                        
	  @Fld_FldDate,                        
	  getdate(),                        
	  @Fld_Flag,                        
	  @Fld_Upd_By            
	  )   
	  
	  Select 'Insert'                   
  End



               
 if @@ERROR <> 0                      
 begin                      
  rollback tran                      
 end                      
 else                      
 begin                      
  commit                      
 end   
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_COUNT_Report
-- --------------------------------------------------
CREATE Proc USP_TCP_COUNT_Report                                  
(@FromDate as varchar(11) /*,@ToDate as varchar(11)*/,@Server as varchar(20)/*,@From_Fld_Time as varchar(15),@To_Fld_Time as varchar(15)*/)                                  
as                                  
set nocount on                           
             
      
                                
Declare @Fld_Sbs_Name as varchar(50)                                  
Declare @Fld_Server_Name as varchar(50)                                  
Declare @cnt as int                                
Declare @sql as varchar(5000)                 
                 
      
/*      
declare @FromDate as varchar(11)                        
declare @Server as varchar(20)                        
                        
set @FromDate = '01/04/2008'                        
set @Server = 'AHMEDABAD EQ(8)'                                 
      
      
--select * from tbl_Tcp_Master      
--select * from #TCP      
      
*/      
  
                         
                              
set @FromDate = convert(varchar(11),convert(datetime,@FromDate,103))                                
--set @ToDate = convert(varchar(11),convert(datetime,@ToDate,103))                                
                              
declare @From_Fld_Time as varchar(15)                              
declare @To_Fld_Time as varchar(15)                                    
                           
select @From_Fld_Time = min(fld_time) from tbl_Tcp_Master where                               
Fld_Entered_Date >= @FromDate and  Fld_Entered_Date <= @FromDate +' 23:59:59'        
--print @From_Fld_Time                        
                              
select @To_Fld_Time = max(fld_time) from tbl_Tcp_Master where                               
Fld_Entered_Date >= @FromDate and Fld_Entered_Date <= @FromDate +' 23:59:59'                                  
--print @To_Fld_Time                        
                                
set @cnt = 0                   
                                
create table #TCP                   
(                  
SERVER varchar(100),                  
[ODIN MANAGER<BR>10.15 AM] VARCHAR(50),      
[ODIN MANAGER<BR>03.15 PM] VARCHAR(50),      
--REMARK varchar(100),                      
[SURVEILLANCE<BR>09:15 AM] varchar(11)                       
)                    
                                
insert into #TCP                                  
--select distinct UPPER(Server),'','','' from server_users      
select server,'','','' from V_TCP_Server                  
                      
set @sql = 'update #TCP set [ODIN MANAGER<BR>10.15 AM] = Fld_Tcp_count from tbl_Tcp_Master where                         
Fld_Entered_Date >= '''+@FromDate+''' and Fld_Entered_Date <= '''+@FromDate+' 23:59:59''                        
and  server = Fld_server and Fld_Time = '''+@From_Fld_Time+''''                        
exec (@sql)      
      
set @sql = 'update #TCP set [ODIN MANAGER<BR>03.15 PM] = Fld_Tcp_count from tbl_Tcp_Master where                         
Fld_Entered_Date >= '''+@FromDate+''' and Fld_Entered_Date <= '''+@FromDate+' 23:59:59''                        
and  server = Fld_server and Fld_Time = '''+@To_Fld_Time+''''                        
exec(@sql)                     
                        
set @sql = 'update #TCP set [SURVEILLANCE<BR>09:15 AM] = Fld_Sur_Count from tbl_Tcp_Master where                         
Fld_Entered_Date >= '''+@FromDate+''' and Fld_Entered_Date <= '''+@FromDate+' 23:59:59''                        
and  server = Fld_server and Fld_Sur_Count <> '''''                        
exec(@sql)                         
                                  
DECLARE Server_cursor CURSOR FOR select server from V_TCP_Server /*where location = @Server */                                 
OPEN Server_cursor                                     
                                  
FETCH NEXT FROM Server_cursor                                  
INTO @Fld_Server_Name                                    
                
WHILE @@FETCH_STATUS = 0                                                                                  
                                                           
BEGIN                                                     
                                  
DECLARE TCP_cursor CURSOR FOR select distinct Fld_Sbs_Name from tbl_sbs_master         
OPEN TCP_cursor                                                              
                                                                                
FETCH NEXT FROM TCP_cursor                                                              
INTO @Fld_Sbs_Name                                                          
                                                                                  
WHILE @@FETCH_STATUS = 0                                                                                  
         
BEGIN                                                                                      
                                  
if @cnt = 0                                
begin                                
 set @sql = 'alter table #TCP                                 
 add ['+@Fld_Sbs_Name+ '<br>'+@To_Fld_Time+'] varchar(25),                                  
 ['+@Fld_Sbs_Name+'<br>'+@From_Fld_Time+'] varchar(25)'                                  
exec (@sql)                                  
-- print @sql                                  
end                                    
set @sql = 'update #TCP set                                     
['+@Fld_Sbs_Name+ '<br>'+@From_Fld_Time+'] = convert(varchar,isnull(x.Fld_Tcp_Count,0)) + case when x.Fld_Ip_Address <> '''' then ''[''+replace(right(x.Fld_Ip_Address,3),''.'','''')+'']'' else '''' end,                                    
['+@Fld_Sbs_Name+ '<br>'+@To_Fld_Time+'] = convert(varchar,isnull(y.Fld_Tcp_Count,0)) + case when x.Fld_Ip_Address <> '''' then ''[''+replace(right(x.Fld_Ip_Address,3),''.'','''')+'']'' else '''' end    from                                    
((select Fld_server,Fld_Tcp_Count,Fld_Ip_Address from tbl_Tcp_Master where Fld_Time = '''+@From_Fld_Time+''' and Fld_Sb_Name = '''+@Fld_Sbs_Name+''' and Fld_Server = '''+@Fld_Server_Name+''' and Fld_Entered_Date >= '''+@FromDate+''' and Fld_Entered_Date <= '''+@FromDate+' 23:59:59'') x                                    
full outer join                                    
(select Fld_server,Fld_Tcp_Count,Fld_Ip_Address from tbl_Tcp_Master where Fld_Time = '''+@To_Fld_Time+''' and Fld_Sb_Name = '''+@Fld_Sbs_Name+''' and Fld_Server = '''+@Fld_Server_Name+''' and Fld_Entered_Date >= '''+@FromDate+''' and Fld_Entered_Date <= '''+@FromDate+' 23:59:59'') y                                    
on x.Fld_server= y.Fld_server) where #tcp.SERVER = '''+@Fld_Server_Name+''''                                    
exec (@sql)                                    
--print @sql                     
                  
                                  
--print @sql                                  
                                  
FETCH NEXT FROM TCP_cursor                                                            
INTO @Fld_Sbs_Name                                                              
                                     
END                                                                
                                                                       
CLOSE TCP_cursor                                                            
DEALLOCATE TCP_cursor                                   
                                
set @cnt = 1                                
        FETCH NEXT FROM Server_cursor                                                            
INTO @Fld_Server_Name                                                              
                                                            
END                                                                                  
                                       
CLOSE Server_cursor           
DEALLOCATE Server_cursor                             
                      
set @sql = 'alter table #TCP                                 
 add REMARK varchar(500)'             
exec (@sql)                   
    
set @sql = 'update #TCP set REMARK = Fld_Remark from tbl_Tcp_Master where                    
Fld_Entered_Date >= '''+@FromDate+''' and Fld_Entered_Date <= '''+@FromDate+' 23:59:59''                      
and  server = Fld_server'                      
exec(@sql)                        
                              
if @Server = 'All'                              
begin                              
set @sql = 'select * from #TCP'                           
end                               
else                              
begin                              
set @sql = 'select * from #TCP where SERVER = '''+@Server+''''                              
end                              
--print @sql                         
exec (@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Del
-- --------------------------------------------------
CREATE Proc USP_TCP_Del   
(    
@Fld_Location as varchar(20),    
@Fld_Server as varchar(20),    
@Fld_Sb_Name as varchar(20),  
@Fld_Date as varchar(11)    
)     
as    
    
--select convert(varchar(11),getdate())  

set @Fld_Date = (select substring(@Fld_Date,4,2)+'/'+substring(@Fld_Date,0,3)+'/'+right(@Fld_Date,4))
    
delete from  tbl_Tcp_Master where     
Fld_Entered_Date = @Fld_Date and     
Fld_Location = @Fld_Location and     
Fld_Server = @Fld_Server and     
Fld_Sb_Name = @Fld_Sb_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Delete
-- --------------------------------------------------
create Proc USP_TCP_Delete  
(  
@drpLocation as varchar(35),  
@drpServer as varchar(35),  
@Date as varchar(35)
)  
as
  
set @Date = (select substring(@Date,4,2)+'/'+substring(@Date,0,3)+'/'+right(@Date,4))    

delete from tbl_Tcp_Master where Fld_Entered_Date = @date and Fld_Location = @drpLocation  and Fld_Server = @drpServer

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Insert
-- --------------------------------------------------
CREATE Proc USP_TCP_Insert    
(    
@drpLocation as varchar(35),    
@drpServer as varchar(35),    
@SBS_Name as varchar(35),    
@Time as varchar(35),    
@Count as int,    
@Date as varchar(35),    
@IP as varchar(35),    
@SUR_count as varchar(35),    
@SUR_remark as varchar(500)    
)    
as  
  
  
  
    
set @Date = (select substring(@Date,4,2)+'/'+substring(@Date,0,3)+'/'+right(@Date,4))       

insert into tbl_Tcp_Master values(@drpLocation,@drpServer,@SBS_Name,@Time,@Count,@Date,@IP,@SUR_count,@SUR_remark)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Mail
-- --------------------------------------------------
CREATE proc USP_TCP_Mail                            
                          
as                          
SET NOCOUNT ON                          
                        
CREATE TABLE #C                        
(                        
fld_id  varchar(50),                        
fld_server  VARCHAR(5000)                        
)                        
                          
select * INTO #a from                            
(                            
select server,email_id,location from                             
(select * from tbl_Bulk_Mail (nolock)) x                            
inner join                            
(select * from server_users (nolock)) y                            
on x.locaton = y.location                            
)                            
x where not exists                            
(                            
select * from tbl_tcp_master y where Fld_Entered_date = convert(datetime,convert(varchar(11),getdate()))                            
and x.server = y.Fld_server                            
) order by server                             
                          
            
                          
DECLARE @server_id varchar(25),@message varchar(5000), @server_name varchar(80),@email_id varchar(500)                          
                          
DECLARE tcp_cursor CURSOR FOR                          
select distinct location,email_id from #a                          
                          
OPEN tcp_cursor                          
                          
FETCH NEXT FROM tcp_cursor                          
INTO @server_id,@email_id                          
                          
WHILE @@FETCH_STATUS = 0                          
BEGIN                          
                          
set @message = ''                          
                          
   DECLARE mail_cursor CURSOR FOR                           
   select server from #a where location = @server_id                             
                          
   OPEN mail_cursor                          
   FETCH NEXT FROM mail_cursor INTO @server_name                          
                          
   WHILE @@FETCH_STATUS = 0                          
   BEGIN                          
                                
      --set @message = @message + @server_name +'<br>'                          
      --exec ('INSERT INTO #C VALUES ('''+@server_id+''','''+@message+''')')                          
      set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for todays TCP count report.<br><br>Kindly note that the cut off timing for TCP count report is <b><font color=#ff6666>4.00 p.m.</font></b><br><br><b
r>Best Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'          
      FETCH NEXT FROM mail_cursor INTO @server_name                          
                             
   END                          
                          
   CLOSE mail_cursor                          
   DEALLOCATE mail_cursor                          
                           
-- SET @message = (SELECT max(fld_server) FROM #C WHERE FLD_ID = @server_id)                            
                            
--exec mis.master.dbo.usp_AutoMail_TCP 'Mangesh.wangane@angeltrade.com','Mangesh.wangane@angeltrade.com','TCP Count Report - Reminder',@message                                 
--exec mis.master.dbo.usp_AutoMail_TCP 'Mangesh.wangane@angeltrade.com','Mangesh.wangane@angeltrade.com','TCP Count Report - Reminder',@message                                 
--exec mis.master.dbo.usp_AutoMail_TCP @email_id,'ITBranchsupport@angeltrade.com','TCP Count Report - Reminder',@message                                 
          
                            
   FETCH NEXT FROM tcp_cursor                           
   INTO @server_id,@email_id                          
     
END                          
                          
CLOSE tcp_cursor                          
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Mail_New
-- --------------------------------------------------
CREATE proc USP_TCP_Mail_New  
as      
                                        
SET NOCOUNT ON      
      
DECLARE @email_id varchar(500),@message as varchar(1000),@br_tag AS VARCHAR(20),@MAIL AS VARCHAR(500)                         
    
    
select distinct br_tag into #x from V_TCP_Mails where Br_tag not in      
(    
select distinct Fld_Branch_Code from tbl_tcp_count (nolock) where Fld_FldDate >= convert(varchar(11),getdate()) and     
Fld_FldDate <= convert(varchar(11),getdate()) + ' 23:59:59'     
)    
                                        
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag from #x                                         
OPEN tcp_cursor                                        
                                        
FETCH NEXT FROM tcp_cursor                                        
INTO @br_tag                                        
                                        
WHILE @@FETCH_STATUS = 0                                        
BEGIN            
      
 set @email_id = ''       
       
 DECLARE TCP_MAILS CURSOR FOR SELECT EMAILADD FROM V_TCP_Mails WHERE BR_TAG = @br_tag      
 OPEN TCP_MAILS      
      
 SET @MAIL = ''      
       
 FETCH NEXT FROM TCP_MAILS      
 INTO @email_id      
      
 WHILE @@FETCH_STATUS = 0                                        
 BEGIN       
      
 SET @MAIL = @email_id+';'+@MAIL      
      
 FETCH NEXT FROM TCP_MAILS                                         
 INTO @email_id        
      
 END              
      
 CLOSE TCP_MAILS      
 DEALLOCATE TCP_MAILS      
       
 --PRINT @MAIL       
 set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for todays TCP count report.<br><br>Kindly note that the cut off timing for TCP count report is <b><font color=#ff6666>4.00 p.m.</font></b><br><br><br>Bes
  
t Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'                                                      
  
    
                                   
 exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITBranchsupport@angeltrade.com','TCP Count Report - Reminder',@message       
 --PRINT  'mis.master.dbo.usp_AutoMail_TCP '+@MAIL+',''ITBranchsupport@angeltrade.com'',''TCP Count Report - Reminder'','+@message+''                                                         
        --print @message               
                                          
   FETCH NEXT FROM tcp_cursor                                         
   INTO @br_tag                         
                   
END                                        
                                        
CLOSE tcp_cursor                                        
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Mail_New_1
-- --------------------------------------------------
--sp_helptext USP_TCP_Mail_New_1    
    
CREATE proc [dbo].[USP_TCP_Mail_New_1]                              
as                              
                                                                
SET NOCOUNT ON                              
                              
DECLARE @email_id nvarchar(500),@message as nvarchar(1000),@br_tag AS nVARCHAR(20),@MAIL AS nVARCHAR(500),@brname as nvarchar(100)                                                   
                            
select distinct br_tag,br_name into #x from V_TCP_Mails where Br_tag not in                              
(                            
select distinct Fld_Branch_Code from tbl_tcp_count (nolock) where Fld_FldDate >= convert(varchar(11),getdate()) and                             
Fld_FldDate <= convert(varchar(11),getdate()) + ' 23:59:59'                             
)                            
                                                                
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x                                                                 
OPEN tcp_cursor                                                                
                                                                
FETCH NEXT FROM tcp_cursor                                                                
INTO @br_tag,@brname                                                                
                                                                
WHILE @@FETCH_STATUS = 0                                                                
BEGIN                                    
                              
 set @email_id = ''                               
                               
 DECLARE TCP_MAILS CURSOR FOR SELECT  EMAILADD FROM V_TCP_Mails WHERE BR_TAG = @br_tag                              
 OPEN TCP_MAILS                              
                              
 SET @MAIL = ''                              
                               
 FETCH NEXT FROM TCP_MAILS                              
 INTO @email_id                              
                              
 WHILE @@FETCH_STATUS = 0                                                                
 BEGIN                               
                              
 SET @MAIL = @email_id+';'+@MAIL                              
                              
 FETCH NEXT FROM TCP_MAILS                                                                 
 INTO @email_id                                
                              
 END                                      
                              
 CLOSE TCP_MAILS                              
 DEALLOCATE TCP_MAILS                              
                               
 --PRINT @MAIL                               
set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for todays TCP count report.<br><br>Kindly note that the cut off timing for TCP count report is <b><font color=#ff6666>4.00 p.m.</font></b><br><br><br>Be  
  
    
      
        
          
            
                    
 Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                                    
  
    
      
        
          
            
              
                
                  
                       
                      
                            
                            
                                                       
--exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITbranchsupport@angeltrade.com','TCP Count Report - Reminder '+@brname,@message                               
set @brname=case when @brname='AKRUTI-[HO]' then 'DAKC(DHO)' else @brname end  
set @MAIL='Odinakruti@angelbroking'
--print @brname
--print @Mail
exec('mis.helpdesk.dbo.usp_AutoMail_TCP '''+@MAIL+''',''ITBranchsupport'',''TCP Count Report - Reminder '+ @brname +''','''+@message+''','''+@brname+'''')                                                
--Print 'master.dbo.usp_AutoMail_TCP '''+@MAIL+''',''ITbranchsupport@angeltrade.com'',''TCP Count Report - Reminder '+@brname+''','''+@message+''''                          
--exec('mis.master.dbo.usp_AutoMail_TCP ''mangesh.wangane@angeltrade.com'',''mangesh.wangane@angeltrade.com'',''TCP Count Report - Reminder '+@brname+''','''+@message+'''')                                                                    
                                   
   FETCH NEXT FROM tcp_cursor                                                     
   INTO @br_tag,@brname                                                 
                   
END                                                                
                                          
CLOSE tcp_cursor                                           
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Mail_New_1_28Nov2014
-- --------------------------------------------------
--sp_helptext USP_TCP_Mail_New_1    
    
CREATE proc [dbo].[USP_TCP_Mail_New_1_28Nov2014]                              
as                              
                                                                
SET NOCOUNT ON                              
                              
DECLARE @email_id nvarchar(500),@message as nvarchar(1000),@br_tag AS nVARCHAR(20),@MAIL AS nVARCHAR(500),@brname as nvarchar(100)                                                   
                            
select distinct br_tag,br_name into #x from V_TCP_Mails where Br_tag not in                              
(                            
select distinct Fld_Branch_Code from tbl_tcp_count (nolock) where Fld_FldDate >= convert(varchar(11),getdate()) and                             
Fld_FldDate <= convert(varchar(11),getdate()) + ' 23:59:59'                             
)                            
                                                                
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x                                                                 
OPEN tcp_cursor                                                                
                                                                
FETCH NEXT FROM tcp_cursor                                                                
INTO @br_tag,@brname                                                                
                                                                
WHILE @@FETCH_STATUS = 0                                                                
BEGIN                                    
                              
 set @email_id = ''                               
                               
 DECLARE TCP_MAILS CURSOR FOR SELECT  EMAILADD FROM V_TCP_Mails WHERE BR_TAG = @br_tag                              
 OPEN TCP_MAILS                              
                              
 SET @MAIL = ''                              
                               
 FETCH NEXT FROM TCP_MAILS                              
 INTO @email_id                              
                              
 WHILE @@FETCH_STATUS = 0                                                                
 BEGIN                               
                              
 SET @MAIL = @email_id+';'+@MAIL                              
                              
 FETCH NEXT FROM TCP_MAILS                                                                 
 INTO @email_id                                
                              
 END                                      
                              
 CLOSE TCP_MAILS                              
 DEALLOCATE TCP_MAILS                              
                               
 --PRINT @MAIL                               
set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for todays TCP count report.<br><br>Kindly note that the cut off timing for TCP count report is <b><font color=#ff6666>4.00 p.m.</font></b><br><br><br>Be  
  
    
      
        
          
            
                    
 Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                                    
  
    
      
        
          
            
              
                
                  
                       
                      
                            
                            
                                                       
--exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITbranchsupport@angeltrade.com','TCP Count Report - Reminder '+@brname,@message                               
set @brname=case when @brname='AKRUTI-[HO]' then 'DAKC(DHO)' else @brname end  
exec('mis.helpdesk.dbo.usp_AutoMail_TCP '''+@MAIL+''',''ITBranchsupport'',''TCP Count Report - Reminder '+ @brname +''','''+@message+''','''+@brname+'''')                                                
--Print 'master.dbo.usp_AutoMail_TCP '''+@MAIL+''',''ITbranchsupport@angeltrade.com'',''TCP Count Report - Reminder '+@brname+''','''+@message+''''                          
--exec('mis.master.dbo.usp_AutoMail_TCP ''mangesh.wangane@angeltrade.com'',''mangesh.wangane@angeltrade.com'',''TCP Count Report - Reminder '+@brname+''','''+@message+'''')                                                                    
                                   
   FETCH NEXT FROM tcp_cursor                                                     
   INTO @br_tag,@brname                                                 
                   
END                                                                
                                          
CLOSE tcp_cursor                                           
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Mail_New_Saturday
-- --------------------------------------------------
CREATE proc USP_TCP_Mail_New_Saturday              
as              
                                                
SET NOCOUNT ON              
              
DECLARE @email_id nvarchar(500),@message as nvarchar(1000),@br_tag AS nVARCHAR(20),@MAIL AS nVARCHAR(500),@brname as nvarchar(100)                                   
            
select distinct br_tag,br_name into #x from V_TCP_Mails where Br_tag not in              
(            
select distinct Fld_Branch_Code from tbl_tcp_count (nolock) where Fld_FldDate >= convert(varchar(11),getdate()) and             
Fld_FldDate <= convert(varchar(11),getdate()) + ' 23:59:59'             
)  and br_tag not in ('VKPT','XP','TB')           
                                                
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x                                                 
OPEN tcp_cursor                                                
                                                
FETCH NEXT FROM tcp_cursor                                                
INTO @br_tag,@brname                                                
                                                
WHILE @@FETCH_STATUS = 0                                                
BEGIN                    
              
 set @email_id = ''               
               
 DECLARE TCP_MAILS CURSOR FOR SELECT EMAILADD FROM V_TCP_Mails WHERE BR_TAG = @br_tag              
 OPEN TCP_MAILS              
              
 SET @MAIL = ''              
               
 FETCH NEXT FROM TCP_MAILS              
 INTO @email_id              
              
 WHILE @@FETCH_STATUS = 0                                                
 BEGIN               
              
 SET @MAIL = @email_id+';'+@MAIL              
              
 FETCH NEXT FROM TCP_MAILS                                                 
 INTO @email_id                
              
 END                      
              
 CLOSE TCP_MAILS              
 DEALLOCATE TCP_MAILS              
               
 --PRINT @MAIL               
set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for todays TCP count report.<br><br>Kindly note that the cut off timing for TCP count report is <b><font color=#ff6666>3.00 p.m.</font></b><br><br><br>Best
 Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                                       
  
           
exec('mis.master.dbo.usp_AutoMail_TCP '''+@MAIL+''',''ITBranchsupport@angeltrade.com'',''TCP Count Report - Reminder '+@brname+''','''+@message+'''')                                                                 
    
                   
   FETCH NEXT FROM tcp_cursor                                                 
   INTO @br_tag,@brname                                 
                           
END                                                
                                                
CLOSE tcp_cursor                                                
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Not_Update
-- --------------------------------------------------
CREATE Proc USP_TCP_Not_Update(@fdate as varchar(11))  
as  
  
select Distinct Br_Name from V_TCP_Servers x (nolock)  where not exists  
(select * from Tbl_Tcp_Count y (nolock)  where Fld_FldDate = @fdate and x.Fld_Branch_cd = Fld_Branch_Code)   
and  x.Fld_Branch_cd in (SELECT (fld_branch_cd) FROM dbo.Server_manager_Branch_ITdetails_todate WHERE fld_to_date > @fdate)  
order by Br_Name--,S,Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Not_Update_17012013
-- --------------------------------------------------
Create Proc USP_TCP_Not_Update_17012013(@fdate as varchar(11))  
as  
  
select Distinct Br_Name from V_TCP_Servers x (nolock)  where not exists  
(select * from Tbl_Tcp_Count y (nolock)  where Fld_FldDate = @fdate and x.Fld_Branch_cd = Fld_Branch_Code)   
order by Br_Name--,S,Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Report
-- --------------------------------------------------
CREATE Proc USP_TCP_Report(@Fdate as varchar(11),@tdate as varchar(11),@Location as varchar(100))  
as  
  
/*  
Declare @Fdate as varchar(11),  
@tdate as varchar(11),  
@Server as varchar(100)  
  
set @Fdate = 'Oct 01 2007'  
set @Tdate = 'Oct 15 2007'  
set @Server = 'Ahmedabad'  
--set @Location = 'ALL'  
*/

set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                          
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                          
set @Location = (case when @Location = 'ALL' then 'like ''%%' else '='+''''+@Location+'' end)  
  
Declare @Str as varchar(500)  
set @Str = 'select UPPER(Fld_Server_id) SERVER,sum(convert(int,fld_count)) as [TCP COUNT] from tbl_TCP where   
Fld_date >= '''+@Fdate+''' and Fld_date <= '''+@tdate+''' and Fld_Server_id in
(select server from server_users where Location '+@Location+''') group by Fld_Server_id'  
Exec (@Str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Update
-- --------------------------------------------------
--USP_TCP_Update 'DHO','2016-11-15'        
CREATE Proc [dbo].[USP_TCP_Update](@Fld_Branch_cd as varchar(15),@Fld_FldDate as datetime)                                  
as                                  
         
set nocount on         
declare @variable table        
(        
S char(2),        
Fld_id varchar(5),        
server_id int,        
Fld_Server varchar(50),        
Fld_Branch_cd varchar(20),        
Br_Name varchar(50),        
SBS_IP varchar(20),        
Remark varchar(50)        
)            
insert into @variable        
exec usp_v_TCP_Servers_new  @Fld_FldDate                                    
   
--update   @variable
--set  S='A'
--where Fld_id='AS45'
                               
select S,Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,fld_Server_Id,                                  
isnull(convert(varchar,Fld_Tcp_1015),0) Fld_Tcp_1015,                                  
isnull(convert(varchar,Fld_Tcp_0115),0) Fld_Tcp_0115,                                  
isnull(convert(varchar,Fld_Tcp_0315),0) Fld_Tcp_0315,                                  
isnull(convert(varchar,Fld_Sur_Cnt),0) Fld_Sur_Cnt,                                  
isnull(Fld_Remark,'') Fld_Remark,Fld_Flddate,SBS_ip,Remark,person_name                              
into #t                            
 from                                   
(--select * from V_TCP_Servers where Fld_Branch_cd like @Fld_Branch_cd        
select * from @variable where Fld_Branch_cd like @Fld_Branch_cd) x                                  
left outer join                                  
(select * from V_Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate)y                                  
on x.Fld_Branch_cd = y.Fld_Branch_Code and x.server_Id = y.Fld_Server_Id and x.S = y.Fld_Flag                         
--order by   S,Fld_id                                
order by   Br_Name,S,Fld_Server                                
                            
select * from #t where Fld_branch_cd in                            
(                            
select Fld_Branch_code from Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate                            
)       
and Fld_Server not in (case when @Fld_FldDate>'May 25 2015' then 'MIS (25)' else '' end)    
and Fld_Server not in (case when @Fld_FldDate>'Jul 08 2015' then 'MIS (27)' else '' end)  
and Fld_Server not in (case when @Fld_FldDate>'Sep 29 2015' then 'DAKC DIET CLIENT (64)' else '' end)
and fld_Server_Id <> 207

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Update_03042018
-- --------------------------------------------------
--USP_TCP_Update 'DHO','2016-11-15'        
Create Proc [dbo].[USP_TCP_Update_03042018](@Fld_Branch_cd as varchar(15),@Fld_FldDate as datetime)                                  
as                                  
         
set nocount on         
declare @variable table        
(        
S char(2),        
Fld_id varchar(5),        
server_id int,        
Fld_Server varchar(50),        
Fld_Branch_cd varchar(20),        
Br_Name varchar(50),        
SBS_IP varchar(20),        
Remark varchar(50)        
)            
insert into @variable        
exec usp_v_TCP_Servers_new  @Fld_FldDate                                    
                               
select S,Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,fld_Server_Id,                                  
isnull(convert(varchar,Fld_Tcp_1015),0) Fld_Tcp_1015,                                  
isnull(convert(varchar,Fld_Tcp_0115),0) Fld_Tcp_0115,                                  
isnull(convert(varchar,Fld_Tcp_0315),0) Fld_Tcp_0315,                                  
isnull(convert(varchar,Fld_Sur_Cnt),0) Fld_Sur_Cnt,                                  
isnull(Fld_Remark,'') Fld_Remark,Fld_Flddate,SBS_ip,Remark,person_name                              
into #t                            
 from                                   
(--select * from V_TCP_Servers where Fld_Branch_cd like @Fld_Branch_cd        
select * from @variable where Fld_Branch_cd like @Fld_Branch_cd) x                                  
left outer join                                  
(select * from V_Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate)y                                  
on x.Fld_Branch_cd = y.Fld_Branch_Code and x.server_Id = y.Fld_Server_Id and x.S = y.Fld_Flag                         
--order by   S,Fld_id                                
order by   Br_Name,S,Fld_Server                                
                            
select * from #t where Fld_branch_cd in                            
(                            
select Fld_Branch_code from Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate                            
)       
and Fld_Server not in (case when @Fld_FldDate>'May 25 2015' then 'MIS (25)' else '' end)    
and Fld_Server not in (case when @Fld_FldDate>'Jul 08 2015' then 'MIS (27)' else '' end)  
and Fld_Server not in (case when @Fld_FldDate>'Sep 29 2015' then 'DAKC DIET CLIENT (64)' else '' end)
and fld_Server_Id <> 207

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Update_dummy
-- --------------------------------------------------
CREATE Proc USP_TCP_Update_dummy(@Fld_Branch_cd as varchar(15),@Fld_FldDate as datetime,@Fld_FldDate1 as datetime)                            
as                            
                        
set nocount on                      
                            
select S,Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,                            
isnull(convert(varchar,Fld_Tcp_1015),0) Fld_Tcp_1015,                            
isnull(convert(varchar,Fld_Tcp_0115),0) Fld_Tcp_0115,                            
isnull(convert(varchar,Fld_Tcp_0315),0) Fld_Tcp_0315,                            
isnull(convert(varchar,Fld_Sur_Cnt),0) Fld_Sur_Cnt,                            
isnull(Fld_Remark,'') Fld_Remark,Fld_Flddate=convert(varchar(11),Fld_Flddate,103),SBS_ip,Remark,person_name                        
into #t                      
 from                             
(select * from V_TCP_Servers where Fld_Branch_cd like @Fld_Branch_cd) x                            
left outer join                            
(select * from V_Tbl_Tcp_Count where Fld_FldDate >= @Fld_FldDate and Fld_FldDate<=@Fld_FldDate1)y                            
on x.Fld_Branch_cd = y.Fld_Branch_Code and x.server_Id = y.Fld_Server_Id and x.S = y.Fld_Flag                   
--order by   S,Fld_id                          
order by   Br_Name,S,Fld_Server                          
                      
select * from #t where Fld_branch_cd in                      
(                      
select Fld_Branch_code from Tbl_Tcp_Count where Fld_FldDate >= @Fld_FldDate and Fld_FldDate<=@Fld_FldDate1                 
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Update1
-- --------------------------------------------------
--EXEC USP_TCP_Update1 '%%','05/25/2015'                        
--EXEC USP_TCP_Update1 '%%','10/01/2015'                        
CREATE Proc [dbo].[USP_TCP_Update1](@Fld_Branch_cd as varchar(15),@Fld_FldDate as datetime)                                                                    
as                                                                    
                        
set nocount on                                                                      
                        
declare @str as varchar(30)                           
set @str=replace(convert(varchar(12) ,@Fld_FldDate,102),'.','-')                               
                              
if (@str >= '2006-09-01' and @str <='2009-09-01')                             
begin                                                                   
 declare @variable table                                           
 (S char(2),                                            
 Fld_id varchar(5),                                            
 server_id int,                                            
 Fld_Server varchar(50),                                            
 Fld_Branch_cd varchar(20),                                            
 Br_Name varchar(50),                                            
 SBS_IP varchar(20),                                            
 Remark varchar(50))                                                
                         
 insert into @variable                                            
 exec usp_v_TCP_Servers_new  '01/21/2014'                              
                                                                      
 select distinct S,Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,                                                                      
 isnull(convert(varchar,Fld_Tcp_1015),0) Fld_Tcp_1015,                                                                      
 isnull(convert(varchar,Fld_Tcp_0115),0) Fld_Tcp_0115,                                                                      
 isnull(convert(varchar,Fld_Tcp_0315),0) Fld_Tcp_0315,                                                                      
 isnull(convert(varchar,Fld_Sur_Cnt),0) Fld_Sur_Cnt,                           
 isnull(convert(varchar,PrevDay_Sur_Cnt),0) PrevDay_Sur_Cnt,                        
 isnull(convert(varchar,First_Sur_Cnt),0) First_Sur_Cnt,                        
 isnull(Fld_Remark,'') Fld_Remark,Fld_Flddate,SBS_ip,Remark,person_name                                                                  
 into #t                                                                
  from                                                                       
 (--select * from V_TCP_Servers where Fld_Branch_cd like @Fld_Branch_cd                                            
 select distinct * from @variable where Fld_Branch_cd like @Fld_Branch_cd) x                                                                      
 left outer join                                                                      
  (select distinct * from V_Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate)y                                                                      
  on                 
  x.Fld_Branch_cd = y.Fld_Branch_Code                
  or                 
  x.server_Id = y.Fld_Server_Id                 
  --and x.S = y.Fld_Flag                                                             
 --order by   S,Fld_id                                                                    
 order by   Br_Name,S,Fld_Server                                                                    
                                                                 
 select *,                                      
 Fld_Tcp_1015color=                                      
 case when Fld_Server like '%DIET%' and Fld_Tcp_1015 >= 1000 then 'Red'                                      
 when Fld_Server like '%DIET%' and Fld_Tcp_1015 < 1000 then 'Black'                                      
 when Fld_Server not like '%DIET%' and Fld_Tcp_1015 >= 350 then 'Red'                                      
 when Fld_Server not like '%DIET%' and Fld_Tcp_1015 < 350 then 'Black'                                      
 end,                     
 Fld_Tcp_0115color=                                      
 case when Fld_Server like '%DIET%' and Fld_Tcp_0115 >= 1000 then 'Red'                                      
 when Fld_Server like '%DIET%' and Fld_Tcp_0115 < 1000 then 'Black'                                      
 when Fld_Server not like '%DIET%' and Fld_Tcp_0115 >= 350 then 'Red'                                      
 when Fld_Server not like '%DIET%' and Fld_Tcp_0115 < 350 then 'Black'                                      
 end,                                 
 Fld_Tcp_0315color=                                      
 case when Fld_Server like '%DIET%' and Fld_Tcp_0315 >= 1000 then 'Red'                                      
 when Fld_Server like '%DIET%' and Fld_Tcp_0315 < 1000 then 'Black'                                      
 when Fld_Server not like '%DIET%' and Fld_Tcp_0315 >= 350 then 'Red'                                      
 when Fld_Server not like '%DIET%' and Fld_Tcp_0315 < 350 then 'Black'                                      
 end                                      
   from #t where Fld_branch_cd in                                                                
 (                                                  
 select Fld_Branch_code from Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate                                           
 )                               
end                          
                               
else                         
begin                          
 declare @variable1 table                                           
 (                                            
 S char(2),                                            
 Fld_id varchar(5),                                            
 server_id int,                                            
 Fld_Server varchar(50),                                            
 Fld_Branch_cd varchar(20),                                            
 Br_Name varchar(50),                                            
 SBS_IP varchar(20),                                            
 Remark varchar(50)                                            
 )                                                
 insert into @variable1                                            
 exec usp_v_TCP_Servers_new  @Fld_FldDate                              
                        
 select S,Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,                                                                    
 isnull(convert(varchar,Fld_Tcp_1015),0) Fld_Tcp_1015,                                                                    
 isnull(convert(varchar,Fld_Tcp_0115),0) Fld_Tcp_0115,                                                                    
 isnull(convert(varchar,Fld_Tcp_0315),0) Fld_Tcp_0315,                                                                    
 isnull(convert(varchar,Fld_Sur_Cnt),0) Fld_Sur_Cnt,                           
 isnull(convert(varchar,PrevDay_Sur_Cnt),0) PrevDay_Sur_Cnt,                        
 isnull(convert(varchar,First_Sur_Cnt),0) First_Sur_Cnt,                                                          
 isnull(Fld_Remark,'') Fld_Remark,Fld_Flddate,SBS_ip,Remark,person_name                                                                
 into #t1                                                              
 from                                                                     
 (--select * from V_TCP_Servers where Fld_Branch_cd like @Fld_Branch_cd                                          
 select * from @variable1 where Fld_Branch_cd like @Fld_Branch_cd                         
 and fld_server not in('MIS (27)','DAKC OMNESYS (109)','SBS (15)','SBS (20)','SBS (108)','SBS (112)','SBS (95)','SBS (6)','SBS (7)')  
 AND fld_server NOT IN(SELECT SERVER_NAME   
        FROM ELIMINATE_SERVER   
        WHERE CONVERT(VARCHAR,ELIMINATE_AFTER,103) < CONVERT(VARCHAR,CONVERT(DATETIME,@Fld_FldDate),103))  
   
   
   
 ) x                                                                    
 left outer join                                                                    
  (select * from V_Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate )y                                                                    
  on                   
  x.Fld_Branch_cd = y.Fld_Branch_Code and                   
  x.server_Id = y.Fld_Server_Id              
  and  exists (SElect fld_id From tbl_server_master Where fld_id = y.fld_server_id)          
 -- and x.S = y.Fld_Flag                                                       
 --order by   S,Fld_id                                                                  
 order by   Br_Name,S,Fld_Server                        
                        
                        
 select *,                                    
 Fld_Tcp_1015color=                                    
 case when Fld_Server like '%DIET%' and Fld_Tcp_1015 >= 1000 then 'Red'                         
 when Fld_Server like '%DIET%' and Fld_Tcp_1015 < 1000 then 'Black'                                    
 when Fld_Server not like '%DIET%' and Fld_Tcp_1015 >= 350 then 'Red'                                    
 when Fld_Server not like '%DIET%' and Fld_Tcp_1015 < 350 then 'Black'                                    
 end,                            
 Fld_Tcp_0115color=                                    
 case when Fld_Server like '%DIET%' and Fld_Tcp_0115 >= 1000 then 'Red'                                    
 when Fld_Server like '%DIET%' and Fld_Tcp_0115 < 1000 then 'Black'                                    
 when Fld_Server not like '%DIET%' and Fld_Tcp_0115 >= 350 then 'Red'                                    
 when Fld_Server not like '%DIET%' and Fld_Tcp_0115 < 350 then 'Black'                                    
 end,                                    
 Fld_Tcp_0315color=                 
 case when Fld_Server like '%DIET%' and Fld_Tcp_0315 >= 1000 then 'Red'                                    
 when Fld_Server like '%DIET%' and Fld_Tcp_0315 < 1000 then 'Black'                                    
 when Fld_Server not like '%DIET%' and Fld_Tcp_0315 >= 350 then 'Red'                        
 when Fld_Server not like '%DIET%' and Fld_Tcp_0315 < 350 then 'Black'                                    
 end                                    
 from #t1 where Fld_branch_cd in                                                              
 (                                                              
 select Fld_Branch_code from Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate                                                              
 )
 and Fld_Server not in (case when @Fld_FldDate>'May 25 2015' then 'MIS (25)' else '' end)                                                             
 and Fld_Server not in (case when @Fld_FldDate>'Sep 29 2015' then 'DAKC DIET CLIENT (64)' else '' end)                                                             
end               
 --select * from Tbl_Tcp_Count where Fld_FldDate = '09/01/2012'               
               
 --select * from V_Tbl_Tcp_Count v where Fld_FldDate = '08/27/2012' and  exists (SElect fld_id From tbl_server_master Where fld_id = v.fld_server_id)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TCP_Update1_backup
-- --------------------------------------------------
CREATE Proc USP_TCP_Update1_BACKUP(@Fld_Branch_cd as varchar(15),@Fld_FldDate as datetime)                                              
as                                              
                     
set nocount on                                                
         
declare @str as varchar(30)     
set @str=replace(convert(varchar(12) ,@Fld_FldDate,102),'.','-')         
        
if (@str >= '2006-09-01' and @str <='2009-09-01')       
begin                                             
declare @variable table                     
(                      
S char(2),                      
Fld_id varchar(5),                      
server_id int,                      
Fld_Server varchar(50),                      
Fld_Branch_cd varchar(20),                      
Br_Name varchar(50),                      
SBS_IP varchar(20),                      
Remark varchar(50)                      
)                          
insert into @variable                      
exec usp_v_TCP_Servers_new  @Fld_FldDate        
                                               
select S,Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,                                                
isnull(convert(varchar,Fld_Tcp_1015),0) Fld_Tcp_1015,                                                
isnull(convert(varchar,Fld_Tcp_0115),0) Fld_Tcp_0115,                                                
isnull(convert(varchar,Fld_Tcp_0315),0) Fld_Tcp_0315,                                                
isnull(convert(varchar,Fld_Sur_Cnt),0) Fld_Sur_Cnt,                                                
isnull(Fld_Remark,'') Fld_Remark,Fld_Flddate,SBS_ip,Remark,person_name                                            
into #t                                          
 from                                                 
(--select * from V_TCP_Servers where Fld_Branch_cd like @Fld_Branch_cd                      
select * from @variable where Fld_Branch_cd like @Fld_Branch_cd) x                                                
left outer join                                                
(select * from V_Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate)y                                                
on x.Fld_Branch_cd = y.Fld_Branch_Code and x.server_Id = y.Fld_Server_Id and x.S = y.Fld_Flag                                       
--order by   S,Fld_id                                              
order by   Br_Name,S,Fld_Server                                              
                                          
select *,                
Fld_Tcp_1015color=                
case when Fld_Server like '%DIET%' and Fld_Tcp_1015 >= 1000 then 'Red'                
when Fld_Server like '%DIET%' and Fld_Tcp_1015 < 1000 then 'Black'                
when Fld_Server not like '%DIET%' and Fld_Tcp_1015 >= 350 then 'Red'                
when Fld_Server not like '%DIET%' and Fld_Tcp_1015 < 350 then 'Black'                
end,                
Fld_Tcp_0115color=                
case when Fld_Server like '%DIET%' and Fld_Tcp_0115 >= 1000 then 'Red'                
when Fld_Server like '%DIET%' and Fld_Tcp_0115 < 1000 then 'Black'                
when Fld_Server not like '%DIET%' and Fld_Tcp_0115 >= 350 then 'Red'                
when Fld_Server not like '%DIET%' and Fld_Tcp_0115 < 350 then 'Black'                
end,                
Fld_Tcp_0315color=                
case when Fld_Server like '%DIET%' and Fld_Tcp_0315 >= 1000 then 'Red'                
when Fld_Server like '%DIET%' and Fld_Tcp_0315 < 1000 then 'Black'                
when Fld_Server not like '%DIET%' and Fld_Tcp_0315 >= 350 then 'Red'                
when Fld_Server not like '%DIET%' and Fld_Tcp_0315 < 350 then 'Black'                
end                
  from #t where Fld_branch_cd in                                          
(                                          
select Fld_Branch_code from Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate                                          
)         
end    
         
else   
begin    
      
declare @variable1 table                     (                      
S char(2),                      
Fld_id varchar(5),                      
server_id int,                      
Fld_Server varchar(50),                      
Fld_Branch_cd varchar(20),                      
Br_Name varchar(50),                      
SBS_IP varchar(20),                      
Remark varchar(50)                      
)                          
insert into @variable1                      
exec usp_v_TCP_Servers_new  @Fld_FldDate        
                                        
select S,Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,                                              
isnull(convert(varchar,Fld_Tcp_1015),0) Fld_Tcp_1015,                                              
isnull(convert(varchar,Fld_Tcp_0115),0) Fld_Tcp_0115,                                              
isnull(convert(varchar,Fld_Tcp_0315),0) Fld_Tcp_0315,                                              
isnull(convert(varchar,Fld_Sur_Cnt),0) Fld_Sur_Cnt,                                              
isnull(Fld_Remark,'') Fld_Remark,Fld_Flddate,SBS_ip,Remark,person_name                                          
into #t1                                        
 from                                               
(--select * from V_TCP_Servers where Fld_Branch_cd like @Fld_Branch_cd                    
select * from @variable1 where Fld_Branch_cd like @Fld_Branch_cd and fld_server not in('SBS (15)','SBS (20)','SBS (108)','SBS (112)','SBS (95)','SBS (6)','SBS (7)')) x                                              
left outer join                                              
(select * from V_Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate)y                                              
on x.Fld_Branch_cd = y.Fld_Branch_Code and x.server_Id = y.Fld_Server_Id and x.S = y.Fld_Flag                                 
--order by   S,Fld_id                                            
order by   Br_Name,S,Fld_Server                                            
           
                                     
select *,              
Fld_Tcp_1015color=              
case when Fld_Server like '%DIET%' and Fld_Tcp_1015 >= 1000 then 'Red'              
when Fld_Server like '%DIET%' and Fld_Tcp_1015 < 1000 then 'Black'              
when Fld_Server not like '%DIET%' and Fld_Tcp_1015 >= 350 then 'Red'              
when Fld_Server not like '%DIET%' and Fld_Tcp_1015 < 350 then 'Black'              
end,              
Fld_Tcp_0115color=              
case when Fld_Server like '%DIET%' and Fld_Tcp_0115 >= 1000 then 'Red'              
when Fld_Server like '%DIET%' and Fld_Tcp_0115 < 1000 then 'Black'              
when Fld_Server not like '%DIET%' and Fld_Tcp_0115 >= 350 then 'Red'              
when Fld_Server not like '%DIET%' and Fld_Tcp_0115 < 350 then 'Black'              
end,              
Fld_Tcp_0315color=              
case when Fld_Server like '%DIET%' and Fld_Tcp_0315 >= 1000 then 'Red'              
when Fld_Server like '%DIET%' and Fld_Tcp_0315 < 1000 then 'Black'              
when Fld_Server not like '%DIET%' and Fld_Tcp_0315 >= 350 then 'Red'              
when Fld_Server not like '%DIET%' and Fld_Tcp_0315 < 350 then 'Black'              
end              
  from #t1 where Fld_branch_cd in                                        
(                                        
select Fld_Branch_code from Tbl_Tcp_Count where Fld_FldDate = @Fld_FldDate                                        
)           
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_terminal_brok_loss
-- --------------------------------------------------
CREATE proc usp_terminal_brok_loss  
as  
  
select company,Terminal_id,Brokerage=sum(Brokerage)  
into #terminal_brok from terminal_brok where sauda_date >= 'Aug 24 2006' and   
sauda_date <= 'Aug 24 2006'group by company,Terminal_id  
  
select Location,ImpactedSegemnt,Downtimemin=sum(convert(int,Downtimemin)) into #downtime from newtab1  
where dt >= 'Aug 24 2006' and dt <= 'Aug 24 2006' group by Location,ImpactedSegemnt  
  
select b.server,b.segment,Brokerage=sum(a.Brokerage) into #server from #terminal_brok a inner join terminals b   
on a.terminal_id = b.odin_id group by  server,segment  
  
select * into #ser_brok from #server  where server in (select location from  #downtime)  
  
select *, space(20) as dt,space(20) as uptime,space(20) as Brk_Loss into #t from #ser_brok   

select * from #b
  
drop table #a
drop table #tt

select *   
into #a   
from #t LEFT OUTER join #downtime on #t.server = #downtime.location  
  
select bse=sum(bse),CM=sum(CM),Fo=sum(Fo),MCX=sum(MCX),NCDEX=sum(NCDEX)   
into #tt from sett_mst where tdate >= 'Aug 24 2006' and tdate <= 'Aug 24 2006'  
  
update #a set uptime = bse from #tt where #a.segment = 'ABLCM'  
update #a set uptime = cm from #tt where #a.segment = 'ACDLCM'  
update #a set uptime = fo from #tt where #a.segment = 'ACDLFO'  
update #a set uptime = mcx from #tt where #a.segment = 'ACPLNCDEX'  
update #a set uptime = ncdex from #tt where #a.segment = 'ACPLMCX'  
  

------------------------------BSE--------------------------------------------  
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION  
AND #t.SEGMENT in (CASE WHEN #downtime.ImpactedSegemnt = 'BSE' THEN 'ABLCM' END  )

-----------------------------ALL  Segments---------------------------------------- 
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION  
AND #t.SEGMENT LIKE CASE WHEN #downtime.ImpactedSegemnt = 'All Segments' THEN '%' END    

------------------------------CM+FO-------------------------------------------------
UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION  
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLCM' END)

UPDATE #t SET DT = DOWNTIMEMIN FROM #downtime WHERE #t.SERVER = #downtime.LOCATION  
AND #t.SEGMENT IN (CASE WHEN #downtime.ImpactedSegemnt = 'CM + FO' THEN 'ACDLFO' END)

update #t set dt = 0  where dt = ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Test
-- --------------------------------------------------
CREATE Proc Usp_Test @deptname varchar(10)
as    
Select top 10 * from departmentmaster where departmentname = 'KYC'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_TestDataset
-- --------------------------------------------------
Create Proc Usp_TestDataset(@deptname varchar(15))
as
Select deptno,departmentname from departmentmaster where deptno = @deptname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_TestNonQuery
-- --------------------------------------------------

Create Proc Usp_TestNonQuery (@Val varchar(10))
as 

Insert into tbl_Test values(@Val,'A','B',getdate())

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_TestReader
-- --------------------------------------------------

Create Proc Usp_TestReader(@deptname varchar(15))
as
Select distinct top 20 queryfrom from complaint_table where department = @deptname

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport1
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport1(@type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),                                
@Location as varchar(20),@Issue as varchar(50),@username as varchar(15),@access_to as varchar(10),                                
@access_code as varchar(15))                                                                          
as                                              
        
                                                                     
--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                                                            
--set @type='Branch'                
--set @fDate='01/01/2010'                                                            
--set @Tdate= '31/01/2010'                                                            
--set @Location='%%'                                                            
--set @Issue='%%'                                           
                                         
--drop table #temp                                          
--drop table #temp1                                          
--drop table #temp2                                          
--drop table #t                  
--drop table #result                                        
--drop table #result1                                      
                    
create table #temp                
(                
server varchar(255),                
issues varchar(50),                
dt int,                
uptime int,                
Brk_Loss float                
)                                  
set nocount on                                          
                   
if @type='Branch'                      
begin                
insert into #temp                
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                 
from Terminal_Brok_Loss(nolock)                                                                           
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                 
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                  
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                       
Group by Issues,server                                               
end                 
else                
begin                
insert into #temp                
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                    
from Terminal_Brok_Loss(nolock)                
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                 
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                  
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                       
Group by Issues,server                
end                    
                                    
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #temp1                 
from #temp group by Issues                                          
                                         
select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                          
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                      
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #temp2                             
from #temp1                                            
              
create table #t        
(            
team varchar(20),            
Issues varchar(50),            
[Branch engineers] int,            
[Odin Team] int,            
[Nt Team] int,            
System int,            
Infra int,            
RM int,            
Exchange int,            
[Help Desk] int            
)            
            
if @type<>'Branch'                      
begin             
alter table #t drop column [Branch engineers]            
alter table #t add EBroking int            
end                                        
            
if @type='Branch'               
begin            
insert into #t                                          
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                          
from                                                                        
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                        
right outer join                                                                     
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                                        
on a.issues=b.issues            
end            
else            
begin            
insert into #t              
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                                          
from                                                                        
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                        
right outer join                                                                     
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                                        
on a.issues=b.issues            
end                                            
                
            
create table #result            
(            
team varchar(20),            
dt int,            
dtPer decimal,            
uptime int,            
UptimePer decimal,            
Brk_Loss decimal            
)              
         
if @type='Branch'                      
begin             
insert into #result                              
select  b.team,                     
case when b.team='Branch engineers' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Branch engineers])/100,0)),0)                     
when b.team='Odin Team' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Odin Team])/100,0)),0)     
when b.team='Network Team' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Nt Team])/100,0)),0)    
when b.team='System Team' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[System])/100,0)),0)    
when b.team='Infra' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Infra])/100,0)),0)    
when b.team='RM' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[RM])/100,0)),0)    
when b.team='Exchange' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Exchange])/100,0)),0)    
when b.team='Helpdesk' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Help desk])/100,0)),0)                    
end as dt ,                    
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001))
)                   
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                    
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                    
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                    
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                    
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                   
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                    
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                    
end as dtPer,   
case when b.team='Branch engineers' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Branch engineers])/100,0)),0)                     
when b.team='Odin Team' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Odin Team])/100,0)),0)     
when b.team='Network Team' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Nt Team])/100,0)),0)    
when b.team='System Team' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[System])/100,0)),0)    
when b.team='Infra' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Infra])/100,0)),0)    
when b.team='RM' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[RM])/100,0)),0)    
when b.team='Exchange' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Exchange])/100,0)),0)    
when b.team='Helpdesk' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Help desk])/100,0)),0)                    
end as uptime,                    
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0))))   
          
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                    
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                    
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                    
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                    
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                    
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                    
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                    
end as UptimePer,                    
case when b.team='Branch engineers' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Branch engineers])/100),0)                     
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                    
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                    
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                    
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                    
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                    
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                    
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                    
end as Brk_Loss                             
 from                            
(select * from #temp2)a                                          
left outer join                                          
(select * from #t)b                                          
on a.Issues=b.issues              
end            
else            
begin            
insert into #result            
select  b.team,     
case   
when b.team='Odin Team' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Odin Team])/100,0)),0)     
when b.team='Network Team' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Nt Team])/100,0)),0)    
when b.team='System Team' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[System])/100,0)),0)    
when b.team='Infra' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Infra])/100,0)),0)    
when b.team='RM' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[RM])/100,0)),0)    
when b.team='Exchange' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Exchange])/100,0)),0)    
when b.team='Helpdesk' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[Help desk])/100,0)),0)  
when b.team='EBroking' then isnull(convert(int,round(convert(decimal(10,2),a.dt*b.[EBroking])/100,0)),0)                     
end as dt ,                    
case             
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                    
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                    
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                    
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                    
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                    
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                    
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                    
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[EBroking])/100,0)*100)/(isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)))                    
end as dtPer,   
  
case   
when b.team='Odin Team' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Odin Team])/100,0)),0)     
when b.team='Network Team' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Nt Team])/100,0)),0)    
when b.team='System Team' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[System])/100,0)),0)    
when b.team='Infra' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Infra])/100,0)),0)    
when b.team='RM' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[RM])/100,0)),0)    
when b.team='Exchange' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Exchange])/100,0)),0)    
when b.team='Helpdesk' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[Help desk])/100,0)),0)  
when b.team='EBroking' then isnull(convert(int,round(convert(decimal(10,2),a.uptime*b.[EBroking])/100,0)),0)                   
end as uptime,                    
case             
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                    
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                    
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                    
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                    
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                    
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                    
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                    
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[EBroking])/100,0)*100)/(isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)))                    
end as UptimePer,                    
case             
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                    
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                    
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                    
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                    
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                    
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                    
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)            
when b.team='EBroking' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[EBroking])/100),0)                    
end as Brk_Loss                           
 from                                          
(select * from #temp2)a                                          
left outer join                                          
(select * from #t)b                                          
on a.Issues=b.issues              
end                                    
                    
select team,sum(dt)dt,sum(Uptime)Uptime,sum(Brk_Loss)Brk_Loss into #result1                                         
from #result group by team                                          
                                        
                                        
select '<a href=report.aspx?reportno=232&Type='+@type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(team,' ','-')+'>'+team+'</a>' as Team,dt  as DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float
  
    
,uptime)),2)),                    
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                          
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                           
from #result1 where team is not null and dt is not null                               
                                      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport1_All
-- --------------------------------------------------
CREATE proc [dbo].[USP_ThresHoldBranch_GReport1_All](@type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),                                                                      
@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),                                                                      
@access_code as varchar(15),@username as varchar(15))                                                                                                                
as                                                                                    
                                                                                                               
set nocount on                                                                                                              
--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                                                                                                  
--set @type='CSO'                                                      
--set @fDate='01/07/2015'                                                                                                  
--set @Tdate= '31/07/2015'                                                                                                  
--set @Location='%%'                                                                                                  
--set @Issue='%%'                                       
                                                                                 
                                                                                
--drop table #temp                                                                                
--drop table #temp1                                                                                
--drop table #temp2                                                                                
--drop table #t                                                        
--drop table #result                                                                              
--drop table #result1            


--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),@access_code as varchar(15),@username as varchar(15) 

--set @type='ALL'
--set @fDate='01/01/2014'
--set @Tdate='31/01/2014'
--set @Location='%%'
--set @Issue='%%'
--set @access_to='E08430'
--set @access_code='BROKER'
--set @username='CSO'            
                      
if @type ='ALL'                      
begin                      
set @type ='%%'                      
end                                                                          
                                                          
create table #tempBranch                                                      
(                                                      
server varchar(255),                                                      
issues varchar(50),                                                      
dt decimal(14,2),                                                      
uptime int,                                                      
Brk_Loss float                                                      
)                                           
create table #tempCSO                                                     
(                                                      
server varchar(255),                                                      
issues varchar(50),                                                      
dt decimal(14,2),                                                      
uptime int,                                                      
Brk_Loss float                                                      
)                                           
                                                                        
--set nocount on                                                                                
------------------------------------Branch---------------------------------------                                          
insert into #tempBranch                                                      
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                       
from Terminal_Brok_Loss(nolock)                                                                                         
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                       
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd in ('HO','DHO')) and                                                                               
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                
Group by Issues,server                             
                                               
--------------------------------------CSO---------------------------------------                                                            
insert into #tempCSO                            
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                            
from Terminal_Brok_Loss(nolock)                                     
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                      
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd not in ('HO','DHO')) and                                                                                                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                                  
Group by Issues,server                                                      
                                                        
-----------------------------------Branch---------------------------------                                                                                 
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempBranch1                                                       
from #tempbranch group by Issues                                           
-----------------------------------CSO------------------------------------                                                                               
                                                                                
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempCSO1                                                       
from #tempcso group by Issues                                           
-------------------------------------Branch-----------------------------------                                          
select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempBranch2                                                                                 
from #tempBranch1                                             
------------------------------------------CSO------------------------------------------                                                                               
 select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                             
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempCSO2                                           
from #tempCSO1                                              
                                                 
create table #tBranch                                              
(                                                  
team varchar(20),               
Issues varchar(50),                                                  
[Branch engineers] int,                                                  
[Odin Team] int,                                   
[Nt Team] int,                                                  
System int,                                                  
Infra int,                                             
RM int,                                                  
Exchange int,                                                  
[Help Desk] int                  
)                                            
                                          
create table #tCSO                                              
(                                                  
team varchar(20),                                                  
Issues varchar(50),                                                         
[Odin Team] int,                                                  
[Nt Team] int,                                            
System int,                                                  
Infra int,                                                  
RM int,                                                  
Exchange int,                           
[Help Desk] int,                                          
EBroking int                                                
)                                                  
--------------------------------------------Branch-------------------------------------------                                               
insert into #tBranch                                                                                
select b.team,b.issues,[Branch engineers]=isnull(a.[Branch engineers],0),[Odin Team]=isnull(a.[Odin Team],0),[Nt Team]=isnull(a.[Nt Team],0),System=isnull(a.System,0),Infra=isnull(a.Infra,0),RM=isnull(a.RM,0),Exchange=isnull(a.Exchange,0),               
  
     
     
       
[Helpdesk]=isnull(a.[Help Desk],0)                                                                                
from                                                                                                              
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                                                              
right outer join                                   
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                                                                              
on a.issues=b.issues                                                  
-----------------------------------------CSO----------------------------------------------                                                 
insert into #tCSO                                                    
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                                                                                
from                                                                                                              
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                                                            
right outer join                                                                                                           
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                    
on a.issues=b.issues                  
----------------------------------------------------------------------------                                                                                
                                 
                                                  
create table #result                                          
(                                                  
team varchar(20),                                                  
dt decimal(14,2),                                                  
dtPer decimal(14,2),                                                  
uptime int,                                                  
UptimePer decimal,                     
Brk_Loss decimal                                                  
)                                                    
-------------------------------------------BRANCH----------------------                                                 
insert into #result               
                                                                 
select  b.team,                                                           
case when b.team='Branch engineers' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Branch engineers]))/100),0)                                                          
when b.team='Odin Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Odin Team]))/100),0)                                                           
when b.team='Network Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Nt Team]))/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[System]))/100),0)                           
when b.team='Infra' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Infra]))/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[RM]))/100),0)                                         
when b.team='Exchange' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Exchange]))/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Help desk]))/100),0)                                                          
end as dt,                     
                                                         
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)          
+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)               
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)end))                            
            
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                                    
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                    
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                        
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                                 
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)         
when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                         
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                                     
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                                  
end as dtPer,                                                          
                    
                    
case when b.team='Branch engineers' then isnull((a.uptime*b.[Branch engineers])/100,0)                                                           
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                          
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                                          
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                          
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                          
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                          
end as uptime,                 
                   
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)*100)/ case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0))+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,
   
   
      
0                  
)               
when 0 then 1 else isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0) end ))                               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)when 0 then 1 else        
  
    
      
       
(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                             
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001) when 0 then 1 else          
  
    
     
(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                      
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) when 0 then 1 else              
 
(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) end ))                                                    
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001) when 0 then 1 else               
(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end))                                                          
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001) when 0 then 1 else               
(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end))                                                          
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001) when 0 then 1 else           
  
   
 (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                                 
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001) when 0 then 1 else        
  
    
      
       
(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                              
end as UptimePer,                                                          
                
                    
case when b.team='Branch engineers' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Branch engineers])/100),0)                                                           
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                          
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                          
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                          
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                                                          
end as Brk_Loss                                                                   
                    
 from                                                                  
(select * from #tempBranch2)a                                               
right outer join                                                                                
(select * from #tBranch)b                                                         
on a.Issues=b.issues                       
                    
                    
                                     
------------------------------------CSO----------------------------------------------------                                                
insert into #result                                                  
select  b.team,                                                           
case                                        
when b.team='Odin Team' then isnull((a.dt*b.[Odin Team])/100,0)                                                           
when b.team='Network Team' then isnull((a.dt*b.[Nt Team])/100,0)                                
when b.team='System Team' then isnull((a.dt*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.dt*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.dt*b.[RM])/100,0)                                              
when b.team='Exchange' then isnull((a.dt*b.[Exchange])/100,0)                                                      
when b.team='Helpdesk' then isnull((a.dt*b.[Help desk])/100,0)                                                  
when b.team='EBroking' then isnull((a.dt*b.[EBroking])/100,0)                                                           
end as dt,                      
                                                        
case               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001) end ))                                                
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                        
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                          
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                                          
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                          
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                      
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end ))                                                  
            
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                                     
end as dtPer,                                                       
                    
                    
case                                                            
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                          
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                           
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                          
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                          
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                    
when b.team='EBroking' then isnull((a.uptime*b.[EBroking])/100,0)                                                        
end as uptime,                                                          
                    
case                                                   
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                             
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                    
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                          
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                          
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                                 
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                              
            
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                                 
end as UptimePer,                                                          
                    
case                                                   
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                          
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                          
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                          
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                  
when b.team='EBroking' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[EBroking])/100),0)                                                          
end as Brk_Loss                     
                                                                
from                                                                                
(select * from #tempCSO2)a                                                                                
right outer join                                                                                
(select * from #tCSO)b                                                                                
on a.Issues=b.issues       



select sum(uptime) as uptime into #branch from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment )a   
inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment) b on a.segment = b.segment and a.server like '%%' group by a.server,a.segment,b.uptime ) c inner merge join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109)  
and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner merge join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment  
) a inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment ) b on a.segment = b.segment and a.server like '%%'group by a.server,a.segment,b.uptime ) c   
inner merge join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner merge join (select * from V_Server_Master with(nolock))  y on x.server = y.Fld_Id and 
Fld_Branch_cd in  ('TB') 

--print @fDate
if(cast(@fDate as datetime)>='01/09/2014')
Begin
print @fDate
IF OBJECT_ID('tempdb..#CSO') IS NOT NULL
DROP TABLE #CSO


select  IDENTITY(int, 1, 1) AS RowID,sauda_date into #date from terminal_brok_loss where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) 
group by sauda_date

if exists (select * FROM V_Server_Master WITH(NOLOCK) where fld_to_date  >=convert(varchar(12),convert(datetime,@fDate,103),109)
AND fld_to_date  <=convert(varchar(12),convert(datetime,@Tdate,103),109))
Begin
select sum(cast(uptime as int)) as uptime into #disabledServer from  terminal_brok_loss with(nolock) where sauda_date>= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) 
and server=18 and sauda_date in (select sauda_date from #date where RowId <=(SELECT convert(int,Fld_To_Date-convert(varchar(12),convert(datetime,@fDate,103),109)) FROM V_Server_Master WITH(NOLOCK) where fld_to_date  >=convert(varchar(12),convert(datetime,@fDate,103),109)
AND fld_to_date  <=convert(varchar(12),convert(datetime,@Tdate,103),109)))
end
select sum(uptime) as uptime into #CSO from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment )a   
inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment) b on a.segment = b.segment and a.server like '%%' group by a.server,a.segment,b.uptime ) c inner merge join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109)  
and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner merge join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment  
) a inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment ) b on a.segment = b.segment and a.server like '%%'group by a.server,a.segment,b.uptime ) c   
inner merge join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner merge join (select * from V_Server_Master with(nolock))  y on x.server = y.Fld_Id and 
Fld_Branch_cd in  ('DHO') 


SELECT IDENTITY(INT, 1, 1) AS Recid	,* INTO #t
FROM V_Manager_Details WHERE manager_status = 'disabled'
	AND tdate >= convert(varchar(12),convert(datetime,@fDate,103),109)
	AND tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109)


DECLARE @uptime INT,@cnt INT,@cntRcd INT,@todate VARCHAR(12),@segment VARCHAR(10)
set @uptime=0
SET @cnt = 1
SET @cntRcd = (SELECT count(*) FROM #t)
if(@cntRcd>0 and @cntRcd<7)
Begin
WHILE (@cnt <= @cntRcd)
BEGIN
	SET @todate = (
			SELECT convert(VARCHAR(12), tdate, 106)
			FROM #t
			WHERE Recid = @cnt
			)
	SET @segment = (
			SELECT Fld_Segment
			FROM #t
			WHERE Recid = @cnt
			)

	PRINT @todate
	print @segment

	IF (@uptime = 0)
	BEGIN	
		SET @uptime = (
				SELECT sum(uptime) AS uptime
				FROM V_Segment_Master WITH (NOLOCK)
				WHERE tdate >= convert(varchar(12),convert(datetime,@fDate,103),109)
					AND tdate < convert(VARCHAR(12), convert(DATETIME, @todate, 103), 109)
					AND segment = @segment
				GROUP BY segment
				)
			
	END
	ELSE
	BEGIN	    
	    SET @uptime = @uptime+(SELECT sum(uptime) AS uptime
				FROM V_Segment_Master WITH (NOLOCK)
				WHERE tdate >= convert(varchar(12),convert(datetime,@fDate,103),109)
					AND tdate < convert(VARCHAR(12), convert(DATETIME, @todate, 103), 109)
					AND segment = @segment
				GROUP BY segment)		
	END	
	set @cnt=@cnt+1
END

End



End
else
Begin
IF OBJECT_ID('tempdb..#CSO1') IS NOT NULL
DROP TABLE #CSO1
select sum(uptime) as uptime into #CSO1 from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment )a   
inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment) b on a.segment = b.segment and a.server like '%%' group by a.server,a.segment,b.uptime ) c inner merge join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109)  
and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner merge join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment  
) a inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment ) b on a.segment = b.segment and a.server like '%%'group by a.server,a.segment,b.uptime ) c   
inner merge join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner merge join (select * from V_Server_Master with(nolock))  y on x.server = y.Fld_Id and 
Fld_Branch_cd in  ('HO') 
End


                                                                      
                                                          
select team,dt=isnull(sum(dt),0),Uptime=isnull(sum(Uptime),0),Brk_Loss=isnull(sum(Brk_Loss),0) into #result1                                                                             
from #result group by team                                                           


update #result1
set uptime=#branch.uptime
from #branch 
where #result1.team='Branch engineers'
                                         


if(cast(@fDate as datetime)>='01/09/2014')
Begin
update #result1
set uptime=#CSO.uptime
from #CSO 
where #result1.team<>'Branch engineers'   


if exists (select * FROM V_Server_Master WITH(NOLOCK) where fld_to_date  >=convert(varchar(12),convert(datetime,@fDate,103),109)
AND fld_to_date  <=convert(varchar(12),convert(datetime,@Tdate,103),109))
Begin
update #result1
set uptime=#result1.uptime+#disabledServer.uptime
from #disabledServer 
where #result1.team<>'Branch engineers'  
End
if(@uptime<>0)
Begin
update #result1
set uptime=#result1.uptime-@uptime
from #result1
where #result1.team<>'Branch engineers'  
End
end
else
Begin
update #result1
set uptime=#CSO1.uptime
from #CSO1 
where #result1.team<>'Branch engineers'   
end

                          
select '<a href=report.aspx?reportno=260&Type='+@type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(team,' ','-')+'>'+team+'</a>' as Team,dt  as DownTime,      
[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime)) end ,2)),                
uptime,      
--[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime))end,2)),          
[UpTime%]=convert(decimal(14,2),(convert(float,uptime)*100))/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime))end,
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                                                                 
from #result1 where team is not null and dt is not null                                                                      


                                                                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport1_All_10Apr2015
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport1_All_10Apr2015(@type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),                                                                      
@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),                                                                      
@access_code as varchar(15),@username as varchar(15))                                                                                                                
as                                                                                    
                                                                                                               
set nocount on                                                                                                              
--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                                                                                                  
--set @type='CSO'                                                      
--set @fDate='01/03/2010'                                                                                                  
--set @Tdate= '31/03/2010'                                                                                                  
--set @Location='%%'                                                                                                  
--set @Issue='%%'                                       
                                                                                 
                                                                                
--drop table #temp                                                                                
--drop table #temp1                                                                                
--drop table #temp2                                                                                
--drop table #t                                                        
--drop table #result                                                                              
--drop table #result1                         
                      
if @type ='ALL'                      
begin                      
set @type ='%%'                      
end                                                                          
                                                          
create table #tempBranch                                                      
(                                                      
server varchar(255),                                                      
issues varchar(50),                                                      
dt decimal(14,2),                                                      
uptime int,                                                      
Brk_Loss float                                                      
)                                           
create table #tempCSO                                                     
(                                                      
server varchar(255),                                                      
issues varchar(50),                                                      
dt decimal(14,2),                                                      
uptime int,                                                      
Brk_Loss float                                                      
)                                           
                                                                        
--set nocount on                                                                                
------------------------------------Branch---------------------------------------                                          
insert into #tempBranch                                                      
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                       
from Terminal_Brok_Loss(nolock)                                                                                         
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                       
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                               
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                
Group by Issues,server                             
                                               
--------------------------------------CSO---------------------------------------                                                            
insert into #tempCSO                            
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                            
from Terminal_Brok_Loss(nolock)                                     
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                      
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                                                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                                  
Group by Issues,server                                                      
                                                        
-----------------------------------Branch---------------------------------                                                                                 
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempBranch1                                                       
from #tempbranch group by Issues                                           
-----------------------------------CSO------------------------------------                                                                               
                                                                                
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempCSO1                                                       
from #tempcso group by Issues                                           
-------------------------------------Branch-----------------------------------                                          
select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempBranch2                                                                                 
from #tempBranch1                                             
------------------------------------------CSO------------------------------------------                                                                               
 select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                             
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempCSO2                                           
from #tempCSO1                                              
                                                 
create table #tBranch                                              
(                                                  
team varchar(20),               
Issues varchar(50),                                                  
[Branch engineers] int,                                                  
[Odin Team] int,                                   
[Nt Team] int,                                                  
System int,                                                  
Infra int,                                             
RM int,                                                  
Exchange int,                                                  
[Help Desk] int                  
)                                            
                                          
create table #tCSO                                              
(                                                  
team varchar(20),                                                  
Issues varchar(50),                                                         
[Odin Team] int,                                                  
[Nt Team] int,                                            
System int,                                                  
Infra int,                                                  
RM int,                                                  
Exchange int,                           
[Help Desk] int,                                          
EBroking int                                                
)                                                  
--------------------------------------------Branch-------------------------------------------                                               
insert into #tBranch                                                                                
select b.team,b.issues,[Branch engineers]=isnull(a.[Branch engineers],0),[Odin Team]=isnull(a.[Odin Team],0),[Nt Team]=isnull(a.[Nt Team],0),System=isnull(a.System,0),Infra=isnull(a.Infra,0),RM=isnull(a.RM,0),Exchange=isnull(a.Exchange,0),               
  
     
     
       
[Helpdesk]=isnull(a.[Help Desk],0)                                                                                
from                                                                                                              
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                                                              
right outer join                                   
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                                                                              
on a.issues=b.issues                                                  
-----------------------------------------CSO----------------------------------------------                                                 
insert into #tCSO                                                    
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                                                                                
from                                                                                                              
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                                                            
right outer join                                                                                                           
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                    
on a.issues=b.issues                  
----------------------------------------------------------------------------                                                                                
                                 
                                                  
create table #result                                          
(                                                  
team varchar(20),                                                  
dt decimal(14,2),                                                  
dtPer decimal(14,2),                                                  
uptime int,                                                  
UptimePer decimal,                     
Brk_Loss decimal                                                  
)                                                    
-------------------------------------------BRANCH----------------------                                                 
insert into #result               
                                                                 
select  b.team,                                                           
case when b.team='Branch engineers' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Branch engineers]))/100),0)                                                          
when b.team='Odin Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Odin Team]))/100),0)                                                           
when b.team='Network Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Nt Team]))/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[System]))/100),0)                           
when b.team='Infra' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Infra]))/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[RM]))/100),0)                                         
when b.team='Exchange' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Exchange]))/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Help desk]))/100),0)                                                          
end as dt,                     
                                                         
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)          
+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)               
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)end))                            
            
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                                    
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                    
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                        
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                                 
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)         
when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                         
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                                     
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                                  
end as dtPer,                                                          
                    
                    
case when b.team='Branch engineers' then isnull((a.uptime*b.[Branch engineers])/100,0)                                                           
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                          
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                                          
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                          
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                          
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                          
end as uptime,                 
                   
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)*100)/ case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0))+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,
   
   
      
0                  
)               
when 0 then 1 else isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0) end ))                               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)when 0 then 1 else        
  
    
      
       
(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                             
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001) when 0 then 1 else          
  
    
     
(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                      
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) when 0 then 1 else              
 
(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) end ))                                                    
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001) when 0 then 1 else               
(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end))                                                          
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001) when 0 then 1 else               
(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end))                                                          
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001) when 0 then 1 else           
  
   
 (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                                 
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001) when 0 then 1 else        
  
    
      
       
(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                              
end as UptimePer,                                                          
                
                    
case when b.team='Branch engineers' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Branch engineers])/100),0)                                                           
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                          
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                          
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                          
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                                                          
end as Brk_Loss                                                                   
                    
 from                                                                  
(select * from #tempBranch2)a                                               
right outer join                                                                                
(select * from #tBranch)b                                                         
on a.Issues=b.issues                       
                    
                    
                                     
------------------------------------CSO----------------------------------------------------                                                
insert into #result                                                  
select  b.team,                                                           
case                                        
when b.team='Odin Team' then isnull((a.dt*b.[Odin Team])/100,0)                                                           
when b.team='Network Team' then isnull((a.dt*b.[Nt Team])/100,0)                                
when b.team='System Team' then isnull((a.dt*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.dt*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.dt*b.[RM])/100,0)                                              
when b.team='Exchange' then isnull((a.dt*b.[Exchange])/100,0)                                                      
when b.team='Helpdesk' then isnull((a.dt*b.[Help desk])/100,0)                                                  
when b.team='EBroking' then isnull((a.dt*b.[EBroking])/100,0)                                                           
end as dt,                      
                                                        
case               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001) end ))                                                
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                        
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                          
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                                          
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                          
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                      
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end ))                                                  
            
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                                     
end as dtPer,                                                       
                    
                    
case                                                            
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                          
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                           
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                          
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                          
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                    
when b.team='EBroking' then isnull((a.uptime*b.[EBroking])/100,0)                                                        
end as uptime,                                                          
                    
case                                                   
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                             
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                    
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                          
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                          
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                                 
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                              
            
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                                 
end as UptimePer,                                                          
                    
case                                                   
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                          
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                          
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                          
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                  
when b.team='EBroking' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[EBroking])/100),0)                                                          
end as Brk_Loss                     
                                                                
from                                                                                
(select * from #tempCSO2)a                                                                                
right outer join                                                                                
(select * from #tCSO)b                                                                                
on a.Issues=b.issues                                                
                                                                         
                                                          
select team,dt=isnull(sum(dt),0),Uptime=isnull(sum(Uptime),0),Brk_Loss=isnull(sum(Brk_Loss),0) into #result1                                                                             
from #result group by team                                                           
                          
select '<a href=report.aspx?reportno=260&Type='+@type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(team,' ','-')+'>'+team+'</a>' as Team,dt  as DownTime,      
[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime)) end ,2)),                
uptime,      
[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime))end,2)),          
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                                                                 
from #result1 where team is not null and dt is not null                                                                      
                                                                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport1_All_10Sep2015
-- --------------------------------------------------
Create proc [dbo].[USP_ThresHoldBranch_GReport1_All_10Sep2015](@type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),                                                                      
@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),                                                                      
@access_code as varchar(15),@username as varchar(15))                                                                                                                
as                                                                                    
                                                                                                               
set nocount on                                                                                                              
--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                                                                                                  
--set @type='CSO'                                                      
--set @fDate='01/01/2015'                                                                                                  
--set @Tdate= '31/01/2015'                                                                                                  
--set @Location='%%'                                                                                                  
--set @Issue='%%'                                       
                                                                                 
                                                                                
--drop table #temp                                                                                
--drop table #temp1                                                                                
--drop table #temp2                                                                                
--drop table #t                                                        
--drop table #result                                                                              
--drop table #result1            


--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),@access_code as varchar(15),@username as varchar(15) 

--set @type='ALL'
--set @fDate='01/01/2014'
--set @Tdate='31/01/2014'
--set @Location='%%'
--set @Issue='%%'
--set @access_to='E08430'
--set @access_code='BROKER'
--set @username='CSO'            
                      
if @type ='ALL'                      
begin                      
set @type ='%%'                      
end                                                                          
                                                          
create table #tempBranch                                                      
(                                                      
server varchar(255),                                                      
issues varchar(50),                                                      
dt decimal(14,2),                                                      
uptime int,                                                      
Brk_Loss float                                                      
)                                           
create table #tempCSO                                                     
(                                                      
server varchar(255),                                                      
issues varchar(50),                                                      
dt decimal(14,2),                                                      
uptime int,                                                      
Brk_Loss float                                                      
)                                           
                                                                        
--set nocount on                                                                                
------------------------------------Branch---------------------------------------                                          
insert into #tempBranch                                                      
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                       
from Terminal_Brok_Loss(nolock)                                                                                         
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                       
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd in ('HO','DHO')) and                                                                               
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                
Group by Issues,server                             
                                               
--------------------------------------CSO---------------------------------------                                                            
insert into #tempCSO                            
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                            
from Terminal_Brok_Loss(nolock)                                     
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                      
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd not in ('HO','DHO')) and                                                                                                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                                  
Group by Issues,server                                                      
                                                        
-----------------------------------Branch---------------------------------                                                                                 
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempBranch1                                                       
from #tempbranch group by Issues                                           
-----------------------------------CSO------------------------------------                                                                               
                                                                                
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempCSO1                                                       
from #tempcso group by Issues                                           
-------------------------------------Branch-----------------------------------                                          
select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempBranch2                                                                                 
from #tempBranch1                                             
------------------------------------------CSO------------------------------------------                                                                               
 select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                                
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                             
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempCSO2                                           
from #tempCSO1                                              
                                                 
create table #tBranch                                              
(                                                  
team varchar(20),               
Issues varchar(50),                                                  
[Branch engineers] int,                                                  
[Odin Team] int,                                   
[Nt Team] int,                                                  
System int,                                                  
Infra int,                                             
RM int,                                                  
Exchange int,                                                  
[Help Desk] int                  
)                                            
                                          
create table #tCSO                                              
(                                                  
team varchar(20),                                                  
Issues varchar(50),                                                         
[Odin Team] int,                                                  
[Nt Team] int,                                            
System int,                                                  
Infra int,                                                  
RM int,                                                  
Exchange int,                           
[Help Desk] int,                                          
EBroking int                                                
)                                                  
--------------------------------------------Branch-------------------------------------------                                               
insert into #tBranch                                                                                
select b.team,b.issues,[Branch engineers]=isnull(a.[Branch engineers],0),[Odin Team]=isnull(a.[Odin Team],0),[Nt Team]=isnull(a.[Nt Team],0),System=isnull(a.System,0),Infra=isnull(a.Infra,0),RM=isnull(a.RM,0),Exchange=isnull(a.Exchange,0),               
  
     
     
       
[Helpdesk]=isnull(a.[Help Desk],0)                                                                                
from                                                                                                              
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                                                              
right outer join                                   
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                                                                              
on a.issues=b.issues                                                  
-----------------------------------------CSO----------------------------------------------                                                 
insert into #tCSO                                                    
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                                                                                
from                                                                                                              
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                                                            
right outer join                                                                                                           
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                    
on a.issues=b.issues                  
----------------------------------------------------------------------------                                                                                
                                 
                                                  
create table #result                                          
(                                                  
team varchar(20),                                                  
dt decimal(14,2),                                                  
dtPer decimal(14,2),                                                  
uptime int,                                                  
UptimePer decimal,                     
Brk_Loss decimal                                                  
)                                                    
-------------------------------------------BRANCH----------------------                                                 
insert into #result               
                                                                 
select  b.team,                                                           
case when b.team='Branch engineers' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Branch engineers]))/100),0)                                                          
when b.team='Odin Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Odin Team]))/100),0)                                                           
when b.team='Network Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Nt Team]))/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[System]))/100),0)                           
when b.team='Infra' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Infra]))/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[RM]))/100),0)                                         
when b.team='Exchange' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Exchange]))/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Help desk]))/100),0)                                                          
end as dt,                     
                                                         
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)          
+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)               
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)end))                            
            
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                                    
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                    
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                        
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                                 
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)         
when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                         
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                                     
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                                  
end as dtPer,                                                          
                    
                    
case when b.team='Branch engineers' then isnull((a.uptime*b.[Branch engineers])/100,0)                                                           
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                          
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                                          
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                          
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                          
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                          
end as uptime,                 
                   
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)*100)/ case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0))+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,
   
   
      
0                  
)               
when 0 then 1 else isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0) end ))                               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)when 0 then 1 else        
  
    
      
       
(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                             
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001) when 0 then 1 else          
  
    
     
(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                      
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) when 0 then 1 else              
 
(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) end ))                                                    
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001) when 0 then 1 else               
(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end))                                                          
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001) when 0 then 1 else               
(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end))                                                          
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001) when 0 then 1 else           
  
   
 (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                                 
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001) when 0 then 1 else        
  
    
      
       
(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                              
end as UptimePer,                                                          
                
                    
case when b.team='Branch engineers' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Branch engineers])/100),0)                                                           
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                          
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                          
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                          
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                                                          
end as Brk_Loss                                                                   
                    
 from                                                                  
(select * from #tempBranch2)a                                               
right outer join                                                                                
(select * from #tBranch)b                                                         
on a.Issues=b.issues                       
                    
                    
                                     
------------------------------------CSO----------------------------------------------------                                                
insert into #result                                                  
select  b.team,                                                           
case                                        
when b.team='Odin Team' then isnull((a.dt*b.[Odin Team])/100,0)                                                           
when b.team='Network Team' then isnull((a.dt*b.[Nt Team])/100,0)                                
when b.team='System Team' then isnull((a.dt*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.dt*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.dt*b.[RM])/100,0)                                              
when b.team='Exchange' then isnull((a.dt*b.[Exchange])/100,0)                                                      
when b.team='Helpdesk' then isnull((a.dt*b.[Help desk])/100,0)                                                  
when b.team='EBroking' then isnull((a.dt*b.[EBroking])/100,0)                                                           
end as dt,                      
                                                        
case               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001) end ))                                                
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                        
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                          
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                                          
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                          
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                      
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end ))                                                  
            
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                                     
end as dtPer,                                                       
                    
                    
case                                                            
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                          
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                           
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                          
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                          
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                          
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                          
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                    
when b.team='EBroking' then isnull((a.uptime*b.[EBroking])/100,0)                                                        
end as uptime,                                                          
                    
case                                                   
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                             
            
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                
            
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                    
            
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                          
            
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)            
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                          
            
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                                 
            
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)            
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                              
            
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                                 
end as UptimePer,                                                          
                    
case                                                   
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                          
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                          
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                          
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                          
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                          
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                          
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                  
when b.team='EBroking' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[EBroking])/100),0)                                                          
end as Brk_Loss                     
                                                                
from                                                                                
(select * from #tempCSO2)a                                                                                
right outer join                                                                                
(select * from #tCSO)b                                                                                
on a.Issues=b.issues       



select sum(uptime) as uptime into #branch from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment )a   
inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment) b on a.segment = b.segment and a.server like '%%' group by a.server,a.segment,b.uptime ) c inner merge join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109)  
and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner merge join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment  
) a inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment ) b on a.segment = b.segment and a.server like '%%'group by a.server,a.segment,b.uptime ) c   
inner merge join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner merge join (select * from V_Server_Master with(nolock))  y on x.server = y.Fld_Id and 
Fld_Branch_cd in  ('TB') 

--print @fDate
if(cast(@fDate as datetime)>='01/09/2014')
Begin
print @fDate
IF OBJECT_ID('tempdb..#CSO') IS NOT NULL
DROP TABLE #CSO
select sum(uptime) as uptime into #CSO from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment )a   
inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment) b on a.segment = b.segment and a.server like '%%' group by a.server,a.segment,b.uptime ) c inner merge join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109)  
and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner merge join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment  
) a inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment ) b on a.segment = b.segment and a.server like '%%'group by a.server,a.segment,b.uptime ) c   
inner merge join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner merge join (select * from V_Server_Master with(nolock))  y on x.server = y.Fld_Id and 
Fld_Branch_cd in  ('DHO') 
End
else
Begin
IF OBJECT_ID('tempdb..#CSO1') IS NOT NULL
DROP TABLE #CSO1
select sum(uptime) as uptime into #CSO1 from(
select upper(f.server) as server ,f.segment,abrokerage=f.brokerage,abrk_loss=f.brk_loss,uptime=f.Total_uptime,dt=f.Total_Downtime,brokerage=f.Total_brok,  
brk_loss=f.Total_Brok_Loss,dt_per=g.Total_dt,uptime_per=100-Total_dt from ( select c.server,c.segment,c.brokerage,c.brk_loss,Total_uptime=sum(uptime),Total_Downtime=sum(dt),  
DT=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)),Total_brok=d.brokerage,Total_Brok_Loss=d.brk_loss from ( select a.server,  
a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),b.uptime,dt=sum(convert(int,a.Total_dt))  
from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)), 
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment )a   
inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment) b on a.segment = b.segment and a.server like '%%' group by a.server,a.segment,b.uptime ) c inner merge join      
( select server,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum( brk_loss)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109)  
and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server )d on c.server = d.server group by c.server,c.segment,c.brokerage,c.brk_loss,d.brokerage,d.brk_loss  
) f inner merge join ( select c.server,Total_dt=(sum(convert(dec,dt))*100)/sum(convert(dec,uptime)) from (select a.server,a.segment,brokerage=sum(convert(dec,a.brokerage)),brk_loss=sum(convert(dec,a.brk_loss)),  
b.uptime,dt=sum(convert(int,a.Total_dt)) from ( select server,segment,brokerage=convert(varchar(15),sum(distinct brokerage)),brk_loss=convert(varchar(15),sum(brk_loss)),       
Total_dt=sum(convert(dec,dt)) from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by server,segment  
) a inner merge join ( select segment,sum(uptime) as uptime from  V_Segment_Master with(nolock) where tdate >= convert(varchar(12),convert(datetime,@fDate,103),109) and tdate <= convert(varchar(12),convert(datetime,@Tdate,103),109) group by segment ) b on a.segment = b.segment and a.server like '%%'group by a.server,a.segment,b.uptime ) c   
inner merge join ( select server,brokerage=sum(convert(dec,brokerage)),brk_loss=sum(convert(dec,brk_loss))  
from terminal_brok_loss with(nolock) where sauda_date >= convert(varchar(12),convert(datetime,@fDate,103),109) and sauda_date <= convert(varchar(12),convert(datetime,@Tdate,103),109) and server like '%%' group by server  
)d on c.server = d.server group by c.server ) g on f.server = g.server) x inner merge join (select * from V_Server_Master with(nolock))  y on x.server = y.Fld_Id and 
Fld_Branch_cd in  ('HO') 
End


                                                                      
                                                          
select team,dt=isnull(sum(dt),0),Uptime=isnull(sum(Uptime),0),Brk_Loss=isnull(sum(Brk_Loss),0) into #result1                                                                             
from #result group by team                                                           


update #result1
set uptime=#branch.uptime
from #branch 
where #result1.team='Branch engineers'
                                         


if(cast(@fDate as datetime)>='01/09/2014')
Begin
update #result1
set uptime=#CSO.uptime
from #CSO 
where #result1.team<>'Branch engineers'   
end
else
Begin
update #result1
set uptime=#CSO1.uptime
from #CSO1 
where #result1.team<>'Branch engineers'   
end

                          
select '<a href=report.aspx?reportno=260&Type='+@type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(team,' ','-')+'>'+team+'</a>' as Team,dt  as DownTime,      
[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime)) end ,2)),                
uptime,      
[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime))end,2)),          
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                                                                 
from #result1 where team is not null and dt is not null                                                                      


                                                                            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport1_All_13Apr2015
-- --------------------------------------------------
Create proc [dbo].[USP_ThresHoldBranch_GReport1_All_13Apr2015](@type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),                                                                    
@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),                                                                    
@access_code as varchar(15),@username as varchar(15))                                                                                                              
as                                                                                  
                                                                                                             
set nocount on                                                                                                            
--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                                                                                                
--set @type='CSO'                                                    
--set @fDate='01/03/2010'                                                                                                
--set @Tdate= '31/03/2010'                                                                                                
--set @Location='%%'                                                                                                
--set @Issue='%%'                                     
                                                                               
                                                                              
--drop table #temp                                                                              
--drop table #temp1                                                                              
--drop table #temp2                                                                              
--drop table #t                                                      
--drop table #result                                                                            
--drop table #result1                       
                    
if @type ='ALL'                    
begin                    
set @type ='%%'                    
end                                                                        
                                                        
create table #tempBranch                                                    
(                                                    
server varchar(255),                                                    
issues varchar(50),                                                    
dt decimal(14,2),                                                    
uptime int,                                                    
Brk_Loss float                                                    
)                                         
create table #tempCSO                                                   
(                                                    
server varchar(255),                                                    
issues varchar(50),                                                    
dt decimal(14,2),                                                    
uptime int,                                                    
Brk_Loss float                                                    
)                                         
                                                                      
--set nocount on                                                                              
------------------------------------Branch---------------------------------------                                        
insert into #tempBranch                                                    
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                     
from Terminal_Brok_Loss(nolock)                                                                                       
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                     
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                             
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                              
Group by Issues,server                           
                                             
--------------------------------------CSO---------------------------------------                                                          
insert into #tempCSO                          
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                          
from Terminal_Brok_Loss(nolock)                                   
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                    
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                                                      
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                                
Group by Issues,server                                                    
                                                      
-----------------------------------Branch---------------------------------                                                                               
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempBranch1                                                     
from #tempbranch group by Issues                                         
-----------------------------------CSO------------------------------------                                                                             
                                                                              
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempCSO1                                                     
from #tempcso group by Issues                                         
-------------------------------------Branch-----------------------------------                                        
select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                              
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                              
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempBranch2                                                                               
from #tempBranch1                                           
------------------------------------------CSO------------------------------------------                                                                             
 select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                              
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                                              
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempCSO2                                         
from #tempCSO1                                            
                                               
create table #tBranch                                            
(                                                
team varchar(20),             
Issues varchar(50),                                                
[Branch engineers] int,                                                
[Odin Team] int,                                 
[Nt Team] int,                                                
System int,                                                
Infra int,                                           
RM int,                                                
Exchange int,                                                
[Help Desk] int                
)                                          
                                        
create table #tCSO                                            
(                                                
team varchar(20),                                                
Issues varchar(50),                                                       
[Odin Team] int,                                                
[Nt Team] int,                                          
System int,                                                
Infra int,                                                
RM int,                                                
Exchange int,                         
[Help Desk] int,                                        
EBroking int                                              
)                                                
--------------------------------------------Branch-------------------------------------------                                             
insert into #tBranch                                                                              
select b.team,b.issues,[Branch engineers]=isnull(a.[Branch engineers],0),[Odin Team]=isnull(a.[Odin Team],0),[Nt Team]=isnull(a.[Nt Team],0),System=isnull(a.System,0),Infra=isnull(a.Infra,0),RM=isnull(a.RM,0),Exchange=isnull(a.Exchange,0),               
   
   
     
[Helpdesk]=isnull(a.[Help Desk],0)                                                                              
from                                                                                                            
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                                                            
right outer join                                 
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                                                                            
on a.issues=b.issues                                                
-----------------------------------------CSO----------------------------------------------                                               
insert into #tCSO                                                  
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                                                                              
from                                                                                                            
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                                                          
right outer join                                                                                                         
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                  
on a.issues=b.issues                                                
----------------------------------------------------------------------------                                                                              
                               
                                                
create table #result                                        
(                                                
team varchar(20),                                                
dt decimal(14,2),                                                
dtPer decimal(14,2),                                                
uptime int,                                                
UptimePer decimal,                   
Brk_Loss decimal                                                
)                                                  
-------------------------------------------BRANCH----------------------                                               
insert into #result             
                                                               
select  b.team,                                                         
case when b.team='Branch engineers' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Branch engineers]))/100),0)                                                        
when b.team='Odin Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Odin Team]))/100),0)                                                         
when b.team='Network Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Nt Team]))/100),0)                                                        
when b.team='System Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[System]))/100),0)                         
when b.team='Infra' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Infra]))/100),0)                                                        
when b.team='RM' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[RM]))/100),0)                                       
when b.team='Exchange' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Exchange]))/100),0)                                                        
when b.team='Helpdesk' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Help desk]))/100),0)                                                        
end as dt,                   
                                                       
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)        
+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)             
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)end))                          
          
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)          
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                                  
          
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                  
          
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                      
          
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                               
          
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)       
when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                       
          
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                                   
          
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                                
end as dtPer,                                                        
                  
                  
case when b.team='Branch engineers' then isnull((a.uptime*b.[Branch engineers])/100,0)                                                         
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                        
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                                        
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                        
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                        
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                        
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                        
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                        
end as uptime,               
                 
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)*100)/ case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0))+isnull((convert(float,a.uptime)*b.[Branch engineers])/100, 
 
    
0                
)             
when 0 then 1 else isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0) end ))                             
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)when 0 then 1 else        
  
    
     
(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                           
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001) when 0 then 1 else          
  
   
(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                    
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) when 0 then 1 else             
(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001) end ))                                                  
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001) when 0 then 1 else             
(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end))                                                        
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001) when 0 then 1 else             
(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end))                                                        
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001) when 0 then 1 else           
 
 (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                               
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001) when 0 then 1 else        
  
    
     
(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                            
end as UptimePer,                                                        
              
                  
case when b.team='Branch engineers' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Branch engineers])/100),0)                                                         
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                        
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                        
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                        
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                        
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                        
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                        
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                                                        
end as Brk_Loss                                                                 
                  
 from                                                                
(select * from #tempBranch2)a                                                                              
right outer join                                                                              
(select * from #tBranch)b                                                       
on a.Issues=b.issues                     
                  
                  
                                   
------------------------------------CSO----------------------------------------------------                                              
insert into #result                                                
select  b.team,                                                         
case                                      
when b.team='Odin Team' then isnull((a.dt*b.[Odin Team])/100,0)                                                         
when b.team='Network Team' then isnull((a.dt*b.[Nt Team])/100,0)                              
when b.team='System Team' then isnull((a.dt*b.[System])/100,0)                                                        
when b.team='Infra' then isnull((a.dt*b.[Infra])/100,0)                                                        
when b.team='RM' then isnull((a.dt*b.[RM])/100,0)                                            
when b.team='Exchange' then isnull((a.dt*b.[Exchange])/100,0)                                                    
when b.team='Helpdesk' then isnull((a.dt*b.[Help desk])/100,0)                                                
when b.team='EBroking' then isnull((a.dt*b.[EBroking])/100,0)                                                         
end as dt,                    
                                                      
case             
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001) end ))                                              
          
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                                      
          
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                        
          
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                                        
          
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)          
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                        
          
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end))                                    
          
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end ))                                                
          
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)          
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                                   
end as dtPer,                                                     
                  
                  
case                                                          
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                                        
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                         
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                                        
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                                        
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                                        
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                                        
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                                  
when b.team='EBroking' then isnull((a.uptime*b.[EBroking])/100,0)                                                      
end as uptime,                                                        
                  
case                                                 
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)          
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)end ))                                           
          
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)end ))                                              
          
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)end))                                                  
          
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)end ))                                               
          
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)          
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)end ))                                                        
          
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)end ))                                               
          
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)          
when 0 then 1 else (isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)end))                                            
          
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[EBroking])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)           
when 0 then 1 else (isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)end))                                               
end as UptimePer,                                                        
                  
case                                                 
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                                        
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                                        
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                                        
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                                        
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                                        
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                                        
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                
when b.team='EBroking' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[EBroking])/100),0)                                                        
end as Brk_Loss                   
                                                              
from                                                                              
(select * from #tempCSO2)a                                                                              
right outer join                                                                              
(select * from #tCSO)b                                                                              
on a.Issues=b.issues                                              
                                                                       
                                                        
select team,dt=isnull(sum(dt),0),Uptime=isnull(sum(Uptime),0),Brk_Loss=isnull(sum(Brk_Loss),0) into #result1                                                                           
from #result group by team                                                         
                                                   
select '<a href=report.aspx?reportno=260&Type='+@type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(team,' ','-')+'>'+team+'</a>' as Team,dt  as DownTime,    
[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime)) end ,2)),              
uptime,    
[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/case when(convert(float,dt)+convert(float,uptime))=0 then 1 else (convert(float,dt)+convert(float,uptime))end,2)),        
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                                                               
from #result1 where team is not null and dt is not null                                                                    
                                                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport1_All_new
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport1_All_new (@type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),                                                    
@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),                                                    
@access_code as varchar(15),@username as varchar(15))                                                                                              
as                                                                  
                                                                                             
set nocount on                                                                                            
--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                                                                                
--set @type='CSO'                                    
--set @fDate='01/03/2010'                                                                                
--set @Tdate= '31/03/2010'                                                                                
--set @Location='%%'                                                                                
--set @Issue='%%'                     
                                                               
                                                              
--drop table #temp                                                              
--drop table #temp1                                                              
--drop table #temp2                                                              
--drop table #t                                      
--drop table #result                                                            
--drop table #result1       
    
if @type ='ALL'    
begin    
set @type ='%%'    
end                                                        
                                        
create table #tempBranch                                    
(                                    
server varchar(255),                                    
issues varchar(50),                                    
dt decimal(14,2),                                    
uptime int,                                    
Brk_Loss float                                    
)                         
create table #tempCSO                                   
(                                    
server varchar(255),                                    
issues varchar(50),                                    
dt decimal(14,2),                                    
uptime int,                                    
Brk_Loss float                                    
)                         
                                                      
--set nocount on                                                              
------------------------------------Branch---------------------------------------                        
insert into #tempBranch                                    
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                     
from Terminal_Brok_Loss(nolock)                                                                                               
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                     
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                                      
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                           
Group by Issues,server                         
                             
--------------------------------------CSO---------------------------------------                                          
insert into #tempCSO          
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                          
from Terminal_Brok_Loss(nolock)                   
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                    
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                                      
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                
Group by Issues,server                                    
                                      
-----------------------------------Branch---------------------------------                                                               
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempBranch1                                     
from #tempbranch group by Issues                         
-----------------------------------CSO------------------------------------                                                             
                                                              
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempCSO1                                     
from #tempcso group by Issues                         
-------------------------------------Branch-----------------------------------                        
select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                              
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                              
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempBranch2                                                               
from #tempBranch1                           
------------------------------------------CSO------------------------------------------                                                             
 select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                              
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                              
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempCSO2                                                               
from #tempCSO1                            
                               
create table #tBranch                            
(                                
team varchar(20),                                
Issues varchar(50),                                
[Branch engineers] int,                                
[Odin Team] int,                                
[Nt Team] int,                                
System int,                                
Infra int,                                
RM int,                                
Exchange int,                                
[Help Desk] int                                
)                          
                        
create table #tCSO                            
(                                
team varchar(20),                                
Issues varchar(50),                                       
[Odin Team] int,                                
[Nt Team] int,                                
System int,                                
Infra int,                                
RM int,                                
Exchange int,                                [Help Desk] int,                        
EBroking int                              
)                                
--------------------------------------------Branch-------------------------------------------                             
insert into #tBranch                                                              
select b.team,b.issues,[Branch engineers]=isnull(a.[Branch engineers],0),[Odin Team]=isnull(a.[Odin Team],0),[Nt Team]=isnull(a.[Nt Team],0),System=isnull(a.System,0),Infra=isnull(a.Infra,0),RM=isnull(a.RM,0),Exchange=isnull(a.Exchange,0),    
a.[Help Desk]                                                             
from                                                                                            
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                                            
right outer join                 
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like '%')b                                                                                            
on a.issues=b.issues                                
-----------------------------------------CSO----------------------------------------------                               
insert into #tCSO                                  
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                                                              
from                                                                                            
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                                          
right outer join                                                                                         
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like '%')b                                  
on a.issues=b.issues                                
----------------------------------------------------------------------------                                                              
                                    
                                
create table #result                        
(                                
team varchar(20),                                
dt decimal(14,2),                                
dtPer decimal(14,2),                                
uptime int,                                
UptimePer decimal,                                
Brk_Loss decimal                                
)                                  
-------------------------------------------BRANCH----------------------                               
insert into #result                                                  
select  b.team,                                         
case when b.team='Branch engineers' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Branch engineers]))/100),0)                                        
when b.team='Odin Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Odin Team]))/100),0)                                         
when b.team='Network Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Nt Team]))/100),0)                                        
when b.team='System Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[System]))/100),0)                                        
when b.team='Infra' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Infra]))/100),0)                                        
when b.team='RM' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[RM]))/100),0)                                        
when b.team='Exchange' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Exchange]))/100),0)                                        
when b.team='Helpdesk' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Help desk]))/100),0)                                        
end as dt ,   
                                       
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001)))
          
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                                 
  
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                    
  
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                        
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                                        
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                       
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                                     
  
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                                  
  
end as dtPer,                                        
  
  
case when b.team='Branch engineers' then isnull((a.uptime*b.[Branch engineers])/100,0)                                         
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                        
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                        
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                        
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                        
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                        
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                        
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                        
end as uptime  
,  
--  
--  
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)*100)/case (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0))
 when 0 then 1 else (isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)) end ))     
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                             
  
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                
  
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                    
  
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                                        
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                        
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                                 
  
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                              
  
end as UptimePer  
,                                        
  
  
case when b.team='Branch engineers' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Branch engineers])/100),0)                                         
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                        
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                        
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                        
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                        
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                        
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                        
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                                        
end as Brk_Loss                                                 
  
  
 from                                                
(select * from #tempBranch2)a                                                              
left outer join                                                              
(select * from #tBranch)b                                       
on a.Issues=b.issues     
  
  
  
  
  
  
  
  
  
  
  
                               
------------------------------------CSO----------------------------------------------------                              
insert into #result                                
select  b.team,                                         
case                      
when b.team='Odin Team' then isnull((a.dt*b.[Odin Team])/100,0)                                         
when b.team='Network Team' then isnull((a.dt*b.[Nt Team])/100,0)                                        
when b.team='System Team' then isnull((a.dt*b.[System])/100,0)                                        
when b.team='Infra' then isnull((a.dt*b.[Infra])/100,0)                                        
when b.team='RM' then isnull((a.dt*b.[RM])/100,0)                            
when b.team='Exchange' then isnull((a.dt*b.[Exchange])/100,0)                                        
when b.team='Helpdesk' then isnull((a.dt*b.[Help desk])/100,0)                                
when b.team='EBroking' then isnull((a.dt*b.[EBroking])/100,0)                                         
end as dt,    
                                      
case                                 
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                                 
     
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                    
    
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                        
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                                        
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                        
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                    
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                                  
     
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[EBroking])/100,0)*100)/(isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)))                                     
   
end as dtPer  
  
,                                     
  
  
case                                          
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                        
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                        
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                        
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                        
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                        
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                        
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                  
when b.team='EBroking' then isnull((a.uptime*b.[EBroking])/100,0)                                      
end as uptime,                                        
  
case                                 
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                             
  
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                
  
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                    
  
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                               
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                        
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                                 
  
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                              
  
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[EBroking])/100,0)*100)/(isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)))                                 
  
end as UptimePer,                                        
  
case                                 
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                        
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                        
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                        
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                        
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                        
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                        
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                                
when b.team='EBroking' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[EBroking])/100),0)                                        
end as Brk_Loss   
                                              
from                                                              
(select * from #tempCSO2)a                                                              
left outer join                                                              
(select * from #tCSO)b                                                              
on a.Issues=b.issues                                  
                                                       
                                        
select team,sum(dt)dt,sum(Uptime)Uptime,sum(Brk_Loss)Brk_Loss into #result1                                                             
from #result group by team                                                              
                                                            
                                   
select '<a href=report.aspx?reportno=260&Type='+@type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(team,' ','-')+'>'+team+'</a>' as Team,dt  as DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float
  
    
      
        
          
,uptime)),2)),                                        
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                              
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                                               
from #result1 where team is not null and dt is not null                                                   
                                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport1_All_old
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport1_All_old(@type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),                                                  
@Location as varchar(20),@Issue as varchar(50),@access_to as varchar(10),                                                  
@access_code as varchar(15),@username as varchar(15))                                                                                            
as                                                                
                                                                                           
set nocount on                                                                                          
--declare @type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                                                                              
--set @type='CSO'                                  
--set @fDate='01/03/2010'                                                                              
--set @Tdate= '31/03/2010'                                                                              
--set @Location='%%'                                                                              
--set @Issue='%%'                   
                                                             
                                                            
--drop table #temp                                                            
--drop table #temp1                                                            
--drop table #temp2                                                            
--drop table #t                                    
--drop table #result                                                          
--drop table #result1     
  
if @type ='ALL'  
begin  
set @type ='%%'  
end                                                      
                                      
create table #tempBranch                                  
(                                  
server varchar(255),                                  
issues varchar(50),                                  
dt decimal(14,2),                                  
uptime int,                                  
Brk_Loss float                                  
)                       
create table #tempCSO                                 
(                                  
server varchar(255),                                  
issues varchar(50),                                  
dt decimal(14,2),                                  
uptime int,                                  
Brk_Loss float                                  
)                       
                                                    
--set nocount on                                                            
------------------------------------Branch---------------------------------------                      
insert into #tempBranch                                  
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                   
from Terminal_Brok_Loss(nolock)                                                                                             
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                                   
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                                    
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                                         
Group by Issues,server                       
                           
--------------------------------------CSO---------------------------------------                                        
insert into #tempCSO        
select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                        
from Terminal_Brok_Loss(nolock)                 
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                                                                  
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                                    
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                              
Group by Issues,server                                  
                                    
-----------------------------------Branch---------------------------------                                                             
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempBranch1                                   
from #tempbranch group by Issues                       
-----------------------------------CSO------------------------------------                                                           
                                                            
select Issues,sum(Dt)Dt,sum(uptime)uptime,sum(Brk_Loss)Brk_Loss into #tempCSO1                                   
from #tempcso group by Issues                       
-------------------------------------Branch-----------------------------------                      
select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                            
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                            
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempBranch2                                                             
from #tempBranch1                         
------------------------------------------CSO------------------------------------------                                                           
 select Issues,dt,dtPer=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                            
uptime,UptimePer=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                            
convert(decimal(14,2),round(Brk_Loss,2))Brk_Loss into #tempCSO2                                                             
from #tempCSO1                          
                             
create table #tBranch                          
(                              
team varchar(20),                              
Issues varchar(50),                              
[Branch engineers] int,                              
[Odin Team] int,                              
[Nt Team] int,                              
System int,                              
Infra int,                              
RM int,                              
Exchange int,                              
[Help Desk] int                              
)                        
                      
create table #tCSO                          
(                              
team varchar(20),                              
Issues varchar(50),                                     
[Odin Team] int,                              
[Nt Team] int,                              
System int,                              
Infra int,                              
RM int,                              
Exchange int,                              
[Help Desk] int,                      
EBroking int                            
)                              
--------------------------------------------Branch-------------------------------------------                           
insert into #tBranch                                                            
select b.team,b.issues,[Branch engineers]=isnull(a.[Branch engineers],0),[Odin Team]=isnull(a.[Odin Team],0),[Nt Team]=isnull(a.[Nt Team],0),System=isnull(a.System,0),Infra=isnull(a.Infra,0),RM=isnull(a.RM,0),Exchange=isnull(a.Exchange,0),  
[Helpdesk]=isnull(a.[Help Desk],0)                                                            
from                                                                                          
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                                          
right outer join               
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                                                                          
on a.issues=b.issues                              
-----------------------------------------CSO----------------------------------------------                             
insert into #tCSO                                
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                                                            
from                                                                                          
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                                        
right outer join                                                                                       
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                
on a.issues=b.issues                              
----------------------------------------------------------------------------                                                            
                                  
                              
create table #result                      
(                              
team varchar(20),                              
dt decimal(14,2),                              
dtPer decimal(14,2),                              
uptime int,                              
UptimePer decimal,                              
Brk_Loss decimal                              
)                                
-------------------------------------------BRANCH----------------------                             
insert into #result                                                
select  b.team,                                       
case when b.team='Branch engineers' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Branch engineers]))/100),0)                                      
when b.team='Odin Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Odin Team]))/100),0)                                       
when b.team='Network Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Nt Team]))/100),0)                                      
when b.team='System Team' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[System]))/100),0)                                      
when b.team='Infra' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Infra]))/100),0)                                      
when b.team='RM' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[RM]))/100),0)                                      
when b.team='Exchange' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Exchange]))/100),0)                                      
when b.team='Helpdesk' then isnull(convert(decimal(14,2),convert(decimal(14,1),(a.dt*b.[Help desk]))/100),0)                                      
end as dt ,                                      
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)+0.0001))
   
   
      
)        
          
                                     
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                                 
  
    
     
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                    
  
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                      
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                                      
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                     
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                                     
 
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                                  
  
    
end as dtPer,                                      
case when b.team='Branch engineers' then isnull((a.uptime*b.[Branch engineers])/100,0)                                       
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                      
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                      
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                      
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                      
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                      
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                      
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                      
end as uptime,                                      
case when b.team='Branch engineers' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Branch engineers])/100,0)+isnull((convert(float,a.uptime)*b.[Branch engineers])/100,0))))   
  
    
      
        
         
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                             
  
    
      
        
         
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                
  
    
      
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                    
  
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                                      
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                      
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                                 
  
    
     
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                              
  
    
      
        
end as UptimePer,                                      
case when b.team='Branch engineers' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Branch engineers])/100),0)                                       
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                      
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                      
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                      
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                      
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                      
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                      
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                                      
end as Brk_Loss                                               
 from                                              
(select * from #tempBranch2)a                                                            
left outer join                                                            
(select * from #tBranch)b                                     
on a.Issues=b.issues                                
------------------------------------CSO----------------------------------------------------                            
insert into #result                              
select  b.team,                                       
case                    
when b.team='Odin Team' then isnull((a.dt*b.[Odin Team])/100,0)                                       
when b.team='Network Team' then isnull((a.dt*b.[Nt Team])/100,0)                                      
when b.team='System Team' then isnull((a.dt*b.[System])/100,0)                                      
when b.team='Infra' then isnull((a.dt*b.[Infra])/100,0)                                      
when b.team='RM' then isnull((a.dt*b.[RM])/100,0)                          
when b.team='Exchange' then isnull((a.dt*b.[Exchange])/100,0)                                      
when b.team='Helpdesk' then isnull((a.dt*b.[Help desk])/100,0)                              
when b.team='EBroking' then isnull((a.dt*b.[EBroking])/100,0)                                       
end as dt ,                                      
case                               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                                 
  
    
     
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                    
  
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                      
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                                      
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                      
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                  
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                                  
  
   
     
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.dt)*b.[EBroking])/100,0)*100)/(isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)))                                     
 
end as dtPer,                                      
case                                        
when b.team='Odin Team' then isnull((a.uptime*b.[Odin Team])/100,0)                                      
when b.team='Network Team' then isnull((a.uptime*b.[Nt Team])/100,0)                                      
when b.team='System Team' then isnull((a.uptime*b.[System])/100,0)                                      
when b.team='Infra' then isnull((a.uptime*b.[Infra])/100,0)                                      
when b.team='RM' then isnull((a.uptime*b.[RM])/100,0)                                      
when b.team='Exchange' then isnull((a.uptime*b.[Exchange])/100,0)                                      
when b.team='Helpdesk' then isnull((a.uptime*b.[Help desk])/100,0)                                
when b.team='EBroking' then isnull((a.uptime*b.[EBroking])/100,0)                                    
end as uptime,                                      
case                               
when b.team='Odin Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Odin Team])/100,0)+isnull((convert(float,a.uptime)*b.[Odin Team])/100,0)+0.0001)))                             
  
    
      
       
          
when b.team='Network Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Nt Team])/100,0)+isnull((convert(float,a.uptime)*b.[Nt Team])/100,0)+0.0001)))                                
  
    
      
when b.team='System Team' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[System])/100,0)*100)/(isnull((convert(float,a.dt)*b.[System])/100,0)+isnull((convert(float,a.uptime)*b.[System])/100,0)+0.0001)))                                    
  
when b.team='Infra' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Infra])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Infra])/100,0)+isnull((convert(float,a.uptime)*b.[Infra])/100,0)+0.0001)))                             
when b.team='RM' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[RM])/100,0)*100)/(isnull((convert(float,a.dt)*b.[RM])/100,0)+isnull((convert(float,a.uptime)*b.[RM])/100,0)+0.0001)))                                      
when b.team='Exchange' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Exchange])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Exchange])/100,0)+isnull((convert(float,a.uptime)*b.[Exchange])/100,0)+0.0001)))                                 
  
    
     
when b.team='Helpdesk' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[Help desk])/100,0)*100)/(isnull((convert(float,a.dt)*b.[Help desk])/100,0)+isnull((convert(float,a.uptime)*b.[Help desk])/100,0)+0.0001)))                              
  
    
      
        
when b.team='EBroking' then (convert(decimal(10,2),(isnull((convert(float,a.uptime)*b.[EBroking])/100,0)*100)/(isnull((convert(float,a.dt)*b.[EBroking])/100,0)+isnull((convert(float,a.uptime)*b.[EBroking])/100,0)+0.0001)))                                 
  
    
     
end as UptimePer,                                      
case                               
when b.team='Odin Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Odin Team])/100),0)                                      
when b.team='Network Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Nt Team])/100),0)                                      
when b.team='System Team' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[System])/100),0)                                      
when b.team='Infra' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Infra])/100),0)                                      
when b.team='RM' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[RM])/100),0)                                      
when b.team='Exchange' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Exchange])/100),0)                                      
when b.team='Helpdesk' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[Help desk])/100),0)                              
when b.team='EBroking' then isnull(convert(decimal(10,2),(a.Brk_Loss*b.[EBroking])/100),0)                                      
end as Brk_Loss                                             
 from                                                            
(select * from #tempCSO2)a                                                            
left outer join                                                            
(select * from #tCSO)b                                                            
on a.Issues=b.issues                                
                                                     
                                      
select team,sum(dt)dt,sum(Uptime)Uptime,sum(Brk_Loss)Brk_Loss into #result1                                                           
from #result group by team                                                            
                                                          
                                 
select '<a href=report.aspx?reportno=260&Type='+@type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(team,' ','-')+'>'+team+'</a>' as Team,dt  as DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float
  
    
      
        
,uptime)),2)),                                      
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)),2)),                                                            
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                                             
from #result1 where team is not null and dt is not null                                                 
                                                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport2
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport2(@Type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),                      
@access_to varchar(20),@access_code varchar(20))                                                                              
as                                                  
                              
--declare @fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20)                                                                
--set @fDate='01/10/2009'                                                                
--set @Tdate= '31/10/2009'                                                                
--set @Team='Odin team'               
create table #temp              
(              
Fld_Branch_cd varchar(50),              
server varchar(255),              
issues varchar(50),              
dt int,              
uptime int,              
Brk_Loss float              
)               
                                
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp')=1                               
drop table Tbl_ThresHoldTemp                              
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp1')=1                               
drop table Tbl_ThresHoldTemp1                                                            
                   
if @type='Branch'                    
begin              
insert into #temp              
select fld_Branch_Cd,a.*                                
from                               
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss --into #temp                                                                            
from Terminal_Brok_Loss(nolock)                                                                               
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                    
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                      
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                           
Group by server ,Issues)a                              
left outer join                              
(select * from tbl_server_master(nolock)) b                              
on a.server=b.Fld_Id   order by Fld_Branch_cd,server                                              
end               
else              
begin              
insert into #temp              
select fld_Branch_Cd,a.*                                
from                               
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss --into #temp                                                                            
from Terminal_Brok_Loss(nolock)                                                                               
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                    
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                      
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                           
Group by server ,Issues)a                              
left outer join                              
(select * from tbl_server_master(nolock)) b                              
on a.server=b.Fld_Id   order by Fld_Branch_cd,server               
end                                                       
              
create table #t            
(            
team varchar(20),            
Issues varchar(50),            
[Branch engineers] int,    
[Odin Team] int,            
[Nt Team] int,            
System int,            
Infra int,            
RM int,            
Exchange int,            
[Help Desk] int            
)            
           
if @type<>'Branch'                      
begin             
alter table #t drop column [Branch engineers]            
alter table #t add EBroking int            
end              
                 
if @type='Branch'                      
begin            
insert into #t                                          
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                               
from                                                                            
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                            
right outer join                                                                            
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                            
on a.issues=b.issues             
end            
else            
begin            
insert into #t              
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.[EBroking]                                               
from                                                                            
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                            
right outer join                                                                            
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                            
on a.issues=b.issues             
end              
            
create table #temp1            
(            
server varchar(255),            
Fld_Branch_cd varchar(15),            
[BranchEngDT] int,            
[BranchEngUT] int,            
[BranchEngloss] decimal,            
[OdinTeamDT] int,            
[OdinTeamUT] int,            
[OdinTeamloss] decimal,            
[NetworkTeamDT] int,            
[NetworkTeamUT] int,            
[NetworkTeamloss] decimal,            
[SystemTeamDT] int,            
[SystemTeamUT] int,            
[SystemTeamloss] decimal,            
InfraDT int,            
InfraUT int,            
Infraloss decimal,            
RMDT int,            
RMUT int,            
RMloss decimal,            
ExchangeDT int,            
ExchangeUT int,            
Exchangeloss decimal,            
[HelpDeskDT] int,            
[HelpDeskUT] int,            
[HelpDeskloss] decimal            
)              
            
if @type<>'Branch'                      
begin             
alter table #temp1 drop column [BranchEngDT]            
alter table #temp1 drop column [BranchEngUT]            
alter table #temp1 drop column [BranchEngloss]            
            
alter table #temp1 add [EBrokingDT] int            
alter table #temp1 add [EBrokingUT] int            
alter table #temp1 add [EBrokingloss] int            
end                                             
                
if  @type='Branch'              
begin              
insert into #temp1                      
select b.server,b.Fld_Branch_cd,                              
[BranchEngDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Branch engineers])/100,0)),0),[BranchEngUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Branch engineers])/100,0)),0),[BranchEngloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),      
[OdinTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Odin Team])/100,0)),0) ,[OdinTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Odin Team])/100,0)),0),[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                          
[NetworkTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Nt Team])/100,0)),0),[NetworkTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Nt Team])/100,0)),0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                            
[SystemTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.System)/100,0)),0),[SystemTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.System)/100,0)),0),[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                            
InfraDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Infra)/100,0)),0),InfraUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Infra)/100,0)),0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0),
RMDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Rm)/100,0)),0) ,RMUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Rm)/100,0)),0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                       
ExchangeDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Exchange)/100,0)),0),ExchangeUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Exchange)/100,0)),0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0),
[HelpDeskDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Help Desk])/100,0)),0),[HelpDeskUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Help Desk])/100,0)),0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                       
from                               
(select * from #t)a                                                            
left outer join                                                 
(select * from #temp)b                                                            
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd              
            
select Fld_Branch_cd as Bcode,sum(BranchEngDT)BranchEngDT,sum(BranchEngUT)BranchEngUT,sum(BranchEngloss)BranchEngloss,                              
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                              
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                              
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                              
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                              
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                              
sum(HelpDeskloss)HelpDeskloss  into Tbl_ThresHoldTemp from #temp1 group by Fld_Branch_cd             
            
end             
else   
begin           
  
insert into #temp1                      
select b.server,b.Fld_Branch_cd,                              
[OdinTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Odin Team])/100,0)),0) ,[OdinTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Odin Team])/100,0)),0),[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                            
[NetworkTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Nt Team])/100,0)),0),[NetworkTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Nt Team])/100,0)),0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                            
[SystemTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.System)/100,0)),0),[SystemTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.System)/100,0)),0),[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                            
InfraDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Infra)/100,0)),0),InfraUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Infra)/100,0)),0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0),
RMDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Rm)/100,0)),0) ,RMUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Rm)/100,0)),0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                       
ExchangeDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Exchange)/100,0)),0),ExchangeUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Exchange)/100,0)),0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0),
[HelpDeskDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Help Desk])/100,0)),0),[HelpDeskUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Help Desk])/100,0)),0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0),     
[EBrokingDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[EBroking])/100,0)),0),[EBrokingUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[EBroking])/100,0)),0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[EBroking])/100),0)                                
from                               
(select * from #t)a                                                            
left outer join                                                 
(select * from #temp)b                                                            
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd              
            
            
select Fld_Branch_cd as Bcode,                              
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                              
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                              
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                              
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                              
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                              
sum(HelpDeskloss)HelpDeskloss,sum([EBrokingDT])[EBrokingDT],sum([EBrokingUT])[EBrokingUT],sum([EBrokingloss])[EBrokingloss]            
into Tbl_ThresHoldTemp from #temp1 group by Fld_Branch_cd             
            
end                                            
                                                              
declare @ColumnName as varchar(50),@ColumnName1 as varchar(50),@ColumnName2 as varchar(50),@ColumnName3 as varchar(50),@str as varchar(200)                                  
declare @filter as varchar(5)                              
set @filter=(select substring(replace(@team,'-',' ') ,1,4)+'%')                              
--print @filter                              
                              
select RowId=row_number() over(order by name),name into #loop from sys.columns where object_id in (select id from sysobjects where name='Tbl_ThresHoldTemp')                              
and name like @filter                              
                              
Declare @MinRowId int,@MaxRowId int,@CurrRowId int                              
                                     
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #loop                                     
set @CurrRowId=@MinRowId                            
while(@CurrRowId <=@MaxRowId)                                      
Begin                                
                              
if @CurrRowId=1                              
set @ColumnName1=(select name from #loop where RowId=@CurrRowId)                              
                              
if @CurrRowId=2                              
set @ColumnName2=(select name from #loop where RowId=@CurrRowId)                              
                              
if @CurrRowId=3                              
set @ColumnName3=(select name from #loop where RowId=@CurrRowId)                              
                              
set @CurrRowId=@CurrRowId+1                                 
END                              
                              
set @str ='select BCode,'+@ColumnName1+' as dt,'+@ColumnName2+' as Brk_Loss,'+@ColumnName3+' as uptime into Tbl_ThresHoldTemp1 from Tbl_ThresHoldTemp(nolock)'                              
--print @str                              
exec(@str)                              
                            
select '<a href=report.aspx?reportno=234&Type='+@Type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(@Team,' ','-')+'&Branch='+replace(BCode,' ','-')+'>'+BCode+'</a>' as BCode,dt as DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*
  
100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                              
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                              
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]       
from Tbl_ThresHoldTemp1 where BCode is not null                                          
                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport2_All
-- --------------------------------------------------
-- [USP_ThresHoldBranch_GReport2_All] '%%','01/01/2015','31/01/2015','E-Broking','BROKER','CSO'
CREATE proc [dbo].[USP_ThresHoldBranch_GReport2_All](@Type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),                        
@access_to varchar(20),@access_code varchar(20))                                                                                
as                                                    
                                
--declare @fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20)                                                                  
--set @fDate='01/10/2009'                                                                  
--set @Tdate= '31/10/2009'                                                                  
--set @Team='Odin team'                 
create table #tempBranch                
(                
Fld_Branch_cd varchar(50),                
server varchar(255),                
issues varchar(50),                
dt decimal(14,2),                
uptime int,                
Brk_Loss float                
)        
    
create table #tempCSO                
(                
Fld_Branch_cd varchar(50),                
server varchar(255),                
issues varchar(50),                
dt decimal(14,2),                
uptime int,                
Brk_Loss float                
)             
                                  
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp_All')=1                                 
drop table Tbl_ThresHoldTemp_All                                
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp1_All')=1                                 
drop table Tbl_ThresHoldTemp1_All                                                              
                     
------------------------------------------Branch---------------------------------               
insert into #tempBranch                
select fld_Branch_Cd,a.*                                  
from                                 
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss --into #temp                                                                              
from Terminal_Brok_Loss(nolock)                                                                                 
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                      
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd  in ('HO','DHO')) and                                                                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                             
Group by server ,Issues)a                                
left outer join                                
(select * from tbl_server_master(nolock)) b                                
on a.server=b.Fld_Id   order by Fld_Branch_cd,server                                                
-------------------------------------------CSO------------------------------------               
insert into #tempCSO                
select fld_Branch_Cd,a.*                                  
from                                 
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss --into #temp                                                                              
from Terminal_Brok_Loss(nolock)                                                                                 
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                      
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd not in ('HO','DHO')) and                                                                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                
Group by server ,Issues)a                                
left outer join        
(select * from tbl_server_master(nolock)) b                                
on a.server=b.Fld_Id   order by Fld_Branch_cd,server                 
                                                         
-------------------------------------------------------------------------------------               
create table #tBranch              
(              
team varchar(20),              
Issues varchar(50),              
[Branch engineers] int,              
[Odin Team] int,              
[Nt Team] int,              
System int,              
Infra int,              
RM int,              
Exchange int,              
[Help Desk] int              
)     
    
create table #tCSO              
(              
team varchar(20),              
Issues varchar(50),                       
[Odin Team] int,              
[Nt Team] int,              
System int,              
Infra int,              
RM int,              
Exchange int,              
[Help Desk] int,    
EBroking int               
)             
              
------------------------------------Branch--------------------------------------             
insert into #tBranch                                            
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                                 
from                                                                              
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                              
right outer join                                                                              
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                              
on a.issues=b.issues               
-------------------------------------CSO------------------------------------------            
insert into #tCSO                
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.[EBroking]                                                 
from                                                                              
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                              
right outer join                                                                              
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                              
on a.issues=b.issues               
------------------------------------------------------------------------------------              
              
create table #temp1Branch              
(              
server varchar(255),              
Fld_Branch_cd varchar(15),              
[BranchEngDT] decimal(14,2),              
[BranchEngUT] decimal(14,2),              
[BranchEngloss] decimal(14,2),              
[OdinTeamDT] decimal(14,2),              
[OdinTeamUT] decimal(14,2),              
[OdinTeamloss] decimal(14,2),              
[NetworkTeamDT] decimal(14,2),              
[NetworkTeamUT] decimal(14,2),              
[NetworkTeamloss] decimal(14,2),              
[SystemTeamDT] decimal(14,2),              
[SystemTeamUT] decimal(14,2),              
[SystemTeamloss] decimal(14,2),              
InfraDT decimal(14,2),              
InfraUT decimal(14,2),              
Infraloss decimal(14,2),              
RMDT decimal(14,2),              
RMUT decimal(14,2),              
RMloss decimal(14,2),              
ExchangeDT decimal(14,2),              
ExchangeUT decimal(14,2),              
Exchangeloss decimal(14,2),              
[HelpDeskDT] decimal(14,2),              
[HelpDeskUT] decimal(14,2),              
[HelpDeskloss] decimal(14,2)              
)     
    
create table #temp1CSO              
(              
server varchar(255),              
Fld_Branch_cd varchar(15),                        
[OdinTeamDT] int,              
[OdinTeamUT] int,              
[OdinTeamloss] decimal,       
[NetworkTeamDT] int,              
[NetworkTeamUT] int,              
[NetworkTeamloss] decimal,              
[SystemTeamDT] int,              
[SystemTeamUT] int,              
[SystemTeamloss] decimal,              
InfraDT int,              
InfraUT int,              
Infraloss decimal,              
RMDT int,              
RMUT int,              
RMloss decimal,              
ExchangeDT int,              
ExchangeUT int,              
Exchangeloss decimal,              
[HelpDeskDT] int,              
[HelpDeskUT] int,              
[HelpDeskloss] decimal,    
[EBrokingDT] int,              
[EBrokingUT] int,              
[EBrokingloss] int              
)               
    
create table Tbl_ThresHoldTemp_All              
(              
server varchar(255),              
Fld_Branch_cd varchar(15),              
[BranchEngDT] decimal(14,2),              
[BranchEngUT] decimal(14,2),              
[BranchEngloss] decimal(14,2),              
[OdinTeamDT] decimal(14,2),              
[OdinTeamUT] decimal(14,2),              
[OdinTeamloss] decimal(14,2),              
[NetworkTeamDT] decimal(14,2),              
[NetworkTeamUT] decimal(14,2),              
[NetworkTeamloss] decimal(14,2),              
[SystemTeamDT] decimal(14,2),              
[SystemTeamUT] decimal(14,2),              
[SystemTeamloss] decimal(14,2),              
InfraDT decimal(14,2),              
InfraUT decimal(14,2),              
Infraloss decimal(14,2),              
RMDT decimal(14,2),              
RMUT decimal(14,2),              
RMloss decimal(14,2),              
ExchangeDT decimal(14,2),              
ExchangeUT decimal(14,2),              
Exchangeloss decimal(14,2),              
[HelpDeskDT] decimal(14,2),              
[HelpDeskUT] decimal(14,2),              
[HelpDeskloss] decimal(14,2),    
[EBrokingDT] decimal(14,2),              
[EBrokingUT] decimal(14,2),              
[EBrokingloss] decimal(14,2)               
)               
----------------------------------------BRANCH---------------------------               
insert into #temp1Branch                        
select b.server,b.Fld_Branch_cd,                                
[BranchEngDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Branch engineers]))/100),0),[BranchEngUT]=isnull((b.uptime*a.[Branch engineers])/100,0),[BranchEngloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),        
[OdinTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Odin Team]))/100),0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                              
[NetworkTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Nt Team]))/100),0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                              
[SystemTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.System))/100),0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                              
InfraDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Infra))/100),0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                   
,RMDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Rm))/100),0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                           
ExchangeDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Exchange))/100),0),ExchangeUT=isnull((b.uptime*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                                              
,[HelpDeskDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Help Desk]))/100),0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                         
from                                 
(select * from #tBranch)a                                                              
left outer join                                                   
(select * from #tempBranch)b                                                              
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd                
     
insert into Tbl_ThresHoldTemp_All    
(              
Fld_Branch_cd,              
[BranchEngDT],              
[BranchEngUT],              
[BranchEngloss],              
[OdinTeamDT],              
[OdinTeamUT],              
[OdinTeamloss],              
[NetworkTeamDT],              
[NetworkTeamUT],              
[NetworkTeamloss],              
[SystemTeamDT],              
[SystemTeamUT],              
[SystemTeamloss],              
InfraDT,              
InfraUT,              
Infraloss,              
RMDT,              
RMUT,              
RMloss,              
ExchangeDT,              
ExchangeUT,              
Exchangeloss,              
[HelpDeskDT],              
[HelpDeskUT],              
[HelpDeskloss]    
)             
select Fld_Branch_cd as Bcode,sum(BranchEngDT)BranchEngDT,sum(BranchEngUT)BranchEngUT,sum(BranchEngloss)BranchEngloss,                                
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                                
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                                
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                                
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                                
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                                
sum(HelpDeskloss)HelpDeskloss from #temp1Branch group by Fld_Branch_cd               
-----------------------------------CSO---------------------------------------             
insert into #temp1CSO                        
select b.server,b.Fld_Branch_cd,                                
[OdinTeamDT]=isnull((b.dt*a.[Odin Team])/100,0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                              
[NetworkTeamDT]=isnull((b.dt*a.[Nt Team])/100,0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                              
[SystemTeamDT]=isnull((b.dt*a.System)/100,0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                              
InfraDT=isnull((b.dt*a.Infra)/100,0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                              
,RMDT=isnull((b.dt*a.Rm)/100,0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                           
ExchangeDT=isnull((b.dt*a.Exchange)/100,0),ExchangeUT=isnull((b.uptime*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                                              
,[HelpDeskDT]=isnull((b.dt*a.[Help Desk])/100,0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                                
,[EBrokingDT]=isnull((b.dt*a.[EBroking])/100,0),[EBrokingUT]=isnull((b.uptime*a.[EBroking])/100,0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[EBroking])/100),0)                                
from                                 
(select * from #tCSO)a                                                              
left outer join                                                   
(select * from #tempCSO)b                                                              
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd                
              
insert into Tbl_ThresHoldTemp_All    
(              
Fld_Branch_cd,                        
[OdinTeamDT],              
[OdinTeamUT],              
[OdinTeamloss],              
[NetworkTeamDT],              
[NetworkTeamUT],              
[NetworkTeamloss],              
[SystemTeamDT],              
[SystemTeamUT],              
[SystemTeamloss],              
InfraDT,              
InfraUT,              
Infraloss,              
RMDT,              
RMUT,              
RMloss,              
ExchangeDT,              
ExchangeUT,              
Exchangeloss,     
[HelpDeskDT],              
[HelpDeskUT],              
[HelpDeskloss],    
[EBrokingDT],              
[EBrokingUT],              
[EBrokingloss])            
select Fld_Branch_cd as Bcode,                                
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                                
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                                
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                                
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                                
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                                
sum(HelpDeskloss)HelpDeskloss,sum([EBrokingDT])[EBrokingDT],sum([EBrokingUT])[EBrokingUT],sum([EBrokingloss])[EBrokingloss]              
from #temp1CSO group by Fld_Branch_cd               
------------------------------------------------------------------------------                                             
                                                                
declare @ColumnName as varchar(50),@ColumnName1 as varchar(50),@ColumnName2 as varchar(50),@ColumnName3 as varchar(50),@str as varchar(200)                                    
declare @filter as varchar(10)              
if(@team<>'E-Broking')
begin                  
set @filter=(select substring(replace(@team,'-',' ') ,1,4)+'%')                                
End
else
Begin
set @filter=(select replace(@team,'-','')+'%')                                
End
print @filter                                
                                
select RowId=row_number() over(order by name),name into #loop from sys.columns where object_id in (select id from sysobjects where name='Tbl_ThresHoldTemp_All')                                
and name like @filter                                
                                
Declare @MinRowId int,@MaxRowId int,@CurrRowId int                                
                                       
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #loop                                       
set @CurrRowId=@MinRowId                                        
while(@CurrRowId <=@MaxRowId)                                        
Begin                                  
                                
if @CurrRowId=1                                
set @ColumnName1=(select name from #loop where RowId=@CurrRowId)                                
                                
if @CurrRowId=2                                
set @ColumnName2=(select name from #loop where RowId=@CurrRowId)                                
                                
if @CurrRowId=3                                
set @ColumnName3=(select name from #loop where RowId=@CurrRowId)                                
                                
set @CurrRowId=@CurrRowId+1                                   
END                                
                                
set @str ='select Fld_Branch_cd,'+@ColumnName1+' as dt,'+@ColumnName2+' as Brk_Loss,'+@ColumnName3+' as uptime into Tbl_ThresHoldTemp1_All from Tbl_ThresHoldTemp_All(nolock)'                                
print @str                                
exec(@str)                                
                              
select '<a href=report.aspx?reportno=263&Type='+@Type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(@Team,' ','-')+'&Branch='+replace(Fld_Branch_cd,' ','-')+'>'+Fld_Branch_cd+'</a>' as BCode,dt as DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                                
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                                
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]         
from Tbl_ThresHoldTemp1_All where Fld_Branch_cd is not null and dt is not null                                            
                                           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport3
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport3(@Type as varchar(10),@fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10),                
@access_to varchar(20),@access_code varchar(20))                                                                          
as                                              
                     
--declare @fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10)                                                            
--set @fDate='01/10/2009'                                                            
--set @Tdate= '31/10/2009'                                                            
--set @Team='Odin team'                     
--set @branch='BNG'                     
                           
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp2')=1                           
drop table Tbl_ThresHoldTemp2                          
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp3')=1                           
drop table Tbl_ThresHoldTemp3                        
        
create table #temp          
(        
Fld_Branch_cd  varchar(50),        
Fld_Server varchar(255),          
issues varchar(50),          
dt int,          
uptime int,          
Brk_Loss float          
)        
        
if @Type='Branch'                    
begin        
insert into #temp        
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                           
from                           
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                        
from Terminal_Brok_Loss(nolock)                                                                           
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                  
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                       
Group by server ,Issues)a                          
right outer join                          
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                          
on a.server=b.Fld_Id order by Fld_Branch_cd,server                                     
end        
else        
begin        
insert into #temp        
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                           
from                           
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                        
from Terminal_Brok_Loss(nolock)                                                                           
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                  
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                       
Group by server ,Issues)a                          
right outer join                          
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                          
on a.server=b.Fld_Id order by Fld_Branch_cd,server          
end        
    
create table #t      
(      
team varchar(20),      
Issues varchar(50),      
[Branch engineers] int,      
[Odin Team] int,      
[Nt Team] int,      
System int,      
Infra int,      
RM int,      
Exchange int,      
[Help Desk] int      
)      
      
if @type<>'Branch'                
begin       
alter table #t drop column [Branch engineers]      
alter table #t add EBroking int      
end     
           
if @type='Branch'                
begin      
insert into #t                                    
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                             
from                                                                        
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                              
right outer join                                                                      
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                        
on a.issues=b.issues      
end      
else      
begin      
insert into #t        
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.[EBroking]                                         
from                                                                      
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                      
right outer join                                                                      
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                      
on a.issues=b.issues       
end     
------------------------------------------------------------------------------                                          
    
create table #temp1      
(      
Fld_server varchar(255),      
Fld_Branch_cd varchar(15),      
[BranchEngDT] int,      
[BranchEngUT] int,      
[BranchEngloss] decimal,      
[OdinTeamDT] int,      
[OdinTeamUT] int,      
[OdinTeamloss] decimal,      
[NetworkTeamDT] int,      
[NetworkTeamUT] int,      
[NetworkTeamloss] decimal,      
[SystemTeamDT] int,      
[SystemTeamUT] int,      
[SystemTeamloss] decimal,      
InfraDT int,      
InfraUT int,      
Infraloss decimal,      
RMDT int,      
RMUT int,      
RMloss decimal,      
ExchangeDT int,      
ExchangeUT int,      
Exchangeloss decimal,      
[HelpDeskDT] int,      
[HelpDeskUT] int,      
[HelpDeskloss] decimal      
)        
      
if @type<>'Branch'                
begin       
alter table #temp1 drop column [BranchEngDT]      
alter table #temp1 drop column [BranchEngUT]      
alter table #temp1 drop column [BranchEngloss]      
      
alter table #temp1 add [EBrokingDT] int      
alter table #temp1 add [EBrokingUT] int      
alter table #temp1 add [EBrokingloss] int      
end                                       
        
 
if  @type='Branch'        
begin  
     
insert into #temp1                
select b.Fld_server,b.Fld_Branch_cd,                          
[BranchEngDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Branch engineers])/100,0)),0),[BranchEngUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Branch engineers])/100,0)),0),[BranchEngloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),      
[OdinTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Odin Team])/100,0)),0) ,[OdinTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Odin Team])/100,0)),0),[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                          
[NetworkTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Nt Team])/100,0)),0),[NetworkTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Nt Team])/100,0)),0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                            
[SystemTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.System)/100,0)),0),[SystemTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.System)/100,0)),0),[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                            
InfraDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Infra)/100,0)),0),InfraUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Infra)/100,0)),0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0),
RMDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Rm)/100,0)),0) ,RMUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Rm)/100,0)),0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                       
ExchangeDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Exchange)/100,0)),0),ExchangeUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Exchange)/100,0)),0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0),
[HelpDeskDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Help Desk])/100,0)),0),[HelpDeskUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Help Desk])/100,0)),0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                         
from                           
(select * from #t)a                                                        
left outer join                                             
(select * from #temp)b                                                        
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd                            
                                   
select Fld_server as [Server Name],sum(BranchEngDT)BranchEngDT,sum(BranchEngUT)BranchEngUT,sum(BranchEngloss)BranchEngloss,                          
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                          
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                          
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                          
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                          
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                          
sum(HelpDeskloss)HelpDeskloss into Tbl_ThresHoldTemp2                     
from #temp1 group by Fld_server        
      
end       
else      
begin      
insert into #temp1                
select b.Fld_server,b.Fld_Branch_cd,                        
[OdinTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Odin Team])/100,0)),0) ,[OdinTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Odin Team])/100,0)),0),[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                            
[NetworkTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Nt Team])/100,0)),0),[NetworkTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Nt Team])/100,0)),0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                            
[SystemTeamDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.System)/100,0)),0),[SystemTeamUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.System)/100,0)),0),[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                            
InfraDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Infra)/100,0)),0),InfraUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Infra)/100,0)),0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0),
RMDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Rm)/100,0)),0) ,RMUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Rm)/100,0)),0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                       
ExchangeDT=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.Exchange)/100,0)),0),ExchangeUT=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.Exchange)/100,0)),0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0),
[HelpDeskDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[Help Desk])/100,0)),0),[HelpDeskUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[Help Desk])/100,0)),0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0),     
[EBrokingDT]=isnull(convert(int,round(convert(decimal(10,2),b.dt*a.[EBroking])/100,0)),0),[EBrokingUT]=isnull(convert(int,round(convert(decimal(10,2),b.uptime*a.[EBroking])/100,0)),0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[EBroking])/100),0)                      
from                         
(select * from #t)a                                                      
left outer join                                           
(select * from #temp)b                                                      
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd        
      
      
select Fld_server as [Server Name],                        
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                        
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                        
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                        
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                        
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                        
sum(HelpDeskloss)HelpDeskloss,sum([EBrokingDT])[EBrokingDT],sum([EBrokingUT])[EBrokingUT],sum([EBrokingloss])[EBrokingloss]      
into Tbl_ThresHoldTemp2 from #temp1 group by Fld_server       
      
end                                      
-------------------------------------------------------------------------------                     
                                                          
declare @ColumnName as varchar(50),@ColumnName1 as varchar(50),@ColumnName2 as varchar(50),@ColumnName3 as varchar(50),@str as varchar(200)                              
declare @filter as varchar(5)                          
set @filter=(select substring(@team ,1,4)+'%')                          
--print @filter                          
                          
select RowId=row_number() over(order by name),name into #loop from sys.columns where object_id in (select id from sysobjects where name='Tbl_ThresHoldTemp2')                          
and name like @filter                     
                          
Declare @MinRowId int,@MaxRowId int,@CurrRowId int                          
                                 
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #loop                                 
set @CurrRowId=@MinRowId                                  
while(@CurrRowId <=@MaxRowId)                                  
Begin                            
                          
if @CurrRowId=1                          
set @ColumnName1=(select name from #loop where RowId=@CurrRowId)                          
                          
if @CurrRowId=2                          
set @ColumnName2=(select name from #loop where RowId=@CurrRowId)                          
                          
if @CurrRowId=3                          
set @ColumnName3=(select name from #loop where RowId=@CurrRowId)                          
                          
set @CurrRowId=@CurrRowId+1                             
END                          
                          
set @str ='select [Server Name],'+@ColumnName1+' as dt,'+@ColumnName2+' as Brk_Loss,'+@ColumnName3+' as uptime into Tbl_ThresHoldTemp3 from Tbl_ThresHoldTemp2(nolock)'                          
--print @str                          
exec(@str)                          
                        
select '<a href=report.aspx?reportno=235&Type='+@Type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(@Team,' ','-')+'&Branch='+replace(@branch,' ','-')+'&ServerName='+replace([Server Name],' ','-')+'>'+[Server Name]+'</a>' as [Server Name],dt as DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100  )/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                          
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                          
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                           
from Tbl_ThresHoldTemp3 where [Server Name] is not null                                      
                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport3_All
-- --------------------------------------------------
  
CREATE proc USP_ThresHoldBranch_GReport3_All(@Type as varchar(10),@fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10),                      
@access_to varchar(20),@access_code varchar(20))                                                                                
as                                                    
                           
--declare @fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10)                                                                  
--set @fDate='01/10/2009'                                                                  
--set @Tdate= '31/10/2009'                                                                  
--set @Team='Odin team'                           
--set @branch='BNG'                           
                                 
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp2_All')=1                                 
drop table Tbl_ThresHoldTemp2_All                                
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp3_All')=1                                 
drop table Tbl_ThresHoldTemp3_All                              
              
create table #tempBranch                
(              
Fld_Branch_cd  varchar(50),              
Fld_Server varchar(255),                
issues varchar(50),                
dt int,                
uptime int,                
Brk_Loss float                
)       
create table #tempCSO                
(              
Fld_Branch_cd  varchar(50),              
Fld_Server varchar(255),                
issues varchar(50),                
dt int,                
uptime int,                
Brk_Loss float                
)                
-------------------------------Branch-------------------------------            
insert into #tempBranch              
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                                 
from                                 
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                              
from Terminal_Brok_Loss(nolock)                                                                                 
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                      
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                                                                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                             
Group by server ,Issues)a                                
right outer join                                
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                                
on a.server=b.Fld_Id order by Fld_Branch_cd,server                                           
---------------------------------CSO------------------------------             
insert into #tempCSO              
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                                 
from                                 
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                              
from Terminal_Brok_Loss(nolock)                                                                                 
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                      
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                                                                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                            
Group by server ,Issues)a                                
right outer join                 
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                                
on a.server=b.Fld_Id order by Fld_Branch_cd,server                
             
          
create table #tBranch            
(            
team varchar(20),            
Issues varchar(50),            
[Branch engineers] int,            
[Odin Team] int,            
[Nt Team] int,            
System int,            
Infra int,            
RM int,            
Exchange int,            
[Help Desk] int            
)       
      
create table #tCSO            
(            
team varchar(20),            
Issues varchar(50),                 
[Odin Team] int,            
[Nt Team] int,            
System int,            
Infra int,            
RM int,            
Exchange int,            
[Help Desk] int,      
EBroking int            
)            
            
-------------------------------Branch-----------------------------           
insert into #tBranch                                        
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                                   
from                                                                              
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                    
right outer join                                                                            
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                              
on a.issues=b.issues            
----------------------------CSO------------------------------           
insert into #tCSO              
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.[EBroking]                                               
from                                                                            
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                            
right outer join                                                                            
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                            
on a.issues=b.issues             
         
------------------------------------------------------------------------------                                                
          
create table #temp1Branch            
(            
Fld_server varchar(255),            
Fld_Branch_cd varchar(15),            
[BranchEngDT] decimal(14,2),            
[BranchEngUT] decimal(14,2),            
[BranchEngloss] decimal(14,2),            
[OdinTeamDT] decimal(14,2),            
[OdinTeamUT] decimal(14,2),            
[OdinTeamloss] decimal(14,2),            
[NetworkTeamDT] decimal(14,2),            
[NetworkTeamUT] decimal(14,2),            
[NetworkTeamloss] decimal(14,2),            
[SystemTeamDT] decimal(14,2),            
[SystemTeamUT] decimal(14,2),            
[SystemTeamloss] decimal(14,2),            
InfraDT decimal(14,2),            
InfraUT decimal(14,2),            
Infraloss decimal(14,2),            
RMDT decimal(14,2),            
RMUT decimal(14,2),            
RMloss decimal(14,2),            
ExchangeDT decimal(14,2),            
ExchangeUT decimal(14,2),            
Exchangeloss decimal(14,2),            
[HelpDeskDT] decimal(14,2),            
[HelpDeskUT] decimal(14,2),            
[HelpDeskloss] decimal(14,2)            
)         
      
create table #temp1CSO            
(            
Fld_server varchar(255),            
Fld_Branch_cd varchar(15),                 
[OdinTeamDT] decimal(14,2),            
[OdinTeamUT] int,            
[OdinTeamloss] decimal,            
[NetworkTeamDT] int,            
[NetworkTeamUT] int,            
[NetworkTeamloss] decimal,            
[SystemTeamDT] int,            
[SystemTeamUT] int,            
[SystemTeamloss] decimal,            
InfraDT int,            
InfraUT int,            
Infraloss decimal,            
RMDT int,            
RMUT int,            
RMloss decimal,            
ExchangeDT int,            
ExchangeUT int,            
Exchangeloss decimal,            
[HelpDeskDT] int,            
[HelpDeskUT] int,            
[HelpDeskloss] decimal,      
[EBrokingDT] int,            
[EBrokingUT] int,           
[EBrokingloss] int            
)             
          
create table Tbl_ThresHoldTemp2_All            
(            
Fld_server varchar(255),            
Fld_Branch_cd varchar(15),      
[BranchEngDT] decimal(14,2),            
[BranchEngUT] decimal(14,2),            
[BranchEngloss] decimal(14,2),                  
[OdinTeamDT] decimal(14,2),            
[OdinTeamUT] decimal(14,2),            
[OdinTeamloss] decimal(14,2),            
[NetworkTeamDT] decimal(14,2),            
[NetworkTeamUT] decimal(14,2),            
[NetworkTeamloss] decimal(14,2),            
[SystemTeamDT] decimal(14,2),            
[SystemTeamUT] decimal(14,2),            
[SystemTeamloss] decimal(14,2),            
InfraDT decimal(14,2),            
InfraUT decimal(14,2),            
Infraloss decimal(14,2),            
RMDT decimal(14,2),            
RMUT decimal(14,2),            
RMloss decimal(14,2),            
ExchangeDT decimal(14,2),            
ExchangeUT decimal(14,2),            
Exchangeloss decimal(14,2),            
[HelpDeskDT] decimal(14,2),            
[HelpDeskUT] decimal(14,2),            
[HelpDeskloss] decimal(14,2),      
[EBrokingDT] decimal(14,2),            
[EBrokingUT] decimal(14,2),           
[EBrokingloss] decimal(14,2)            
)             
-----------------------------Branch --------------------------            
insert into #temp1Branch                      
select b.Fld_server,b.Fld_Branch_cd,                                
[BranchEngDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Branch engineers]))/100),0),[BranchEngUT]=isnull((b.uptime*a.[Branch engineers])/100,0),[BranchEngloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),         
[OdinTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Odin Team]))/100),0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                              
[NetworkTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Nt Team]))/100),0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                              
[SystemTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.System))/100),0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                              
InfraDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Infra))/100),0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                
,RMDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Rm))/100),0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                                              
ExchangeDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Exchange))/100),0),ExchangeUT=isnull((b.uptime*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                             
,[HelpDeskDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Help Desk]))/100),0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                               
from                                 
(select * from #tBranch)a                                                              
left outer join                                                   
(select * from #tempBranch)b                                                              
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd                                  
       
insert into Tbl_ThresHoldTemp2_All       
(      
Fld_server,            
[BranchEngDT],            
[BranchEngUT],            
[BranchEngloss],                  
[OdinTeamDT],            
[OdinTeamUT],            
[OdinTeamloss],            
[NetworkTeamDT],            
[NetworkTeamUT],            
[NetworkTeamloss],            
[SystemTeamDT],            
[SystemTeamUT],            
[SystemTeamloss],            
InfraDT,            
InfraUT,            
Infraloss,            
RMDT,            
RMUT,            
RMloss,            
ExchangeDT,            
ExchangeUT,            
Exchangeloss,            
[HelpDeskDT],            
[HelpDeskUT],            
[HelpDeskloss]      
)                                        
select Fld_server as [Server Name],sum(BranchEngDT)BranchEngDT,sum(BranchEngUT)BranchEngUT,sum(BranchEngloss)BranchEngloss,                                
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                                
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                                
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                                
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                                
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                                
sum(HelpDeskloss)HelpDeskloss                           
from #temp1Branch group by Fld_server              
------------------------------CSO---------------------------------           
insert into #temp1CSO                      
select b.Fld_server,b.Fld_Branch_cd,                              
[OdinTeamDT]=isnull((b.dt*a.[Odin Team])/100,0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                            
[NetworkTeamDT]=isnull((b.dt*a.[Nt Team])/100,0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                            
[SystemTeamDT]=isnull((b.dt*a.System)/100,0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                            
InfraDT=isnull((b.dt*a.Infra)/100,0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                            
,RMDT=isnull((b.dt*a.Rm)/100,0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                         
ExchangeDT=isnull((b.dt*a.Exchange)/100,0),ExchangeUT=isnull((b.uptime*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                                            
,[HelpDeskDT]=isnull((b.dt*a.[Help Desk])/100,0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                              
,[EBrokingDT]=isnull((b.dt*a.[EBroking])/100,0),[EBrokingUT]=isnull((b.uptime*a.[EBroking])/100,0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[EBroking])/100),0)                              
from                               
(select * from #tCSO)a                                                            
left outer join                                                 
(select * from #tempCSO)b                                                            
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd              
            
insert into Tbl_ThresHoldTemp2_All       
(Fld_server,                     
[OdinTeamDT],            
[OdinTeamUT],            
[OdinTeamloss],            
[NetworkTeamDT],            
[NetworkTeamUT],            
[NetworkTeamloss],            
[SystemTeamDT],            
[SystemTeamUT],      
[SystemTeamloss],            
InfraDT,            
InfraUT,            
Infraloss,            
RMDT,            
RMUT,            
RMloss,            
ExchangeDT,            
ExchangeUT,            
Exchangeloss,            
[HelpDeskDT],            
[HelpDeskUT],            
[HelpDeskloss],      
[EBrokingDT],            
[EBrokingUT],           
[EBrokingloss]       
)            
select Fld_server as [Server Name],                              
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                              
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                              
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                              
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                              
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                              
sum(HelpDeskloss)HelpDeskloss,sum([EBrokingDT])[EBrokingDT],sum([EBrokingUT])[EBrokingUT],sum([EBrokingloss])[EBrokingloss]            
from #temp1CSO group by Fld_server             
                                                 
-------------------------------------------------------------------------------                           
                                                                
declare @ColumnName as varchar(50),@ColumnName1 as varchar(50),@ColumnName2 as varchar(50),@ColumnName3 as varchar(50),@str as varchar(200)                                    
declare @filter as varchar(5)                                
set @filter=(select substring(@team ,1,4)+'%')                                
--print @filter                                
                                
select RowId=row_number() over(order by name),name into #loop from sys.columns where object_id in (select id from sysobjects where name='Tbl_ThresHoldTemp2_All')                                
and name like @filter                           
                                
Declare @MinRowId int,@MaxRowId int,@CurrRowId int                                
                                       
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #loop                                       
set @CurrRowId=@MinRowId                                        
while(@CurrRowId <=@MaxRowId)                                        
Begin                                  
                                
if @CurrRowId=1                                
set @ColumnName1=(select name from #loop where RowId=@CurrRowId)                                
                                
if @CurrRowId=2                                
set @ColumnName2=(select name from #loop where RowId=@CurrRowId)                                
                                
if @CurrRowId=3                                
set @ColumnName3=(select name from #loop where RowId=@CurrRowId)                                
                                
set @CurrRowId=@CurrRowId+1                                   
END                                
                                
set @str ='select Fld_server,'+@ColumnName1+' as dt,'+@ColumnName2+' as Brk_Loss,'+@ColumnName3+' as uptime into Tbl_ThresHoldTemp3_All from Tbl_ThresHoldTemp2_All(nolock)'                                
--print @str                                
exec(@str)                                
                              
select '<a href=report.aspx?reportno=264&Type='+@Type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(@Team,' ','-')+'&Branch='+replace(@branch,' ','-')+'&ServerName='+replace(Fld_server,' ','-')+'>'+Fld_server+'</a>' as [Server Name],dt as DownTime,[
  
    
DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100  )/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                                
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                                
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                                 
from Tbl_ThresHoldTemp3_All where Fld_server is not null                                            
                                
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport4
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport4(@Type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10),@ServerName as varchar(30),                  
@access_to varchar(20),@access_code varchar(20))                                                                            
as                                                
                        
--declare @fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10),@ServerName as varchar(15)                                                              
--set @fDate='01/10/2009'                                                              
--set @Tdate= '31/10/2009'                                                              
--set @Team='Branch Engineers'                       
--set @branch='BNG'                 
--set @ServerName='BANGALORE'                     
                             
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp4')=1                             
drop table Tbl_ThresHoldTemp4                            
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp5')=1                             
drop table Tbl_ThresHoldTemp5               
                      
create table #temp                
(                
Fld_Branch_cd varchar(50),                
Fld_Server varchar(255),                
issues varchar(50),                
dt int,                
uptime int,                
Brk_Loss float                
)                                                                
                     
if @type='Branch'                      
begin                
insert into #temp                
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                             
from                             
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                          
from Terminal_Brok_Loss(nolock)                                                                             
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                  
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO' and Fld_Server=replace(@ServerName,'-',' ')) and                                                                    
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                         
Group by server ,Issues)a                            
right outer join                            
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                            
on a.server=b.Fld_Id order by Fld_Branch_cd,server                                               
end                 
else                
begin                
insert into #temp                
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                             
from                             
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                          
from Terminal_Brok_Loss(nolock)                                                                             
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                  
server in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO' and Fld_Server=replace(@ServerName,'-',' ')) and                                                                    
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                         
Group by server ,Issues)a                            right outer join                            
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                            
on a.server=b.Fld_Id order by Fld_Branch_cd,server                 
end                                            
            
create table #t              
(              
team varchar(20),              
Issues varchar(50),              
[Branch engineers] int,              
[Odin Team] int,              
[Nt Team] int,              
System int,              
Infra int,              
RM int,              
Exchange int,              
[Help Desk] int      )              
              
if @type<>'Branch'                        
begin               
alter table #t drop column [Branch engineers]              
alter table #t add EBroking int              
end                
                   
if @type='Branch'                        
begin              
insert into #t                                            
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                         
from                                                                          
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                          
right outer join                                                                          
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                          
on a.issues=b.issues                
end              
else              
begin              
insert into #t                
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.[EBroking]                                                 
from                                                                              
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                                              
right outer join                                                                              
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                              
on a.issues=b.issues               
end                
            
create table #temp1              
(              
Issues varchar(255),              
Fld_Branch_cd varchar(15),              
[BranchEngDT] int,              
[BranchEngUT] int,              
[BranchEngloss] decimal,              
[OdinTeamDT] int,              
[OdinTeamUT] int,              
[OdinTeamloss] decimal,              
[NetworkTeamDT] int,              
[NetworkTeamUT] int,              
[NetworkTeamloss] decimal,              
[SystemTeamDT] int,              
[SystemTeamUT] int,              
[SystemTeamloss] decimal,              
InfraDT int,              
InfraUT int,              
Infraloss decimal,              
RMDT int,              
RMUT int,              
RMloss decimal,              
ExchangeDT int,              
ExchangeUT int,              
Exchangeloss decimal,              
[HelpDeskDT] int,              
[HelpDeskUT] int,              
[HelpDeskloss] decimal              
)                
              
if @type<>'Branch'                        
begin               
alter table #temp1 drop column [BranchEngDT]              
alter table #temp1 drop column [BranchEngUT]              
alter table #temp1 drop column [BranchEngloss]              
              
alter table #temp1 add [EBrokingDT] int              
alter table #temp1 add [EBrokingUT] int              
alter table #temp1 add [EBrokingloss] int              
end                                               
                 
if  @type='Branch'                
begin                
insert into #temp1                        
select b.Issues,b.Fld_Branch_cd,                            
[BranchEngDT]=isnull((b.dt*a.[Branch engineers])/100,0),[BranchEngUT]=isnull((b.uptime*a.[Branch engineers])/100,0),[BranchEngloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),                                                    
  
[OdinTeamDT]=isnull((b.dt*a.[Odin Team])/100,0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                          
[NetworkTeamDT]=isnull((b.dt*a.[Nt Team])/100,0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                          
[SystemTeamDT]=isnull((b.dt*a.System)/100,0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                          
InfraDT=isnull((b.dt*a.Infra)/100,0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                          
,RMDT=isnull((b.dt*a.Rm)/100,0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                                          
ExchangeDT=isnull((b.dt*a.Exchange)/100,0),ExchangeUT=isnull((b.uptime*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                         
,[HelpDeskDT]=isnull((b.dt*a.[Help Desk])/100,0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                            
from                             
(select * from #t)a                                                          
left outer join                                               
(select * from #temp)b                                                          
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd                              
                                    
select Issues,sum(BranchEngDT)BranchEngDT,sum(BranchEngUT)BranchEngUT,sum(BranchEngloss)BranchEngloss,                            
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                            
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                            
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                            
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                            
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                            
sum(HelpDeskloss)HelpDeskloss  into Tbl_ThresHoldTemp4                       
from #temp1 group by Issues              
              
end               
else              
begin              
insert into #temp1                        
select b.Issues,b.Fld_Branch_cd,                                
[OdinTeamDT]=isnull((b.dt*a.[Odin Team])/100,0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                              
[NetworkTeamDT]=isnull((b.dt*a.[Nt Team])/100,0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                              
[SystemTeamDT]=isnull((b.dt*a.System)/100,0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                              
InfraDT=isnull((b.dt*a.Infra)/100,0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                              
,RMDT=isnull((b.dt*a.Rm)/100,0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                         ExchangeDT=isnull((b.dt*a.Exchange)/100,0),ExchangeUT=isnull((b.uptime*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                                              
,[HelpDeskDT]=isnull((b.dt*a.[Help Desk])/100,0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                                
,[EBrokingDT]=isnull((b.dt*a.[EBroking])/100,0),[EBrokingUT]=isnull((b.uptime*a.[EBroking])/100,0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[EBroking])/100),0)                                
from                                 
(select * from #t)a                                       
left outer join                                                   
(select * from #temp)b                                                              
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd                
              
              
select Issues,                                
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                                
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                                
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                                
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                                
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                                
sum(HelpDeskloss)HelpDeskloss,sum([EBrokingDT])[EBrokingDT],sum([EBrokingUT])[EBrokingUT],sum([EBrokingloss])[EBrokingloss]              
into Tbl_ThresHoldTemp4 from #temp1 group by Issues               
              
end                             
                                                            
declare @ColumnName as varchar(50),@ColumnName1 as varchar(50),@ColumnName2 as varchar(50),@ColumnName3 as varchar(50),@str as varchar(200)                                
declare @filter as varchar(5)                            
set @filter=(select substring(replace(@team,'-',' ') ,1,4)+'%')                            
--print @filter                            
                            
select RowId=row_number() over(order by name),name into #loop from sys.columns where object_id in (select id from sysobjects where name='Tbl_ThresHoldTemp4')                            
and name like @filter                            
                            
Declare @MinRowId int,@MaxRowId int,@CurrRowId int                            
                                   
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #loop                                   
set @CurrRowId=@MinRowId                                    
while(@CurrRowId <=@MaxRowId)                                    
Begin                              
                            
if @CurrRowId=1                            
set @ColumnName1=(select name from #loop where RowId=@CurrRowId)                            
                            
if @CurrRowId=2                            
set @ColumnName2=(select name from #loop where RowId=@CurrRowId)                            
                            
if @CurrRowId=3                            
set @ColumnName3=(select name from #loop where RowId=@CurrRowId)                            
                            
set @CurrRowId=@CurrRowId+1                               
END        
                            
set @str ='select Issues,'+@ColumnName1+' as dt,'+@ColumnName2+' as Brk_Loss,'+@ColumnName3+' as uptime into Tbl_ThresHoldTemp5 from Tbl_ThresHoldTemp4(nolock)'                            
--print @str                            
exec(@str)                            
                          
select '<a href=report.aspx?reportno=236&type='+@Type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(@Team,' ','-')+'&Branch='+replace(@branch,' ','-')+'&ServerName='+replace(@ServerName,' ','-')+'&Issues='+replace(Issues,' ','-')+'>'+Issues+'</a>' as Issues,dt as 
    
DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                            
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                           
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                                             
from Tbl_ThresHoldTemp5 where Issues is not null                                        
                                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport4_All
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport4_All(@Type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10),@ServerName as varchar(30),                                                    
@access_to varchar(20),@access_code varchar(20))                                                                                                              
as                                                                                  
                                                          
--declare @fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@Type as varchar(11),@branch as varchar(10),@ServerName as varchar(15)                                                                                              
--set @fDate='01/03/2010'                                                                                              
--set @Tdate= '31/03/2010'                                                                                              
--set @Team='Branch Engineers'                                                       
--set @branch='BOK'                                                 
--set @ServerName='BOK (25)'             
--set @Type='All'                                                       
   set @ServerName=replace(@ServerName,'-',' ')            
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp4_All')=1                                                               
drop table Tbl_ThresHoldTemp4_All                                                              
if (select count(name) from sysobjects where name like 'Tbl_ThresHoldTemp5_All')=1                                                               
drop table Tbl_ThresHoldTemp5_All                                                 
                                                        
create table #tempBranch                                                  
(                                                  
Fld_Branch_cd varchar(50),                                                  
Fld_Server varchar(255),                                                  
issues varchar(50),                                                  
dt decimal(14,2),                                                  
uptime int,                                                  
Brk_Loss float                                                  
)                                  
                                
create table #tempCSO                                                  
(                                                  
Fld_Branch_cd varchar(50),                                                  
Fld_Server varchar(255),                                                  
issues varchar(50),                                                  
dt decimal(14,2),                                                  
uptime int,                                                  
Brk_Loss float                                                  
)                                                                                                 
                                                       
------------------------------------Branch------------------------                      
                    
                                               
insert into #tempBranch                              
                                            
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                                                               
from                                                               
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                                                            
from Terminal_Brok_Loss(nolock)                                                                                                               
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                  
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO' and Fld_Server=replace(@ServerName,'-',' ')) and                                                            
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                                                         
Group by server ,Issues)a                    
right outer join                                                              
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                        
on a.server=b.Fld_Id                           
where Fld_Server=@ServerName                         
order by Fld_Branch_cd,server                             
                             
----------------------------------CSO---------------------------------                       
                    
insert into #tempCSO                                                  
select b.fld_Branch_Cd,b.Fld_Server,a.Issues,a.dt,a.uptime,a.Brk_Loss                                                               
from                                                               
(select server,Issues,sum(convert(int,dt))dt,sum(convert(int,uptime))uptime,sum(convert(float,Brk_Loss))Brk_Loss                                                                                                            
from Terminal_Brok_Loss(nolock)                                                                                                               
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and                                                                                                    
server in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd = 'HO' and Fld_Server=replace(@ServerName,'-',' ')) and                                                                                                      
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                  
Group by server ,Issues)a                            right outer join                                                              
(select * from tbl_server_master(nolock) where fld_Branch_cd=replace(@branch,'-',' ')) b                                                              
on a.server=b.Fld_Id order by Fld_Branch_cd,server                                                   
-----------------------------------------------------------------------                          
                                              
create table #tBranch                                                
(                                                
team varchar(20),                 
Issues varchar(50),                                                
[Branch engineers] int,                                                
[Odin Team] int,                       
[Nt Team] int,                                                
System int,                                                
Infra int,                                                
RM int,                                                
Exchange int,                                 
[Help Desk] int)                                  
                                
create table #tCSO                                                
(                                                
team varchar(20),                                                
Issues varchar(50),                                                                
[Odin Team] int,                                                
[Nt Team] int,                                                
System int,                                                
Infra int,                                                
RM int,                                                
Exchange int,                                                
[Help Desk] int,                                
EBroking int)                                              
                                                
                                                 
-------------------------------Branch--------------------------------------                    
                    
                                               
insert into #tBranch                                                                              
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                                                           
from                                                                                                            
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                                                                  
right outer join                                                                                                            
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                                                            
on a.issues=b.issues                                                  
--------------------------------CSO----------------------------------------                                               
                    
                    
insert into #tCSO                                                  
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.[EBroking]                                                                                   
from                                                                                                                
(select * from Tbl_ThresHoldCSO_Master(nolock) where status='A')a                                                
right outer join                                                                                                                
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team like replace(@Team,'-',' '))b                                                                                             
on a.issues=b.issues                                                 
-----------------------------------------------------------------------------                                                  
                                              
create table #temp1Branch                                                
(                                                
Issues varchar(255),                        
Fld_Branch_cd varchar(15),                                                
[BranchEngDT] decimal(14,2),                                                
[BranchEngUT] decimal(14,2),                                                
[BranchEngloss] decimal(14,2),                                                
[OdinTeamDT] decimal(14,2),                                                
[OdinTeamUT] decimal(14,2),                                                
[OdinTeamloss] decimal(14,2),                                                
[NetworkTeamDT] decimal(14,2),                                                
[NetworkTeamUT] decimal(14,2),                                                
[NetworkTeamloss] decimal(14,2),                                                
[SystemTeamDT] decimal(14,2),                                                
[SystemTeamUT] decimal(14,2),                                                
[SystemTeamloss] decimal(14,2),                                                
InfraDT decimal(14,2),                                                
InfraUT decimal(14,2),                                                
Infraloss decimal(14,2),                                                
RMDT decimal(14,2),                                                
RMUT decimal(14,2),                                                
RMloss decimal(14,2),                        
ExchangeDT decimal(14,2),                                                
ExchangeUT decimal(14,2),                                                
Exchangeloss decimal(14,2),                                                
[HelpDeskDT] decimal(14,2),                                                
[HelpDeskUT] decimal(14,2),                                                
[HelpDeskloss] decimal(14,2)                                                
)                                  
                                    
create table #temp1CSO                                               
(                                                
Issues varchar(255),                                                
Fld_Branch_cd varchar(15),                                                                
[OdinTeamDT] decimal(14,2),                                                
[OdinTeamUT] decimal(14,2),                       
[OdinTeamloss] decimal(14,2),                                                
[NetworkTeamDT] decimal(14,2),                                                
[NetworkTeamUT] decimal(14,2),                                                
[NetworkTeamloss] decimal(14,2),                                                
[SystemTeamDT] decimal(14,2),                                                
[SystemTeamUT] decimal(14,2),                                                
[SystemTeamloss] decimal(14,2),                                           
InfraDT decimal(14,2),                                                
InfraUT decimal(14,2),                                                
Infraloss decimal(14,2),                                                
RMDT decimal(14,2),                                                
RMUT decimal(14,2),                                                
RMloss decimal(14,2),                                                
ExchangeDT decimal(14,2),                                                
ExchangeUT decimal(14,2),                                                
Exchangeloss decimal(14,2),                                   
[HelpDeskDT] decimal(14,2),                                                
[HelpDeskUT] decimal(14,2),                                                
[HelpDeskloss] decimal(14,2),                                
[EBrokingDT] decimal(14,2),                                                
[EBrokingUT] decimal(14,2),                                                
[EBrokingloss] decimal(14,2)                                                 
)                                     
                                
create table Tbl_ThresHoldTemp4_All                 
(                                                
Issues varchar(255),                                                
Fld_Branch_cd varchar(15),                               
[BranchEngDT] decimal(14,2),                                                
[BranchEngUT] decimal(14,2),                                                
[BranchEngloss] decimal(14,2),                                                                
[OdinTeamDT] decimal(14,2),                                                
[OdinTeamUT] decimal(14,2),                                                
[OdinTeamloss] decimal(14,2),                                                
[NetworkTeamDT] decimal(14,2),                                                
[NetworkTeamUT] decimal(14,2),                                                
[NetworkTeamloss] decimal(14,2),                                                
[SystemTeamDT] decimal(14,2),                                                
[SystemTeamUT] decimal(14,2),                               
[SystemTeamloss] decimal(14,2),                                                
InfraDT decimal(14,2),                                                
InfraUT decimal(14,2),                                                
Infraloss decimal(14,2),                                                
RMDT decimal(14,2),                                                
RMUT decimal(14,2),                                                
RMloss decimal(14,2),                                                
ExchangeDT decimal(14,2),                                                
ExchangeUT decimal(14,2),                                                
Exchangeloss decimal(14,2),                                                
[HelpDeskDT] decimal(14,2),                                                
[HelpDeskUT] decimal(14,2),                                                
[HelpDeskloss] decimal(14,2),                                
[EBrokingDT] decimal(14,2),                                                
[EBrokingUT] decimal(14,2),                                
[EBrokingloss] decimal(14,2)                                                 
)                                              
------------------------------------------Branch----------------------------                     
                
          
                    
                                              
insert into #temp1Branch                                                          
select b.Issues,b.Fld_Branch_cd,                                                              
[BranchEngDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Branch engineers]))/100),0),[BranchEngUT]=isnull((b.uptime*a.[Branch engineers])/100,0),[BranchEngloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),      
 
    
     
[OdinTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Odin Team]))/100),0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),          
[NetworkTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Nt Team]))/100),0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),          
[SystemTeamDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.System))/100),0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                     
  
    
     
                                                      
          
InfraDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Infra))/100),0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                                
  
    
      
                        
,RMDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Rm))/100),0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                                                                
  
    
      
            
ExchangeDT=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.Exchange))/100),0),ExchangeUT=isnull((b.uptime*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                              
  
    
      
                             
,[HelpDeskDT]=isnull(convert(decimal(14,2),convert(decimal(14,1),(b.dt*a.[Help Desk]))/100),0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                              
  
    
      
                                
from                                                               
(select * from #tBranch)a                                                                                            
left outer join                                                                     
(select * from #tempBranch)b                                                                                            
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd        
                                
insert into Tbl_ThresHoldTemp4_All                                
(Issues,                                                
[BranchEngDT],                                                
[BranchEngUT],                                                
[BranchEngloss],                                                                
[OdinTeamDT],                                                
[OdinTeamUT],                                                
[OdinTeamloss],                                                
[NetworkTeamDT],                                                
[NetworkTeamUT],                                                
[NetworkTeamloss],                               
[SystemTeamDT],                                                
[SystemTeamUT],                                                
[SystemTeamloss],                                                
InfraDT,                                                
InfraUT,                                                
Infraloss,                                                
RMDT,                                                
RMUT,                                                
RMloss,                                                
ExchangeDT,                                                
ExchangeUT,                                                
Exchangeloss,                                                
[HelpDeskDT],                                                
[HelpDeskUT],                                                
[HelpDeskloss]                                
)                                
select Issues,sum(BranchEngDT)BranchEngDT,sum(BranchEngUT)BranchEngUT,sum(BranchEngloss)BranchEngloss,                                                              
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                                                              
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                                                              
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                                                              
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,                                                              
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                                                              
sum(HelpDeskloss)HelpDeskloss                                                         
from #temp1Branch group by Issues                                 
-------------------------------------CSO----------------------------------------                                               
                    
                                            
insert into #temp1CSO                                                          
select b.Issues,b.Fld_Branch_cd,                                                                  
[OdinTeamDT]=isnull((b.dt*a.[Odin Team])/100,0) ,[OdinTeamUT]=isnull((b.uptime*a.[Odin Team])/100,0) ,[OdinTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                                                       
   
    
     
         
         
             
              
                
                  
                    
                      
                          
[NetworkTeamDT]=isnull((b.dt*a.[Nt Team])/100,0) ,[NetworkTeamUT]=isnull((b.uptime*a.[Nt Team])/100,0) , [NetworkTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                                                      
  
    
      
        
          
            
              
                
                  
                    
                      
                            
[SystemTeamDT]=isnull((b.dt*a.System)/100,0) ,[SystemTeamUT]=isnull((b.uptime*a.System)/100,0) ,[SystemTeamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                                                                   
  
    
      
        
          
            
             
InfraDT=isnull((b.dt*a.Infra)/100,0),InfraUT=isnull((b.uptime*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                                                                                
,RMDT=isnull((b.dt*a.Rm)/100,0),RMUT=isnull((b.uptime*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                         ExchangeDT=isnull((b.dt*a.Exchange)/100,0),ExchangeUT=isnull((b.uptime*a.Exchange)/  
  
    
      
        
          
            
              
                
                  
                    
                      
100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                                                                                
,[HelpDeskDT]=isnull((b.dt*a.[Help Desk])/100,0),[HelpDeskUT]=isnull((b.uptime*a.[Help Desk])/100,0),[HelpDeskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                                                                  
,[EBrokingDT]=isnull((b.dt*a.[EBroking])/100,0),[EBrokingUT]=isnull((b.uptime*a.[EBroking])/100,0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[EBroking])/100),0)                                                                  
from                                                                   
(select * from #tCSO)a                                                                         
left outer join                                                                                     
(select * from #tempCSO)b                                                                                                
on a.issues=b.issues where Fld_Branch_cd is not null order by Fld_Branch_cd                                                  
                                                
insert into Tbl_ThresHoldTemp4_All                                
(Issues,                                                                                
[OdinTeamDT],        
[OdinTeamUT],                                                
[OdinTeamloss],                                                
[NetworkTeamDT],                                                
[NetworkTeamUT],                                                
[NetworkTeamloss],                                                
[SystemTeamDT],                                                
[SystemTeamUT],                                                
[SystemTeamloss],                                                
InfraDT,                                                
InfraUT,                                                
Infraloss,                                                
RMDT,                                                
RMUT,                                                
RMloss,                                                
ExchangeDT,                                                
ExchangeUT,                                                
Exchangeloss,                                                
[HelpDeskDT],                                                
[HelpDeskUT],                                                
[HelpDeskloss],                                
[EBrokingDT],                                          
[EBrokingUT],                                                
[EBrokingloss])                                        
select Issues,                                                                  
sum(OdinTeamDT)OdinTeamDT,sum(OdinTeamUT)OdinTeamUT,sum(OdinTeamloss)OdinTeamloss,sum(NetworkTeamDT)NetworkTeamDT,                                                                  
sum(NetworkTeamUT)NetworkTeamUT,sum(NetworkTeamloss)NetworkTeamloss,sum(SystemTeamDT)SystemTeamDT,                                                                  
sum(SystemTeamUT)SystemTeamUT,sum(SystemTeamloss)SystemTeamloss,sum(InfraDT)InfraDT,sum(InfraUT)InfraUT,                                                                  
sum(Infraloss)Infraloss,sum(RMDT)RMDT,sum(RMUT)RMUT,sum(RMloss)RMloss,sum(ExchangeDT)ExchangeDT,             
sum(ExchangeUT)ExchangeUT,sum(Exchangeloss)Exchangeloss,sum(HelpDeskDT)HelpDeskDT,sum(HelpDeskUT)HelpDeskUT,                                                                  
sum(HelpDeskloss)HelpDeskloss,sum([EBrokingDT])[EBrokingDT],sum([EBrokingUT])[EBrokingUT],sum([EBrokingloss])[EBrokingloss]                                                
from #temp1CSO group by Issues                                                 
--------------------------------------------------------------------------------                                                              
                    
                                                                                     
declare @ColumnName as varchar(50),@ColumnName1 as varchar(50),@ColumnName2 as varchar(50),@ColumnName3 as varchar(50),@str as varchar(200)                                                                  
declare @filter as varchar(5)                                                              
set @filter=(select substring(replace(@team,'-',' ') ,1,4)+'%')                    
--print @filter                                                              
                                                              
select RowId=row_number() over(order by name),name into #loop from sys.columns where object_id in (select id from sysobjects where name='Tbl_ThresHoldTemp4_All')                      
and name like @filter                                                              
                                                        
Declare @MinRowId int,@MaxRowId int,@CurrRowId int                                                              
                                                                     
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #loop                                               
set @CurrRowId=@MinRowId                                                                      
while(@CurrRowId <=@MaxRowId)                                                                      
Begin                                  
                                                              
if @CurrRowId=1                                  
set @ColumnName1=(select name from #loop where RowId=@CurrRowId)                                                              
                                     
if @CurrRowId=2                                                              
set @ColumnName2=(select name from #loop where RowId=@CurrRowId)                                                              
                                                              
if @CurrRowId=3                                                              
set @ColumnName3=(select name from #loop where RowId=@CurrRowId)                                                              
                                                              
set @CurrRowId=@CurrRowId+1                                                                 
END                                          
                      
set @str ='select Issues,'+@ColumnName1+' as dt,'+@ColumnName2+' as Brk_Loss,'+@ColumnName3+' as uptime into Tbl_ThresHoldTemp5_All from Tbl_ThresHoldTemp4_All(nolock)'                                                              
--print @str                                   
exec(@str)                                                             
                                                      
select '<a href=report.aspx?reportno=236&type='+@Type+'&fDate='+@fDate+'&tDate='+@Tdate+'&Team='+replace(@Team,' ','-')+'&Branch='+replace(@branch,' ','-')+'&ServerName='+replace(@ServerName,' ','-')+'&Issues='+replace(Issues,' ','-')+'>'+Issues+'</a>' as
         
 Issues,dt as                                    
DownTime,[DownTime%]=convert(decimal(14,2),round((convert(float,dt)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                                                              
uptime,[UpTime%]=convert(decimal(14,2),round((convert(float,uptime)*100)/(convert(float,dt)+convert(float,uptime)+0.0001),2)),                                                             
convert(decimal(14,2),round(Brk_Loss,2)) as [Brokerage Loss]                              
from Tbl_ThresHoldTemp5_All where Issues is not null                                                                          
                                                                          
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_GReport5
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_GReport5(@Type as varchar(11),@fDate as varchar(11), @tdate as varchar(11),@Team as varchar(20),@Branch as varchar(10),@ServerName as varchar(30),@Issues as varchar(50),                      
@access_to varchar(20),@access_code varchar(20))                                                                                
as                                                    
                            
--declare @Type as varchar(11),@fDate as varchar(11), @Tdate as varchar(11),@Team as varchar(20),@branch as varchar(10),@ServerName as varchar(30),@Issue as varchar(50)                                                                  
--set @Type='CSO'        
--set @fDate='01/10/2009'                                                                
--set @Tdate= '31/10/2009'                                                                
--set @Team='Odin-Team'                         
--set @branch='HO'                   
--set @ServerName='AKRUTI-CLIENT-(44)'          
--set @Issue='ODIN-ISSUE'               
        
--select * from tbl_server_master(nolock)        
--select * from Newtab1(nolock) where location=78        
             
select convert(varchar,a.Dt,103)Date,b.Fld_Server as Server,a.TimeFrom,a.TimeTo,a.EventParticulars as [Event Particulars],a.Solution,a.Problem as Issue,a.ImpactedSegemnt as [Affected Segment],        
a.downtime,a.Remark        
from                       
(select * from Newtab1(nolock) where Location in (select Fld_Id from tbl_server_master(nolock) where Fld_server=replace(@ServerName ,'-',' ') and Fld_Branch_cd=@branch)        
and Problem=replace(@Issues ,'-',' ') and dt>=convert(datetime,@fDate,103) and dt<=convert(datetime,@Tdate,103))a        
left Outer Join         
(select Fld_Id,Fld_Server from tbl_server_master(nolock))b        
on a.location =b.Fld_Id        
        
--select a.dt,a.uptime,a.Brk_Loss from        
--(select * from Terminal_Brok_Loss(nolock) where sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103))a        
--left outer join         
--(select Fld_Id,Fld_Server from tbl_server_master(nolock) where Fld_Server=replace(@ServerName,'-',' '))b        
--on a.server =b.Fld_Id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ThresHoldBranch_Master
-- --------------------------------------------------

  
CREATE proc Usp_ThresHoldBranch_Master          
(                  
@Issues varchar(50),          
@BranchEngineers int,         
@OdinTeam int,          
@NtTeam int,          
@System int,          
@Infra int,          
@RM int,          
@Exchange int,          
@HelpDesk int        
)          
as       
  
declare @VarId as int   
set @VarId=(select max(Id) from Tbl_ThresHoldBranch_Master(nolock) where Issues=@Issues)  
update Tbl_ThresHoldBranch_Master set Status='D',FromDate=getdate() where Id=@VarId   
  
insert into Tbl_ThresHoldBranch_Master values  
(  
@Issues,          
@BranchEngineers,         
@OdinTeam,          
@NtTeam,          
@System,          
@Infra,          
@RM,          
@Exchange,          
@HelpDesk,  
getdate(),  
getdate(),  
'A'  
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_Report
-- --------------------------------------------------
CREATE proc USP_ThresHoldBranch_Report(@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50))                        
as                        
                 
--declare @fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)          
--set @fDate='01/10/2009'          
--set @Tdate= '27/11/2009'          
--set @Location='%%'          
--set @Issue='%%'          
                 
select b.Fld_server,a.Issues,a.dt,a.Brk_Loss into #Terminal_Brok_Loss from          
(          
select server,Issues,sum(convert(int,dt))dt,sum(convert(float,Brk_Loss))Brk_Loss                      
from Terminal_Brok_Loss(nolock)                         
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and               
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                
sauda_date>=convert(datetime,'01/10/2009',103) and sauda_date<=convert(datetime,'27/11/2009',103)+ ' 23:59:59.899'                     
Group by Issues,server)a          
left outer join          
(select Fld_Id,Fld_server from tbl_server_master(nolock) where Fld_Branch_cd <>'HO')b          
on a.server=b.Fld_Id                               
                     
select b.team,b.issue,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                      
into #t from                      
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                      
right outer join                      
(select  * from Tbl_ThresHoldTeamToIssueMapping(nolock) where Issue like @Issue)b                      
on a.issues=b.issue                      
                              
select b.Fld_server,a.team,a.issue,                      
[Branch engineers]=isnull((b.dt*a.[Branch engineers])/100,0),[Branch engineersloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),                      
[Odin Team]=isnull((b.dt*a.[Odin Team])/100,0) ,[Odin Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                      
[Network Team]=isnull((b.dt*a.[Nt Team])/100,0) , [Network Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                      
[System Team]=isnull((b.dt*a.System)/100,0) ,[System Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                      
Infra=isnull((b.dt*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                      
,RM=isnull((b.dt*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                      
Exchange=isnull((b.dt*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                      
,[Help Desk]=isnull((b.dt*a.[Help Desk])/100,0),[Help Deskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0) into #result from                      
(select * from #t)a                      
left outer join                      
(select  * from #Terminal_Brok_Loss(nolock))b                      
on a.issue=b.issues order by Fld_server          
          
select * from #result where Fld_server is not null      
select Fld_server,convert(int,count(Fld_server))CFld_server from #result where Fld_server is not null     
 group by Fld_server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_Report1
-- --------------------------------------------------

CREATE proc USP_ThresHoldBranch_Report1(@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50))                              
as                              
                       
--declare @fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                
--set @fDate='01/10/2009'                
--set @Tdate= '27/11/2009'                
--set @Location='%%'                
--set @Issue='%%'                
                       
select b.Fld_server,a.Issues,a.dt,a.Brk_Loss into #Terminal_Brok_Loss from                
(                
select server,Issues,sum(convert(int,dt))dt,sum(convert(float,Brk_Loss))Brk_Loss                            
from Terminal_Brok_Loss(nolock)                               
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                     
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                      
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                           
Group by Issues,server)a                
left outer join                
(select Fld_Id,Fld_server from tbl_server_master(nolock) where Fld_Branch_cd <>'HO')b                
on a.server=b.Fld_Id                                     
                           
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                            
into #t from                            
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                            
right outer join                            
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                            
on a.issues=b.issues                            
                                    
select b.Fld_server,a.team,a.issues,                            
[Branch engineers]=isnull((b.dt*a.[Branch engineers])/100,0),[Branch engineersloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),                            
[Odin Team]=isnull((b.dt*a.[Odin Team])/100,0) ,[Odin Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                            
[Network Team]=isnull((b.dt*a.[Nt Team])/100,0) , [Network Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                            
[System Team]=isnull((b.dt*a.System)/100,0) ,[System Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                            
Infra=isnull((b.dt*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                            
,RM=isnull((b.dt*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                            
Exchange=isnull((b.dt*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                            
,[Help Desk]=isnull((b.dt*a.[Help Desk])/100,0),[Help Deskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0) into #result from                            
(select * from #t)a                            
left outer join                            
(select  * from #Terminal_Brok_Loss(nolock))b                            
on a.issues=b.issues order by Fld_server                
                
select Fld_server,team,issues as issue,[Branch engineers],[Branch engineersloss],[Odin Team],[Odin Teamloss],[Network Team],      
[Network Teamloss],[System Team],[System Teamloss],Infra,Infraloss,RM,RMloss,Exchange,Exchangeloss,[Help Desk] as HelpDesk,      
[Help Deskloss] as HelpDeskloss from #result where Fld_server is not null    
          
select Fld_server,convert(int,count(Fld_server))CFld_server from #result where Fld_server is not null           
 group by Fld_server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldBranch_View
-- --------------------------------------------------
create proc USP_ThresHoldBranch_View    
as    
select * from Tbl_ThresHoldBranch_Master(nolock) where Status='A'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ThresHoldCSO_Master
-- --------------------------------------------------
  
CREATE proc Usp_ThresHoldCSO_Master          
(                  
@Issues varchar(50),                
@OdinTeam int,          
@NtTeam int,          
@System int,          
@Infra int,          
@RM int,          
@Exchange int,          
@HelpDesk int,
@EBroking int        
)          
as       
  
declare @VarId as int   
set @VarId=(select max(Id) from Tbl_ThresHoldCSO_Master(nolock) where Issues=@Issues)  
update Tbl_ThresHoldCSO_Master set Status='D',FromDate=getdate() where Id=@VarId   

insert into Tbl_ThresHoldCSO_Master values  
(  
@Issues,               
@OdinTeam,          
@NtTeam,          
@System,          
@Infra,          
@RM,          
@Exchange,          
@HelpDesk,  
getdate(),  
getdate(),  
'A',
@EBroking  
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldCSO_Report
-- --------------------------------------------------
CREATE proc USP_ThresHoldCSO_Report(@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50))                      
as       
  
--declare @fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)            
--set @fDate='01/10/2009'            
--set @Tdate= '27/11/2009'            
--set @Location='%%'            
--set @Issue='%%'      
              
select b.Fld_server,a.Issues,a.dt,a.Brk_Loss into #Terminal_Brok_Loss from            
(            
select server,Issues,sum(convert(int,dt))dt,sum(convert(float,Brk_Loss))Brk_Loss --into #Terminal_Brok_Loss                   
from Terminal_Brok_Loss(nolock)                       
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and server like @Location and                
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and              
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                   
Group by Issues,server)a            
left outer join            
(select Fld_Id,Fld_server from tbl_server_master(nolock) where Fld_Branch_cd ='HO')b            
on a.server=b.Fld_Id        
                         
                    
select b.team,b.issue,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                    
into #t from                    
(select * from Tbl_ThresHoldCSO_Master(nolock)where status='A' )a                    
right outer join                    
(select  * from Tbl_ThresHoldTeamToIssueMapping(nolock) where Team <>'Branch engineers' and Issue like @Issue)b                    
on a.issues=b.issue                    
                    
select b.Fld_server,a.team,a.issue,                    
--[Branch engineers]=isnull((b.dt*a.[Branch engineers])/100,0),[Branch engineersloss]=isnull((b.Brk_Loss*a.[Branch engineers])/100,0),                    
[Odin Team]=isnull((b.dt*a.[Odin Team])/100,0) ,[Odin Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100),0),                    
[Network Team]=isnull((b.dt*a.[Nt Team])/100,0) , [Network Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                    
[System Team]=isnull((b.dt*a.System)/100,0) ,[System Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                    
Infra=isnull((b.dt*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                    
,RM=isnull((b.dt*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                    
Exchange=isnull((b.dt*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                    
,[Help Desk]=isnull((b.dt*a.[Help Desk])/100,0),[Help Deskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)      
,[EBroking]=isnull((b.dt*a.EBroking)/100,0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.EBroking)/100),0) into #result from                    
(select * from #t)a                    
left outer join                    
(select  *from #Terminal_Brok_Loss(nolock))b                    
on a.issue=b.issues   
  
select * from #result where Fld_server is not null        
select Fld_server,convert(int,count(Fld_server))CFld_server from #result where Fld_server is not null       
 group by Fld_server

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldCSO_Report1
-- --------------------------------------------------
CREATE proc USP_ThresHoldCSO_Report1(@fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50))                                
as                 
            
--declare @fDate as varchar(11), @Tdate as varchar(11),@Location as varchar(20),@Issue as varchar(50)                      
--set @fDate='01/10/2009'                      
--set @Tdate= '27/11/2009'                      
--set @Location='%%'                      
--set @Issue='%%'                
                  
------------------------------------For CSO Calculation--------------------------------- --------------           
select b.Fld_server,a.Issues,a.dt,a.Brk_Loss into #Terminal_Brok_Loss from                      
(                      
select server,Issues,sum(convert(int,dt))dt,sum(convert(float,Brk_Loss))Brk_Loss --into #Terminal_Brok_Loss                             
from Terminal_Brok_Loss(nolock)                                 
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and server like @Location and                          
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd <>'HO') and                        
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                             
Group by Issues,server)a                      
left outer join                      
(select Fld_Id,Fld_server from tbl_server_master(nolock) where Fld_Branch_cd ='HO')b                      
on a.server=b.Fld_Id                  
                                   
                              
select b.team,b.issues,a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk],a.EBroking                              
into #t from                              
(select * from Tbl_ThresHoldCSO_Master(nolock)where status='A')a                              
right outer join                              
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Team <>'Branch engineers' and Issues like @Issue)b                              
on a.issues=b.issues                              
                              
select b.Fld_server,a.team,a.issues,                              
--[Branch engineers]=isnull((b.dt*a.[Branch engineers])/100,0),[Branch engineersloss]=isnull((b.Brk_Loss*a.[Branch engineers])/100,0),                              
[Odin Team]=isnull((b.dt*a.[Odin Team])/100,0) ,[Odin Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100),0),                              
[Network Team]=isnull((b.dt*a.[Nt Team])/100,0) , [Network Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                              
[System Team]=isnull((b.dt*a.System)/100,0) ,[System Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                              
Infra=isnull((b.dt*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                              
,RM=isnull((b.dt*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                              
Exchange=isnull((b.dt*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                              
,[Help Desk]=isnull((b.dt*a.[Help Desk])/100,0),[Help Deskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0)                
,[EBroking]=isnull((b.dt*a.EBroking)/100,0),[EBrokingloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.EBroking)/100),0) into #result from                              
(select * from #t)a                              
left outer join                              
(select  *from #Terminal_Brok_Loss(nolock))b                              
on a.issues=b.issues             
            
-------------------------------------------------------------------------------------------------------------      
---------------------------------------For Branch------------------------------------------------------------                         
                          
select b.Fld_server,a.Issues,a.dt,a.Brk_Loss into #Terminal_Brok_Loss_Branch from                        
(                        
select server,Issues,sum(convert(int,dt))dt,sum(convert(float,Brk_Loss))Brk_Loss                                    
from Terminal_Brok_Loss(nolock)                                       
where Sauda_date <>'2020-03-21 00:00:00.000'and issues<>'' and  server like @Location and                             
server not in (select Fld_Id from tbl_server_master(nolock) where Fld_Branch_cd ='HO') and                              
sauda_date>=convert(datetime,@fDate,103) and sauda_date<=convert(datetime,@Tdate,103)+ ' 23:59:59.899'                                   
Group by Issues,server)a                        
left outer join                        
(select Fld_Id,Fld_server from tbl_server_master(nolock) where Fld_Branch_cd <>'HO')b                        
on a.server=b.Fld_Id                                             
                                   
select b.team,b.issues,a.[Branch engineers],a.[Odin Team],a.[Nt Team],a.System,a.Infra,a.RM,a.Exchange,a.[Help Desk]                                    
into #t_Branch from                                    
(select * from Tbl_ThresHoldBranch_Master(nolock) where status='A')a                                    
right outer join                                    
(select  * from Tbl_ThresHoldTeamToIssueMapping1(nolock) where Issues like @Issue)b                                    
on a.issues=b.issues                                    
                                            
select b.Fld_server,a.team,a.issues,                                    
[Branch engineers]=isnull((b.dt*a.[Branch engineers])/100,0),[Branch engineersloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Branch engineers])/100),0),                                    
[Odin Team]=isnull((b.dt*a.[Odin Team])/100,0) ,[Odin Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Odin Team])/100,0),0),                                    
[Network Team]=isnull((b.dt*a.[Nt Team])/100,0) , [Network Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Nt Team])/100),0),                                    
[System Team]=isnull((b.dt*a.System)/100,0) ,[System Teamloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.System)/100),0),                                    
Infra=isnull((b.dt*a.Infra)/100,0),Infraloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Infra)/100),0)                                    
,RM=isnull((b.dt*a.Rm)/100,0),RMloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Rm)/100),0),                                    
Exchange=isnull((b.dt*a.Exchange)/100,0),Exchangeloss=isnull(convert(decimal(10,2),(b.Brk_Loss*a.Exchange)/100),0)                                    
,[Help Desk]=isnull((b.dt*a.[Help Desk])/100,0),[Help Deskloss]=isnull(convert(decimal(10,2),(b.Brk_Loss*a.[Help Desk])/100),0) into #result_Branch from                                    
(select * from #t_Branch)a                                    
left outer join                                    
(select  * from #Terminal_Brok_Loss_Branch(nolock))b                                    
on a.issues=b.issues order by Fld_server                        
        
      
select Fld_server,team,issues,[Branch engineers]=0,[Branch engineersloss]=0.00,[Odin Team],[Odin Teamloss],[Network Team],[Network Teamloss],[System Team],[System Teamloss],Infra,      
Infraloss,RM,RMloss,Exchange,Exchangeloss,[Help Desk],[Help Deskloss],EBroking,EBrokingloss      
 into #final from #result where Fld_server is not null        
union all                   
select Fld_server,team,issues,[Branch engineers],[Branch engineersloss],[Odin Team],[Odin Teamloss],[Network Team],      
[Network Teamloss],[System Team],[System Teamloss],Infra,Infraloss,RM,RMloss,Exchange,Exchangeloss,[Help Desk],[Help Deskloss],EBroking=0 ,EBrokingloss=0.00      
 from #result_Branch where Fld_server is not null       
        
select Fld_server,team,issues as issue,[Branch engineers],[Branch engineersloss],[Odin Team],[Odin Teamloss],[Network Team],    
[Network Teamloss],[System Team],[System Teamloss],Infra,Infraloss,RM,RMloss,Exchange,Exchangeloss,[Help Desk] as HelpDesk,    
[Help Deskloss] as HelpDeskloss,EBroking,EBrokingloss    
 from  #final               
select Fld_server,convert(int,count(Fld_server))CFld_server from #final where Fld_server is not null                   
 group by Fld_server       
------------------------------------------------------------------------------------------------------------      
------------------------------combind-----------------------------------------------------------------------      
 --USP_ThresHoldCSO_Report1 '01/10/2009','27/11/2009','%%','%%'     
-------------------------------------------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldCSO_View
-- --------------------------------------------------
CREATE proc USP_ThresHoldCSO_View  
as  
select * from Tbl_ThresHoldCSO_Master(nolock) where Status='A'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ThresHoldTeamToIssueMapping
-- --------------------------------------------------
CREATE proc Usp_ThresHoldTeamToIssueMapping                  
(          
@Issue varchar(50),                      
@BranchEng char(1),  
@Odin char(1),  
@Network char(1),  
@System char(1),  
@Infra char(1),  
@RM char(1),  
@Exchange char(1),  
@Helpdesk char(1),  
@EBroking char(1)           
)                  
as       
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping where Issue=@Issue) =0
Begin     
insert into Tbl_ThresHoldTeamToIssueMapping values  
(@Issue,  @BranchEng,  @Odin,  @Network,  @System,  @Infra,  @RM,  @Exchange,  @Helpdesk,  @EBroking )
End
else
Begin
update Tbl_ThresHoldTeamToIssueMapping set
BranchEng=@BranchEng,
Odin=@Odin,
Network=@Network,
System=@System,
Infra=@Infra,
RM=@RM,
Exchange=@Exchange,
Helpdesk=@Helpdesk,
EBroking=@EBroking where Issue=@Issue
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ThresHoldTeamToIssueMapping_view
-- --------------------------------------------------
CREATE proc USP_ThresHoldTeamToIssueMapping_view  
as  
select * from Tbl_ThresHoldTeamToIssueMapping (nolock) where Status='A' order by Team

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ThresHoldTeamToIssueMapping1_View
-- --------------------------------------------------
create proc Usp_ThresHoldTeamToIssueMapping1_View      
as      
    
select row_number() over (ORDER BY ID )AS RowId,Team,Issues into #t from Tbl_ThresHoldTeamToIssueMapping1(nolock)where status='A' order by Issues    
DECLARE @Issues varchar(50),@Team varchar(50)    
  
update Tbl_ThresHoldTeamToIssueMapping set BranchEng='N',Odin='N',Network='N',System='N',Infra='N',RM='N',Exchange='N',    
Helpdesk='N',EBroking='N'     
  
Declare @MinRowId int,@MaxRowId int,@CurrRowId int        
select @MinRowId=min(RowId),@MaxRowId=max(RowId) from #t        
set @CurrRowId=@MinRowId        
while(@CurrRowId <=@MaxRowId)        
Begin        
select @Team=Team,@Issues=Issues from #t(nolock) where RowId=@CurrRowId     
    
if @Team='Branch engineers'    
update Tbl_ThresHoldTeamToIssueMapping set BranchEng='Y' where Issue=@Issues    
    
if @Team='Odin Team'    
update Tbl_ThresHoldTeamToIssueMapping set Odin='Y' where Issue=@Issues    
    
if @Team='Network Team'    
update Tbl_ThresHoldTeamToIssueMapping set Network='Y' where Issue=@Issues    
    
if @Team='System Team'    
update Tbl_ThresHoldTeamToIssueMapping set System='Y' where Issue=@Issues    
    
if @Team='Infra'    
update Tbl_ThresHoldTeamToIssueMapping set Infra='Y' where Issue=@Issues    
    
if @Team='RM'    
update Tbl_ThresHoldTeamToIssueMapping set RM='Y' where Issue=@Issues    
    
if @Team='Exchange'    
update Tbl_ThresHoldTeamToIssueMapping set Exchange='Y' where Issue=@Issues    
    
if @Team='HelpDesk'    
update Tbl_ThresHoldTeamToIssueMapping set Helpdesk='Y' where Issue=@Issues    
    
if @Team='E-Broking'    
update Tbl_ThresHoldTeamToIssueMapping set EBroking='Y' where Issue=@Issues    
        
set @CurrRowId=@CurrRowId+1         
end      
    
select * from Tbl_ThresHoldTeamToIssueMapping(nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_ThresHoldTeamToIssueMapping2
-- --------------------------------------------------
CREATE proc Usp_ThresHoldTeamToIssueMapping2                        
(                
@Issue varchar(50),        
@BranchEng char(1),        
@Odin char(1),        
@Network char(1),        
@System char(1),        
@Infra char(1),        
@RM char(1),        
@Exchange char(1),        
@Helpdesk char(1),        
@EBroking char(1)                 
)                        
as         
if @BranchEng='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='Branch engineers')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('Branch engineers',@Issue,'A')  
end   
  
if @Odin='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='Odin Team')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('Odin Team',@Issue,'A')  
end   
  
if @Network='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='Network Team')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('Network Team',@Issue,'A')  
end   
  
if @System='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='System Team')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('System Team',@Issue,'A')  
end   
  
if @Infra='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='Infra')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('Infra',@Issue,'A')  
end   
  
if @RM='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='RM')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('RM',@Issue,'A')  
end   
  
if @Exchange='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='Exchange')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('Exchange',@Issue,'A')  
end   
  
if @Helpdesk='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='Helpdesk')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('Helpdesk',@Issue,'A')  
end   
  
if @EBroking='Y'     
begin   
if(select count(*) from Tbl_ThresHoldTeamToIssueMapping1 where Issues=@Issue and Team='E-Broking')=0  
insert into Tbl_ThresHoldTeamToIssueMapping1 values('E-Broking',@Issue,'A')  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Travel_Admin_Inbox_Details
-- --------------------------------------------------
CREATE proc usp_Travel_Admin_Inbox_Details          
(          
@complaintid as varchar(15),          
@flag as varchar(10)          
)          
as          
SET NOCOUNT ON        
select y.emp_name,no_of_guests,fldfrom,fldto,travel_details,convert(varchar(11),departon,103)as departon,DepartureTiming,          
convert(varchar(11),Returnon,103)as Returnon,returntime,modeoftravel,Acdtion_Requ,purpose,PickupnDrop,Othdetail,UserAttach          
from travelbooking x left outer join intranet.risk.dbo.emp_info y           
on x.entryby=y.emp_no where complaint_id=@complaintid and flag=@flag group by complaint_id,emp_name,no_of_guests,    
fldfrom,fldto,travel_details,departon,DepartureTiming,Returnon,    
returntime,modeoftravel,Acdtion_Requ,purpose,PickupnDrop,Othdetail,UserAttach

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Travel_CsoRequest_Inbox
-- --------------------------------------------------
CREATE proc usp_Travel_CsoRequest_Inbox            
(            
@flag as varchar(15),  
@fromdate as varchar(11),  
@todate as varchar(11)          
)        
as      
SET NOCOUNT ON           
select complaint_id,y.emp_name,convert(varchar(11),departon,113)as departon,fldfrom,fldto,purpose,modeoftravel,flag,  
status=case when flag='HA' then 'Pending'  
when flag='CA' then 'TravelDesk Aproved'  
when flag='CH' then 'TravelDesk Hold'  
when flag='CR' then 'TravelDesk Reject' end into #tta
from travelbooking x left outer join intranet.risk.dbo.emp_info y             
on x.entryby=y.emp_no where  flag=@flag and   
entrydate >= convert(datetime,@fromdate,103) AND   
entrydate <=convert(datetime,@todate,103)+' 23:59:59.989' group by 
complaint_id,emp_name,departon,fldto,purpose,modeoftravel,flag,status,fldfrom  

select * from #tta

select Total=count(*) from #tta where flag in('HA','CH','CA','CR')  
select Hold=count(*) from #tta where flag = 'CH'  
select Accept=count(*) from #tta where flag = 'CA'  
select Reject=count(*) from #tta where flag = 'CR'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Travel_HodRequest_Inbox
-- --------------------------------------------------
CREATE proc usp_Travel_HodRequest_Inbox          
(          
@hod as varchar(15),    
@fromdate as varchar(11),    
@todate as varchar(11),    
@flag as varchar(10)          
)          
as       
SET NOCOUNT ON  
  
select complaint_id,y.emp_name,convert(varchar(11),departon,103)as departon,fldto,purpose,modeoftravel,flag,    
status=case when flag='P' then 'Pending'    
when flag='HA' then 'Hod Aproved'    
when flag='HR' then 'Hod Reject'    
when flag='HH' then 'Hod Hold'    
when flag='CA' then 'TravelDesk Aproved'    
when flag='CH' then 'TravelDesk Hold'    
when flag='CR' then 'TravelDesk Reject' end    
from travelbooking x left outer join intranet.risk.dbo.emp_info y           
on x.entryby=y.emp_no where hod=@hod and flag like @flag and     
entrydate >= convert(datetime,@fromdate,103) AND     
entrydate <=convert(datetime,@todate,103)+' 23:59:59.989'  group by   
complaint_id,emp_name,departon,fldto,purpose,modeoftravel,flag,status  
  
select flag into #tat from travelbooking  where hod=@hod  and     
entrydate >= convert(datetime,@fromdate,103) AND     
entrydate <=convert(datetime,@todate,103)+' 23:59:59.989' group by complaint_id,flag
   
select Total=count(*) from #tat where flag like '%%'    
select Hold=count(*) from #tat where flag in ('HH','CH')    
select Accept=count(*) from #tat where flag in ('HA','CA')    
select Reject=count(*) from #tat where flag in ('HR','CR')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Travel_HodRequest_Inbox_Details
-- --------------------------------------------------
CREATE proc usp_Travel_HodRequest_Inbox_Details        
(        
@complaintid as varchar(15),        
@flag as varchar(10)        
)        
as        
SET NOCOUNT ON      
select y.emp_name,no_of_guests,fldfrom,fldto,travel_details,convert(varchar(11),departon,113)as departon,DepartureTiming,        
convert(varchar(11),Returnon,113)as Returnon,returntime,modeoftravel,Acdtion_Requ,purpose,PickupnDrop,Othdetail,Userattach,csoattach,Reason        
from travelbooking x left outer join intranet.risk.dbo.emp_info y         
on x.entryby=y.emp_no where complaint_id=@complaintid and flag=@flag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Travel_Inbox_Details
-- --------------------------------------------------
CREATE proc usp_Travel_Inbox_Details            
(            
@complaintid as varchar(15),            
@flag as varchar(10)            
)            
as            
SET NOCOUNT ON          
select y.emp_name,no_of_guests,fldfrom,fldto,travel_details,convert(varchar(11),departon,103)as departon,DepartureTiming,            
convert(varchar(11),Returnon,103)as Returnon,returntime,modeoftravel,Acdtion_Requ,purpose,      
PickupnDrop,Othdetail,modeoftraveldetails,acdtion_requdetails,pickupndropdetails,csoattach,Reason            
from travelbooking x left outer join intranet.risk.dbo.emp_info y             
on x.entryby=y.emp_no where complaint_id=@complaintid and flag=@flag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Travel_UserRequest_Inbox
-- --------------------------------------------------
CREATE proc usp_Travel_UserRequest_Inbox              
(              
@entryby as varchar(15),        
@fromdate as varchar(11),        
@todate as varchar(11),        
@flag as varchar(10)              
)              
as           
SET NOCOUNT ON             
select complaint_id,y.emp_name,convert(varchar(11),departon,103)as departon,fldto,purpose,modeoftravel,flag,        
status=case when flag='P' then 'Pending'        
when flag='HA' then 'Hod Aproved'        
when flag='HR' then 'Hod Reject'        
when flag='HH' then 'Hod Hold'        
when flag='CA' then 'TravelDesk Aproved'        
when flag='CH' then 'TravelDesk Hold'        
when flag='CR' then 'TravelDesk Reject' end      
from travelbooking x left outer join intranet.risk.dbo.emp_info y               
on x.entryby=y.emp_no where entryby=@entryby and flag like @flag and         
entrydate >= convert(datetime,@fromdate,103) AND         
entrydate <=convert(datetime,@todate,103)+' 23:59:59.989' group by     
complaint_id,emp_name,departon,fldto,purpose,modeoftravel,flag,status,fldfrom     
    
select flag into #ta from travelbooking where entryby=@entryby and          
entrydate >= convert(datetime,@fromdate,103) AND         
entrydate <=convert(datetime,@todate,103)+' 23:59:59.989' group by flag,complaint_id
--complaint_id,departon,fldto,purpose,modeoftravel,flag,fldfrom,srno,no_of_guess,emp_code,travel_details     
    
  
select Total=count(*) from #ta where flag like '%%'        
select Hold=count(*) from #ta where flag in ('HH','CH')        
select Accept=count(*) from #ta where flag in ('HA','CA')        
select Reject=count(*) from #ta where flag in ('HR','CR')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_travelbooking_complaint
-- --------------------------------------------------
CREATE proc Usp_travelbooking_complaint                        
(                        
@no_of_gustes AS int,                        
@emp_code AS varchar(15),                        
@travel_details AS varchar(15),                        
@DepartOn AS varchar(12),                        
@ReturnOn AS varchar(12),                        
@DepartureTiming AS varchar(50),                        
@ReturnTime AS varchar(50),                        
@fldfrom AS varchar(25),                        
@fldto AS varchar(25),                        
@ModeOfTravel AS varchar(10),                        
@Acdtion_Requ AS varchar(5),                        
@PickupnDrop AS varchar(5),                        
@Purpose AS varchar(100),                        
@Othdetail AS varchar(250),                        
@entryby AS varchar(15),                          
@complaintNo as varchar(25),                
@hod as varchar(12),    
@UserAttach as varchar(30),  
@costcode as varchar(20)                       
)                        
as           
SET NOCOUNT ON                   
                                                                                           
set @hod=(Select senior from intranet.risk.dbo.emp_info where emp_no=@emp_code)                
                    
                     
declare @time as varchar(11)                      
 set @time=(select substring(@DepartureTiming,10,23))                       
declare @time1 as varchar(11)                      
 set @time1=(select substring(@ReturnTime,10,23))                      
                      
Insert into  travelbooking          
                   
(  
                    
complaint_id,  
no_of_guests,  
emp_code,  
travel_details,  
DepartOn,  
ReturnOn,  
DepartureTiming,  
ReturnTime,  
fldfrom,                        
fldto,  
ModeOfTravel,  
Acdtion_Requ,  
PickupnDrop,  
Purpose,  
Othdetail,  
Entryby,  
Costcode,  
Entrydate,  
hod,  
flag,  
Reason,  
modeoftraveldetails,  
acdtion_requdetails,  
pickupndropdetails,  
UserAttach,  
CsoAttach,  
Solutionby,  
costfortravel,  
costforacc,  
costforpnd                      
)                        
VALUES                         
(                        
@complaintNo,                        
@no_of_gustes,                        
@emp_code,                        
@travel_details,                        
convert(datetime,@DepartOn,103),                        
convert(datetime,@ReturnOn,103),                       
@time,                        
@time1,                        
@fldfrom,                        
@fldto,                      
@ModeOfTravel,                        
@Acdtion_Requ,                        
@PickupnDrop,                        
@Purpose,                        
@Othdetail,                        
@entryby,   
@costcode,                      
getdate(),                        
@hod,                        
'p',                        
'',          
'',          
'',          
'',@UserAttach,'','','','',''          
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_TravelHelpDesk_EmpName
-- --------------------------------------------------
Create proc Usp_TravelHelpDesk_EmpName
(
@complaint_id varchar(20),
@flag varchar(5)
)
as
SET NOCOUNT ON

select b.emp_name from travelbooking a
left outer join intranet.risk.dbo.emp_info b
on a.emp_code=b.emp_no where complaint_id=@complaint_id and flag=@flag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_travelID
-- --------------------------------------------------
create proc usp_travelID
(
@entryby as varchar(15),
@Complaintno as varchar(20)
)
as
SET NOCOUNT ON 

set @Complaintno = (select count(*) from travelbooking (nolock) where EntryBy =@entryby)                     
         
if @Complaintno = 0                                                                                        
  begin                                                                                         
   set @Complaintno = @EntryBy+'0'                                                                                              
  end                                                                                        
 else                                                                                        
  begin                                                                                         
  /* set @Complaintno = (select top 1 @Fld_EntryBy+convert(varchar,substring(Complaint_ID,7,100)+1)                             
   from tbl_complaint where  Fld_EntryBy =@Fld_EntryBy order by Complaint_Date desc)   */                
   set @Complaintno = (select  @entryby+convert(varchar,max(convert(int,substring(complaint_id,len(@entryby)+1,3)))+1)                             
   from travelbooking where  Entryby =@entryby)                                                                             
  end      
select TravelID=@Complaintno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPD_First_Apr_Wanlink
-- --------------------------------------------------
CREATE Proc USP_UPD_First_Apr_Wanlink  
(  
@Fld_SrNo int ,  
@Fld_Status char(10),  
--@Fld_DOFT datetime,  
--@Fld_First_TestBy varchar(50),  
@Fld_First_Remark varchar(150),  
@Fld_FEmpCode varchar(15)  
)  
as  
  
update Tbl_IT_Wanlink_Update_Data set   
Fld_Flag = 'P',  
Fld_Status = @Fld_Status,  
Fld_DOFT = getdate(),  
Fld_First_TestBy = @Fld_FEmpCode,  
Fld_First_Remark = @Fld_First_Remark,  
Fld_FEmpCode = @Fld_FEmpCode  
where Fld_SrNo = @Fld_SrNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPD_First_Apr_Wanlink_admin
-- --------------------------------------------------
CREATE Proc USP_UPD_First_Apr_Wanlink_admin    
(    
@Fld_SrNo int ,    
@Fld_Second_TestBy varchar(50),    
@Fld_Second_Remark varchar(150)  
)    
as    
    
update Tbl_IT_Wanlink_Update_Data set     
Fld_Second_TestBy = @Fld_Second_TestBy,    
Fld_Second_Remark = @Fld_Second_Remark
where Fld_SrNo = @Fld_SrNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPD_Forward
-- --------------------------------------------------
CREATE Proc USP_UPD_Forward(@Fld_Complaint_No as varchar(15),@Fld_Forward_To as varchar(15),@Flag as varchar(2))    
as    
    
if @Flag = 'C'   
Begin  
 update tbl_Query_entry set Fld_Completed_Date = getdate(),Fld_Status = 'C' where Fld_Complaint_No = @Fld_Complaint_No      
end   
else  
Begin  
 update tbl_Query_entry set Fld_Forward_To = @Fld_Forward_To,Fld_Status = 'F' where Fld_Complaint_No = @Fld_Complaint_No     

	declare @email as varchar(50)      	
	declare @userid as varchar(50)      	
	declare @sub as varchar(50)      
	declare @msg as varchar(500)      

	set @email = (select replace(email,'','Rohit@angeltrade.com') as Email from intranet.risk.dbo.emp_info where emp_no = @Fld_Forward_To)
	set @email = (select emp_name from intranet.risk.dbo.emp_info where emp_no = @Fld_Forward_To)

	set @sub = 'Helpdesk Queries'      
	set @msg = '<font face=verdana size=2>Dear <b>'+ upper(@userid) +'</b>,<br><br>Please Login in RM to solve forwared Query</b>      
	<br><br><font face=verdana size=2>Thanks & Regards,<br><BR><b>Banking Helpdesk<Br></font>'                  

	exec mis.master.dbo.usp_Banking_mail @email,'BankingHelpdesk@angeltrade.com',@sub,@msg    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_upd_request
-- --------------------------------------------------
create proc usp_upd_request(@request as varchar(200),@srno as int,@subject as varchar(200),@solution as varchar(1000),@ssubject as varchar(200),@ssolution as varchar(1000))
as

update tbl_request_master set fld_request = @request where fld_srno = @srno

update tbl_hr_solutions set fld_subject = @subject,fld_solution = @solution where fld_sr_no = @srno and fld_subject = @ssubject and fld_solution = @ssolution

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPD_Second_Apr_Wanlink
-- --------------------------------------------------




  
CREATE Proc USP_UPD_Second_Apr_Wanlink                
(                
@Fld_SrNo int ,                
@Fld_Status char(10),                   
@Fld_DOST varchar(15),                
@Fld_Second_Remark varchar(150),                
@Fld_SEmpCode varchar(15)     
--@Active_Status char(10)            
--@Fld_Second_TestBy varchar(50),                 
)                
as                
DECLARE @Fdate varchar(12)            
DECLARE @Count as int            
SET  @Fdate = Convert(varchar(11),Convert(datetime,@Fld_DOST,103),121)            
Select @Count =COUNT(*) From Tbl_IT_Wanlink_Update_Data Where Fld_DOST = @Fdate and Fld_Id = @Fld_SrNo              
            
IF @Count > 0            
 BEGIN            
  update Tbl_IT_Wanlink_Update_Data     
  set Fld_Flag = 'A',                
  Fld_Status = @Fld_Status,               
  Fld_DOST = @Fdate,                
  Fld_Second_TestBy = @Fld_SEmpCode,                
  Fld_Second_Remark = @Fld_Second_Remark,                
  Fld_SEmpCode = @Fld_SEmpCode      
  where Fld_Id = @Fld_SrNo and Fld_DOST = @Fdate      
        
 -- IF @Active_Status ='InActive'      
 --BEGIN      
 -- Update Tbl_IT_Wanlink_Data SET      
 -- ActiveStatus = @Active_Status,      
 -- InactiveDate= @Fld_DOST        
 -- WHERE Fld_Id = @Fld_SrNo        
 --END        
 END      
ELSE            
BEGIN    
insert into Tbl_IT_Wanlink_Update_Data (Fld_Id,Fld_Fetch_Date,Fld_Flag,Fld_Status,Fld_DOST,Fld_Second_TestBy,Fld_Second_Remark,Fld_SEmpCode)            
Values(@Fld_SrNo,GETDATE(),'A',@Fld_Status,@Fdate,@Fld_SEmpCode,@Fld_Second_Remark,@Fld_SEmpCode)            
  --IF @Active_Status ='InActive'      
  --BEGIN      
  --Update Tbl_IT_Wanlink_Data SET      
  --ActiveStatus = @Active_Status,      
  --InactiveDate= @Fld_DOST        
  --WHERE Fld_Id = @Fld_SrNo        
  --END            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPD_UPS_Count
-- --------------------------------------------------
CREATE proc USP_UPD_UPS_Count              
(              
@Fld_SrNo int,              
@Fld_Branch_Code int,              
@Fld_Upsid int,              
@Fld_945 varchar(50),              
@Fld_2 varchar(50),              
@Fld_530 varchar(50),              
@Fld_10 varchar(50),              
@Fld_Upd_By varchar(50),              
@fld_remark varchar(1000),            
@Fld_Date as varchar(11)              
)              
as              
            
set @Fld_Date = convert(varchar(11),convert(datetime,@Fld_Date,103))                
            
if (select count(*) from tbl_ups_count_details where Fld_SrNo = @Fld_SrNo) = 0              
              
begin              
 insert into tbl_ups_count_details values              
 (              
 @Fld_Branch_Code,              
 @Fld_Upsid,              
 @Fld_945,              
 @Fld_2,              
 @Fld_530,              
 @Fld_10,              
 @Fld_Date,              
 @Fld_Upd_By,              
 @fld_remark              
 )              
end              
else              
begin    
if (select usertype from intranet.risk.dbo.user_login with(nolock)where username=@Fld_Upd_By) = 'ADMIN'        
Begin             
 update tbl_ups_count_details set              
 Fld_945 = @Fld_945,              
 Fld_2 = @Fld_2,              
 Fld_530 = @Fld_530,              
 Fld_10 = @Fld_10,              
 Fld_Date = @Fld_Date,              
-- Fld_Upd_By = @Fld_Upd_By,              
 fld_remark = @fld_remark where Fld_SrNo = @Fld_SrNo              
End       
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_Complaint
-- --------------------------------------------------
Create proc Usp_Update_Complaint(@val as int,@complaint as varchar(5000),@complaintno as varchar(15))
as

set nocount on

if @val = 1
begin
	UPDATE complaint_table SET Problem=@complaint WHERE COMPLAINTNO=@complaintno
end
else
begin
UPDATE complaint_table SET suggestion=@complaint WHERE COMPLAINTNO=@complaintno
end

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_IP
-- --------------------------------------------------
CREATE proc USP_UPDATE_IP(@FLD_IPFrom as varchar(15),@FLD_IPTo as varchar(15),@FLD_SB_Mask as varchar(15),@FLD_Def_GT as varchar(15),@Fld_Remark as varchar(500),@FLD_SRNO as int,@Flag as char(1))  
as  
  
if @Flag = 'Y'
 
Begin
	UPDATE tbl_IT_IPaddress SET FLD_IPFrom = @FLD_IPFrom,FLD_IPTo = @FLD_IPTo,FLD_SB_Mask = @FLD_SB_Mask,FLD_Def_GT =@FLD_Def_GT,Fld_Remark =@Fld_Remark   
	where FLD_SRNO = @FLD_SRNO   
end
else
Begin
	Begin

	delete 	tbl_ip_details where Fld_IP_id = @FLD_SRNO
	UPDATE tbl_IT_IPaddress SET FLD_IPFrom = @FLD_IPFrom,FLD_IPTo = @FLD_IPTo,FLD_SB_Mask = @FLD_SB_Mask,FLD_Def_GT =@FLD_Def_GT,Fld_Remark =@Fld_Remark   
	where FLD_SRNO = @FLD_SRNO   
	
	end
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_IP_Details
-- --------------------------------------------------
create proc USP_UPDATE_IP_Details(@Fld_Remark as varchar(500),@FLD_SRNO as int)
as
Begin Tran
	UPDATE tbl_ip_details SET Fld_Remark =@Fld_Remark where FLD_SRNO = @FLD_SRNO 
Commit

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_tbl_IT_UserMaster
-- --------------------------------------------------
  
CREATE proc [dbo].[Usp_Update_tbl_IT_UserMaster]          
   
-----------------------------------------------------------------------  
--Created By :  
--Created On : 24 DEC 2010  
--Description : Update Information into emp_info From [MIDDLEWARE].[Harmony].dbo.VLMSInhouse   
--     Of Only Active Employee   
--Execution Time : Daily 11:00 PM   
-----------------------------------------------------------------------  
  
As  
  
Begin  
 Truncate table tbl_IT_UserMaster  
  
 Insert into dbo.tbl_IT_UserMaster (Emp_ID,EMP_NAME,HOD,HOD_Name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,  
          Department,Sub_Department,Designation,Location_Address,[LEVEL],categorydesc,  
          Costcode,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,  
          [STATUS],[Address],City,[State],Account_No,pincode,Functional_Head,flgCSOBranch,  
          tpdlgcode,LOBDESC  
          )  
 select [Emp No],EMP_NAME,[HOD No],[HOD Name],[Company Name],SBU,Lob,Zone,Region,Location,AttendanceLoc,  
          Department,[Sub Department],Designation,[Location Address],[LEVEL],categorydesc,  
          Costcode,[Join Date],[Separation Date],emailadd,sex,BirthDate,PHONE,JOINDATE,  
          [STATUS],[Address],City,[State],[Account No],pincode,[Functional Head],  
          flgCSOBranch,tpdlgcode,LOBDESC  
  
 from [MIDDLEWARE].[Harmony].dbo.VLMSInhouse  
-- WHERE [STATUS] = 'A'  
  
  
  
 Drop Table VLMSInhouse  
 Select * into VLMSInhouse from [MIDDLEWARE].[Harmony].dbo.VLMSInhouse  
  
  
   
 Insert Into tbl_ITStaffMaster  
 Select *,CostCode,'','','' From VLMSInhouse  
 Where [Emp No] not in (Select [Emp No] From tbl_ITStaffMaster)  
 And Department='IT'  
  
 Update tbl_ITStaffMaster  
 Set Status = VLMSInhouse.Status  , emailadd=VLMSInhouse.emailadd ,   
 [Separation Date]= VLMSInhouse.[Separation Date] , Designation = VLMSInhouse.Designation  
 From tbl_ITStaffMaster,VLMSInhouse  
 Where tbl_ITStaffMaster.[Emp No] = VLMSInhouse.[Emp No]  
  
   
  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_UPS_Data
-- --------------------------------------------------
CREATE Proc Usp_Update_UPS_Data  
(  
@Fld_Upd_Date Varchar(15)=null,
@Fld_Ups_Id int=null,
@Fld_BranchID int=null,
@Fld_Avg_Load Varchar(15)=null,        
@Fld_Bat_Over Varchar(15)=null,
@Fld_Critical_Check Varchar(15)=null,
@Fld_Fob Varchar(15)=null,  
@Fld_Fremark Varchar(50)=null,
@Fld_Type Char(1)=null,        
@Fld_Sob Varchar(15)=null,  
@Fld_Sremark Varchar(15)=null,
@Agv_Daily_Load Varchar(50)=null,
@Total_TestingTime int=null,
@Total_Load_InPer Varchar(50)=null
)              
as              
              
Set @Fld_Upd_Date = Convert(varchar(11),Convert(datetime,@Fld_Upd_Date,103),121)              
        
If(@Fld_Type = 'U')        
	Begin             
		 Update tbl_weekly_UPs_Details        
		 set Fld_Avg_Load = @Fld_Avg_Load,Fld_Bat_Over = @Fld_Bat_Over, 
		 Fld_Critical_Check = @Fld_Critical_Check,        
		 Fld_Fob = @Fld_Fob,Fld_Fremark = @Fld_Fremark,Fld_Fcd = getdate(),
		 @Agv_Daily_Load = Agv_Daily_Load,
		 @Total_TestingTime = Total_TestingTime,
		 @Total_Load_InPer = Total_Load_InPer 
		 WHERE Fld_Ups_Id = @Fld_Ups_Id and Fld_BranchID = @Fld_BranchID and Fld_Upd_Date = @Fld_Upd_Date         
	End        
Else        
	Begin        
		 Update tbl_weekly_UPs_Details        
		 set Fld_Avg_Load = @Fld_Avg_Load,Fld_Bat_Over = @Fld_Bat_Over, 
		 Fld_Critical_Check = @Fld_Critical_Check,        
		 Fld_Sob = @Fld_Sob,Fld_Sremark = @Fld_Sremark,Fld_Scd = getdate(),
		 @Agv_Daily_Load = Agv_Daily_Load,
		 @Total_TestingTime = Total_TestingTime,
		 @Total_Load_InPer = Total_Load_InPer 
		 WHERE Fld_Ups_Id = @Fld_Ups_Id and Fld_BranchID = @Fld_BranchID and Fld_Upd_Date = @Fld_Upd_Date
	End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_VLMSInhouse_Users
-- --------------------------------------------------
  
CREATE proc [dbo].[Usp_Update_VLMSInhouse_Users]          
   
-----------------------------------------------------------------------  
--Created By : Rupali Mayekar  
--Created On : 23 August 2011  
--Description : Update Information into emp_info From [MIDDLEWARE].[Harmony].dbo.VLMSInhouse   
--     Of Only Active Employee   
--Execution Time : Daily 11:00 PM   
-----------------------------------------------------------------------  
  
As  
  
Begin  
     Drop Table VLMSInhouse_Users  
  Select * into VLMSInhouse_Users from [MIDDLEWARE].[Harmony].dbo.VLMSInhouse  
  
  
 Insert Into tbl_IT_Staff_New  
 Select   [Emp no] , Emp_Name , Phone , [Join Date] , emailadd,'',  
 CostCode,[Status],[Status],getdate()  
 From VLMSInhouse_Users  
 Where [Emp No] not in (Select Fld_Emp_No From tbl_IT_Staff_New)  
 And Department='IT'  
   
 Update tbl_IT_Staff_New  
 set  FLd_branch_Id = A.Sr_No   
 from Tbl_IT_Br_Master  A , tbl_IT_Staff_New  
 where  tbl_IT_Staff_New.Fld_Branch_Id = LTRIM(RTRIM(A.Br_Tag))  
  
 Update tbl_IT_Staff_New  
 Set Fld_Status = VLMSInhouse_Users.[Status]  
 From tbl_IT_Staff_New,VLMSInhouse_Users  
 Where tbl_IT_Staff_New.Fld_Emp_No = VLMSInhouse_Users.[Emp No]  
   
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Update_Vsat
-- --------------------------------------------------
CREATE Proc Usp_Update_Vsat(@srno as varchar(5),@catid as varchar(15),@IP as varchar(15),@city as varchar(15),@contperson as varchar(50))
as

set nocount on

update v_sat_mast1 set cat_item_id = @catid,cat_pcip = @Ip,cat_city = @city,cat_contPerson = @Contperson
where Sr_no = @srno

set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Updates_Printer_Data
-- --------------------------------------------------
CREATE Proc USP_Updates_Printer_Data(@fdate as varchar(11),@tdate as varchar(11),@Fld_CSO varchar(11),@fld_branch varchar(11),@rpt as varchar(5))     
as      
  
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))  
set @tdate = convert(varchar(11),convert(datetime,@tdate,103))  
  
create table #t        
(        
Sr_No int,        
Br_tag varchar(150),        
Br_Name varchar(500)        
)                     
        
if @fld_branch = 'All'        
        
begin        
 insert into #t        
 exec USP_WAN_Search_Branch @Fld_CSO        
end        
else        
begin        
 insert into #t        
 select @fld_branch,'',''        
end   
  
if @rpt = 'A'       
  
begin  
  
  
select * from        
(select * from V_Printer_Master where Fld_Branch_id in (select Sr_No from #t))x        
inner join        
(select *,Fld_Serial_No as New_Sr_NO,Fld_SrNo as Upd_SrNo,convert(varchar(11),Fld_dt_date,103) as dt       
from tbl_Printer_Updates where Fld_Upd_Date >= @fdate and Fld_Upd_Date <= @tdate+' 23:59:59')y        
on x.Fld_SrNo = y.Fld_Printer_Id        
  
return  
      
end  
else  
begin  
  
select * from        
(select * from V_Printer_Master where Fld_Branch_id in (select Sr_No from #t))x        
left outer join        
(select *,Fld_Serial_No as New_Sr_NO,Fld_SrNo as Upd_SrNo   
from tbl_Printer_Updates where Fld_Upd_Date >= @fdate and Fld_Upd_Date <= @tdate+' 23:59:59')y        
on x.Fld_SrNo = y.Fld_Printer_Id        
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPLOAD_IT_Connectivity_DATA
-- --------------------------------------------------
CREATE proc USP_UPLOAD_IT_Connectivity_DATA
(                      
@filename as varchar(100)                      
)                       
as                          
set transaction  isolation  level read uncommitted                          
              
declare @path as varchar(100)                      
declare @sql as varchar(2000)                   
            
set @path='d:\upload1\' + @filename                                     
    
SET @SQL = 'insert into Tbl_IT_Connectivity select [Branch Type],[Branch Code],[Type of Link],[Lease Line / Vsat],
[CKT ID (Lease Line)  / Vsat ID],[BANDWIDTH],[PURPOSE],[Activation Date],[Expiring Date],[Service Provider Name],[Contact No],[Contact Person],  
[Remarks],getdate()FROM OPENROWSET(''Microsoft.Jet.OLEDB.4.0'',''Excel 8.0;DATABASE='+@path+''',''Select * from [sheet1$]'')'        
Exec (@SQL) 

select @@rowcount as Total

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPLOAD_IT_NETWORK_DATA
-- --------------------------------------------------
CREATE proc USP_UPLOAD_IT_NETWORK_DATA    
(                        
@filename as varchar(100)                        
)                         
as                            
set transaction  isolation  level read uncommitted                            
                
declare @path as varchar(100)                        
declare @sql as varchar(2000)                     
              
set @path='d:\upload1\' + @filename                                       
      
SET @SQL = 'insert into Tbl_IT_Network_Data select Branch_Type,[Branch Code],[Equipment Type],
[Equipment Name],Make,[Series/Model],[Lan Port1],[Lan Port2],[Wan Port1],[Wan Port2],[Wan Port3],        
[IP Addresss],[Installation Date],[Warrenty From],[Warrenty To],[Supplier Name],    
[Supplier Contact No],[AMC From],[AMC To],[AMC Provider],[AMC Provider Contact],Managed,Purpose,getdate()    
FROM OPENROWSET(''Microsoft.Jet.OLEDB.4.0'',''Excel 8.0;DATABASE='+@path+''',''Select * from [sheet1$]'')'          
--print @SQL

Exec (@SQL)        
select @@rowcount as Total

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Upload_ITServer_Uptime_27Feb2013
-- --------------------------------------------------




CREATE PROCEDURE USP_Upload_ITServer_Uptime_27Feb2013(@filename as varchar(25))    
AS    
 BEGIN       
  --INSERT INTO helpdesk.dbo.temptable(tdate,Bse,Cm,Fo,Mcx,Ncdex,ACDLNSX,ACPLMCD)  SELECT tdate ,  
  INSERT INTO helpdesk.dbo.sett_mst(tdate,Bse,Cm,Fo,Mcx,Ncdex,ACDLNSX,ACPLMCD)  SELECT tdate ,  
  CASE WHEN Bse='Holiday' THEN 0 ELSE Bse END,  
  CASE WHEN Cm='Holiday' THEN 0 ELSE Cm END,  
  CASE WHEN Fo = 'Holiday' THEN 0 ELSE Fo END,  
  CASE WHEN Mcx='Holiday' THEN 0 ELSE Mcx END,  
  CASE WHEN Ncdex='Holiday' THEN 0 ELSE Ncdex END,  
  CASE WHEN ACDLNSX= 'Holiday' THEN 0 ELSE ACDLNSX END,  
  CASE WHEN ACPLMCD = 'Holiday' THEN 0 ELSE ACPLMCD END   
  FROM tbl_Uptime_report               
  TRUNCATE TABLE tbl_Uptime_report           
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_uploadedfile
-- --------------------------------------------------
CREATE proc usp_uploadedfile(@date as varchar(11),@branch as varchar(11),@serverid as varchar(5))        
as        
      
select * from tbl_uploadedfile_entry(nolock) where fld_server_id=@serverid and      
 entrydate=convert(datetime,@date,103)      
   
select * from tbl_daily_uploaded_file(nolock) where flag='A'  
      
select * from v_tbl_server_master(nolock) where fld_id =@serverid

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UploadedFile_report
-- --------------------------------------------------

CREATE proc usp_UploadedFile_report(@serverid as varchar(5),@date as varchar(11),@branch as varchar(25))                
as                
if @serverid='All'              
begin               
set @serverid='%%'              
end              
          
select * from tbl_uploadedfile_entry(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)              
and fld_branch_id=@branch  and fld_server_id in        
(select fld_id from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd=@branch              
) order by fld_server_id 
              
select * from tbl_daily_uploaded_file(nolock) where flag='A'      
   
select * from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd=@branch              
 and fld_id in            
(select distinct fld_server_id from tbl_uploadedfile_entry(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)              
and fld_branch_id=@branch )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_uploadedFile_report_d1
-- --------------------------------------------------
   
CREATE proc usp_uploadedFile_report_d1(@serverid as varchar(5),@date as varchar(11),@branch as varchar(25))         
as                          
if @serverid='All'                        
begin                         
set @serverid='%%'                        
end                        
                    
select x.*,y.Br_name as Br_Name from      
(                   
select * from tbl_uploadedfile_entry(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)                        
and fld_branch_id  like @branch  and fld_server_id in           
(select fld_id from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd like @branch))x       
left outer join       
(select Br_Tag,Br_name from tbl_it_br_master(nolock))y      
on x.fld_branch_id=y.Br_Tag order by fld_server_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_uploadedFile_report_d2
-- --------------------------------------------------

Create proc usp_uploadedFile_report_d2(@serverid as varchar(5),@date as varchar(11),@branch as varchar(25)) 
as                  
if @serverid='All'                
begin                 
set @serverid='%%'                
end                
            
select * from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd=@branch                
 and fld_id in              
(select distinct fld_server_id from tbl_uploadedfile_entry(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)                
and fld_branch_id=@branch )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UploadedFile_report_dummy
-- --------------------------------------------------
CREATE proc usp_UploadedFile_report_dummy(@serverid as varchar(5),@date as varchar(11),@branch as varchar(25))                  
as                  
if @serverid='All'                
begin                 
set @serverid='%%'                
end                
     if @serverid=''                
begin                 
set @serverid='%%'                
end           
select * from tbl_uploadedfile_entry(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)                
and fld_branch_id like @branch  and fld_server_id in          
(select fld_id from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd like @branch                
) order by fld_server_id   
                
select * from tbl_daily_uploaded_file(nolock) where flag='A'        
     
select * from v_tbl_server_master(nolock) where fld_id like @serverid and status='Active' and fld_branch_cd like @branch                
 and fld_id in              
(select distinct fld_server_id from tbl_uploadedfile_entry(nolock) where fld_server_id like @serverid and entrydate=convert(datetime,@date,103)                
and fld_branch_id like @branch )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Daily_Report
-- --------------------------------------------------
    
CREATE proc [dbo].[USP_UPS_Daily_Report]          
(          
@branchid varchar(11),          
@fdate varchar(11),          
@tdate varchar(11)          
)                                                                    

As
Begin
                                               
                                            
	 set nocount on                                                            
	             
	 DECLARE @FDT AS DATETIME    
	 DECLARE @EDT AS DATETIME       
	 --DECLARE @branchid As varchar(11)            
	                                                                  
	 set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                       
	 set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                                                    
	                                                                  
	 --set @FDT =  Convert(Datetime,convert(varchar(11),convert(datetime,@fdate),113))    
	 --set @EDT =  Convert(Datetime,convert(varchar(11),convert(datetime,@tdate),113))    
	 ----SET @branchid = '198'    
	
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempUPSDailyReport]') AND type in (N'U'))
	DROP TABLE [dbo].[TempUPSDailyReport]
	
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#DailyUPS1]') AND type in (N'U'))
	DROP TABLE [dbo].[#DailyUPS1]
	
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#DailyUPS2]') AND type in (N'U'))
	DROP TABLE [dbo].[#DailyUPS2]	        
	
	CREATE TABLE [dbo].[TempUPSDailyReport](
		[Br_name] [varchar](100) NULL,
		[ups_id] [int] NULL,
		[ups_name] [varchar](167) NULL,
		[Fld_SrNo] [int] NULL,
		[Fld_Branch_Code] [int] NULL,
		[Fld_Upsid] [int] NULL,
		[Fld_945] [varchar](15) NULL,
		[Fld_2] [varchar](15) NULL,
		[Fld_530] [varchar](15) NULL,
		[Fld_10] [varchar](15) NULL,
		[Fld_Date] [datetime] NULL,
		[Fld_Upd_By] [varchar](15) NULL,
		[fld_remark] [varchar](1000) NULL,
		[person_name] [varchar](100) NULL,
		[Branches] [varchar](100) NULL,
		[date] [varchar](11) NULL
	) ON [PRIMARY]
		        

	-- Get Dates List 
	Declare  @TempDateList Table
	(Dates datetime)

	Insert Into @TempDateList
	Exec GetDateList @fdate,@tdate

	--Select * From @TempDateList
	
	Declare @Count AS Int
	Declare @Total AS Int
	Declare @Date As Datetime
	
	Set @Count = 0
	Set @Total = (Select COUNT(Dates) From @TempDateList)
	
	While (@Count < @Total)
	Begin
	    Set @Date = (Select Top 1 Dates From @TempDateList)
        
		Select Br_name, ups_id,    
			Fld_Brand_Name+'-'+Fld_Model_Capacity+'<br>&nbsp;&nbsp;'+Fld_Model_Srno as ups_name,    
			y.*     
		Into #DailyUPS1     
		From                                                                    
			(     
				Select * from V_UPS_Master where Fld_Branch_id like @branchid and Fld_App = 'U'    
			)x                                                                    
			left outer join                                                                    
			(                                              
				select x.*,y.person_name from                                              
			(    
		   --select * from tbl_ups_count_details (nolock)  
				Select    
					Fld_SrNo , Fld_Branch_Code ,Fld_Upsid,  
					(case when (Fld_945  <> '' and Fld_945 IS NOT NULL)  
						Then Fld_945 Else 'NA' End)  as [Fld_945],  
					(case when (Fld_2  <> '' and Fld_2 IS NOT NULL)  
					  Then Fld_2 Else 'NA' End)  as [Fld_2],  
					(case when (Fld_530  <> '' and Fld_530 IS NOT NULL)  
					  Then Fld_530 Else 'NA' End) as [Fld_530],  
					(case when (Fld_10  <> '' and Fld_10 IS NOT NULL)  
						Then Fld_10 Else 'NA' End)as [Fld_10],  
					Fld_Date , Fld_Upd_By , fld_remark     
				from tbl_ups_count_details (nolock)       
				where fld_date >= @Date and fld_date <= @Date+' 23:59:59'  
			 --Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) >= Convert(Datetime,convert(varchar(11),convert(datetime,@FDT),113))     
			 --and Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) <= Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@EDT),113) +' 23:59:59')    
			)x                                              
			left outer join                                              
			(     
				select * from intranet.risk.dbo.user_login     
			) y                                              
			on x.Fld_Upd_by = y.username and x.fld_upd_by <> ''        
		   ----and y.username <> '' and x.fld_upd_by is not null and y.username is not null                                             
			) y                                                                    
			on  x.Fld_SrNo = y.Fld_upsid  order by Ups_Name,Fld_Date                                                  
		                                            
		                                           
		 Select upper(Br_Name) as Branches     
		 Into #DailyUPS2     
		 From tbl_It_Br_Master     
		 where Sr_No in                                                
		  (                                                
		   Select Fld_Branch_Code from tbl_ups_count_details (nolock)     
		   Where (convert(money,Fld_945) > 79 or                                             
			 convert(money,Fld_2) > 79 or                                             
			 convert(money,Fld_530) > 79 or                                             
			 convert(money,Fld_10) > 79 ) --or Fld_Remark <> ''      
			 and Fld_Date >= @Date and fld_date <= @Date +' 23:59:59'       
			 --and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'                                              
			--And Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) >= Convert(Datetime,convert(varchar(11),convert(datetime,@FDT),113))     
			--and Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) <= Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@EDT),113) +' 23:59:59')                                              
		  )             
		                          
		                                          
		/*                                        
		select upper(Br_Name) as Branches into #y from tbl_It_Br_Master where Sr_No in                                                
		(                                                
		select Fld_Branch_Code from tbl_ups_count_details (nolock) where                                             
		Fld_Remark <> '' and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'                                                
		) */                                         
		
		               
		                
		Select *, [date]=convert(varchar(11),x.Fld_Date,103) 
		Into #DailyUPS3    
		From                                            
			(     
				select * from #DailyUPS1 where br_name <> '' and fld_date <> ''     
			)x                                            
			left outer join                                            
			(    
				select * from #DailyUPS2    
			)y                                            
		On x.br_Name = y.branches                                            
		Order by br_name,ups_name,Fld_Date     
			
		Insert Into [TempUPSDailyReport]
		Select Distinct * From #DailyUPS3
		 
		Delete @TempDateList Where Dates = @Date
		 		 
		Set @Count = @Count + 1
		 
		Drop Table #DailyUPS1
		Drop Table #DailyUPS2
		Drop Table #DailyUPS3
	End
	
	Select * From [TempUPSDailyReport]
	    
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempUPSDailyReport]') AND type in (N'U'))
	DROP TABLE [dbo].[TempUPSDailyReport]

	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#DailyUPS1]') AND type in (N'U'))
	DROP TABLE [dbo].[#DailyUPS1]
	
	IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[#DailyUPS2]') AND type in (N'U'))
	DROP TABLE [dbo].[#DailyUPS2]	
	--select * from V_UPS_Master
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ups_details
-- --------------------------------------------------
CREATE proc [dbo].[usp_ups_details](@branchid varchar(12),@fld_date varchar(11))                      
as                      
                    
set @fld_date = convert(varchar(11),convert(datetime,@fld_date,103))  
        
   Declare @str as varchar(4000)      
   Declare @case as varchar(1000)     
   Declare @UPSCase As Varchar(1000)  
   Declare @UPSCase1 As Varchar(500)     
   Declare @case1 as varchar(500)     
   Declare @UPSCase2 As Varchar(500)     
   Declare @case2 as varchar(500)  
     
   Set @UPSCase = ''  
   Set @case =''  
     
   Set @UPSCase1 = ''  
   Set @case1 =''  
     
   Set @UPSCase2 = ''  
   Set @case2 =''  
  
 If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fld_date),113))   
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))    
 Begin  
  Set @UPSCase = 'And Fld_Upsid NOT IN (''2'',''4'',''6'',''68'',''20'',''28'',''41'',''36'',''61'',''46'',''45'',''31'',''77'',''78'')'  
  Set @case = 'And Fld_Ups_id NOT IN (''2'',''4'',''6'',''68'',''20'',''28'',''41'',''36'',''61'',''46'',''45'',''31'',''77'',''78'')'  
 End  
    Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fld_date),113))   
        < Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))    
 Begin  
  Set @UPSCase = ''  
  Set @case =''  
 End                      
          
    --    Print @UPSCase  
          
 If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fld_date),113))   
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 June 2011'),113)))    
 Begin  
  Set @UPSCase1 = 'And Fld_Upsid NOT IN (''62'')'  
  Set @case1 = 'And Fld_Ups_id NOT IN (''62'')'  
 End  
  
    If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fld_date),113))   
        > Convert(Datetime,Convert(Varchar(12),convert(datetime,'12 June 2011'),113)))    
 Begin  
  Set @UPSCase2 = 'And Fld_Upsid NOT IN (''83'',''86'',''84'',''85'')'  
  Set @case2 ='And Fld_Ups_id NOT IN (''83'',''86'',''84'',''85'')'  
 End                
   Begin                   
 Set @str = 'Select x.Fld_Srno as ups_id,Fld_Brand_Name+''-''+Fld_Model_Capacity +''<br> [''+Fld_Model_SrNo+'']'' as ups_name,  
  y.* from                        
  (select * from V_UPS_Master   
      where  Fld_Branch_id like '''+@branchid+''' and Fld_App = ''U''  and Fld_Appl_To like  (''%D,%'')and Fld_Flag = ''A'' '+@case+' '+@case1+' '+@case2+'   
  )x                        
  left outer join                        
  (select * from tbl_ups_count_details (nolock)   
   where Fld_Date >= '''+@fld_date+''' and fld_date <= '''+@fld_date +' 23:59:59'+'''   
   '+ @UPSCase+'   '+ @UPSCase1+' '+ @UPSCase2+'  
  ) y                        
  on  x.Fld_Srno = y.Fld_upsid order by   ups_name '  
    --Convert(Varchar(11),DeactiveDate,103) >= '''+ @fld_date + ''' and
     print (@str)     
             
     exec(@str)   
   End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ups_details_mark
-- --------------------------------------------------
CREATE proc usp_ups_details_mark(@fld_date varchar(11))                      
as                      
                    
set @fld_date = convert(varchar(11),convert(datetime,@fld_date,103))         
    
select upper(Br_Name) as Br_Name from tbl_It_Br_Master where Sr_No in    
(    
select Fld_Branch_Code from tbl_ups_count_details (nolock) where 
(convert(money,Fld_945) > 75 or 
convert(money,Fld_2) > 75 or 
convert(money,Fld_530) > 75 or 
convert(money,Fld_10) > 75)     
and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'    
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ups_details_rpt
-- --------------------------------------------------
CREATE proc usp_ups_details_rpt(@branchid varchar(11),@fld_date varchar(11))                              
as              
      
set nocount on                      
                            
set @fld_date = convert(varchar(11),convert(datetime,@fld_date,103))                                
                            
select Br_name,ups_id,Fld_Brand_Name+'-'+Fld_Model_Capacity+'<br>&nbsp;&nbsp;'+Fld_Model_Srno as ups_name,y.* into #rpt from                              
(select * from V_UPS_Master where Fld_Branch_id like @branchid and Fld_App = 'U')x                              
inner join                              
(        
select x.*,y.person_name from        
(select * from tbl_ups_count_details (nolock)  where Fld_Date >= @fld_date and fld_date <= @fld_date+' 23:59:59')x        
left outer join        
(select * from intranet.risk.dbo.user_login) y        
on x.Fld_Upd_by = y.username        
) y                              
on  x.Fld_SrNo = y.Fld_upsid                  
      
    
      
select upper(Br_Name) as Branches into #y from tbl_It_Br_Master where Sr_No in          
(          
select Fld_Branch_Code from tbl_ups_count_details (nolock) where       
(convert(money,Fld_945) > 75 or       
convert(money,Fld_2) > 75 or       
convert(money,Fld_530) > 75 or       
convert(money,Fld_10) > 75 or Fld_Remark <> '')           
and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'          
)   
    
/*  
select upper(Br_Name) as Branches into #y from tbl_It_Br_Master where Sr_No in          
(          
select Fld_Branch_Code from tbl_ups_count_details (nolock) where       
Fld_Remark <> '' and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'          
) */   
      
select * from      
(select * from #rpt)x      
left outer join      
(select * from #y)y      
on x.br_Name = y.branches      
order by br_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ups_details_rpt1
-- --------------------------------------------------

        
CREATE proc [dbo].[usp_ups_details_rpt1]              
(              
@branchid varchar(11),              
@fdate varchar(11),              
@tdate varchar(11)              
)                                                                        
as                                                        
                                                
 set nocount on                                                                
  
   
 DECLARE @FDT AS DATETIME
 DECLARE @EDT AS DATETIME                                                                      
 set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                           
 set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                                                        
	Select Br_name, ups_id,        
	Fld_Brand_Name+'-'+Fld_Model_Capacity+'<br>&nbsp;&nbsp;'+Fld_Model_Srno as ups_name,        
	y.* into #rpt         
	From (Select * from V_UPS_Master where Fld_Branch_id like @branchid and Fld_App = 'U' and Fld_Flag='A'
	and Convert(Varchar(11),DeactiveDate,103) >= @fdate and Convert(Varchar(11),DeactiveDate,103) <= @tdate --added by harshal at 20 Mar 2013
	)x                                                                        
	left outer join(select x.*,y.person_name from                                                  
	(Select Fld_SrNo , Fld_Branch_Code ,Fld_Upsid,      
	(case when (Fld_945  <> '' and Fld_945 IS NOT NULL)Then Fld_945 Else 'NA' End)  as [Fld_945],      
	(case when (Fld_2  <> '' and Fld_2 IS NOT NULL)Then Fld_2 Else 'NA' End)  as [Fld_2],      
	(case when (Fld_530  <> '' and Fld_530 IS NOT NULL)Then Fld_530 Else 'NA' End) as [Fld_530],      
	(case when (Fld_10  <> '' and Fld_10 IS NOT NULL)Then Fld_10 Else 'NA' End)as [Fld_10],Fld_Date , 
	Fld_Upd_By , fld_remark from tbl_ups_count_details (nolock)           
	where         
    fld_date >= @fdate and fld_date <= @tdate+' 23:59:59'      
     --Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) >= Convert(Datetime,convert(varchar(11),convert(datetime,@FDT),113))         
     --and Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) <= Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@EDT),113) +' 23:59:59')        
   )x                                                  
   left outer join                                                  
	(select * from intranet.risk.dbo.user_login) y on x.Fld_Upd_by = y.username and x.fld_upd_by <> '') y on  x.Fld_SrNo = y.Fld_upsid
	where @branchid like REPLACE(@branchid,'ALL','%')   
	order by Ups_Name,Fld_Date                                           
                                               
 Select upper(Br_Name) as Branches         
 Into #y         
 From tbl_It_Br_Master         
 where Sr_No in                                                    
  (                                                    
   Select Fld_Branch_Code from tbl_ups_count_details (nolock)         
   Where (convert(money,Fld_945) > 79 or                                                 
     convert(money,Fld_2) > 79 or                                                 
     convert(money,Fld_530) > 79 or                                       
     convert(money,Fld_10) > 79 ) --or Fld_Remark <> ''          
     and Fld_Date >= @fdate and fld_date <= @tdate +' 23:59:59'           
     --and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'                                                  
    --And Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) >= Convert(Datetime,convert(varchar(11),convert(datetime,@FDT),113))         
    --and Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) <= Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@EDT),113) +' 23:59:59')                                                  
  )
/*                                            
select upper(Br_Name) as Branches into #y from tbl_It_Br_Master where Sr_No in                                                    
(                                                    
select Fld_Branch_Code from tbl_ups_count_details (nolock) where                                                 
Fld_Remark <> '' and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'                                                    
) */                                                
 Select *, [date]=convert(varchar(11),x.Fld_Date,103)       
 --Into TempUPDDailyReport      
 From                                                
  (         
   select * from #rpt where br_name <> '' and fld_date <> ''         
  )x                                                
  left outer join                                                
  (        
   select * from #y        
  )y                                                
  on x.br_Name = y.branches                                                
 Order by br_name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ups_details_rpt1_test
-- --------------------------------------------------
--sp_helptext usp_ups_details_rpt1

      
CREATE proc [dbo].[usp_ups_details_rpt1_test]        
(            
@branchid varchar(11),            
@fdate varchar(11),            
@tdate varchar(11)            
)                                                                      
as                                                      
                                              
 set nocount on                                                              
               
 DECLARE @FDT AS DATETIME      
 DECLARE @EDT AS DATETIME         
 --DECLARE @branchid As varchar(11)              
                                                                    
 set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                         
 set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                                                      
                                                                    
 --set @FDT =  Convert(Datetime,convert(varchar(11),convert(datetime,@fdate),113))      
 --set @EDT =  Convert(Datetime,convert(varchar(11),convert(datetime,@tdate),113))      
 ----SET @branchid = '198'      
          
 Select  distinct Br_name, ups_id,      
  Fld_Brand_Name+'-'+Fld_Model_Capacity+'<br>&nbsp;&nbsp;'+Fld_Model_Srno as ups_name,      
  y.*       
 into #rpt       
 From                                                                      
  (       
   Select * from V_UPS_Master where Fld_Branch_id like @branchid and Fld_App = 'U'      
  )x                                                                      
  left outer join                                                                      
  (                                                
   select x.*,y.person_name from                                                
   (      
   --select * from tbl_ups_count_details (nolock)    
    Select      
    Fld_SrNo , Fld_Branch_Code ,Fld_Upsid,    
    (case when (Fld_945  <> '' and Fld_945 IS NOT NULL)    
      Then Fld_945 Else 'NA' End)  as [Fld_945],    
  (case when (Fld_2  <> '' and Fld_2 IS NOT NULL)    
      Then Fld_2 Else 'NA' End)  as [Fld_2],    
  (case when (Fld_530  <> '' and Fld_530 IS NOT NULL)    
      Then Fld_530 Else 'NA' End) as [Fld_530],    
   (case when (Fld_10  <> '' and Fld_10 IS NOT NULL)    
      Then Fld_10 Else 'NA' End)as [Fld_10],    
   Fld_Date , Fld_Upd_By , fld_remark       
     from tbl_ups_count_details (nolock)         
    where       
      fld_date >= @fdate and fld_date <= @tdate+' 23:59:59'    
     --Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) >= Convert(Datetime,convert(varchar(11),convert(datetime,@FDT),113))       
     --and Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) <= Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@EDT),113) +' 23:59:59')      
   )x                                                
   left outer join                                                
   (       
    select * from intranet.risk.dbo.user_login       
   ) y                                                
   on x.Fld_Upd_by = y.username and x.fld_upd_by <> ''          
   ----and y.username <> '' and x.fld_upd_by is not null and y.username is not null                                               
  ) y                                                                      
  on  x.Fld_SrNo = y.Fld_upsid  order by Ups_Name,Fld_Date                                                    
                                              
                                             
 Select upper(Br_Name) as Branches       
 Into #y       
 From tbl_It_Br_Master       
 where Sr_No in                                                  
  (                                                  
   Select Fld_Branch_Code from tbl_ups_count_details (nolock)       
   Where (convert(money,Fld_945) > 79 or                                               
     convert(money,Fld_2) > 79 or                                               
     convert(money,Fld_530) > 79 or                     
     convert(money,Fld_10) > 79 ) --or Fld_Remark <> ''        
     and Fld_Date >= @fdate and fld_date <= @tdate +' 23:59:59'         
     --and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'                                                
    --And Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) >= Convert(Datetime,convert(varchar(11),convert(datetime,@FDT),113))       
    --and Convert(Datetime,Convert(Varchar(12),Convert(Datetime,fld_date),113)) <= Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@EDT),113) +' 23:59:59')                                                
  )               
                            
                                            
/*                                          
select upper(Br_Name) as Branches into #y from tbl_It_Br_Master where Sr_No in                                                  
(                                                  
select Fld_Branch_Code from tbl_ups_count_details (nolock) where                                               
Fld_Remark <> '' and Fld_Date >= @fld_date and fld_date <= @fld_date +' 23:59:59'                                                  
) */                                           
                                              
 Select *, [date]=convert(varchar(11),x.Fld_Date,103)     
 --Into TempUPDDailyReport    
 From                                              
  (       
   select * from #rpt where br_name <> '' and fld_date <> ''       
  )x                                              
  left outer join                                              
  (      
   select * from #y      
  )y                                              
  on x.br_Name = y.branches                                              
 Order by br_name       
      
  --  Select * From TempUPDDailyReport  
      
--select * from V_UPS_Master

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ups_details_rpt1_Test1
-- --------------------------------------------------

--usp_ups_details_rpt1_Test1 '129','04/07/2012','05/07/2012'     
CREATE proc [dbo].[usp_ups_details_rpt1_Test1]                
(                
@branchid varchar(11),                
@fdate varchar(11),                
@tdate varchar(11)                
)                                                                          
as                                                          
                                                  
 set nocount on                                                                  
                   
 DECLARE @FDT AS DATETIME          
 DECLARE @EDT AS DATETIME             
                
                                                                        
 set @fdate = convert(varchar(11),convert(datetime,@fdate,103))                                             
 set @tdate = convert(varchar(11),convert(datetime,@tdate,103))                                                                          
                                                                        
    
              
   Declare @str as varchar(4000)      
   Declare @str1 as varchar(4000)      
   Declare @str2 as varchar(4000)            
   Declare @case as varchar(1000)         
   Declare @UPSCase As Varchar(1000) 
   Declare @case1 as varchar(500)         
   Declare @UPSCase1 As Varchar(500)
   Declare @case2 as varchar(500)         
   Declare @UPSCase2 As Varchar(500)                                      
      
   Set @UPSCase = '' 
   
   Set @UPSCase1 = ''
   Set @case1 =''
   
   Set @UPSCase2 = ''
   Set @case2 =''     
       
 --If(fld_date >= @fdate and fld_date <= @tdate+' 23:59:59')      
 If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))       
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113))        
  And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))       
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'29 Apr 2049'),113)))      
 Begin      
  Set @UPSCase = 'And Fld_Upsid NOT IN (''2'',''4'',''6'',''68'',''20'',''28'',''41'',''36'',''61'',''46'',''45'',''31'','' 77'',''78'')'      
 End      
    Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))       
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2007'),113))        
  And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))       
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))      
 Begin      
  Set @UPSCase = ''      
 End      
      
	If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 June 2011'),113)))  
	Begin
		Set @UPSCase1 = 'And Fld_Upsid NOT IN (''62'')'
	End

	If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113)) 
			  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'12 June 2011'),113)))  
	Begin
		Set @UPSCase2 = 'And Fld_Upsid NOT IN (''83'',''86'',''84'',''85'')'
	End  
  -- print (@UPSCase)       
     
     Drop Table Temp      
     Drop Table Temp1      
       
  Set @str = 'Select Br_name, ups_id,          
              Br_name + ''-''+ Fld_Brand_Name+''-''+Fld_Model_Capacity+ '' ''+Fld_Model_Srno as ups_name,          
    y.*           
    into Temp       
    From                                                                          
    (           
       Select * from V_UPS_Master where Fld_Branch_id like '''+@branchid+'''       
       and Fld_App = ''U'' and Fld_Flag=''A''         
       )x                                                                          
       left outer join                                                                          
       (                                                    
       select x.*,y.person_name from                                                    
       (          
       Select          
       Fld_SrNo , Fld_Branch_Code ,Fld_Upsid,        
       (case when (Fld_945  <> '''' and Fld_945 IS NOT NULL)        
         Then Fld_945 Else ''NA'' End)  as [Fld_945],        
       (case when (Fld_2  <> '''' and Fld_2 IS NOT NULL)        
         Then Fld_2 Else ''NA'' End)  as [Fld_2],        
       (case when (Fld_530  <> '''' and Fld_530 IS NOT NULL)        
         Then Fld_530 Else ''NA'' End) as [Fld_530],        
       (case when (Fld_10  <> '''' and Fld_10 IS NOT NULL)        
         Then Fld_10 Else ''NA'' End)as [Fld_10],        
       Fld_Date , Fld_Upd_By , fld_remark           
       from tbl_ups_count_details (nolock)             
       where           
         fld_date >= '''+@fdate+''' and fld_date <= '''+@tdate+'''       
         '+@UPSCase+' '+ @UPSCase1+' '+ @UPSCase2+'      
        )x                                                    
       left outer join                                                    
       (           
        select * from intranet.risk.dbo.user_login           
       ) y                                                    
       on x.Fld_Upd_by = y.username and x.fld_upd_by <> ''''              
       ) y                                                                          
    on  x.Fld_SrNo = y.Fld_upsid order by Ups_Name,Fld_Date'                                                        
                        
     print (@str)         
                 
     exec(@str)       
                                
                                                 
   Set @str1 = 'Select upper(Br_Name) as Branches           
   Into Temp1          
    From tbl_It_Br_Master           
   where Sr_No in                                                      
    (                                                      
   Select Fld_Branch_Code from tbl_ups_count_details (nolock)           
   Where (convert(money,Fld_945) > 79 or                                                   
     convert(money,Fld_2) > 79 or                                                   
     convert(money,Fld_530) > 79 or                                                   
     convert(money,Fld_10) > 79 )           
     and Fld_Date >= '''+@fdate+''' and fld_date <= '''+@tdate+'''             
          
    )'                 
                                  
               
    print (@str1)         
                  
    exec(@str1)                                        
                                               
                                                
    set @str2='Select *, [date]=convert(varchar(11),x.Fld_Date,103)         
      From                                                  
       (           
       select * from Temp where br_name <> '''' and fld_date <> ''''           
       )x                                                  
       left outer join                                                  
       (          
      select * from Temp1       
       )y                                                  
        on x.br_Name = y.branches                                                  
        Order by br_name'         
  print (@str2)         
                 
    exec(@str2)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ups_details_test
-- --------------------------------------------------
--sp_helptext  usp_ups_details_test '228','02/05/2011'



CREATE proc usp_ups_details_test(@branchid varchar(10),@fld_date varchar(11))                      
as                      
                    
set @fld_date = convert(varchar(11),convert(datetime,@fld_date,103))
      
   Declare @str as varchar(4000)    
   Declare @case as varchar(1000)   
   Declare @UPSCase As Varchar(1000)       

   Set @UPSCase = ''
	

	If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fld_date),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))  
	Begin
		Set @UPSCase = 'And Fld_Upsid NOT IN (''2'',''4'',''73'',''6'',''11'',''62'',''68'',''20'',''28'',''41'',''36'',''61'',''46'',''45'')'
		Set @case = 'And Fld_Ups_id NOT IN (''2'',''4'',''73'',''6'',''11'',''62'',''68'',''20'',''28'',''41'',''36'',''61'',''46'',''45'')'
	End
    Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fld_date),113)) 
		      < Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))  
	Begin
		Set @UPSCase = ''
		Set @case =''
	End                    
                    
   Begin                 
	Set @str = 'Select x.Fld_Srno as ups_id,Fld_Brand_Name+''-''+Fld_Model_Capacity +''<br> [''+Fld_Model_SrNo+'']'' as ups_name,
		y.* from                      
		(select * from V_UPS_Master 
		    where Fld_Branch_id like '''+@branchid+''' and Fld_App = ''U'' and Fld_Flag = ''A'' '+@case+'
		)x                      
		left outer join                      
		(select * from tbl_ups_count_details (nolock) 
		 where Fld_Date >= '''+@fld_date+''' and fld_date <= '''+@fld_date +' 23:59:59'+''' 
		 '+ @UPSCase+'
		) y                      
		on  x.Fld_Srno = y.Fld_upsid order by   ups_name '
		
     print (@str)   
           
     exec(@str) 
   End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Mail
-- --------------------------------------------------




CREATE proc [dbo].[USP_UPS_Mail]                          
as                                
                                                                  
SET NOCOUNT ON    
                           
                                
DECLARE @email_id varchar(2500),@message as varchar(5000),@br_tag AS VARCHAR(20),                      
@MAIL AS VARCHAR(2500),@brname as varchar(100)                     
      
declare @str as varchar(50)      
set @str=(SELECT DATENAME(dw, GETDATE()) as DayName)                                
      
if  @str = 'Monday'        
 Begin      
	 Select distinct br_tag,upper(br_name)+' ['+(br_Tag)+']' as br_name into #x from  V_IT_Staff_Rpt_New  where Status = 'A' and Fld_Branch_id in                                
	(                                  
	SELECT Distinct sr_No FROM V_UPS_Report x (nolock) 
	where Sr_No not In ('196','36','120','8','114','116') and not exists                                  
	(select * from tbl_ups_count_details y (nolock)  where Fld_Date = convert(varchar(11),getdate()-2) and x.sr_no = Fld_Branch_Code)                                   
	)      
      
	DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x where br_tag not in ('HO')                                                                  
	OPEN tcp_cursor                                                                  
	                                                                  
	FETCH NEXT FROM tcp_cursor                                                                  
	INTO @br_tag,@brname                                                                  
	                                                                  
	WHILE @@FETCH_STATUS = 0                                                                  
	BEGIN                                      
	                                
	set @email_id = ''                                 
	                                 
	 DECLARE TCP_MAILS CURSOR FOR SELECT EMAILADD FROM V_IT_Staff_Rpt_New WHERE BR_TAG = @br_tag and Status = 'A'                               
	 OPEN TCP_MAILS                                
	                                
	 SET @MAIL = ''                                
	                                 
	 FETCH NEXT FROM TCP_MAILS                                
	 INTO @email_id                                
	                                
	 WHILE @@FETCH_STATUS = 0                                                                  
	 BEGIN                                 
	                                
	 SET @MAIL = @email_id+';'+@MAIL                                
	                                
	 FETCH NEXT FROM TCP_MAILS                                                                   
	 INTO @email_id                                  
	                                
	 END                                        
	                                
	 CLOSE TCP_MAILS                                
	 DEALLOCATE TCP_MAILS                                
	                                 
 --PRINT @MAIL                                 
set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for Yesterdays UPS daily report.<br><br><b><font color=#ff6666>Kindly note that the cut off timing for UPS daily report is 9.00 a.m. (Next day)</font></b> 
   
 <br><br><br>Best Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                   
  
                                                 
-- exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITBranchsupport@angeltrade.com','Reminder for UPS Daily Report',@message                                 
exec('mis.helpdesk.dbo.usp_AutoMail '''+@MAIL+''',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                                                                           
--exec('mis.helpdesk.dbo.usp_AutoMail_TCP ''rupali.mayekar@angelbroking.com'',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                                                                              
  
    
      
                                    
 FETCH NEXT FROM tcp_cursor                                                                   
 INTO @br_tag,@brname                                                   
                                             
END                        
	                                                                  
	CLOSE tcp_cursor                     
	DEALLOCATE tcp_cursor           
  
end      
  
-----<>monday      
    
if  @str <> 'Monday'     
begin      
select distinct br_tag,upper(br_name)+' ['+(br_Tag)+']' as br_name into #x1 from  V_IT_Staff_Rpt_New where Status = 'A' and Fld_Branch_id in                                
(                                  
SELECT Distinct sr_No FROM V_UPS_Report x (nolock) 
where Sr_No not In ('196','36','120','8','114','116') and  not exists                                  
(select * from tbl_ups_count_details y (nolock)  where Fld_Date = convert(varchar(11),getdate()-1) and x.sr_no = Fld_Branch_Code)                                   
)      
      
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x1 where br_tag not in ('HO')                                                                  
OPEN tcp_cursor                                                                  
                                                                  
FETCH NEXT FROM tcp_cursor                                                                  
INTO @br_tag,@brname                                                                  
                                                                  
WHILE @@FETCH_STATUS = 0                                                                  
BEGIN                                      
                                
set @email_id = ''                                 
                                 
 DECLARE TCP_MAILS CURSOR FOR SELECT EMAILADD FROM V_IT_Staff_Rpt_New WHERE BR_TAG = @br_tag and Status = 'A'                               
 OPEN TCP_MAILS                                
                                
 SET @MAIL = ''                                
                                 
 FETCH NEXT FROM TCP_MAILS                                
 INTO @email_id                                
                                
 WHILE @@FETCH_STATUS = 0                                                                  
 BEGIN                                 
                                
 SET @MAIL = @email_id+';'+@MAIL                                
                                
 FETCH NEXT FROM TCP_MAILS                                                                   
 INTO @email_id                                  
                                
 END                                        
                                
 CLOSE TCP_MAILS                                
 DEALLOCATE TCP_MAILS                                
                                 
 --PRINT @MAIL                                 
	set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for Yesterdays UPS daily report.<br><br><b><font color=#ff6666>Kindly note that the cut off timing for UPS daily report is 9.00 a.m. (Next day)</font></b> 
   
 <br><br><br>Best Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                   
  
                                                 
-- exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITBranchsupport@angeltrade.com','Reminder for UPS Daily Report',@message                                 
exec('mis.helpdesk.dbo.usp_AutoMail '''+@MAIL+''',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                     
--exec('mis.helpdesk.dbo.usp_AutoMail_TCP ''megha.wangane@angeltrade.com'',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                                                                             
  
     
                                   
 FETCH NEXT FROM tcp_cursor                                                                   
 INTO @br_tag,@brname          
                                             
END                                                              
CLOSE tcp_cursor                     
DEALLOCATE tcp_cursor       
end     
    
----<> monday end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Mail_backup
-- --------------------------------------------------
CREATE proc USP_UPS_Mail_backup                    
as                        
                                                          
SET NOCOUNT ON                        
                        
DECLARE @email_id varchar(500),@message as varchar(1000),@br_tag AS VARCHAR(20),              
@MAIL AS VARCHAR(500),@brname as varchar(100)                                             
                      
select distinct br_tag,upper(br_name)+' ['+(br_Tag)+']' as br_name into #x from V_IT_Staff_Rpt_New where Status = 'A' and Fld_Branch_id in                        
(                          
SELECT Distinct sr_No FROM V_UPS_Report x (nolock) where  not exists                          
(select * from tbl_ups_count_details y (nolock)  where Fld_Date = convert(varchar(11),getdate()-1) and x.sr_no = Fld_Branch_Code)                           
)                      
                                                          
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x where br_tag not in ('HO')                                                          
OPEN tcp_cursor                                                          
                                                          
FETCH NEXT FROM tcp_cursor                                                          
INTO @br_tag,@brname                                                          
                                                          
WHILE @@FETCH_STATUS = 0                                                          
BEGIN                              
                        
 set @email_id = ''                         
                         
 DECLARE TCP_MAILS CURSOR FOR SELECT EMAILADD FROM V_IT_Staff_Rpt_New WHERE BR_TAG = @br_tag and Status = 'A'                       
 OPEN TCP_MAILS                        
                        
 SET @MAIL = ''                        
                         
 FETCH NEXT FROM TCP_MAILS                        
 INTO @email_id                        
                        
 WHILE @@FETCH_STATUS = 0                                                          
 BEGIN                         
                        
 SET @MAIL = @email_id+';'+@MAIL                        
                        
 FETCH NEXT FROM TCP_MAILS                                                           
 INTO @email_id                          
                        
 END                                
                        
 CLOSE TCP_MAILS                        
 DEALLOCATE TCP_MAILS                        
                         
 --PRINT @MAIL                         
 set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for Yesterdays UPS daily report.<br><br><b><font color=#ff6666>Kindly note that the cut off timing for UPS daily report is 9.00 a.m. (Next day)</font></b>
  
    
        
          
 <br><br><br>Best Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                   
  
    
       
        
          
               
                  
                                                     
-- exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITBranchsupport@angeltrade.com','Reminder for UPS Daily Report',@message                         
exec('mis.helpdesk.dbo.usp_AutoMail '''+@MAIL+''',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                                                                   
--exec('mis.helpdesk.dbo.usp_AutoMail_TCP ''megha.wangane@angeltrade.com'',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                                                                              
  
                                             
 FETCH NEXT FROM tcp_cursor                                                           
 INTO @br_tag,@brname                                           
                                     
END                
                                                          
CLOSE tcp_cursor             
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Mail_changbackup
-- --------------------------------------------------
CREATE proc USP_UPS_Mail_changbackup                      
as                          
                                                            
SET NOCOUNT ON                          
                          
DECLARE @email_id varchar(500),@message as varchar(1000),@br_tag AS VARCHAR(20),                
@MAIL AS VARCHAR(500),@brname as varchar(100)                                               
                     
select distinct br_tag,upper(br_name)+' ['+(br_Tag)+']' as br_name into #x   
from V_IT_Staff_Rpt_New where Status = 'A' and Fld_Branch_id in                          
(                            
SELECT Distinct sr_No FROM V_UPS_Report x (nolock) where  not exists                            
(select * from tbl_ups_count_details y (nolock)  where Fld_Date =   
(select max(tdate) from sett_mst (nolock) where tdate < convert(varchar(11),getdate()))  
and x.sr_no = Fld_Branch_Code)                             
)                        
                                                            
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x where br_tag not in ('HO')                                                            
OPEN tcp_cursor                                                            
                                                            
FETCH NEXT FROM tcp_cursor                                                            
INTO @br_tag,@brname                                                            
                                                            
WHILE @@FETCH_STATUS = 0                                                            
BEGIN                                
                          
 set @email_id = ''                           
                           
 DECLARE TCP_MAILS CURSOR FOR SELECT EMAILADD FROM V_IT_Staff_Rpt_New WHERE BR_TAG = @br_tag and Status = 'A'                         
 OPEN TCP_MAILS                          
                          
 SET @MAIL = ''                          
                           
 FETCH NEXT FROM TCP_MAILS                          
 INTO @email_id                          
                          
 WHILE @@FETCH_STATUS = 0                                                            
 BEGIN                           
                          
 SET @MAIL = @email_id+';'+@MAIL                          
                          
 FETCH NEXT FROM TCP_MAILS                                                             
 INTO @email_id                            
                          
 END                                  
                          
 CLOSE TCP_MAILS                          
 DEALLOCATE TCP_MAILS                          
                           
 --PRINT @MAIL                           
 set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for Yesterdays UPS daily report.<br><br><b><font color=#ff6666>Kindly note that the cut off timing for UPS daily report is 9.00 a.m. (Next day)</font></b>
  
    
      
          
            
 <br><br><br>Best Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                   
  
    
      
         
          
            
                 
                    
                                                       
-- exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITBranchsupport@angeltrade.com','Reminder for UPS Daily Report',@message                           
exec('mis.helpdesk.dbo.usp_AutoMail '''+@MAIL+''',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                                                                     
--exec('mis.helpdesk.dbo.usp_AutoMail_TCP ''megha.wangane@angeltrade.com'',''ITbranchsupport'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+''','''+@brname+'''')                                  
    
                                               
 FETCH NEXT FROM tcp_cursor                                                             
 INTO @br_tag,@brname                                             
                                       
END                  
                                                            
CLOSE tcp_cursor               
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Mail_Saturday
-- --------------------------------------------------

CREATE proc USP_UPS_Mail_Saturday          
as              
                                                
SET NOCOUNT ON              
              
DECLARE @email_id varchar(500),@message as varchar(1000),@br_tag AS VARCHAR(20),    
@MAIL AS VARCHAR(500),@brname as varchar(100)                                   
            
select distinct br_tag,upper(br_name)+' ['+(br_Tag)+']' as br_name into #x from V_IT_Staff_Rpt_New where Status = 'A' and Fld_Branch_id in              
(                
SELECT Distinct sr_No FROM V_UPS_Report x (nolock) where  not exists                
(select * from tbl_ups_count_details y (nolock)  where Fld_Date = convert(varchar(11),getdate())   
and x.sr_no = Fld_Branch_Code)                 
)            
                                                
DECLARE tcp_cursor CURSOR FOR select DISTINCT br_tag,br_name from #x where br_tag not in ('HO')                                                
OPEN tcp_cursor                                                
                                                
FETCH NEXT FROM tcp_cursor                                                
INTO @br_tag,@brname                                                
                                                
WHILE @@FETCH_STATUS = 0                                                
BEGIN                    
              
 set @email_id = ''               
               
 DECLARE TCP_MAILS CURSOR FOR SELECT EMAILADD FROM V_IT_Staff_Rpt_New WHERE BR_TAG = @br_tag and Status = 'A'             
 OPEN TCP_MAILS              
              
 SET @MAIL = ''              
               
 FETCH NEXT FROM TCP_MAILS              
 INTO @email_id              
              
 WHILE @@FETCH_STATUS = 0                                                
 BEGIN               
              
 SET @MAIL = @email_id+';'+@MAIL              
              
 FETCH NEXT FROM TCP_MAILS                                                 
 INTO @email_id                
              
 END                      
              
 CLOSE TCP_MAILS              
 DEALLOCATE TCP_MAILS              
               
 --PRINT @MAIL               
set @message = '<font style= "FONT-FAMILY: Calibri"><br>Dear IT Team,<br><br>This is to remind you for Yesterdays UPS daily report.<br><br><b><font color=#ff6666>Kindly note that the cut off timing for UPS daily report is 9.00 a.m. (Next day)</font></b><
br><br><br>Best Regards,<br><b>IT Branch Support Team</b><br>Angel Broking Ltd.<br>Central Support Office<br>Tel no: 022-28358800 (Ext: 404/405/406)<br></font>'--<img src = "\\196.1.115.136\d$\upload1\AngelLogo.bmp" >'                                        
      
                                           
-- exec mis.master.dbo.usp_AutoMail_TCP @MAIL,'ITBranchsupport@angeltrade.com','Reminder for UPS Daily Report',@message               
exec('mis.master.dbo.usp_AutoMail_TCP '''+@MAIL+''',''ITBranchsupport@angeltrade.com'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+'''')                                                         
--exec('mis.master.dbo.usp_AutoMail_TCP ''mangesh.wangane@angeltrade.com'',''mangesh.wangane@angeltrade.com'',''Reminder for UPS Daily Report - '+@brname+''','''+@message+'''')                                                         
                                                  
 FETCH NEXT FROM tcp_cursor                                                 
 INTO @br_tag,@brname                                 
                           
END                                                
                                                
CLOSE tcp_cursor                                                
DEALLOCATE tcp_cursor

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UPS_Master
-- --------------------------------------------------
CREATE proc [dbo].[Usp_UPS_Master]                    
(                    
@Fld_srNo int,          
@Fld_Brand_id int,                    
@Fld_Model_id int,                    
@Fld_Model_Capacity_id int,                    
@Fld_Model_Srno varchar(50),                    
@Fld_Battery_Bank varchar(50),                    
@Fld_Warrenty_From varchar(11),                    
@Fld_Warrenty_To  varchar(11),                    
@Fld_Status char(10),                    
@Fld_Upd_By varchar(15),                
@Fld_Vendor_Id int,                
@Fld_Bat_WFrom varchar(11),                    
@Fld_Bat_WTo varchar(11),              
@Fld_Battery_Brand varchar(50),              
@Fld_Battery_Remark varchar(100),        
@Fld_Appl_To varchar(25)      
)                    
as                    
                    
set @Fld_Warrenty_From =  convert(datetime,@Fld_Warrenty_From,103)                  
set @Fld_Warrenty_To =  convert(datetime,@Fld_Warrenty_To,103)                  
set @Fld_Bat_WFrom =  convert(datetime,@Fld_Bat_WFrom,103)                  
set @Fld_Bat_WTo =  convert(datetime,@Fld_Bat_WTo,103)              
--set @Fld_Upd_date =  convert(datetime,@Fld_Upd_date,103)              
          
if (select count(*) from  tbl_UPS_Master where  Fld_srNo = @Fld_srNo) = 0          
          
begin                    
          
insert into tbl_UPS_Master(Fld_Brand_id,    
Fld_Model_id,    
Fld_Model_Capacity_id,    
Fld_Model_Srno,    
Fld_Battery_Bank,    
Fld_Warrenty_From,    
Fld_Warrenty_To,    
Fld_Status,    
Fld_Upd_By,    
Fld_Upd_date,    
Fld_Vendor_Id,    
Fld_Bat_WFrom,    
Fld_Bat_WTo,    
Fld_Battery_Brand,    
Fld_Battery_Remark,    
Fld_Appl_To,    
Fld_Activation_Status,DeactivatedOn) values    
(    
@Fld_Brand_id,    
@Fld_Model_id,    
@Fld_Model_Capacity_id,    
@Fld_Model_Srno,    
@Fld_Battery_Bank,    
@Fld_Warrenty_From,    
@Fld_Warrenty_To,    
@Fld_Status,            
@Fld_Upd_By,    
getdate(),    
@Fld_Vendor_Id,    
@Fld_Bat_WFrom,    
@Fld_Bat_WTo,    
@Fld_Battery_Brand,    
@Fld_Battery_Remark,    
@Fld_Appl_To,    
'A',
'2049-12-30 14:20:49.483'    
)    
end    
else    
begin    
update tbl_UPS_Master set    
Fld_Brand_id = @Fld_Brand_id,    
Fld_Model_id = @Fld_Model_id,    
Fld_Model_Capacity_id = @Fld_Model_Capacity_id,    
Fld_Model_Srno = @Fld_Model_Srno,      
Fld_Battery_Bank = @Fld_Battery_Bank,    
Fld_Warrenty_From = @Fld_Warrenty_From,    
Fld_Warrenty_To = @Fld_Warrenty_To,    
Fld_Status = @Fld_Status,          
Fld_Upd_By = @Fld_Upd_By,    
Fld_Upd_date = getdate(),    
Fld_Vendor_Id = @Fld_Vendor_Id,    
Fld_Bat_WFrom = @Fld_Bat_WFrom,    
Fld_Bat_WTo = @Fld_Bat_WTo,    
Fld_Battery_Brand =@Fld_Battery_Brand,    
Fld_Battery_Remark = @Fld_Battery_Remark,    
Fld_Appl_To= @Fld_Appl_To,Fld_activation_status='A'    
where Fld_srNo = @Fld_srNo    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Not_Update
-- --------------------------------------------------
CREATE Proc USP_UPS_Not_Update(@fdate as varchar(11))    
as    
    
set @fdate = convert(varchar(11),convert(datetime,@fdate,103))  
  
SELECT Distinct Br_Name FROM V_UPS_Report x (nolock) where /*Br_type = 'DATACENTER' and*/ not exists    
(select * from tbl_ups_count_details y (nolock)  where Fld_Date = @fdate and x.sr_no = Fld_Branch_Code)     
order by Br_Name--,S,Fld_id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Not_Update_Latest
-- --------------------------------------------------

 --USP_UPS_Not_Update_Latest '04/06/2012','06/06/2012'     
 -- =============================================    
-- Author:  <Author,,Name>    
-- Create date: <Create Date,,>    
-- Description: <Description,,>    
-- =============================================    

CREATE Proc [dbo].[USP_UPS_Not_Update_Latest]    
(    
--@fdate as varchar(11),     
--@tdate as varchar(11)    
@fdate varchar(11),            
@tdate varchar(11)  )             
  
As          
Begin  
   
 SET NOCOUNT ON    
           
  Declare @str as varchar(4000)
  Declare @str1 as varchar(4000)
  Declare @str2 as varchar(4000)      
  Declare @case as varchar(1000)   
  Declare @UPSCase As Varchar(1000)       
  set @fdate = convert(varchar(11),convert(datetime,@fdate,103))      
  set @tdate = convert(varchar(11),convert(datetime,@tdate,103)) 
  Set @UPSCase = ''
	

	If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113))  
		And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113)) 
		< Convert(Datetime,Convert(Varchar(12),convert(datetime,'29 Apr 2049'),113)))
	Begin
		Set @UPSCase = 'Sr_no Not IN (''196'',''36'',''120'',''114'',''116'',''8'') and'
	End
    Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2007'),113))  
		And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))
	Begin
		Set @UPSCase = ''
	End
  DECLARE @diff AS varchar(10)      
       
  SELECT  @diff = DateDiff(DAY,CONVERT(Datetime,Convert(varchar(12),convert(datetime,@fdate),113)),CONVERT(Datetime,Convert(varchar(12),convert(datetime,@tdate)+1,113)) )      
           
  Set @str = 'SELECT Fld_Branch_Code, COUNT(Fld_Branch_Code) AS BranchCount      
  INTO BranchCount      
  FROM      
  (      
   Select Fld_Branch_Code, Fld_Date      
   from tbl_ups_count_details y (nolock)        
   where  Fld_Date  between   CONVERT(Datetime,Convert(varchar(12),convert(datetime, '''+@fdate+'''),113))      
    and  CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@tdate+''')+1,113)) 
   Group By Fld_Branch_Code, Fld_Date      
  ) T      
  GROUP BY Fld_Branch_Code '             
           
     print (@str)   
           
     exec(@str) 
           
 set @str1 = ' Select Br_Name  as [Branch] from     
  (    
  Select Br_Name      
  FROM V_UPS_Report x with (nolock), BranchCount       
  WHERE sr_no = Fld_Branch_Code       
   AND BranchCount <  '+@diff+'      
  --ORDER BY Br_Name      
        
  Union All      
        
  Select Distinct Br_Name       
  FROM V_UPS_Report x (nolock)       
  Where  '+@UPSCase+'  /*Br_type = ''+DATACENTER+'' and*/ not exists            
   (Select fld_Branch_Code from tbl_ups_count_details y (nolock)        
    where Fld_Date       
    --between @fdate and  @tdate      
    between   CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@fdate+'''),113))      
    and  CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@tdate+''')+1,113))  
    and x.sr_no = Fld_Branch_Code)       
    ) temp  '
     
     print (@str1)   
           
     exec(@str1) 
         
  DROP TABLE BranchCount    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Not_Update_Latest_New
-- --------------------------------------------------
   
--USP_UPS_Not_Update_Latest_New '2 Apr 2011','2 Apr 2011'
 CREATE Proc [dbo].[USP_UPS_Not_Update_Latest_New] 
    
 @fdate varchar(11),
 @tdate varchar(11)
As          
Begin  
   
 SET NOCOUNT ON   
  
  Declare @str as varchar(4000)
  Declare @str1 as varchar(4000)
  Declare @str2 as varchar(4000)      
  Declare @case as varchar(1000)   
  Declare @UPSCase As Varchar(1000)       
  set @fdate = convert(varchar(11),convert(datetime,@fdate,103))      
  set @tdate = convert(varchar(11),convert(datetime,@tdate,103)) 
   Set @UPSCase = ''
	

	If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113))  
		And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113)) 
		< Convert(Datetime,Convert(Varchar(12),convert(datetime,'29 Apr 2049'),113)))
	Begin
		Set @UPSCase = 'Sr_no Not IN (''196'',''36'',''120'',''114'',''116'') and'
	End
    Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2007'),113))  
		And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113)) 
		> Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))
	Begin
		Set @UPSCase = ''
	End
  DECLARE @diff AS varchar(10)      
       
  SELECT  @diff = DateDiff(DAY,CONVERT(Datetime,Convert(varchar(12),convert(datetime,@fdate),113)),CONVERT(Datetime,Convert(varchar(12),convert(datetime,@tdate)+1,113)) )      
           
  Set @str = 'SELECT Fld_Branch_Code, COUNT(Fld_Branch_Code) AS BranchCount      
  INTO BranchCount      
  FROM      
  (      
   Select Fld_Branch_Code, Fld_Date      
   from tbl_ups_count_details y (nolock)        
   where  Fld_Date  between   CONVERT(Datetime,Convert(varchar(12),convert(datetime, '''+@fdate+'''),113))      
    and  CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@tdate+''')+1,113)) 
   Group By Fld_Branch_Code, Fld_Date      
  ) T      
  GROUP BY Fld_Branch_Code '             
           
     print (@str)   
           
     exec(@str) 
           
 set @str1 = ' Select Br_Name from     
  (    
  Select Br_Name      
  FROM V_UPS_Report x with (nolock), BranchCount       
  WHERE sr_no = Fld_Branch_Code       
   AND BranchCount <  '+@diff+'      
  --ORDER BY Br_Name      
        
  Union All      
        
  Select Distinct Br_Name       
  FROM V_UPS_Report x (nolock)       
  Where  '+@UPSCase+'  /*Br_type = ''+DATACENTER+'' and*/ not exists            
   (Select fld_Branch_Code from tbl_ups_count_details y (nolock)        
    where Fld_Date       
    --between @fdate and  @tdate      
    between   CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@fdate+'''),113))      
    and  CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@tdate+''')+1,113))  
    and x.sr_no = Fld_Branch_Code)       
    ) temp  '
     
     print (@str1)   
           
     exec(@str1) 
         
  DROP TABLE BranchCount    
  end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_Not_Update_Latest1
-- --------------------------------------------------
--sp_helptext USP_UPS_Not_Update_Latest

--USP_UPS_Not_Update_Latest1 '17 May 2011','17 May 2011'
   
 -- =============================================      
-- Author:  <Author,,Name>      
-- Create date: <Create Date,,>      
-- Description: <Description,,>      
-- =============================================      
CREATE Proc [dbo].[USP_UPS_Not_Update_Latest1]      
(      
--@fdate as varchar(11),       
--@tdate as varchar(11)      
@fdate varchar(11),              
@tdate varchar(11)  )               
    
As            
Begin    
     
 SET NOCOUNT ON      
             
  Declare @str as varchar(4000)  
  Declare @str1 as varchar(4000)  
  Declare @str2 as varchar(4000)        
  Declare @case as varchar(1000)     
  Declare @UPSCase As Varchar(1000)         
  set @fdate = convert(varchar(11),convert(datetime,@fdate,103))        
  set @tdate = convert(varchar(11),convert(datetime,@tdate,103))   
  Set @UPSCase = ''  
   
  
 If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))   
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113))    
  And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))   
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'29 Apr 2049'),113)))  
 Begin  
  Set @UPSCase = 'Sr_no Not IN (''196'',''36'',''120'',''114'',''116'',''8'') and'  
 End  
    Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))   
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2007'),113))    
  And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))   
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))  
 Begin  
  Set @UPSCase = ''  
 End  
  DECLARE @diff AS varchar(10)        
         
  SELECT  @diff = DateDiff(DAY,CONVERT(Datetime,Convert(varchar(12),convert(datetime,@fdate),113)),CONVERT(Datetime,Convert(varchar(12),convert(datetime,@tdate)+1,113)) )        
             
  Set @str = 'SELECT Fld_Branch_Code, COUNT(Fld_Branch_Code) AS BranchCount        
  INTO BranchCount        
  FROM        
  (        
   Select Fld_Branch_Code, Fld_Date        
   from tbl_ups_count_details y (nolock)          
   where  Fld_Date  between   CONVERT(Datetime,Convert(varchar(12),convert(datetime, '''+@fdate+'''),113))        
    and  CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@tdate+''')+1,113))   
   Group By Fld_Branch_Code, Fld_Date        
  ) T        
  GROUP BY Fld_Branch_Code '               
             
     print (@str)     
             
     exec(@str)   
             
 set @str1 = ' Select Br_Name from       
  (      
  Select Br_Name        
  FROM V_UPS_Report x with (nolock), BranchCount         
  WHERE sr_no = Fld_Branch_Code         
   AND BranchCount <  '+@diff+'        
  --ORDER BY Br_Name        
          
  Union All        
          
  Select Distinct Br_Name  , Fld_Brand_Name+''-''+Fld_Model_Capacity+ '' ''+Fld_Model_Srno as ups_name       
  FROM V_UPS_Report x (nolock)  , V_UPS_Master y (nolock)         
  Where  '+@UPSCase+'  /*Br_type = ''+DATACENTER+'' and*/ not exists              
   (Select fld_Branch_Code from tbl_ups_count_details y (nolock)          
    where Fld_Date         
    --between @fdate and  @tdate        
    between   CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@fdate+'''),113))        
    and  CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@tdate+''')+1,113))    
    and x.sr_no = Fld_Branch_Code)         
    ) temp  '  
       
     print (@str1)     
             
     exec(@str1)   
           
  DROP TABLE BranchCount      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UPS_Not_Updated_Branch
-- --------------------------------------------------
CREATE Proc [dbo].[usp_UPS_Not_Updated_Branch]    
@fdate as varchar(12),    
@tdate as varchar(12)    
as    
    
    
   SET NOCOUNT ON     
Begin    
  Drop Table Temp1    
      
  Declare @UPSCase As Varchar(1000)    
  set @fdate = convert(varchar(11),convert(datetime,@fdate,103))          
  set @tdate = convert(varchar(11),convert(datetime,@tdate,103))     
      
  Set @UPSCase = ''      
     
         
  If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))       
   > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113))        
   And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))       
   < Convert(Datetime,Convert(Varchar(12),convert(datetime,'29 Apr 2049'),113)))      
  Begin      
   Set @UPSCase = '    
    --and Fld_Branch_Code Not IN (''196'',''36'',''120'',''114'',''116'',''8'')     
   And Fld_Upsid NOT IN (''2'',''4'',''6'',''68'',''20'',''28'',''41'',''36'',''61'',''46'',''45'',''31'','' 77'',''78'')'            
  End      
  Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))       
   > Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2007'),113))        
   And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))       
   > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))      
  Begin      
   Set @UPSCase = ''      
  End      
       
    
       
   Declare @Str varchar(Max)    
       
   Set @Str = '    
               Select Br_name, Fld_Branch_Code,Fld_Upsid,     
               br_Name+ ''-''+Fld_Brand_Name+''-''+Fld_Model_Capacity+ '' ''+Fld_Model_Srno as [ups_name]  ,Fld_Date    
         into Temp1    
         from    
         (     
         Select Fld_Branch_Code,Fld_Upsid,     
               Br_name , Fld_Brand_Name,Fld_Model_Capacity,Fld_Model_Srno,Fld_Date    
        From tbl_ups_count_details TC     
        left outer join   V_UPS_Master U on TC.Fld_Upsid = U.Fld_Ups_Id    
            
    Where     
    Fld_Date Between CONVERT (Datetime,'''+@fdate+''') And CONVERT(Datetime,'''+@tdate+''')     
    and U.Fld_App = ''U'' and U.Fld_Flag=''A''     
    --and  TC.Fld_Branch_Code = U.Fld_Branch_id     
      '+@UPSCase+'    
      )t    
    '    
    Print(@Str)    
        
    EXEC (@Str)    
        
     Select * into #Temp1 from Temp1    
        
  Declare @Query varchar(Max)    
      
  Set @Query = 'EXECUTE USP_Getalldates '''+@fdate+''' ,'''+@tdate+''''    
      
     PRINT (@QUERY)    
       
  Create table #Temp2 (AllDates Datetime)     
  INSERT INTO #Temp2     
     
  EXEC (@Query)    
    
  select distinct  c.br_name  as Br_Name,c.fld_upsid  , c.ups_name,convert(varchar(12) , c.AllDates,103) as alldates,  c.fld_branch_code,     
  0 as '08:445 AM', 0 as '02:00 PM' , 0 as '05:30 PM' ,0 as '10:00 PM', '' as person_name , 'Not Updated' as fld_remark ,    
  Day_Name=datename(weekday,alldates)    
     from     
  (    
   select * from (select *,fld=0 from #Temp2) a    
   inner join (select *,fd=0 from #Temp1) b on a.fld=b.fd    
   --where Fld_Branch_Code = 115 and Fld_Upsid = 15    
  ) c    
  where datename(weekday,c.alldates) <> 'SUNDAY'     
  and c.alldates not in     
  (    
   select Fld_Date from #Temp1     
   where c.Fld_Branch_Code = #temp1.Fld_Branch_Code    
   and c.Fld_Upsid = #temp1.Fld_Upsid    
  )  order by c.br_name     
End    
   --SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UPS_Not_Updated_Branch_test
-- --------------------------------------------------
--usp_UPS_Not_Updated_Branch_test '04/06/2012','06/06/2012'     
CREATE Proc [dbo].[usp_UPS_Not_Updated_Branch_test]    
@fdate as varchar(12),    
@tdate as varchar(12)    
as    
    
    
SET NOCOUNT ON     
Begin    
  Drop Table Temp1    
      
  Declare @UPSCase As Varchar(1000) 
  Declare @Sr_No As Varchar(1000)
  
  set @fdate = convert(varchar(11),convert(datetime,@fdate,103))         
  set @tdate = convert(varchar(11),convert(datetime,@tdate,103))     
      
      print @fdate
      print @tdate
      
  Set @UPSCase = '' 
  Set @Sr_No = ''     
     
         
  If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))       
   > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113))        
   And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))       
   < Convert(Datetime,Convert(Varchar(12),convert(datetime,'29 Apr 2049'),113)))      
  Begin      
   Set @UPSCase = 'And Fld_Upsid NOT IN (''2'',''4'',''6'',''68'',''20'',''28'',''41'',''36'',''61'',''46'',''45'',''31'','' 77'',''78'')'  
   Set @Sr_No = ' Sr_No Not IN (''196'',''36'',''120'',''114'',''116'',''8'')'          
  End      
  Else If(Convert(Datetime,Convert(Varchar(12),convert(datetime,@fdate),113))       
   > Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2007'),113))        
   And Convert(Datetime,Convert(Varchar(12),convert(datetime,@tdate),113))       
   > Convert(Datetime,Convert(Varchar(12),convert(datetime,'30 Apr 2011'),113)))      
  Begin      
   Set @UPSCase = ''   
   Set @Sr_No = ''   
  End      
       
   If(@fdate <> @tdate)
   Begin 
	       
	   Declare @Str varchar(Max)    
	       
	   Set @Str = 'Select '' %''+ Br_name + ''%'' as [Br_name] , Fld_Branch_Code,Fld_Upsid,     
				   br_Name+ ''-''+Fld_Brand_Name+''-''+Fld_Model_Capacity+ '' ''+Fld_Model_Srno as [ups_name]  ,Fld_Date    
					 into Temp1    
					 from    
					 (     
						 Select Fld_Branch_Code,Fld_Upsid,     
						   Br_name   , Fld_Brand_Name,Fld_Model_Capacity,Fld_Model_Srno,Fld_Date    
						From tbl_ups_count_details TC     
						left outer join   V_UPS_Master U on   
						-- TC.Fld_Branch_code = U.fld_branch_id
						TC.Fld_Upsid = U.Fld_Ups_Id    
						Where     
						Fld_Date Between CONVERT (Datetime,'''+@fdate+''') And CONVERT(Datetime,'''+@tdate+''')     
						and U.Fld_App = ''U'' and U.Fld_Flag=''A''     
						--and  TC.Fld_Branch_Code = U.Fld_Branch_id     
						  '+@UPSCase+'    
					  )t    
						'    
		Print(@Str)    
	        
		EXEC (@Str)    
	        
		 Select * into #Temp1 from Temp1    
	        
		Declare @Query varchar(Max)    
	      
		 Set @Query = 'EXECUTE USP_Getalldates '''+@fdate+''' ,'''+@tdate+''''    
	      
		 PRINT (@QUERY)    
	       
		 Create table #Temp2 (AllDates Datetime)     
		 INSERT INTO #Temp2     
	     
		 EXEC (@Query)    
	    
		  select distinct  c.br_name  as Branch,c.fld_upsid  , c.ups_name,convert(varchar(12) , c.AllDates,103) as alldates,  c.fld_branch_code,     
		  0 as '08:445 AM', 0 as '02:00 PM' , 0 as '05:30 PM' ,0 as '10:00 PM', '' as person_name , 'Not Updated' as fld_remark ,    
		  Day_Name=datename(weekday,alldates)    ,null as Branches
			 from     
		  (    
		   select * from (select *,fld=0 from #Temp2) a    
		   inner join (select *,fd=0 from #Temp1) b on a.fld=b.fd    
		   --where Fld_Branch_Code = 115 and Fld_Upsid = 15    
		  ) c    
		  where datename(weekday,c.alldates) <> 'SUNDAY'     
		  and c.alldates not in     
		  (    
		   select Fld_Date from #Temp1     
		   where c.Fld_Branch_Code = #temp1.Fld_Branch_Code    
		   and c.Fld_Upsid = #temp1.Fld_Upsid    
		  )  order by c.br_name

  End
  
  Else  If(@fdate = @tdate)
  Begin
   Declare @Str1 varchar(Max)    
       
   Set @Str1 = '  Select Distinct X.br_Name as Branch , 
					 fld_Ups_Id as [fld_upsid] ,   
					 X.br_Name+ ''-''+Fld_Brand_Name+''-''+Fld_Model_Capacity+ '' ''+Fld_Model_Srno as [ups_name],
					 CONVERT(varchar(12) , convert(datetime,'''+@fdate+''') , 103) as alldates , x.Sr_No as [fld_branch_code],
					 0 as ''08:445 AM'', 0 as ''02:00 PM'' , 0 as ''05:30 PM'' ,0 as ''10:00 PM'', '''' as person_name ,
				     ''Not Updated'' as fld_remark , null as Branches 
				 FROM V_UPS_Report x (nolock) , V_UPS_Master y  (nolock)    
				 Where  '+@Sr_No+' and  /*Br_type = ''+DATACENTER+'' and*/ not exists            
					   (Select fld_Branch_Code from tbl_ups_count_details y (nolock)        
						where Fld_Date      
						   between   CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@fdate+'''),113))      
						   and  CONVERT(Datetime,Convert(varchar(12),convert(datetime,'''+@tdate+'''),113))  
						   and x.sr_no = Fld_Branch_Code) and x.Sr_No = y.Fld_Branch_id'
						   
	Print(@Str1)    
        
    EXEC (@Str1) 					   
	
	    
  End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_UPS_Report
-- --------------------------------------------------
--declare @Date Varchar(15)='03/09/2016'  
  
  
  
CREATE PROCEDURE [dbo].[Usp_UPS_Report]                  
AS  
BEGIN  
DECLARE @EMP_NAME AS VARCHAR(100),@EMP_EMAIL AS VARCHAR(100)                  
DECLARE @EMAILTO AS VARCHAR(1000),@EMAILCC AS VARCHAR(1000),@EMAILBCC AS VARCHAR(1000),@SUB AS VARCHAR(MAX),@MESS NVARCHAR(MAX)    
  
  
  
SELECT @EMAILTO='sandeep.rai@angelbroking.com;PRASHANT.PATADE@ANGELBROKING.COM'  
  
DECLARE @filename1 as varchar(100)                              
                 
--select @filename1='d:\Ups_Report\UPS_Report'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                         
      
  
declare @Date varchar(19)=convert(varchar(19),getdate()-9,103)  
print @Date    
declare @BranchId int=0,@BrTag Varchar(15)='%%'    
                      
DECLARE @Fdate Varchar(15)                            
SET @Fdate = @Date                            
Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)      
                                                   
DECLARE @CSOName as Varchar(50)                                      
SELECT @CSOName = Fld_RegName FROM Tbl_RegionMaster_UPSWanlink WHERE Fld_RegCode = @BrTag                                                                                  
Begin                                      
 print 'Hello'                                 
SET NOCOUNT ON                              
                                        
CREATE TABLE #T(BRCODE INT,BRTAG VARCHAR(15),BRNAME VARCHAR(100))                                                  
  INSERT INTO #T                                                  
  EXEC USP_WAN_SEARCH_BRANCH @BRTAG            
                
   Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,              
   a.Fld_Branch_id,                
  g.CSONAME as CSOName, A.Remark_ups ,                    
 A.Agv_Daily_Load,                
 Case When A.Total_TestingTime =  '' Then '' Else A.Total_TestingTime END as Total_TestingTime,                
 A.Total_Load_InPer,                
 A.Remark,                                      
 Fld_Model_Capacity,Fld_Model_Name,a.Br_Name,              
 (a.Ups_Name + '-'+ CASE WHEN Fld_Model_Name is null THEN '-' ELSE Fld_Model_Name END + '-' + Fld_Model_Capacity) as UPS_Model,              
 e.Emp_Name  
 into #aa                    
  FROM         
  (SELECT k.*,h.ChangedBy as changed_by,h.Agv_Daily_Load,h.Total_TestingTime,h.Total_Load_InPer,h.Remark as Remark_ups   FROM V_UPS_MASTER(NOLOCK) k          
  right outer join tbl_ups_data h  on k.Fld_srNo = h.Fld_Ups_id and  Fld_Entry_date = Convert(datetime,@FDATE,103)            
  WHERE FLD_BRANCH_ID IN (SELECT BRCODE FROM #T) AND DeactivatedOn >= Convert(datetime,@FDATE,103)          
  and Fld_Entry_date = Convert(datetime,@FDATE,103)                  
  )A                                
  left outer join V_CSONAMES g on A.Fld_Branch_id = g.Sr_No                           
  left outer join intranet.risk.dbo.emp_info e  on A.changed_by = e.Emp_no                     
  ORDER BY CSOName   
     
             
End                                          
  truncate table tbl_UPS_Rpt_Temp  
  
  insert into tbl_UPS_Rpt_Temp(CSOName,Br_Name,UPS_Model,UpsCapacity,Agv_Daily_Load,Total_TestingTime,Total_Load_InPer,Remark,Emp_Name)  
  
 SELECT   'CSO','Location Name','UPS NAME MODEL NO CAPACITY','SERIAL NO NO OF BATTERIES','AVG.DAILY LOAD IN(%)','TOTAL TIME OF TESTING IN(MIN)','TOTAL LOAD (IN %)',  
             'REMARKS','TESTING DONE BY'  
    
  insert into tbl_UPS_Rpt_Temp(CSOName,Br_Name,UPS_Model,UpsCapacity,Agv_Daily_Load,Total_TestingTime,Total_Load_InPer,Remark,Emp_Name)  
 select CSOName,Br_Name,UPS_Model,UpsCapacity,Agv_Daily_Load,Total_TestingTime,Total_Load_InPer,Remark,Emp_Name  
 from #aa    
  
    
  DECLARE @BCPCOMMAND VARCHAR(250)   
  DECLARE @FILENAME VARCHAR(250)--@filename1 varchar(max)  
 declare @s1 as varchar(max)    
  --select @filename1='d:\Ups_Report\UPS_Report'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                         
  SET @FILENAME ='d:\upload1\UPS_Report'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'  
    SET @FILENAME1 ='\\196.1.115.167\d$\upload1\UPS_Report'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'  
  SET @BCPCOMMAND = 'BCP "SELECT CSOName,Br_Name,UPS_Model,UpsCapacity,Agv_Daily_Load,Total_TestingTime,Total_Load_InPer,Remark,Emp_Name FROM Helpdesk.dbo.tbl_UPS_Rpt_Temp " QUERYOUT "'          
  SET @BCPCOMMAND = @BCPCOMMAND + @FILENAME + '" -c -t, -Smis -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'          
    EXEC MASTER..XP_CMDSHELL @BCPCOMMAND   
     print @FILENAME  
    
  SET @MESS='DEAR ALL,<BR><BR>GOOD EVENING!!!<BR><BR>GREETINGS OF THE DAY!<BR>'  
  SET @MESS=@MESS+'<BR><BR>THIS IS A SYSTEM GENERATED MESSAGE. PLEASE DO NOT REPLY.<BR><BR>REGARDS,<BR><BR>(IT HELPDESK)'                                
  SET @SUB ='UPS Report AS ON ' + CONVERT(VARCHAR(MAX),GETDATE())  
               
 DECLARE @s varchar(500)                  
 SET @s = @FILENAME1   
  
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                
 @RECIPIENTS =@EMAILTO,                                
 @COPY_RECIPIENTS = @EMAILCC,                                
 @BLIND_COPY_RECIPIENTS=@EMAILBCC,                      
 @PROFILE_NAME = 'ANGELBROKING',                                
 @BODY_FORMAT ='HTML',                                
 @SUBJECT = @SUB ,   
 @FILE_ATTACHMENTS =@s,                               
 @BODY =@MESS   
    
  drop table #aa  
   drop table #t    
    
-- drop table #T     
   
   
   
            
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPS_weeklyNot_Update
-- --------------------------------------------------
CREATE PROC USP_UPS_WEEKLYNOT_UPDATE            
(            
 @DATE VARCHAR(15),            
 @BRANCHID INT,            
 @BRTAG VARCHAR(15)            
)            
AS            
set nocount on                
  --DECLARE @Fdate Varchar(15)            
  --SET @Fdate=@DATE                
  --IF @BRTAG ='All'            
  --BEGIN             
  --SET @BRTAG ='%%'            
  --END                        
BEGIN            
DECLARE @Fdate Varchar(15)                                
SET @Fdate = @DATE           
SET @DATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE,103),121)                      
   --CREATE TABLE #M            
   --(            
   -- SR_NO INT,            
   -- BR_TAG VARCHAR(20),            
   -- BR_NAME VARCHAR(50)            
   --)            
   --IF(@BRANCHID <> 0)            
   -- BEGIN            
   --INSERT INTO #M            
   --Select 0,'',''                      
   -- END                      
   --ELSE                      
   -- BEGIN                      
   --INSERT INTO #M                       
   --EXEC USP_WAN_SEARCH_BRANCH @BRTAG                        
   -- END                      
   --IF(@BRANCHID <> 0)                      
   -- BEGIN            
   --  SELECT DISTINCT S.* FROM V_UPS_MASTER(NOLOCK) S            
   --  WHERE FLD_BRANCH_ID = @BRANCHID AND FLD_TODATE <> @DATE            
   --  and Convert(Varchar(11),DeactivatedOn,103) >= @Fdate            
   -- END            
   --ELSE            
   -- BEGIN              
   --SELECT DISTINCT FLD_BRANCH_ID,a.Br_Name,g.CSONAME as CSOName --Fld_RegName as CSOName             
   --FROM V_UPS_MASTER  a            
   --   left outer join Tbl_IT_Br_Master e on a.Fld_Branch_id = e.Sr_No            
   ----left outer join tbl_region_master f on e.Br_Region =f.Fld_RegCode                 
   --left outer join V_CSONAMES g on e.br_tag = g.br_tag            
   --WHERE FLD_BRANCH_ID IN(SELECT SR_NO FROM #M) AND ISNULL(FLD_TODATE,0) <> @DATE            
   --and Convert(Varchar(11),DeactivatedOn,103) >= @Fdate            
   --union            
   --SELECT #M.sr_no,#M.Br_Name,g.CSONAME as CSOName --Fld_RegName as CSOName              
   --FROm #M            
   --   left outer join Tbl_IT_Br_Master e on #M.sr_no = e.Sr_No            
   ----left outer join tbl_region_master f on e.Br_Region =f.Fld_RegCode                 
   --left outer join V_CSONAMES g on e.br_tag = g.br_tag            
   --WHERE #M.SR_NO not in(SELECT DISTINCT FLD_BRANCH_ID  FROM V_UPS_MASTER            
   --WHERE FLD_BRANCH_ID IN(SELECT SR_NO FROM #M) AND ISNULL(FLD_TODATE,0) <> @DATE)            
   --and #M.SR_NO not in(SELECT DISTINCT FLD_BRANCH_ID  FROM V_UPS_MASTER            
   --WHERE FLD_BRANCH_ID IN(SELECT SR_NO FROM #M) AND ISNULL(FLD_TODATE,0) = @DATE)            
   -- END            
   --   drop table #M          
 SELECT distinct C.FLD_BRANCH_ID,D.BR_NAME ,D.CSONAME,D.BR_TAG,D.Br_Region  from tbl_ups_mapping_TEST C        
 LEFT OUTER JOIN V_CSONAMES D ON C.FLD_BRANCH_ID = D.sr_no        
 LEFT OUTER JOIN V_UPS_Master b on C.Fld_Ups_id = b.Fld_Ups_id     
 Where C.Fld_Branch_id not in (SELECT distinct Fld_Branch FROM tbl_ups_data        
 Where Fld_Entry_date = CONVERT(datetime ,@Fdate,103)) and D.Br_Status='A'      
 and C.Fld_Flag ='A'  and b.DeactivatedOn >= CONVERT(datetime ,@Fdate,103)
 Order by D.CSONAME 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPSLink_AutoMail
-- --------------------------------------------------
CREATE proc [dbo].[USP_UPSLink_AutoMail]      
as      
BEGIN      
 DECLARE @CNT INT=0      
 DECLARE @RowCnt INT=0      
 DECLARE @EMAIL AS VARCHAR(1000)=''      
 DECLARE @Region AS VARCHAR(100)=''      
 DECLARE @GroupID AS VARCHAR(100)=''      
 DECLARE @BODY1 VARCHAR(8000)=''      
 DECLARE @BODY2 VARCHAR(8000)=''      
 DECLARE @BODY3 VARCHAR(8000)=''      
 DECLARE @HTMLBODY VARCHAR(MAX)=''      
 DECLARE @HTML VARCHAR(MAX)=''      
 DECLARE @SUB VARCHAR(8000)=''      
 DECLARE @OUTPUT VARCHAR(1000)=''      
 DECLARE @GetDate DATETIME = DATEADD(DD, 3 , getdate())      
 --SELECT @GetDate      
 /***** For First Saturday of the Month *****/      
 --IF DATEPART(DAY, @GetDate) - DATEPART(DAY, DATEADD(DD, -DATEPART(DAY, @getdate)+1, @GetDate) + 7 - DATEPART(DW, DATEADD(DD, -DATEPART(DAY, @getdate)+1, @GetDate))) >= 0      
  --AND DATEPART(DW, @GetDate) <> 1      
---- Get First Saturday of month      
  DECLARE @YEAR INT      
  DECLARE @COUNT int      
  SELECT @YEAR = DATEPART(YEAR,GETDATE())      
      
  SELECT MIN(DATES) AS FIRST_SATURDAY into #T1 FROM      
  (SELECT DATEADD(DAY,NUMBER-1,DATEADD(YEAR,@YEAR-1900,0))      
  AS DATES  FROM MASTER..SPT_VALUES      
  WHERE TYPE='P' AND NUMBER BETWEEN 1 AND      
  DATEDIFF(DAY,DATEADD(YEAR,@YEAR-1900,0),DATEADD(YEAR,@YEAR-1900+1,0))      
  ) AS T WHERE DATENAME(WEEKDAY,DATES)='SATURDAY'      
  GROUP BY DATEADD(MONTH,DATEDIFF(MONTH,0,DATES),0)      
--------------End Here      
      
  SELECT @COUNT =COUNT(*) FROM #T1 Where Convert(varchar(15) ,FIRST_SATURDAY,105) =(SELECT Convert(varchar(15),GETDATE(),105))      
IF @COUNT = 0      
  BEGIN                  
   --SELECT Br_Tag,Sr_No,      
   --upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch ,      
   --EMAIL= CONVERT(VARCHAR(1000),'') ,GroupID=CONVERT(VARCHAR(1000),''),MAIL_SENT='N',Region=CONVERT(VARCHAR(1000),'')      
   --INTO #UPSLink_PENDING  FROM tbl_it_br_master (nolock)      
   --WHERE Br_Status='A'      
   --AND Sr_No NOT IN (SELECT DISTINCT Fld_Branch_id FROM V_UPS_Master  WITH (NOLOCK)      
   --WHERE Fld_ToDate BETWEEN Convert(Varchar(15),GETDATE(),105) and Convert(Varchar(15),DATEADD(DAY,-7,GETDATE()),105))      
   --ORDER BY Br_Name,Br_Tag      
 SELECT distinct D.Br_Name as BranchName ,D.Br_Tag,Sr_No,      
 upper(D.Br_Name)+'-('+upper(D.Br_tag)+')' as Branch ,      
 EMAIL= CONVERT(VARCHAR(1000),'') ,GroupID=CONVERT(VARCHAR(1000),''),MAIL_SENT='N',Region=CONVERT(VARCHAR(1000),'')      
 INTO     
 #UPSLink_PENDING      
 from tbl_ups_mapping_TEST C      
 LEFT OUTER JOIN V_CSONAMES D ON C.FLD_BRANCH_ID = D.sr_no      
 LEFT OUTER JOIN V_UPS_Master b on C.Fld_Ups_id = b.Fld_Ups_id      
 Where C.Fld_Branch_id not in (SELECT distinct Fld_Branch FROM tbl_ups_data      
 Where Convert(datetime,Fld_Entry_date,105)= CASE WHEN DateName(DW,getdate()) = 'Saturday' THEN     
 Convert(datetime,GETDATE(),105)      
 ELSE Convert(datetime,GETDATE()- 2,105) END)      
 --BETWEEN Convert(Varchar(15),GETDATE(),105) and Convert(Varchar(15),DATEADD(DAY,-7,GETDATE()),105))      
 and D.Br_Status='A' AND b.DeactivatedOn >= CASE WHEN DateName(DW,getdate()) = 'Saturday'     
 THEN Convert(datetime,GETDATE(),103)      
 ELSE Convert(datetime,GETDATE()- 2,103) END and C.Fld_Flag='A'      
 ORDER BY BranchName,Br_Tag      
               
   UPDATE #UPSLink_PENDING      
   SET EMAIL= IE_Employee_Email,      
   GroupID=IE_GroupID,      
   Region=IE_Region_name      
   From tbl_IT_Inventory_EmailID      
   WHERE #UPSLink_PENDING.Sr_No=tbl_IT_Inventory_EmailID.IE_Branch_SrNo      
 SELECT Distinct Br_Tag,Branch,EMAIL,GroupID,MAIL_SENT,Region      
   INTO #PENDING FROM #UPSLink_PENDING  GROUP BY GroupID,Br_Tag,Branch,EMAIL,MAIL_SENT,Region      
   ORDER BY Br_Tag      
   SELECT Br_Name  AS [Branches_Not_Updated],tbl_it_br_master.Br_Tag ,GroupID      
   INTO #Branches      
   FROM tbl_it_br_master,#UPSLink_PENDING      
   WHERE #UPSLink_PENDING.Br_Tag = tbl_it_br_master.Br_Tag      
   AND Br_Status='A'      
   SELECT @RowCnt=@@ROWCOUNT      
   SELECT @CNT=0      
   SELECT @CNT=COUNT(1) FROM #PENDING WITH (NOLOCK) WHERE MAIL_SENT = 'N' GROUP BY GroupID      
   WHILE @CNT > 0      
    BEGIN                          
     SELECT TOP 1 @EMAIL=EMAIL,@GroupID=GroupID,@Region=Region      
     FROM #PENDING WITH (NOLOCK)      
     WHERE MAIL_SENT = 'N'                                
     SELECT @OUTPUT='Select [Branches_Not_Updated],Br_Tag  from #Branches where GroupID='      
     +''''+@GroupID+''''      
     EXEC [DBA_ConvertQueryInHTMP_Page] @OUTPUT, @HTMLBODY OUTPUT      
     SELECT @BODY1 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;">      
     Dear IT Team,<BR/><BR/>This is to remind you for updating UPS Link Report of this week.<BR/><BR/>                            
     <b><font color=#ff6666>Kindly note that the cut off timing for updating UPS Link Report is 3:00 P.M. every Saturday.<BR/><BR/></font></b>     </td></tr></table>'      
     SELECT @BODY2 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;">      
     <BR/>Best Regards,<BR/><BR/><b>IT Branch Support Team</b><BR/>Angel Broking Ltd<BR/>Central Support Office <BR/>Tel no: 022-28358800(Ext: 404/405/406)      
     </td></tr></table>'      
     SELECT @HTML = @BODY1+@HTMLBODY+@BODY2      
  SELECT @SUB='Reminder for UPS Link Report - '+@Region+''      
     EXEC MSDB.dbo.SP_SEND_DBMAIL      
     @profile_name = 'ITHelpdesk',      
     @recipients =@EMAIL,                
     @copy_recipients = 'IThelpdeskakruti@angelbroking.com;VinodC@angelbroking.com',      
     --@blind_copy_recipients = 'harshalrose4@gmail.com',         
     @subject = @SUB,      
     @body = @HTML,      
     @body_format = 'HTML'      
     UPDATE #PENDING SET MAIL_SENT = 'Y' WHERE EMAIL=@EMAIL      
     SELECT @CNT=COUNT(1) FROM #PENDING WITH (NOLOCK) WHERE MAIL_SENT = 'N'      
     END      
   DROP TABLE #UPSLink_PENDING      
   DROP TABLE #PENDING      
   DROP TABLE #Branches      
   DROP TABLE #T1      
 END      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_User_Inbox
-- --------------------------------------------------
Create Proc USP_User_Inbox
(@Fld_EmpCode as varchar(10)) as
select x.* from
(select * from intranet.outlook.dbo.V_Inbox_Mails) x
inner join
(select * from tbl_request_master_mapping (nolock)) y 
on x.Fld_SrNo = y.Fld_SrNo and y.Fld_EmpCode = @Fld_EmpCode

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_UserCompleted_HelpDeskOpration
-- --------------------------------------------------
CREATE PROC usp_UserCompleted_HelpDeskOpration                                      
(                                      
@dept_id varchar(10),                                                        
@complaint AS VARCHAR(2000),                                                          
@attachment AS VARCHAR(70),                                      
@status AS VARCHAR(20),                                      
@Fld_EntryBy AS VARCHAR(50),                                
@complaintNo as varchar(100),              
@subject as varchar(10),          
@querytype as varchar(10),        
@solutionby as varchar(15),      
@Access_code as varchar(15)                                                                                                
)                  
AS   
  
declare @compabt as int
declare @clt_subdetl as varchar(15)
set @compabt =(select top 1 compl_abt from tbl_complaint where complaint_id=@complaintNo order by sr_num)
set @clt_subdetl =(select top 1 clt_subdetl from tbl_complaint where complaint_id=@complaintNo order by sr_num)


INSERT INTO tbl_complaint                                       
  (                                      
  Dept_ID,      
  Complaint_ID,      
  Query_Type,      
  Subject,                                      
  Complaint,                                      
  Solution,                                            
  Access_code,                                      
  Solution_By,                                      
  Complaint_Date,                                      
  Solution_Date,                                      
  Attachment,                                      
  Status,                                      
  Fld_EntryBy,                                      
  cso_attch,                                      
  fld_hold_Reason,                                      
  compl_abt,                                      
  clt_subdetl                                      
  )                                      
  VALUES                                      
(                                      
@dept_id,                                      
@Complaintno,                                      
@querytype,                                    
@subject,                                      
@complaint,                                      
'',                                      
ltrim(rtrim(@Access_code)),                                       
@solutionby,                                      
getdate(),                                      
getdate(),                                      
@attachment,                                      
@status,                                      
@Fld_EntryBy,                                      
'',                                      
'',                                      
@compabt,                                      
@clt_subdetl                                      
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Userstatus_count
-- --------------------------------------------------
CREATE proc usp_Userstatus_count(@username  varchar(10))             
as            
select sr_num=max(sr_num),complaint_id into #t1      
 from tbl_complaint where  fld_EntryBy=@username and       
complaint_date >=convert(datetime,convert(varchar,GETDATE()-1,103),103) AND       
complaint_date <=convert(datetime,convert(varchar,GETDATE(),103),103)+' 23:59:59.989'       
group by complaint_id      
      
select Total=count(*) from tbl_complaint  where     
 sr_num in (select sr_num from #t1) and status like '%%'      
      
select HOLD=count(*)  from tbl_complaint  where     
 sr_num in (select sr_num from #t1) and status='H'      
      
select Pending=count(*)  from tbl_complaint where     
sr_num in  (select sr_num from #t1) and status='P'      
      
select InProcess=count(*)  from tbl_complaint where     
 sr_num in (select sr_num from #t1)and status in('IP','F')  

select Completed=count(*)  from tbl_complaint where    
 sr_num in (select sr_num from #t1) and status='BC'
 
select CsoCompleted=count(*)  from tbl_complaint where     
sr_num in (select sr_num from #t1)and status ='C'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Userstatus_count1
-- --------------------------------------------------
CREATE proc usp_Userstatus_count1(@username  varchar(10),@fdate varchar(11), @tdate varchar(11))         
as        
select sr_num=max(sr_num),complaint_id into #t1  
 from tbl_complaint (nolock) where  fld_EntryBy=@username and   
complaint_date >=convert(datetime,@fdate,103) AND   
complaint_date <=convert(datetime,@tdate,103)+' 23:59:59.989'   
group by complaint_id  
  
select Total=count(*) from tbl_complaint  where fld_EntryBy=@username and   
complaint_date >=convert(datetime,@fdate,103) AND   
complaint_date <=convert(datetime,@tdate,103)+' 23:59:59.989'   
and sr_num in (select sr_num from #t1) and status like '%%'  
  
select HOLD=count(*)  from tbl_complaint  where fld_EntryBy=@username and   
complaint_date >=convert(datetime,@fdate,103) AND   
complaint_date <=convert(datetime,@tdate,103)+' 23:59:59.989'   
and sr_num in (select sr_num from #t1) and status='H'  
  
select Pending=count(*)  from tbl_complaint where fld_EntryBy=@username and   
complaint_date >=convert(datetime,@fdate,103) AND   
complaint_date <=convert(datetime,@tdate,103)+' 23:59:59.989'   
and sr_num in  (select sr_num from #t1)   
and status='P'  
  
select InProcess=count(*)  from tbl_complaint where fld_EntryBy=@username and   
 complaint_date >=convert(datetime,@fdate,103) AND   
complaint_date <=convert(datetime,@tdate,103)+' 23:59:59.989'   
 and sr_num in (select sr_num from #t1)   
and status in('IP','F','C')  
  
select Completed=count(*)  from tbl_complaint where fld_EntryBy=@username and   
complaint_date >=convert(datetime,@fdate,103) AND   
complaint_date <=convert(datetime,@tdate,103)+' 23:59:59.989'   
 and sr_num in (select sr_num from #t1) and status='BC'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_userstatus_display
-- --------------------------------------------------


CREATE proc usp_userstatus_display(@username  varchar(10),@status varchar(10),@fdate varchar(11),@tdate varchar(11))                 
as             
          
create table #ts(sr_num int,complaint_id varchar(15))            
            
if @fdate='' and @tdate=''      
begin            
insert into #ts            
select sr_num=max(sr_num),complaint_id                  
 from tbl_complaint where fld_entryby=@username    
group by complaint_id                
end             
else            
    
begin            
insert into #ts            
select sr_num=max(sr_num),complaint_id                 
 from tbl_complaint where fld_entryby=@username         
and Complaint_Date >= convert(datetime,@fdate,103) and Complaint_Date <= convert(datetime,@tdate,103)+' 23:59:59.989'               
group by complaint_id             
end            
            
if @status='%%'            
begin                 
select * from v_user_inbox  where   sr_num in                
(select sr_num from #ts) and Status like '%%'            
end                
            
if @status='H'            
begin                
select *  from v_user_inbox  where  sr_num in                
(select sr_num from #ts) and Status='Hold'                
end            
            
if @status='p'            
begin                
select *  from v_user_inbox where  sr_num in                
(select sr_num from #ts) and Status='Pending'                
end            
            
if @status='IP'            
begin                
select *  from v_user_inbox  where  sr_num in                
(select sr_num from #ts) and Status in('In Process','Forwarded')                
end            
  
          
  
if @status='BC'            
begin              
select *  from v_user_inbox  where  sr_num in                
(select sr_num from #ts) and Status='Completed'            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_v_TCP_Servers_new
-- --------------------------------------------------
CREATE proc [dbo].[usp_v_TCP_Servers_new]                  
(                  
@date as datetime                  
)                                                      
as                                                      
                                      
declare @str as varchar(3000)                                       
declare @case as varchar(1000)                       
Declare @ServerCase As Varchar(1000)       
--,@sql varchar(100)                          
-- declare @date as varchar(11)                      
--set @date='07/25/2010'            
/*      
set @sql='select '''+convert(varchar,convert(datetime,@date,103))+''''      
print @sql      
*/      
      
                              
 If convert(datetime,@date,103)>'2009-02-25 00:00:00.000' and convert(datetime,@date,103)<'2009-10-08 00:00:00.000'                                         
  Set @case='and x.Fld_Branch_cd not in(''CMBTR'',''KNPR'')'                       
 Else if convert(datetime,@date,103)<='2009-02-25 00:00:00.000'                              
  Set @case=''                               
 Else                                              
  Set @case='and x.Fld_Branch_cd not in(''CMBTR'',''KNPR'',''NAGPR'')'                                    
                               
 Set @ServerCase = ''                    
                    
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))                      
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'21 Feb 2011'),113)) )                    
 Begin                    
  Set @ServerCase = @ServerCase +  ' And FLD_SBS_NAME NOT IN (''MIS (22)'',''MIS (102)'')'                    
   End                    
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))                      
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'17 Feb 2011'),113)) )                    
 Begin                    
  Set @ServerCase = @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (26)'')'                  
                    
 End  
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))  
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'14 Mar 2011'),113)) )  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (27)'')'                   
 End                    
If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'10 July 2009'),113)))  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (15)'',''SBS (20)'')'                  
 End  
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'03 Nov 2011'),113)))  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (84)'')'  
 End  
--If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
 -- = Convert(Datetime,Convert(Varchar(12),convert(datetime,'18 June 2011'),113)) )  
 ---and Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
 ------ --<= Convert(Datetime,Convert(Varchar(12),convert(datetime,GETDATE()),113)) )  
 --Begin  
 -- Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (15)'',''SBS (20)'')'  
 --End              
SET @str =  
 ' SELECT  
  ''A'' as S,                    
  ''A'' + convert(varchar,Fld_id) as Fld_id,                    
  Fld_id as server_id,                     
  Fld_Server,         
  Fld_Branch_cd,                                    
  upper(Br_Name) as Br_Name,                    
  '''' as SBS_IP,                    
  '''' as Remark                     
 From V_Server_Master x (nolock)                     
 Where fld_server not in (''SBS (95)'',''SBS (108)'',''SBS (112)'')                     
  And exists                          
  (select * from V_Tbl_Manager_Master y (nolock) where x.Fld_id = y.Fld_id             
  --and y.status = ''Active''            
   and x.Fld_id in(select distinct(fld_id) from V_Server_manager_Branch_ITdetails_forTcp   WHERE Fld_To_Date >'''+ convert(varchar,convert(datetime,@date,105)) + '''      
   )            
  )                                    
    ' + @case + '                                                   
  union all                                                      
  select ''AS'' as S,''AS'' + convert(varchar,Fld_SBS_id),Fld_SBS_id,Fld_SBS_Name,Br_Tag,br_Name,                    
   Fld_Sbs_ip, Fld_Remark                     
  From V_SBS_Master(nolock)                     
  Where Fld_SBS_NAME not in (''SBS (95)'',''SBS (108)'',''SBS (112)'',''MIS (22)'',''SBS (26)'',''SBS (27)'',''MIS (95)'',''SBS (117)'',''SBS (118)'')                     
   ' + @ServerCase + '                    
 '                                 
      
PRINT (@str)                  
EXEC(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_v_TCP_Servers_new_17Jul2014
-- --------------------------------------------------
Create proc [dbo].[usp_v_TCP_Servers_new_17Jul2014]                  
(                  
@date as datetime                  
)                                                      
as                                                      
                                      
declare @str as varchar(3000)                                       
declare @case as varchar(1000)                       
Declare @ServerCase As Varchar(1000)       
--,@sql varchar(100)                          
-- declare @date as varchar(11)                      
--set @date='07/25/2010'            
/*      
set @sql='select '''+convert(varchar,convert(datetime,@date,103))+''''      
print @sql      
*/      
      
                              
 If convert(datetime,@date,103)>'2009-02-25 00:00:00.000' and convert(datetime,@date,103)<'2009-10-08 00:00:00.000'                                         
  Set @case='and x.Fld_Branch_cd not in(''CMBTR'',''KNPR'')'                       
 Else if convert(datetime,@date,103)<='2009-02-25 00:00:00.000'                              
  Set @case=''                               
 Else                                              
  Set @case='and x.Fld_Branch_cd not in(''CMBTR'',''KNPR'',''NAGPR'')'                                    
                               
 Set @ServerCase = ''                    
                    
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))                      
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'21 Feb 2011'),113)) )                    
 Begin                    
  Set @ServerCase = @ServerCase +  ' And FLD_SBS_NAME NOT IN (''MIS (22)'',''MIS (102)'')'                    
   End                    
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))                      
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'17 Feb 2011'),113)) )                    
 Begin                    
  Set @ServerCase = @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (26)'')'                  
                    
 End  
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))  
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'14 Mar 2011'),113)) )  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (27)'')'                   
 End                    
If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'10 July 2009'),113)))  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (15)'',''SBS (20)'')'                  
 End  
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'03 Nov 2011'),113)))  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (84)'')'  
 End  
--If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
 -- = Convert(Datetime,Convert(Varchar(12),convert(datetime,'18 June 2011'),113)) )  
 ---and Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
 ------ --<= Convert(Datetime,Convert(Varchar(12),convert(datetime,GETDATE()),113)) )  
 --Begin  
 -- Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (15)'',''SBS (20)'')'  
 --End              
SET @str =  
 ' SELECT  
  ''A'' as S,                    
  ''A'' + convert(varchar,Fld_id) as Fld_id,                    
  Fld_id as server_id,                     
  Fld_Server,         
  Fld_Branch_cd,                                    
  upper(Br_Name) as Br_Name,                    
  '''' as SBS_IP,                    
  '''' as Remark                     
 From V_Server_Master x (nolock)                     
 Where fld_server not in (''SBS (95)'',''SBS (108)'',''SBS (112)'')                     
  And exists                          
  (select * from V_Tbl_Manager_Master y (nolock) where x.Fld_id = y.Fld_id             
  --and y.status = ''Active''            
   and x.Fld_id in(select distinct(fld_id) from V_Server_manager_Branch_ITdetails_forTcp   WHERE Fld_To_Date >'''+ convert(varchar,convert(datetime,@date,105)) + '''      
   )            
  )                                    
    ' + @case + '                                                   
  union all                                                      
  select ''AS'' as S,''AS'' + convert(varchar,Fld_SBS_id),Fld_SBS_id,Fld_SBS_Name,Br_Tag,br_Name,                    
   Fld_Sbs_ip, Fld_Remark                     
  From V_SBS_Master(nolock)                     
  Where Fld_SBS_NAME not in (''SBS (95)'',''SBS (108)'',''SBS (112)'',''MIS (22)'',''SBS (26)'',''SBS (27)'')                     
   ' + @ServerCase + '                    
 '                                 
      
PRINT (@str)                  
EXEC(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_v_TCP_Servers_new_27Oct2014
-- --------------------------------------------------
Create proc [dbo].[usp_v_TCP_Servers_new_27Oct2014]                  
(                  
@date as datetime                  
)                                                      
as                                                      
                                      
declare @str as varchar(3000)                                       
declare @case as varchar(1000)                       
Declare @ServerCase As Varchar(1000)       
--,@sql varchar(100)                          
-- declare @date as varchar(11)                      
--set @date='07/25/2010'            
/*      
set @sql='select '''+convert(varchar,convert(datetime,@date,103))+''''      
print @sql      
*/      
      
                              
 If convert(datetime,@date,103)>'2009-02-25 00:00:00.000' and convert(datetime,@date,103)<'2009-10-08 00:00:00.000'                                         
  Set @case='and x.Fld_Branch_cd not in(''CMBTR'',''KNPR'')'                       
 Else if convert(datetime,@date,103)<='2009-02-25 00:00:00.000'                              
  Set @case=''                               
 Else                                              
  Set @case='and x.Fld_Branch_cd not in(''CMBTR'',''KNPR'',''NAGPR'')'                                    
                               
 Set @ServerCase = ''                    
                    
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))                      
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'21 Feb 2011'),113)) )                    
 Begin                    
  Set @ServerCase = @ServerCase +  ' And FLD_SBS_NAME NOT IN (''MIS (22)'',''MIS (102)'')'                    
   End                    
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))                      
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))                     
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'17 Feb 2011'),113)) )                    
 Begin                    
  Set @ServerCase = @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (26)'')'                  
                    
 End  
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  < Convert(Datetime,Convert(Varchar(12),convert(datetime,'1 Jan 2006'),113))  
  OR Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'14 Mar 2011'),113)) )  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (27)'')'                   
 End                    
If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'10 July 2009'),113)))  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (15)'',''SBS (20)'')'                  
 End  
 If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
  > Convert(Datetime,Convert(Varchar(12),convert(datetime,'03 Nov 2011'),113)))  
 Begin  
  Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (84)'')'  
 End  
--If( Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
 -- = Convert(Datetime,Convert(Varchar(12),convert(datetime,'18 June 2011'),113)) )  
 ---and Convert(Datetime,Convert(Varchar(12),convert(datetime,@date),113))  
 ------ --<= Convert(Datetime,Convert(Varchar(12),convert(datetime,GETDATE()),113)) )  
 --Begin  
 -- Set @ServerCase =  @ServerCase + ' And FLD_SBS_NAME NOT IN (''SBS (15)'',''SBS (20)'')'  
 --End              
SET @str =  
 ' SELECT  
  ''A'' as S,                    
  ''A'' + convert(varchar,Fld_id) as Fld_id,                    
  Fld_id as server_id,                     
  Fld_Server,         
  Fld_Branch_cd,                                    
  upper(Br_Name) as Br_Name,                    
  '''' as SBS_IP,                    
  '''' as Remark                     
 From V_Server_Master x (nolock)                     
 Where fld_server not in (''SBS (95)'',''SBS (108)'',''SBS (112)'')                     
  And exists                          
  (select * from V_Tbl_Manager_Master y (nolock) where x.Fld_id = y.Fld_id             
  --and y.status = ''Active''            
   and x.Fld_id in(select distinct(fld_id) from V_Server_manager_Branch_ITdetails_forTcp   WHERE Fld_To_Date >'''+ convert(varchar,convert(datetime,@date,105)) + '''      
   )            
  )                                    
    ' + @case + '                                                   
  union all                                                      
  select ''AS'' as S,''AS'' + convert(varchar,Fld_SBS_id),Fld_SBS_id,Fld_SBS_Name,Br_Tag,br_Name,                    
   Fld_Sbs_ip, Fld_Remark                     
  From V_SBS_Master(nolock)                     
  Where Fld_SBS_NAME not in (''SBS (95)'',''SBS (108)'',''SBS (112)'',''MIS (22)'',''SBS (26)'',''SBS (27)'',''MIS (95)'',''SBS (117)'',''SBS (118)'')                     
   ' + @ServerCase + '                    
 '                                 
      
PRINT (@str)                  
EXEC(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_vinay
-- --------------------------------------------------
CREATE proc usp_vinay  
as   
select fld_srno,fld_productmodel from tbl_itassetsdata(nolock)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Vsat
-- --------------------------------------------------
CREATE Proc Usp_Vsat(@category as varchar(15),@code as varchar(20))  
as  
set nocount on  
  
select Sr_no,Dept_NO,Category,isnull(Cat_item_Id,' ') Cat_item_Id ,isnull(Cat_PCIP,' ') Cat_PCIP,  
isnull(Cat_Email,' ') Cat_Email,Cat_Phone,isnull(Cat_city,' ') Cat_city,isnull(Cat_Type,' ') Cat_Type,  
isnull(CAt_Address,' ') CAt_Address,Cat_ContPerson from v_sat_mast1 where category = @category and   
dept_no = 'IT' and cat_item_id like @code+'%' or cat_pcip like @code+'%'   
  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Wan_Branch_Report
-- --------------------------------------------------
CREATE Proc Usp_Wan_Branch_Report(@fld_branch varchar(20),@Fld_CSO varchar(15),@fdate as varchar(11)      
)                        
as           
    
create table #t    
(    
Sr_No int,    
Br_tag varchar(150),    
Br_Name varchar(500)    
)                 
    
if @fld_branch = 'All'    
    
begin    
 insert into #t    
 exec USP_WAN_Search_Branch @Fld_CSO    
end    
else    
begin    
 insert into #t    
 select @fld_branch,'',''    
end    
    
            
select * from V_WAN_RPT (nolock) where Fetch_date = @fdate and Fld_Branch in (select Sr_No from #t) order by Br_name,Fld_Id

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_Search_Branch
-- --------------------------------------------------
CREATE proc [dbo].[USP_WAN_Search_Branch](@access_code as varchar(15))                                    
as                                     
                 
                 
If @access_code = 'CSO'                                      
begin                             
                                    
select * from                                    
(                                    
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = @access_code                                    
union                                    
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Region =@access_code                                    
union                             
select 0,'CSO','CSO-(CSO)'        
) x order by Br_Name                                           
end                            
                
Else                
begin                                     
select * from                                    
(                                    
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Tag like @access_code 
or Reg_Code like @access_code 
and Br_Status='A' )                                   
union                                    
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Region like @access_code or Reg_Code like @access_code and Br_Status='A')                                  
union                
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where brmast_cd like @access_code and Br_Status='A'                  
union                
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag ,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code and Br_Status='A')          
union        
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = CASE WHEN @access_code ='HO' then 'AKSTR' ELSE '' END and Br_Status='A'     
--union    
--select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = CASE WHEN @access_code ='KNPR' then 'KNPSK' ELSE '' END and Br_Status='A'        
) x order by Br_Name                                                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_Search_Branch_bkup
-- --------------------------------------------------
--USP_WAN_Search_Branch 'YA3'
CREATE proc [dbo].[USP_WAN_Search_Branch_bkup](@access_code as varchar(15))                    
as                     
            
If @access_code = 'CSO'                      
begin             
                    
select * from                    
(                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = @access_code                    
union                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Region =@access_code                    
union             
select 0,'CSO','CSO-(CSO)'          
) x order by Br_Name                           
end            

Else
begin                     
select * from                    
(                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Tag like @access_code or Reg_Code like @access_code  )                   
union                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Region like @access_code or Reg_Code like @access_code)                  
union
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where brmast_cd like @access_code  
----union
----select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)
----where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code)                     
) x order by Br_Name                                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_Search_Branch_FOR_INVENTORY
-- --------------------------------------------------
CREATE proc [dbo].[USP_WAN_Search_Branch_FOR_INVENTORY](@access_code as varchar(15))                                    
as                                     
                 
                 
If @access_code = 'CSO'                                      
begin                             
                                    
select * from                                    
(                                    
/*select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = @access_code                                    
union */                                   
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)  where Br_Region ='cso'                                   
union
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)  where Br_Region ='NASIK'                                   
union
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)  where Br_Region ='luck'                                     
union                              
select 0,'CSO','CSO-(CSO)'        
) x order by Br_Name                                           
end                            
                
Else                
begin                                     
select * from                                    
(                                    
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) 
where (Br_Tag like @access_code 
or Reg_Code like @access_code 
and Br_Status='A' AND Br_Region='CSO')                                   
/*
union                                    
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name 
from V_tbl_it_br_master (nolock) 
where (Br_Region like @access_code or Reg_Code like @access_code and Br_Status='A')
*/ 
                                
union                
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name 
from V_tbl_it_br_master (nolock) 
where brmast_cd like @access_code and Br_Status='A' AND Br_Region='CSO'  
  
union

select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) 
where (Br_Tag like (CASE WHEN @ACCESS_CODE='NASIK_1' THEN 'NASIK' ELSE @ACCESS_CODE END) 
or Reg_Code like (CASE WHEN @ACCESS_CODE='NASIK_1' THEN 'NASIK' ELSE @ACCESS_CODE END) 
and Br_Status='A' AND Br_Region='CSO') 
/*               
union                
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag ,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name 
from V_tbl_it_br_master (nolock) 
where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code and Br_Status='A') 
*/         
union        
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = CASE WHEN @access_code ='HO' then 'AKSTR' ELSE '' END and Br_Status='A'     
--union    
--select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = CASE WHEN @access_code ='KNPR' then 'KNPSK' ELSE '' END and Br_Status='A'        
) x order by Br_Name                                                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_Search_Branch_FOR_INVENTORY_BKP08Jun2016
-- --------------------------------------------------
create proc [dbo].[USP_WAN_Search_Branch_FOR_INVENTORY_BKP08Jun2016](@access_code as varchar(15))                                    
as                                     
                 
                 
If @access_code = 'CSO'                                      
begin                             
                                    
select * from                                    
(                                    
/*select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = @access_code                                    
union */                                   
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)  where Br_Region ='cso'                                   
union
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)  where Br_Region ='NASIK'                                   
union
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)  where Br_Region ='luck'                                     
union                              
select 0,'CSO','CSO-(CSO)'        
) x order by Br_Name                                           
end                            
                
Else                
begin                                     
select * from                                    
(                                    
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Tag like @access_code 
or Reg_Code like @access_code 
and Br_Status='A' )                                   
union                                    
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Region like @access_code or Reg_Code like @access_code and Br_Status='A')                                  
union                
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where brmast_cd like @access_code and Br_Status='A'                  
union                
select Sr_No,rtrim(ltrim(Br_tag))as Br_tag ,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code and Br_Status='A')          
union        
select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = CASE WHEN @access_code ='HO' then 'AKSTR' ELSE '' END and Br_Status='A'     
--union    
--select Sr_No,rtrim(ltrim(Br_tag)) as Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = CASE WHEN @access_code ='KNPR' then 'KNPSK' ELSE '' END and Br_Status='A'        
) x order by Br_Name                                                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_Search_Branch_ITStaff
-- --------------------------------------------------
--USP_WAN_Search_Branch_ITStaff 'BNg_3'
--select * from V_tbl_it_br_master_IT_Staff
CREATE proc [dbo].[USP_WAN_Search_Branch_ITStaff](@access_code as varchar(15))                    
as                     
            
If @access_code = 'CSO'                      
begin             
                    
select * from                    
(                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master_IT_Staff (nolock) where Br_Tag = @access_code                    
union                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master_IT_Staff (nolock) where Br_Region =@access_code                    
union             
select 0,'CSO','CSO-(CSO)'          
) x order by Br_Name                           
end            

Else
begin                     
select * from                    
(                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master_IT_Staff (nolock) where (Br_Tag like @access_code or Reg_Code like @access_code  )                   
union                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master_IT_Staff (nolock) where (Br_Region like @access_code or Reg_Code like @access_code)                  
union
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master_IT_Staff (nolock) where brmast_cd like @access_code  
union
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master_IT_Staff (nolock)
where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code)                     
) x order by Br_Name                                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_Search_Branch_new
-- --------------------------------------------------
--USP_WAN_Search_Branch 'BNg_3'
Create proc [dbo].[USP_WAN_Search_Branch_new](@access_code as varchar(15))                    
as                     
            
If @access_code = 'CSO'                      
begin             
                    
select * from                    
(                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = @access_code                    
union                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Region =@access_code                    
union             
select 0,'CSO','CSO-(CSO)'          
) x order by Br_Name                           
end            

Else
begin                     
select * from                    
(                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Tag like @access_code or Reg_Code like @access_code  )                   
union                    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Region like @access_code or Reg_Code like @access_code)                  
union
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where brmast_cd like @access_code  
union
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)
where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code)                     
) x order by Br_Name                                 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_Search_Branch_test
-- --------------------------------------------------





CREATE proc [dbo].[USP_WAN_Search_Branch_test](@access_code as varchar(15))                        
as                         
                
If @access_code = 'CSO'                          
begin                 
                        
select Sr_No from                        
(                        
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Tag = @access_code                        
union                        
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where Br_Region =@access_code                        
union                 
select 0,'CSO','CSO-(CSO)'              
) x order by Br_Name                               
end                
    
Else    
begin                         
select Sr_No from                        
(                        
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Tag like @access_code or Reg_Code like @access_code and Br_Status='A' )                       
union                        
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Region like @access_code or Reg_Code like @access_code and Br_Status='A')                      
union    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where brmast_cd like @access_code and Br_Status='A'      
union    
select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)    
where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @access_code and Br_Status='A')                         
) x order by Br_Name                                     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WAN_WEEKLYNOT_UPDATE
-- --------------------------------------------------



  
    
    
CREATE PROC USP_WAN_WEEKLYNOT_UPDATE    
(    
 @DATE VARCHAR(15),    
 @BRANCHID INT,    
 @BRTAG VARCHAR(15)    
)    
AS    
    --- commented by harshal at 8 May 2013    
     --SET NOCOUNT ON    
     --IF @BRTAG ='ALL'    
     --BEGIN    
     --SET @BRTAG ='%%'    
     --END    
BEGIN    
     --CREATE TABLE #M    
     --(    
     -- SR_NO INT,    
     -- BR_TAG VARCHAR(20),    
     -- BR_NAME VARCHAR(50)    
     --)    
 SET @DATE =  CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE,103),121)    
     --IF(@BRANCHID <> 0)    
     --  BEGIN    
     -- INSERT INTO #M    
     -- SELECT 0,'',''    
     --  END    
     --ELSE    
     --  BEGIN    
     --  INSERT INTO #M    
     --  EXEC USP_WAN_SEARCH_BRANCH @BRTAG    
     --  END    
     --IF(@BRANCHID <> 0)    
     --BEGIN    
     -- SELECT DISTINCT S.* FROM V_WAN_NOTUPDATED(NOLOCK) S    
     -- WHERE FLD_BRANCH = @BRANCHID AND FLD_DOST <> @DATE    
     --END    
     --ELSE    
     --BEGIN    
     -- SELECT DISTINCT A.FLD_BRANCH,E.BR_NAME,FLD_REGNAME AS CSONAME,E.BR_TAG,E.Br_Region FROM V_WAN_NOTUPDATED  A    
     -- LEFT OUTER JOIN TBL_IT_BR_MASTER E ON A.FLD_BRANCH = E.SR_NO    
     -- LEFT OUTER JOIN TBL_REGIONMASTER_UPSWANLINK F ON E.BR_TAG =F.FLD_REGCODE    
     -- WHERE FLD_BRANCH IN(SELECT SR_NO FROM #M) AND ISNULL(FLD_DOST,0) <> @DATE    
     -- UNION    
     -- SELECT #M.SR_NO,#M.BR_NAME,FLD_REGNAME AS CSONAME,E.BR_TAG ,E.Br_Region FROM #M    
     -- LEFT OUTER JOIN TBL_IT_BR_MASTER E ON #M.SR_NO = E.SR_NO    
     -- LEFT OUTER JOIN TBL_REGIONMASTER_UPSWANLINK F ON E.BR_TAG  =F.FLD_REGCODE    
     -- WHERE #M.SR_NO NOT IN(SELECT DISTINCT FLD_BRANCH  FROM V_WAN_NOTUPDATED    
     -- WHERE FLD_BRANCH IN(SELECT SR_NO FROM #M) AND ISNULL(FLD_DOST,0) <> @DATE)    
     -- AND #M.SR_NO NOT IN(SELECT DISTINCT FLD_BRANCH  FROM V_WAN_NOTUPDATED    
     -- WHERE FLD_BRANCH IN(SELECT SR_NO FROM #M) AND ISNULL(FLD_DOST,0) = @DATE)    
     --END    
     -- DROP TABLE #M    
        
 SELECT DISTINCT C.FLD_BRANCH,D.BR_NAME ,D.CSONAME,D.BR_TAG,D.Br_Region FROM TBL_IT_WANLINK_DATA C    
 LEFT OUTER JOIN V_CSONAMES D ON C.fld_branch = D.sr_no    
 Where fld_branch not in(SELECT DISTINCT B.FLD_BRANCH FROM TBL_IT_WANLINK_UPDATE_DATA A    
 LEFT OUTER JOIN TBL_IT_WANLINK_DATA B ON B.FLD_ID =A.FLD_ID    
 WHERE FLD_DOST = @DATE )  
 --and b.fld_status='U')   
 and D.Br_Status='A' and Fld_Status ='U'
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WanLink_AutoMail
-- --------------------------------------------------
    
        
CREATE proc [dbo].[USP_WanLink_AutoMail]                        
as                      
BEGIN                      
 DECLARE @CNT INT=0                      
 DECLARE @RowCnt INT=0                      
 DECLARE @EMAIL AS VARCHAR(1000)=''                      
 DECLARE @Region AS VARCHAR(100)=''                      
 DECLARE @GroupID AS VARCHAR(100)=''                      
 DECLARE @BODY1 VARCHAR(8000)=''                      
 DECLARE @BODY2 VARCHAR(8000)=''                      
 DECLARE @BODY3 VARCHAR(8000)=''                      
 DECLARE @HTMLBODY VARCHAR(MAX)=''                      
 DECLARE @HTML VARCHAR(MAX)=''                      
 DECLARE @SUB VARCHAR(8000)=''                      
 DECLARE @OUTPUT VARCHAR(1000)=''                      
 DECLARE @GetDate DATETIME = DATEADD(DD, 3 , getdate())                      
 --SELECT @GetDate                      
 /***** For First Saturday of the Month *****/                      
 --IF DATEPART(DAY, @GetDate) - DATEPART(DAY, DATEADD(DD, -DATEPART(DAY, @getdate)+1, @GetDate) + 7 - DATEPART(DW, DATEADD(DD, -DATEPART(DAY, @getdate)+1, @GetDate))) >= 0                        
  --AND DATEPART(DW, @GetDate) <> 1                      
  BEGIN                      
   --SELECT Br_Tag,Sr_No,                      
   --upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch ,                      
   --EMAIL= CONVERT(VARCHAR(1000),'') ,GroupID=CONVERT(VARCHAR(1000),''),MAIL_SENT='N',Region=CONVERT(VARCHAR(1000),'')                      
   --INTO #WanLink_PENDING  FROM tbl_it_br_master (nolock)                      
   --WHERE Br_Status='A'                      
   --AND Sr_No NOT IN (SELECT DISTINCT Fld_Branch  FROM Tbl_IT_Wanlink_Data WITH (NOLOCK)                      
   --WHERE Fld_Entry_Date BETWEEN Convert(Varchar(15),GETDATE(),105) and Convert(Varchar(15),DATEADD(DAY,-7,GETDATE()),105))                      
   --ORDER BY Br_Name,Br_Tag                      
SELECT distinct Sr_No as Branch_Name ,D.Br_Tag,D.Sr_No,                        
 upper(Br_Name)+'-('+upper(Br_tag)+')' as Branch ,                        
 EMAIL= CONVERT(VARCHAR(1000),'') ,GroupID=CONVERT(VARCHAR(1000),''),MAIL_SENT='N',Region=CONVERT(VARCHAR(1000),'')                        
 INTO #WanLink_PENDING  FROM TBL_IT_WANLINK_DATA C                         
 LEFT OUTER JOIN V_CSONAMES D ON C.fld_branch = D.sr_no                        
 Where Upper(C.fld_branch) != 'ALL' and fld_branch not in(SELECT DISTINCT B.FLD_BRANCH FROM TBL_IT_WANLINK_UPDATE_DATA A                        
 LEFT OUTER JOIN TBL_IT_WANLINK_DATA B ON B.FLD_ID =A.FLD_ID                         
 WHERE  Convert(Varchar(30),FLD_DOST,105) =CASE WHEN DateName(DW,getdate()) = 'Saturday' THEN Convert(Varchar(15),GETDATE(),105)       
 ELSE Convert(Varchar(15),GETDATE()- 2,105) END and  b.fld_status='U' )      
 --BETWEEN Convert(Varchar(15),GETDATE(),105) and Convert(Varchar(15),DATEADD(DAY,-7,GETDATE()),105)  and b.fld_status='U' )                       
                            
   UPDATE #WanLink_PENDING                        
   SET EMAIL= IE_Employee_Email,                        
   GroupID=IE_GroupID,                        
   Region=IE_Region_name                        
   From tbl_IT_Inventory_EmailID  
   WHERE #WanLink_PENDING.Sr_No=tbl_IT_Inventory_EmailID.IE_Branch_SrNo                        
                             
   SELECT Distinct Br_Tag,Branch,EMAIL,GroupID,MAIL_SENT,Region                        
   INTO #PENDING FROM #WanLink_PENDING where Sr_no is not null GROUP BY GroupID,Br_Tag,Branch,EMAIL,MAIL_SENT,Region                        
   ORDER BY Br_Tag                        
                          
   SELECT Br_Name  AS [Branches_Not_Updated],tbl_it_br_master.Br_Tag ,GroupID                        
   INTO #Branches                        
   FROM tbl_it_br_master,#WanLink_PENDING                        
   WHERE #WanLink_PENDING.Br_Tag = tbl_it_br_master.Br_Tag                        
   AND Br_Status='A'                           
                             
   SELECT @RowCnt=@@ROWCOUNT                          
   SELECT @CNT=0                      
   SELECT @CNT=COUNT(1) FROM #PENDING WITH (NOLOCK) WHERE MAIL_SENT = 'N' GROUP BY GroupID                            
                          
   WHILE @CNT > 0                   
    BEGIN                            
     SELECT TOP 1 @EMAIL=EMAIL,@GroupID=GroupID,@Region=Region                           
     FROM #PENDING WITH (NOLOCK)                           
     WHERE MAIL_SENT = 'N'                            
                          
     SELECT @OUTPUT='Select [Branches_Not_Updated],Br_Tag  from #Branches where GroupID='                             
     +''''+@GroupID+''''                            
           
     EXEC [DBA_ConvertQueryInHTMP_Page] @OUTPUT, @HTMLBODY OUTPUT                            
                          
     SELECT @BODY1 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;">                            
     Dear IT Team,<BR/><BR/>This is to remind you for updating WAN Link Report of this week.<BR/><BR/>                            
     <b><font color=#ff6666>Kindly note that the cut off timing for updating WAN Link Report is 2.00 P.M.every Saturday.<BR/><BR/></font></b>                            
     </td></tr></table>'                            
     SELECT @BODY2 = '<table border="0" width="80%" ><tr><td style="font-family:TREBUCHET MS;font-size:14px;">                            
     <BR/>Best Regards,<BR/><BR/><b>IT Branch Support Team</b><BR/>Angel Broking Ltd<BR/>Central Support Office <BR/>Tel no: 022-28358800(Ext: 404/405/406)                            
     </td></tr></table>'                            
                          
     SELECT @HTML = @BODY1+@HTMLBODY+@BODY2                            
     SELECT @SUB='Reminder for Wan Link Report - '+@Region+''                                      
    EXEC MSDB.dbo.SP_SEND_DBMAIL
    @profile_name = 'ITHelpdesk',
    @recipients = @EMAIL,
    @copy_recipients = 'IThelpdeskakruti@angelbroking.com;networkadmin@angelbroking.com',
    --@blind_copy_recipients = 'harshalrose4@gmail.com',
    @subject = @SUB,
    @body = @HTML,
    @body_format = 'HTML'
                          
     UPDATE #PENDING SET MAIL_SENT = 'Y' WHERE EMAIL=@EMAIL                            
     SELECT @CNT=COUNT(1) FROM #PENDING WITH (NOLOCK) WHERE MAIL_SENT = 'N'                            
    END                            
                          
   DROP TABLE #WanLink_PENDING                         
   DROP TABLE #PENDING                            
   DROP TABLE #Branches                            
 END                            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_WANLink_Report
-- --------------------------------------------------
  
  
CREATE PROCEDURE [dbo].[Usp_WANLink_Report]                  
AS  
BEGIN  
DECLARE @EMP_NAME AS VARCHAR(100),@EMP_EMAIL AS VARCHAR(100)                  
DECLARE @EMAILTO AS VARCHAR(1000),@EMAILCC AS VARCHAR(1000),@EMAILBCC AS VARCHAR(1000),@SUB AS VARCHAR(MAX),@MESS NVARCHAR(MAX)    
  
  
  
SELECT @EMAILTO='PRASHANT.PATADE@ANGELBROKING.COM;'  
  
DECLARE @filename1 as varchar(100)                              
  declare @Date varchar(19)=convert(varchar(19),getdate()-10,103)               
--select @filename1='d:\Ups_Report\UPS_Report'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                         
      
 declare @BrTag Varchar(15)='%%'   
                                                   
--DECLARE @CSOName as Varchar(50)                                      
--SELECT @CSOName = Fld_RegName FROM Tbl_RegionMaster_UPSWanlink WHERE Fld_RegCode = @BrTag                                                                                  
                           
                                          
CREATE TABLE #T(BRCODE INT,BRTAG VARCHAR(15),BRNAME VARCHAR(100))                                                  
  INSERT INTO  #T                                                  
  EXEC USP_WAN_SEARCH_BRANCH @BRTAG  
                                                               
                                                               
  --INSERT INTO #T                                                              
  --SELECT @FLD_BRANCH,'',''                                                              
                      
 --DECLARE @CSONAME VARCHAR(30)                                                        
 --SELECT @CSONAME = FLD_REGNAME FROM TBL_REGION_MASTER WHERE FLD_REGCODE = @FLD_CSO   
   
   
--declare @Date varchar(19)= (getdate()-10)  
--print @Date    
--declare @BranchId int=0,@BrTag Varchar(15)='%%'    
                      
--DECLARE @Fdate Varchar(15)                            
--Set @Fdate = Convert(datetime,@Date,103)   
--print @Fdate  
----SET @Fdate = @Date     
  
DECLARE @Fdate as datetime     
set @Fdate=getdate()-10                       
                                              
 SELECT A.FLD_ID AS SRNO,A.FLD_LINK,A.CATEGORY,A.FLD_CHK_ID,                                                                              
   A.FLD_PROVIDER,A.FLD_BANDWITDH,A.FLD_PURPOSE,A.FLD_CSO,A.FLD_BRANCH,                          
   B.FLD_ID,B.FLD_ENTRY_DATE,                                            
   B.FLD_STATUS,B.FLD_CONNECTIVITY_TYPE,                                                                                
   Ltrim(Rtrim(D.Fld_Status)) as Status,          
   D.FLD_DOFT,Z.PERSON_NAME AS FLD_FIRST_TESTBY,Z.PERSON_NAME AS FLD_FEMPCODE,                                             
   D.FLD_DOST,D.FLD_SECOND_TESTBY,                                                
   D.FLD_FIRST_REMARK  AS FLD_FIRST_REMARK ,D.FLD_SECOND_REMARK  AS FLD_SECOND_REMARK,                                            
   D.FLD_SEMPCODE,B.ACTIVESTATUS,B.INACTIVEDATE,                              
   UPPER(C.BR_NAME) AS BR_NAME ,UPPER(C.BR_TAG) AS BR_TAG,FLD_REGNAME AS CSONAME   
     into #y                  
  FROM V_WAN_DATA A                            
  INNER JOIN TBL_IT_WANLINK_DATA B  ON A.FLD_ID = B.FLD_ID           
  AND A.FLD_BRANCH IN (SELECT brcode FROM #T) ---- commented by harshal at 8 May 2013          
  LEFT OUTER JOIN (SELECT * FROM TBL_IT_WANLINK_UPDATE_DATA (NOLOCK) WHERE FLD_DOST=@FDATE) D  ON A.FLD_ID = D.FLD_ID                                           
  LEFT OUTER JOIN INTRANET.RISK.DBO.USER_LOGIN Z ON D.FLD_SECOND_TESTBY = Z.USERNAME                                                                               
  LEFT OUTER JOIN TBL_IT_BR_MASTER C ON convert(varchar(max),A.FLD_BRANCH) = convert(varchar(max),C.SR_NO)                                 
  --LEFT OUTER JOIN TBL_IT_BR_MASTER E ON A.FLD_BRANCH = E.SR_NO                
  LEFT OUTER JOIN Tbl_RegionMaster_UPSWanlink F ON C.Br_Tag =F.FLD_REGCODE                
  WHERE CONVERT(DATETIME,(CONVERT(VARCHAR(11),A.INACTIVEDATE ,103)),103) >= CONVERT(DATETIME,@Fdate,103)                  
  --WHERE CONVERT(VARCHAR(11),CONVERT(DATETIME,A.FLD_ENTRY_DATE,103),121) = @FDATE                          
  ORDER BY C.BR_NAME,A.FLD_ID   
   
 END  
  truncate table tbl_WAN_Rpt_Temp  
  
  insert into tbl_WAN_Rpt_Temp(CSONAME,BR_TAG,BR_NAME,FLD_LINK,FLD_CONNECTIVITY_TYPE,FLD_CHK_ID,FLD_PROVIDER,FLD_BANDWITDH,FLD_PURPOSE,FLD_STATUS)  
  
 SELECT   'CSO','Branch Tag','BRANCH NAME','LINK','CONNECTIVITY','CKT ID NO','PROVIDER','BANDWIDTH','PURPOSE','STATUS'  
    
  insert into tbl_WAN_Rpt_Temp(CSONAME,BR_TAG,BR_NAME,FLD_LINK,FLD_CONNECTIVITY_TYPE,FLD_CHK_ID,FLD_PROVIDER,FLD_BANDWITDH,FLD_PURPOSE,FLD_STATUS)  
 select CSONAME,BR_TAG,BR_NAME,FLD_LINK,FLD_CONNECTIVITY_TYPE,FLD_CHK_ID,FLD_PROVIDER,FLD_BANDWITDH,FLD_PURPOSE,FLD_STATUS  
 from #y    
  
    
  DECLARE @BCPCOMMAND VARCHAR(250)   
  DECLARE @FILENAME VARCHAR(250)--@filename1 varchar(max)  
 declare @s1 as varchar(max)    
  --select @filename1='d:\Ups_Report\UPS_Report'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'                                                         
 SET @FILENAME ='d:\upload1\d$\upload1\WAN_Link_Rrport'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'  
    SET @FILENAME1 ='\\196.1.115.167\d$\upload1\WAN_Link_Rrport'+replace(convert(varchar(25),getdate(),102),'.','')+replace(convert(varchar(25),getdate(),108),':','')+'.csv'  
  SET @BCPCOMMAND = 'BCP "SELECT CSOName,Br_Name,UPS_Model,UpsCapacity,Agv_Daily_Load,Total_TestingTime,Total_Load_InPer,Remark,Emp_Name FROM Helpdesk.dbo.tbl_WAN_Rpt_Temp " QUERYOUT "'          
  SET @BCPCOMMAND = @BCPCOMMAND + @FILENAME + '" -c -t, -Smis -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'          
    EXEC MASTER..XP_CMDSHELL @BCPCOMMAND   
     print @FILENAME  
    
  SET @MESS='DEAR ALL,<BR><BR>GOOD EVENING!!!<BR><BR>GREETINGS OF THE DAY!<BR>'  
  SET @MESS=@MESS+'<BR><BR>THIS IS A SYSTEM GENERATED MESSAGE. PLEASE DO NOT REPLY.<BR><BR>REGARDS,<BR><BR>(IT HELPDESK)'                                
  SET @SUB ='UPS Report AS ON ' + CONVERT(VARCHAR(MAX),GETDATE())  
               
 DECLARE @s varchar(500)                  
 SET @s = @FILENAME1   
  
 EXEC INTRANET.MSDB.DBO.SP_SEND_DBMAIL                                
 @RECIPIENTS =@EMAILTO,                                
 @COPY_RECIPIENTS = @EMAILCC,                                
 @BLIND_COPY_RECIPIENTS=@EMAILBCC,                      
 @PROFILE_NAME = 'ANGELBROKING',                                
 @BODY_FORMAT ='HTML',                                
 @SUBJECT = @SUB ,   
 @FILE_ATTACHMENTS =@s,                               
 @BODY =@MESS         
 drop table #T

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_weekly_UPs_Details
-- --------------------------------------------------
CREATE Proc USP_weekly_UPs_Details
(
@Fld_Ups_Id int,
@Fld_Avg_Load varchar(50),
@Fld_Bat_Over varchar(50),
@Fld_Critical_Check varchar(50),
@Fld_FOB varchar(15),
@Fld_FRemark varchar(100),
@Fld_SOB varchar(15),
@Fld_SRemark varchar(100),
@Fld_FCD datetime,
@Fld_SCD datetime,
@Fld_Upd_Date datetime
)
as

insert into tbl_weekly_UPs_Details values
(
@Fld_Ups_Id,
@Fld_Avg_Load,
@Fld_Bat_Over,
@Fld_Critical_Check,
@Fld_FOB,
@Fld_FRemark,
@Fld_SOB,
@Fld_SRemark,
@Fld_FCD,
@Fld_SCD,
getdate()
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Weekly_UPS_Report
-- --------------------------------------------------
CREATE Proc [dbo].[Usp_Weekly_UPS_Report](@Date Varchar(15),@BranchId int,@BrTag Varchar(15))                    
as                    
                    
Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)                   
DECLARE @CSOName as Varchar(50)  
SELECT @CSOName = Fld_RegName FROM tbl_region_master WHERE Fld_RegCode = @BrTag        
        
Select * into #empinfo from intranet.risk.dbo.emp_info 
 
if(@BranchId <> 0)        
Begin        
 Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,b.*,c.Emp_Name FirstCheck,d.Emp_Name SecondCheck ,  
 @CSOName as CSOName, a.Agv_Daily_Load,Case When a.Total_TestingTime =  '' Then '' Else a.Total_TestingTime END as Total_TestingTime,  --added by harshal   
 a.Total_Load_InPer,a.Remark,Fld_Model_Capacity,Fld_Model_Name,Br_Name, (a.Ups_Name + '-'+ Fld_Model_Name + '-' + Fld_Model_Capacity) as UPS_Model ,a.Emp_Name  --added by harshal   
  from                    
 (Select s.*,e.Emp_Name from V_Ups_Master(nolock) s 
 inner join  #empinfo e           
 on s.ChangedBy = e.Emp_no where fld_Branch_id = @BranchId)a                    
 left outer join              
 (Select * from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId = @BranchId)b               
 on a.Fld_Srno = b.fld_ups_id        
 left outer join #empinfo c            
 on b.Fld_Fob = c.Emp_no    
 left outer join #empinfo d           
 on b.Fld_Sob = d.Emp_no
 order by a.ups_id        
End        
Else        
Begin         
 Create Table #t(BrCode int,BrTag varchar(15),BrName varchar(100))        
        
 Insert into #t        
 Exec Usp_Wan_Search_Branch @BrTag         
        
 Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,b.*,c.Emp_Name FirstCheck,d.Emp_Name SecondCheck ,  
 @CSOName as CSOName ,a.Agv_Daily_Load,Case When a.Total_TestingTime =  '' Then '' Else a.Total_TestingTime END as Total_TestingTime,a.Total_Load_InPer,a.Remark,    --added by harshal  
 Fld_Model_Capacity,Fld_Model_Name,Br_Name, (a.Ups_Name + '-'+ Fld_Model_Name + '-' + Fld_Model_Capacity) as UPS_Model,a.Emp_Name  
 from                    
 (Select s.* ,e.Emp_Name from V_Ups_Master(nolock) s
 left outer join #empinfo e           
 on s.ChangedBy = e.Emp_no where fld_Branch_id in (Select BrCode from #t))a                      
 left outer join              
 (Select * from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId in (Select BrCode from #t))b               
 on a.Fld_Srno = b.fld_ups_id        
 left outer join #empinfo c            
 on b.Fld_Fob = c.Emp_no    
 left outer join #empinfo d           
 on b.Fld_Sob = d.Emp_no
 order by a.ups_id      
 
 drop table #t
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WEEKLY_UPS_REPORT_15122010
-- --------------------------------------------------
CREATE PROCEDURE USP_WEEKLY_UPS_REPORT_15122010
(
	@Date Varchar(15),
	@BranchId int,
	@BrTag Varchar(15)
)
                  
as                  
	          
	Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)                  

	Select * into #empinfo from intranet.risk.dbo.emp_info  

	if(@BranchId <> 0)      
	Begin      
	
		Select * 
		into #temp
		from V_Ups_Master(nolock) where fld_Branch_id = @BranchId
	
		Select a.fld_srno UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,b.*,c.Emp_Name FirstCheck,d.Emp_Name SecondCheck 
		from                  
		--(Select * from V_Ups_Master(nolock) where fld_Branch_id = @BranchId)a                  
		#temp a
		inner join            
		(Select * from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId = @BranchId)b             
		on a.Fld_Srno = b.fld_ups_id      
		left outer join #empinfo c          
		on b.Fld_Fob = c.Emp_no  
		left outer join #empinfo d         
		on b.Fld_Sob = d.Emp_no  
		--order by a.UpsId      
		order by #temp.UpsId      
	
	End      

	Else      

	Begin       
	
		Create Table #t(BrCode int,BrTag varchar(15),BrName varchar(100))      

		Insert into #t      
		Exec Usp_Wan_Search_Branch @BrTag       
		
		Select * 
		into #temp2 
		from V_Ups_Master(nolock) 
		where fld_Branch_id in (Select BrCode from #t)

		Select a.fld_srno UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,b.*,c.Emp_Name FirstCheck,d.Emp_Name SecondCheck 
		from                  
		--(Select * from V_Ups_Master(nolock) where fld_Branch_id in (Select BrCode from #t))a                  
		#temp2 a
		inner join            
		(Select * from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId in (Select BrCode from #t))b             
		on a.Fld_Srno = b.fld_ups_id      
		left outer join #empinfo c          
		on b.Fld_Fob = c.Emp_no  
		left outer join #empinfo d         
		on b.Fld_Sob = d.Emp_no  
		--order by a.UpsId       
		order by #temp2.UpsId       
	End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Weekly_UPS_Report_25Feb2013
-- --------------------------------------------------



CREATE Proc [dbo].[Usp_Weekly_UPS_Report_25Feb2013](@Date Varchar(15),@BranchId int,@BrTag Varchar(15))                  
as                  
                  
Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)                  
      
Select * into #empinfo from intranet.risk.dbo.emp_info  
  
if(@BranchId <> 0)      
Begin      
 Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,b.*,c.Emp_Name FirstCheck,d.Emp_Name SecondCheck from                  
 (Select * from V_Ups_Master(nolock) where fld_Branch_id = @BranchId)a                  
 inner join            
 (Select * from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId = @BranchId)b             
 on a.Fld_Srno = b.fld_ups_id      
 left outer join #empinfo c          
 on b.Fld_Fob = c.Emp_no  
 left outer join #empinfo d         
 on b.Fld_Sob = d.Emp_no  
 order by a.ups_id      
End      
Else      
Begin       
 Create Table #t(BrCode int,BrTag varchar(15),BrName varchar(100))      
      
 Insert into #t      
 Exec Usp_Wan_Search_Branch @BrTag       
      
 Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,b.*,c.Emp_Name FirstCheck,d.Emp_Name SecondCheck from                  
 (Select * from V_Ups_Master(nolock) where fld_Branch_id in (Select BrCode from #t))a                  
 inner join            
 (Select * from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId in (Select BrCode from #t))b             
 on a.Fld_Srno = b.fld_ups_id      
 left outer join #empinfo c          
 on b.Fld_Fob = c.Emp_no  
 left outer join #empinfo d         
 on b.Fld_Sob = d.Emp_no  
 order by a.ups_id       
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_WEEKLY_UPS_REPORT_31122010
-- --------------------------------------------------
CREATE PROC USP_WEEKLY_UPS_REPORT_31122010
(
	@DATE VARCHAR(15),
	@BRANCHID INT,
	@BRTAG VARCHAR(15)
)                  

AS                  
                  
	SET @DATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE,103),121)                  
	  
	SELECT * INTO #EMPINFO FROM INTRANET.RISK.DBO.EMP_INFO  

	IF(@BRANCHID <> 0)      
	BEGIN      
		SELECT UPSID=A.FLD_SRNO,A.UPS_ID,A.UPS_NAME,FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID,B.*,C.EMP_NAME FIRSTCHECK,D.EMP_NAME SECONDCHECK FROM                  
		(SELECT * FROM V_UPS_MASTER(NOLOCK) WHERE FLD_BRANCH_ID = @BRANCHID)A                  
		INNER JOIN            
		(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK) WHERE CONVERT(VARCHAR(11),FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID = @BRANCHID)B             
		ON A.FLD_SRNO = B.FLD_UPS_ID      
		LEFT OUTER JOIN #EMPINFO C          
		ON B.FLD_FOB = C.EMP_NO  
		LEFT OUTER JOIN #EMPINFO D         
		ON B.FLD_SOB = D.EMP_NO  
		ORDER BY UPSID      
	END      
	
	ELSE      
	BEGIN       
	
		CREATE TABLE #T(BRCODE INT,BRTAG VARCHAR(15),BRNAME VARCHAR(100))      
		  
		INSERT INTO #T      
		EXEC USP_WAN_SEARCH_BRANCH @BRTAG       
		  
		SELECT UPSID=A.FLD_SRNO,A.UPS_ID,A.UPS_NAME,FLD_MODEL_SRNO+' ('+FLD_BATTERY_BANK+')' UPSCAPACITY,A.FLD_BRANCH_ID,B.*,C.EMP_NAME FIRSTCHECK,D.EMP_NAME SECONDCHECK FROM                  
		(SELECT * FROM V_UPS_MASTER(NOLOCK) WHERE FLD_BRANCH_ID IN (SELECT BRCODE FROM #T))A                  
		INNER JOIN            
		(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK) WHERE CONVERT(VARCHAR(11),FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID IN (SELECT BRCODE FROM #T))B             
		ON A.FLD_SRNO = B.FLD_UPS_ID      
		LEFT OUTER JOIN #EMPINFO C          
		ON B.FLD_FOB = C.EMP_NO  
		LEFT OUTER JOIN #EMPINFO D         
		ON B.FLD_SOB = D.EMP_NO  
		ORDER BY UPSID       
		
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Weekly_UPS_Report_test
-- --------------------------------------------------
       
 
   
  
  
CREATE Proc [dbo].[Usp_Weekly_UPS_Report_test](@Date Varchar(15),@BranchId int,@BrTag Varchar(15))                        
as                        
                        
Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)                       
DECLARE @CSOName as Varchar(50)      
SELECT @CSOName = Fld_RegName FROM tbl_region_master WHERE Fld_RegCode = @BrTag            
            
 --Create Table #t(BrCode int,BrTag varchar(15),BrName varchar(100))          
          
 Select * into  #t From tbl_it_br_master
       
 --Exec Usp_Wan_Search_Branch @BrTag           
          
 Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,b.*,c.Emp_Name FirstCheck,d.Emp_Name SecondCheck ,    
 @CSOName as CSOName ,a.Agv_Daily_Load,Case When a.Total_TestingTime =  '' Then '' Else a.Total_TestingTime END as Total_TestingTime,a.Total_Load_InPer,a.Remark,    --added by harshal    
 Fld_Model_Capacity,Fld_Model_Name,Br_Name, (a.Ups_Name + '-'+ Fld_Model_Name + '-' + Fld_Model_Capacity) as UPS_Model,a.Emp_Name    
 from                      
 (Select s.* ,e.Emp_Name from V_Ups_Master(nolock) s  
 left outer join intranet.risk.dbo.emp_info e             
 on s.ChangedBy = e.Emp_no where fld_Branch_id in (0))a                        
 left outer join                
 (Select * from tbl_Weekly_ups_details(nolock) where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId in (0))b                 
 on a.Fld_Srno = b.fld_ups_id          
 left outer join intranet.risk.dbo.emp_info c              
 on b.Fld_Fob = c.Emp_no      
 left outer join intranet.risk.dbo.emp_info d             
 on b.Fld_Sob = d.Emp_no  
 order by a.ups_id        
   
 drop table #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_Weekly_UPS_Report1
-- --------------------------------------------------
          
CREATE Proc [dbo].[Usp_Weekly_UPS_Report1](@Date Varchar(15),@BranchId int,@BrTag Varchar(15))                                                    
as                
                        
DECLARE @Fdate Varchar(15)                        
SET @Fdate = @Date                        
Set @Date = Convert(varchar(11),Convert(datetime,@Date,103),121)                                                   
DECLARE @CSOName as Varchar(50)                                  
SELECT @CSOName = Fld_RegName FROM Tbl_RegionMaster_UPSWanlink WHERE Fld_RegCode = @BrTag                                        
if(@BranchId <> 0)                                        
Begin                                        
 Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,                
  g.CSONAME as CSOName,                  
  h.Agv_Daily_Load,h.Remark as Remark_ups,             
  Case When h.Total_TestingTime =  '' Then '' Else h.Total_TestingTime END as Total_TestingTime,  --added by harshal                                   
 h.Total_Load_InPer,            
 h.Remark,Fld_Model_Capacity,Fld_Model_Name,a.Br_Name,a.Fld_Branch_id, (a.Ups_Name + '-'+ CASE WHEN Fld_Model_Name Is null THEN '-' ELSE Fld_Model_Name END + '-' + Fld_Model_Capacity) as UPS_Model ,a.Emp_Name  --added by harshal                    
  from  
 (Select s.*,e.Emp_Name from V_Ups_Master(nolock) s                                   
 inner join  intranet.risk.dbo.emp_info e                                           
 on s.ChangedBy = e.Emp_no where fld_Branch_id = @BranchId and Fld_ToDate =@Date                        
 and Convert(Varchar(11),DeactivatedOn,103) > = @Fdate )a                                                    
 left outer join                                              
 (Select * from tbl_Weekly_ups_details(nolock)                               
 where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId = @BranchId)b                                               
 on a.Fld_Srno = b.fld_ups_id                                        
 left outer join intranet.risk.dbo.emp_info c                                            
 on b.Fld_Fob = c.Emp_no                                    
 left outer join intranet.risk.dbo.emp_info d                                           
 on b.Fld_Sob = d.Emp_no                                
 left outer join V_CSONAMES g on a.Fld_Branch_id = g.Sr_No                
 left outer join tbl_ups_data h on A.Fld_srNo = h.Fld_Ups_id  and Fld_Entry_date = Convert(datetime,@FDATE,103)              
 --order by a.ups_id ,CSOName                         
 order by CSOName     
End                                        
Else                                        
Begin                                  
-- Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,a.Fld_Branch_id,            
--  g.CSONAME as CSOName,                  
-- h.Agv_Daily_Load,            
-- Case When h.Total_TestingTime =  '' Then '' Else h.Total_TestingTime END as Total_TestingTime,            
-- h.Total_Load_InPer,            
-- h.Remark,    --added by harshal                                  
-- Fld_Model_Capacity,Fld_Model_Name,a.Br_Name,a.Fld_Branch_id, (a.Ups_Name + '-'+ CASE WHEN Fld_Model_Name is null THEN '-' ELSE Fld_Model_Name END + '-' + Fld_Model_Capacity) as UPS_Model,a.Emp_Name                                  
-- from                                                    
-- (Select s.* ,e.Emp_Name from V_Ups_Master(nolock) s                                
-- left outer join intranet.risk.dbo.emp_info e                                           
-- on s.ChangedBy = e.Emp_no where  Fld_ToDate =@Date and Convert(Varchar(11),DeactivatedOn,103) > = @Fdate  and fld_Branch_id in (select Sr_No from                                                      
--(                                                      
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Tag like @BrTag or Reg_Code like @BrTag and Br_Status='A' )                         
--union                                                      
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Region like @BrTag or Reg_Code like @BrTag and Br_Status='A')                                                    
--union                  
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where brmast_cd like @BrTag and Br_Status='A'                                    
--union                                  
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)                                  
--where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @BrTag and Br_Status='A')                                                       
--) x  ))a                                                      
-- left outer join                                              
-- (Select * from tbl_Weekly_ups_details(nolock)                               
-- where Convert(Varchar(11),Fld_Upd_Date,121) = @Date and Fld_BranchId in (select Sr_No from                                                      
--(                                                      
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Tag like @BrTag or Reg_Code like @BrTag and Br_Status='A' )                                                     
--union                                                  
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where (Br_Region like @BrTag or Reg_Code like @BrTag and Br_Status='A')                                                    
--union                                  
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock) where brmast_cd like @BrTag and Br_Status='A'                                    
--union                                  
--select Sr_No,Br_tag,upper(Br_Name)+'-('+upper(Br_tag)+')' as Br_Name from V_tbl_it_br_master (nolock)                                  
--where Br_Region  in (select br_tag  from V_tbl_it_br_master where brmast_cd like @BrTag and Br_Status='A')                                                       
--) x))b                
-- on a.Fld_Srno = b.fld_ups_id                                        
-- left outer join intranet.risk.dbo.emp_info c                                            
-- on b.Fld_Fob = c.Emp_no                                    
-- left outer join intranet.risk.dbo.emp_info d                                           
-- on b.Fld_Sob = d.Emp_no                 
-- left outer join V_CSONAMES g on a.Fld_Branch_id = g.Sr_No               
-- left outer join tbl_ups_data h on A.Fld_srNo = h.Fld_Ups_id             
-- order by CSOName,a.ups_id                          
                                         
---- drop table #t                                
SET NOCOUNT ON                          
                                    
CREATE TABLE #T(BRCODE INT,BRTAG VARCHAR(15),BRNAME VARCHAR(100))                                              
  INSERT INTO #T                                              
  EXEC USP_WAN_SEARCH_BRANCH @BRTAG        
            
   Select a.fld_srno as UpsId,a.ups_id,a.Ups_Name,fld_Model_Srno+' ('+Fld_Battery_Bank+')' UpsCapacity,          
   a.Fld_Branch_id,            
  g.CSONAME as CSOName, A.Remark_ups ,                
 A.Agv_Daily_Load,            
 Case When A.Total_TestingTime =  '' Then '' Else A.Total_TestingTime END as Total_TestingTime,            
 A.Total_Load_InPer,            
 A.Remark,    --added by harshal                                  
 Fld_Model_Capacity,Fld_Model_Name,a.Br_Name,a.Fld_Branch_id,           
 (a.Ups_Name + '-'+ CASE WHEN Fld_Model_Name is null THEN '-' ELSE Fld_Model_Name END + '-' + Fld_Model_Capacity) as UPS_Model,          
 e.Emp_Name                
  FROM     
  (SELECT k.*,h.ChangedBy as changed_by,h.Agv_Daily_Load,h.Total_TestingTime,h.Total_Load_InPer,h.Remark as Remark_ups   FROM V_UPS_MASTER(NOLOCK) k      
  right outer join tbl_ups_data h  on k.Fld_srNo = h.Fld_Ups_id and  Fld_Entry_date = Convert(datetime,@FDATE,103)        
  WHERE FLD_BRANCH_ID IN (SELECT BRCODE FROM #T) AND DeactivatedOn >= Convert(datetime,@FDATE,103)      
  and Fld_Entry_date = Convert(datetime,@FDATE,103)              
  )A                  
 -- LEFT OUTER JOIN                  
  --(SELECT * FROM TBL_WEEKLY_UPS_DETAILS(NOLOCK)  WHERE CONVERT(VARCHAR(11),                  
  --FLD_UPD_DATE,121) = @DATE AND FLD_BRANCHID  IN (SELECT BRCODE FROM #T))B                  
 -- ON A.FLD_SRNO = B.FLD_UPS_ID                  
 -- LEFT OUTER JOIN                      
  --INTRANET.RISK.DBO.EMP_INFO C                          
  --ON B.FLD_FOB = C.EMP_NO          
  left outer join V_CSONAMES g on A.Fld_Branch_id = g.Sr_No                       
  left outer join intranet.risk.dbo.emp_info e  on A.changed_by = e.Emp_no                
  --ORDER BY A.UPS_ID,CSOName
  ORDER BY CSOName
 drop table #t           
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USPAssetsReportDateWise
-- --------------------------------------------------
CREATE proc USPAssetsReportDateWise(@fdate as varchar(25),@tdate as varchar(25),@Branch varchar(10))
as
select a.* from 
(select '' as Fld_PurchaseOrderNo, * from tbl_itassetsdata(nolock)  
where convert(datetime,fld_warrantyto,103) >= @fdate 
and convert(datetime,fld_warrantyto,103) <= @tdate)a
inner join
(select Fld_SrNo,Fld_BranchCode from tbl_ITRequestMaster where Fld_BranchCode like @Branch)b
on a.Fld_RequestTableSrNo=b.Fld_SrNo

GO

-- --------------------------------------------------
-- PROCEDURE dbo.uspdowntime
-- --------------------------------------------------
CREATE procedure uspdowntime(@sdate datetime,@edate datetime,@location varchar(100))    
as    
    
set @sdate=(convert(datetime,@sdate))    
set @edate=( convert(datetime,@edate))  
  
-- select Location,downtime=sum(convert (int,downtimemin)) from NewTAb1 
-- where dt >= @sdate and dt <= @edate 
-- and Location like Replace(@location,'All','%')+'%' group by Location order by Location 

select Location,downtime=sum(convert (int,downtimemin)) into #t from NewTAb1 
where dt >= @sdate and dt <= @edate 
and Location like Replace(@location,'All','%')+'%' group by Location order by Location 

select Location,downtime,a=downtime/convert(numeric,5),b=100-downtime/convert(numeric,5) from #t

--select Location,downtime,a=downtime/convert(numeric,826070),b=100-downtime/convert(numeric,826070) from #t

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UspFillProc
-- --------------------------------------------------

CREATE proc UspFillProc(@branch as varchar(50))
as
select fld_id,procedures from odinchecklist_procedures where flag='A' and fld_id not in
(select procedureid From tbl_odinchecklist_cutofftime where br_tag=@branch )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V_IT_Staff_Rpt_New_M
-- --------------------------------------------------
CREATE proc V_IT_Staff_Rpt_New_M   
(  
@branch as varchar(50),  
@status as varchar(50)  
)     
as                              
select case when x.Emp_No is null then y.Fld_Emp_No else x.Emp_No end as Emp_No,                                      
case when x.Emp_Name is null then y.Fld_Emp_Name else x.Emp_Name end as Emp_Name,                                      
case when x.Status is null then y.Fld_Status else x.Status end as Status,                          
case when y.Fld_Phone is null then x.Phone else y.Fld_Phone end as Phone,                                      
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                                      
case when x.Joindate is null then convert(varchar(11),y.Fld_JoinDate,103) else x.Joindate end as Joindate,                                      
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                                      
case when y.Fld_emailadd is null then x.emailadd else y.Fld_emailadd end as emailadd,                  
case when x.JobDesCid is null then y.Fld_DeptId else x.JobDesCid end as DesgJobDesc,                               
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,x.Department,x.subdepartment,x.Costcode,                                      
case when y.Fld_Branch_id is null then 0 else y.Fld_Branch_id end as Fld_Branch_id,                            
convert(varchar(11),x.RelieveDate,103) as RelieveDate,x.[HOD NO],                                     
x.mm,x.yy,z.br_tag,z.Br_Name,q.*,z.Br_Type                                
 from                                      
(                                      
/*                
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                                        
(                        
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                                    
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                                    
emailadd,DesgJobDesc,Emp_region,attnlocation                                     
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                                        
left outer join                                        
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                                         
on a.DesgJobDesc = b.JobDesCid                                        
left outer join                                        
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                                        
on a.Emp_region = c.code and a.attnlocation = c.pid                            
left outer join                            
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                            
on a.Emp_No = d.Emp_No                 
*/                
select x.*,y.JobDescid from              
(              
select [Emp No] Emp_No,Emp_Name,[HOD No],                
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,                
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,                
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,                
attendanceLoc as attnlocation,[Separation Date] RelieveDate,Region as Description,attendanceLoc as Loc_Name,            
Department,[sub Department] as subdepartment,Costcode                
from  [MIDDLEWARE].harmony.dbo.vlmsinhouse  where department = 'IT'               
)x              
left outer join              
(select * from  [MIDDLEWARE].harmony.dbo.jobdescriptionmaster) y              
on x.Job_Des = y.JobDesc                                    
)x                                      
full outer join                                      
(select * from tbl_IT_Staff (nolock)) y         
on x.Emp_No = y.Fld_Emp_No                                     
left outer join                           
(select * from tbl_it_br_master(nolock))z                                  
on y.Fld_Branch_id = z.Sr_No                                  
left outer join                                        
(select * from V_User_Category_New)q                                
on x.Emp_No = q.username  where br_tag=@branch and status=@status

GO

-- --------------------------------------------------
-- PROCEDURE dbo.v_user_history
-- --------------------------------------------------
CREATE procedure v_user_history(@id varchar(25))          
as          
select a.*,b.dept_name,c.fld_query,d.subject,z.Emp_Name  as enteredby,y.emp_name as solutionby from          
(select  Sr_Num,Dept_ID,Complaint_ID,Query_Type,Subject,Complaint,Solution,Access_code,Solution_By,          
convert(varchar(11),Complaint_Date,103) as Complaint_Date,convert(varchar(11),Solution_Date,103) as Solution_Date,Attachment,Fld_EntryBy,cso_attch,fld_hold_Reason          
,status=case 
when status = 'IP' then 'In Process'    
when status = 'C' then 'completed'            
when status = 'H' then 'Hold'                
when status = 'BC' then ' Branch Completed'                      
when status = 'P' then 'Pending'  end  from tbl_complaint(nolock)  where  complaint_id=@id)a          
left outer join          
(select  * from department_master(nolock))b          
on a.dept_id=b.dept_id          
left outer join          
(select * from query_type(nolock))c          
on a.query_type=c.fld_srno          
left outer join          
(select  * from tbl_subject(nolock))d           
on a.subject=d.srno          
left outer join                
intranet.risk.dbo.emp_info z           
on a.Fld_EntryBy = z.emp_no          
left outer join                
intranet.risk.dbo.emp_info y           
on a.solution_by  = y.emp_no       
order by a.Sr_Num

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ValidateUser
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[ValidateUser] @Emp_no varchar(20), @Emp_Pass varchar(20)   
AS  
BEGIN  
  
 SET NOCOUNT ON;  
 DECLARE @IsValid bit;  
 IF EXISTS(SELECT 1 FROM [CSOKYC-6].general.emplmst With(Nolock) where emp_no=@emp_no and emp_pass=@emp_pass
           union all
		   select 1 from [INTRANET].rolemgm.dbo.user_login with (nolock) where username=@Emp_no and userpassword=@Emp_Pass  )  
  SET @IsValid=1;  
 ELSE  
  SET @IsValid=0  
      
 select @IsValid as LoginStatus;   
END

GO

-- --------------------------------------------------
-- TABLE dbo.[tbl_wan_band]
-- --------------------------------------------------
CREATE TABLE [dbo].[[tbl_wan_band]]]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [drp_band] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.[tbl_wan_provider]
-- --------------------------------------------------
CREATE TABLE [dbo].[[tbl_wan_provider]]]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [drp_provider] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo._xlnm#_FilterDatabase
-- --------------------------------------------------
CREATE TABLE [dbo].[_xlnm#_FilterDatabase]
(
    [CSO] NVARCHAR(255) NULL,
    [Branch TAG] NVARCHAR(255) NULL,
    [ Branch name] NVARCHAR(255) NULL,
    [Link] NVARCHAR(255) NULL,
    [Connectivity] NVARCHAR(255) NULL,
    [Ckt id] NVARCHAR(255) NULL,
    [Provider] NVARCHAR(255) NULL,
    [Bandwidth] NVARCHAR(255) NULL,
    [ purpose] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Date of testing] NVARCHAR(255) NULL,
    [Tested by] NVARCHAR(255) NULL,
    [Remark] NVARCHAR(255) NULL,
    [Admin remark] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AAAA
-- --------------------------------------------------
CREATE TABLE [dbo].[AAAA]
(
    [prod] VARCHAR(10) NULL,
    [Total] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.apexmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[apexmaster]
(
    [Col001] VARCHAR(255) NULL,
    [Col002] VARCHAR(255) NULL,
    [Col003] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.atultest
-- --------------------------------------------------
CREATE TABLE [dbo].[atultest]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] NVARCHAR(1000) NOT NULL,
    [Solution] NTEXT NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(70) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(50) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Aug_cal
-- --------------------------------------------------
CREATE TABLE [dbo].[Aug_cal]
(
    [DATE] VARCHAR(255) NULL,
    [BSE CM] VARCHAR(255) NULL,
    [NSECM] VARCHAR(255) NULL,
    [NSEFO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Aug_set1
-- --------------------------------------------------
CREATE TABLE [dbo].[Aug_set1]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUTOMAIL_TAT
-- --------------------------------------------------
CREATE TABLE [dbo].[AUTOMAIL_TAT]
(
    [COMPLAINTID] VARCHAR(50) NOT NULL,
    [RAISED_TO_DEPT] VARCHAR(20) NULL,
    [RAISED_DATE] VARCHAR(11) NULL,
    [RAISED_BY_EMPNM] VARCHAR(100) NULL,
    [SUBJECT] VARCHAR(1000) NULL,
    [COMPLAINT_DETAILS] VARCHAR(1000) NULL,
    [PENDING_SINCE_HOURS] VARCHAR(15) NULL,
    [HR48] VARCHAR(100) NULL,
    [HR72] VARCHAR(100) NULL,
    [HR240] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.automail_tat41
-- --------------------------------------------------
CREATE TABLE [dbo].[automail_tat41]
(
    [Email] VARCHAR(1000) NULL,
    [TAT] VARCHAR(1000) NULL,
    [ComplaintID] VARCHAR(1000) NULL,
    [EmpName] VARCHAR(1000) NULL,
    [Complaint] VARCHAR(1000) NULL,
    [Date] VARCHAR(11) NULL,
    [Department] VARCHAR(1000) NULL,
    [Subject] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_ct270210
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_ct270210]
(
    [complaint_date] DATETIME NULL,
    [department] VARCHAR(50) NULL,
    [dsection] VARCHAR(20) NULL,
    [queryfrom] VARCHAR(250) NULL,
    [contact_person] VARCHAR(250) NULL,
    [problem] VARCHAR(5000) NULL,
    [suggestion] VARCHAR(5000) NULL,
    [completed_on] DATETIME NULL,
    [completed_remark] VARCHAR(150) NULL,
    [grade] CHAR(10) NULL,
    [helpdeskMarkcompleted] CHAR(10) NULL,
    [helpdeskmarkcompleteddate] DATETIME NULL,
    [status] CHAR(10) NULL,
    [complaintno] VARCHAR(50) NULL,
    [code] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [category] VARCHAR(15) NULL,
    [deptmarkcompleted] CHAR(10) NULL,
    [deptmarkcompleteddate] DATETIME NULL,
    [Remark] VARCHAR(600) NULL,
    [dstatus] VARCHAR(50) NULL,
    [dremark] VARCHAR(600) NULL,
    [emailid] VARCHAR(70) NULL,
    [phone] VARCHAR(250) NULL,
    [entry_by] VARCHAR(20) NULL,
    [subject] VARCHAR(500) NULL,
    [entered_through] VARCHAR(15) NULL,
    [time_limit] VARCHAR(15) NULL,
    [forwardto_dept] VARCHAR(100) NULL,
    [mark_complete] VARCHAR(5) NULL,
    [Call_type] VARCHAR(200) NULL,
    [Grp_Id] VARCHAR(50) NULL,
    [Attachment] VARCHAR(1000) NULL,
    [it_cat] VARCHAR(50) NULL,
    [it_subcat] VARCHAR(50) NULL,
    [it_conn] VARCHAR(50) NULL,
    [Wrong_Entry] CHAR(10) NULL,
    [City] VARCHAR(100) NULL,
    [Fld_Backup] VARCHAR(100) NULL,
    [Fld_Con_Time] VARCHAR(15) NULL,
    [Fld_Courtesy_Call_Type] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_IT
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_IT]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_newtab1
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_newtab1]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_newtab1_140607
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_newtab1_140607]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bak_sett_mas
-- --------------------------------------------------
CREATE TABLE [dbo].[Bak_sett_mas]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_sol_011207
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_sol_011207]
(
    [Sr.No] INT IDENTITY(1,1) NOT NULL,
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(3000) NULL,
    [Solution] VARCHAR(3000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL,
    [function1] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_Tbl_IT_Br_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_Tbl_IT_Br_Master]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Br_Tag] VARCHAR(15) NULL,
    [Br_Name] VARCHAR(50) NULL,
    [Br_Type] VARCHAR(50) NULL,
    [Br_Region] NCHAR(10) NULL,
    [Br_Contact_Person] NCHAR(100) NULL,
    [Br_Address] NCHAR(150) NULL,
    [Br_Email] NCHAR(100) NULL,
    [Br_TelNo] NCHAR(100) NULL,
    [Br_Fax] NCHAR(100) NULL,
    [Br_Head] NCHAR(100) NULL,
    [Br_CellNo] NCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_Tbl_Request_Master0608
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_Tbl_Request_Master0608]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dept] VARCHAR(10) NULL,
    [Fld_Request] VARCHAR(50) NULL,
    [Fld_EmpCode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_terminal_brok_loss_140607
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_terminal_brok_loss_140607]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [Brokerage] MONEY NULL,
    [dt] VARCHAR(20) NULL,
    [uptime] VARCHAR(20) NULL,
    [Brk_Loss] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [issues] VARCHAR(50) NULL,
    [Exchanges] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.book1
-- --------------------------------------------------
CREATE TABLE [dbo].[book1]
(
    [Column 0] NVARCHAR(50) NULL,
    [Column 1] NVARCHAR(50) NULL,
    [Column 2] NVARCHAR(50) NULL,
    [Column 3] NVARCHAR(50) NULL,
    [Column 4] NVARCHAR(50) NULL,
    [Column 5] NVARCHAR(50) NULL,
    [Column 6] NVARCHAR(50) NULL,
    [acd] VARCHAR(20) NULL,
    [remark] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Book2
-- --------------------------------------------------
CREATE TABLE [dbo].[Book2]
(
    [A] VARCHAR(8000) NULL,
    [B] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Book2hrsolution
-- --------------------------------------------------
CREATE TABLE [dbo].[Book2hrsolution]
(
    [Category] VARCHAR(255) NULL,
    [Sub Category] VARCHAR(255) NULL,
    [Subject] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Book3
-- --------------------------------------------------
CREATE TABLE [dbo].[Book3]
(
    [Col001] VARCHAR(255) NULL,
    [Col002] VARCHAR(255) NULL,
    [Col003] VARCHAR(1132) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Book5
-- --------------------------------------------------
CREATE TABLE [dbo].[Book5]
(
    [BranchName] VARCHAR(255) NULL,
    [UserName] VARCHAR(255) NULL,
    [UserId] VARCHAR(255) NULL,
    [AccessCode] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branch
-- --------------------------------------------------
CREATE TABLE [dbo].[Branch]
(
    [ctclBranch_id] VARCHAR(255) NULL,
    [ctclBranch_BranchCode] VARCHAR(255) NULL,
    [ctclBranch_Segment] VARCHAR(255) NULL,
    [ctclBranch_address1] VARCHAR(255) NULL,
    [ctclBranch_address2] VARCHAR(255) NULL,
    [ctclBranch_address3] VARCHAR(255) NULL,
    [ctclBranch_city] VARCHAR(255) NULL,
    [ctclBranch_pincode] VARCHAR(255) NULL,
    [ctclBranch_state] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch_list
-- --------------------------------------------------
CREATE TABLE [dbo].[branch_list]
(
    [BR_CODE] VARCHAR(255) NULL,
    [BR_NAME] VARCHAR(255) NULL,
    [SERVER] VARCHAR(255) NULL,
    [Server_IP] VARCHAR(255) NULL,
    [Database_IP] VARCHAR(255) NULL,
    [MANAGER_ID] VARCHAR(255) NULL,
    [SEGMENT] VARCHAR(255) NULL,
    [ACTIVATION_DATE] VARCHAR(255) NULL,
    [DEACTIVATION_DATE] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branch_Master_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Branch_Master_New]
(
    [TAG] VARCHAR(255) NULL,
    [BRANCH_NAME] VARCHAR(255) NULL,
    [Regional_HUB] VARCHAR(255) NULL,
    [IT_Category] VARCHAR(255) NULL,
    [IT_Support] VARCHAR(255) NULL,
    [E-mail_ids] VARCHAR(255) NULL,
    [TEL] VARCHAR(255) NULL,
    [FAX] VARCHAR(255) NULL,
    [BRANCH_HEAD] VARCHAR(255) NULL,
    [MOBILE] VARCHAR(255) NULL,
    [E-MAIL] VARCHAR(255) NULL,
    [X] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branch_new
-- --------------------------------------------------
CREATE TABLE [dbo].[branch_new]
(
    [TAG] VARCHAR(255) NULL,
    [BRANCH_NAME] VARCHAR(255) NULL,
    [REGIONAL_HUB] VARCHAR(255) NULL,
    [CATEOGRY] VARCHAR(255) NULL,
    [IT_SUPPORT] VARCHAR(255) NULL,
    [BRANCH ADDRESS] VARCHAR(255) NULL,
    [MAIL] VARCHAR(255) NULL,
    [TEL] VARCHAR(255) NULL,
    [FAX] VARCHAR(255) NULL,
    [BRANCH_HEAD] VARCHAR(255) NULL,
    [MOBILE] VARCHAR(255) NULL,
    [MAIL_Id] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Brokerage_Loss
-- --------------------------------------------------
CREATE TABLE [dbo].[Brokerage_Loss]
(
    [location] VARCHAR(255) NULL,
    [downtime] INT NULL,
    [pecentage] DECIMAL(38, 6) NULL,
    [brok_loss] MONEY NOT NULL,
    [Total] DECIMAL(38, 6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Brokerage_Sauda_Date
-- --------------------------------------------------
CREATE TABLE [dbo].[Brokerage_Sauda_Date]
(
    [Sauda_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.brokerage020309
-- --------------------------------------------------
CREATE TABLE [dbo].[brokerage020309]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [ACPLMCD] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [ACDXNSX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bse
-- --------------------------------------------------
CREATE TABLE [dbo].[bse]
(
    [bseid] INT IDENTITY(1,1) NOT NULL,
    [txt1] INT NOT NULL DEFAULT 0,
    [txt2] INT NOT NULL DEFAULT 0,
    [txt3] INT NOT NULL DEFAULT 0,
    [txt4] INT NOT NULL DEFAULT 0,
    [txt5] INT NOT NULL DEFAULT 0,
    [txt6] INT NOT NULL DEFAULT 0,
    [txt7] INT NOT NULL DEFAULT 0,
    [txt8] INT NOT NULL DEFAULT 0,
    [txt9] INT NOT NULL DEFAULT 0
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bus_tag
-- --------------------------------------------------
CREATE TABLE [dbo].[Bus_tag]
(
    [TAG] VARCHAR(255) NULL,
    [Cat] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cal_Apr
-- --------------------------------------------------
CREATE TABLE [dbo].[Cal_Apr]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cal_jan
-- --------------------------------------------------
CREATE TABLE [dbo].[Cal_jan]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CALCDEC
-- --------------------------------------------------
CREATE TABLE [dbo].[CALCDEC]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Calendar
-- --------------------------------------------------
CREATE TABLE [dbo].[Calendar]
(
    [gc_AllDayEvent] CHAR(1) NULL,
    [gc_BillingInformation] VARCHAR(256) NULL,
    [gc_Body] TEXT NULL,
    [gc_BusyStatus] INT NULL,
    [gc_Categories] VARCHAR(256) NULL,
    [gc_Companies] VARCHAR(256) NULL,
    [gc_Duration] INT NULL,
    [gc_End] DATETIME NULL,
    [gc_Importance] INT NULL,
    [gc_InternetCodepage] INT NULL,
    [gc_IsOnlineMeeting] CHAR(1) NULL,
    [gc_Location] VARCHAR(256) NULL,
    [gc_MeetingStatus] INT NULL,
    [gc_MessageClassFormDescription] VARCHAR(256) NULL,
    [gc_Mileage] VARCHAR(256) NULL,
    [gc_NetmeetingServer] VARCHAR(256) NULL,
    [gc_NetMeetingAutoStart] CHAR(1) NULL,
    [gc_NetMeetingDocPathName] VARCHAR(256) NULL,
    [gc_NetMeetingOrganizerAlias] VARCHAR(256) NULL,
    [gc_NetMeetingType] INT NULL,
    [gc_NetShowURL] VARCHAR(256) NULL,
    [gc_NoAging] CHAR(1) NULL,
    [gc_OptionalAttendees] VARCHAR(256) NULL,
    [gc_Organizer] VARCHAR(256) NULL,
    [gc_ReminderMinutesBeforeStart] INT NULL,
    [gc_ReminderOverrideDefault] CHAR(1) NULL,
    [gc_ReminderPlaySound] CHAR(1) NULL,
    [gc_ReminderSet] CHAR(1) NULL,
    [gc_ReminderSoundFile] VARCHAR(256) NULL,
    [gc_ReplyTime] DATETIME NULL,
    [gc_RequiredAttendees] VARCHAR(256) NULL,
    [gc_Resources] VARCHAR(256) NULL,
    [gc_ResponseRequested] CHAR(1) NULL,
    [gc_Sensitivity] INT NULL,
    [gc_Start] DATETIME NULL,
    [gc_Subject] VARCHAR(256) NULL,
    [gc_Unread] CHAR(1) NULL,
    [gc_id] UNIQUEIDENTIFIER NOT NULL,
    [gc_RecurrencePattern] VARCHAR(100) NULL,
    [gc_LastModificationTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CalNov
-- --------------------------------------------------
CREATE TABLE [dbo].[CalNov]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.cat
-- --------------------------------------------------
CREATE TABLE [dbo].[cat]
(
    [DeptNo] VARCHAR(255) NULL,
    [Mainlink] VARCHAR(255) NULL,
    [Sublink] VARCHAR(255) NULL,
    [ProblemNature] VARCHAR(255) NULL,
    [Solutions] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cat_item
-- --------------------------------------------------
CREATE TABLE [dbo].[Cat_item]
(
    [Deptno] VARCHAR(40) NULL,
    [Category] VARCHAR(25) NULL,
    [Cat_item] VARCHAR(25) NULL,
    [Cat_item_name] VARCHAR(50) NULL,
    [Cat_alter_item_name] VARCHAR(50) NULL,
    [cat_email] VARCHAR(100) NULL,
    [cat_phone] VARCHAR(50) NULL,
    [cat_city] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Cat_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[Cat_mast]
(
    [Category] VARCHAR(100) NULL,
    [Deptno] VARCHAR(40) NULL,
    [sr_no] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHAPTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CHAPTER]
(
    [BOOK_ISBN] VARCHAR(50) NOT NULL,
    [IDX] INT NOT NULL,
    [TITLE] VARCHAR(100) NOT NULL,
    [NUM_OF_PAGES] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Details]
(
    [BuySell] VARCHAR(5000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.color
-- --------------------------------------------------
CREATE TABLE [dbo].[color]
(
    [Cust] VARCHAR(25) NULL,
    [Product] VARCHAR(20) NULL,
    [QTY] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.complaint_table_11jan2005
-- --------------------------------------------------
CREATE TABLE [dbo].[complaint_table_11jan2005]
(
    [complaint_date] DATETIME NULL,
    [department] VARCHAR(50) NULL,
    [dsection] VARCHAR(20) NULL,
    [queryfrom] VARCHAR(50) NULL,
    [contact_person] VARCHAR(50) NULL,
    [problem] VARCHAR(600) NULL,
    [suggestion] VARCHAR(600) NULL,
    [completed_on] DATETIME NULL,
    [completed_remark] VARCHAR(150) NULL,
    [grade] CHAR(10) NULL,
    [helpdeskMarkcompleted] CHAR(10) NULL,
    [helpdeskmarkcompleteddate] DATETIME NULL,
    [status] CHAR(10) NULL,
    [complaintno] VARCHAR(50) NULL,
    [code] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [category] VARCHAR(15) NULL,
    [deptmarkcompleted] CHAR(10) NULL,
    [deptmarkcompleteddate] DATETIME NULL,
    [Remark] VARCHAR(600) NULL,
    [dstatus] VARCHAR(50) NULL,
    [dremark] VARCHAR(600) NULL,
    [emailid] VARCHAR(70) NULL,
    [phone] VARCHAR(50) NULL,
    [entry_by] VARCHAR(20) NULL,
    [subject] VARCHAR(100) NULL,
    [entered_through] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.complaint_table_Feedback
-- --------------------------------------------------
CREATE TABLE [dbo].[complaint_table_Feedback]
(
    [complaint_date] DATETIME NULL,
    [department] VARCHAR(50) NULL,
    [dsection] VARCHAR(20) NULL,
    [queryfrom] VARCHAR(250) NULL,
    [contact_person] VARCHAR(250) NULL,
    [problem] VARCHAR(5000) NULL,
    [suggestion] VARCHAR(5000) NULL,
    [completed_on] DATETIME NULL,
    [completed_remark] VARCHAR(150) NULL,
    [grade] CHAR(10) NULL,
    [helpdeskMarkcompleted] CHAR(10) NULL,
    [helpdeskmarkcompleteddate] DATETIME NULL,
    [status] CHAR(10) NULL,
    [complaintno] VARCHAR(50) NULL,
    [code] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [category] VARCHAR(15) NULL,
    [deptmarkcompleted] CHAR(10) NULL,
    [deptmarkcompleteddate] DATETIME NULL,
    [Remark] VARCHAR(600) NULL,
    [dstatus] VARCHAR(50) NULL,
    [dremark] VARCHAR(600) NULL,
    [emailid] VARCHAR(70) NULL,
    [phone] VARCHAR(250) NULL,
    [entry_by] VARCHAR(20) NULL,
    [subject] VARCHAR(500) NULL,
    [entered_through] VARCHAR(15) NULL,
    [time_limit] VARCHAR(15) NULL,
    [forwardto_dept] VARCHAR(100) NULL,
    [mark_complete] VARCHAR(5) NULL,
    [Call_type] VARCHAR(200) NULL,
    [Grp_Id] VARCHAR(50) NULL,
    [Attachment] VARCHAR(1000) NULL,
    [it_cat] VARCHAR(50) NULL,
    [it_subcat] VARCHAR(50) NULL,
    [it_conn] VARCHAR(50) NULL,
    [Wrong_Entry] CHAR(10) NULL,
    [City] VARCHAR(100) NULL,
    [Fld_Backup] VARCHAR(100) NULL,
    [Fld_Con_Time] VARCHAR(15) NULL,
    [Fld_Courtesy_Call_Type] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.complaint_table24nov2005
-- --------------------------------------------------
CREATE TABLE [dbo].[complaint_table24nov2005]
(
    [complaint_date] DATETIME NULL,
    [department] VARCHAR(50) NULL,
    [dsection] VARCHAR(20) NULL,
    [queryfrom] VARCHAR(50) NULL,
    [contact_person] VARCHAR(50) NULL,
    [problem] VARCHAR(600) NULL,
    [suggestion] VARCHAR(600) NULL,
    [completed_on] DATETIME NULL,
    [completed_remark] VARCHAR(150) NULL,
    [grade] CHAR(10) NULL,
    [helpdeskMarkcompleted] CHAR(10) NULL,
    [helpdeskmarkcompleteddate] DATETIME NULL,
    [status] CHAR(10) NULL,
    [complaintno] VARCHAR(50) NULL,
    [code] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [category] VARCHAR(15) NULL,
    [deptmarkcompleted] CHAR(10) NULL,
    [deptmarkcompleteddate] DATETIME NULL,
    [Remark] VARCHAR(600) NULL,
    [dstatus] VARCHAR(50) NULL,
    [dremark] VARCHAR(600) NULL,
    [emailid] VARCHAR(70) NULL,
    [phone] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTACTS
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTACTS]
(
    [OCS_ID] UNIQUEIDENTIFIER NOT NULL,
    [OCS_SENSITIVITY] INT NULL,
    [OCS_IMPORTANCE] CHAR(1) NULL,
    [OCS_BILLINGINFORMATION] VARCHAR(32) NULL,
    [OCS_MILEAGE] DECIMAL(16, 3) NULL,
    [OCS_NOAGING] CHAR(1) NULL,
    [OCS_INITIALS] VARCHAR(32) NULL,
    [OCS_FIRSTNAME] VARCHAR(128) NULL,
    [OCS_MIDDLENAME] VARCHAR(128) NULL,
    [OCS_LASTNAME] VARCHAR(128) NULL,
    [OCS_SUFFIX] VARCHAR(32) NULL,
    [OCS_FULLNAME] VARCHAR(256) NULL,
    [OCS_FILEAS] VARCHAR(256) NULL,
    [OCS_JOBTITLE] VARCHAR(64) NULL,
    [OCS_COMPANYNAME] VARCHAR(64) NULL,
    [OCS_DEPARTMENT] VARCHAR(64) NULL,
    [OCS_GENDER] CHAR(1) NULL,
    [OCS_SELECTEDMAILINGADDRESS] CHAR(1) NULL,
    [OCS_ACCOUNT] VARCHAR(32) NULL,
    [OCS_ANNIVERSARY] VARCHAR(32) NULL,
    [OCS_BIRTHDAY] DATETIME NULL,
    [OCS_ASSISTANTNAME] VARCHAR(256) NULL,
    [OCS_CHILDREN] VARCHAR(128) NULL,
    [OCS_COMPUTERNETWORKNAME] VARCHAR(20) NULL,
    [OCS_FTPSITE] VARCHAR(256) NULL,
    [OCS_CUSTOMERID] VARCHAR(32) NULL,
    [OCS_GOVERNMENTID] VARCHAR(32) NULL,
    [OCS_ORGANIZATIONID] VARCHAR(32) NULL,
    [OCS_HOBBY] VARCHAR(64) NULL,
    [OCS_INETFREEBUSSY] VARCHAR(256) NULL,
    [OCS_JOURNAL] CHAR(1) NULL,
    [OCS_LANGUAGE] VARCHAR(32) NULL,
    [OCS_MANAGERNAME] VARCHAR(256) NULL,
    [OCS_NETMEETINGALIAS] VARCHAR(128) NULL,
    [OCS_NETMEETINGSERVER] VARCHAR(256) NULL,
    [OCS_NICKNAME] VARCHAR(128) NULL,
    [OCS_OFFICELOCATION] VARCHAR(64) NULL,
    [OCS_PERSONALHOMEPAGE] VARCHAR(256) NULL,
    [OCS_PROFESSION] VARCHAR(64) NULL,
    [OCS_REFERREDBY] VARCHAR(256) NULL,
    [OCS_SPOUCE] VARCHAR(256) NULL,
    [OCS_WEBPAGE] VARCHAR(256) NULL,
    [OCS_CATEGORY] VARCHAR(64) NULL,
    [OCS_BUSINESS_CITY] VARCHAR(64) NULL,
    [OCS_BUSINESS_COUNTRY] VARCHAR(32) NULL,
    [OCS_BUSINESS_POSTALCODE] VARCHAR(8) NULL,
    [OCS_BUSINESS_POSTOFFICEBOX] VARCHAR(16) NULL,
    [OCS_BUSINESS_STATE] VARCHAR(32) NULL,
    [OCS_BUSINESS_STREET] VARCHAR(64) NULL,
    [OCS_BUSINESS_FAX] VARCHAR(32) NULL,
    [OCS_BUSINESS_HOMEPAGE] VARCHAR(256) NULL,
    [OCS_BUSINESS_TELEPHONE] VARCHAR(32) NULL,
    [OCS_BUSINESS_TELEPHONE2] VARCHAR(32) NULL,
    [OCS_EMAIL1ADDRESS] VARCHAR(128) NULL,
    [OCS_EMAIL1ADDRESSTYPE] VARCHAR(64) NULL,
    [OCS_EMAIL2ADDRESS] VARCHAR(128) NULL,
    [OCS_EMAIL2ADDRESS_TYPE] VARCHAR(64) NULL,
    [OCS_EMAIL3ADDRESS] VARCHAR(128) NULL,
    [OCS_EMAIL3ADDRESS_TYPE] VARCHAR(64) NULL,
    [OCS_HOME_CITY] VARCHAR(64) NULL,
    [OCS_HOME_COUNTRY] VARCHAR(32) NULL,
    [OCS_HOME_POSTALCODE] VARCHAR(8) NULL,
    [OCS_HOME_POSTOFFICEBOX] VARCHAR(16) NULL,
    [OCS_HOME_STATE] VARCHAR(32) NULL,
    [OCS_HOME_STREET] VARCHAR(64) NULL,
    [OCS_HOME_FAX] VARCHAR(32) NULL,
    [OCS_HOME_TELEPHONE] VARCHAR(32) NULL,
    [OCS_HOME_TELEPHONE2] VARCHAR(32) NULL,
    [OCS_OTHER_CITY] VARCHAR(64) NULL,
    [OCS_OTHER_COUNTRY] VARCHAR(32) NULL,
    [OCS_OTHER_POSTALCODE] VARCHAR(8) NULL,
    [OCS_OTHER_POSTOFFICEBOX] VARCHAR(16) NULL,
    [OCS_OTHER_STATE] VARCHAR(32) NULL,
    [OCS_OTHER_STREET] VARCHAR(64) NULL,
    [OCS_OTHER_FAX] VARCHAR(32) NULL,
    [OCS_OTHER_TELEPHONE] VARCHAR(32) NULL,
    [OCS_ASSISTANTTELEPHONE] VARCHAR(32) NULL,
    [OCS_BODY] TEXT NULL,
    [OCS_CALLBACKTELEPHONE] VARCHAR(32) NULL,
    [OCS_CARTELEPHONE] VARCHAR(32) NULL,
    [OCS_COMPANYMAINTELEPHONE] VARCHAR(32) NULL,
    [OCS_ISDNNUMBER] VARCHAR(32) NULL,
    [OCS_MOBILEPHONE] VARCHAR(32) NULL,
    [OCS_USERCERTIFICATE] VARCHAR(128) NULL,
    [OCS_UNREAD] CHAR(1) NULL,
    [OCS_TITLE] VARCHAR(50) NULL,
    [OCS_USER1] VARCHAR(50) NULL,
    [OCS_USER2] VARCHAR(50) NULL,
    [OCS_TTYTDD] VARCHAR(50) NULL,
    [OCS_RADIOTELEPHONE] VARCHAR(50) NULL,
    [OCS_TELEX] VARCHAR(50) NULL,
    [OCS_PAGER] VARCHAR(50) NULL,
    [OCS_PRIMARYTELEPHONE] VARCHAR(50) NULL,
    [gc_LastModificationTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Critical_mail
-- --------------------------------------------------
CREATE TABLE [dbo].[Critical_mail]
(
    [gc_AlternateRecipientAllowed] CHAR(1) NULL,
    [gc_AutoForwarded] CHAR(1) NULL,
    [gc_BCC] VARCHAR(1700) NULL,
    [gc_BillingInformation] VARCHAR(256) NULL,
    [gc_Categories] VARCHAR(256) NULL,
    [gc_CC] VARCHAR(1700) NULL,
    [gc_Companies] VARCHAR(256) NULL,
    [gc_CreationTime] DATETIME NULL,
    [gc_DeferredDeliveryTime] DATETIME NULL,
    [gc_DeleteAfterSubmit] CHAR(1) NULL,
    [gc_ExpiryTime] DATETIME NULL,
    [gc_FlagDueBy] DATETIME NULL,
    [gc_FlagRequest] VARCHAR(100) NULL,
    [gc_FlagStatus] INT NULL,
    [gc_HTMLBody] TEXT NULL,
    [gc_Importance] INT NULL,
    [gc_InternetCodepage] INT NULL,
    [gc_Mileage] VARCHAR(100) NULL,
    [gc_NoAging] CHAR(1) NULL,
    [gc_OriginatorDeliveryReportRequested] CHAR(1) NULL,
    [gc_ReadReceiptRequested] CHAR(1) NULL,
    [gc_ReceivedByName] VARCHAR(150) NULL,
    [gc_ReceivedOnBehalfOfName] VARCHAR(150) NULL,
    [gc_RecipientReassignmentProhibited] CHAR(1) NULL,
    [gc_RemoteStatus] INT NULL,
    [gc_ReplyRecipientNames] VARCHAR(256) NULL,
    [gc_SenderEmailAddress] VARCHAR(256) NULL,
    [gc_SenderEmailType] VARCHAR(100) NULL,
    [gc_SenderName] VARCHAR(150) NULL,
    [gc_Sensitivity] INT NULL,
    [gc_SentOn] DATETIME NULL,
    [gc_SentOnBehalfOfName] VARCHAR(150) NULL,
    [gc_Subject] VARCHAR(256) NULL,
    [gc_To] VARCHAR(1700) NULL,
    [gc_Unread] CHAR(1) NULL,
    [gc_ReceivedTime] DATETIME NULL,
    [gc_guid] UNIQUEIDENTIFIER NOT NULL,
    [gc_LastModificationTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.csvtest
-- --------------------------------------------------
CREATE TABLE [dbo].[csvtest]
(
    [Firstname] VARCHAR(50) NULL,
    [Lastname] VARCHAR(50) NULL,
    [age] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CTCL_
-- --------------------------------------------------
CREATE TABLE [dbo].[CTCL_]
(
    [Ctcl_Id] VARCHAR(255) NULL,
    [Ctcl_CtclBranchId] VARCHAR(255) NULL,
    [Ctcl_BranchId] VARCHAR(255) NULL,
    [Ctcl_OdinID] VARCHAR(255) NULL,
    [Ctcl_OffNature] VARCHAR(255) NULL,
    [Ctcl_PanNo] VARCHAR(255) NULL,
    [Ctcl_Lineid] VARCHAR(255) NULL,
    [Ctcl_LineMode] VARCHAR(255) NULL,
    [Ctcl_ApprovedPerson] VARCHAR(255) NULL,
    [Ctcl_FatherName] VARCHAR(255) NULL,
    [Ctcl_DOB] VARCHAR(255) NULL,
    [Ctcl_ContactPerson] VARCHAR(255) NULL,
    [Ctcl_Designation] VARCHAR(255) NULL,
    [Ctcl_Phoneno] VARCHAR(255) NULL,
    [Ctcl_Fax] VARCHAR(255) NULL,
    [Ctcl_Mailid] VARCHAR(255) NULL,
    [Ctcl_SEBINO] VARCHAR(255) NULL,
    [Ctcl_SubBrokerName] VARCHAR(255) NULL,
    [Ctcl_AuthPerson] VARCHAR(255) NULL,
    [Ctcl_MapinNo] VARCHAR(255) NULL,
    [Ctcl_Address1] VARCHAR(255) NULL,
    [Ctcl_Address2] VARCHAR(255) NULL,
    [Ctcl_Address3] VARCHAR(255) NULL,
    [Ctcl_ResAddress1] VARCHAR(255) NULL,
    [Ctcl_ResAddress2] VARCHAR(255) NULL,
    [Ctcl_ResAddress3] VARCHAR(255) NULL,
    [Ctcl_ResAddress4] VARCHAR(255) NULL,
    [Ctcl_ResAddress5] VARCHAR(255) NULL,
    [Ctcl_PerAddress1] VARCHAR(255) NULL,
    [Ctcl_PerAddress2] VARCHAR(255) NULL,
    [Ctcl_PerAddress3] VARCHAR(255) NULL,
    [Ctcl_PerAddress4] VARCHAR(255) NULL,
    [Ctcl_PerAddress5] VARCHAR(255) NULL,
    [Ctcl_Relation] VARCHAR(255) NULL,
    [Ctcl_TerminalID] VARCHAR(255) NULL,
    [Ctcl_AllotDate] VARCHAR(255) NULL,
    [Ctcl_DisablingDate] VARCHAR(255) NULL,
    [Ctcl_PayNature] VARCHAR(255) NULL,
    [Ctcl_Regno] VARCHAR(255) NULL,
    [Ctcl_RegValidDate] VARCHAR(255) NULL,
    [Ctcl_Purpose] VARCHAR(255) NULL,
    [Ctcl_Status] VARCHAR(255) NULL,
    [Ctcl_ChangedId] VARCHAR(255) NULL,
    [Ctcl_MFileId] VARCHAR(255) NULL,
    [Ctcl_TFileId] VARCHAR(255) NULL,
    [Ctcl_MemAccept] VARCHAR(255) NULL,
    [Ctcl_TermAccept] VARCHAR(255) NULL,
    [Ctcl_NcfmRemarks] VARCHAR(255) NULL,
    [Created_By] VARCHAR(255) NULL,
    [Created_Date] VARCHAR(255) NULL,
    [Modified_By] VARCHAR(255) NULL,
    [Modified_Date] VARCHAR(255) NULL,
    [Ctcl_IBranch_type] VARCHAR(255) NULL,
    [Ctcl_IAdd1] VARCHAR(255) NULL,
    [Ctcl_IAdd2] VARCHAR(255) NULL,
    [Ctcl_IAdd3] VARCHAR(255) NULL,
    [Ctcl_IPin] VARCHAR(255) NULL,
    [Ctcl_ICity] VARCHAR(255) NULL,
    [Ctcl_IState] VARCHAR(255) NULL,
    [Ctcl_ISBType] VARCHAR(255) NULL,
    [Ctcl_ISBName] VARCHAR(255) NULL,
    [Ctcl_ISBRegNo] VARCHAR(255) NULL,
    [Ctcl_ISBRegdt] VARCHAR(255) NULL,
    [Ctcl_IAUType] VARCHAR(255) NULL,
    [Ctcl_IAUName] VARCHAR(255) NULL,
    [Ctcl_IAUdt] VARCHAR(255) NULL,
    [Ctcl_IRelation] VARCHAR(255) NULL,
    [Ctcl_ISBTag] VARCHAR(255) NULL,
    [Ctcl_Iverified] VARCHAR(255) NULL,
    [Ctcl_Approval_Status] VARCHAR(255) NULL,
    [Ctcl_SBRegister] VARCHAR(255) NULL,
    [Ctcl_APRegister] VARCHAR(255) NULL,
    [CTCL_Disablereason] VARCHAR(255) NULL,
    [CTCL_Angelpremises] VARCHAR(255) NULL,
    [CTCL_IBranch_cd] VARCHAR(255) NULL,
    [CTCL_AngEmpCode] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.customers
-- --------------------------------------------------
CREATE TABLE [dbo].[customers]
(
    [IID] INT IDENTITY(1,1) NOT NULL,
    [col0] VARCHAR(90) NULL,
    [col1] VARCHAR(90) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DATA1
-- --------------------------------------------------
CREATE TABLE [dbo].[DATA1]
(
    [DeptNo] VARCHAR(255) NULL,
    [Complaint] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL,
    [Dummy1] VARCHAR(255) NULL,
    [Dummy2] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Datacenter
-- --------------------------------------------------
CREATE TABLE [dbo].[Datacenter]
(
    [SrNo] VARCHAR(255) NULL,
    [Br_Tag] VARCHAR(255) NULL,
    [Br_Name] VARCHAR(255) NULL,
    [Br_Type] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML120001
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML120001]
(
    [Branches_Not_Updated] VARCHAR(100) NULL,
    [Br_Tag] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML125816
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML125816]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ClientBOId] VARCHAR(30) NOT NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NOT NULL,
    [Client_Type] CHAR(3) NOT NULL,
    [BranchId] VARCHAR(15) NULL,
    [SubBrokerId] VARCHAR(15) NOT NULL,
    [OutstandingDebitAmt] MONEY NOT NULL,
    [DebitDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML125842
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML125842]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ClientBOId] VARCHAR(30) NOT NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NOT NULL,
    [Client_Type] CHAR(3) NOT NULL,
    [BranchId] VARCHAR(15) NULL,
    [SubBrokerId] VARCHAR(15) NOT NULL,
    [OutstandingDebitAmt] MONEY NOT NULL,
    [DebitDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML125856
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML125856]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ClientBOId] VARCHAR(30) NOT NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NOT NULL,
    [Client_Type] CHAR(3) NOT NULL,
    [BranchId] VARCHAR(15) NULL,
    [SubBrokerId] VARCHAR(15) NOT NULL,
    [OutstandingDebitAmt] MONEY NOT NULL,
    [DebitDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML125901
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML125901]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ClientBOId] VARCHAR(30) NOT NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NOT NULL,
    [Client_Type] CHAR(3) NOT NULL,
    [BranchId] VARCHAR(15) NULL,
    [SubBrokerId] VARCHAR(15) NOT NULL,
    [OutstandingDebitAmt] MONEY NOT NULL,
    [DebitDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML125903
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML125903]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ClientBOId] VARCHAR(30) NOT NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NOT NULL,
    [Client_Type] CHAR(3) NOT NULL,
    [BranchId] VARCHAR(15) NULL,
    [SubBrokerId] VARCHAR(15) NOT NULL,
    [OutstandingDebitAmt] MONEY NOT NULL,
    [DebitDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML125912
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML125912]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ClientBOId] VARCHAR(30) NOT NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NOT NULL,
    [Client_Type] CHAR(3) NOT NULL,
    [BranchId] VARCHAR(15) NULL,
    [SubBrokerId] VARCHAR(15) NOT NULL,
    [OutstandingDebitAmt] MONEY NOT NULL,
    [DebitDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML130615
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML130615]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [ClientBOId] VARCHAR(30) NOT NULL,
    [ClientName] VARCHAR(100) NULL,
    [ClientCode] VARCHAR(50) NOT NULL,
    [Client_Type] CHAR(3) NOT NULL,
    [BranchId] VARCHAR(15) NULL,
    [SubBrokerId] VARCHAR(15) NOT NULL,
    [OutstandingDebitAmt] MONEY NOT NULL,
    [DebitDate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBA_TempHTML131639
-- --------------------------------------------------
CREATE TABLE [dbo].[DBA_TempHTML131639]
(
    [Branches_Not_Updated] VARCHAR(100) NULL,
    [Br_Tag] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Demo_formview
-- --------------------------------------------------
CREATE TABLE [dbo].[Demo_formview]
(
    [Name] VARCHAR(20) NULL,
    [Address] VARCHAR(20) NULL,
    [Phone] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.department_complaintmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[department_complaintmaster]
(
    [complaintno] VARCHAR(50) NULL,
    [status] VARCHAR(50) NULL,
    [completeddate] DATETIME NULL,
    [semicompleteddate] DATETIME NULL,
    [comments] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.department_master
-- --------------------------------------------------
CREATE TABLE [dbo].[department_master]
(
    [Dept_ID] INT IDENTITY(1,1) NOT NULL,
    [Dept_Name] VARCHAR(50) NOT NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.department_master17092010
-- --------------------------------------------------
CREATE TABLE [dbo].[department_master17092010]
(
    [Dept_ID] INT NOT NULL,
    [Dept_Name] VARCHAR(50) NOT NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.department_master18
-- --------------------------------------------------
CREATE TABLE [dbo].[department_master18]
(
    [Dept_ID] INT NOT NULL,
    [Dept_Name] VARCHAR(50) NOT NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.department_master251112010
-- --------------------------------------------------
CREATE TABLE [dbo].[department_master251112010]
(
    [Dept_ID] INT NOT NULL,
    [Dept_Name] VARCHAR(50) NOT NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.departmentmaster_new
-- --------------------------------------------------
CREATE TABLE [dbo].[departmentmaster_new]
(
    [deptno] VARCHAR(40) NULL,
    [departmentname] VARCHAR(50) NULL,
    [eff_from] DATETIME NULL,
    [eff_to] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dept_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[dept_mast]
(
    [Dept_ID] INT IDENTITY(1,1) NOT NULL,
    [Dept_Name] VARCHAR(50) NOT NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dept_master14
-- --------------------------------------------------
CREATE TABLE [dbo].[dept_master14]
(
    [Dept_ID] INT IDENTITY(1,1) NOT NULL,
    [Dept_Name] VARCHAR(50) NOT NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.deptinfo
-- --------------------------------------------------
CREATE TABLE [dbo].[deptinfo]
(
    [id] INT NOT NULL,
    [department] VARCHAR(50) NULL,
    [escalationlevel] VARCHAR(10) NULL,
    [responsiblePerson] VARCHAR(30) NULL,
    [PersonName] VARCHAR(150) NULL,
    [Work] VARCHAR(150) NULL,
    [email] VARCHAR(100) NULL,
    [contact] VARCHAR(50) NULL,
    [Mobile] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DP1
-- --------------------------------------------------
CREATE TABLE [dbo].[DP1]
(
    [Client id] VARCHAR(255) NULL,
    [NameofClient] VARCHAR(255) NULL,
    [DP] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Dt_011007
-- --------------------------------------------------
CREATE TABLE [dbo].[Dt_011007]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dtcal
-- --------------------------------------------------
CREATE TABLE [dbo].[dtcal]
(
    [Tdate] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dummy
-- --------------------------------------------------
CREATE TABLE [dbo].[dummy]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(1000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EBR
-- --------------------------------------------------
CREATE TABLE [dbo].[EBR]
(
    [DeptNo] VARCHAR(255) NULL,
    [Mainlink] VARCHAR(255) NULL,
    [Sublink] VARCHAR(255) NULL,
    [ProblemNature] VARCHAR(4000) NULL,
    [Solutions] VARCHAR(4000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EBR_FWD_MAST
-- --------------------------------------------------
CREATE TABLE [dbo].[EBR_FWD_MAST]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Dept] VARCHAR(50) NULL,
    [Category] VARCHAR(50) NULL,
    [Name] VARCHAR(50) NULL,
    [Email] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ELIMINATE_SERVER
-- --------------------------------------------------
CREATE TABLE [dbo].[ELIMINATE_SERVER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SERVERID] INT NULL,
    [SERVER_NAME] VARCHAR(10) NULL,
    [ELIMINATE_AFTER] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMPCODE_EMAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[EMPCODE_EMAIL]
(
    [FLD_EMPID] VARCHAR(50) NULL,
    [USERNAME] VARCHAR(20) NULL,
    [EMAIL] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.examtype
-- --------------------------------------------------
CREATE TABLE [dbo].[examtype]
(
    [Srno] VARCHAR(255) NULL,
    [ExamType] VARCHAR(255) NULL,
    [ExamFees] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Feedback_Emp_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Feedback_Emp_Details]
(
    [Name] VARCHAR(50) NULL,
    [Feedback_Username] VARCHAR(50) NULL,
    [EmpID] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fileupload
-- --------------------------------------------------
CREATE TABLE [dbo].[fileupload]
(
    [branch] VARCHAR(30) NULL,
    [manager] VARCHAR(20) NULL,
    [folder] VARCHAR(100) NULL,
    [date] VARCHAR(11) NULL,
    [time] VARCHAR(20) NULL,
    [ampm] VARCHAR(20) NULL,
    [filesize] VARCHAR(50) NULL,
    [filename] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FINAL_TAT_ESCALTION
-- --------------------------------------------------
CREATE TABLE [dbo].[FINAL_TAT_ESCALTION]
(
    [COMPLAINTID] VARCHAR(50) NULL,
    [RAISED_TO_DEPT] VARCHAR(50) NOT NULL,
    [RAISED_DATE] VARCHAR(11) NULL,
    [RAISED_BY_EMPNM] VARCHAR(150) NULL,
    [SUBJECT] VARCHAR(50) NULL,
    [COMPLAINT_DETAILS] VARCHAR(5000) NULL,
    [PENDING_SINCE_HOURS] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.fotrade
-- --------------------------------------------------
CREATE TABLE [dbo].[fotrade]
(
    [tradeno] VARCHAR(25) NULL,
    [ttype] VARCHAR(25) NULL,
    [scrip] VARCHAR(25) NULL,
    [scriptype] VARCHAR(25) NULL,
    [expdate] VARCHAR(25) NULL,
    [stkpricce] VARCHAR(25) NULL,
    [opttype] VARCHAR(25) NULL,
    [scripname] VARCHAR(100) NULL,
    [aa] VARCHAR(25) NULL,
    [bb] VARCHAR(25) NULL,
    [userid] VARCHAR(25) NULL,
    [location] VARCHAR(25) NULL,
    [bs] VARCHAR(25) NULL,
    [qty] VARCHAR(25) NULL,
    [price] VARCHAR(25) NULL,
    [cltype] VARCHAR(25) NULL,
    [clcode] VARCHAR(25) NULL,
    [brkcode] VARCHAR(25) NULL,
    [brktype] VARCHAR(25) NULL,
    [orderdate] VARCHAR(25) NULL,
    [tradedate] VARCHAR(25) NULL,
    [order_no] VARCHAR(25) NULL,
    [remarks] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.frwrd_reply_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[frwrd_reply_hist]
(
    [gc_sendername] VARCHAR(100) NULL,
    [gc_SUBJECT] VARCHAR(300) NULL,
    [GC_receivedtime] DATETIME NULL,
    [GC_GUID] VARCHAR(70) NOT NULL,
    [GC_HTMLBODY] TEXT NULL,
    [GC_senderemailaddress] VARCHAR(500) NULL,
    [GC_REPLY] TEXT NULL,
    [category] VARCHAR(30) NULL,
    [code] VARCHAR(15) NULL,
    [department] VARCHAR(35) NULL,
    [resolved] VARCHAR(5) NULL,
    [resolved_by] VARCHAR(50) NULL,
    [resolved_date] DATETIME NULL,
    [forwarded_to] VARCHAR(100) NULL,
    [srno] INT NOT NULL,
    [status] VARCHAR(50) NULL,
    [cc] VARCHAR(200) NULL,
    [bcc] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Group_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Group_Master]
(
    [Group_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grp
-- --------------------------------------------------
CREATE TABLE [dbo].[grp]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [grp] VARCHAR(50) NULL,
    [sbgrp] VARCHAR(50) NULL,
    [dept] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Helpdesk
-- --------------------------------------------------
CREATE TABLE [dbo].[Helpdesk]
(
    [SrNo] VARCHAR(255) NULL,
    [Function] VARCHAR(255) NULL,
    [Nature] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HELPDESKSEGMENTS
-- --------------------------------------------------
CREATE TABLE [dbo].[HELPDESKSEGMENTS]
(
    [SrNo] VARCHAR(255) NULL,
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.holidatlist
-- --------------------------------------------------
CREATE TABLE [dbo].[holidatlist]
(
    [Sr] FLOAT NULL,
    [Date] DATETIME NULL,
    [BSECM ] FLOAT NULL,
    [NSECM] FLOAT NULL,
    [NSEFO] FLOAT NULL,
    [NSECDS] FLOAT NULL,
    [MCX] FLOAT NULL,
    [MCXCDS] FLOAT NULL,
    [NCDEX] FLOAT NULL,
    [REMARK] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.holiday
-- --------------------------------------------------
CREATE TABLE [dbo].[holiday]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HR_sols
-- --------------------------------------------------
CREATE TABLE [dbo].[HR_sols]
(
    [SrNo] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Hrcomplaint
-- --------------------------------------------------
CREATE TABLE [dbo].[Hrcomplaint]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(1000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(100) NULL,
    [Fld_WIP_Fres] VARCHAR(25) NULL,
    [dummy] BIT NULL,
    [dummy1] BIT NULL,
    [dummy2] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.hrfaqsaddnew
-- --------------------------------------------------
CREATE TABLE [dbo].[hrfaqsaddnew]
(
    [Category] VARCHAR(255) NULL,
    [Sub_Category] VARCHAR(255) NULL,
    [Subject] VARCHAR(255) NULL,
    [New_Solution] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ID_temp_opt
-- --------------------------------------------------
CREATE TABLE [dbo].[ID_temp_opt]
(
    [ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.illScrip50
-- --------------------------------------------------
CREATE TABLE [dbo].[illScrip50]
(
    [Scrip_cd] VARCHAR(255) NULL,
    [ScripName] VARCHAR(255) NULL,
    [UpdDated] VARCHAR(255) NULL,
    [Month] VARCHAR(20) NULL,
    [Year] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.it
-- --------------------------------------------------
CREATE TABLE [dbo].[it]
(
    [srno] VARCHAR(15) NULL,
    [category] VARCHAR(150) NULL,
    [subcategory] VARCHAR(200) NULL,
    [problem] VARCHAR(1000) NULL,
    [solution] VARCHAR(1500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT$
-- --------------------------------------------------
CREATE TABLE [dbo].[IT$]
(
    [SrNo] FLOAT NULL,
    [Mainlink] NVARCHAR(255) NULL,
    [Sublink] NVARCHAR(255) NULL,
    [Problem] NVARCHAR(255) NULL,
    [Solution] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT_
-- --------------------------------------------------
CREATE TABLE [dbo].[IT_]
(
    [Date] VARCHAR(8000) NULL,
    [Location] VARCHAR(8000) NULL,
    [TimeFrom] VARCHAR(8000) NULL,
    [TimeTo] VARCHAR(8000) NULL,
    [Event Particulars] VARCHAR(8000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(8000) NULL,
    [Downtimeinminutes] VARCHAR(8000) NULL,
    [ImpactedSegment] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.it_1
-- --------------------------------------------------
CREATE TABLE [dbo].[it_1]
(
    [Date] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(255) NULL,
    [TimeTo] VARCHAR(255) NULL,
    [EventParticulars] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL,
    [Problem] VARCHAR(255) NULL,
    [Downtimeinminutes] VARCHAR(255) NULL,
    [ImpactedSegment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT_AddDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[IT_AddDetails]
(
    [site_code] NVARCHAR(15) NOT NULL,
    [location] NVARCHAR(50) NOT NULL,
    [default_gateway] NVARCHAR(20) NOT NULL,
    [subnet_mask] NVARCHAR(50) NOT NULL,
    [status] NVARCHAR(15) NOT NULL,
    [address] NVARCHAR(50) NOT NULL,
    [contact_person] NVARCHAR(20) NOT NULL,
    [email_id] NVARCHAR(20) NOT NULL,
    [c_branch] NVARCHAR(20) NOT NULL,
    [segment_eq] NVARCHAR(10) NOT NULL,
    [odin_u_id_eq] NVARCHAR(50) NOT NULL,
    [odin_u_id_comm] NVARCHAR(50) NOT NULL,
    [server_ip] NVARCHAR(30) NOT NULL,
    [relationship] NVARCHAR(20) NOT NULL,
    [connectivity] NVARCHAR(15) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.it_category
-- --------------------------------------------------
CREATE TABLE [dbo].[it_category]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [dept] VARCHAR(50) NULL,
    [category] VARCHAR(50) NULL,
    [sub_category] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.it_category1
-- --------------------------------------------------
CREATE TABLE [dbo].[it_category1]
(
    [srno] INT NULL,
    [dept] VARCHAR(20) NULL,
    [category] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.it_categorybak
-- --------------------------------------------------
CREATE TABLE [dbo].[it_categorybak]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [dept] VARCHAR(50) NULL,
    [category] VARCHAR(50) NULL,
    [sub_category] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[IT_Data]
(
    [Sr. No.] VARCHAR(255) NULL,
    [Date] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL,
    [Time From] VARCHAR(255) NULL,
    [Time To] VARCHAR(255) NULL,
    [Event Particulars] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL,
    [Problem] VARCHAR(255) NULL,
    [Downtime in minutes] VARCHAR(255) NULL,
    [Impacted Segment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT_DT
-- --------------------------------------------------
CREATE TABLE [dbo].[IT_DT]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT_Mast
-- --------------------------------------------------
CREATE TABLE [dbo].[IT_Mast]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Problem] VARCHAR(5000) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT_mast_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[IT_mast_bak]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Problem] VARCHAR(5000) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT_Reports_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[IT_Reports_Master]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Rpt_Name] VARCHAR(50) NULL,
    [Fld_Rpt_Url] VARCHAR(50) NULL,
    [Fld_Rpt_For] VARCHAR(50) NULL,
    [Fld_Frq] INT NULL,
    [Fld_Cut_off] VARCHAR(50) NULL,
    [Fld_Entry_By] VARCHAR(15) NULL,
    [Fld_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.it_sitecode
-- --------------------------------------------------
CREATE TABLE [dbo].[it_sitecode]
(
    [SiteCode] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL,
    [BranchTag] VARCHAR(50) NULL,
    [Connectivity] VARCHAR(255) NULL,
    [Relationship] VARCHAR(255) NULL,
    [DefaultGateway] VARCHAR(255) NULL,
    [SubnetMask] VARCHAR(255) NULL,
    [Status] VARCHAR(255) NULL,
    [PostalAddress] VARCHAR(255) NULL,
    [ContactPerson] VARCHAR(255) NULL,
    [ContactNo] VARCHAR(255) NULL,
    [Emailid] VARCHAR(255) NULL,
    [ConnectedWithBranch] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [NSE] VARCHAR(255) NULL,
    [NSEFO] VARCHAR(255) NULL,
    [BSEFO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDX] VARCHAR(255) NULL,
    [OdinUserIdEq] VARCHAR(255) NULL,
    [OdinUserIdComm] VARCHAR(255) NULL,
    [ServerIP] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT0106
-- --------------------------------------------------
CREATE TABLE [dbo].[IT0106]
(
    [Date] VARCHAR(255) NULL,
    [Server] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(255) NULL,
    [TimeTo] VARCHAR(255) NULL,
    [EventParticulars] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL,
    [TypeofProblem] VARCHAR(255) NULL,
    [ImpactedSegment] VARCHAR(255) NULL,
    [Downtime] VARCHAR(255) NULL,
    [Downtimeinminutes] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IT2$
-- --------------------------------------------------
CREATE TABLE [dbo].[IT2$]
(
    [SrNo] FLOAT NULL,
    [Mainlink] NVARCHAR(255) NULL,
    [Sublink] NVARCHAR(255) NULL,
    [Problem] NVARCHAR(255) NULL,
    [Solution] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.it2803
-- --------------------------------------------------
CREATE TABLE [dbo].[it2803]
(
    [Date] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(255) NULL,
    [TimeTo] VARCHAR(255) NULL,
    [EventParticulars] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL,
    [Problem] VARCHAR(255) NULL,
    [Downtimeinminutes] VARCHAR(255) NULL,
    [ImpactedSegment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.itasset_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[itasset_temp]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_ProductModel] VARCHAR(50) NULL,
    [Fld_ProductDesc] VARCHAR(50) NULL,
    [Fld_AssetName] VARCHAR(50) NULL,
    [Fld_PartNo] VARCHAR(50) NULL,
    [Fld_VendorName] VARCHAR(50) NULL,
    [Fld_Rate] VARCHAR(50) NULL,
    [Fld_WarrantyFrom] VARCHAR(50) NULL,
    [Fld_WarrantyTo] VARCHAR(50) NULL,
    [Fld_BranchCode] VARCHAR(50) NULL,
    [Fld_AssignToDept] VARCHAR(50) NULL,
    [Fld_BillNo] VARCHAR(50) NULL,
    [Fld_ChallanNo] VARCHAR(50) NULL,
    [Fld_Purpose] VARCHAR(50) NULL,
    [Fld_CapexName] VARCHAR(50) NULL,
    [Fld_WarrantyType] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITData25
-- --------------------------------------------------
CREATE TABLE [dbo].[ITData25]
(
    [Date] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(255) NULL,
    [TimeTo] VARCHAR(255) NULL,
    [EventParticulars] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL,
    [Problem] VARCHAR(255) NULL,
    [ImpactedSegment] VARCHAR(255) NULL,
    [downtime] VARCHAR(255) NULL,
    [Downtimeinminutes] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Itinc
-- --------------------------------------------------
CREATE TABLE [dbo].[Itinc]
(
    [Sr. No.] VARCHAR(8000) NULL,
    [Date] VARCHAR(8000) NULL,
    [Location] VARCHAR(8000) NULL,
    [Time From] VARCHAR(8000) NULL,
    [Time To] VARCHAR(8000) NULL,
    [Event Particulars] VARCHAR(8000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(8000) NULL,
    [Downtime in minutes] VARCHAR(8000) NULL,
    [Impacted Segemnt] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.itinci
-- --------------------------------------------------
CREATE TABLE [dbo].[itinci]
(
    [Date] VARCHAR(8000) NULL,
    [Location] VARCHAR(8000) NULL,
    [TimeFrom] VARCHAR(8000) NULL,
    [TimeTo] VARCHAR(8000) NULL,
    [EventParticulars] VARCHAR(8000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(8000) NULL,
    [Downtimeinminutes] VARCHAR(8000) NULL,
    [ImpactedSegemnt] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITIncidence
-- --------------------------------------------------
CREATE TABLE [dbo].[ITIncidence]
(
    [Date] VARCHAR(8000) NULL,
    [Location] VARCHAR(8000) NULL,
    [Time From] VARCHAR(8000) NULL,
    [Time To] VARCHAR(8000) NULL,
    [Event Particulars] VARCHAR(8000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(8000) NULL,
    [Impacted Segemnt] VARCHAR(8000) NULL,
    [Downtime in minutes] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ITrequesttemp
-- --------------------------------------------------
CREATE TABLE [dbo].[ITrequesttemp]
(
    [RequestType] VARCHAR(22) NULL,
    [Total] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.itsitecode
-- --------------------------------------------------
CREATE TABLE [dbo].[itsitecode]
(
    [SiteCode] VARCHAR(255) NULL,
    [BranchCode] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Journal
-- --------------------------------------------------
CREATE TABLE [dbo].[Journal]
(
    [gc_BillingInformation] VARCHAR(256) NULL,
    [gc_Body] TEXT NULL,
    [gc_Categories] VARCHAR(256) NULL,
    [gc_Companies] VARCHAR(256) NULL,
    [gc_ContactNames] VARCHAR(256) NULL,
    [gc_DocPosted] CHAR(1) NULL,
    [gc_DocPrinted] CHAR(1) NULL,
    [gc_DocRouted] CHAR(1) NULL,
    [gc_DocSaved] CHAR(1) NULL,
    [gc_Duration] INT NULL,
    [gc_End] DATETIME NULL,
    [gc_Importance] INT NULL,
    [gc_MessageClassFormDescription] VARCHAR(256) NULL,
    [gc_Mileage] VARCHAR(256) NULL,
    [gc_NoAging] CHAR(1) NULL,
    [gc_Recipients] VARCHAR(256) NULL,
    [gc_Sensitivity] INT NULL,
    [gc_Start] DATETIME NULL,
    [gc_Subject] VARCHAR(256) NULL,
    [gc_Type] VARCHAR(256) NULL,
    [gc_Unread] CHAR(1) NULL,
    [gc_id] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.JUly
-- --------------------------------------------------
CREATE TABLE [dbo].[JUly]
(
    [FDate] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [NSE] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.KYC
-- --------------------------------------------------
CREATE TABLE [dbo].[KYC]
(
    [KYC] VARCHAR(255) NULL,
    [ClientID] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.listoflocation
-- --------------------------------------------------
CREATE TABLE [dbo].[listoflocation]
(
    [SrNo] VARCHAR(255) NULL,
    [ListofLocations] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Location_Mast
-- --------------------------------------------------
CREATE TABLE [dbo].[Location_Mast]
(
    [locid] INT IDENTITY(1,1) NOT NULL,
    [Location] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Location_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Location_Master]
(
    [sub_category] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.login
-- --------------------------------------------------
CREATE TABLE [dbo].[login]
(
    [username] VARCHAR(10) NULL,
    [userpassword] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.logintable
-- --------------------------------------------------
CREATE TABLE [dbo].[logintable]
(
    [fldauto] INT NOT NULL,
    [fldpartycode] VARCHAR(40) NOT NULL,
    [fldpassword] VARCHAR(40) NOT NULL,
    [fldpasscheck] VARCHAR(40) NULL,
    [fldfavshare] VARCHAR(40) NULL,
    [fldfirstname] VARCHAR(50) NULL,
    [fldmidname] VARCHAR(40) NULL,
    [fldlastname] VARCHAR(40) NULL,
    [fldemail] VARCHAR(30) NULL,
    [fldbdate] VARCHAR(10) NULL,
    [fldgender] VARCHAR(7) NULL,
    [fldzip] VARCHAR(10) NULL,
    [fldcountry] VARCHAR(30) NULL,
    [fldstate] VARCHAR(20) NULL,
    [fldcity] VARCHAR(30) NULL,
    [fldaddress] VARCHAR(150) NULL,
    [fldphone1] VARCHAR(15) NULL,
    [fldphone2] VARCHAR(15) NULL,
    [abl_upd] DATETIME NULL,
    [acdl_upd] DATETIME NULL,
    [fo_upd] DATETIME NULL,
    [FLDDEPARTMENT] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.logintable_new
-- --------------------------------------------------
CREATE TABLE [dbo].[logintable_new]
(
    [fldauto] INT NOT NULL,
    [fldpartycode] VARCHAR(40) NOT NULL,
    [fldpassword] VARCHAR(40) NOT NULL,
    [fldpasscheck] VARCHAR(40) NULL,
    [fldfavshare] VARCHAR(40) NULL,
    [fldfirstname] VARCHAR(50) NULL,
    [fldmidname] VARCHAR(40) NULL,
    [fldlastname] VARCHAR(40) NULL,
    [fldemail] VARCHAR(30) NULL,
    [fldbdate] VARCHAR(10) NULL,
    [fldgender] VARCHAR(7) NULL,
    [fldzip] VARCHAR(10) NULL,
    [fldcountry] VARCHAR(30) NULL,
    [fldstate] VARCHAR(20) NULL,
    [fldcity] VARCHAR(30) NULL,
    [fldaddress] VARCHAR(150) NULL,
    [fldphone1] VARCHAR(15) NULL,
    [fldphone2] VARCHAR(15) NULL,
    [abl_upd] DATETIME NULL,
    [acdl_upd] DATETIME NULL,
    [fo_upd] DATETIME NULL,
    [FLDDEPARTMENT] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.logintablecopy
-- --------------------------------------------------
CREATE TABLE [dbo].[logintablecopy]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldpartycode] VARCHAR(40) NULL,
    [fldpassword] VARCHAR(40) NULL,
    [fldpasscheck] VARCHAR(40) NULL,
    [flddepartment] VARCHAR(50) NULL,
    [fldfirstname] VARCHAR(50) NULL,
    [fldmidname] VARCHAR(40) NULL,
    [fldlastname] VARCHAR(40) NULL,
    [category] VARCHAR(15) NULL,
    [emailid] VARCHAR(100) NULL,
    [phno] VARCHAR(50) NULL,
    [fldaddress] VARCHAR(120) NULL,
    [Sub_category] VARCHAR(50) NULL,
    [status] INT NOT NULL DEFAULT 0,
    [Emp_Code] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MAIL_HIST
-- --------------------------------------------------
CREATE TABLE [dbo].[MAIL_HIST]
(
    [gc_AlternateRecipientAllowed] CHAR(1) NULL,
    [gc_AutoForwarded] CHAR(1) NULL,
    [gc_BCC] VARCHAR(1700) NULL,
    [gc_BillingInformation] VARCHAR(256) NULL,
    [gc_Categories] VARCHAR(256) NULL,
    [gc_CC] VARCHAR(1700) NULL,
    [gc_Companies] VARCHAR(256) NULL,
    [gc_CreationTime] DATETIME NULL,
    [gc_DeferredDeliveryTime] DATETIME NULL,
    [gc_DeleteAfterSubmit] CHAR(1) NULL,
    [gc_ExpiryTime] DATETIME NULL,
    [gc_FlagDueBy] DATETIME NULL,
    [gc_FlagRequest] VARCHAR(100) NULL,
    [gc_FlagStatus] INT NULL,
    [gc_HTMLBody] TEXT NULL,
    [gc_Importance] INT NULL,
    [gc_InternetCodepage] INT NULL,
    [gc_Mileage] VARCHAR(100) NULL,
    [gc_NoAging] CHAR(1) NULL,
    [gc_OriginatorDeliveryReportRequested] CHAR(1) NULL,
    [gc_ReadReceiptRequested] CHAR(1) NULL,
    [gc_ReceivedByName] VARCHAR(150) NULL,
    [gc_ReceivedOnBehalfOfName] VARCHAR(150) NULL,
    [gc_RecipientReassignmentProhibited] CHAR(1) NULL,
    [gc_RemoteStatus] INT NULL,
    [gc_ReplyRecipientNames] VARCHAR(256) NULL,
    [gc_SenderEmailAddress] VARCHAR(256) NULL,
    [gc_SenderEmailType] VARCHAR(100) NULL,
    [gc_SenderName] VARCHAR(150) NULL,
    [gc_Sensitivity] INT NULL,
    [gc_SentOn] DATETIME NULL,
    [gc_SentOnBehalfOfName] VARCHAR(150) NULL,
    [gc_Subject] VARCHAR(256) NULL,
    [gc_To] VARCHAR(1700) NULL,
    [gc_Unread] CHAR(1) NULL,
    [gc_ReceivedTime] DATETIME NULL,
    [gc_guid] UNIQUEIDENTIFIER NOT NULL,
    [gc_LastModificationTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mail_totaldata
-- --------------------------------------------------
CREATE TABLE [dbo].[Mail_totaldata]
(
    [ComplaintId] VARCHAR(100) NULL,
    [Subject] VARCHAR(500) NULL,
    [mailto] VARCHAR(1000) NULL,
    [mailcc] VARCHAR(1000) NULL,
    [Message_1] VARCHAR(5000) NULL,
    [repliedby] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MailAttachment
-- --------------------------------------------------
CREATE TABLE [dbo].[MailAttachment]
(
    [gc_parent_guid] UNIQUEIDENTIFIER NOT NULL,
    [gc_attach_number] INT NOT NULL,
    [GC_ATTACH_FILENAME] VARCHAR(100) NULL,
    [GC_ATTACH_LONG_FILENAME] VARCHAR(100) NULL,
    [GC_ATTACH_METHOD] INT NULL,
    [GC_ATTACH_MIME_TAG] VARCHAR(200) NULL,
    [GC_RENDERING_POSITION] INT NULL,
    [GC_ATTACH_CONTENT_LOCATION] VARCHAR(200) NULL,
    [GC_ATTACH_BINARY] IMAGE NULL,
    [GC_ATTACH_CONTENT_ID] VARCHAR(200) NULL,
    [GC_ATTACH_FULL_PATH_AND_NAME] VARCHAR(400) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Maildata
-- --------------------------------------------------
CREATE TABLE [dbo].[Maildata]
(
    [To_mail] VARCHAR(20) NULL,
    [Cc_mail] VARCHAR(20) NULL,
    [message_send] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Maildata_1
-- --------------------------------------------------
CREATE TABLE [dbo].[Maildata_1]
(
    [To_mail] VARCHAR(200) NULL,
    [Cc_mail] VARCHAR(200) NULL,
    [message_send] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mailreader1
-- --------------------------------------------------
CREATE TABLE [dbo].[mailreader1]
(
    [FromHeader] VARCHAR(150) NULL,
    [SubjectHeader] VARCHAR(500) NULL,
    [DateHeader] VARCHAR(22) NOT NULL,
    [Unread] VARCHAR(500) NULL,
    [Message] VARCHAR(8000) NULL,
    [CC] VARCHAR(50) NULL,
    [Dummy1] VARCHAR(50) NULL,
    [Dummy2] VARCHAR(500) NULL,
    [ProfileName] VARCHAR(500) NULL,
    [attachment] VARCHAR(500) NULL,
    [Solutions] VARCHAR(8000) NULL,
    [Status] CHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Manager_Cert
-- --------------------------------------------------
CREATE TABLE [dbo].[Manager_Cert]
(
    [Server_name] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL,
    [CTCL_ID] VARCHAR(255) NULL,
    [Start_Date] VARCHAR(255) NULL,
    [End_Date] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.May2008
-- --------------------------------------------------
CREATE TABLE [dbo].[May2008]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Menu_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Menu_Master]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [fld_Menu] VARCHAR(50) NULL,
    [fld_Sub_Menu] VARCHAR(50) NULL,
    [fld_Sub_Menu_Item] VARCHAR(50) NULL,
    [fld_Link] VARCHAR(50) NULL,
    [fld_Dept] VARCHAR(50) NULL,
    [fld_Location] VARCHAR(50) NULL,
    [fld_Category] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mis_terminal_brok
-- --------------------------------------------------
CREATE TABLE [dbo].[mis_terminal_brok]
(
    [company] VARCHAR(10) NULL,
    [terminal_id] VARCHAR(10) NULL,
    [sauda_Date] DATETIME NULL,
    [turnover] MONEY NULL,
    [Brokerage] MONEY NULL,
    [TO_Trd_Fut] MONEY NULL,
    [TO_Del_Opt] MONEY NULL,
    [BK_Trd_Fut] MONEY NULL,
    [BK_Del_Opt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.na
-- --------------------------------------------------
CREATE TABLE [dbo].[na]
(
    [CKT ID NO:] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.na1
-- --------------------------------------------------
CREATE TABLE [dbo].[na1]
(
    [CKDIDNO] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NCFM_Date_Upload
-- --------------------------------------------------
CREATE TABLE [dbo].[NCFM_Date_Upload]
(
    [Day] VARCHAR(50) NULL,
    [Date] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.New$
-- --------------------------------------------------
CREATE TABLE [dbo].[New$]
(
    [Date] NVARCHAR(255) NULL,
    [Location] NVARCHAR(255) NULL,
    [Time From] NVARCHAR(255) NULL,
    [Time To] NVARCHAR(255) NULL,
    [Event Particulars] NVARCHAR(255) NULL,
    [Solution] NVARCHAR(255) NULL,
    [Problem] NVARCHAR(255) NULL,
    [Impacted Segemnt] NVARCHAR(255) NULL,
    [Downtime in minutes] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtab_back
-- --------------------------------------------------
CREATE TABLE [dbo].[newtab_back]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Type] VARCHAR(50) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NewTAb1
-- --------------------------------------------------
CREATE TABLE [dbo].[NewTAb1]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Type] VARCHAR(50) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Newtab1_1Aug2011
-- --------------------------------------------------
CREATE TABLE [dbo].[Newtab1_1Aug2011]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtab1_23
-- --------------------------------------------------
CREATE TABLE [dbo].[newtab1_23]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtab1_27122013
-- --------------------------------------------------
CREATE TABLE [dbo].[newtab1_27122013]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Type] VARCHAR(50) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtab1_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[newtab1_bak]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] VARCHAR(50) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(6000) NULL,
    [Problem] VARCHAR(6000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtab1_bak23
-- --------------------------------------------------
CREATE TABLE [dbo].[newtab1_bak23]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Newtab1_dummy
-- --------------------------------------------------
CREATE TABLE [dbo].[Newtab1_dummy]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtab1_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[newtab1_temp]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtab2
-- --------------------------------------------------
CREATE TABLE [dbo].[newtab2]
(
    [SrNo] BIGINT NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] DECIMAL(18, 0) NULL,
    [downtimemin] DECIMAL(18, 0) NOT NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.newtabl_bkup
-- --------------------------------------------------
CREATE TABLE [dbo].[newtabl_bkup]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Type] VARCHAR(50) NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(8000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL,
    [Remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Notes
-- --------------------------------------------------
CREATE TABLE [dbo].[Notes]
(
    [gc_Body] VARCHAR(256) NULL,
    [gc_Categories] VARCHAR(256) NULL,
    [gc_Color] INT NULL,
    [gc_Height] INT NULL,
    [gc_Left] INT NULL,
    [gc_MessageClassFormDescription] VARCHAR(256) NULL,
    [gc_Top] INT NULL,
    [gc_Width] INT NULL,
    [gc_id] UNIQUEIDENTIFIER NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nov08
-- --------------------------------------------------
CREATE TABLE [dbo].[nov08]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.nse
-- --------------------------------------------------
CREATE TABLE [dbo].[nse]
(
    [bseid] INT IDENTITY(1,1) NOT NULL,
    [txt1] INT NOT NULL,
    [txt2] INT NOT NULL,
    [txt3] INT NOT NULL,
    [txt4] INT NOT NULL,
    [txt5] INT NOT NULL,
    [txt6] INT NOT NULL,
    [txt7] INT NOT NULL,
    [txt8] INT NOT NULL,
    [txt9] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Oct
-- --------------------------------------------------
CREATE TABLE [dbo].[Oct]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.oct_mnt
-- --------------------------------------------------
CREATE TABLE [dbo].[oct_mnt]
(
    [Sr] FLOAT NULL,
    [Date] DATETIME NULL,
    [BSECM ] FLOAT NULL,
    [NSECM] FLOAT NULL,
    [NSEFO] FLOAT NULL,
    [NSECDS] FLOAT NULL,
    [MCX] FLOAT NULL,
    [MCXCDS] FLOAT NULL,
    [NCDEX] FLOAT NULL,
    [REMARK] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.odinchecklist_procedures
-- --------------------------------------------------
CREATE TABLE [dbo].[odinchecklist_procedures]
(
    [fld_id] INT IDENTITY(1,1) NOT NULL,
    [procedures] VARCHAR(255) NULL,
    [flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.odinchecklist_sbs_procedures
-- --------------------------------------------------
CREATE TABLE [dbo].[odinchecklist_sbs_procedures]
(
    [fld_id] INT IDENTITY(1,1) NOT NULL,
    [procedures] VARCHAR(255) NULL,
    [flag] VARCHAR(5) NULL,
    [cutofftime] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.old_solutions
-- --------------------------------------------------
CREATE TABLE [dbo].[old_solutions]
(
    [Sr.No] INT IDENTITY(1,1) NOT NULL,
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(1000) NULL,
    [Solution] VARCHAR(3000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.old_solutions1
-- --------------------------------------------------
CREATE TABLE [dbo].[old_solutions1]
(
    [Sr.No] INT IDENTITY(1,1) NOT NULL,
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(1000) NULL,
    [Solution] VARCHAR(3000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OneIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[OneIndex]
(
    [ID] INT NULL,
    [FirstName] VARCHAR(100) NULL,
    [LastName] VARCHAR(100) NULL,
    [City] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OP_Mail
-- --------------------------------------------------
CREATE TABLE [dbo].[OP_Mail]
(
    [email] VARCHAR(1000) NULL,
    [tat] VARCHAR(500) NULL,
    [complaint_id] VARCHAR(500) NOT NULL,
    [emp_name] VARCHAR(1500) NULL,
    [complaint] VARCHAR(5000) NULL,
    [complaint_date] VARCHAR(110) NULL,
    [dept_name] VARCHAR(500) NOT NULL,
    [subject] VARCHAR(2550) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.op_mail_dummy
-- --------------------------------------------------
CREATE TABLE [dbo].[op_mail_dummy]
(
    [Head] VARCHAR(5000) NULL,
    [srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.op_mail1
-- --------------------------------------------------
CREATE TABLE [dbo].[op_mail1]
(
    [email] VARCHAR(5000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OP_Masterdata
-- --------------------------------------------------
CREATE TABLE [dbo].[OP_Masterdata]
(
    [Id] INT NULL,
    [Name] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.op_querytype_backup
-- --------------------------------------------------
CREATE TABLE [dbo].[op_querytype_backup]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.op_sett_mst
-- --------------------------------------------------
CREATE TABLE [dbo].[op_sett_mst]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.op_subject_backup
-- --------------------------------------------------
CREATE TABLE [dbo].[op_subject_backup]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OperationHelpdesk_Reminder
-- --------------------------------------------------
CREATE TABLE [dbo].[OperationHelpdesk_Reminder]
(
    [Complaint_id] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.OphelpdeskTAT
-- --------------------------------------------------
CREATE TABLE [dbo].[OphelpdeskTAT]
(
    [complaint_id] VARCHAR(50) NOT NULL,
    [stat_flag] VARCHAR(30) NOT NULL,
    [OpTAT] VARCHAR(7) NULL,
    [tat] INT NULL,
    [UpdDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ord_conf
-- --------------------------------------------------
CREATE TABLE [dbo].[ord_conf]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Contact_Person] VARCHAR(100) NULL,
    [Fld_Confimation_Time] VARCHAR(15) NULL,
    [Fld_Staus] VARCHAR(1000) NULL,
    [Fld_Reason] VARCHAR(1000) NULL,
    [Fld_UPD_By] VARCHAR(15) NULL,
    [Fld_UPD_Time] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Order_Confirmation
-- --------------------------------------------------
CREATE TABLE [dbo].[Order_Confirmation]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Contact_Person] VARCHAR(100) NULL,
    [Fld_Confimation_Time] VARCHAR(15) NULL,
    [Fld_Staus] VARCHAR(1000) NULL,
    [Fld_Reason] VARCHAR(1000) NULL,
    [Fld_UPD_By] VARCHAR(15) NULL,
    [Fld_UPD_Time] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prb
-- --------------------------------------------------
CREATE TABLE [dbo].[prb]
(
    [Department] VARCHAR(8000) NULL,
    [Problem] VARCHAR(8000) NULL,
    [Solutions] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prb1
-- --------------------------------------------------
CREATE TABLE [dbo].[prb1]
(
    [Department] VARCHAR(8000) NULL,
    [Problem] VARCHAR(8000) NULL,
    [Solutions] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Product
-- --------------------------------------------------
CREATE TABLE [dbo].[Product]
(
    [Cust] VARCHAR(25) NULL,
    [Product] VARCHAR(20) NULL,
    [QTY] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Att_title_master
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Att_title_master]
(
    [Survey_no] INT NULL,
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [TitleSrNo] INT NULL,
    [TitleSubSrno] VARCHAR(2) NULL,
    [title] VARCHAR(500) NULL,
    [active] VARCHAR(1) NULL,
    [type] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Attribute_master
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Attribute_master]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [title_SrNo] INT NULL,
    [Att_No] INT NULL,
    [type] VARCHAR(6) NULL,
    [Description] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Attribute_master_07102008
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Attribute_master_07102008]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [title_SrNo] INT NULL,
    [Att_No] INT NULL,
    [type] VARCHAR(6) NULL,
    [Description] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Attribute_Report
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Attribute_Report]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [title_SrNo] INT NULL,
    [Att_No] INT NULL,
    [type] VARCHAR(6) NULL,
    [Description] VARCHAR(500) NULL,
    [status] VARCHAR(1) NULL,
    [branch] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [Rpt_type] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Attribute_Report_07102008
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Attribute_Report_07102008]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [title_SrNo] INT NULL,
    [Att_No] INT NULL,
    [type] VARCHAR(6) NULL,
    [Description] VARCHAR(500) NULL,
    [status] VARCHAR(1) NULL,
    [branch] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [Rpt_type] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Attribute_Report_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Attribute_Report_hist]
(
    [ID] INT NOT NULL,
    [title_SrNo] INT NULL,
    [Att_No] INT NULL,
    [type] VARCHAR(6) NULL,
    [Description] VARCHAR(500) NULL,
    [status] VARCHAR(1) NULL,
    [branch] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [Rpt_type] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_graph_color
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_graph_color]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [Options] VARCHAR(12) NULL,
    [color] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Ques_master
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Ques_master]
(
    [ID] INT NOT NULL,
    [Department] VARCHAR(80) NULL,
    [Group_no] INT NULL,
    [Ques_no] INT NULL,
    [Sub_ques_of] VARCHAR(2) NULL,
    [Question] VARCHAR(200) NULL,
    [ques_for] VARCHAR(6) NULL,
    [Ans_text] VARCHAR(1) NULL,
    [Suggestion] VARCHAR(1) NULL,
    [Map_AttrSrno] INT NULL,
    [active] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.qa_ques_master_deleted
-- --------------------------------------------------
CREATE TABLE [dbo].[qa_ques_master_deleted]
(
    [ID] INT NOT NULL,
    [Department] VARCHAR(80) NULL,
    [Group_no] INT NULL,
    [Ques_no] INT NULL,
    [Sub_ques_of] VARCHAR(2) NULL,
    [Question] VARCHAR(200) NULL,
    [ques_for] VARCHAR(6) NULL,
    [Ans_text] VARCHAR(1) NULL,
    [Suggestion] VARCHAR(1) NULL,
    [Map_AttrSrno] INT NULL,
    [active] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Ques_Opt
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Ques_Opt]
(
    [Ques_ID] INT NULL,
    [Options] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_survey_ANS1
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_survey_ANS1]
(
    [ques_id] INT NULL,
    [ques_no] INT NULL,
    [Sub_ques] VARCHAR(2) NULL,
    [Ans] VARCHAR(40) NULL,
    [Ans_text] VARCHAR(60) NULL,
    [Suggestion] VARCHAR(500) NULL,
    [Id_Ans2] INT NULL,
    [branch] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.qa_survey_ans1_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[qa_survey_ans1_hist]
(
    [ques_id] INT NULL,
    [ques_no] INT NULL,
    [Sub_ques] VARCHAR(2) NULL,
    [Ans] VARCHAR(40) NULL,
    [Ans_text] VARCHAR(60) NULL,
    [Suggestion] VARCHAR(500) NULL,
    [Id_Ans2] INT NULL,
    [branch] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_survey_ANS2
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_survey_ANS2]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [SDate] DATETIME NULL,
    [type] VARCHAR(5) NULL,
    [client_code] VARCHAR(12) NULL,
    [client_name] VARCHAR(80) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [Branch] VARCHAR(10) NULL,
    [Mobile] VARCHAR(20) NULL,
    [Mobile_status] VARCHAR(50) NULL,
    [Phone] VARCHAR(20) NULL,
    [phone_status] VARCHAR(50) NULL,
    [email] VARCHAR(80) NULL,
    [email_status] VARCHAR(50) NULL,
    [Address] VARCHAR(250) NULL,
    [Action] VARCHAR(150) NULL,
    [Final_status] VARCHAR(8) NULL,
    [survey_by] VARCHAR(60) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.qa_survey_ans2_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[qa_survey_ans2_hist]
(
    [Id] INT NOT NULL,
    [SDate] DATETIME NULL,
    [type] VARCHAR(5) NULL,
    [client_code] VARCHAR(12) NULL,
    [client_name] VARCHAR(80) NULL,
    [Sub_broker] VARCHAR(10) NULL,
    [Branch] VARCHAR(10) NULL,
    [Mobile] VARCHAR(20) NULL,
    [Mobile_status] VARCHAR(50) NULL,
    [Phone] VARCHAR(20) NULL,
    [phone_status] VARCHAR(50) NULL,
    [email] VARCHAR(80) NULL,
    [email_status] VARCHAR(50) NULL,
    [Address] VARCHAR(250) NULL,
    [Action] VARCHAR(150) NULL,
    [Final_status] VARCHAR(8) NULL,
    [survey_by] VARCHAR(60) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_Survey_Group
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_Survey_Group]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [grp] VARCHAR(18) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_survey_master
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_survey_master]
(
    [Survey_no] INT NULL,
    [Survey_name] VARCHAR(100) NULL,
    [Survey_desc] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.QA_temp_compNo
-- --------------------------------------------------
CREATE TABLE [dbo].[QA_temp_compNo]
(
    [complaintno] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.query_type
-- --------------------------------------------------
CREATE TABLE [dbo].[query_type]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(200) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.query_type02
-- --------------------------------------------------
CREATE TABLE [dbo].[query_type02]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(200) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.query_type1
-- --------------------------------------------------
CREATE TABLE [dbo].[query_type1]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(100) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.query_type14
-- --------------------------------------------------
CREATE TABLE [dbo].[query_type14]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(200) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.query_type24
-- --------------------------------------------------
CREATE TABLE [dbo].[query_type24]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(200) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.query_type26
-- --------------------------------------------------
CREATE TABLE [dbo].[query_type26]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(200) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.query_type26072010
-- --------------------------------------------------
CREATE TABLE [dbo].[query_type26072010]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dep_Id] VARCHAR(50) NULL,
    [Fld_Query] VARCHAR(50) NULL,
    [dummy1] VARCHAR(50) NULL,
    [dummy2] VARCHAR(50) NULL,
    [dummy3] VARCHAR(50) NULL,
    [dummy4] VARCHAR(50) NULL,
    [dummy5] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Reminder
-- --------------------------------------------------
CREATE TABLE [dbo].[Reminder]
(
    [ComplaintNo] VARCHAR(50) NULL,
    [reminder] INT NULL,
    [Datetime] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Report_title
-- --------------------------------------------------
CREATE TABLE [dbo].[Report_title]
(
    [type] VARCHAR(6) NULL,
    [branch] VARCHAR(8) NULL,
    [brname] VARCHAR(20) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [title] VARCHAR(600) NULL,
    [rating] INT NULL,
    [sdate] DATETIME NULL,
    [ConductBy] VARCHAR(30) NULL,
    [ReviewedBy] VARCHAR(30) NULL,
    [ApprovedBy] VARCHAR(30) NULL,
    [HiLight] VARCHAR(800) NULL,
    [Sugg] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Report_title_07102008
-- --------------------------------------------------
CREATE TABLE [dbo].[Report_title_07102008]
(
    [type] VARCHAR(6) NULL,
    [branch] VARCHAR(8) NULL,
    [brname] VARCHAR(20) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [title] VARCHAR(600) NULL,
    [rating] INT NULL,
    [sdate] DATETIME NULL,
    [ConductBy] VARCHAR(30) NULL,
    [ReviewedBy] VARCHAR(30) NULL,
    [ApprovedBy] VARCHAR(30) NULL,
    [HiLight] VARCHAR(800) NULL,
    [Sugg] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Req_HR
-- --------------------------------------------------
CREATE TABLE [dbo].[Req_HR]
(
    [Sr] VARCHAR(255) NULL,
    [Request] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.request_map
-- --------------------------------------------------
CREATE TABLE [dbo].[request_map]
(
    [request_type] VARCHAR(100) NULL,
    [guid] UNIQUEIDENTIFIER NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.request_mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[request_mapping]
(
    [request_type] VARCHAR(100) NULL,
    [emp_id] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.request_name
-- --------------------------------------------------
CREATE TABLE [dbo].[request_name]
(
    [request_type] VARCHAR(100) NULL,
    [FLAG] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.rest
-- --------------------------------------------------
CREATE TABLE [dbo].[rest]
(
    [test] VARCHAR(50) NULL,
    [comno] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sectionmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[sectionmaster]
(
    [deptno] VARCHAR(40) NULL,
    [secid] VARCHAR(40) NULL,
    [sectionname] VARCHAR(50) NULL,
    [eff_from] DATETIME NULL,
    [eff_to] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.seg_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[seg_mast]
(
    [segid] INT IDENTITY(1,1) NOT NULL,
    [Segment] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.seg_mast_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[seg_mast_bak]
(
    [segid] INT IDENTITY(1,1) NOT NULL,
    [Segment] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sep_Cal
-- --------------------------------------------------
CREATE TABLE [dbo].[Sep_Cal]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sep2008
-- --------------------------------------------------
CREATE TABLE [dbo].[Sep2008]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ser
-- --------------------------------------------------
CREATE TABLE [dbo].[ser]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Server_Summary
-- --------------------------------------------------
CREATE TABLE [dbo].[Server_Summary]
(
    [server] VARCHAR(255) NULL,
    [company] VARCHAR(10) NULL,
    [Delivery_TO] MONEY NULL,
    [Trading_TO] MONEY NULL,
    [Delivery_brok] MONEY NULL,
    [Trading_brok] MONEY NULL,
    [Total_brok] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Server_users
-- --------------------------------------------------
CREATE TABLE [dbo].[Server_users]
(
    [Server] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.set
-- --------------------------------------------------
CREATE TABLE [dbo].[set]
(
    [date] VARCHAR(255) NULL,
    [bse] VARCHAR(255) NULL,
    [cm] VARCHAR(255) NULL,
    [fo] VARCHAR(255) NULL,
    [mcx] VARCHAR(255) NULL,
    [ncdex] VARCHAR(255) NULL,
    [sx] VARCHAR(255) NULL,
    [cd] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.set_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[set_mast]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Set_test090110
-- --------------------------------------------------
CREATE TABLE [dbo].[Set_test090110]
(
    [date] VARCHAR(255) NULL,
    [bse] VARCHAR(255) NULL,
    [cm] VARCHAR(255) NULL,
    [fo] VARCHAR(255) NULL,
    [mcx] VARCHAR(255) NULL,
    [sx] VARCHAR(255) NULL,
    [ncdex] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.set1
-- --------------------------------------------------
CREATE TABLE [dbo].[set1]
(
    [date] VARCHAR(255) NULL,
    [bse] VARCHAR(255) NULL,
    [cm] VARCHAR(255) NULL,
    [fo] VARCHAR(255) NULL,
    [mcx] VARCHAR(255) NULL,
    [ncdex] VARCHAR(255) NULL,
    [SX] VARCHAR(255) NULL,
    [Currency] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett
-- --------------------------------------------------
CREATE TABLE [dbo].[sett]
(
    [Sett_date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL,
    [CNT] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_cal
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_cal]
(
    [Date] VARCHAR(8000) NULL,
    [BSE] VARCHAR(8000) NULL,
    [CM] VARCHAR(8000) NULL,
    [FO] VARCHAR(8000) NULL,
    [MCX] VARCHAR(8000) NULL,
    [NCDEX] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_calfeb
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_calfeb]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sett_Jul
-- --------------------------------------------------
CREATE TABLE [dbo].[Sett_Jul]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst_final
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst_final]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst_log
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst_log]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL,
    [mod_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst_mahendra
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst_mahendra]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst1
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst1]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mst4
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mst4]
(
    [date] VARCHAR(255) NULL,
    [bse] VARCHAR(255) NULL,
    [cm] VARCHAR(255) NULL,
    [fo] VARCHAR(255) NULL,
    [mcx] VARCHAR(255) NULL,
    [ncdex] VARCHAR(255) NULL,
    [sx] VARCHAR(255) NULL,
    [cd] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sett_mstfinal
-- --------------------------------------------------
CREATE TABLE [dbo].[sett_mstfinal]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1]
(
    [DeptNo] VARCHAR(50) NULL,
    [complaint] VARCHAR(1000) NULL,
    [Solution] VARCHAR(1000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [Dummy2] VARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet1$
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet1$]
(
    [Sr] FLOAT NULL,
    [Date] DATETIME NULL,
    [BSECM ] FLOAT NULL,
    [NSECM] FLOAT NULL,
    [NSEFO] FLOAT NULL,
    [NSECDS] FLOAT NULL,
    [MCX] FLOAT NULL,
    [MCXCDS] FLOAT NULL,
    [NCDEX] FLOAT NULL,
    [REMARK] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Sheet3$
-- --------------------------------------------------
CREATE TABLE [dbo].[Sheet3$]
(
    [REGION] NVARCHAR(255) NULL,
    [Branch TAG] NVARCHAR(255) NULL,
    [ Branch name] NVARCHAR(255) NULL,
    [Link] NVARCHAR(255) NULL,
    [Connectivity] NVARCHAR(255) NULL,
    [Ckt id] NVARCHAR(255) NULL,
    [Provider] NVARCHAR(255) NULL,
    [Bandwidth] NVARCHAR(255) NULL,
    [ purpose] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Date of testing] NVARCHAR(255) NULL,
    [Tested by] NVARCHAR(255) NULL,
    [Remark] NVARCHAR(255) NULL,
    [Admin remark] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.site
-- --------------------------------------------------
CREATE TABLE [dbo].[site]
(
    [SiteCode] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL,
    [BranchTag] VARCHAR(255) NULL,
    [Connectivity] VARCHAR(255) NULL,
    [Relationship] VARCHAR(255) NULL,
    [DefaultGateway] VARCHAR(255) NULL,
    [SubnetMask] VARCHAR(255) NULL,
    [Status] VARCHAR(255) NULL,
    [PostalAddress] VARCHAR(255) NULL,
    [ContactPerson] VARCHAR(255) NULL,
    [ContactNo] VARCHAR(255) NULL,
    [Emailid] VARCHAR(255) NULL,
    [ConnectedWithBranch] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [NSE] VARCHAR(255) NULL,
    [NSEFO] VARCHAR(255) NULL,
    [BSEFO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDX] VARCHAR(255) NULL,
    [OdinUserIdEq] VARCHAR(255) NULL,
    [OdinUserIdComm] VARCHAR(255) NULL,
    [ServerIP] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.site1
-- --------------------------------------------------
CREATE TABLE [dbo].[site1]
(
    [Fld_Site_Code] VARCHAR(255) NULL,
    [Fld_Location] VARCHAR(255) NULL,
    [Fld_BranchTag] VARCHAR(255) NULL,
    [Fld_Connectivity] VARCHAR(255) NULL,
    [Fld_RelationShip] VARCHAR(255) NULL,
    [Fld_Def_Gateway] VARCHAR(255) NULL,
    [Fld_Subnet_Mast] VARCHAR(255) NULL,
    [Fld_Status] VARCHAR(255) NULL,
    [Fld_Postal_Address] VARCHAR(255) NULL,
    [Fld_Contact_Person] VARCHAR(255) NULL,
    [Fld_Contact_No] VARCHAR(255) NULL,
    [Fld_Email_Id] VARCHAR(255) NULL,
    [Fld_Connected_Branch] VARCHAR(255) NULL,
    [Fld_BSE] VARCHAR(255) NULL,
    [Fld_NSE] VARCHAR(255) NULL,
    [Fld_FO] VARCHAR(255) NULL,
    [Fld_BSEFO] VARCHAR(255) NULL,
    [Fld_MCX] VARCHAR(255) NULL,
    [Fld_NCX] VARCHAR(255) NULL,
    [Fld_Odin_Userid_Eq] VARCHAR(255) NULL,
    [Fld_Odin_Userid_Comm] VARCHAR(255) NULL,
    [Fld_Server_Ip] VARCHAR(255) NULL,
    [Fld_Entry_Date] VARCHAR(255) NULL,
    [Fld_Userid] VARCHAR(255) NULL,
    [Fld_UserLocation] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sols
-- --------------------------------------------------
CREATE TABLE [dbo].[sols]
(
    [Department] VARCHAR(8000) NULL,
    [Problem] VARCHAR(8000) NULL,
    [Solutions] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.solutions_14062008
-- --------------------------------------------------
CREATE TABLE [dbo].[solutions_14062008]
(
    [Sr.No] INT IDENTITY(1,1) NOT NULL,
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(3000) NULL,
    [Solution] VARCHAR(3000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL,
    [function1] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.solve
-- --------------------------------------------------
CREATE TABLE [dbo].[solve]
(
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(1000) NULL,
    [Solution] VARCHAR(1000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SRNO
-- --------------------------------------------------
CREATE TABLE [dbo].[SRNO]
(
    [Sr_No] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.step_nature
-- --------------------------------------------------
CREATE TABLE [dbo].[step_nature]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [department] VARCHAR(50) NULL,
    [name] VARCHAR(100) NULL,
    [Steps] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Stocks
-- --------------------------------------------------
CREATE TABLE [dbo].[Stocks]
(
    [Name] CHAR(4) NOT NULL,
    [Price] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.stud_Demo
-- --------------------------------------------------
CREATE TABLE [dbo].[stud_Demo]
(
    [id] INT NULL,
    [name] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t#
-- --------------------------------------------------
CREATE TABLE [dbo].[t#]
(
    [Server] VARCHAR(255) NULL,
    [Odin_Id] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.t1
-- --------------------------------------------------
CREATE TABLE [dbo].[t1]
(
    [srNo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.table_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[table_temp]
(
    [Segment] VARCHAR(10) NULL,
    [Code] VARCHAR(10) NULL,
    [BALANCE] VARCHAR(10) NULL,
    [SECURITY] VARCHAR(10) NULL,
    [PROVISION] VARCHAR(10) NULL,
    [NetofProvision] VARCHAR(10) NULL,
    [SECURED] VARCHAR(10) NULL,
    [UNSECURED] VARCHAR(10) NULL,
    [DIFFERENCE] VARCHAR(10) NULL,
    [ClosingBalance] VARCHAR(10) NULL,
    [0-29Days] VARCHAR(10) NULL,
    [31-60Days] VARCHAR(10) NULL,
    [61-90Days] VARCHAR(10) NULL,
    [91-180Days] VARCHAR(10) NULL,
    [181-360Days] VARCHAR(10) NULL,
    [361daysPlus] VARCHAR(10) NULL,
    [MoreThan6Months] VARCHAR(10) NULL,
    [Debtors>6MonthsSecured] VARCHAR(10) NULL,
    [Debtors>6MonthUnsecured] VARCHAR(10) NULL,
    [BalanceSecurity] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Table1
-- --------------------------------------------------
CREATE TABLE [dbo].[Table1]
(
    [ColId] INT NULL,
    [ColName] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tablejoin
-- --------------------------------------------------
CREATE TABLE [dbo].[tablejoin]
(
    [ID] INT NULL,
    [Value] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tablejoin2
-- --------------------------------------------------
CREATE TABLE [dbo].[tablejoin2]
(
    [ID] INT NULL,
    [Value1] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tablejoin3
-- --------------------------------------------------
CREATE TABLE [dbo].[tablejoin3]
(
    [ID] INT NULL,
    [Value1] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tasks
-- --------------------------------------------------
CREATE TABLE [dbo].[Tasks]
(
    [gc_ActualWork] INT NULL,
    [gc_BillingInformation] VARCHAR(256) NULL,
    [gc_Body] TEXT NULL,
    [gc_CardData] VARCHAR(256) NULL,
    [gc_Categories] VARCHAR(256) NULL,
    [gc_Companies] VARCHAR(256) NULL,
    [gc_Complete] CHAR(1) NULL,
    [gc_ContactNames] VARCHAR(256) NULL,
    [gc_CreationTime] DATETIME NULL,
    [gc_DateCompleted] DATETIME NULL,
    [gc_DueDate] DATETIME NULL,
    [gc_Importance] INT NULL,
    [gc_InternetCodepage] INT NULL,
    [gc_RecurrencePattern] VARCHAR(100) NULL,
    [gc_Mileage] VARCHAR(256) NULL,
    [gc_NoAging] CHAR(1) NULL,
    [gc_Ordinal] INT NULL,
    [gc_Owner] VARCHAR(256) NULL,
    [gc_PercentComplete] INT NULL,
    [gc_ReminderOverrideDefault] CHAR(1) NULL,
    [gc_ReminderPlaySound] CHAR(1) NULL,
    [gc_ReminderSet] CHAR(1) NULL,
    [gc_ReminderSoundFile] VARCHAR(256) NULL,
    [gc_ReminderTime] DATETIME NULL,
    [gc_Role] VARCHAR(256) NULL,
    [gc_SchedulePlusPriority] VARCHAR(256) NULL,
    [gc_Sensitivity] INT NULL,
    [gc_StartDate] DATETIME NULL,
    [gc_Status] INT NULL,
    [gc_StatusOnCompletionRecipients] VARCHAR(256) NULL,
    [gc_StatusUpdateRecipients] VARCHAR(256) NULL,
    [gc_Subject] VARCHAR(256) NULL,
    [gc_TeamTask] CHAR(1) NULL,
    [gc_TotalWork] INT NULL,
    [gc_Unread] CHAR(1) NULL,
    [gc_guid] UNIQUEIDENTIFIER NOT NULL,
    [gc_LastModificationTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TAT
-- --------------------------------------------------
CREATE TABLE [dbo].[TAT]
(
    [COMPLAINTID] VARCHAR(50) NOT NULL,
    [RAISED_TO_DEPT] VARCHAR(20) NULL,
    [RAISED_DATE] VARCHAR(11) NULL,
    [RAISED_BY_EMPNM] VARCHAR(100) NULL,
    [SUBJECT] VARCHAR(1000) NULL,
    [COMPLAINT_DETAILS] VARCHAR(1000) NULL,
    [PENDING_SINCE_HOURS] VARCHAR(15) NULL,
    [HR48] VARCHAR(100) NULL,
    [HR72] VARCHAR(100) NULL,
    [HR240] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AOTD
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AOTD]
(
    [Fld_ComplainNo] VARCHAR(50) NOT NULL,
    [Fld_Date] VARCHAR(50) NULL,
    [Fld_Connectivity] VARCHAR(50) NULL,
    [Fld_CircuitId] VARCHAR(50) NULL,
    [Fld_Descrip] VARCHAR(200) NULL,
    [Fld_MediumInfo] VARCHAR(50) NULL,
    [Fld_Action] VARCHAR(100) NULL,
    [Fld_Timefrm] VARCHAR(50) NULL,
    [Fld_TimeTo] VARCHAR(50) NULL,
    [Fld_Link_dntime] VARCHAR(50) NULL,
    [Fld_Business_dntime] VARCHAR(50) NULL,
    [Fld_Backup] VARCHAR(50) NULL,
    [Fld_Impact] VARCHAR(50) NULL,
    [Fld_Location] VARCHAR(50) NULL,
    [Fld_Loc] VARCHAR(50) NULL,
    [Fld_Reason] VARCHAR(200) NULL,
    [Fld_LastUpdate] VARCHAR(300) NULL,
    [Fld_Status] VARCHAR(50) NULL,
    [Fld_DateTime] DATETIME NULL,
    [Fld_CompletedTime] DATETIME NULL,
    [Fld_Username] VARCHAR(50) NULL,
    [Fld_Accesscode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AOTD_5Apr
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AOTD_5Apr]
(
    [Fld_ComplainNo] VARCHAR(50) NOT NULL,
    [Fld_Date] VARCHAR(50) NULL,
    [Fld_Connectivity] VARCHAR(50) NULL,
    [Fld_CircuitId] VARCHAR(50) NULL,
    [Fld_Descrip] VARCHAR(200) NULL,
    [Fld_MediumInfo] VARCHAR(50) NULL,
    [Fld_Action] VARCHAR(100) NULL,
    [Fld_Timefrm] VARCHAR(50) NULL,
    [Fld_TimeTo] VARCHAR(50) NULL,
    [Fld_Link_dntime] VARCHAR(50) NULL,
    [Fld_Business_dntime] VARCHAR(50) NULL,
    [Fld_Backup] VARCHAR(50) NULL,
    [Fld_Impact] VARCHAR(50) NULL,
    [Fld_Location] VARCHAR(50) NULL,
    [Fld_Loc] VARCHAR(50) NULL,
    [Fld_Reason] VARCHAR(200) NULL,
    [Fld_LastUpdate] VARCHAR(300) NULL,
    [Fld_Status] VARCHAR(50) NULL,
    [Fld_DateTime] DATETIME NULL,
    [Fld_CompletedTime] DATETIME NULL,
    [Fld_Username] VARCHAR(50) NULL,
    [Fld_Accesscode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AOTD_mail
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AOTD_mail]
(
    [Fld_ComplainNo] VARCHAR(50) NOT NULL,
    [Fld_Date] VARCHAR(50) NULL,
    [Fld_Connectivity] VARCHAR(50) NULL,
    [Fld_CircuitId] VARCHAR(50) NULL,
    [Fld_Descrip] VARCHAR(100) NULL,
    [Fld_MediumInfo] VARCHAR(50) NULL,
    [Fld_Action] VARCHAR(100) NULL,
    [Fld_Timefrm] VARCHAR(50) NULL,
    [Fld_TimeTo] VARCHAR(50) NULL,
    [Fld_Link_dntime] VARCHAR(50) NULL,
    [Fld_Business_dntime] VARCHAR(50) NULL,
    [Fld_Backup] VARCHAR(50) NULL,
    [Fld_Impact] VARCHAR(50) NULL,
    [Fld_Location] VARCHAR(50) NULL,
    [Fld_Loc] VARCHAR(50) NULL,
    [Fld_Reason] VARCHAR(100) NULL,
    [Fld_LastUpdate] VARCHAR(50) NULL,
    [Fld_Status] VARCHAR(50) NULL,
    [Fld_DateTime] VARCHAR(50) NULL,
    [Fld_CompletedTime] VARCHAR(50) NULL,
    [Fld_Username] VARCHAR(50) NULL,
    [Fld_Accesscode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_AssetsReportFilterType
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_AssetsReportFilterType]
(
    [TypeText] VARCHAR(20) NULL,
    [TypeValue] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_attach
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_attach]
(
    [Sr_No] INT NULL,
    [Emp_Code] VARCHAR(50) NULL,
    [AttachFile] IMAGE NULL,
    [Doctype] VARCHAR(50) NULL,
    [Filename] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Bandwidth
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Bandwidth]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Bandwitdh] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Branch_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Branch_Master]
(
    [Fld_Branch_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Tag] VARCHAR(15) NULL,
    [Fld_Branch_Name] VARCHAR(25) NULL,
    [Fld_Dept_Id] VARCHAR(10) NULL,
    [Fld_Type] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Bulk_Mail
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Bulk_Mail]
(
    [Locaton] VARCHAR(25) NULL,
    [Email_id] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Call_Note
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Call_Note]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_Remark] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_call_rpt
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_call_rpt]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Gateway_ip] VARCHAR(15) NULL,
    [Fld_Call_Type] CHAR(1) NULL,
    [Fld_Dealer_Name] VARCHAR(50) NULL,
    [Fld_First_Confirmation] VARCHAR(15) NULL,
    [Fld_First_Frq] VARCHAR(15) NULL,
    [Fld_First_Entered_By] VARCHAR(15) NULL,
    [Fld_Second_Confirmation] VARCHAR(15) NULL,
    [Fld_Second_Frq] VARCHAR(15) NULL,
    [Fld_Second_Entered_By] VARCHAR(15) NULL,
    [Fld_Upd_date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Cat_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Cat_Master]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Dept_No] VARCHAR(10) NULL,
    [Category] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Category_Item_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Category_Item_Master]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dept] VARCHAR(10) NULL,
    [Fld_Issue_Type] VARCHAR(20) NULL,
    [Fld_Code] VARCHAR(20) NULL,
    [Fld_Alt_Code] VARCHAR(20) NULL,
    [Fld_Contact_Person] VARCHAR(50) NULL,
    [Fld_Address] VARCHAR(50) NULL,
    [Fld_City] VARCHAR(50) NULL,
    [Fld_Tel] VARCHAR(50) NULL,
    [Fld_Email] VARCHAR(50) NULL,
    [Fld_Status] VARCHAR(1) NULL,
    [Fld_UserName] VARCHAR(20) NULL,
    [Fld_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Category_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Category_Master]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Category_Name] VARCHAR(50) NOT NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Deactive_Date] DATETIME NULL,
    [Fld_Dept_Id] VARCHAR(10) NOT NULL,
    [Fld_Status] CHAR(2) NULL,
    [Fld_Login_IP] VARCHAR(50) NULL,
    [Fld_Created_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_comp_issue_1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_comp_issue_1]
(
    [server] VARCHAR(255) NULL,
    [issues] VARCHAR(50) NULL,
    [dt] DECIMAL(38, 0) NULL,
    [Total_dt] DECIMAL(38, 0) NULL,
    [uptime] DECIMAL(38, 0) NULL,
    [dt_per] DECIMAL(38, 6) NULL,
    [brk_loss] VARCHAR(15) NULL,
    [Total_Brok_loss] MONEY NULL,
    [Total_DownTime_Per] DECIMAL(38, 28) NULL,
    [Total_Brokerage] MONEY NULL,
    [Total_issue_dt] DECIMAL(38, 0) NULL,
    [Total_issue_per] DECIMAL(38, 6) NULL,
    [Total_issue_brok] DECIMAL(38, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_comp_issue_2
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_comp_issue_2]
(
    [server] VARCHAR(255) NULL,
    [issues] VARCHAR(50) NULL,
    [dt] DECIMAL(38, 0) NULL,
    [Total_dt] DECIMAL(38, 0) NULL,
    [uptime] DECIMAL(38, 0) NULL,
    [dt_per] DECIMAL(38, 6) NULL,
    [brk_loss] VARCHAR(15) NULL,
    [Total_Brok_loss] MONEY NULL,
    [Total_DownTime_Per] DECIMAL(38, 28) NULL,
    [Total_Brokerage] MONEY NULL,
    [Total_issue_dt] DECIMAL(38, 0) NULL,
    [Total_issue_per] DECIMAL(38, 6) NULL,
    [Total_issue_brok] DECIMAL(38, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_comp_rpt
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_comp_rpt]
(
    [server] VARCHAR(255) NULL,
    [issues] VARCHAR(50) NULL,
    [dt] DECIMAL(38, 0) NULL,
    [Total_dt] DECIMAL(38, 0) NULL,
    [uptime] DECIMAL(38, 0) NULL,
    [dt_per] DECIMAL(38, 6) NULL,
    [brk_loss] VARCHAR(15) NULL,
    [Total_Brok_loss] MONEY NULL,
    [Total_DownTime_Per] DECIMAL(38, 28) NULL,
    [Total_Brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_comp_rpt1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_comp_rpt1]
(
    [server] VARCHAR(255) NULL,
    [issues] VARCHAR(50) NULL,
    [dt] DECIMAL(38, 0) NULL,
    [Total_dt] DECIMAL(38, 0) NULL,
    [uptime] DECIMAL(38, 0) NULL,
    [dt_per] DECIMAL(38, 6) NULL,
    [brk_loss] VARCHAR(15) NULL,
    [Total_Brok_loss] MONEY NULL,
    [Total_DownTime_Per] DECIMAL(38, 28) NULL,
    [Total_Brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint_backup_13dec
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint_backup_13dec]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint042010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint042010]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint1]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint10
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint10]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint12
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint12]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint13
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint13]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint132010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint132010]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint1320100
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint1320100]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint142010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint142010]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint21
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint21]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint21082010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint21082010]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint23
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint23]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint23112010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint23112010]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint24092010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint24092010]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint240920100
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint240920100]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_COMPLAINT25
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_COMPLAINT25]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint29
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint29]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaint30sep2010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaint30sep2010]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaintmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaintmaster]
(
    [deptno] VARCHAR(40) NULL,
    [complaint] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_complaintmaster1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_complaintmaster1]
(
    [deptno] VARCHAR(40) NULL,
    [complaint] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_connectivity
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_connectivity]
(
    [Fld_Connectivity_Type] INT IDENTITY(1,1) NOT NULL,
    [drp_connectivity] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_connectivity_dtl
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_connectivity_dtl]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_From] VARCHAR(50) NULL,
    [Fld_To] VARCHAR(50) NULL,
    [Fld_LC_id] VARCHAR(50) NULL,
    [Fld_Circuit_id] VARCHAR(50) NULL,
    [Fld_From_Device] VARCHAR(50) NULL,
    [Fld_To_Device] VARCHAR(50) NULL,
    [Fld_Lan_IP] VARCHAR(200) NULL,
    [Fld_ISP] VARCHAR(50) NULL,
    [Fld_Connectivity_Type] VARCHAR(50) NULL,
    [Fld_Comm_Date] VARCHAR(50) NULL,
    [Fld_Bandwidth] VARCHAR(50) NULL,
    [Fld_Router] VARCHAR(50) NULL,
    [Fld_Cheesy_Slot] VARCHAR(50) NULL,
    [Fld_Modem] VARCHAR(50) NULL,
    [Fld_Remarks] VARCHAR(500) NULL,
    [Fld_Sysdate] DATETIME NULL,
    [Fld_Access_code] VARCHAR(10) NULL,
    [Fld_Billing_date] VARCHAR(50) NULL,
    [Fld_Billing_Type] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_daily_uploaded_file
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_daily_uploaded_file]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [filename] VARCHAR(50) NULL,
    [application] VARCHAR(50) NULL,
    [flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DB_Shrink_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DB_Shrink_Data]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Branch_Id] VARCHAR(50) NULL,
    [Fld_DB] VARCHAR(500) NULL,
    [Fld_BQ] VARCHAR(15) NULL,
    [Fld_AQ] VARCHAR(15) NULL,
    [Fld_DD] VARCHAR(15) NULL,
    [Fld_FS] VARCHAR(15) NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [Fld_Sys_Date] DATETIME NULL,
    [Fld_Upd_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DB_Shrink_Data_New
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DB_Shrink_Data_New]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Branch_Id] VARCHAR(50) NOT NULL,
    [Fld_Mdf_COD] VARCHAR(50) NULL,
    [Fld_Mdf_BQ] VARCHAR(50) NULL,
    [Fld_Mdf_AQ] VARCHAR(50) NULL,
    [Fld_Mdf_DD] VARCHAR(50) NULL,
    [Fld_Mdf_FS] VARCHAR(50) NULL,
    [Fld_Ldf_COD] VARCHAR(50) NULL,
    [Fld_Ldf_BQ] VARCHAR(50) NULL,
    [Fld_Ldf_AQ] VARCHAR(50) NULL,
    [Fld_Ldf_DD] VARCHAR(50) NULL,
    [Fld_Ldf_FS] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(500) NULL,
    [Fld_Upd_By] VARCHAR(50) NULL,
    [Fld_Sys_Date] DATETIME NULL,
    [Fld_Upd_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DB_Shrink_Mail
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DB_Shrink_Mail]
(
    [br_name] VARCHAR(100) NULL,
    [fld_server] VARCHAR(50) NULL,
    [fld_DB_Ip] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_Branch_Id] VARCHAR(50) NULL,
    [Fld_Mdf_COD] VARCHAR(50) NULL,
    [Fld_Mdf_BQ] VARCHAR(50) NULL,
    [Fld_Mdf_AQ] VARCHAR(50) NULL,
    [Fld_Mdf_DD] VARCHAR(50) NULL,
    [Fld_Mdf_FS] VARCHAR(50) NULL,
    [Fld_Ldf_COD] VARCHAR(50) NULL,
    [Fld_Ldf_BQ] VARCHAR(50) NULL,
    [Fld_Ldf_AQ] VARCHAR(50) NULL,
    [Fld_Ldf_DD] VARCHAR(50) NULL,
    [Fld_Ldf_FS] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(500) NULL,
    [Fld_Upd_By] VARCHAR(50) NULL,
    [Fld_Upd_Date] VARCHAR(15) NULL,
    [fld_server_id] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DeactiveServer_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DeactiveServer_Master]
(
    [Fld_id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_cd] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_DB_Ip] VARCHAR(50) NULL,
    [From_Date] DATETIME NULL,
    [To_Date] DATETIME NULL,
    [Status] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Department_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Department_Master]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dept_Id] VARCHAR(15) NOT NULL,
    [Fld_Dept_Name] VARCHAR(50) NULL,
    [Fld_Dept_Head] VARCHAR(50) NOT NULL,
    [Fld_Dept_Email] VARCHAR(50) NOT NULL,
    [Fld_Active_Date] DATETIME NULL,
    [Fld_Deactive_Date] DATETIME NULL,
    [Fld_Status] CHAR(2) NULL,
    [Fld_User_Name] VARCHAR(50) NULL,
    [Fld_Ip_Address] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_dept_mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_dept_mapping]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_DeptName] VARCHAR(50) NULL,
    [Fld_EmpID] VARCHAR(50) NULL,
    [Fld_DeptID] INT NULL,
    [flag] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_DEPT_MAPPING_29
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_DEPT_MAPPING_29]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_DeptName] VARCHAR(50) NULL,
    [Fld_EmpID] VARCHAR(50) NULL,
    [Fld_DeptID] INT NULL,
    [flag] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_dept_mapping07
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_dept_mapping07]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_DeptName] VARCHAR(50) NULL,
    [Fld_EmpID] VARCHAR(50) NULL,
    [Fld_DeptID] INT NULL,
    [flag] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Detailsview
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Detailsview]
(
    [AutoID] INT IDENTITY(1,1) NOT NULL,
    [Name] VARCHAR(50) NULL,
    [Address] VARCHAR(50) NULL,
    [Phone] VARCHAR(50) NULL,
    [City] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DIRTextFile_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DIRTextFile_Master]
(
    [Filename] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_DIRTextFileUpload
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_DIRTextFileUpload]
(
    [branch] VARCHAR(30) NULL,
    [manager] VARCHAR(20) NULL,
    [folder] VARCHAR(100) NULL,
    [date] VARCHAR(11) NULL,
    [time] VARCHAR(20) NULL,
    [ampm] VARCHAR(20) NULL,
    [filesize] VARCHAR(50) NULL,
    [filename] VARCHAR(100) NULL,
    [Fld_UploadTime] DATETIME NULL,
    [Fld_srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Exchange_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Exchange_Master]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Segment_Name] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_final_mail
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_final_mail]
(
    [complaint_id] VARCHAR(50) NOT NULL,
    [fld_deptname] VARCHAR(50) NULL,
    [complaint] VARCHAR(5000) NOT NULL,
    [tat] INT NULL,
    [subname] VARCHAR(255) NULL,
    [hr24] VARCHAR(100) NULL,
    [hr48] VARCHAR(100) NULL,
    [hr72] VARCHAR(100) NULL,
    [more72] VARCHAR(30) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_graph
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_graph]
(
    [server] VARCHAR(255) NULL,
    [issues] VARCHAR(50) NULL,
    [a_dt_per] DECIMAL(38, 6) NULL,
    [b_dt_per] DECIMAL(38, 6) NULL,
    [a_Total_Downtime_Per] DECIMAL(38, 6) NULL,
    [b_Total_Downtime_Per] DECIMAL(38, 6) NULL,
    [a_brk_loss] VARCHAR(15) NULL,
    [b_brk_loss] VARCHAR(15) NULL,
    [a_Total_brok_loss] DECIMAL(38, 0) NULL,
    [b_Total_brok_loss] DECIMAL(38, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_helpdesk_location
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_helpdesk_location]
(
    [Location] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_helpdesk_particulars
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_helpdesk_particulars]
(
    [Particular] VARCHAR(500) NULL,
    [sr_no] INT IDENTITY(1,1) NOT NULL,
    [Nos] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_helpdesk_particulars_old
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_helpdesk_particulars_old]
(
    [Manufacturer_Name] VARCHAR(150) NULL,
    [UPS_CAPACTIY_KV] VARCHAR(100) NULL,
    [No_of_Betteris_with_warranty] VARCHAR(150) NULL,
    [Particular] VARCHAR(500) NULL,
    [Load_in_VA] VARCHAR(50) NULL,
    [Nos] VARCHAR(50) NULL,
    [Total_Load] VARCHAR(50) NULL,
    [Testing_Time] VARCHAR(50) NULL,
    [Total_Backup_Tested_Time] VARCHAR(50) NULL,
    [Bettery_Life_Remain_persentage_or_min] VARCHAR(50) NULL,
    [Status_UPS_Warranty_AMC] VARCHAR(50) NULL,
    [Status_all_PM_Date] VARCHAR(50) NULL,
    [Last_Hardwar] VARCHAR(50) NULL,
    [Tested_By] VARCHAR(50) NULL,
    [Verify_By] VARCHAR(50) NULL,
    [from_date] DATETIME NULL,
    [To_date] DATETIME NULL,
    [sr_no] INT IDENTITY(1,1) NOT NULL,
    [Location] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_CatMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_CatMaster]
(
    [FldCatId] INT IDENTITY(1,1) NOT NULL,
    [FldCatName] VARCHAR(50) NOT NULL,
    [FldCatStatus] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_CatSubCategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_CatSubCategory]
(
    [FldCatSubCategoryId] INT IDENTITY(1,1) NOT NULL,
    [FldSubCatSubjectId] INT NULL,
    [FldCatId] INT NULL,
    [FldSSStatus] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_hr_compalint_master_new
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_hr_compalint_master_new]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(1000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(100) NULL,
    [Fld_WIP_Fres] VARCHAR(25) NULL,
    [BINARYFILE] IMAGE NULL,
    [MIMETYPE] VARCHAR(1000) NULL,
    [BINARYFILE_Admin] IMAGE NULL,
    [MIMETYPE_Admin] VARCHAR(50) NULL,
    [File_name_admin] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_hr_complaint_master_new
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_hr_complaint_master_new]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(3000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(100) NULL,
    [Fld_WIP_Fres] VARCHAR(25) NULL,
    [Fld_harmony_date] DATETIME NULL,
    [Fld_taskno] INT NULL,
    [dummy2] BIT NULL,
    [BINARYFILE] IMAGE NULL,
    [MIMETYPE] VARCHAR(1000) NULL,
    [BINARYFILE_Admin] IMAGE NULL,
    [MIMETYPE_Admin] VARCHAR(1000) NULL,
    [File_name_admin] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_hr_complaint_master_NEW_50
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_hr_complaint_master_NEW_50]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(1000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_hr_complaint_master_new_dummy
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_hr_complaint_master_new_dummy]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(3000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(100) NULL,
    [Fld_WIP_Fres] VARCHAR(25) NULL,
    [Fld_harmony_date] DATETIME NULL,
    [Fld_taskno] INT NULL,
    [dummy2] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_hr_complaint_master_old
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_hr_complaint_master_old]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(1000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(100) NULL,
    [Fld_WIP_Fres] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_HR_Solution_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_HR_Solution_Master]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Solution] VARCHAR(500) NULL,
    [Fld_Flag] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_SolutionMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_SolutionMaster]
(
    [FldSolutionId] INT IDENTITY(1,1) NOT NULL,
    [FldSolutionName] VARCHAR(1000) NOT NULL,
    [FldSolutionStatus] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_SolutionMaster_old
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_SolutionMaster_old]
(
    [FldSolutionId] INT IDENTITY(1,1) NOT NULL,
    [FldSolutionName] VARCHAR(500) NOT NULL,
    [FldSolutionStatus] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_SolutionMasterBAK1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_SolutionMasterBAK1]
(
    [FldSolutionId] INT NOT NULL,
    [FldSolutionName] VARCHAR(500) NOT NULL,
    [FldSolutionStatus] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_HR_Solutions
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_HR_Solutions]
(
    [Fld_Sr_No] INT NOT NULL,
    [Fld_Subject] VARCHAR(500) NULL,
    [Fld_Solution] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_SubCategorySubject
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_SubCategorySubject]
(
    [FldSubCatSubjectId] INT IDENTITY(1,1) NOT NULL,
    [FldSSId] INT NULL,
    [FldSubCatId] INT NULL,
    [FldSSStatus] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_SubCatMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_SubCatMaster]
(
    [FldSubCatId] INT IDENTITY(1,1) NOT NULL,
    [FldSubCatName] VARCHAR(50) NOT NULL,
    [FldSubCatStatus] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_SubjectMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_SubjectMaster]
(
    [FldSubjectId] INT IDENTITY(1,1) NOT NULL,
    [FldSubjectName] VARCHAR(2000) NOT NULL,
    [FldSubjectStatus] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HR_SubjectSolution
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HR_SubjectSolution]
(
    [FldSSId] INT IDENTITY(1,1) NOT NULL,
    [FldSubjectId] INT NULL,
    [FldSolutionId] INT NULL,
    [FldSSStatus] CHAR(1) NOT NULL DEFAULT 'Y'
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HrHarmonyNewRequest
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HrHarmonyNewRequest]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_RefNo] INT NULL,
    [Fld_RequestDate] DATETIME NULL,
    [Fld_From] VARCHAR(20) NULL,
    [Fld_QryType] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_DeadLine] DATETIME NULL,
    [Fld_Message] VARCHAR(1000) NULL,
    [fld_FileName] VARCHAR(100) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_Solution] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_HrHarmonyQryType
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_HrHarmonyQryType]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Type] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ip_details
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ip_details]
(
    [fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [fld_branch] VARCHAR(500) NULL,
    [fld_Ip] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(100) NULL,
    [Fld_date] DATETIME NULL,
    [Fld_Subnet_Mask] VARCHAR(50) NULL,
    [Fld_Default_GW] VARCHAR(50) NULL,
    [Fld_IP_ID] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_AngelGroupofCompaniesMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_AngelGroupofCompaniesMaster]
(
    [CompId] INT IDENTITY(1,1) NOT NULL,
    [compName] VARCHAR(50) NULL,
    [status] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_Assetmaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_Assetmaster]
(
    [Fld_AssetID] INT IDENTITY(1,1) NOT NULL,
    [Fld_AssetName] VARCHAR(50) NULL,
    [Fld_AssetType] VARCHAR(20) NULL,
    [Fld_Fdate] DATETIME NULL,
    [Fld_Tdate] DATETIME NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Dummy1] VARCHAR(10) NULL,
    [Fld_Dummy2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_AssignToDeptMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_AssignToDeptMaster]
(
    [Fld_AssignToDeptId] INT IDENTITY(1,1) NOT NULL,
    [Fld_AssignToDeptName] VARCHAR(50) NULL,
    [Fld_DeptHeadName] VARCHAR(20) NULL,
    [Fld_Email] VARCHAR(20) NULL,
    [Fld_Fdate] DATETIME NULL,
    [Fld_Tdate] DATETIME NULL,
    [Fld_Dummy1] VARCHAR(10) NULL,
    [Fld_Dummy2] VARCHAR(10) NULL,
    [Fld_Dummy3] VARCHAR(10) NULL,
    [Fld_Dummy4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Attachment
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Attachment]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Br_Tag] VARCHAR(15) NULL,
    [Br_Attachment] VARCHAR(50) NULL,
    [Br_Date] DATETIME NULL,
    [Br_Head] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Br_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Br_Master]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Br_Tag] VARCHAR(100) NULL,
    [Br_Name] VARCHAR(100) NULL,
    [Br_Type] VARCHAR(100) NULL,
    [Br_Region] VARCHAR(100) NULL,
    [Br_Contact_Person] VARCHAR(100) NULL,
    [Br_Address] VARCHAR(500) NULL,
    [Br_Email] VARCHAR(500) NULL,
    [Br_TelNo] VARCHAR(500) NULL,
    [Br_Fax] VARCHAR(100) NULL,
    [Br_Head] VARCHAR(100) NULL,
    [Br_Head_Mails] VARCHAR(100) NULL,
    [Br_CellNo] VARCHAR(100) NULL,
    [Fld_Business_Category] VARCHAR(10) NULL,
    [Br_Status] CHAR(2) NULL,
    [fdate] DATETIME NULL,
    [tdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_BrMerger_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_BrMerger_Master]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Br_Merged] VARCHAR(100) NOT NULL DEFAULT '',
    [BR_Merged_With] VARCHAR(100) NOT NULL DEFAULT '',
    [Merge_Eff_Date] DATETIME NOT NULL DEFAULT (getdate()),
    [MergeStatus] CHAR(1) NOT NULL DEFAULT '',
    [CreatedOn] DATETIME NOT NULL DEFAULT (getdate()),
    [CreatedBy] VARCHAR(50) NOT NULL DEFAULT '',
    [ModifiedOn] DATETIME NOT NULL DEFAULT (getdate()),
    [ModifiedBy] VARCHAR(50) NOT NULL DEFAULT ''
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_CapexMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_CapexMaster]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_CapexCode] VARCHAR(50) NULL,
    [Fld_Capex] VARCHAR(300) NULL,
    [Fld_CapexType] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Connectivity
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Connectivity]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Br_Type] VARCHAR(30) NULL,
    [Fld_Branch_Code] VARCHAR(30) NULL,
    [Fld_Link_Type] VARCHAR(50) NULL,
    [Fld_LL] VARCHAR(50) NULL,
    [Fld_LL_ID] VARCHAR(50) NULL,
    [Fld_Bandwidth] VARCHAR(50) NULL,
    [Fld_Purpose] VARCHAR(100) NULL,
    [Fld_Activate_Date] VARCHAR(11) NULL,
    [Fld_Expiring_Date] VARCHAR(11) NULL,
    [Fld_SP_Name] VARCHAR(50) NULL,
    [Fld_SP_Tel_No] VARCHAR(50) NULL,
    [Fld_Contact_No] VARCHAR(50) NULL,
    [Fld_Remark] VARCHAR(100) NULL,
    [Fld_UPd_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_events
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_events]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [Dt] DATETIME NULL,
    [Location] VARCHAR(255) NULL,
    [TimeFrom] VARCHAR(20) NULL,
    [TimeTo] VARCHAR(20) NULL,
    [EventParticulars] VARCHAR(1000) NULL,
    [Solution] VARCHAR(5000) NULL,
    [Problem] VARCHAR(5000) NULL,
    [ImpactedSegemnt] VARCHAR(100) NULL,
    [downtime] VARCHAR(10) NULL,
    [downtimemin] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_inventory
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_inventory]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [br_id] VARCHAR(11) NULL,
    [desktops] VARCHAR(11) NULL,
    [desktop_server] VARCHAR(11) NULL,
    [branded_server] VARCHAR(11) NULL,
    [laptops] VARCHAR(11) NULL,
    [enteredby] VARCHAR(50) NULL,
    [enteredon] DATETIME NULL,
    [remark] VARCHAR(100) NULL,
    [updatedon] DATETIME NULL,
    [Year] VARCHAR(5) NULL,
    [month] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_IPaddress
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_IPaddress]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch] VARCHAR(50) NULL,
    [Fld_IpFrom] VARCHAR(15) NULL,
    [Fld_IpTo] VARCHAR(15) NULL,
    [Fld_SB_mask] VARCHAR(15) NULL,
    [Fld_Def_GT] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(500) NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_User] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_Jobs_Log_Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_Jobs_Log_Detail]
(
    [Brcode] VARCHAR(50) NULL,
    [FromID] VARCHAR(5000) NULL,
    [ToID] VARCHAR(5000) NULL,
    [Subject] VARCHAR(5000) NULL,
    [MailContent] VARCHAR(5000) NULL,
    [JobName] VARCHAR(5000) NULL,
    [MailSentDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_LocationMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_LocationMaster]
(
    [Fld_LocationId] INT IDENTITY(1,1) NOT NULL,
    [Fld_LocationTag] VARCHAR(50) NULL,
    [Fld_LocationName] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Network_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Network_Data]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Br_Type] VARCHAR(15) NULL,
    [Fld_Br_Code] VARCHAR(15) NULL,
    [Fld_Equip_Type] VARCHAR(50) NULL,
    [Fld_Equip_Name] VARCHAR(50) NULL,
    [Fld_Make] VARCHAR(25) NULL,
    [Fld_Series] VARCHAR(25) NULL,
    [Fld_LanPort] VARCHAR(25) NULL,
    [Fld_LanPort1] VARCHAR(50) NULL,
    [Fld_WanPort] VARCHAR(25) NULL,
    [Fld_WanPort1] VARCHAR(50) NULL,
    [Fld_WanPort2] VARCHAR(50) NULL,
    [Fld_IP_Address] VARCHAR(15) NULL,
    [Fld_Install_Date] VARCHAR(11) NULL,
    [Fld_Warranty_From] VARCHAR(11) NULL,
    [Fld_Warranty_To] VARCHAR(11) NULL,
    [Fld_Supplier_Name] VARCHAR(100) NULL,
    [Fld_Contact_No] VARCHAR(50) NULL,
    [Fld_AMC_From] VARCHAR(11) NULL,
    [Fld_AMC_To] VARCHAR(11) NULL,
    [Fld_AMC_Provider_Name] VARCHAR(100) NULL,
    [Fld_AMC_Contact_No] VARCHAR(50) NULL,
    [Fld_Managed] VARCHAR(15) NULL,
    [Fld_Purpose] VARCHAR(100) NULL,
    [Fld_Upd_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Reports_details
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Reports_details]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_id] INT NULL,
    [Fld_Br_Code] VARCHAR(20) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Fet_Date] DATETIME NULL,
    [Fld_Upd_Date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Reports_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Reports_Master]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Rpt_Name] VARCHAR(50) NULL,
    [Fld_Rpt_Url] VARCHAR(50) NULL,
    [Fld_Rpt_For] VARCHAR(50) NULL,
    [Fld_Frq] INT NULL,
    [Fld_Cut_off] VARCHAR(50) NULL,
    [Fld_Entry_By] VARCHAR(15) NULL,
    [Fld_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_Staff_New
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_Staff_New]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Emp_No] VARCHAR(15) NULL,
    [Fld_Emp_Name] VARCHAR(100) NULL,
    [Fld_Phone] VARCHAR(50) NULL,
    [Fld_JoinDate] DATETIME NULL,
    [Fld_emailadd] VARCHAR(50) NULL,
    [Fld_DeptId] INT NULL,
    [Fld_Branch_Id] VARCHAR(50) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_EmpType] VARCHAR(15) NULL,
    [Fld_Upd_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_Staff_test
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_Staff_test]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Emp_No] VARCHAR(15) NULL,
    [Fld_Emp_Name] VARCHAR(100) NULL,
    [Fld_Phone] VARCHAR(50) NULL,
    [Fld_JoinDate] DATETIME NULL,
    [Fld_emailadd] VARCHAR(50) NULL,
    [Fld_DeptId] INT NULL,
    [Fld_Branch_Id] INT NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_EmpType] VARCHAR(15) NULL,
    [Fld_Upd_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_Taxes
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_Taxes]
(
    [Fld_RequestID] INT NULL,
    [Fld_Excise] FLOAT NULL,
    [Fld_Edn_Cess] FLOAT NULL,
    [Fld_CST] FLOAT NULL,
    [Fld_VAT] FLOAT NULL,
    [Fld_Service] FLOAT NULL,
    [Fld_Frieght] FLOAT NULL,
    [Fld_Octroi] FLOAT NULL,
    [Fld_Discount] FLOAT NULL,
    [Fld_Status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_IT_UPSWANLink_EmailID
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_IT_UPSWANLink_EmailID]
(
    [IE_ID] INT IDENTITY(1,1) NOT NULL,
    [IE_Region] VARCHAR(50) NOT NULL,
    [IE_Branch_Tag] VARCHAR(50) NOT NULL,
    [IE_Branch_SrNo] VARCHAR(50) NOT NULL,
    [IE_Employee_Email] VARCHAR(1000) NOT NULL,
    [IE_CC_Email] VARCHAR(50) NOT NULL,
    [IE_GroupID] VARCHAR(50) NOT NULL,
    [IE_Status] CHAR(1) NOT NULL,
    [IE_Region_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_it_vendormaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_it_vendormaster]
(
    [Fld_VendorCode] INT IDENTITY(1,1) NOT NULL,
    [Fld_VendorName] VARCHAR(250) NULL,
    [Fld_Address1] VARCHAR(200) NULL,
    [Fld_Address2] VARCHAR(200) NULL,
    [Fld_Address3] VARCHAR(200) NULL,
    [Fld_Status] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Wanlink
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Wanlink]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Link] VARCHAR(50) NULL,
    [Fld_Connectivity_Type] VARCHAR(50) NULL,
    [Fld_Chk_Id] VARCHAR(100) NULL,
    [Fld_Provider] VARCHAR(50) NULL,
    [Fld_BandWidth] VARCHAR(50) NULL,
    [Fld_Purpose] VARCHAR(200) NULL,
    [Fld_Region] VARCHAR(50) NULL,
    [Fld_Branch] VARCHAR(100) NULL,
    [Fld_Entry_By] VARCHAR(50) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Status] CHAR(1) NULL,
    [Tested_by] VARCHAR(50) NULL,
    [Verified_by] VARCHAR(50) NULL,
    [Remark] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Wanlink_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Wanlink_Data]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Link] VARCHAR(50) NULL,
    [Fld_Connectivity_Type] VARCHAR(50) NULL,
    [Fld_Chk_Id] VARCHAR(100) NULL,
    [Fld_Provider] VARCHAR(50) NULL,
    [Fld_BandWidth] VARCHAR(50) NULL,
    [Fld_Purpose] VARCHAR(200) NULL,
    [Fld_CSO] VARCHAR(50) NULL,
    [Fld_Branch] VARCHAR(100) NULL,
    [Fld_Entry_By] VARCHAR(50) NULL,
    [Fld_Entry_Date] DATETIME NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Type] VARCHAR(50) NULL,
    [ActiveStatus] CHAR(10) NULL,
    [InactiveDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Wanlink_Update_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Wanlink_Update_Data]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Id] INT NULL,
    [Fld_Fetch_Date] DATETIME NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_Status] CHAR(10) NULL,
    [Fld_Connectivity_Type] VARCHAR(50) NULL,
    [Fld_DOFT] DATETIME NULL,
    [Fld_First_TestBy] VARCHAR(50) NULL,
    [Fld_First_Remark] VARCHAR(150) NULL,
    [Fld_DOST] DATETIME NULL,
    [Fld_Second_TestBy] VARCHAR(150) NULL,
    [Fld_Second_Remark] VARCHAR(150) NULL,
    [Fld_FEmpCode] VARCHAR(15) NULL,
    [Fld_SEmpCode] VARCHAR(15) NULL,
    [ActiveStatus] CHAR(10) NULL,
    [InactiveDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_IT_Wanlink_Update_Data_history
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_IT_Wanlink_Update_Data_history]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Id] INT NULL,
    [Fld_Fetch_Date] DATETIME NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_Status] CHAR(10) NULL,
    [Fld_Connectivity_Type] VARCHAR(50) NULL,
    [Fld_DOFT] DATETIME NULL,
    [Fld_First_TestBy] VARCHAR(50) NULL,
    [Fld_First_Remark] VARCHAR(150) NULL,
    [Fld_DOST] DATETIME NULL,
    [Fld_Second_TestBy] VARCHAR(150) NULL,
    [Fld_Second_Remark] VARCHAR(150) NULL,
    [Fld_FEmpCode] VARCHAR(15) NULL,
    [Fld_SEmpCode] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITAssetsData
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITAssetsData]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_RequestId] INT NULL,
    [Fld_ProductType] VARCHAR(50) NULL,
    [Fld_ProductName] VARCHAR(100) NULL,
    [Fld_ProductModel] VARCHAR(100) NULL,
    [Fld_ProductDesc] VARCHAR(1000) NULL,
    [Fld_AssetName] VARCHAR(100) NULL,
    [Fld_AssetTag] VARCHAR(50) NULL,
    [Fld_PartNo] VARCHAR(100) NULL,
    [Fld_VendorName] VARCHAR(500) NULL,
    [Fld_Qty] NUMERIC(18, 0) NULL,
    [Fld_Rate] NUMERIC(18, 2) NULL,
    [Fld_WarrantyFrom] VARCHAR(25) NULL,
    [Fld_WarrantyTo] VARCHAR(25) NULL,
    [Fld_BranchCode] VARCHAR(50) NULL,
    [Fld_AssignToDept] VARCHAR(50) NULL,
    [Fld_BillNo] VARCHAR(25) NULL,
    [Fld_ChallanNo] VARCHAR(25) NULL,
    [Fld_Purpose] VARCHAR(500) NULL,
    [Fld_Status] VARCHAR(5) NULL,
    [Fld_SystemDate] DATETIME NULL,
    [Fld_CapexName] VARCHAR(30) NULL,
    [Fld_WarrantyType] VARCHAR(15) NULL,
    [Fld_Pid] VARCHAR(20) NULL,
    [Fld_RequestTableSrNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITAssetsData_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITAssetsData_temp]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_RequestId] INT NULL,
    [Fld_ProductModel] VARCHAR(100) NULL,
    [Fld_ProductDesc] VARCHAR(100) NULL,
    [Fld_AssetName] VARCHAR(100) NULL,
    [Fld_PartNo] VARCHAR(100) NULL,
    [Fld_VendorName] VARCHAR(500) NULL,
    [Fld_Qty] NUMERIC(18, 0) NULL,
    [Fld_Rate] NUMERIC(18, 0) NULL,
    [Fld_WarrantyFrom] VARCHAR(25) NULL,
    [Fld_WarrantyTo] VARCHAR(25) NULL,
    [Fld_BranchCode] VARCHAR(50) NULL,
    [Fld_AssignToDept] VARCHAR(50) NULL,
    [Fld_BillNo] VARCHAR(25) NULL,
    [Fld_ChallanNo] VARCHAR(25) NULL,
    [Fld_Purpose] VARCHAR(500) NULL,
    [Fld_Status] VARCHAR(5) NULL,
    [Fld_SystemDate] DATETIME NULL,
    [Fld_CapexName] VARCHAR(30) NULL,
    [Fld_WarrantyType] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITAssetsData_tmpdata
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITAssetsData_tmpdata]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_RequestId] INT NULL,
    [Fld_ProductType] VARCHAR(50) NULL,
    [Fld_ProductName] VARCHAR(100) NULL,
    [Fld_ProductModel] VARCHAR(100) NULL,
    [Fld_ProductDesc] VARCHAR(1000) NULL,
    [Fld_AssetName] VARCHAR(100) NULL,
    [Fld_AssetTag] VARCHAR(50) NULL,
    [Fld_PartNo] VARCHAR(100) NULL,
    [Fld_VendorName] VARCHAR(500) NULL,
    [Fld_Qty] NUMERIC(18, 0) NULL,
    [Fld_Rate] NUMERIC(18, 2) NULL,
    [Fld_WarrantyFrom] VARCHAR(25) NULL,
    [Fld_WarrantyTo] VARCHAR(25) NULL,
    [Fld_BranchCode] VARCHAR(50) NULL,
    [Fld_AssignToDept] VARCHAR(50) NULL,
    [Fld_BillNo] VARCHAR(25) NULL,
    [Fld_ChallanNo] VARCHAR(25) NULL,
    [Fld_Purpose] VARCHAR(500) NULL,
    [Fld_Status] VARCHAR(5) NULL,
    [Fld_SystemDate] DATETIME NULL,
    [Fld_CapexName] VARCHAR(30) NULL,
    [Fld_WarrantyType] VARCHAR(15) NULL,
    [Fld_Pid] VARCHAR(20) NULL,
    [Fld_RequestTableSrNo] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITRequest_Description
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITRequest_Description]
(
    [Fld_RequestId] INT NULL,
    [Fld_RequestDesc] VARCHAR(5000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITRequestCondition
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITRequestCondition]
(
    [Fld_srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_condition] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITRequestCondition_History
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITRequestCondition_History]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [POID] INT NULL,
    [con1] VARCHAR(100) NULL,
    [con2] VARCHAR(100) NULL,
    [con3] VARCHAR(100) NULL,
    [con4] VARCHAR(100) NULL,
    [con5] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITRequestMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITRequestMaster]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_RequestId] INT NULL,
    [Fld_AssetType] INT NULL,
    [Fld_RequestTime] DATETIME NULL,
    [Fld_ForwardTime] DATETIME NULL,
    [Fld_CompletedTime] DATETIME NULL,
    [Fld_Status] VARCHAR(4) NULL,
    [Fld_AccessCode] VARCHAR(50) NULL,
    [Fld_BranchCode] VARCHAR(50) NULL,
    [Fld_RequestBy] VARCHAR(50) NULL,
    [Fld_ForwardBy] VARCHAR(50) NULL,
    [Fld_CompletedBy] VARCHAR(50) NULL,
    [Fld_AdminRemark] VARCHAR(5000) NULL,
    [Fld_Recommended_By] VARCHAR(200) NULL,
    [FLD_CSOForwardBY] VARCHAR(50) NULL,
    [Fld_QTY] NUMERIC(18, 0) NULL,
    [Department] VARCHAR(50) NULL,
    [Fld_dummy5] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITRequestMaster_tmpdata
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITRequestMaster_tmpdata]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_RequestId] INT NULL,
    [Fld_AssetType] INT NULL,
    [Fld_RequestTime] DATETIME NULL,
    [Fld_ForwardTime] DATETIME NULL,
    [Fld_CompletedTime] DATETIME NULL,
    [Fld_Status] VARCHAR(4) NULL,
    [Fld_AccessCode] VARCHAR(50) NULL,
    [Fld_BranchCode] VARCHAR(50) NULL,
    [Fld_RequestBy] VARCHAR(50) NULL,
    [Fld_ForwardBy] VARCHAR(50) NULL,
    [Fld_CompletedBy] VARCHAR(50) NULL,
    [Fld_AdminRemark] VARCHAR(5000) NULL,
    [Fld_Recommended_By] VARCHAR(200) NULL,
    [FLD_CSOForwardBY] VARCHAR(50) NULL,
    [Fld_QTY] NUMERIC(18, 0) NULL,
    [Department] VARCHAR(50) NULL,
    [Fld_dummy5] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ItRequestPurchaseOrder
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ItRequestPurchaseOrder]
(
    [Fld_RequestId] INT NULL,
    [Fld_VendorId] INT NULL,
    [Fld_VendorName] VARCHAR(200) NULL,
    [Fld_PurchaseOrderNo] VARCHAR(100) NULL,
    [Fld_ShipTo] VARCHAR(200) NULL,
    [Fld_ShippingMethod] VARCHAR(50) NULL,
    [Fld_OrderTerms] VARCHAR(50) NULL,
    [Fld_DeliveryDate] DATETIME NULL,
    [Fld_CompID] INT NULL,
    [Fld_PId] INT NOT NULL DEFAULT 0,
    [POBranch] VARCHAR(20) NULL,
    [PODeliveryTime] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ItRequestPurchaseOrder_tmpdata
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ItRequestPurchaseOrder_tmpdata]
(
    [Fld_RequestId] INT NULL,
    [Fld_VendorId] INT NULL,
    [Fld_VendorName] VARCHAR(200) NULL,
    [Fld_PurchaseOrderNo] VARCHAR(100) NULL,
    [Fld_ShipTo] VARCHAR(200) NULL,
    [Fld_ShippingMethod] VARCHAR(50) NULL,
    [Fld_OrderTerms] VARCHAR(50) NULL,
    [Fld_DeliveryDate] DATETIME NULL,
    [Fld_CompID] INT NULL,
    [Fld_PId] INT NOT NULL,
    [POBranch] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITRequestType
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITRequestType]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_RequestName] VARCHAR(50) NULL,
    [Fld_RequestStatus] CHAR(1) NULL DEFAULT 'Y',
    [Fld_Dummy1] VARCHAR(10) NULL,
    [Fld_Dummy2] VARCHAR(10) NULL,
    [Fld_Dummy3] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITStaff_OtherDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITStaff_OtherDetails]
(
    [ITSO_ID] INT IDENTITY(1,1) NOT NULL,
    [ITSO_EmpId] VARCHAR(10) NOT NULL DEFAULT '',
    [ITSO_EmpName] VARCHAR(50) NOT NULL DEFAULT '',
    [ITSO_CSCP] VARCHAR(100) NOT NULL DEFAULT '',
    [ITSO_Group_1] VARCHAR(100) NOT NULL DEFAULT '',
    [ITSO_Group_2] VARCHAR(100) NOT NULL DEFAULT '',
    [ITSO_RM_User] VARCHAR(10) NOT NULL DEFAULT ''
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ITStaffMaster_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ITStaffMaster_Log]
(
    [Emp No] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [HOD No] VARCHAR(6) NULL,
    [HOD Name] VARCHAR(150) NULL,
    [Company Name] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [Lob] INT NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub Department] VARCHAR(150) NULL,
    [Designation] VARCHAR(255) NULL,
    [Location Address] VARCHAR(5000) NULL,
    [LEVEL] VARCHAR(50) NULL,
    [categorydesc] VARCHAR(50) NULL,
    [Costcode] NVARCHAR(255) NULL,
    [Join Date] DATETIME NULL,
    [Separation Date] DATETIME NULL,
    [emailadd] VARCHAR(100) NULL,
    [sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [PHONE] VARCHAR(50) NULL,
    [JOINDATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [Address] NVARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State] NVARCHAR(25) NULL,
    [Account No] VARCHAR(20) NULL,
    [pincode] VARCHAR(20) NULL,
    [Functional Head] VARCHAR(500) NULL,
    [flgCSOBranch] NCHAR(6) NULL,
    [tpdlgcode] NVARCHAR(50) NULL,
    [LOBDESC] VARCHAR(100) NULL,
    [IT_Location] NVARCHAR(255) NULL,
    [Modified_By] VARCHAR(20) NULL,
    [Modified_Datetime] DATETIME NULL,
    [Modification_Remark] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Link_master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Link_master]
(
    [Fld_link] VARCHAR(10) NULL,
    [link_name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Mail_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Mail_Mapping]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Gc_Guid] VARCHAR(100) NULL,
    [Fld_Req_Id] INT NULL,
    [Fld_Forward_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Manager_Cert_Validity
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Manager_Cert_Validity]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Id] INT NULL,
    [Fld_Segment] CHAR(8) NULL,
    [Fld_Manager_Id] CHAR(10) NULL,
    [Fld_From_Date] DATETIME NULL,
    [Fld_To_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Manager_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Manager_Master]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Id] INT NULL,
    [Fld_Segment] VARCHAR(15) NULL,
    [Fld_Manager_Id] VARCHAR(15) NULL,
    [Fld_From_Date] DATETIME NULL,
    [Fld_To_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Manager_Master_27Oct2014
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Manager_Master_27Oct2014]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Id] INT NULL,
    [Fld_Segment] VARCHAR(15) NULL,
    [Fld_Manager_Id] VARCHAR(15) NULL,
    [Fld_From_Date] DATETIME NULL,
    [Fld_To_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Manager_Master_BackUp
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Manager_Master_BackUp]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Id] INT NULL,
    [Fld_Segment] VARCHAR(15) NULL,
    [Fld_Manager_Id] VARCHAR(15) NULL,
    [Fld_From_Date] DATETIME NULL,
    [Fld_To_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_mm
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_mm]
(
    [srno] INT NULL,
    [mm] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Ncfm_Exam_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Ncfm_Exam_Master]
(
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_NcfmCode] VARCHAR(15) NULL,
    [Fld_Examtype] VARCHAR(50) NULL,
    [Fld_exammodule] VARCHAR(50) NULL,
    [Fld_registration_no] VARCHAR(50) NULL,
    [Fld_preferredl_loc] VARCHAR(50) NULL,
    [Fld_preferred_date] DATETIME NULL,
    [Fld_AllocatedDate] DATETIME NULL,
    [Fld_Month] VARCHAR(50) NULL,
    [Fld_preferred_time] VARCHAR(50) NULL,
    [Fld_Entereddate] DATETIME NULL,
    [Fld_EmpCode] VARCHAR(50) NULL,
    [Fld_Approvedby] VARCHAR(50) NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_Approveddate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ncfmresult
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ncfmresult]
(
    [Fld_sr_no] INT IDENTITY(1,1) NOT NULL,
    [Fld_Empcode] VARCHAR(50) NULL,
    [Fld_ncfmcode] VARCHAR(50) NULL,
    [Fld_attemptexam] CHAR(18) NULL,
    [Fld_result] CHAR(10) NULL,
    [Fld_passper] VARCHAR(50) NULL,
    [Fld_attachment] IMAGE NULL,
    [Fld_entrydate] DATETIME NULL,
    [Fld_DocType] VARCHAR(50) NULL,
    [Fld_FName] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_odin_checklist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_odin_checklist]
(
    [fld_srno] INT IDENTITY(1,1) NOT NULL,
    [fld_branch_id] VARCHAR(50) NULL,
    [fld_server_id] INT NULL,
    [Entrydate] DATETIME NULL,
    [updateddate] DATETIME NULL,
    [enteredby] VARCHAR(100) NULL,
    [1] VARCHAR(255) NULL,
    [1Comment] VARCHAR(255) NULL,
    [2] VARCHAR(255) NULL,
    [2comment] VARCHAR(255) NULL,
    [3] VARCHAR(255) NULL,
    [3comment] VARCHAR(255) NULL,
    [4] VARCHAR(255) NULL,
    [4comment] VARCHAR(255) NULL,
    [5] VARCHAR(255) NULL,
    [5comment] VARCHAR(255) NULL,
    [6] VARCHAR(255) NULL,
    [6comment] VARCHAR(255) NULL,
    [7] VARCHAR(255) NULL,
    [7comment] VARCHAR(255) NULL,
    [8] VARCHAR(255) NULL,
    [8comment] VARCHAR(255) NULL,
    [9] VARCHAR(255) NULL,
    [9comment] VARCHAR(255) NULL,
    [10] VARCHAR(255) NULL,
    [10comment] VARCHAR(255) NULL,
    [11] VARCHAR(255) NULL,
    [11comment] VARCHAR(255) NULL,
    [12] VARCHAR(255) NULL,
    [12comment] VARCHAR(255) NULL,
    [13] VARCHAR(255) NULL,
    [13comment] VARCHAR(255) NULL,
    [14] VARCHAR(255) NULL,
    [14comment] VARCHAR(255) NULL,
    [15] VARCHAR(255) NULL,
    [15comment] VARCHAR(255) NULL,
    [16] VARCHAR(255) NULL,
    [16comment] VARCHAR(255) NULL,
    [17] VARCHAR(255) NULL,
    [17comment] VARCHAR(255) NULL,
    [18] VARCHAR(255) NULL,
    [18comment] VARCHAR(255) NULL,
    [19] VARCHAR(255) NULL,
    [19comment] VARCHAR(255) NULL,
    [20] VARCHAR(255) NULL,
    [20comment] VARCHAR(255) NULL,
    [21] VARCHAR(255) NULL,
    [21comment] VARCHAR(255) NULL,
    [22] VARCHAR(255) NULL,
    [22comment] VARCHAR(255) NULL,
    [23] VARCHAR(255) NULL,
    [23comment] VARCHAR(255) NULL,
    [24] VARCHAR(255) NULL,
    [24comment] VARCHAR(255) NULL,
    [25] VARCHAR(255) NULL,
    [25comment] VARCHAR(255) NULL,
    [26] VARCHAR(255) NULL,
    [26comment] VARCHAR(255) NULL,
    [27] VARCHAR(255) NULL,
    [27comment] VARCHAR(255) NULL,
    [28] VARCHAR(255) NULL,
    [28comment] VARCHAR(255) NULL,
    [29] VARCHAR(255) NULL,
    [29comment] VARCHAR(255) NULL,
    [30] VARCHAR(255) NULL,
    [30comment] VARCHAR(255) NULL,
    [31] VARCHAR(255) NULL,
    [31comment] VARCHAR(255) NULL,
    [32] VARCHAR(255) NULL,
    [32comment] VARCHAR(255) NULL,
    [33] VARCHAR(255) NULL,
    [33comment] VARCHAR(255) NULL,
    [34] VARCHAR(255) NULL,
    [34comment] VARCHAR(255) NULL,
    [35] VARCHAR(255) NULL,
    [35comment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_odinchecklist_cutofftime
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_odinchecklist_cutofftime]
(
    [sr_no] INT IDENTITY(1,1) NOT NULL,
    [procedureid] INT NULL,
    [cutofftime] VARCHAR(255) NULL,
    [br_tag] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Order_Confirmation
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Order_Confirmation]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Contact_Person] VARCHAR(100) NULL,
    [Fld_Confimation_Time] VARCHAR(15) NULL,
    [Fld_Staus] VARCHAR(1000) NULL,
    [Fld_Reason] VARCHAR(1000) NULL,
    [Fld_UPD_By] VARCHAR(15) NULL,
    [Fld_UPD_Time] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Order_Confirmation_21Oct2014
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Order_Confirmation_21Oct2014]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Contact_Person] VARCHAR(100) NULL,
    [Fld_Confimation_Time] VARCHAR(15) NULL,
    [Fld_Staus] VARCHAR(1000) NULL,
    [Fld_Reason] VARCHAR(1000) NULL,
    [Fld_UPD_By] VARCHAR(15) NULL,
    [Fld_UPD_Time] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Order_Confirmation_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Order_Confirmation_bak]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Contact_Person] VARCHAR(100) NULL,
    [Fld_Confimation_Time] VARCHAR(15) NULL,
    [Fld_Staus] VARCHAR(1000) NULL,
    [Fld_Reason] VARCHAR(1000) NULL,
    [Fld_UPD_By] VARCHAR(15) NULL,
    [Fld_UPD_Time] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Printer_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Printer_Master]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Mfg_id] INT NULL,
    [Fld_Model_No] VARCHAR(50) NULL,
    [Fld_Serial_No] VARCHAR(50) NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_User_Name] VARCHAR(50) NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [Fld_Upd_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Printer_Updates
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Printer_Updates]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Printer_Id] INT NULL,
    [Fld_DT_Date] DATETIME NULL,
    [Fld_DT_From] VARCHAR(10) NULL,
    [Fld_DT_To] VARCHAR(10) NULL,
    [Fld_Total_DT] VARCHAR(10) NULL,
    [Fld_Problem] VARCHAR(200) NULL,
    [Fld_Solution] VARCHAR(200) NULL,
    [Fld_Status] VARCHAR(50) NULL,
    [Fld_Part_Name] VARCHAR(50) NULL,
    [Fld_Port_No] VARCHAR(50) NULL,
    [Fld_Serial_No] VARCHAR(50) NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [Fld_Upd_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ProcessStatus_OHelpdesk
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ProcessStatus_OHelpdesk]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [status] VARCHAR(25) NULL,
    [Svalue] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Provider
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Provider]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Fld_Provider] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Query_type
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Query_type]
(
    [Fld_Sr_No] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Fld_Query_Name] VARCHAR(50) NULL,
    [Fld_Created_Date] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rates
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rates]
(
    [Scrip] VARCHAR(10) NULL,
    [Time] VARCHAR(10) NULL,
    [Value] INT NULL,
    [Sensex] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Region_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Region_Master]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_RegCode] VARCHAR(50) NULL,
    [Fld_RegName] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_RegionMaster_UPSWanlink
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_RegionMaster_UPSWanlink]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_RegCode] VARCHAR(50) NULL,
    [Fld_RegName] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Request_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Request_Master]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Dept] VARCHAR(10) NULL,
    [Fld_Request] VARCHAR(50) NULL,
    [Fld_EmpCode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Request_Master_Mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Request_Master_Mapping]
(
    [Fld_SrNo] INT NOT NULL,
    [Fld_EmpCode] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_SBS_Mapp
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_SBS_Mapp]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_SBS_Id] INT NULL,
    [Fld_Id] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_SBS_Mast
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_SBS_Mast]
(
    [Fld_SBS_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_SBS_Name] VARCHAR(50) NULL,
    [Fld_SBS_Ip] VARCHAR(15) NULL,
    [Fld_Remark] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Sbs_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Sbs_Master]
(
    [Fld_Sbs_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Sbs_Name] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_sbschecklist
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_sbschecklist]
(
    [fld_srno] INT IDENTITY(1,1) NOT NULL,
    [fld_branch_id] VARCHAR(50) NULL,
    [fld_server_id] INT NULL,
    [Entrydate] DATETIME NULL,
    [updateddate] DATETIME NULL,
    [enteredby] VARCHAR(100) NULL,
    [1] VARCHAR(255) NULL,
    [1Comment] VARCHAR(255) NULL,
    [2] VARCHAR(255) NULL,
    [2comment] VARCHAR(255) NULL,
    [3] VARCHAR(255) NULL,
    [3comment] VARCHAR(255) NULL,
    [4] VARCHAR(255) NULL,
    [4comment] VARCHAR(255) NULL,
    [5] VARCHAR(255) NULL,
    [5comment] VARCHAR(255) NULL,
    [6] VARCHAR(255) NULL,
    [6comment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Segemt_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Segemt_Master]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Segment_Name] VARCHAR(50) NOT NULL DEFAULT ''
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Segment_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Segment_Master]
(
    [Fld_Segments] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Server_Mapp
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Server_Mapp]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Cd] VARCHAR(15) NULL,
    [Fld_Server_Id] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Server_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Server_Master]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_cd] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_DB_Ip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_server_master_22Oct2014
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_server_master_22Oct2014]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_cd] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_DB_Ip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_server_master_27oCT2014
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_server_master_27oCT2014]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_cd] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_DB_Ip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Server_Master_31Oct2014
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Server_Master_31Oct2014]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_cd] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_DB_Ip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Server_Master_DIR
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Server_Master_DIR]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_cd] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_DB_Ip] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Server_Master_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Server_Master_New]
(
    [Fld_Id] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_cd] VARCHAR(50) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Odin_Ip] VARCHAR(50) NULL,
    [Fld_DB_Ip] VARCHAR(50) NULL,
    [Activation_Date] DATETIME NULL,
    [Deactivation_Date] DATETIME NULL,
    [Status] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject_bkp_0210
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject_bkp_0210]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject02
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject02]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject03
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject03]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject09112010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject09112010]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject10
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject10]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject14
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject14]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject16082010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject16082010]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject26072010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject26072010]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_subject30aug2010
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_subject30aug2010]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [fld_deptid] INT NULL,
    [fld_queryid] INT NULL,
    [Subject] VARCHAR(255) NULL,
    [Mandatory_Requirements] VARCHAR(255) NULL,
    [Flag] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_TCP
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_TCP]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Server_Id] VARCHAR(50) NULL,
    [Fld_Login_Time] VARCHAR(10) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_User_Name] VARCHAR(50) NULL,
    [Fld_Entry_Time] DATETIME NULL,
    [Fld_Count] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Tcp_Count
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Tcp_Count]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] VARCHAR(15) NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0115] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_Flag] CHAR(2) NULL,
    [Fld_EmpCode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Tcp_Count_11Nov2016
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Tcp_Count_11Nov2016]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] VARCHAR(15) NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0115] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_Flag] CHAR(2) NULL,
    [Fld_EmpCode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Tcp_Count_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Tcp_Count_bak]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] VARCHAR(15) NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0115] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_Flag] CHAR(2) NULL,
    [Fld_EmpCode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Tcp_Count_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Tcp_Count_Log]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] VARCHAR(15) NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0115] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_Flag] CHAR(2) NULL,
    [Fld_EmpCode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Tcp_Count_Mail
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Tcp_Count_Mail]
(
    [Br_Name] VARCHAR(100) NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Tcp_1015] VARCHAR(30) NULL,
    [Fld_Tcp_0115] VARCHAR(30) NULL,
    [Fld_Tcp_0315] VARCHAR(30) NULL,
    [Fld_Sur_cnt] VARCHAR(30) NULL,
    [Fld_Remark] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Tcp_Count_phy
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Tcp_Count_phy]
(
    [Srno] BIGINT NULL,
    [Fld_Server_id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_EmpCode] VARCHAR(12) NULL,
    [PrevDay_Sur_Cnt] INT NOT NULL,
    [First_Sur_Cnt] INT NOT NULL,
    [FLd_Server] VARCHAR(50) NULL,
    [server_id] INT NULL,
    [Emp_name] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Tcp_Count_phy1
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Tcp_Count_phy1]
(
    [Srno] BIGINT NULL,
    [Fld_Server_id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_EmpCode] VARCHAR(12) NULL,
    [PrevDay_Sur_Cnt] INT NOT NULL,
    [First_Sur_Cnt] INT NOT NULL,
    [FLd_Server] VARCHAR(50) NULL,
    [server_id] INT NULL,
    [Emp_name] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Tcp_Count_recover
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Tcp_Count_recover]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] VARCHAR(15) NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0115] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_Flag] CHAR(2) NULL,
    [Fld_EmpCode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Tcp_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Tcp_Master]
(
    [Fld_Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Fld_Location] VARCHAR(30) NULL,
    [Fld_Server] VARCHAR(30) NULL,
    [Fld_Sb_Name] VARCHAR(30) NULL,
    [Fld_Time] VARCHAR(20) NULL,
    [Fld_Tcp_Count] NUMERIC(18, 0) NULL,
    [Fld_Entered_Date] DATETIME NULL,
    [Fld_Ip_Address] VARCHAR(15) NULL,
    [Fld_Sur_Count] VARCHAR(11) NULL,
    [Fld_Remark] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_tcpcnt
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_tcpcnt]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] VARCHAR(15) NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0115] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_Flag] CHAR(2) NULL,
    [Fld_EmpCode] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_terminal_brok_loss
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_terminal_brok_loss]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [Brokerage] MONEY NULL,
    [dt] VARCHAR(20) NULL,
    [uptime] VARCHAR(20) NULL,
    [Brk_Loss] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [issues] VARCHAR(50) NULL,
    [Exchanges] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Test
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Test]
(
    [fld_Col1] VARCHAR(10) NULL,
    [fld_Col2] VARCHAR(10) NULL,
    [fld_Col3] VARCHAR(10) NULL,
    [fld_Col4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldBranch_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldBranch_Master]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [Issues] VARCHAR(50) NULL,
    [Branch engineers] INT NULL,
    [Odin Team] INT NULL,
    [Nt Team] INT NULL,
    [System] INT NULL,
    [Infra] INT NULL,
    [RM] INT NULL,
    [Exchange] INT NULL,
    [Help Desk] INT NULL,
    [ToDate] DATETIME NULL,
    [FromDate] DATETIME NULL,
    [Status] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldCSO_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldCSO_Master]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [Issues] VARCHAR(50) NULL,
    [Odin Team] INT NULL,
    [Nt Team] INT NULL,
    [System] INT NULL,
    [Infra] INT NULL,
    [RM] INT NULL,
    [Exchange] INT NULL,
    [Help Desk] INT NULL,
    [ToDate] DATETIME NULL,
    [FromDate] DATETIME NULL,
    [Status] CHAR(1) NULL,
    [EBroking] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresholdTeam
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresholdTeam]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [Team] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTeamToIssueMapping
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTeamToIssueMapping]
(
    [Id] INT IDENTITY(1,1) NOT NULL,
    [Issue] VARCHAR(50) NULL,
    [BranchEng] CHAR(1) NULL,
    [Odin] CHAR(1) NULL,
    [Network] CHAR(1) NULL,
    [System] CHAR(1) NULL,
    [Infra] CHAR(1) NULL,
    [RM] CHAR(1) NULL,
    [Exchange] CHAR(1) NULL,
    [Helpdesk] CHAR(1) NULL,
    [EBroking] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTeamToIssueMapping1
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTeamToIssueMapping1]
(
    [id] INT IDENTITY(1,1) NOT NULL,
    [Team] VARCHAR(20) NULL,
    [Issues] VARCHAR(50) NULL,
    [Status] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp]
(
    [Bcode] VARCHAR(15) NULL,
    [OdinTeamDT] INT NULL,
    [OdinTeamUT] INT NULL,
    [OdinTeamloss] DECIMAL(38, 0) NULL,
    [NetworkTeamDT] INT NULL,
    [NetworkTeamUT] INT NULL,
    [NetworkTeamloss] DECIMAL(38, 0) NULL,
    [SystemTeamDT] INT NULL,
    [SystemTeamUT] INT NULL,
    [SystemTeamloss] DECIMAL(38, 0) NULL,
    [InfraDT] INT NULL,
    [InfraUT] INT NULL,
    [Infraloss] DECIMAL(38, 0) NULL,
    [RMDT] INT NULL,
    [RMUT] INT NULL,
    [RMloss] DECIMAL(38, 0) NULL,
    [ExchangeDT] INT NULL,
    [ExchangeUT] INT NULL,
    [Exchangeloss] DECIMAL(38, 0) NULL,
    [HelpDeskDT] INT NULL,
    [HelpDeskUT] INT NULL,
    [HelpDeskloss] DECIMAL(38, 0) NULL,
    [EBrokingDT] INT NULL,
    [EBrokingUT] INT NULL,
    [EBrokingloss] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp_All
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp_All]
(
    [server] VARCHAR(255) NULL,
    [Fld_Branch_cd] VARCHAR(15) NULL,
    [BranchEngDT] DECIMAL(14, 2) NULL,
    [BranchEngUT] DECIMAL(14, 2) NULL,
    [BranchEngloss] DECIMAL(14, 2) NULL,
    [OdinTeamDT] DECIMAL(14, 2) NULL,
    [OdinTeamUT] DECIMAL(14, 2) NULL,
    [OdinTeamloss] DECIMAL(14, 2) NULL,
    [NetworkTeamDT] DECIMAL(14, 2) NULL,
    [NetworkTeamUT] DECIMAL(14, 2) NULL,
    [NetworkTeamloss] DECIMAL(14, 2) NULL,
    [SystemTeamDT] DECIMAL(14, 2) NULL,
    [SystemTeamUT] DECIMAL(14, 2) NULL,
    [SystemTeamloss] DECIMAL(14, 2) NULL,
    [InfraDT] DECIMAL(14, 2) NULL,
    [InfraUT] DECIMAL(14, 2) NULL,
    [Infraloss] DECIMAL(14, 2) NULL,
    [RMDT] DECIMAL(14, 2) NULL,
    [RMUT] DECIMAL(14, 2) NULL,
    [RMloss] DECIMAL(14, 2) NULL,
    [ExchangeDT] DECIMAL(14, 2) NULL,
    [ExchangeUT] DECIMAL(14, 2) NULL,
    [Exchangeloss] DECIMAL(14, 2) NULL,
    [HelpDeskDT] DECIMAL(14, 2) NULL,
    [HelpDeskUT] DECIMAL(14, 2) NULL,
    [HelpDeskloss] DECIMAL(14, 2) NULL,
    [EBrokingDT] DECIMAL(14, 2) NULL,
    [EBrokingUT] DECIMAL(14, 2) NULL,
    [EBrokingloss] DECIMAL(14, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp1
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp1]
(
    [BCode] VARCHAR(15) NULL,
    [dt] INT NULL,
    [Brk_Loss] DECIMAL(38, 0) NULL,
    [uptime] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp1_All
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp1_All]
(
    [Fld_Branch_cd] VARCHAR(15) NULL,
    [dt] DECIMAL(14, 2) NULL,
    [Brk_Loss] DECIMAL(14, 2) NULL,
    [uptime] DECIMAL(14, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp2
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp2]
(
    [Server Name] VARCHAR(255) NULL,
    [OdinTeamDT] INT NULL,
    [OdinTeamUT] INT NULL,
    [OdinTeamloss] DECIMAL(38, 0) NULL,
    [NetworkTeamDT] INT NULL,
    [NetworkTeamUT] INT NULL,
    [NetworkTeamloss] DECIMAL(38, 0) NULL,
    [SystemTeamDT] INT NULL,
    [SystemTeamUT] INT NULL,
    [SystemTeamloss] DECIMAL(38, 0) NULL,
    [InfraDT] INT NULL,
    [InfraUT] INT NULL,
    [Infraloss] DECIMAL(38, 0) NULL,
    [RMDT] INT NULL,
    [RMUT] INT NULL,
    [RMloss] DECIMAL(38, 0) NULL,
    [ExchangeDT] INT NULL,
    [ExchangeUT] INT NULL,
    [Exchangeloss] DECIMAL(38, 0) NULL,
    [HelpDeskDT] INT NULL,
    [HelpDeskUT] INT NULL,
    [HelpDeskloss] DECIMAL(38, 0) NULL,
    [EBrokingDT] INT NULL,
    [EBrokingUT] INT NULL,
    [EBrokingloss] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp2_All
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp2_All]
(
    [Fld_server] VARCHAR(255) NULL,
    [Fld_Branch_cd] VARCHAR(15) NULL,
    [BranchEngDT] DECIMAL(14, 2) NULL,
    [BranchEngUT] DECIMAL(14, 2) NULL,
    [BranchEngloss] DECIMAL(14, 2) NULL,
    [OdinTeamDT] DECIMAL(14, 2) NULL,
    [OdinTeamUT] DECIMAL(14, 2) NULL,
    [OdinTeamloss] DECIMAL(14, 2) NULL,
    [NetworkTeamDT] DECIMAL(14, 2) NULL,
    [NetworkTeamUT] DECIMAL(14, 2) NULL,
    [NetworkTeamloss] DECIMAL(14, 2) NULL,
    [SystemTeamDT] DECIMAL(14, 2) NULL,
    [SystemTeamUT] DECIMAL(14, 2) NULL,
    [SystemTeamloss] DECIMAL(14, 2) NULL,
    [InfraDT] DECIMAL(14, 2) NULL,
    [InfraUT] DECIMAL(14, 2) NULL,
    [Infraloss] DECIMAL(14, 2) NULL,
    [RMDT] DECIMAL(14, 2) NULL,
    [RMUT] DECIMAL(14, 2) NULL,
    [RMloss] DECIMAL(14, 2) NULL,
    [ExchangeDT] DECIMAL(14, 2) NULL,
    [ExchangeUT] DECIMAL(14, 2) NULL,
    [Exchangeloss] DECIMAL(14, 2) NULL,
    [HelpDeskDT] DECIMAL(14, 2) NULL,
    [HelpDeskUT] DECIMAL(14, 2) NULL,
    [HelpDeskloss] DECIMAL(14, 2) NULL,
    [EBrokingDT] DECIMAL(14, 2) NULL,
    [EBrokingUT] DECIMAL(14, 2) NULL,
    [EBrokingloss] DECIMAL(14, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp3
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp3]
(
    [Server Name] VARCHAR(255) NULL,
    [dt] INT NULL,
    [Brk_Loss] DECIMAL(38, 0) NULL,
    [uptime] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp3_All
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp3_All]
(
    [Fld_server] VARCHAR(255) NULL,
    [dt] DECIMAL(14, 2) NULL,
    [Brk_Loss] DECIMAL(14, 2) NULL,
    [uptime] DECIMAL(14, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp4
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp4]
(
    [Issues] VARCHAR(255) NULL,
    [OdinTeamDT] INT NULL,
    [OdinTeamUT] INT NULL,
    [OdinTeamloss] DECIMAL(38, 0) NULL,
    [NetworkTeamDT] INT NULL,
    [NetworkTeamUT] INT NULL,
    [NetworkTeamloss] DECIMAL(38, 0) NULL,
    [SystemTeamDT] INT NULL,
    [SystemTeamUT] INT NULL,
    [SystemTeamloss] DECIMAL(38, 0) NULL,
    [InfraDT] INT NULL,
    [InfraUT] INT NULL,
    [Infraloss] DECIMAL(38, 0) NULL,
    [RMDT] INT NULL,
    [RMUT] INT NULL,
    [RMloss] DECIMAL(38, 0) NULL,
    [ExchangeDT] INT NULL,
    [ExchangeUT] INT NULL,
    [Exchangeloss] DECIMAL(38, 0) NULL,
    [HelpDeskDT] INT NULL,
    [HelpDeskUT] INT NULL,
    [HelpDeskloss] DECIMAL(38, 0) NULL,
    [EBrokingDT] INT NULL,
    [EBrokingUT] INT NULL,
    [EBrokingloss] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp4_All
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp4_All]
(
    [Issues] VARCHAR(255) NULL,
    [Fld_Branch_cd] VARCHAR(15) NULL,
    [BranchEngDT] DECIMAL(14, 2) NULL,
    [BranchEngUT] DECIMAL(14, 2) NULL,
    [BranchEngloss] DECIMAL(14, 2) NULL,
    [OdinTeamDT] DECIMAL(14, 2) NULL,
    [OdinTeamUT] DECIMAL(14, 2) NULL,
    [OdinTeamloss] DECIMAL(14, 2) NULL,
    [NetworkTeamDT] DECIMAL(14, 2) NULL,
    [NetworkTeamUT] DECIMAL(14, 2) NULL,
    [NetworkTeamloss] DECIMAL(14, 2) NULL,
    [SystemTeamDT] DECIMAL(14, 2) NULL,
    [SystemTeamUT] DECIMAL(14, 2) NULL,
    [SystemTeamloss] DECIMAL(14, 2) NULL,
    [InfraDT] DECIMAL(14, 2) NULL,
    [InfraUT] DECIMAL(14, 2) NULL,
    [Infraloss] DECIMAL(14, 2) NULL,
    [RMDT] DECIMAL(14, 2) NULL,
    [RMUT] DECIMAL(14, 2) NULL,
    [RMloss] DECIMAL(14, 2) NULL,
    [ExchangeDT] DECIMAL(14, 2) NULL,
    [ExchangeUT] DECIMAL(14, 2) NULL,
    [Exchangeloss] DECIMAL(14, 2) NULL,
    [HelpDeskDT] DECIMAL(14, 2) NULL,
    [HelpDeskUT] DECIMAL(14, 2) NULL,
    [HelpDeskloss] DECIMAL(14, 2) NULL,
    [EBrokingDT] DECIMAL(14, 2) NULL,
    [EBrokingUT] DECIMAL(14, 2) NULL,
    [EBrokingloss] DECIMAL(14, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp5
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp5]
(
    [Issues] VARCHAR(255) NULL,
    [dt] INT NULL,
    [Brk_Loss] DECIMAL(38, 0) NULL,
    [uptime] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp5_All
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp5_All]
(
    [Issues] VARCHAR(255) NULL,
    [dt] DECIMAL(14, 2) NULL,
    [Brk_Loss] DECIMAL(14, 2) NULL,
    [uptime] DECIMAL(14, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ThresHoldTemp6
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ThresHoldTemp6]
(
    [Issues] VARCHAR(255) NULL,
    [OdinTeamDT] INT NULL,
    [OdinTeamUT] INT NULL,
    [OdinTeamloss] DECIMAL(38, 0) NULL,
    [NetworkTeamDT] INT NULL,
    [NetworkTeamUT] INT NULL,
    [NetworkTeamloss] DECIMAL(38, 0) NULL,
    [SystemTeamDT] INT NULL,
    [SystemTeamUT] INT NULL,
    [SystemTeamloss] DECIMAL(38, 0) NULL,
    [InfraDT] INT NULL,
    [InfraUT] INT NULL,
    [Infraloss] DECIMAL(38, 0) NULL,
    [RMDT] INT NULL,
    [RMUT] INT NULL,
    [RMloss] DECIMAL(38, 0) NULL,
    [ExchangeDT] INT NULL,
    [ExchangeUT] INT NULL,
    [Exchangeloss] DECIMAL(38, 0) NULL,
    [HelpDeskDT] INT NULL,
    [HelpDeskUT] INT NULL,
    [HelpDeskloss] DECIMAL(38, 0) NULL,
    [EBrokingDT] INT NULL,
    [EBrokingUT] INT NULL,
    [EBrokingloss] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_uploadedfile_entry
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_uploadedfile_entry]
(
    [fld_srno] INT IDENTITY(1,1) NOT NULL,
    [fld_branch_id] VARCHAR(50) NULL,
    [fld_server_id] INT NULL,
    [entrydate] DATETIME NULL,
    [updateddate] DATETIME NULL,
    [entryby] VARCHAR(50) NULL,
    [entryby1] VARCHAR(50) NULL,
    [approvedby] VARCHAR(50) NULL,
    [1] INT NULL,
    [1remark] VARCHAR(100) NULL,
    [2] INT NULL,
    [2remark] VARCHAR(100) NULL,
    [3] INT NULL,
    [3remark] VARCHAR(100) NULL,
    [4] INT NULL,
    [4remark] VARCHAR(100) NULL,
    [5] INT NULL,
    [5remark] VARCHAR(100) NULL,
    [6] INT NULL,
    [6remark] VARCHAR(100) NULL,
    [7] INT NULL,
    [7remark] VARCHAR(100) NULL,
    [8] INT NULL,
    [8remark] VARCHAR(100) NULL,
    [9] INT NULL,
    [9remark] VARCHAR(100) NULL,
    [10] INT NULL,
    [10remark] VARCHAR(100) NULL,
    [11] INT NULL,
    [11remark] VARCHAR(100) NULL,
    [12] INT NULL,
    [12remark] VARCHAR(100) NULL,
    [13] INT NULL,
    [13remark] VARCHAR(100) NULL,
    [14] INT NULL,
    [14remark] VARCHAR(100) NULL,
    [15] INT NULL,
    [15remark] VARCHAR(100) NULL,
    [16] INT NULL,
    [16remark] VARCHAR(100) NULL,
    [17] INT NULL,
    [17remark] VARCHAR(100) NULL,
    [18] INT NULL,
    [18remark] VARCHAR(100) NULL,
    [19] INT NULL,
    [19remark] VARCHAR(100) NULL,
    [20] INT NULL,
    [20remark] VARCHAR(100) NULL,
    [21] INT NULL,
    [21remark] VARCHAR(100) NULL,
    [22] INT NULL,
    [22remark] VARCHAR(100) NULL,
    [23] INT NULL,
    [23remark] VARCHAR(100) NULL,
    [24] INT NULL,
    [24remark] VARCHAR(100) NULL,
    [25] INT NULL,
    [25remark] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Brand_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Brand_Master]
(
    [Fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Brand_Name] VARCHAR(50) NULL,
    [Fld_Type] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ups_count_details
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ups_count_details]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] INT NULL,
    [Fld_Upsid] INT NULL,
    [Fld_945] VARCHAR(15) NULL,
    [Fld_2] VARCHAR(15) NULL,
    [Fld_530] VARCHAR(15) NULL,
    [Fld_10] VARCHAR(15) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [fld_remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ups_count_details_25052009
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ups_count_details_25052009]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_Code] INT NULL,
    [Fld_Upsid] INT NULL,
    [Fld_945] VARCHAR(15) NULL,
    [Fld_2] VARCHAR(15) NULL,
    [Fld_530] VARCHAR(15) NULL,
    [Fld_10] VARCHAR(15) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [fld_remark] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_DailyMails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_DailyMails]
(
    [UPS_dailymail_ID1] INT IDENTITY(1,1) NOT NULL,
    [Sr_No] INT NOT NULL,
    [Br_Tag] VARCHAR(100) NOT NULL,
    [Br_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ups_data
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ups_data]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Ups_id] INT NULL,
    [Agv_Daily_Load] VARCHAR(50) NULL,
    [Total_TestingTime] INT NULL,
    [Total_Load_InPer] VARCHAR(50) NULL,
    [Remark] VARCHAR(150) NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedOn] DATETIME NULL,
    [Fld_Entry_date] DATETIME NULL,
    [fld_branch] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ups_mapping
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ups_mapping]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Ups_id] INT NULL,
    [Fld_Flag] CHAR(1) NULL DEFAULT 'M',
    [Fld_From_date] DATETIME NULL,
    [Fld_To_date] DATETIME NULL,
    [Fld_Del_Remark] VARCHAR(500) NULL,
    [Fld_App] CHAR(1) NULL,
    [Agv_Daily_Load] VARCHAR(50) NULL,
    [Total_TestingTime] INT NULL,
    [Total_Load_InPer] VARCHAR(50) NULL,
    [Remark] VARCHAR(150) NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedOn] DATETIME NULL DEFAULT (getdate()),
    [Fld_ToDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [StatusUpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ups_mapping_bkup2May
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ups_mapping_bkup2May]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Ups_id] INT NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_From_date] DATETIME NULL,
    [Fld_To_date] DATETIME NULL,
    [Fld_Del_Remark] VARCHAR(500) NULL,
    [Fld_App] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ups_mapping_TEST
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ups_mapping_TEST]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Ups_id] INT NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_From_date] DATETIME NULL,
    [Fld_To_date] DATETIME NULL,
    [Fld_Del_Remark] VARCHAR(500) NULL,
    [Fld_App] CHAR(1) NULL,
    [Agv_Daily_Load] VARCHAR(50) NULL,
    [Total_TestingTime] INT NULL,
    [Total_Load_InPer] VARCHAR(50) NULL,
    [Remark] VARCHAR(4000) NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedOn] DATETIME NULL,
    [Fld_ToDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [StatusUpdatedOn] DATETIME NULL,
    [fld_EntryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ups_mapping_TESTdata
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ups_mapping_TESTdata]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Branch_id] INT NULL,
    [Fld_Ups_id] INT NULL,
    [Fld_Flag] CHAR(1) NULL,
    [Fld_From_date] DATETIME NULL,
    [Fld_To_date] DATETIME NULL,
    [Fld_Del_Remark] VARCHAR(500) NULL,
    [Fld_App] CHAR(1) NULL,
    [Agv_Daily_Load] VARCHAR(50) NULL,
    [Total_TestingTime] INT NULL,
    [Total_Load_InPer] VARCHAR(50) NULL,
    [Remark] VARCHAR(4000) NULL,
    [ChangedBy] VARCHAR(20) NULL,
    [ChangedOn] DATETIME NULL,
    [Fld_ToDate] DATETIME NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [StatusUpdatedOn] DATETIME NULL,
    [fld_EntryDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Master]
(
    [Fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Brand_id] INT NULL,
    [Fld_Model_id] INT NULL,
    [Fld_Model_Capacity_id] INT NULL,
    [Fld_Model_Srno] VARCHAR(50) NULL,
    [Fld_Battery_Bank] VARCHAR(50) NULL,
    [Fld_Warrenty_From] DATETIME NULL,
    [Fld_Warrenty_To] DATETIME NULL,
    [Fld_Status] CHAR(10) NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [Fld_Upd_date] DATETIME NULL,
    [Fld_Vendor_Id] INT NULL,
    [Fld_Bat_WFrom] DATETIME NULL,
    [Fld_Bat_WTo] DATETIME NULL,
    [Fld_Battery_Brand] VARCHAR(50) NULL,
    [Fld_Battery_Remark] VARCHAR(100) NULL,
    [Fld_Appl_To] VARCHAR(25) NULL,
    [Fld_Activation_Status] CHAR(1) NULL DEFAULT 'D',
    [DeactivatedOn] DATETIME NULL,
    [Remark] VARCHAR(200) NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [Fld_Branch_id] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Master_09042012
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Master_09042012]
(
    [Fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Brand_id] INT NULL,
    [Fld_Model_id] INT NULL,
    [Fld_Model_Capacity_id] INT NULL,
    [Fld_Model_Srno] VARCHAR(50) NULL,
    [Fld_Battery_Bank] VARCHAR(50) NULL,
    [Fld_Warrenty_From] DATETIME NULL,
    [Fld_Warrenty_To] DATETIME NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [Fld_Upd_date] DATETIME NULL,
    [Fld_Vendor_Id] INT NULL,
    [Fld_Bat_WFrom] DATETIME NULL,
    [Fld_Bat_WTo] DATETIME NULL,
    [Fld_Battery_Brand] VARCHAR(50) NULL,
    [Fld_Battery_Remark] VARCHAR(100) NULL,
    [Fld_Appl_To] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Master_test
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Master_test]
(
    [Fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Brand_id] INT NULL,
    [Fld_Model_id] INT NULL,
    [Fld_Model_Capacity_id] INT NULL,
    [Fld_Model_Srno] VARCHAR(50) NULL,
    [Fld_Battery_Bank] VARCHAR(50) NULL,
    [Fld_Warrenty_From] DATETIME NULL,
    [Fld_Warrenty_To] DATETIME NULL,
    [Fld_Status] CHAR(10) NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [Fld_Upd_date] DATETIME NULL,
    [Fld_Vendor_Id] INT NULL,
    [Fld_Bat_WFrom] DATETIME NULL,
    [Fld_Bat_WTo] DATETIME NULL,
    [Fld_Battery_Brand] VARCHAR(50) NULL,
    [Fld_Battery_Remark] VARCHAR(100) NULL,
    [Fld_Appl_To] VARCHAR(25) NULL,
    [Fld_Activation_Status] CHAR(1) NULL,
    [DeactivatedOn] DATETIME NULL,
    [Remark] VARCHAR(200) NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [Fld_Branch_id] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Master_testfinal
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Master_testfinal]
(
    [Fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Brand_id] INT NULL,
    [Fld_Model_id] INT NULL,
    [Fld_Model_Capacity_id] INT NULL,
    [Fld_Model_Srno] VARCHAR(50) NULL,
    [Fld_Battery_Bank] VARCHAR(50) NULL,
    [Fld_Warrenty_From] DATETIME NULL,
    [Fld_Warrenty_To] DATETIME NULL,
    [Fld_Status] CHAR(10) NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [Fld_Upd_date] DATETIME NULL,
    [Fld_Vendor_Id] INT NULL,
    [Fld_Bat_WFrom] DATETIME NULL,
    [Fld_Bat_WTo] DATETIME NULL,
    [Fld_Battery_Brand] VARCHAR(50) NULL,
    [Fld_Battery_Remark] VARCHAR(100) NULL,
    [Fld_Appl_To] VARCHAR(25) NULL,
    [Fld_Activation_Status] CHAR(1) NULL,
    [DeactivatedOn] DATETIME NULL,
    [Remark] VARCHAR(200) NULL,
    [UpdatedBy] VARCHAR(20) NULL,
    [Fld_Branch_id] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Model_Capacity
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Model_Capacity]
(
    [Fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Model_Capacity] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Model_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Model_Master]
(
    [Fld_srNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Model_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_UPS_Rpt_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_UPS_Rpt_Temp]
(
    [UpsCapacity] VARCHAR(103) NULL,
    [CSOName] VARCHAR(50) NULL,
    [Agv_Daily_Load] VARCHAR(50) NULL,
    [Total_TestingTime] VARCHAR(50) NULL,
    [Total_Load_InPer] VARCHAR(50) NULL,
    [Remark] VARCHAR(4000) NULL,
    [Br_Name] VARCHAR(100) NULL,
    [UPS_Model] VARCHAR(204) NULL,
    [Emp_Name] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_v_graph
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_v_graph]
(
    [Fld_Issue] VARCHAR(50) NULL,
    [Fld_Prev_Dt] NUMERIC(2, 2) NULL,
    [Fld_Prev_Tb] NUMERIC(2, 2) NULL,
    [Fld_Cur_Dt] NUMERIC(2, 2) NULL,
    [Fld_Cur_Tb] NUMERIC(2, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_V_Server_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_V_Server_Master]
(
    [FLd_SrNO] INT NOT NULL,
    [Fld_Branch_cd] VARCHAR(15) NULL,
    [Fld_server] VARCHAR(50) NULL,
    [Fld_id] INT NULL,
    [Br_Name] VARCHAR(100) NULL,
    [Status] VARCHAR(8) NULL,
    [reg_code] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_VCRTextFile
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_VCRTextFile]
(
    [Fld_Srno] INT IDENTITY(1,1) NOT NULL,
    [Branch] VARCHAR(15) NULL,
    [Manager] VARCHAR(20) NULL,
    [FileName] VARCHAR(15) NULL,
    [Folder] VARCHAR(1000) NULL,
    [DataField] VARCHAR(100) NULL,
    [Fld_UploadTime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Vendor_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Vendor_Master]
(
    [Fld_VendorId] INT IDENTITY(1,1) NOT NULL,
    [Fld_VendorName] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_wan_band
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_wan_band]
(
    [Fld_BandWidth] INT IDENTITY(1,1) NOT NULL,
    [drp_band] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_wan_branch
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_wan_branch]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Br_tag] VARCHAR(100) NULL,
    [Br_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_wan_connectivity
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_wan_connectivity]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_connectivity] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_wan_provider
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_wan_provider]
(
    [Fld_Provider] INT IDENTITY(1,1) NOT NULL,
    [drp_provider] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_wan_region
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_wan_region]
(
    [Fld_Region] INT IDENTITY(1,1) NOT NULL,
    [Br_Region] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_WAN_Rpt_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_WAN_Rpt_Temp]
(
    [CSONAME] VARCHAR(50) NULL,
    [BR_TAG] VARCHAR(50) NULL,
    [BR_NAME] VARCHAR(50) NULL,
    [FLD_LINK] VARCHAR(50) NULL,
    [FLD_CONNECTIVITY_TYPE] VARCHAR(50) NULL,
    [FLD_CHK_ID] VARCHAR(50) NULL,
    [FLD_PROVIDER] VARCHAR(50) NULL,
    [FLD_BANDWITDH] VARCHAR(50) NULL,
    [FLD_PURPOSE] VARCHAR(50) NULL,
    [FLD_STATUS] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_wanlink
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_wanlink]
(
    [Sr_Number] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Link_Type] VARCHAR(50) NULL,
    [Connectivity_Type] VARCHAR(50) NULL,
    [Circuit_ID] VARCHAR(50) NULL,
    [Line_No] VARCHAR(50) NULL,
    [Customer_ID] VARCHAR(50) NULL,
    [Provider] VARCHAR(50) NULL,
    [Bandwidth] VARCHAR(50) NULL,
    [Purpose] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_weekly_UPs_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_weekly_UPs_Details]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Ups_Id] INT NULL,
    [Fld_BranchId] INT NULL,
    [Fld_Avg_Load] VARCHAR(50) NULL,
    [Fld_Bat_Over] VARCHAR(50) NULL,
    [Fld_Critical_Check] VARCHAR(50) NULL,
    [Fld_FOB] VARCHAR(15) NULL,
    [Fld_FRemark] VARCHAR(100) NULL,
    [Fld_SOB] VARCHAR(15) NULL,
    [Fld_SRemark] VARCHAR(100) NULL,
    [Fld_FCD] DATETIME NULL,
    [Fld_SCD] DATETIME NULL,
    [Fld_Upd_Date] DATETIME NULL,
    [Agv_Daily_Load] VARCHAR(50) NULL,
    [Total_TestingTime] INT NULL,
    [Total_Load_InPer] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_year
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_year]
(
    [yy] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory]
(
    [DeptNo] VARCHAR(255) NULL,
    [Mainlink] VARCHAR(255) NULL,
    [Sublink] VARCHAR(255) NULL,
    [ProblemNature] VARCHAR(4000) NULL,
    [Solutions] VARCHAR(4000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblcategory1
-- --------------------------------------------------
CREATE TABLE [dbo].[tblcategory1]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [DeptNo] VARCHAR(255) NULL,
    [Mainlink] VARCHAR(255) NULL,
    [Sublink] VARCHAR(255) NULL,
    [ProblemNature] VARCHAR(4000) NULL,
    [Solutions] VARCHAR(4000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tblEMail
-- --------------------------------------------------
CREATE TABLE [dbo].[tblEMail]
(
    [SrNo] VARCHAR(255) NULL,
    [USERNAME] VARCHAR(255) NULL,
    [EMAILID] VARCHAR(255) NULL,
    [LOCATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbo_comp
-- --------------------------------------------------
CREATE TABLE [dbo].[tbo_comp]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tCat_Mast
-- --------------------------------------------------
CREATE TABLE [dbo].[tCat_Mast]
(
    [Category] VARCHAR(25) NULL,
    [Deptno] VARCHAR(40) NULL,
    [sr_no] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tcp_count
-- --------------------------------------------------
CREATE TABLE [dbo].[tcp_count]
(
    [Srno] BIGINT NULL,
    [Fld_Server_id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_EmpCode] VARCHAR(12) NULL,
    [PrevDay_Sur_Cnt] INT NOT NULL,
    [First_Sur_Cnt] INT NOT NULL,
    [FLd_Server] VARCHAR(50) NULL,
    [server_id] INT NULL,
    [Emp_name] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tem1
-- --------------------------------------------------
CREATE TABLE [dbo].[tem1]
(
    [name] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp]
(
    [Br_name] VARCHAR(100) NULL,
    [ups_id] INT NULL,
    [ups_name] VARCHAR(253) NULL,
    [Fld_SrNo] INT NULL,
    [Fld_Branch_Code] INT NULL,
    [Fld_Upsid] INT NULL,
    [Fld_945] VARCHAR(15) NULL,
    [Fld_2] VARCHAR(15) NULL,
    [Fld_530] VARCHAR(15) NULL,
    [Fld_10] VARCHAR(15) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [fld_remark] VARCHAR(1000) NULL,
    [person_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp#
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp#]
(
    [Br_name] VARCHAR(100) NULL,
    [ups_id] INT NULL,
    [ups_name] VARCHAR(253) NULL,
    [Fld_SrNo] INT NULL,
    [Fld_Branch_Code] INT NULL,
    [Fld_Upsid] INT NULL,
    [Fld_945] VARCHAR(15) NULL,
    [Fld_2] VARCHAR(15) NULL,
    [Fld_530] VARCHAR(15) NULL,
    [Fld_10] VARCHAR(15) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [fld_remark] VARCHAR(1000) NULL,
    [person_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_bak]
(
    [Br_name] VARCHAR(100) NULL,
    [ups_id] INT NULL,
    [ups_name] VARCHAR(253) NULL,
    [Fld_SrNo] INT NULL,
    [Fld_Branch_Code] INT NULL,
    [Fld_Upsid] INT NULL,
    [Fld_945] VARCHAR(15) NULL,
    [Fld_2] VARCHAR(15) NULL,
    [Fld_530] VARCHAR(15) NULL,
    [Fld_10] VARCHAR(15) NULL,
    [Fld_Date] DATETIME NULL,
    [Fld_Upd_By] VARCHAR(15) NULL,
    [fld_remark] VARCHAR(1000) NULL,
    [person_name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_comp
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_comp]
(
    [complaint_date] DATETIME NULL,
    [department] VARCHAR(50) NULL,
    [dsection] VARCHAR(20) NULL,
    [queryfrom] VARCHAR(250) NULL,
    [contact_person] VARCHAR(250) NULL,
    [problem] VARCHAR(5000) NULL,
    [suggestion] VARCHAR(5000) NULL,
    [completed_on] DATETIME NULL,
    [completed_remark] VARCHAR(150) NULL,
    [grade] CHAR(10) NULL,
    [helpdeskMarkcompleted] CHAR(10) NULL,
    [helpdeskmarkcompleteddate] DATETIME NULL,
    [status] CHAR(10) NULL,
    [complaintno] VARCHAR(50) NULL,
    [code] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [category] VARCHAR(15) NULL,
    [deptmarkcompleted] CHAR(10) NULL,
    [deptmarkcompleteddate] DATETIME NULL,
    [Remark] VARCHAR(600) NULL,
    [dstatus] VARCHAR(50) NULL,
    [dremark] VARCHAR(600) NULL,
    [emailid] VARCHAR(70) NULL,
    [phone] VARCHAR(250) NULL,
    [entry_by] VARCHAR(20) NULL,
    [subject] VARCHAR(500) NULL,
    [entered_through] VARCHAR(15) NULL,
    [time_limit] VARCHAR(15) NULL,
    [forwardto_dept] VARCHAR(100) NULL,
    [mark_complete] VARCHAR(5) NULL,
    [Call_type] VARCHAR(200) NULL,
    [Grp_Id] VARCHAR(50) NULL,
    [Attachment] VARCHAR(1000) NULL,
    [it_cat] VARCHAR(50) NULL,
    [it_subcat] VARCHAR(50) NULL,
    [it_conn] VARCHAR(50) NULL,
    [Wrong_Entry] CHAR(10) NULL,
    [City] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_compNo
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_compNo]
(
    [complaintno] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_HR
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_HR]
(
    [Fld_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Fld_Complaint_date] DATETIME NULL,
    [Fld_Request_Id] INT NULL,
    [Fld_Subject] VARCHAR(100) NULL,
    [Fld_Query] VARCHAR(5000) NULL,
    [Fld_Solution] VARCHAR(1000) NULL,
    [Fld_Emp_Code] VARCHAR(10) NULL,
    [Fld_Complaint_No] VARCHAR(100) NULL,
    [Fld_Status] CHAR(1) NULL,
    [Fld_Mark_Time] DATETIME NULL,
    [Fld_Solved_By] VARCHAR(10) NULL,
    [File_Name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_IT_assets_data
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_IT_assets_data]
(
    [Product type] VARCHAR(255) NULL,
    [Product name] VARCHAR(255) NULL,
    [Asset name] VARCHAR(255) NULL,
    [Asset tag] VARCHAR(255) NULL,
    [Asset serial no.] VARCHAR(255) NULL,
    [Vendor name] VARCHAR(255) NULL,
    [Asset cost] VARCHAR(255) NULL,
    [Acquisation date] VARCHAR(255) NULL,
    [Warranty Expiry] VARCHAR(255) NULL,
    [Location] VARCHAR(255) NULL,
    [Assigned to Dept.] VARCHAR(255) NULL,
    [Bill no.] VARCHAR(255) NULL,
    [Challan no.] VARCHAR(255) NULL,
    [Qty.] VARCHAR(255) NULL,
    [Purpose] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_kyc
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_kyc]
(
    [client Id] VARCHAR(255) NULL,
    [NameofClient] VARCHAR(255) NULL,
    [Dp] VARCHAR(255) NULL,
    [KYC] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_solutions
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_solutions]
(
    [Sr.No] INT IDENTITY(1,1) NOT NULL,
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(1000) NULL,
    [Solution] VARCHAR(3000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_tbl_ITAssetsData
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_tbl_ITAssetsData]
(
    [Fld_ProductType] VARCHAR(50) NULL,
    [Fld_ProductName] VARCHAR(100) NULL,
    [Fld_AssetName] VARCHAR(100) NULL,
    [Fld_AssetTag] VARCHAR(50) NULL,
    [Fld_PartNo] VARCHAR(100) NULL,
    [Fld_VendorName] VARCHAR(500) NULL,
    [Fld_Rate] DECIMAL(18, 0) NULL,
    [Fld_WarrantyFrom] VARCHAR(25) NULL,
    [Fld_WarrantyTo] VARCHAR(25) NULL,
    [Fld_BranchCode] VARCHAR(50) NULL,
    [Fld_AssignToDept] VARCHAR(50) NULL,
    [Fld_BillNo] VARCHAR(25) NULL,
    [Fld_ChallanNo] VARCHAR(25) NULL,
    [Fld_Qty] INT NULL,
    [Fld_Purpose] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_tbl_odin_checklist
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_tbl_odin_checklist]
(
    [fld_srno] INT IDENTITY(1,1) NOT NULL,
    [fld_branch_id] VARCHAR(50) NULL,
    [fld_server_id] INT NULL,
    [Entrydate] DATETIME NULL,
    [updateddate] DATETIME NULL,
    [enteredby] VARCHAR(100) NULL,
    [1] VARCHAR(255) NULL,
    [1Comment] VARCHAR(255) NULL,
    [2] VARCHAR(255) NULL,
    [2comment] VARCHAR(255) NULL,
    [3] VARCHAR(255) NULL,
    [3comment] VARCHAR(255) NULL,
    [4] VARCHAR(255) NULL,
    [4comment] VARCHAR(255) NULL,
    [5] VARCHAR(255) NULL,
    [5comment] VARCHAR(255) NULL,
    [6] VARCHAR(255) NULL,
    [6comment] VARCHAR(255) NULL,
    [7] VARCHAR(255) NULL,
    [7comment] VARCHAR(255) NULL,
    [8] VARCHAR(255) NULL,
    [8comment] VARCHAR(255) NULL,
    [9] VARCHAR(255) NULL,
    [9comment] VARCHAR(255) NULL,
    [10] VARCHAR(255) NULL,
    [10comment] VARCHAR(255) NULL,
    [11] VARCHAR(255) NULL,
    [11comment] VARCHAR(255) NULL,
    [12] VARCHAR(255) NULL,
    [12comment] VARCHAR(255) NULL,
    [13] VARCHAR(255) NULL,
    [13comment] VARCHAR(255) NULL,
    [14] VARCHAR(255) NULL,
    [14comment] VARCHAR(255) NULL,
    [15] VARCHAR(255) NULL,
    [15comment] VARCHAR(255) NULL,
    [16] VARCHAR(255) NULL,
    [16comment] VARCHAR(255) NULL,
    [17] VARCHAR(255) NULL,
    [17comment] VARCHAR(255) NULL,
    [18] VARCHAR(255) NULL,
    [18comment] VARCHAR(255) NULL,
    [19] VARCHAR(255) NULL,
    [19comment] VARCHAR(255) NULL,
    [20] VARCHAR(255) NULL,
    [20comment] VARCHAR(255) NULL,
    [21] VARCHAR(255) NULL,
    [21comment] VARCHAR(255) NULL,
    [22] VARCHAR(255) NULL,
    [22comment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_term
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_term]
(
    [Server] VARCHAR(255) NULL,
    [Odin_Id] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp1]
(
    [Br_name] VARCHAR(103) NULL,
    [Fld_Branch_Code] INT NULL,
    [Fld_Upsid] INT NULL,
    [ups_name] VARCHAR(253) NULL,
    [Fld_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp1_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp1_bak]
(
    [Branches] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp2
-- --------------------------------------------------
CREATE TABLE [dbo].[temp2]
(
    [FromHeader] VARCHAR(150) NULL,
    [SubjectHeader] VARCHAR(500) NULL,
    [DateHeader] VARCHAR(50) NOT NULL,
    [Unread] VARCHAR(500) NULL,
    [Message] VARCHAR(8000) NULL,
    [Dummy1] VARCHAR(500) NULL,
    [Dummy2] VARCHAR(500) NULL,
    [ProfileName] VARCHAR(500) NULL,
    [attachment] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempfile
-- --------------------------------------------------
CREATE TABLE [dbo].[tempfile]
(
    [ID] INT NOT NULL,
    [title_SrNo] INT NULL,
    [Att_No] INT NULL,
    [type] VARCHAR(6) NULL,
    [Description] VARCHAR(500) NULL,
    [status] VARCHAR(1) NULL,
    [branch] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [Rpt_type] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempfile2
-- --------------------------------------------------
CREATE TABLE [dbo].[tempfile2]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [title_SrNo] INT NULL,
    [Att_No] INT NULL,
    [type] VARCHAR(6) NULL,
    [Description] VARCHAR(500) NULL,
    [status] VARCHAR(1) NULL,
    [branch] VARCHAR(10) NULL,
    [tmonth] INT NULL,
    [tyear] INT NULL,
    [Rpt_type] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempfinal
-- --------------------------------------------------
CREATE TABLE [dbo].[tempfinal]
(
    [TypeOfQuery] VARCHAR(50) NULL,
    [NoOfCalls] INT NULL,
    [Percentage] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.template_temp
-- --------------------------------------------------
CREATE TABLE [dbo].[template_temp]
(
    [deptno] VARCHAR(10) NULL,
    [template] VARCHAR(8000) NULL,
    [status] VARCHAR(10) NULL,
    [sno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempOPhelpdeskMIS
-- --------------------------------------------------
CREATE TABLE [dbo].[tempOPhelpdeskMIS]
(
    [Dept_Name] VARCHAR(50) NOT NULL,
    [Branch_Completed] INT NULL,
    [CSO_Completed] INT NULL,
    [In_Process] INT NULL,
    [Pending] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempServerDate
-- --------------------------------------------------
CREATE TABLE [dbo].[TempServerDate]
(
    [SRNO] BIGINT NULL,
    [MDF_LDF] VARCHAR(27) NOT NULL,
    [PERMDF] FLOAT NULL,
    [MDF_FS] VARCHAR(8000) NOT NULL,
    [MDF_AQ] VARCHAR(8000) NOT NULL,
    [MDF_BQ] VARCHAR(8000) NOT NULL,
    [FLD_MDF_COD] VARCHAR(50) NULL,
    [FLD_MDF_BQ] VARCHAR(50) NULL,
    [FLD_MDF_AQ] VARCHAR(50) NULL,
    [FLD_MDF_DD] VARCHAR(50) NULL,
    [FLD_MDF_FS] VARCHAR(50) NULL,
    [FLD_SERVER_ID] INT NULL,
    [FLD_BRANCH_ID] VARCHAR(50) NOT NULL,
    [FLD_REMARK] VARCHAR(500) NULL,
    [FLD_UPD_BY] VARCHAR(50) NULL,
    [FLD_ID] INT NULL,
    [FLD_SERVER] VARCHAR(50) NULL,
    [FLD_DB_IP] VARCHAR(50) NULL,
    [FLD_ODIN_IP] VARCHAR(50) NULL,
    [EMP_NAME] VARCHAR(100) NULL,
    [USERNAME] VARCHAR(20) NULL,
    [BR_TAG] VARCHAR(100) NULL,
    [BR_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temptable
-- --------------------------------------------------
CREATE TABLE [dbo].[temptable]
(
    [srNoo] INT IDENTITY(1,1) NOT NULL,
    [tdate] DATETIME NOT NULL,
    [Bse] INT NULL,
    [Cm] INT NULL,
    [Fo] INT NULL,
    [Mcx] INT NULL,
    [Ncdex] INT NULL,
    [ACDLNSX] INT NULL,
    [ACPLMCD] INT NULL,
    [cnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tempvariable
-- --------------------------------------------------
CREATE TABLE [dbo].[Tempvariable]
(
    [S] CHAR(2) NULL,
    [Fld_id] VARCHAR(5) NULL,
    [server_id] INT NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Branch_cd] VARCHAR(20) NULL,
    [Br_Name] VARCHAR(50) NULL,
    [SBS_IP] VARCHAR(20) NULL,
    [Remark] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tempvinay
-- --------------------------------------------------
CREATE TABLE [dbo].[tempvinay]
(
    [fld_Branch_Cd] VARCHAR(50) NULL,
    [server] VARCHAR(255) NULL,
    [Issues] VARCHAR(50) NULL,
    [dt] INT NULL,
    [uptime] INT NULL,
    [Brk_Loss] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.term
-- --------------------------------------------------
CREATE TABLE [dbo].[term]
(
    [Server] VARCHAR(255) NULL,
    [Terminal_ID] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Term_ID
-- --------------------------------------------------
CREATE TABLE [dbo].[Term_ID]
(
    [Sever] VARCHAR(255) NULL,
    [NSEOLD] VARCHAR(255) NULL,
    [NSENEW] VARCHAR(255) NULL,
    [FOOLD] VARCHAR(255) NULL,
    [FONEW] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.terminal_brok
-- --------------------------------------------------
CREATE TABLE [dbo].[terminal_brok]
(
    [Company] VARCHAR(10) NOT NULL,
    [sauda_Date] DATETIME NULL,
    [branch_cd] VARCHAR(10) NULL,
    [sub_broker] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [party_name] VARCHAR(100) NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [Turnover] MONEY NULL,
    [brokerage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Terminal_Brok_Loss
-- --------------------------------------------------
CREATE TABLE [dbo].[Terminal_Brok_Loss]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [Brokerage] MONEY NULL,
    [dt] VARCHAR(20) NULL,
    [uptime] VARCHAR(20) NULL,
    [Brk_Loss] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [issues] VARCHAR(50) NULL,
    [Exchanges] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.terminal_brok_loss_01012014
-- --------------------------------------------------
CREATE TABLE [dbo].[terminal_brok_loss_01012014]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [Brokerage] MONEY NULL,
    [dt] VARCHAR(20) NULL,
    [uptime] VARCHAR(20) NULL,
    [Brk_Loss] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [issues] VARCHAR(50) NULL,
    [Exchanges] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TERMINAL_BROK_LOSS_29022012
-- --------------------------------------------------
CREATE TABLE [dbo].[TERMINAL_BROK_LOSS_29022012]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [Brokerage] MONEY NULL,
    [dt] VARCHAR(20) NULL,
    [uptime] VARCHAR(20) NULL,
    [Brk_Loss] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [issues] VARCHAR(50) NULL,
    [Exchanges] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TERMINAL_BROK_LOSS_30102013
-- --------------------------------------------------
CREATE TABLE [dbo].[TERMINAL_BROK_LOSS_30102013]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [Brokerage] MONEY NULL,
    [dt] VARCHAR(20) NULL,
    [uptime] VARCHAR(20) NULL,
    [Brk_Loss] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [issues] VARCHAR(50) NULL,
    [Exchanges] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.terminal_brok_loss_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[terminal_brok_loss_bak]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [Brokerage] MONEY NULL,
    [dt] VARCHAR(20) NULL,
    [uptime] VARCHAR(20) NULL,
    [Brk_Loss] MONEY NULL,
    [Sauda_date] DATETIME NULL,
    [issues] VARCHAR(50) NULL,
    [Exchanges] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.terminal_brok_loss_BAK_18_2012
-- --------------------------------------------------
CREATE TABLE [dbo].[terminal_brok_loss_BAK_18_2012]
(
    [server] VARCHAR(255) NULL,
    [segment] VARCHAR(255) NULL,
    [dt] VARCHAR(20) NULL,
    [sauda_date] DATETIME NULL,
    [uptime] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.terminals
-- --------------------------------------------------
CREATE TABLE [dbo].[terminals]
(
    [Server] VARCHAR(255) NULL,
    [Odin_Id] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL,
    [sdate] DATETIME NULL,
    [edate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.terminals_bak
-- --------------------------------------------------
CREATE TABLE [dbo].[terminals_bak]
(
    [Server] VARCHAR(255) NULL,
    [Odin_Id] VARCHAR(255) NULL,
    [Segment] VARCHAR(255) NULL,
    [sdate] DATETIME NULL,
    [edate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test
-- --------------------------------------------------
CREATE TABLE [dbo].[test]
(
    [fld1] VARCHAR(5) NULL,
    [fld2] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Test_complaint_table
-- --------------------------------------------------
CREATE TABLE [dbo].[Test_complaint_table]
(
    [complaint_date] DATETIME NULL,
    [department] VARCHAR(50) NULL,
    [dsection] VARCHAR(20) NULL,
    [queryfrom] VARCHAR(250) NULL,
    [contact_person] VARCHAR(250) NULL,
    [problem] VARCHAR(5000) NULL,
    [suggestion] VARCHAR(5000) NULL,
    [completed_on] DATETIME NULL,
    [completed_remark] VARCHAR(150) NULL,
    [grade] CHAR(10) NULL,
    [helpdeskMarkcompleted] CHAR(10) NULL,
    [helpdeskmarkcompleteddate] DATETIME NULL,
    [status] CHAR(10) NULL,
    [complaintno] VARCHAR(50) NULL,
    [code] VARCHAR(20) NULL,
    [party_code] VARCHAR(20) NULL,
    [category] VARCHAR(15) NULL,
    [deptmarkcompleted] CHAR(10) NULL,
    [deptmarkcompleteddate] DATETIME NULL,
    [Remark] VARCHAR(600) NULL,
    [dstatus] VARCHAR(50) NULL,
    [dremark] VARCHAR(600) NULL,
    [emailid] VARCHAR(70) NULL,
    [phone] VARCHAR(250) NULL,
    [entry_by] VARCHAR(20) NULL,
    [subject] VARCHAR(500) NULL,
    [entered_through] VARCHAR(15) NULL,
    [time_limit] VARCHAR(15) NULL,
    [forwardto_dept] VARCHAR(100) NULL,
    [mark_complete] VARCHAR(5) NULL,
    [Call_type] VARCHAR(200) NULL,
    [Grp_Id] VARCHAR(50) NULL,
    [Attachment] VARCHAR(1000) NULL,
    [it_cat] VARCHAR(50) NULL,
    [it_subcat] VARCHAR(50) NULL,
    [it_conn] VARCHAR(50) NULL,
    [Wrong_Entry] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test_hd
-- --------------------------------------------------
CREATE TABLE [dbo].[test_hd]
(
    [Sr.No] INT IDENTITY(1,1) NOT NULL,
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(1000) NULL,
    [Solution] VARCHAR(3000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.test1
-- --------------------------------------------------
CREATE TABLE [dbo].[test1]
(
    [DeptNo] VARCHAR(50) NULL,
    [Complaint] VARCHAR(1000) NULL,
    [Solution] VARCHAR(1000) NULL,
    [Dummy1] VARCHAR(800) NULL,
    [[Dummy2] VARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TOTAL_ROOPA_COMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TOTAL_ROOPA_COMP]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TOTAL_SHIVA_COMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TOTAL_SHIVA_COMP]
(
    [Sr_Num] INT IDENTITY(1,1) NOT NULL,
    [Dept_ID] INT NOT NULL,
    [Complaint_ID] VARCHAR(50) NOT NULL,
    [Query_Type] VARCHAR(100) NOT NULL,
    [Subject] VARCHAR(50) NULL,
    [Complaint] VARCHAR(5000) NOT NULL,
    [Solution] VARCHAR(5000) NULL,
    [Access_code] NCHAR(10) NOT NULL,
    [Solution_By] VARCHAR(50) NOT NULL,
    [Complaint_Date] DATETIME NOT NULL,
    [Solution_Date] DATETIME NULL,
    [Attachment] VARCHAR(170) NULL,
    [Status] VARCHAR(30) NOT NULL,
    [Fld_EntryBy] VARCHAR(50) NULL,
    [cso_attch] VARCHAR(150) NULL,
    [fld_hold_Reason] VARCHAR(50) NULL,
    [compl_abt] SMALLINT NULL,
    [clt_subdetl] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.travelbooking
-- --------------------------------------------------
CREATE TABLE [dbo].[travelbooking]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [complaint_id] VARCHAR(30) NOT NULL,
    [no_of_guests] TINYINT NOT NULL,
    [emp_code] VARCHAR(15) NOT NULL,
    [travel_details] VARCHAR(15) NOT NULL,
    [DepartOn] DATETIME NOT NULL,
    [ReturnOn] DATETIME NOT NULL,
    [DepartureTiming] VARCHAR(11) NOT NULL,
    [ReturnTime] VARCHAR(11) NOT NULL,
    [fldfrom] VARCHAR(100) NOT NULL,
    [fldto] VARCHAR(100) NOT NULL,
    [ModeOfTravel] VARCHAR(10) NOT NULL,
    [Acdtion_Requ] VARCHAR(5) NOT NULL,
    [PickupnDrop] VARCHAR(5) NOT NULL,
    [Purpose] VARCHAR(100) NOT NULL,
    [Othdetail] VARCHAR(1000) NOT NULL,
    [Entryby] VARCHAR(15) NOT NULL,
    [Costcode] VARCHAR(15) NULL,
    [Entrydate] DATETIME NOT NULL,
    [hod] VARCHAR(15) NOT NULL,
    [flag] VARCHAR(15) NOT NULL,
    [Reason] VARCHAR(1000) NULL,
    [modeoftraveldetails] VARCHAR(5000) NULL,
    [acdtion_requdetails] VARCHAR(2000) NULL,
    [pickupndropdetails] VARCHAR(2000) NULL,
    [UserAttach] VARCHAR(100) NULL,
    [CsoAttach] VARCHAR(100) NULL,
    [Solutionby] VARCHAR(20) NULL,
    [costfortravel] INT NULL,
    [costforacc] INT NULL,
    [costforpnd] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Update_wanlink
-- --------------------------------------------------
CREATE TABLE [dbo].[Update_wanlink]
(
    [Sr_Number] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Link_Type] VARCHAR(50) NULL,
    [Connectivity_Type] VARCHAR(50) NULL,
    [Circuit_ID] VARCHAR(50) NULL,
    [Provider] VARCHAR(50) NULL,
    [Bandwidth] VARCHAR(50) NULL,
    [Purpose] VARCHAR(50) NULL,
    [Status] VARCHAR(50) NULL,
    [Date] VARCHAR(50) NULL,
    [Tested_By] VARCHAR(50) NULL,
    [Verfied_By] VARCHAR(50) NULL,
    [Branch_Mgr] VARCHAR(50) NULL,
    [Remark] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.upload_wan
-- --------------------------------------------------
CREATE TABLE [dbo].[upload_wan]
(
    [Sr_No] VARCHAR(255) NULL,
    [LINK] VARCHAR(255) NULL,
    [TYPE_OF_CONNECTIVITY] VARCHAR(255) NULL,
    [Check_Id] VARCHAR(255) NULL,
    [PROVIDER] VARCHAR(255) NULL,
    [BANDWIDTH] VARCHAR(255) NULL,
    [PURPOSE] VARCHAR(255) NULL,
    [CSO] VARCHAR(255) NULL,
    [BRANCH] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ups_temp_data
-- --------------------------------------------------
CREATE TABLE [dbo].[Ups_temp_data]
(
    [Data] VARCHAR(255) NULL,
    [Type] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.uptime_C
-- --------------------------------------------------
CREATE TABLE [dbo].[uptime_C]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERVER
-- --------------------------------------------------
CREATE TABLE [dbo].[USERVER]
(
    [DATE] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [CURRENCY] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [MCXSX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UT030308
-- --------------------------------------------------
CREATE TABLE [dbo].[UT030308]
(
    [Date] VARCHAR(255) NULL,
    [BSE] VARCHAR(255) NULL,
    [CM] VARCHAR(255) NULL,
    [FO] VARCHAR(255) NULL,
    [MCX] VARCHAR(255) NULL,
    [NCDEX] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.utd_login_log
-- --------------------------------------------------
CREATE TABLE [dbo].[utd_login_log]
(
    [username] VARCHAR(50) NULL,
    [logintime] DATETIME NULL,
    [logouttime] DATETIME NULL,
    [Location] VARCHAR(50) NULL,
    [fld_ip] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v_sat_mast
-- --------------------------------------------------
CREATE TABLE [dbo].[v_sat_mast]
(
    [Dept_NO] VARCHAR(255) NULL,
    [Category] VARCHAR(255) NULL,
    [Cat_item_Id] VARCHAR(255) NULL,
    [Cat_PCIP] VARCHAR(255) NULL,
    [Cat_Email] VARCHAR(255) NULL,
    [Cat_Phone] VARCHAR(255) NULL,
    [Cat_city] VARCHAR(255) NULL,
    [Cat_Type] VARCHAR(255) NULL,
    [CAt_Address] VARCHAR(255) NULL,
    [Cat_ContPerson] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.v_tbl_tcpcnt
-- --------------------------------------------------
CREATE TABLE [dbo].[v_tbl_tcpcnt]
(
    [Fld_SrNo] INT NOT NULL,
    [Fld_Branch_Code] VARCHAR(15) NULL,
    [Fld_Server_Id] INT NULL,
    [Fld_Tcp_1015] INT NULL,
    [Fld_Tcp_0115] INT NULL,
    [Fld_Tcp_0315] INT NULL,
    [Fld_Sur_Cnt] INT NULL,
    [PrevDay_Sur_Cnt] INT NOT NULL,
    [First_Sur_Cnt] INT NOT NULL,
    [Fld_Remark] VARCHAR(200) NULL,
    [Fld_FldDate] DATETIME NULL,
    [Fld_SysDate] DATETIME NULL,
    [Fld_Flag] CHAR(2) NULL,
    [Fld_EmpCode] VARCHAR(12) NULL,
    [UserName] VARCHAR(20) NOT NULL,
    [Person_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.variable
-- --------------------------------------------------
CREATE TABLE [dbo].[variable]
(
    [S] CHAR(2) NULL,
    [Fld_id] VARCHAR(5) NULL,
    [server_id] INT NULL,
    [Fld_Server] VARCHAR(50) NULL,
    [Fld_Branch_cd] VARCHAR(20) NULL,
    [Br_Name] VARCHAR(50) NULL,
    [SBS_IP] VARCHAR(20) NULL,
    [Remark] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VLMSInhouse_Users
-- --------------------------------------------------
CREATE TABLE [dbo].[VLMSInhouse_Users]
(
    [Emp No] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [HOD No] VARCHAR(6) NULL,
    [HOD Name] VARCHAR(150) NULL,
    [Company Name] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [Lob] INT NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub Department] VARCHAR(150) NULL,
    [Designation] VARCHAR(255) NULL,
    [Location Address] VARCHAR(5000) NULL,
    [LEVEL] VARCHAR(50) NULL,
    [categorydesc] VARCHAR(50) NULL,
    [Costcode] NVARCHAR(255) NULL,
    [Join Date] DATETIME NULL,
    [Separation Date] DATETIME NULL,
    [emailadd] VARCHAR(100) NULL,
    [sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [PHONE] VARCHAR(50) NULL,
    [JOINDATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [Address] NVARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State] NVARCHAR(25) NULL,
    [Account No] VARCHAR(20) NULL,
    [pincode] VARCHAR(20) NULL,
    [Functional Head] VARCHAR(500) NULL,
    [flgCSOBranch] NCHAR(6) NULL,
    [tpdlgcode] NVARCHAR(50) NULL,
    [LOBDESC] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.wan_master
-- --------------------------------------------------
CREATE TABLE [dbo].[wan_master]
(
    [REGION] NVARCHAR(255) NULL,
    [Branch TAG] NVARCHAR(255) NULL,
    [ Branch name] NVARCHAR(255) NULL,
    [Link] NVARCHAR(255) NULL,
    [Connectivity] NVARCHAR(255) NULL,
    [Ckt id] NVARCHAR(255) NULL,
    [Provider] NVARCHAR(255) NULL,
    [Bandwidth] NVARCHAR(255) NULL,
    [ purpose] NVARCHAR(255) NULL,
    [Status] NVARCHAR(255) NULL,
    [Date of testing] NVARCHAR(255) NULL,
    [Tested by] NVARCHAR(255) NULL,
    [Remark] NVARCHAR(255) NULL,
    [Admin remark] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.wanlink_master
-- --------------------------------------------------
CREATE TABLE [dbo].[wanlink_master]
(
    [Sr_Number] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Link_Type] VARCHAR(50) NULL,
    [Connectivity_Type] VARCHAR(50) NULL,
    [Circuit_ID] VARCHAR(50) NULL,
    [Provider] VARCHAR(50) NULL,
    [Bandwidth] VARCHAR(50) NULL,
    [Purpose] VARCHAR(50) NULL,
    [Status] VARCHAR(50) NULL,
    [Date] VARCHAR(50) NULL,
    [Tested_By] VARCHAR(50) NULL,
    [Verfied_By] VARCHAR(50) NULL,
    [Branch_Mgr] VARCHAR(50) NULL,
    [Remark] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.WebData
-- --------------------------------------------------
CREATE TABLE [dbo].[WebData]
(
    [fname] VARCHAR(50) NULL,
    [attach] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.xmailreader
-- --------------------------------------------------
CREATE TABLE [dbo].[xmailreader]
(
    [FromHeader] VARCHAR(150) NULL,
    [SubjectHeader] VARCHAR(500) NULL,
    [DateHeader] VARCHAR(22) NOT NULL,
    [Unread] VARCHAR(500) NULL,
    [Message] VARCHAR(8000) NULL,
    [CC] VARCHAR(50) NULL,
    [Dummy1] VARCHAR(50) NULL,
    [Dummy2] VARCHAR(500) NULL,
    [ProfileName] VARCHAR(500) NULL,
    [attachment] VARCHAR(500) NULL,
    [Solutions] VARCHAR(8000) NULL,
    [fwAttachment] VARCHAR(500) NULL,
    [ComplaintNo] VARCHAR(200) NULL,
    [Reminder] VARCHAR(50) NULL,
    [forwardTo] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.xml_uPLOAD
-- --------------------------------------------------
CREATE TABLE [dbo].[xml_uPLOAD]
(
    [fileFormat] VARCHAR(100) NULL,
    [created] VARCHAR(100) NULL,
    [currency] VARCHAR(100) NULL,
    [symbol] VARCHAR(100) NULL,
    [name] VARCHAR(100) NULL,
    [decimalPos] VARCHAR(100) NULL,
    [isCust] VARCHAR(100) NULL,
    [acctType] VARCHAR(100) NULL,
    [name2] VARCHAR(100) NULL,
    [isNetMargin] VARCHAR(100) NULL,
    [priority] VARCHAR(100) NULL,
    [id] VARCHAR(100) NULL,
    [name3] VARCHAR(100) NULL,
    [date] VARCHAR(100) NULL,
    [isSetl] VARCHAR(100) NULL,
    [setlQualifier] VARCHAR(100) NULL,
    [ec] VARCHAR(100) NULL,
    [name4] VARCHAR(100) NULL,
    [isContractScale] VARCHAR(100) NULL,
    [isNetMargin5] VARCHAR(100) NULL,
    [finalizeMeth] VARCHAR(100) NULL,
    [oopDeltaMeth] VARCHAR(100) NULL,
    [capAnov] VARCHAR(100) NULL,
    [lookAheadYears] VARCHAR(100) NULL,
    [fromCur] VARCHAR(100) NULL,
    [toCur] VARCHAR(100) NULL,
    [factor] VARCHAR(100) NULL,
    [r] VARCHAR(100) NULL,
    [isCust6] VARCHAR(100) NULL,
    [acctType7] VARCHAR(100) NULL,
    [isM] VARCHAR(100) NULL,
    [pbc] VARCHAR(100) NULL,
    [r8] VARCHAR(100) NULL,
    [point] VARCHAR(100) NULL,
    [mult] VARCHAR(100) NULL,
    [numerator] VARCHAR(100) NULL,
    [denominator] VARCHAR(100) NULL,
    [mult9] VARCHAR(100) NULL,
    [numerator10] VARCHAR(100) NULL,
    [denominator11] VARCHAR(100) NULL,
    [weight] VARCHAR(100) NULL,
    [pairedPoint] VARCHAR(100) NULL,
    [point12] VARCHAR(100) NULL,
    [mult13] VARCHAR(100) NULL,
    [numerator14] VARCHAR(100) NULL,
    [denominator15] VARCHAR(100) NULL,
    [mult16] VARCHAR(100) NULL,
    [numerator17] VARCHAR(100) NULL,
    [denominator18] VARCHAR(100) NULL,
    [weight19] VARCHAR(100) NULL,
    [exch] VARCHAR(100) NULL,
    [name20] VARCHAR(100) NULL,
    [pfId] VARCHAR(100) NULL,
    [pfCode] VARCHAR(100) NULL,
    [name21] VARCHAR(100) NULL,
    [currency22] VARCHAR(100) NULL,
    [cvf] VARCHAR(100) NULL,
    [priceDl] VARCHAR(100) NULL,
    [priceFmt] VARCHAR(100) NULL,
    [valueMeth] VARCHAR(100) NULL,
    [priceMeth] VARCHAR(100) NULL,
    [setlMeth] VARCHAR(100) NULL,
    [cId] VARCHAR(100) NULL,
    [pe] VARCHAR(100) NULL,
    [p] VARCHAR(100) NULL,
    [d] VARCHAR(100) NULL,
    [v] VARCHAR(100) NULL,
    [cvf23] VARCHAR(100) NULL,
    [sc] VARCHAR(100) NULL,
    [r24] VARCHAR(100) NULL,
    [priceScan] VARCHAR(100) NULL,
    [volScan] VARCHAR(100) NULL,
    [r25] VARCHAR(100) NULL,
    [a] VARCHAR(100) NULL,
    [d26] VARCHAR(100) NULL,
    [pfId27] VARCHAR(100) NULL,
    [pfCode28] VARCHAR(100) NULL,
    [name29] VARCHAR(100) NULL,
    [currency30] VARCHAR(100) NULL,
    [cvf31] VARCHAR(100) NULL,
    [priceDl32] VARCHAR(100) NULL,
    [priceFmt33] VARCHAR(100) NULL,
    [valueMeth34] VARCHAR(100) NULL,
    [priceMeth35] VARCHAR(100) NULL,
    [setlMeth36] VARCHAR(100) NULL,
    [exch37] VARCHAR(100) NULL,
    [pfId38] VARCHAR(100) NULL,
    [pfCode39] VARCHAR(100) NULL,
    [pfType] VARCHAR(100) NULL,
    [s] VARCHAR(100) NULL,
    [i] VARCHAR(100) NULL,
    [cId40] VARCHAR(100) NULL,
    [pe41] VARCHAR(100) NULL,
    [p42] VARCHAR(100) NULL,
    [d43] VARCHAR(100) NULL,
    [v44] VARCHAR(100) NULL,
    [cvf45] VARCHAR(100) NULL,
    [sc46] VARCHAR(100) NULL,
    [setlDate] VARCHAR(100) NULL,
    [t] VARCHAR(100) NULL,
    [exch47] VARCHAR(100) NULL,
    [pfId48] VARCHAR(100) NULL,
    [cId49] VARCHAR(100) NULL,
    [s50] VARCHAR(100) NULL,
    [i51] VARCHAR(100) NULL,
    [val] VARCHAR(100) NULL,
    [rl] VARCHAR(100) NULL,
    [cpm] VARCHAR(100) NULL,
    [exm] VARCHAR(100) NULL,
    [r52] VARCHAR(100) NULL,
    [priceScan53] VARCHAR(100) NULL,
    [volScan54] VARCHAR(100) NULL,
    [r55] VARCHAR(100) NULL,
    [a56] VARCHAR(100) NULL,
    [d57] VARCHAR(100) NULL,
    [pfId58] VARCHAR(100) NULL,
    [pfCode59] VARCHAR(100) NULL,
    [name60] VARCHAR(100) NULL,
    [exercise] VARCHAR(100) NULL,
    [currency61] VARCHAR(100) NULL,
    [cvf62] VARCHAR(100) NULL,
    [priceDl63] VARCHAR(100) NULL,
    [priceFmt64] VARCHAR(100) NULL,
    [strikeDl] VARCHAR(100) NULL,
    [strikeFmt] VARCHAR(100) NULL,
    [cab] VARCHAR(100) NULL,
    [valueMeth65] VARCHAR(100) NULL,
    [priceMeth66] VARCHAR(100) NULL,
    [setlMeth67] VARCHAR(100) NULL,
    [priceModel] VARCHAR(100) NULL,
    [exch68] VARCHAR(100) NULL,
    [pfId69] VARCHAR(100) NULL,
    [pfCode70] VARCHAR(100) NULL,
    [pfType71] VARCHAR(100) NULL,
    [s72] VARCHAR(100) NULL,
    [i73] VARCHAR(100) NULL,
    [pe74] VARCHAR(100) NULL,
    [v75] VARCHAR(100) NULL,
    [volSrc] VARCHAR(100) NULL,
    [setlDate76] VARCHAR(100) NULL,
    [t77] VARCHAR(100) NULL,
    [cvf78] VARCHAR(100) NULL,
    [sc79] VARCHAR(100) NULL,
    [exch80] VARCHAR(100) NULL,
    [pfId81] VARCHAR(100) NULL,
    [cId82] VARCHAR(100) NULL,
    [s83] VARCHAR(100) NULL,
    [i84] VARCHAR(100) NULL,
    [val85] VARCHAR(100) NULL,
    [rl86] VARCHAR(100) NULL,
    [cpm87] VARCHAR(100) NULL,
    [exm88] VARCHAR(100) NULL,
    [r89] VARCHAR(100) NULL,
    [priceScan90] VARCHAR(100) NULL,
    [volScan91] VARCHAR(100) NULL,
    [cId92] VARCHAR(100) NULL,
    [o] VARCHAR(100) NULL,
    [k] VARCHAR(100) NULL,
    [p93] VARCHAR(100) NULL,
    [d94] VARCHAR(100) NULL,
    [v95] VARCHAR(100) NULL,
    [r96] VARCHAR(100) NULL,
    [a97] VARCHAR(100) NULL,
    [d98] VARCHAR(100) NULL,
    [cc] VARCHAR(100) NULL,
    [name99] VARCHAR(100) NULL,
    [id100] VARCHAR(100) NULL,
    [aVal] VARCHAR(100) NULL,
    [currency101] VARCHAR(100) NULL,
    [riskExponent] VARCHAR(100) NULL,
    [capAnov102] VARCHAR(100) NULL,
    [procMeth] VARCHAR(100) NULL,
    [wfprMeth] VARCHAR(100) NULL,
    [spotMeth] VARCHAR(100) NULL,
    [somMeth] VARCHAR(100) NULL,
    [cmbMeth] VARCHAR(100) NULL,
    [exch103] VARCHAR(100) NULL,
    [pfId104] VARCHAR(100) NULL,
    [pfCode105] VARCHAR(100) NULL,
    [pfType106] VARCHAR(100) NULL,
    [sc107] VARCHAR(100) NULL,
    [cmbMeth108] VARCHAR(100) NULL,
    [applyBasisRisk] VARCHAR(100) NULL,
    [r109] VARCHAR(100) NULL,
    [baseR] VARCHAR(100) NULL,
    [val110] VARCHAR(100) NULL,
    [tn] VARCHAR(100) NULL,
    [sPe] VARCHAR(100) NULL,
    [ePe] VARCHAR(100) NULL,
    [tn111] VARCHAR(100) NULL,
    [tn112] VARCHAR(100) NULL,
    [r113] VARCHAR(100) NULL,
    [val114] VARCHAR(100) NULL,
    [spread] VARCHAR(100) NULL,
    [chargeMeth] VARCHAR(100) NULL,
    [r115] VARCHAR(100) NULL,
    [val116] VARCHAR(100) NULL,
    [cc117] VARCHAR(100) NULL,
    [tn118] VARCHAR(100) NULL,
    [rs] VARCHAR(100) NULL,
    [i119] VARCHAR(100) NULL,
    [interSpreads] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.tuAutoUpdateContacts
-- --------------------------------------------------


CREATE TRIGGER tuAutoUpdateContacts ON [dbo].[CONTACTS] 
FOR UPDATE not for replication
as 
begin
   if @@rowcount = 0
      return
      
 
   if not update(gc_LastModificationTime)
   begin
      update c
      	set gc_LastModificationTime = CURRENT_TIMESTAMP
	from CONTACTS c inner join inserted i on (c.OCS_ID=i.OCS_ID)
   end
end

GO

-- --------------------------------------------------
-- VIEW dbo.Complaint_BR
-- --------------------------------------------------
CREATE View Complaint_BR  
as  
--Set transaction isolation level read uncommitted  
select department,code,category,complaint_date,branch=isnull(branch,'HO') from  
(select  department,code,category,complaint_date,branch=isnull(branch_cd,branch_code)   
from complaint_table a (nolock)  
left outer join intranet.risk.dbo.client_details b  
on a.code=b.party_code  
left outer join intranet.risk.dbo.subbrokers c  
on a.code=c.sub_broker  
where entered_through='HD'  and a.wrong_entry <> 'Y' and a.status like '%'     
) a

GO

-- --------------------------------------------------
-- VIEW dbo.dept_NoOfCalls
-- --------------------------------------------------
CREATE view dept_NoOfCalls   
as   
select b.departmentname as TypeOfQuery,NoOfCalls = count(a.department)  from Complaint_table a     
right outer join departmentmaster b   
on   a.department= b.deptno   
where complaint_date >= '07/01/2008' and complaint_date <= '08/01/2008' and
a.entered_through='HD'   
and a.entry_by like '%' and a.department like '%' and a.status like '%'   
and a.wrong_entry <> 'Y'  
group by b.departmentname,a.department,b.deptno

GO

-- --------------------------------------------------
-- VIEW dbo.Forward_reply_Vw
-- --------------------------------------------------
CREATE View Forward_reply_Vw    
as    
    
select gc_guid,flag=max(flag)    
from    
(    
select gc_guid,flag=case when gc_subject like 'FW:%' then 'F' else 'R' end    
from frwrd_reply (nolock) where status='forward'   
union    
select gc_guid,flag='Z'  from frwrd_reply (nolock) where status='reply'   
union    
select gc_guid,flag='O'  from frwrd_reply (nolock) where status not in ('reply','forward')   
) a    

group by gc_guid

GO

-- --------------------------------------------------
-- VIEW dbo.GetSurveyAns
-- --------------------------------------------------
CREATE View GetSurveyAns
as
select Department,cli.branch,cli.sub_broker,cli.client_Code,cli.client_name,
Ques_id,Ans,Sdate,
Mobile,Mobile_status,Phone,phone_status,email,email_status,Address,Action,Final_status,survey_by
from qa_survey_ans2 cli (nolock),
qa_survey_ans1 a (nolock),
(SELECT id,QUESTION,Department FROM QA_QUES_MASTER (nolock)) b
where b.id=a.ques_id and cli.id=a.id_ans2

GO

-- --------------------------------------------------
-- VIEW dbo.Server_manager_Branch_ITdetails
-- --------------------------------------------------

CREATE View [dbo].[Server_manager_Branch_ITdetails]
as
SELECT serv.Fld_Server,serv.fld_branch_Cd,man.fld_id,man.Fld_From_Date,man.Fld_To_Date,brmast.sr_no FROM Tbl_server_master serv
inner join Tbl_Manager_Master man 
on serv.Fld_Id=man.Fld_Id
inner join Tbl_IT_Br_Master brmast
on serv.fld_branch_Cd=brmast.Br_tag and Fld_To_Date > GETDATE()

GO

-- --------------------------------------------------
-- VIEW dbo.Server_manager_Branch_ITdetails_srno
-- --------------------------------------------------
Create View Server_manager_Branch_ITdetails_srno
				as
				SELECT distinct(sr_no),Fld_From_Date,Fld_To_Date FROM Server_manager_Branch_ITdetails_todate

GO

-- --------------------------------------------------
-- VIEW dbo.Server_manager_Branch_ITdetails_todate
-- --------------------------------------------------
CREATE  View dbo.Server_manager_Branch_ITdetails_todate
			as
			SELECT serv.Fld_Server,serv.fld_branch_Cd,man.fld_id,man.Fld_From_Date,man.Fld_To_Date,brmast.sr_no FROm Tbl_server_master serv
			inner join Tbl_Manager_Master man 
			on serv.Fld_Id=man.Fld_Id
			inner join Tbl_IT_Br_Master brmast
			on serv.fld_branch_Cd=brmast.Br_tag

GO

-- --------------------------------------------------
-- VIEW dbo.subject_querytype
-- --------------------------------------------------
create view subject_querytype 
as
select a.Fld_Query,b.subject , b.Mandatory_Requirements
from tbl_subject b,query_type a
where a.Fld_Srno = b.fld_queryid

GO

-- --------------------------------------------------
-- VIEW dbo.v_Addsubject_opHelpdesk
-- --------------------------------------------------
CREATE view v_Addsubject_opHelpdesk  
as  
  
select Srno,dept_name,fld_query, subject, mandatory_requirements,fld_deptid from tbl_subject a (nolock)   
LEFT OUTER JOIN department_master p (nolock)   
ON a.fld_deptid = p.dept_id    
LEFT OUTER JOIN QUERY_TYPE q (NOLOCK)  
ON a.fld_queryid=q.fld_srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_AOTD_RPt
-- --------------------------------------------------
CREATE View V_AOTD_RPt            
as            
            
select Fld_ComplainNo,Fld_Date,Fld_Connectivity,Fld_CircuitId,Fld_Descrip,Fld_MediumInfo,Fld_Action, Fld_Timefrm,Fld_TimeTo,Fld_Link_dntime,Fld_Business_dntime,Fld_Backup,Fld_Impact,Fld_Location,fld_Loc,Fld_Reason,Fld_LastUpdate,        
Fld_Status,Fld_DateTime,Fld_CompletedTime,Fld_Username,Fld_Accesscode,    
case when Fld_Location=0 then x.fld_Loc else upper(y.Br_Name)+'-('+y.Br_Tag+')' end as Br_Name,z.Category,            
upper(a.Person_Name) as Person_Name,case when x.Fld_Status = 'P' then 'PENDING' when x.Fld_Status = 'I' then 'No Issue' when  x.Fld_Status = 'U' then 'UNDER OBSERVATION' else 'COMPLETED' end as Status from            
(select * from tbl_Aotd(nolock))x            
left outer join            
(select * from tbl_It_Br_Master (nolock))y            
on x.Fld_Location  =y.Sr_No left outer join            
(select * from it_category1(nolock) where dept = 'IT')z            
on x.Fld_Connectivity = z.srno            
left outer join            
(select * from intranet.risk.dbo.user_login)a            
on x.Fld_Username = a.username

GO

-- --------------------------------------------------
-- VIEW dbo.V_Clt_Rpt
-- --------------------------------------------------
CREATE View V_Clt_Rpt as 

select x.Code,long_name,branch_cd,sub_broker,lower(email) as email,res_phone1 from
(select Distinct Code from complaint_table (nolock) where Department not in ('IT','SW') and Category = 'Client' and complaint_date >= 'Feb 25 2008' ) x
inner join
(select * from intranet.risk.dbo.client_details) y on rtrim(ltrim(x.code)) = rtrim(ltrim(y.party_code))
and (email <> '' and res_phone1 <> '')

GO

-- --------------------------------------------------
-- VIEW dbo.V_COMPLAINT_DETAILS
-- --------------------------------------------------
CREATE VIEW V_COMPLAINT_DETAILS
AS
SELECT SR_NUM,A.DEPT_ID,DEPT_NAME,DEPARTMENTNAME_ESCALTION,
COMPLAINT_ID,QUERY_TYPE,FLD_QUERY,A.SUBJECT,SUBJECT_NAME=B.SUBJECT,
COMPLAINT,SOLUTION,ACCESS_CODE,
SOLUTION_BY,COMPLAINT_DATE,SOLUTION_DATE,ATTACHMENT,STATUS,FLD_ENTRYBY,CSO_ATTCH,
FLD_HOLD_REASON,COMPL_ABT,
CLT_SUBDETL  FROM
(SELECT * FROM TBL_COMPLAINT  WITH (NOLOCK) )A
LEFT OUTER JOIN
(
SELECT DEPT_ID,DEPT_NAME,DEPARTMENTNAME_ESCALTION,FLD_QUERY,SUBJECT,FLD_SRNO,SRNO FROM
(SELECT DEPT_ID,DEPT_NAME,DEPARTMENTNAME_ESCALTION=DUMMY5 FROM DEPARTMENT_MASTER  WITH (NOLOCK))B
INNER JOIN
(SELECT FLD_SRNO,FLD_DEP_ID,FLD_QUERY FROM QUERY_TYPE WITH (NOLOCK))C
ON B.DEPT_ID=C.FLD_DEP_ID
INNER JOIN
(SELECT SRNO,FLD_DEPTID,FLD_QUERYID,SUBJECT FROM TBL_SUBJECT WITH (NOLOCK) )D
ON B.DEPT_ID=D.FLD_DEPTID AND C.FLD_SRNO=D.FLD_QUERYID)B
ON A.DEPT_ID=B.DEPT_ID --AND B.FLD_SRNO=A.QUERY_TYPE 
AND B.SRNO=A.SUBJECT

GO

-- --------------------------------------------------
-- VIEW dbo.V_COMPLAINT_MAXSRNO
-- --------------------------------------------------
CREATE VIEW V_COMPLAINT_MAXSRNO
AS
SELECT COMPLAINT_ID,SR_NUM=MAX(SR_NUM) FROM TBL_COMPLAINT WITH(NOLOCK)
GROUP BY COMPLAINT_ID

GO

-- --------------------------------------------------
-- VIEW dbo.V_COMPLAINT_MINSRNO
-- --------------------------------------------------
CREATE VIEW V_COMPLAINT_MINSRNO  
AS  
SELECT COMPLAINT_ID,SR_NUM=MIN(SR_NUM) FROM TBL_COMPLAINT WITH(NOLOCK)  
GROUP BY COMPLAINT_ID

GO

-- --------------------------------------------------
-- VIEW dbo.V_complaint_table
-- --------------------------------------------------
Create View V_complaint_table
as

select x.*,y.Fld_Server_Ip from 
(select * from complaint_table (nolock)  where department = 'IT')x
left outer join
(SELECT * FROM tbl_IT_site_Data (nolock))y
on x.code = y.Fld_Site_Code

GO

-- --------------------------------------------------
-- VIEW dbo.V_CSONAMES
-- --------------------------------------------------
CREATE VIEW V_CSONAMES
as
(
	SELECT B.fld_RegName as CSONAME,* FROM TBL_IT_BR_MASTER A
	LEFT OUTER JOIN TBL_REGIONMASTER_UPSWanlink B ON A.br_tag = B.fld_regCode
	Where A.br_region='CSO'  
	union
	SELECT B.fld_RegName as CSONAME,* FROM TBL_IT_BR_MASTER A
	LEFT OUTER JOIN TBL_REGIONMASTER_upsWanlink B ON A.br_region = B.fld_regCode
	Where A.br_region <> 'CSO' 
)

GO

-- --------------------------------------------------
-- VIEW dbo.V_DataCenter_Details
-- --------------------------------------------------
Create View V_DataCenter_Details
as

select x.*,y.Br_Name from
(select * from Tbl_server_master (nolock)) x
inner join
(select * from tbl_it_br_master (nolock) where Br_Type = 'DATACENTER')y
on x.Fld_Branch_Cd = y.br_tag

GO

-- --------------------------------------------------
-- VIEW dbo.V_Emp_info
-- --------------------------------------------------
create view V_Emp_info    
as        
   
select x.*,y.Div_Name from  
(       
select a.Emp_no,a.Emp_name,email=emailadd,status,      
Resadd1+''+ResAdd2+''+ResAdd3 as Address,      
pin,city,attnlocation,emp_region,acntno,state,phone,      
Department=departmentdesc,designation=c.jobdesc,      
Senior=isnull(d.hod_no,''),Sr_name=d.hod_name        
from hrsoft.AngelBroking.dbo.emplmst a,        
hrsoft.AngelBroking.dbo.DepartmentMaster b,         
hrsoft.AngelBroking.dbo.jobdescriptionmaster c,        
(select * from hrsoft.AngelBroking.dbo.auth_per) d        
where a.dept_no=b.dept_Code and a.DesgJobDesc=c.Jobdescid and isnull(a.emp_no,'')=d.emp_no          
) x  
inner join  
(  
select Emp_No,Div_Name from  hrsoft.angelbroking.dbo.employeeASPQuery  
) y on x.Emp_no = y.Emp_No

GO

-- --------------------------------------------------
-- VIEW dbo.v_graph
-- --------------------------------------------------
CREATE view v_graph as

select * from
(
select 
--case when x.issues is null then y.issues else x.issues end as issues,
case when x.Issues is null then y.Issues else x.Issues end as Issues,
isnull(x.Total_Issue_per,0) as Prev_Dt,
isnull(x.Total_Issue_Brok,0) as Prev_Tb,
isnull(y.Total_Issue_per,0) as Cur_Dt,
isnull(y.Total_Issue_Brok,0) as Cur_Tb 
from
(
--select distinct server, a_Total_Downtime_Per,(a_Total_brok_loss/100000) as a_Total_brok_loss from tbl_graph where a_Total_brok_loss <> 0
select distinct Issues,(Total_Issue_Brok/100000)as Total_Issue_Brok,Total_Issue_per from tbl_comp_issue_1
) x
full outer join
(
--select distinct server, b_Total_Downtime_Per,(b_Total_brok_loss/100000) as b_Total_brok_loss from tbl_graph where b_Total_brok_loss <> 0
select distinct Issues,(Total_Issue_Brok/100000)as Total_Issue_Brok,Total_Issue_per from tbl_comp_issue_2
) y on x.Issues = y.Issues
) x

GO

-- --------------------------------------------------
-- VIEW dbo.v_helpdesk_misreport
-- --------------------------------------------------
CREATE VIEW v_helpdesk_misreport   
AS   
  SELECT complaint_id,   
         p.dept_name,   
         q.subject,   
         fld_entryby = CASE   
                         WHEN r.emp_name IS NULL   
                         THEN t.name   
                         ELSE r.emp_name   
                       END,   
         complaint,   
         solution,   
         Convert(VARCHAR(11),complaint_date,103) AS complaint_date,   
         Convert(VARCHAR(11),solution_date,103)  AS solution_date,   
         s.emp_name                              AS solution_by,   
         a.status                                AS stat_flag,   
         status = CASE   
                    WHEN a.status IN ('IP','C','F')   
                    THEN 'In Process'   
                    WHEN a.status = 'H'   
                    THEN 'Hold'   
                    WHEN a.status = 'BC'   
                    THEN 'Completed'   
                    WHEN a.status = 'P'   
                    THEN 'Pending'   
                  END   
  FROM   tbl_complaint a  (nolock) 
         LEFT OUTER JOIN department_master p (nolock)   
           ON a.dept_id = p.dept_id   
         LEFT OUTER JOIN tbl_subject q   
           ON a.subject = q.srno   
         LEFT OUTER JOIN intranet.risk.dbo.emp_info r   
           ON a.fld_entryby = r.emp_no   
         LEFT OUTER JOIN intranet.risk.dbo.emp_info s   
           ON a.solution_by = s.emp_no   
         LEFT OUTER JOIN (SELECT DISTINCT sub_broker,   
                                          name   
                          FROM   intranet.risk.dbo.subbrokers) t   
           ON a.fld_entryby = t.sub_broker

GO

-- --------------------------------------------------
-- VIEW dbo.V_HR_Faqs
-- --------------------------------------------------
CREATE View V_HR_Faqs  
as  
  
select X.Fld_Sr_No,y.Fld_Request,x.Fld_Subject,x.Fld_Solution from   
(select * from Tbl_HR_Solutions (Nolock)) x  
left outer join  
(select * from Tbl_Request_Master (Nolock)) y  
on x.Fld_Sr_no = y.Fld_Srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_HrNewReqId
-- --------------------------------------------------
Create View V_HrNewReqId  
as  
select replace(str(isnull(max(FLd_Id),0)+1,4),' ',0) as RequestID from tbl_HrHarmonyNewRequest(nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.V_HrSubjectSolution
-- --------------------------------------------------
CREATE View dbo.V_HrSubjectSolution      
as      
      
select x.*,y.FldSubCatName,FldCatName,y.fldcatid,y.fldsubcatid from      
(      
select FldSSId,y.FldSubjectName,y.fldsubjectid,z.FldSolutionName from tbl_HR_SubjectSolution x     
left outer join  tbl_HR_SubjectMaster y on x.FldSubjectid = y.FldSubjectid      
left outer join  tbl_HR_SolutionMaster z on x.FldSolutionId = z.FldSolutionId      
)x       
left outer join     
(      
/*select FldSSId,FldSubCatName,FldCatName from tbl_HR_SubCategorySubject x left outer join  tbl_HR_SubCatMaster y on x.FldSubCatid = y.FldSubCatid   left outer join  tbl_HR_CatSubCategory z on x.FldSubCatSubjectId = z.FldSubCatSubjectId left outer join   
  
tbl_HR_CatMaster a on a.FldCatId = z.FldCatId  */    
select FldSSId,FldSubCatName,FldCatName,c.fldcatid,b.fldsubcatid from tbl_HR_CatSubCategory a left outer join  tbl_HR_SubCatMaster b on a.fldsubcatsubjectid = b.fldsubcatid left outer join tbl_HR_CatMaster c on a.fldcatid = c.fldcatid left outer join tbl_HR_SubCategorySubject d on a.fldsubcatsubjectid = d.fldsubcatid    
)y on x.FldSSId = y.FldSSId

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Inventory_Rpt
-- --------------------------------------------------
CREATE View V_IT_Inventory_Rpt      
as      
select x.*,y.Br_Tag,y.Br_Name,y.Br_Type,y.Br_Region,z.person_name from       
(select * from tbl_it_inventory (nolock))x      
left outer join      
(select * from tbl_it_br_master (nolock)) y      
on x.Br_id = y.Sr_no
LEFT OUTER JOIN                                      
(SELECT * FROM INTRANET.RISK.DBO.USER_LOGIN )z ON x.enteredby = z.USERNAME

GO

-- --------------------------------------------------
-- VIEW dbo.v_IT_PendingComplaints
-- --------------------------------------------------
CREATE View v_IT_PendingComplaints as                     
            
select complaint_date,code,department,dsection,queryfrom,city,contact_person,subject,problem,suggestion,completed_on,x.status,complaintno,party_code,time_limit,category,remark,dremark,            
y.person_name,entry_by,forwardto_dept,phone,           
Grp_id from            
(                    
select distinct               
--subject,              
complaint_date,code,department,dsection,queryfrom,city,contact_person,                    
case when TIme_Limit = 'Unsatisfied' then '<b><font color=red>'+subject+'</font></b>' else subject end as subject,              
case when TIme_Limit = 'Unsatisfied' then '<b><font color=red>'+problem+'</font></b>' else problem end as problem,              
case when TIme_Limit = 'Unsatisfied' then '<b><font color=red>'+suggestion+'</font></b>' else suggestion end as suggestion,              
--problem,suggestion,              
completed_on,status,complaintno,party_code,phone,              
time_limit,category,remark,dremark,entry_by,Grp_id,forwardto_dept                     
from complaint_table (nolock) where status in ('pending','scompleted') and entered_through = 'IT' and department like 'IT'                
) x            
left outer join            
(            
select * from intranet.risk.dbo.USER_LOGIN            
) y on x.entry_by = y.username

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt
-- --------------------------------------------------
CREATE View V_IT_Staff_Rpt  
as  
select a.*,b.Job_Des,c.Loc_Name,c.Description from  
(select Emp_No,Emp_Name,Status,Phone,convert(varchar(11),Joindate,103) as Joindate,
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,
emailadd,DesgJobDesc,Emp_region,attnlocation from hrsoft.AngelBroking.dbo.emplmst where dept_no in (40,48))a  
left outer join  
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b   
on a.DesgJobDesc = b.JobDesCid  
left outer join  
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c  
on a.Emp_region = c.code and a.attnlocation = c.pid

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt_New
-- --------------------------------------------------
      
      
      
CREATE View [dbo].[V_IT_Staff_Rpt_New]                                
as                                                
                                              
select case when x.Emp_No is null then y.Fld_Emp_No else x.Emp_No end as Emp_No,                                              
case when x.Emp_Name is null then y.Fld_Emp_Name else x.Emp_Name end as Emp_Name,                                              
case when x.Status is null then y.Fld_Status else x.Status end as Status,                                  
case when y.Fld_Phone is null then x.Phone else y.Fld_Phone end as Phone,                                              
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                                              
case when x.Joindate is null then convert(varchar(11),y.Fld_JoinDate,103) else x.Joindate end as Joindate,                                              
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                                              
case when y.Fld_emailadd is null then x.emailadd else y.Fld_emailadd end as emailadd,                          
case when x.JobDesCid is null then y.Fld_DeptId else x.JobDesCid end as DesgJobDesc,                                       
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,x.Department,x.subdepartment,x.Costcode,                                              
case when y.Fld_Branch_id is null then 0 else y.Fld_Branch_id end as Fld_Branch_id,                                    
convert(varchar(11),x.RelieveDate,103) as RelieveDate,x.[HOD NO],                                             
x.mm,x.yy,z.br_tag,z.Br_Name,q.*,z.Br_Type                                        
from          
                                          
(                                              
/*                        
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                                                
(                                
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                                            
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                                            
emailadd,DesgJobDesc,Emp_region,attnlocation                                             
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                                                
left outer join                                                
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                                                 
on a.DesgJobDesc = b.JobDesCid                                                
left outer join                                                
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                                                
on a.Emp_region = c.code and a.attnlocation = c.pid                                    
left outer join                                    
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                                    
on a.Emp_No = d.Emp_No                         
*/                         
                  
select x.*,y.JobDescid from                      
(                      
select [Emp No] Emp_No,Emp_Name,[HOD No],                        
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,                        
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,                        
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,                        
attendanceLoc as attnlocation,[Separation Date] RelieveDate,Region as Description,attendanceLoc as Loc_Name,                    
Department,[sub Department] as subdepartment,Costcode                        
from  [MIDDLEWARE].harmony.dbo.vlmsinhouse  where department = 'IT'      
-- and [Status]<> 'S'                     
)x                      
left outer join                      
(select * from  [MIDDLEWARE].harmony.dbo.jobdescriptionmaster) y                      
on x.Job_Des = y.JobDesc                                            
)x                                      
full outer join                                              
(select * from tbl_IT_Staff (nolock)) y                          
on x.Emp_No = y.Fld_Emp_No                                             
left outer join                                   
(select * from tbl_it_br_master(nolock))z                                          
on y.Fld_Branch_id = z.Sr_No                                          
left outer join                                                
(select * from V_User_Category_New)q                                        
on x.Emp_No = q.username     
-----------------------added by harshal for filter for  email ids at 22 JAN2 2013     
right outer join tbl_UPS_DailyMails(nolock) b                                          
on b.Sr_No = y.Fld_Branch_id           
----end    
where z.Sr_No is not null   and x.Status = 'A'

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt_New_1
-- --------------------------------------------------
CREATE View V_IT_Staff_Rpt_New_1                            
as                            
                          
select case when x.Emp_No is null then y.Fld_Emp_No else x.Emp_No end as Emp_No,                          
case when x.Emp_Name is null then y.Fld_Emp_Name else x.Emp_Name end as Emp_Name,                          
case when x.Status is null then y.Fld_Status else x.Status end as Status,              
case when y.Fld_Phone is null then x.Phone else y.Fld_Phone end as Phone,                          
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                          
case when x.Joindate is null then convert(varchar(11),y.Fld_JoinDate,103) else x.Joindate end as Joindate,                          
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                          
case when y.Fld_emailadd is null then x.emailadd else y.Fld_emailadd end as emailadd,      
case when x.DesgJobDesc is null then convert(varchar,y.Fld_DeptId) else x.DesgJobDesc end as DesgJobDesc,                   
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,                          
case when y.Fld_Branch_id is null then 0 else y.Fld_Branch_id end as Fld_Branch_id,                
convert(varchar(11),x.RelieveDate,103) as RelieveDate,                         
x.mm,x.yy,z.br_tag,z.Br_Name,q.*                    
 from                          
(                          
/*    
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                            
(            
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                        
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                        
emailadd,DesgJobDesc,Emp_region,attnlocation                         
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                            
left outer join                            
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                             
on a.DesgJobDesc = b.JobDesCid                            
left outer join                            
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                            
on a.Emp_region = c.code and a.attnlocation = c.pid                
left outer join                
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                
on a.Emp_No = d.Emp_No     
*/    
select [Emp No] Emp_No,Emp_Name,    
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,    
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,    
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,    
attendanceLoc as attnlocation,[Separation Date] RelieveDate,Region as Description,attendanceLoc as Loc_Name    
from  [MIDDLEWARE].harmony.dbo.vlmsinhouse  where department = 'IT'                         
)x                          
full outer join                          
(select * from tbl_IT_Staff (nolock)) y                          
on x.Emp_No = y.Fld_Emp_No                         
left outer join                      
(select * from tbl_it_br_master(nolock))z                      
on y.Fld_Branch_id = z.Sr_No                      
left outer join                            
(select * from intranet.risk.dbo.V_User_Category)q                    
on x.Emp_No = q.username

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt_New_15062011
-- --------------------------------------------------

CREATE View [dbo].[V_IT_Staff_Rpt_New_15062011]                         
as                                        
                                      
select case when x.Emp_No is null then y.Fld_Emp_No else x.Emp_No end as Emp_No,                                      
case when x.Emp_Name is null then y.Fld_Emp_Name else x.Emp_Name end as Emp_Name,                                      
case when x.Status is null then y.Fld_Status else x.Status end as Status,                          
case when y.Fld_Phone is null then x.Phone else y.Fld_Phone end as Phone,                                      
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                                      
case when x.Joindate is null then convert(varchar(11),y.Fld_JoinDate,103) else x.Joindate end as Joindate,                                      
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                                      
case when y.Fld_emailadd is null then x.emailadd else y.Fld_emailadd end as emailadd,                  
case when x.JobDesCid is null then y.Fld_DeptId else x.JobDesCid end as DesgJobDesc,                               
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,x.Department,x.subdepartment,x.Costcode,                                      
case when y.Fld_Branch_id is null then 0 else y.Fld_Branch_id end as Fld_Branch_id,                            
convert(varchar(11),x.RelieveDate,103) as RelieveDate,x.[HOD NO],                                     
x.mm,x.yy,z.br_tag,z.Br_Name,q.*,z.Br_Type                                
from                                      
(                                      
/*                
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                                        
(                        
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                                    
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                                    
emailadd,DesgJobDesc,Emp_region,attnlocation                                     
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                                        
left outer join                                        
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                                         
on a.DesgJobDesc = b.JobDesCid                                        
left outer join                                        
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                                        
on a.Emp_region = c.code and a.attnlocation = c.pid                            
left outer join                            
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                            
on a.Emp_No = d.Emp_No                 
*/                
select x.*,y.JobDescid from              
(              
select [Emp No] Emp_No,Emp_Name,[HOD No],                
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,                
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,                
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,                
attendanceLoc as attnlocation,[Separation Date] RelieveDate,Region as Description,attendanceLoc as Loc_Name,            
Department,[sub Department] as subdepartment,Costcode                
from  [196.1.115.239].harmony.dbo.vlmsinhouse  where department = 'IT'               
)x              
left outer join              
(select * from  [196.1.115.239].harmony.dbo.jobdescriptionmaster) y              
on x.Job_Des = y.JobDesc                                    
)x                                      
full outer join                                      
(select * from tbl_IT_Staff (nolock)) y                  
on x.Emp_No = y.Fld_Emp_No                                     
left outer join                           
(select * from tbl_it_br_master(nolock))z                                  
on y.Fld_Branch_id = z.Sr_No                                  
left outer join                                        
(select * from V_User_Category_New)q                                
on x.Emp_No = q.username  where z.Sr_No is not null

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt_New_23AUG
-- --------------------------------------------------






CREATE View [dbo].[V_IT_Staff_Rpt_New_23AUG]                          
as                                          
                                        
select case when x.Emp_No is null then y.Fld_Emp_No else x.Emp_No end as Emp_No,                                        
case when x.Emp_Name is null then y.Fld_Emp_Name else x.Emp_Name end as Emp_Name,                                        
case when x.Status is null then y.Fld_Status else x.Status end as Status,                            
case when y.Fld_Phone is null then x.Phone else y.Fld_Phone end as Phone,                                        
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                                        
case when x.Joindate is null then convert(varchar(11),y.Fld_JoinDate,103) else x.Joindate end as Joindate,                                        
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                                        
case when y.Fld_emailadd is null then x.emailadd else y.Fld_emailadd end as emailadd,                    
case when x.JobDesCid is null then y.Fld_DeptId else x.JobDesCid end as DesgJobDesc,                                 
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,x.Department,x.subdepartment,x.Costcode,                                        
case when y.Fld_Branch_id is null then 0 else y.Fld_Branch_id end as Fld_Branch_id,                              
convert(varchar(11),x.RelieveDate,103) as RelieveDate,x.[HOD NO],                                       
x.mm,x.yy,z.br_tag,z.Br_Name,q.*,z.Br_Type                                  
from    
                                    
(                                        
/*                  
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                                          
(                          
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                                      
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                                      
emailadd,DesgJobDesc,Emp_region,attnlocation                                       
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                                          
left outer join                                          
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                                           
on a.DesgJobDesc = b.JobDesCid                                          
left outer join                                          
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                                          
on a.Emp_region = c.code and a.attnlocation = c.pid                              
left outer join                              
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                              
on a.Emp_No = d.Emp_No                   
*/                   
            
select x.*,y.JobDescid from                
(                
select [Emp No] Emp_No,Emp_Name,[HOD No],                  
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,                  
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,                  
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,                  
attendanceLoc as attnlocation,[Separation Date] RelieveDate,Region as Description,attendanceLoc as Loc_Name,              
Department,[sub Department] as subdepartment,Costcode                  
from  [196.1.115.239].harmony.dbo.vlmsinhouse  where department = 'IT'
-- and [Status]<> 'S'               
)x                
left outer join                
(select * from  [196.1.115.239].harmony.dbo.jobdescriptionmaster) y                
on x.Job_Des = y.JobDesc                                      
)x                                        
full outer join                                        
(select * from tbl_IT_Staff (nolock)) y                    
on x.Emp_No = y.Fld_Emp_No                                       
left outer join                             
(select * from tbl_it_br_master(nolock))z                                    
on y.Fld_Branch_id = z.Sr_No                                    
left outer join                                          
(select * from V_User_Category_New)q                                  
on x.Emp_No = q.username  where z.Sr_No is not null

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt_New_Bk28072011
-- --------------------------------------------------


Create View V_IT_Staff_Rpt_New_Bk28072011                          
as                                          
                                        
select case when x.Emp_No is null then y.Fld_Emp_No else x.Emp_No end as Emp_No,                                        
case when x.Emp_Name is null then y.Fld_Emp_Name else x.Emp_Name end as Emp_Name,                                        
case when x.Status is null then y.Fld_Status else x.Status end as Status,                            
case when y.Fld_Phone is null then x.Phone else y.Fld_Phone end as Phone,                                        
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                                        
case when x.Joindate is null then convert(varchar(11),y.Fld_JoinDate,103) else x.Joindate end as Joindate,                                        
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                                        
case when y.Fld_emailadd is null then x.emailadd else y.Fld_emailadd end as emailadd,                    
case when x.JobDesCid is null then y.Fld_DeptId else x.JobDesCid end as DesgJobDesc,                                 
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,x.Department,x.subdepartment,x.Costcode,                                        
case when y.Fld_Branch_id is null then 0 else y.Fld_Branch_id end as Fld_Branch_id,                              
convert(varchar(11),x.RelieveDate,103) as RelieveDate,x.[HOD NO],                                       
x.mm,x.yy,z.br_tag,z.Br_Name,q.*,z.Br_Type                                  
from                                        
(                                        
/*                  
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                                          
(                          
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                                      
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                                      
emailadd,DesgJobDesc,Emp_region,attnlocation                                       
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                                          
left outer join                                          
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                                           
on a.DesgJobDesc = b.JobDesCid                                          
left outer join                                          
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                                          
on a.Emp_region = c.code and a.attnlocation = c.pid                              
left outer join                              
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                              
on a.Emp_No = d.Emp_No                   
*/                  
select x.*,y.JobDescid from                
(                
select [Emp No] Emp_No,Emp_Name,[HOD No],                  
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,                  
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,                  
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,                  
attendanceLoc as attnlocation,[Separation Date] RelieveDate,Region as Description,attendanceLoc as Loc_Name,              
Department,[sub Department] as subdepartment,Costcode                  
from  [196.1.115.239].harmony.dbo.vlmsinhouse  where department = 'IT'                 
)x                
left outer join                
(select * from  [196.1.115.239].harmony.dbo.jobdescriptionmaster) y                
on x.Job_Des = y.JobDesc                                      
)x                                        
full outer join                                        
(select * from tbl_IT_Staff (nolock)) y                    
on x.Emp_No = y.Fld_Emp_No                                       
left outer join                             
(select * from tbl_it_br_master(nolock))z                                    
on y.Fld_Branch_id = z.Sr_No                                    
left outer join                                          
(select * from V_User_Category_New)q                                  
on x.Emp_No = q.username  where z.Sr_No is not null

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt_New_Live
-- --------------------------------------------------

CREATE View [dbo].[V_IT_Staff_Rpt_New_Live]                            
as                                            
                                          
select case when x.Emp_No is null then y.Fld_Emp_No else x.Emp_No end as Emp_No,                                          
case when x.Emp_Name is null then y.Fld_Emp_Name else x.Emp_Name end as Emp_Name,                                          
case when x.Status is null then y.Fld_Status else x.Status end as Status,                              
case when y.Fld_Phone is null then x.Phone else y.Fld_Phone end as Phone,                                          
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                                          
case when x.Joindate is null then convert(varchar(11),y.Fld_JoinDate,103) else x.Joindate end as Joindate,                                          
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                                          
case when y.Fld_emailadd is null then x.emailadd else y.Fld_emailadd end as emailadd,                      
case when x.JobDesCid is null then y.Fld_DeptId else x.JobDesCid end as DesgJobDesc,                                   
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,x.Department,x.subdepartment,x.Costcode,                                          
case when y.Fld_Branch_id is null then 0 else y.Fld_Branch_id end as Fld_Branch_id,                                
convert(varchar(11),x.RelieveDate,103) as RelieveDate,x.[HOD NO],                                         
x.mm,x.yy,z.br_tag,z.Br_Name,q.*,z.Br_Type                                    
from      
                                      
(                                          
/*                    
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                                            
(                            
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                                        
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                                        
emailadd,DesgJobDesc,Emp_region,attnlocation                                         
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                                            
left outer join                                            
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                                             
on a.DesgJobDesc = b.JobDesCid                                            
left outer join                                            
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                                            
on a.Emp_region = c.code and a.attnlocation = c.pid                                
left outer join                                
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                                
on a.Emp_No = d.Emp_No                     
*/                    
select x.*,y.JobDescid from                  
(                  
select [Emp No] Emp_No,Emp_Name,[HOD No],                    
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,                    
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,                    
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,                    
attendanceLoc as attnlocation,[Separation Date] RelieveDate,Region as Description,attendanceLoc as Loc_Name,                
Department,[sub Department] as subdepartment,Costcode                    
from  [MIDDLEWARE].harmony.dbo.vlmsinhouse  where department = 'IT'                   
)x                  
left outer join                  
(select * from  [MIDDLEWARE].harmony.dbo.jobdescriptionmaster) y                  
on x.Job_Des = y.JobDesc                                        
)x                                          
full outer join                                          
(select * from tbl_IT_Staff (nolock)) y                      
on x.Emp_No = y.Fld_Emp_No                                         
left outer join                               
(select * from tbl_it_br_master(nolock))z                                      
on y.Fld_Branch_id = z.Sr_No                                      
left outer join                                            
(select * from V_User_Category_New)q                                    
on x.Emp_No = q.username  where z.Sr_No is not null

GO

-- --------------------------------------------------
-- VIEW dbo.V_IT_Staff_Rpt_New_rupali
-- --------------------------------------------------
  
--select * from V_IT_Staff_Rpt_New_rupali  
  
  
CREATE View [dbo].[V_IT_Staff_Rpt_New_rupali]                             
as                                            
                                          
select distinct x.Emp_No   as Emp_No,                                          
x.Emp_Name  as Emp_Name,                                          
x.Status  as Status,                              
 x.Phone  as Phone,                                          
--case when x.Phone is null then y.Fld_Phone else x.Phone end as Phone,                                          
 convert(varchar(11),x.JoinDate,103) as Joindate,                                          
--case when y.emailadd is null then x.Fld_emailadd else y.emailadd end as emailadd,                                          
x.emailadd  as emailadd,                      
 x.JobDesCid  as DesgJobDesc,                                   
x.Emp_region,x.attnlocation,x.Job_Des,x.Loc_Name,x.Description,x.Department,x.subdepartment,x.Costcode ,                                          
--case when x.costcode is null then '' else x.costcode end as Fld_Branch_id,   
x.Costcode as Fld_Branch_id  ,                            
convert(varchar(11),x.RelieveDate,103) as RelieveDate,x.[HOD NO],                                         
x.mm,x.yy,z.br_tag,z.Br_Name,q.*,z.Br_Type                                    
from                                          
(                                          
/*                    
select a.*,b.Job_Des,c.Loc_Name,c.Description,d.RelieveDate from                                            
(                            
select Emp_No,Emp_Name,case when Status = 'A' then 'A' else 'D' end as Status,Phone,                                        
convert(varchar(11),Joindate,103) as Joindate,datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,                                        
emailadd,DesgJobDesc,Emp_region,attnlocation                                         
from hrsoft.AngelBroking.dbo.emplmst where dept_no in (18,37,48,186,145,154,238,236,247,261))a                                            
left outer join                                            
(select JobDesCid,Jobdesc as Job_Des from hrsoft.AngelBroking.dbo.jobdescriptionmaster) b                                             
on a.DesgJobDesc = b.JobDesCid                                            
left outer join                                            
(select Code,Description,pid,attnlocation as Loc_Name from V_Region_Location)c                                            
on a.Emp_region = c.code and a.attnlocation = c.pid                                
left outer join                                
(select * from hrsoft.AngelBroking.dbo.Emp_separation) d                                
on a.Emp_No = d.Emp_No                     
*/    
                  
select x.*,y.JobDescid from                  
(                  
select [Emp No] Emp_No,Emp_Name,[HOD No],                    
case when Status = 'A' then 'A' else 'D' end as Status,Phone, convert(varchar(11),Joindate,103) as Joindate,                    
datepart(mm,Joindate) mm,datepart(yy,Joindate) yy,emailadd,                    
Designation as DesgJobDesc,Designation as Job_Des,Region as Emp_region,                    
attendanceLoc as attnlocation,[Separation Date] as RelieveDate,Region as Description,attendanceLoc as Loc_Name,                
Department,[sub Department] as subdepartment,Costcode , [Separation date]  as Separation_Date                 
from  [MIDDLEWARE].harmony.dbo.vlmsinhouse  where department IN (Select distinct Department from tbl_ITStaffMaster )                  
)x                  
left outer join                  
(select * from  [MIDDLEWARE].harmony.dbo.jobdescriptionmaster) y                  
on x.Job_Des = y.JobDesc                                        
)x                                          
full outer join                                          
(select * from tbl_ITStaffMaster (nolock)) y                
on x.Emp_No = y.[Emp No]                                         
left outer join                               
(select * from tbl_it_br_master(nolock))z                                      
on y.IT_Location = z.Br_Tag                                      
left outer join                                            
(select * from V_User_Category_New)q                                    
on x.Emp_No = q.username  where z.Br_Tag is not null

GO

-- --------------------------------------------------
-- VIEW dbo.V_ITRequestDetails
-- --------------------------------------------------

CREATE View V_ITRequestDetails        
as        
        
select x.*,y.Fld_AssetName,replace(str(Fld_RequestId,6),' ',0) as RequestID  from        
(select * from tbl_ITRequestMaster(nolock))x        
left outer join        
(select  * from tbl_it_assetmaster (nolock))y        
on x.Fld_AssetType = y.Fld_AssetID

GO

-- --------------------------------------------------
-- VIEW dbo.V_ITRequestId
-- --------------------------------------------------
Create View V_ITRequestId
as
select replace(str(isnull(max(FLd_Requestid),0)+1,7),' ',0) as RequestID from tbl_ITRequestMaster (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.V_ITRequestMaster
-- --------------------------------------------------
CREATE View V_ITRequestMaster
as
select replace(str(isnull(max(Fld_RequestId),0)+1,6),' ',0) as RequestID from tbl_ITRequestMaster (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.V_Manager_Cert_Validity
-- --------------------------------------------------
CREATE View V_Manager_Cert_Validity  
as  
  
select x.Fld_SrNo,x.Fld_Id,x.Fld_Segment,x.Fld_Manager_Id,
convert(varchar(11),x.Fld_From_Date) as Fld_From_Date,
convert(varchar(11),x.Fld_To_Date) as Fld_To_Date,
convert(varchar(11),sdate) as sdate,
convert(varchar(11),tdate) as tdate,
status,Manager_status,Fld_branch_cd,Fld_server,Br_name  
 from Tbl_Manager_Cert_Validity x(nolock)  left outer join V_Manager_Details y   
on x.Fld_Id = y.Fld_Id and x.Fld_Segment = y.Fld_Segment and x.Fld_Manager_id = y.Fld_Manager_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_Manager_Details
-- --------------------------------------------------
CREATE View V_Manager_Details                  
as                  
                  
select x.*,Fld_branch_cd,Fld_server,upper(z.Br_name) as Br_name,y.Fld_Odin_Ip,y.Fld_DB_Ip from                  
(      
select Fld_SrNo,Fld_Id,Fld_Segment
/*=case when Fld_Segment ='ABLCM' then 'BSE'  
when fld_segment='ACDLCM' then 'NSE'  
when fld_segment='ACDLFO' then 'NSEFO'  
when fld_segment='ACPLMCD' then 'MCXSX'  
when Fld_segment='ACPLMCX' then 'MCX'  
when Fld_segment='ACPLNCDEX' then 'NCDEX' end*/  
,Fld_Manager_Id,convert(varchar(11),Fld_From_Date) as Fld_From_Date,Fld_From_Date as sdate,Fld_To_Date as tdate,            
convert(varchar(11),Fld_To_Date) as Fld_To_Date,status,Manager_status from V_Tbl_Manager_Master      
) x                  
left outer join                  
(select * from Tbl_server_master) y                  
on x.Fld_id  = y.Fld_id                  
left outer join                
(select * from Tbl_IT_Br_Master where Br_Type = 'DATACENTER') z                
on y.Fld_branch_cd = z.Br_tag

GO

-- --------------------------------------------------
-- VIEW dbo.V_Mis_Rpt
-- --------------------------------------------------
CREATE View V_Mis_Rpt                      
as                      
                     
select x.*,y.Emp_Name as Solved_by from                    
(                     
select x.*,y.* from                      
(                      
select           
/*convert(varchar,Fld_Complaint_date,105) +' '+          
convert(varchar,Fld_Complaint_date,108) as*/          
Fld_Complaint_date,        
Fld_Emp_Code,        
Fld_Request,        
Fld_Request_id,        
Fld_Mark_Time,        
Fld_Solved_By,        
Fld_Complaint_No,        
Fld_Status,        
Fld_Query,        
Fld_Solution      
from                      
(select * from Tbl_HR_Complaint_Master) x                      
left outer join                      
(select * from Tbl_Request_Master)y                       
on x.Fld_Request_Id = y.Fld_Srno                      
)x                      
left outer join                      
(    
                    
/*    
select distinct  y.code as Region_Code,y.pid as Branch_Id,emp_name,Emp_No,y.Description as Region,y.attnlocation as branch_cd,lower(email) as email,department,Sr_Name,phone from                    
(select * from V_Emp_info) x                    
inner join                    
(select * from V_Region_Location) y                    
on x.Emp_region = y.code and x.attnlocation = y.pid      
*/    
select Region as Region_Code,CostCode as Branch_Id,emp_name,[Emp No] as Emp_No,Region,AttendanceLoc as branch_cd,    
lower(emailadd) as email,department,[HOD Name] as Sr_Name,phone from    
[MIDDLEWARE].harmony.dbo.vlmsinhouse   
    
) y on x.Fld_Emp_Code =  y.Emp_No                     
) x                     
left outer join                    
(select * from intranet.risk.dbo.emp_info) y                      
on x.Fld_Solved_By = y.Emp_no

GO

-- --------------------------------------------------
-- VIEW dbo.V_Mis_Rpt_new
-- --------------------------------------------------
CREATE View V_Mis_Rpt_new                                  
as                                  
                                 
select x.*,y.Emp_Name as Solved_by from                                
(                                 
select x.*,y.* from                                  
(                                  
select                       
/*convert(varchar,Fld_Complaint_date,105) +' '+                      
convert(varchar,Fld_Complaint_date,108) as*/                      
fld_srno,            
Fld_Complaint_date,                    
Fld_Emp_Code,                    
fldsubcatname,                    
Fld_Request_id,                    
Fld_Mark_Time,                    
Fld_Solved_By,                    
Fld_Complaint_No,                    
Fld_Status,                    
Fld_Query,                    
Fld_Solution,          
fld_wip_fres,    
fldcatid                  
from                                  
(select * from Tbl_HR_Complaint_Master_New (nolock) ) x                                  
left outer join                                  
(select * from tbl_hr_subcatmaster (nolock))y                                   
on x.Fld_Request_Id = y.fldsubcatid      
left outer join     
(select * from tbl_HR_CatSubCategory (nolock))z    
on x.Fld_Request_Id = z.fldsubcatsubjectid                              
)x                                  
left outer join                                  
(                
                                
/*                
select distinct  y.code as Region_Code,y.pid as Branch_Id,emp_name,Emp_No,y.Description as Region,y.attnlocation as branch_cd,lower(email) as email,department,Sr_Name,phone from                                
(select * from V_Emp_info) x                                
inner join                                
(select * from V_Region_Location) y                                
on x.Emp_region = y.code and x.attnlocation = y.pid                  
                
select Region as Region_Code,CostCode as Branch_Id,emp_name,[Emp No] as Emp_No,Region,AttendanceLoc as branch_cd,                
lower(emailadd) as email,department,[HOD Name] as Sr_Name,phone from                
hrsoft.angelbroking.dbo.VLMS       
*/      
select a.*,b.reg_code,b.region as regionname,b.code,b.[name] as branch_name  from     
(    
select Region as Region_Code,CostCode as Branch_Id,emp_name,[Emp_No] as Emp_No,Region,AttendanceLoc as branch_cd,                
lower(email) as email,department,[Sr_Name] as Sr_Name,phone from                
intranet.risk.dbo.emp_info with (nolock) )a    
left outer join    
(select * from intranet.risk.dbo.region with (nolock))b on a.branch_id = b.code    
) y on x.Fld_Emp_Code =  y.Emp_No                                 
) x                                 
left outer join                                
(select * from intranet.risk.dbo.emp_info with (nolock)) y                                  
on x.Fld_Solved_By = y.Emp_no

GO

-- --------------------------------------------------
-- VIEW dbo.V_Mis_RptCategory
-- --------------------------------------------------
create view V_Mis_RptCategory as
select a.* ,b.fldcatname from
(select * from V_Mis_Rpt_new with (nolock))a
left outer join
(select * from tbl_hr_catmaster with (nolock))b
on a.fldcatid = b.fldcatid

GO

-- --------------------------------------------------
-- VIEW dbo.v_odinchecklist_cutofftime
-- --------------------------------------------------
CREATE view v_odinchecklist_cutofftime  
as  
select a.*,b.procedures,c.br_name from   
(select * from tbl_odinchecklist_cutofftime ) a  
left outer join  
(select fld_id,procedures from odinchecklist_procedures where flag='A' ) b  
on a.procedureid=b.fld_id  
left outer join  
(select sr_no,br_name,br_tag from tbl_it_br_master where br_type='DATACENTER' ) c  
on a.br_tag=c.br_tag

GO

-- --------------------------------------------------
-- VIEW dbo.V_OP_Complaintid_serailno
-- --------------------------------------------------
CREATE view V_OP_Complaintid_serailno  
as  
select Complaint_id,Min_srno=min(Sr_num),Max_srno=max(Sr_num) from helpdesk.dbo.tbl_complaint with (nolock) group by Complaint_id

GO

-- --------------------------------------------------
-- VIEW dbo.v_operation_emailid
-- --------------------------------------------------
create view v_operation_emailid
as
Select a.Sr_No,a.Fld_DeptName,Fld_DeptID,Fld_EmpID,b.email,b.Senior,b.Senior_email from
(Select * from tbl_dept_mapping)a
left outer join
(Select x.emp_no,x.email,y.senior,y.Senior_email from
(Select emp_no,senior,email from intranet.risk.dbo.emp_info)x
join
(Select emp_no,senior,email as Senior_email from intranet.risk.dbo.emp_info where emp_no in
(Select senior from intranet.risk.dbo.emp_info))y
on x.senior=y.emp_no)b
on a.Fld_EmpID = b.emp_no

GO

-- --------------------------------------------------
-- VIEW dbo.V_OPH_deptdetails
-- --------------------------------------------------
Create View V_OPH_deptdetails
as
select a.dept_id,a.dept_name,b.fld_srno as queryid,fld_query,c.srno as subject_id,c.subject from
(select * from department_master)a
left outer join
(select fld_srno,fld_dep_id,fld_query from query_type)b
on a.dept_id=b.fld_dep_id
left outer join
(select fld_queryid,subject,srno from tbl_subject)c
on b.fld_srno=c.fld_queryid

GO

-- --------------------------------------------------
-- VIEW dbo.V_OpsStatus
-- --------------------------------------------------
CREATE View V_OpsStatus                                        
as                                        
                                        
select convert(datetime,Complaint_date,103) as Complaint_date,    
Complaint_id,y.Fld_Query,    
x.status as Stat_Flag,                                        
---status=case when x.status in ('IP','C','f') then 'In Process'     

status=case when x.status ='IP' then 'InProcess'                                      
when x.status = 'H' then 'Hold'                  
when x.status = 'BC' then 'Completed'                  
when x.status = 'f' then 'Forwarded'     
when x.status = 'C' then 'Completed'                 
when x.status = 'P' then 'Pending' end,        


Emp_name = z.person_name ,--case when z.person_name is null then r.name else z.person_name end,                  
Branch_Tag=z.access_code,-- case when z.access_code is null then r.sub_broker else z.access_code end,                  
q.subject ,x.dept_id,S.DEPT_NAME,x.fld_entryby,x.sr_num,x.clt_subdetl            
--Branch_Tag = r.sub_broker,  
-- q.subject ,x.dept_id,S.DEPT_NAME,x.fld_entryby,x.sr_num,x.clt_subdetl               
from                  
tbl_complaint x WITH (NOLOCK)                  
inner join                 
query_type y WITH (NOLOCK) on x.query_type = y.Fld_SrNo                  
left outer join
intranet.risk.dbo.user_login z WITH (NOLOCK) on x.Fld_EntryBy = z.username                  
inner join
tbl_subject q WITH (NOLOCK) on x.subject=q.srno              
inner join
DEPARTMENT_MASTER S WITH (NOLOCK) ON X.DEPT_ID=S.DEPT_ID                  
--inner join
--(select distinct sub_broker,name from intranet.risk.dbo.subbrokers WITH (NOLOCK)) r on x.Fld_EntryBy = r.sub_broker

GO

-- --------------------------------------------------
-- VIEW dbo.V_OpsStatus_dummy
-- --------------------------------------------------
CREATE View V_OpsStatus_dummy                                
as                                
                                
select convert(datetime,Complaint_date,103) as Complaint_date,Complaint_id,y.Fld_Query,x.status as Stat_Flag,                                
status=case when x.status in ('IP','C','F') then 'In Process'                                
when x.status = 'H' then 'Hold'          
when x.status = 'BC' then 'Completed'          
--when x.status = 'F' then 'Forwarded'          
when x.status = 'P' then 'Pending' end,          
Emp_name=case when z.Emp_Name is null then r.name else z.Emp_Name end,          
Branch_Tag=case when z.Costcode is null then r.sub_broker else z.Costcode end,          
q.subject ,x.dept_id,S.DEPT_NAME,x.fld_entryby,x.sr_num                              
from          
tbl_complaint x          
left outer join          
query_type y on x.query_type = y.Fld_SrNo          
left outer join          
intranet.risk.dbo.emp_info z on x.Fld_EntryBy = z.emp_no          
left outer join          
tbl_subject q on x.subject=q.srno      
LEFT OUTER JOIN      
DEPARTMENT_MASTER S ON X.DEPT_ID=S.DEPT_ID          
LEFT OUTER JOIN          
(select distinct sub_broker,name from intranet.risk.dbo.subbrokers) r on x.Fld_EntryBy = r.sub_broker

GO

-- --------------------------------------------------
-- VIEW dbo.V_OpsStatus_new
-- --------------------------------------------------
CREATE View V_OpsStatus_new                                        
as                                        
                                        
select convert(datetime,Complaint_date,103) as Complaint_date,    
Complaint_id,y.Fld_Query,    
x.status as Stat_Flag,                                        
---status=case when x.status in ('IP','C','f') then 'In Process'     

status=case when x.status ='IP' then 'InProcess'                                      
when x.status = 'H' then 'Hold'                  
when x.status = 'BC' then 'Completed'                  
when x.status = 'f' then 'Forwarded'     
when x.status = 'C' then 'Completed'                 
when x.status = 'P' then 'Pending' end,        


--Emp_name = z.person_name ,--case when z.person_name is null then r.name else z.person_name end,                  
Branch_Tag=x.access_code,-- case when z.access_code is null then r.sub_broker else z.access_code end,                  
q.subject ,x.dept_id,S.DEPT_NAME,x.fld_entryby,x.sr_num,x.clt_subdetl            
--Branch_Tag = r.sub_broker,  
-- q.subject ,x.dept_id,S.DEPT_NAME,x.fld_entryby,x.sr_num,x.clt_subdetl               
from                  
tbl_complaint x WITH (NOLOCK)                  
inner join                 
query_type y WITH (NOLOCK) on x.query_type = y.Fld_SrNo                  
--left outer join
--intranet.risk.dbo.user_login z WITH (NOLOCK) on x.Fld_EntryBy = z.username                  
inner join
tbl_subject q WITH (NOLOCK) on x.subject=q.srno              
inner join
DEPARTMENT_MASTER S WITH (NOLOCK) ON X.DEPT_ID=S.DEPT_ID                  
--inner join
--(select distinct sub_broker,name from intranet.risk.dbo.subbrokers WITH (NOLOCK)) r on x.Fld_EntryBy = r.sub_broker

GO

-- --------------------------------------------------
-- VIEW dbo.V_Order_Confirmation
-- --------------------------------------------------
CREATE View V_Order_Confirmation
as
select x.*,Fld_SrNo,Fld_Confimation_Time,Fld_Staus,Fld_Reason,Fld_Upd_By,Fld_Upd_Time from
(SELECT Sr_No as Branch_id,Br_Name,Br_Contact_Person FROM Tbl_IT_Br_Master (nolock) WHERE BR_TYPE = 'DATACENTER')x
left outer join
(select * from tbl_Order_Confirmation (nolock))y
on x.Branch_id = y.Fld_Branch_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_pedingcomplaint_feedback
-- --------------------------------------------------
CREATE view dbo.V_pedingcomplaint_feedback    
as    
select convert(varchar(11),complaint_date,103)complaint_date,department,code,dsection,queryfrom,contact_person,problem,    
suggestion,completed_on,status,complaintno,party_code,category,remark,dremark,entry_by,mark_complete    
,b.*     
from    
(Select * from complaint_table (nolock) where department <> 'IT') a    
left outer join     
(Select * from departmentmaster (nolock)) b     
on a.department=b.deptno     
where status in ('pending','scompleted')

GO

-- --------------------------------------------------
-- VIEW dbo.V_Printer_Master
-- --------------------------------------------------
Create View V_Printer_Master
as

select x.*,Fld_Brand_Name,upper(Br_Name+'-('+br_tag+')') as Br_Name from
(select * from tbl_Printer_Master (nolock))x
left outer join
(select * from tbl_UPS_Brand_Master (nolock))y on 
x.Fld_Mfg_id = y.Fld_SrNo
left outer join
(select * from tbl_it_br_master (nolock))z on 
x.Fld_Branch_id = z.Sr_No

GO

-- --------------------------------------------------
-- VIEW dbo.V_Region_Location
-- --------------------------------------------------
CREATE View V_Region_Location  
as    
  
select x.*,pid,attnlocation,loc_no from  
(select Code,Description,IntZone from hrsoft.angelbroking.dbo.RegionMaster with (nolock))x  
left outer join  
(select * from hrsoft.angelbroking.dbo.locationattnmaster with (nolock))y  
on x.Code = y.intRegion

GO

-- --------------------------------------------------
-- VIEW dbo.v_requestdetail
-- --------------------------------------------------
CREATE view v_requestdetail           
as                
select compl_abt,clt_subdetl,complaint_id,b.subject,Fld_EntryBy,c.emp_name,c.costcode,         
convert(varchar(12),complaint_date,103)as complaint_Date,convert(varchar(12),Solution_date,103)as Solution_date,                
complaint,Attachment,a.status,sr_num  from tbl_complaint a(nolock) left outer join intranet.risk.dbo.emp_info c on a.fld_entryby=c.emp_no,tbl_subject b           
 where  a.subject=b.srno

GO

-- --------------------------------------------------
-- VIEW dbo.v_requestdetail_dummy
-- --------------------------------------------------
CREATE view v_requestdetail_dummy          
as          
select complaint_id,b.subject,Fld_EntryBy,c.emp_name,c.costcode,   
convert(varchar(12),complaint_date,103)as complaint_Date,convert(varchar(12),Solution_date,103)as Solution_date,          
complaint,Attachment,a.status,sr_num  from tbl_complaint a(nolock) left outer join intranet.risk.dbo.emp_info c on a.fld_entryby=c.emp_no,tbl_subject b     
 where  a.subject=b.srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_RM_Region
-- --------------------------------------------------
Create View V_RM_Region
as

select x.*,y.Reg_COde,y.Region from tbl_region_master x (nolock) 
left outer join intranet.risk.dbo.region y
on x.Fld_regCode = y.code

GO

-- --------------------------------------------------
-- VIEW dbo.V_SBS_Master
-- --------------------------------------------------
CREATE view V_SBS_Master                
as                
                
select Fld_SBS_NAME,Fld_srno,Fld_ID,x.Fld_Sbs_Id,Br_Name,Br_Tag,Branch_id,'['+replace(right(Fld_Sbs_ip,3),'.','')+']' as Fld_Sbs_ip,Fld_Remark from                
(select * from Tbl_SBS_Mast (nolock)) x                
inner join                
(          
select Fld_Sbs_Id,x.Fld_srno,y.Sr_No as Branch_id,x.Fld_Id,Br_Tag,Br_Name from          
(select * from  Tbl_SBS_Mapp (nolock)) x          
left outer join          
(select * from  tbl_it_br_master (nolock)) y         
on x.Fld_id = y.Sr_No         
) y on x.Fld_Sbs_id = y.Fld_Sbs_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_Segment_Master
-- --------------------------------------------------
CREATE View V_Segment_Master      
as      
select segment,tdate,uptime from (       
select 'ABLCM' as segment,tdate,Uptime=bse from sett_mst   
union       
SELECT 'ACDLCM' as segment,tdate,cm from sett_mst       
union       
SELECT 'ACDLFO' as segment,tdate,fo from sett_mst       
union       
SELECT 'ACPLMCX' as segment,tdate,Mcx from sett_mst      
union       
SELECT 'ACPLNCDEX' as segment,tdate,NCDEX from sett_mst     
union    
SELECT 'ACDLNSX' as segment,tdate,ACDLNSX from sett_mst     
union    
SELECT 'ACPLMCD' as segment,tdate,ACPLMCD  from sett_mst      
) x

GO

-- --------------------------------------------------
-- VIEW dbo.V_Server_manager_Branch_ITdetails_forTcp
-- --------------------------------------------------
 
    
CREATE View [dbo].[V_Server_manager_Branch_ITdetails_forTcp]  
as  
SELECT serv.Fld_Server,serv.fld_branch_Cd,man.fld_id,man.Fld_From_Date,man.Fld_To_Date,brmast.sr_no FROM Tbl_server_master serv  
inner join Tbl_Manager_Master man   
on serv.Fld_Id=man.Fld_Id  
inner join Tbl_IT_Br_Master brmast  
on serv.fld_branch_Cd=brmast.Br_tag 
--and Fld_To_Date < GETDATE()

GO

-- --------------------------------------------------
-- VIEW dbo.V_Server_Master
-- --------------------------------------------------
CREATE view [dbo].[V_Server_Master]                                
as                                
                           
select Distinct x.FLd_SrNO,x.Fld_Branch_cd,Fld_server,y.Fld_id,z.Br_Name,y.Status,z.reg_code,y.Fld_To_date from                          
(select * from  Tbl_Server_Mapp (nolock)) x                          
left outer join                          
(select * from  V_Tbl_Server_Master (nolock)) y                          
on x.Fld_Server_id = y.Fld_id                          
left outer join                  
(select * from  v_tbl_it_br_master (nolock) where Br_Type = 'DATACENTER'  and Br_Status='A'  
union select '','NAGPR','Nagpur','','','','','','','','','','','','','MAH',''    
union select '','KNPR','Kanpur','','','','','','','','','','','','','UP',''    
union select '','CMBTR','Coimbatore','','','','','','','','','','','','','COIM','') z                          
on x.Fld_Branch_Cd = z.Br_Tag

GO

-- --------------------------------------------------
-- VIEW dbo.v_solutiondetail
-- --------------------------------------------------
CREATE view v_solutiondetail                      
as                      
                    
select complaint_id,b.subject,solution_by=c.emp_name, convert(varchar(12),Complaint_Date,103) as Complaint_Date,          
convert(varchar(12),Solution_Date,103) as Solution_Date,                      
complaint,Solution,a.status,fld_hold_Reason,cso_attch,sr_num,a.dept_id,a.subject as subject_id,          
a.query_type as query_type,d.emp_name,TAT=Datediff(hh,Complaint_Date,getdate()),e.dept_name,clt_subdetl from tbl_complaint(nolock)a       
left outer join tbl_subject b        
on a.subject=b.srno       
left outer join  intranet.risk.dbo.emp_info c                    
on  a.solution_by=c.emp_no     
left outer join  intranet.risk.dbo.emp_info d    
on a.fld_entryby=d.emp_no   
left outer join department_master e  
on a.dept_id=e.dept_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_tbl_it_br_master
-- --------------------------------------------------
CREATE View V_tbl_it_br_master      
as      
   select a.*,b.brmast_cd from     
(select x.*,y.Reg_Code from      
(select Sr_No,Br_Tag,Br_Name,Br_Type,Br_Region,Br_Contact_Person,Br_Address,Br_Email,Br_TelNo,Br_Fax,Br_Head,Br_Head_Mails,Br_CellNo,Fld_Business_Category,Br_Status  
 from tbl_it_br_master (nolock) where br_Status='A')x      
left outer join      
(select * from intranet.risk.dbo.region)y      
on x.br_tag = y.Code)a  
left outer join    
(select branch_cd,brmast_cd from  intranet.risk.dbo.branch_master )b  
on a.br_tag=b.branch_cd

GO

-- --------------------------------------------------
-- VIEW dbo.V_tbl_it_br_master_IT_Staff
-- --------------------------------------------------

CREATE View [dbo].[V_tbl_it_br_master_IT_Staff]      
as      
   select a.*,b.brmast_cd from     
(select x.*,y.Reg_Code from      
(select Sr_No,Br_Tag,Br_Name,Br_Type,Br_Region,Br_Contact_Person,Br_Address,Br_Email,Br_TelNo,Br_Fax,Br_Head,Br_Head_Mails,Br_CellNo,Fld_Business_Category,Br_Status  
 from tbl_it_br_master (nolock) where br_Status in ('A','D'))x      
left outer join      
(select * from intranet.risk.dbo.region)y      
on x.br_tag = y.Code)a  
left outer join    
(select branch_cd,brmast_cd from  intranet.risk.dbo.branch_master )b  
on a.br_tag=b.branch_cd

GO

-- --------------------------------------------------
-- VIEW dbo.V_Tbl_IT_Reports_details
-- --------------------------------------------------
CREATE View V_Tbl_IT_Reports_details      
as      
SELECT x.*,Fld_id,Fld_Br_Code,upper(z.Br_Name)+'-('+y.Fld_Br_Code+')' as  Br_Name,a.person_name,    
CASE WHEN Fld_Status = 'P' THEN 'PENDING' ELSE 'COMPLETED' END AS Fld_Status,      
Fld_Fet_Date,Fld_Upd_Date,Fld_Upd_By,
case 
when Fld_Frq = 1 Then 'DAILY'       
when Fld_Frq = 2 Then 'WEEKLY'       
when Fld_Frq = 3 Then 'MONTHLY'       
when Fld_Frq = 4 Then 'QUARTERLY' END AS RPT_TYPE
FROM Tbl_IT_Reports_Master x (nolock)  
left outer join   
Tbl_IT_Reports_details y (nolock) on x.Fld_Srno = y.Fld_id      
left outer join   
Tbl_it_Br_Master z (nolock)  on y.Fld_Br_Code = z.Br_tag  
left outer join  
intranet.risk.dbo.user_login a on y.Fld_Upd_By = a.username

GO

-- --------------------------------------------------
-- VIEW dbo.V_tbl_IT_site_Data
-- --------------------------------------------------


CREATE View V_tbl_IT_site_Data      
as      
      
select       
x.Fld_SrNo,Fld_Site_Code,Fld_Location,Fld_BranchTag,Fld_Connectivity,Fld_RelationShip,Fld_Def_Gateway,      
Fld_Subnet_Mast,Fld_Status,Fld_Postal_Address,Fld_Contact_Person,Fld_Contact_No,      
Fld_Email_Id,Fld_Connected_Branch,Fld_BSE,Fld_NSE,Fld_FO,Fld_BSEFO,Fld_MCX,      
Fld_NCX,Fld_Odin_Userid_Eq,Fld_Odin_Userid_Comm,Fld_Server_Ip,Fld_Entry_Date,      
Fld_Userid,Fld_UserLocation,y.Br_Name,z.category,y.Br_Tag from      
(select *  from tbl_IT_site_Data (nolock))x      
left outer join      
(select Sr_No,Br_Tag,Br_Name from Tbl_IT_Br_Master (nolock))y      
on x.Fld_BranchTag = y.Sr_No    
left outer join      
(select * from Cat_mast (nolock) where DeptNo = 'IT')z      
on x.Fld_Connectivity = z.Sr_No

GO

-- --------------------------------------------------
-- VIEW dbo.V_tbl_ITAssetsData_entry
-- --------------------------------------------------
CREATE View V_tbl_ITAssetsData_entry        
as        
Select Fld_SrNo,Fld_RequestId,Fld_ProductModel,Fld_ProductDesc,        
Fld_AssetName,Fld_AssetTag,Fld_PartNo,Fld_VendorName,Fld_Rate,convert(varchar(11),Fld_WarrantyFrom,103)Fld_WarrantyFrom,        
convert(varchar(11),Fld_WarrantyTo,103)Fld_WarrantyTo,Fld_BranchCode,        
Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,Fld_Status,fld_CapexName,Fld_Qty,Fld_WarrantyType from tbl_ITAssetsData(nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.V_Tbl_Manager_Master
-- --------------------------------------------------

CREATE View V_Tbl_Manager_Master       
as      
      
select *,'Disabled' as Status,case when Fld_To_Date > getdate() then 'Active' else 'Disabled' end as Manager_Status from Tbl_Manager_Master(nolock) where Fld_To_date < getdate() and Fld_id not in (select Fld_id from Tbl_Manager_Master(nolock) where Fld_To_date > getdate())      
union all      
select *,'Active',case when Fld_To_Date > getdate() then 'Active' else 'Disabled' end from Tbl_Manager_Master(nolock) where convert(varchar,Fld_id)+Fld_Manager_id not in      
(      
select convert(varchar,Fld_id)+Fld_Manager_id from Tbl_Manager_Master(nolock) where Fld_To_date < getdate() and Fld_id not in      
(      
select Fld_id from Tbl_Manager_Master(nolock) where Fld_To_date > getdate()      
)      
)

GO

-- --------------------------------------------------
-- VIEW dbo.V_Tbl_Manager_Master_backup
-- --------------------------------------------------
CREATE View V_Tbl_Manager_Master_backup         
as        
        
select *,'Disabled' as Status,case when Fld_To_Date > getdate() then 'Active' else 'Disabled' end as Manager_Status from Tbl_Manager_Master_backup(nolock) where Fld_To_date < getdate() and Fld_id not in (select Fld_id from Tbl_Manager_Master_backup(nolock) where Fld_To_date > getdate())        
union all        
select *,'Active',case when Fld_To_Date > getdate() then 'Active' else 'Disabled' end from Tbl_Manager_Master_backup(nolock) where convert(varchar,Fld_id)+Fld_Manager_id not in        
(        
select convert(varchar,Fld_id)+Fld_Manager_id from Tbl_Manager_Master_backup(nolock) where Fld_To_date < getdate() and Fld_id not in        
(        
select Fld_id from Tbl_Manager_Master_backup(nolock) where Fld_To_date > getdate()        
)        
)

GO

-- --------------------------------------------------
-- VIEW dbo.V_Tbl_server_master
-- --------------------------------------------------
CREATE View V_Tbl_server_master  
as  
  
select x.*,Y.Status,y.Fld_To_date from  
(select * from Tbl_server_master)x  
left outer join  
(select Fld_id,Status,max(Fld_To_date) as Fld_To_date from V_Tbl_Manager_Master group by Fld_id,status)y  
on x.Fld_id = y.Fld_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_Tbl_server_master_backup
-- --------------------------------------------------
Create View V_Tbl_server_master_backup  
as  
  
select x.*,Y.Status from  
(select * from Tbl_server_master)x  
left outer join  
(select distinct Fld_id,Status from V_Tbl_Manager_Master_backup)y  
on x.Fld_id = y.Fld_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_Tbl_server_master_new
-- --------------------------------------------------

Create View V_Tbl_server_master_new  
as  
 
select distinct(SM.fld_id),SM.Fld_branch_cd,SM.fld_server,SM.fld_Odin_ip,SM.Fld_DB_Ip,MM.STATUS From Tbl_server_master_new SM
left outer join
V_Tbl_Manager_Master MM on SM.fld_id=MM.Fld_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_Tbl_Tcp_Count
-- --------------------------------------------------
  
  
CREATE VIEW [dbo].[V_Tbl_Tcp_Count]  
AS  
  
SELECT Today.Fld_SrNo,Today.Fld_Branch_Code,Today.Fld_Server_Id,Today.Fld_Tcp_1015,Today.Fld_Tcp_0115,  
Today.Fld_Tcp_0315,Today.Fld_Sur_Cnt,  
PrevDay_Sur_Cnt=ISNULL(PrevDay.Fld_Sur_Cnt,0),First_Sur_Cnt=ISNULL(FirstDay.Fld_Sur_Cnt,0),  
Today.Fld_Remark,Today.Fld_FldDate,Today.Fld_SysDate,Today.Fld_Flag,Today.Fld_EmpCode,  
UserName=ISNULL(username,''),Person_Name=ISNULL(person_name,'')  
FROM Tbl_Tcp_Count Today WITH (NOLOCK)  
LEFT JOIN Tbl_Tcp_Count FirstDay WITH (NOLOCK)   
 ON Today.Fld_Branch_Code = FirstDay.Fld_Branch_Code AND Today.Fld_Server_Id = FirstDay.Fld_Server_Id  
  AND FirstDay.Fld_FldDate = (SELECT MIN(Fld_FldDate) FROM Tbl_Tcp_Count WITH (NOLOCK)   
             WHERE DATEPART(M,Fld_FldDate) = DATEPART(M,Today.Fld_FldDate)  
             AND DATEPART(YEAR,Fld_FldDate) = DATEPART(YEAR,Today.Fld_FldDate)  
           )  
LEFT JOIN Tbl_Tcp_Count PrevDay WITH (NOLOCK)   
 ON Today.Fld_Branch_Code = PrevDay.Fld_Branch_Code AND Today.Fld_Server_Id = PrevDay.Fld_Server_Id  
  AND PrevDay.Fld_FldDate = (SELECT MAX(Fld_FldDate) FROM Tbl_Tcp_Count WITH (NOLOCK)   
             WHERE Fld_FldDate < CAST(Today.Fld_FldDate AS DATE))  
LEFT OUTER JOIN INTRANET.RISK.dbo.USER_LOGIN B WITH (NOLOCK)   
 ON Today.Fld_EmpCode = username  
  
/*  
SELECT A.*,username,person_name FROM Tbl_Tcp_Count A WITH (NOLOCK)      
LEFT OUTER JOIN INTRANET.RISK.dbo.USER_LOGIN B WITH (NOLOCK) ON Fld_EmpCode = username   
*/

GO

-- --------------------------------------------------
-- VIEW dbo.V_tblComplaint
-- --------------------------------------------------
Create View V_tblComplaint
as 
select Sr_num=max(Sr_num),Complaint_id from tbl_complaint(nolock)
group by Complaint_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_TCP_Mails
-- --------------------------------------------------
CREATE View V_TCP_Mails            
as                  
            
select br_tag,Fld_Branch_Id,emailadd,upper(br_name)+'-['+upper(br_tag) +']'
 as br_name from V_IT_Staff_Rpt_New x where Status = 'A'           
and 
--br_tag not in ('HO','LUDHN','COHIN') 
br_tag in(SELECT DISTINCT fld_branch_Cd FROM Server_manager_Branch_ITdetails)
and exists            
(            
select * from tbl_it_br_master y (nolock) where x.Fld_Branch_id = y.Sr_No and            
y.br_type = 'DATACENTER' and 
--y.br_tag not in ('HO','LUDHN','COHIN')  
y.br_tag in(SELECT DISTINCT fld_branch_Cd FROM Server_manager_Branch_ITdetails)  

)

GO

-- --------------------------------------------------
-- VIEW dbo.V_TCP_Servers
-- --------------------------------------------------
CREATE View V_TCP_Servers                    
as                    
            
/*                    
select * from                    
(                    
select 'A' as S, Fld_id,Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,'' as SBS_IP,'' as Remark from V_Server_Master x where exists                  
(select * from V_Tbl_Manager_Master y where x.Fld_id = y.Fld_id and y.status = 'Active')                  
union all                    
select 'AS' as S, Fld_Sbs_Id,Fld_SBS_Name,Br_Tag,br_Name,Fld_Sbs_ip,Fld_Remark from V_SBS_Master                    
) x */            
            
select * from                    
(                    
select 'A' as S,'A' + convert(varchar,Fld_id) as Fld_id,Fld_id as server_id, Fld_Server,Fld_Branch_cd,upper(Br_Name) as Br_Name,'' as SBS_IP,'' as Remark from V_Server_Master x (nolock) where exists                  
(select * from V_Tbl_Manager_Master y (nolock) where x.Fld_id = y.Fld_id and y.status = 'Active'and x.Fld_Branch_cd <> 'CMBTR' and x.Fld_Branch_cd <> 'KNPR' and x.Fld_Branch_cd <> 'NAGPR')                  
union all                    
select 'AS','AS' + convert(varchar,Fld_SBS_id),Fld_SBS_id,Fld_SBS_Name,Br_Tag,br_Name,Fld_Sbs_ip,Fld_Remark from V_SBS_Master(nolock) where br_tag <> 'vd'                  
) x

GO

-- --------------------------------------------------
-- VIEW dbo.V_TCP_Update
-- --------------------------------------------------
Create View V_TCP_Update
as

select S,Fld_id,Fld_Server,Fld_Branch_cd,
convert(varchar,isnull(Fld_Tcp_1015,'')) Fld_Tcp_1015,
convert(varchar,isnull(Fld_Tcp_0115,'')) Fld_Tcp_0115,
convert(varchar,isnull(Fld_Tcp_0315,'')) Fld_Tcp_0315,
convert(varchar,isnull(Fld_Sur_Cnt,'')) Fld_Sur_Cnt,
convert(varchar,isnull(Fld_Remark,'')) Fld_Remark,
Fld_Flddate from 
(select * from V_TCP_Servers) x
left outer join
(select * from Tbl_Tcp_Count )y
on x.Fld_Branch_cd = y.Fld_Branch_Code and x.Fld_Id = y.Fld_Server_Id

GO

-- --------------------------------------------------
-- VIEW dbo.V_Upload_tbl_ITAssetsData
-- --------------------------------------------------
CREATE view V_Upload_tbl_ITAssetsData          
as          
select Fld_ProductModel,Fld_ProductDesc,Fld_AssetName,Fld_PartNo,Fld_VendorName,Fld_Rate,
Fld_WarrantyFrom,Fld_WarrantyTo,Fld_BranchCode,Fld_AssignToDept,Fld_BillNo,Fld_ChallanNo,Fld_Purpose,
Fld_CapexName,Fld_WarrantyType from tbl_ITAssetsData(nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.V_UPS_Map
-- --------------------------------------------------

CREATE View [dbo].[V_UPS_Map]        
as        
        
SELECT         
a.Fld_srNo,        
b.Fld_Srno as ups_id,        
b.Fld_Brand_Name+' [ '+c.Fld_Model_Name+'-'+Fld_Model_Srno+' ]' as Ups_Name,        
b.Fld_Brand_Name,        
c.Fld_Model_Name,d.Fld_Model_Capacity,        
a.Fld_Model_Srno,        
a.Fld_Battery_Bank,        
a.Fld_Warrenty_From,        
a.Fld_Warrenty_To,        
a.Fld_Status,        
a.Fld_Upd_By,        
a.Fld_Upd_date,    
a.Fld_Battery_Brand,    
a.Fld_Battery_Remark ,fld_activation_status
FROM tbl_UPS_Master a (nolock)        
left outer join        
tbl_UPS_Brand_Master b (nolock) on a.Fld_Brand_id = b.Fld_Srno        
left outer join         
tbl_UPS_Model_Master c (nolock) on a.Fld_Model_id = c.Fld_Srno        
left outer join        
tbl_UPS_Model_Capacity d (nolock) on a.Fld_Model_Capacity_id = d.Fld_Srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_UPS_Map_New
-- --------------------------------------------------

create View [dbo].[V_UPS_Map_New]        
as        
        
SELECT         
a.Fld_srNo,        
b.Fld_Srno as ups_id,        
b.Fld_Brand_Name+' [ '+c.Fld_Model_Name+'-'+Fld_Model_Srno+' ]' as Ups_Name,        
b.Fld_Brand_Name,        
c.Fld_Model_Name,d.Fld_Model_Capacity,        
a.Fld_Model_Srno,        
a.Fld_Battery_Bank,        
a.Fld_Warrenty_From,        
a.Fld_Warrenty_To,        
a.Fld_Status,        
a.Fld_Upd_By,        
a.Fld_Upd_date,    
a.Fld_Battery_Brand,    
a.Fld_Battery_Remark  
FROM tbl_UPS_Master a (nolock)        
left outer join        
tbl_UPS_Brand_Master b (nolock) on a.Fld_Brand_id = b.Fld_Srno        
left outer join         
tbl_UPS_Model_Master c (nolock) on a.Fld_Model_id = c.Fld_Srno        
left outer join        
tbl_UPS_Model_Capacity d (nolock) on a.Fld_Model_Capacity_id = d.Fld_Srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_UPS_Maping
-- --------------------------------------------------
CREATE View [dbo].[V_UPS_Maping]       
as            
            
select * from V_UPS_Map x where not exists            
(            
--select * from tbl_ups_mapping y (nolock)  where x.Fld_SrNo = y.Fld_ups_id and Fld_Flag = 'A'      // commented by harshal 29 Apr 2013      
select * from tbl_ups_mapping_TEST y (nolock)  where   x.Fld_SrNo = y.Fld_ups_id and y.Fld_Flag = 'A'   --and Fld_ups_id='6'         
)  and
 Fld_Activation_Status ='A' --and fld_model_name  like 'PV 6K%'

GO

-- --------------------------------------------------
-- VIEW dbo.V_UPS_Master
-- --------------------------------------------------





  
  
  
  
CREATE View [dbo].V_UPS_Master                                                         
as                                                          
                                                          
SELECT                                          
a.Fld_srNo,                                          
b.Fld_Srno as ups_id,                                          
b.Fld_Brand_Name+'['+ case when c.Fld_Model_Name Is null then '-' else c.Fld_Model_Name END +']' as Ups_Name,                                          
b.Fld_Brand_Name,                                          
c.Fld_Model_Name,d.Fld_Model_Capacity,                                          
a.Fld_Model_Srno,                                          
a.Fld_Battery_Bank,                                          
--convert(varchar(11),a.Fld_Warrenty_From,103) as Fld_Warrenty_From,                                          
--convert(varchar(11),a.Fld_Warrenty_To,103) as  Fld_Warrenty_To,                                          
 a.Fld_Warrenty_From,                                          
 a.Fld_Warrenty_To,                                          
case when a.fld_status = 'A' Then 'AMC' Else 'Warrenty' end as status,                                          
a.Fld_Upd_By,                                          
a.Fld_Upd_date,                                          
e.Fld_SrNo as Ups_Map_Id,                                          
e.Fld_Branch_id,                                          
e.Fld_Ups_id,                                          
e.Fld_Flag,                                                   
e.Fld_app,                                                           
convert(varchar(11),e.Fld_From_date,103) as Fld_From_date,                                                            
e.Fld_Del_remark,                                                          
convert(varchar(11),e.Fld_To_date,103) as  Fld_To_date,                                                           
upper(f.Br_Name) as  Br_Name,                                                        
i.Fld_VendorName,                                                
a.Fld_Appl_To,                                                       
--convert(varchar(11),a.Fld_Bat_WFrom,103) as Fld_Bat_WFrom,                                                         
--convert(varchar(11),a.Fld_Bat_WTo,103) as Fld_Bat_WTo                                                    
a.Fld_Bat_WFrom,                                                         
a.Fld_Bat_WTo ,                                        
--e.Agv_Daily_Load,                                        
--e.Total_TestingTime,                                        
--e.Total_Load_InPer,                                        
e.Remark,                                      
e.ChangedBy,                                    
a.Fld_Activation_Status,                                  
e.Fld_ToDate,                                
e.UpdatedBy as StatusUpdatedBy,                              
e.StatusUpdatedOn as DeactiveDate,                            
f.Br_Tag ,              
a.DeactivatedOn ,            
a.Remark as UserRemark,            
a.UpdatedBy as UserName ,        
e.fld_EntryDate        
FROM tbl_UPS_Master a (nolock)                                                            
left outer join                                                            
tbl_UPS_Brand_Master b (nolock) on a.Fld_Brand_id = b.Fld_Srno                                                            
left outer join                                                             
tbl_UPS_Model_Master c (nolock) on a.Fld_Model_id = c.Fld_Srno                                                            
left outer join                                                            
tbl_UPS_Model_Capacity d (nolock) on a.Fld_Model_Capacity_id = d.Fld_Srno                                                            
left outer join                                                            
tbl_ups_mapping_TEST e (nolock) on a.Fld_SrNO = e.Fld_Ups_Id                                                            
--tbl_ups_mapping e (nolock) on a.Fld_SrNO = e.Fld_Ups_Id                        
left outer join       
Tbl_IT_Br_Master f (nolock) on e.Fld_Branch_id = f.Sr_No                                                            
left outer join                                                    
tbl_Vendor_Master i (nolock) on  a.Fld_Vendor_id = i.Fld_VendorId                              
and Fld_Flag='A'          
Where e.Fld_Flag='A'

GO

-- --------------------------------------------------
-- VIEW dbo.V_UPS_Master_23Feb2013
-- --------------------------------------------------
 
CREATE View [dbo].V_UPS_Master_23Feb2013               
as                
                
SELECT                 
a.Fld_srNo,                
b.Fld_Srno as ups_id,                
b.Fld_Brand_Name+'['+c.Fld_Model_Name+']' as Ups_Name,                
b.Fld_Brand_Name,                
c.Fld_Model_Name,d.Fld_Model_Capacity,                
a.Fld_Model_Srno,                
a.Fld_Battery_Bank,                
--convert(varchar(11),a.Fld_Warrenty_From,103) as Fld_Warrenty_From,                
--convert(varchar(11),a.Fld_Warrenty_To,103) as  Fld_Warrenty_To,           
 a.Fld_Warrenty_From,                
 a.Fld_Warrenty_To,              
case when a.fld_status = 'A' Then 'AMC' Else 'Warrenty' end as status,               
a.Fld_Upd_By,                
a.Fld_Upd_date,                
e.Fld_SrNo as Ups_Map_Id,                
e.Fld_Branch_id,                
e.Fld_Ups_id,                
e.Fld_Flag,       
e.Fld_app,               
convert(varchar(11),e.Fld_From_date,103) as Fld_From_date,                
e.Fld_Del_remark,              
convert(varchar(11),e.Fld_To_date,103) as  Fld_To_date,               
upper(f.Br_Name) as  Br_Name,            
i.Fld_VendorName,    
a.Fld_Appl_To,           
--convert(varchar(11),a.Fld_Bat_WFrom,103) as Fld_Bat_WFrom,             
--convert(varchar(11),a.Fld_Bat_WTo,103) as Fld_Bat_WTo        
a.Fld_Bat_WFrom,             
a.Fld_Bat_WTo              
FROM tbl_UPS_Master a (nolock)                
left outer join                
tbl_UPS_Brand_Master b (nolock) on a.Fld_Brand_id = b.Fld_Srno                
left outer join                 
tbl_UPS_Model_Master c (nolock) on a.Fld_Model_id = c.Fld_Srno                
left outer join                
tbl_UPS_Model_Capacity d (nolock) on a.Fld_Model_Capacity_id = d.Fld_Srno                
left outer join                
tbl_ups_mapping e (nolock) on a.Fld_SrNO = e.Fld_Ups_Id                
left outer join                
Tbl_IT_Br_Master f (nolock) on e.Fld_Branch_id = f.Sr_No                
left outer join            
tbl_Vendor_Master i (nolock) on  a.Fld_Vendor_id = i.Fld_VendorId       
and Fld_Flag='A'

GO

-- --------------------------------------------------
-- VIEW dbo.V_UPS_Report
-- --------------------------------------------------

CREATE View [dbo].[V_UPS_Report]  
as  
  
select Sr_No,upper(Br_Name) as br_Name,br_tag from Tbl_IT_Br_Master x(nolock) where exists  
(select * from tbl_ups_mapping y (nolock) where x.Sr_No = y.Fld_Branch_Id and Fld_App = 'U' and  fld_flag='A')  and Br_Status='A'

GO

-- --------------------------------------------------
-- VIEW dbo.V_User_Category_New
-- --------------------------------------------------

CREATE  view [dbo].[V_User_Category_New]      
as      
select x.username,x.usertype,x.access_to,x.access_code,cat_name from [196.1.115.132].rolemgm.dbo.user_login x (nolock),      
[INTRANET].rolemgm.dbo.menu_cat y  where x.cat_code = y.cat_code

GO

-- --------------------------------------------------
-- VIEW dbo.v_user_inbox
-- --------------------------------------------------
CREATE view  v_user_inbox                
as                
select a.*,b.fld_query,c.subject as sub from                
(select sr_num,complaint_id,dept_id,query_type,subject,convert(varchar(12),solution_date,103) as solution_date,          
status=case when status in ('IP','F') then 'In Process'
when status = 'C' then 'CSO Completed'                    
when status = 'H' then 'Hold'                    
when status = 'BC' then 'Completed'                          
when status = 'P' then 'Pending'    end  ,access_code,fld_entryby from tbl_complaint(nolock)where status<>'F')a                
left outer join                
(select * from query_type(nolock))b                
on a.query_type=b.fld_srno                
left outer join                
(select * from tbl_subject(nolock))c                
on a.subject=c.srno

GO

-- --------------------------------------------------
-- VIEW dbo.V_User_Mapping
-- --------------------------------------------------
Create View V_User_Mapping
as

select x.Fld_SrNo,Fld_Request,y.Fld_EmpCode from
(select * from tbl_request_master (nolock)) x
inner join
(select * from tbl_request_master_mapping (nolock)) y
on x.Fld_SrNo = y.Fld_SrNo

GO

-- --------------------------------------------------
-- VIEW dbo.V_User_Mapping_new
-- --------------------------------------------------
Create View V_User_Mapping_new  
as  
  
select x.fldsubcatid,fldsubcatname,y.Fld_EmpCode from  
(select * from tbl_hr_subcatmaster (nolock)) x  
inner join  
(select * from tbl_request_master_mapping (nolock)) y  
on x.fldsubcatid = y.Fld_SrNo

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wan_data
-- --------------------------------------------------
CREATE View V_Wan_data              
as              
          
select x.*,upper(y.Br_name) as Br_name ,y.Br_Tag from          
(          
select Fld_Id,Fld_Link,              
category,Fld_Chk_Id,Fld_Entry_Date,              
Fld_Provider,Fld_BandWitdh,Fld_Purpose,Fld_CSO,Fld_Branch ,ActiveStatus,InactiveDate    
from V_Wan_Link_Data where 
--Fld_Status  = 'U' AND isnumeric(Fld_Branch) = 1        
isnumeric(Fld_Branch) = 1        
) x          
left outer join          
(select * from tbl_it_br_master (nolock)) y on x.Fld_branch = y.Sr_No

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wan_Link_Data
-- --------------------------------------------------
CREATE View V_Wan_Link_Data    
AS        
SELECT         
FLD_ID,FLD_PURPOSE,FLD_CHK_ID,FLD_CSO,FLD_BRANCH,FLD_ENTRY_BY,FLD_ENTRY_DATE,FLD_STATUS,FLD_TYPE,        
B.CATEGORY,C.FLD_PROVIDER,D.FLD_BANDWITDH,A.ACTIVESTATUS,A.INACTIVEDATE,  
CASE         
WHEN FLD_LINK = 'P' THEN 'PRIMARY LINK'         
WHEN FLD_LINK = 'B' THEN 'BACKUP LINK'
WHEN FLD_LINK = 'M' THEN 'MULTIPLE LINK' END AS FLD_LINK        
FROM TBL_IT_WANLINK_DATA A (NOLOCK)         
LEFT OUTER JOIN CAT_MAST B (NOLOCK) ON A.FLD_CONNECTIVITY_TYPE = B.SR_NO        
LEFT OUTER JOIN TBL_PROVIDER C (NOLOCK) ON A.FLD_PROVIDER = C.FLD_SRNO        
LEFT OUTER JOIN TBL_BANDWIDTH D (NOLOCK) ON A.FLD_BANDWIDTH = D.FLD_SRNO

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wan_Link_Data_12Mar2013
-- --------------------------------------------------
    
CREATE View V_Wan_Link_Data_12Mar2013    
as    
    
select     
Fld_Id,Fld_Purpose,Fld_Chk_Id,Fld_CSO,Fld_Branch,Fld_Entry_By,Fld_Entry_Date,Fld_Status,Fld_Type,    
b.Fld_Connectivity,c.Fld_provider,d.Fld_Bandwitdh,    
case     
when Fld_link = 'P' then 'Primary Link'     
when Fld_link = 'B' then 'Backup Link' end as Fld_Link    
from Tbl_IT_Wanlink_Data a (nolock)     
left outer join tbl_wan_connectivity b (nolock) on a.Fld_Connectivity_Type = b.Fld_SrNo    
left outer join Tbl_Provider c (nolock) on a.Fld_provider = c.Fld_SrNo    
left outer join Tbl_Bandwidth d (nolock) on a.Fld_bandwidth = d.Fld_SrNo

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wan_NotUpdated
-- --------------------------------------------------
CREATE VIEW V_Wan_NotUpdated
AS
SELECT a.*,b.Fld_DOST FROM Tbl_IT_Wanlink_Data a 
inner join  Tbl_IT_Wanlink_Update_Data b on a.Fld_Id=b.Fld_Id

GO

-- --------------------------------------------------
-- VIEW dbo.V_WAN_RPT
-- --------------------------------------------------
CREATE View V_WAN_RPT      
as      
      
select x.*,convert(varchar(11),y.fld_fetch_date,103) as Fetch_Date,      
y.Fld_Status,      
replace(convert(varchar(11),y.Fld_DOFT,103),'01/01/1900','') as Fld_DOFT ,      
y.First_Testby,y.Fld_First_Remark ,y.Fld_DOST ,      
y.Second_TestBy,y.Fld_Second_Remark      
 from      
(select * from V_Wan_data (nolock))x      
inner join      
(    
select x.*,y.person_name as First_Testby,z.Person_name as Second_TestBy  from      
(      
select * from Tbl_IT_Wanlink_Update_Data (nolock)      
union all      
select * from Tbl_IT_Wanlink_Update_Data_history (nolock)      
) x left outer join intranet.risk.dbo.user_login y       
on x.Fld_First_Testby = y.username left outer join intranet.risk.dbo.user_login z      
on x.Fld_SEmpcode = z.username)y      
on x.fld_id = y.Fld_id

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wrong_Downtime
-- --------------------------------------------------






CREATE View [dbo].[V_Wrong_Downtime]

as  

SELECT  Fld_Downtime FROM mis.upload.dbo.IT_Events with(nolock)
WHERE  PATINDEX('%[^0-9]%',Fld_Downtime) > 0

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wrong_Entry
-- --------------------------------------------------
CREATE View V_Wrong_Entry  
as  
  
select distinct Fld_server from   
(  
select x.Fld_Server,Fld_id from  
(      
select  convert(datetime,Fld_Date,103) as Dt,Fld_Server,Fld_Time_From,Fld_Time_To,Fld_Events,              
replace(Fld_Solution,'&','and') as Fld_Solution,Fld_Problem,Fld_Segment,isnull(Fld_Downtime,0) as Fld_Downtime      
from mis.upload.dbo.IT_Events            
) x      
left outer join         
(select * from Tbl_Server_Master)  y      
on x.Fld_Server = y.Fld_Server    
) x where Fld_Id is  null

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wrong_Problems
-- --------------------------------------------------



CREATE View [dbo].[V_Wrong_Problems] 
as  
 
  Select  distinct Fld_Problem  from mis.upload.dbo.IT_Events with(nolock)           
	    where fld_problem Not IN(   
         Select Issues from Tbl_ThresHoldCSO_Master with(nolock) 
         where Status='A')

GO

-- --------------------------------------------------
-- VIEW dbo.V_Wrong_Segments
-- --------------------------------------------------





CREATE View [dbo].[V_Wrong_Segments] 
as  

		Select  distinct Fld_Segment  from mis.upload.dbo.IT_Events with(nolock)           
	    where Fld_Segment Not IN(   
								 Select Segment_Name from tbl_Exchange_Master with(nolock) 
								)

GO

-- --------------------------------------------------
-- VIEW dbo.vw_complaint10Nov
-- --------------------------------------------------
create view vw_complaint10Nov
as
select * from tbl_complaint
where convert(varchar(11),Complaint_Date,103)='10/11/2010'

GO

-- --------------------------------------------------
-- VIEW dbo.VW_OPEX_CLIENT_IP
-- --------------------------------------------------
CREATE VIEW VW_OPEX_CLIENT_IP
AS
	SELECT DISTINCT B.SUB_bROKER,A.*,c.ip FROM
	(select party_Code,Server from intranet.mis.dbo.ctcl_vsat_79 where status='A') A, intranet.mis.dbo.Server_IP_Mapping C,
	intranet.RISK.DBO.CLIENT_deTAILS B WHERE A.PARTY_cODE=B.PARTY_CODE and a.server=c.server

GO

-- --------------------------------------------------
-- VIEW dbo.vw_Opex_ManagerId
-- --------------------------------------------------
create view vw_Opex_ManagerId
as
select 
a.Fld_Branch_cd,
a.Br_name,
a.Fld_Manager_id,
a.Fld_segment,
a.sdate as From_date,
a.tdate as To_date,
a.Manager_status,
b.fld_odin_ip,
b.fld_db_ip
from V_Manager_Details  a , tbl_server_master b (nolock) where a.fld_id=b.fld_id

GO

-- --------------------------------------------------
-- TABLE E07657.HR_MASTER_NEW
-- --------------------------------------------------
CREATE TABLE [E07657].[HR_MASTER_NEW]
(
    [Category] VARCHAR(255) NULL,
    [Subcategory] VARCHAR(255) NULL,
    [Subject] VARCHAR(255) NULL,
    [Solution] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- VIEW E07657.V_abc
-- --------------------------------------------------
create view V_abc as
select fldsubjectid,fldsolutionid from tbl_HR_SubjectSolution

GO

