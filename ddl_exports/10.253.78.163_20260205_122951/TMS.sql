-- DDL Export
-- Server: 10.253.78.163
-- Database: TMS
-- Exported: 2026-02-05T12:32:32.745419

USE TMS;
GO

-- --------------------------------------------------
-- FOREIGN_KEY dbo.Solution_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Solution_Master] ADD CONSTRAINT [FK_Solution_Master_Module_Master] FOREIGN KEY ([Module_ID]) REFERENCES [dbo].[Module_Master_OLD] ([Module_Code])

GO

-- --------------------------------------------------
-- FUNCTION dbo.checkEmp
-- --------------------------------------------------


Create FUNCTION [dbo].[checkEmp]
(@Emp varchar(20),@DT datetime)
RETURNS bit  

As
Begin
Declare @result bit
if exists (Select * from Task_master Where Assigned_To=@Emp And(convert(varchar,AS_SDT,103)=convert(varchar,@DT,103) Or convert(varchar,AS_EDT,103)=convert(varchar,@DT,103)))
	Set @result=1
else Set @result=0
Return @result 
End



--
--Select dbo.checkEmp('E19642',getdate())

GO

-- --------------------------------------------------
-- FUNCTION dbo.CurrSchedule
-- --------------------------------------------------
CREATE FUNCTION [dbo].[CurrSchedule]
(
	@EMP_ID VARCHAR(10),
	@DATE varchar(25)
)
RETURNS VARCHAR(25)
AS
BEGIN
	DECLARE @RETURN VARCHAR(25);
	BEGIN
		IF EXISTS(SELECT AS_DT FROM TASK_MASTER WHERE ASSIGNED_TO = @EMP_ID AND 
					AS_DT < DATEADD(d,1,CONVERT(DATETIME,@DATE ,103)) and AS_EDT > CONVERT(DATETIME, @DATE,103) )
		SET @RETURN = @DATE
		ELSE
		SET @RETURN = NULL
	END
RETURN @RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CurrSchedule1
-- --------------------------------------------------

Create FUNCTION [dbo].[CurrSchedule1]
(
@EMP_ID VARCHAR(10),
@DATE varchar(25)
)
RETURNS VARCHAR(25)
AS
BEGIN
	DECLARE @RETURN VARCHAR(25);
	BEGIN

		IF EXISTS(SELECT AS_DT FROM TASK_MASTER WHERE ASSIGNED_TO = @EMP_ID AND 
					convert(varchar(10),AS_DT,103) <= @DATE AND convert(varchar(10),AS_EDT,103) >= @DATE)
		SET @RETURN = @DATE
		ELSE
		SET @RETURN = NULL
	END
RETURN @RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GenerateID
-- --------------------------------------------------






CREATE FUNCTION [dbo].[GenerateID]
(@Option char(5),@Request_ID char(20))
RETURNS Char(20)  

As
Begin
Declare @ID Char(20)

	if(@Option ='1')---Id for change_Request Master
	Begin
		If Exists (Select top 1 * from Change_Request_Master)
		Begin
			If((Select ISNULL(MAX(Change_ID),0) from Change_Request_Master where dbo.LPAD(Convert(Char,left(Change_ID,4)),4,'')=@Request_ID) < 1)
			Begin
				Set @ID=(rtrim(Convert(Char,@Request_ID))+ rtrim(Convert(Char,'1001')))
			End
			Else
			Begin
				Select @ID=MAX(Change_ID) from Change_Request_Master where dbo.LPAD(Convert(Char,left(Change_ID,4)),4,'')=@Request_ID
				Set @ID=(Convert(Char,(Convert(Int,@ID)+1)))
			End
		end
		else 
		Begin
			Set @ID=(rtrim(Convert(Char,@Request_ID))+ rtrim(Convert(Char,'1001')))
		End					
	End
	Else if (@Option ='2')--------Id For Project_master
	Begin
		if Exists (Select top 1 * from Project_master)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(Project_ID)+1),6,'0') from Project_master
		Else
			Set @ID='000001'
	End
	Else if (@Option ='3')--------Id For Module_master
	Begin
		if Exists (Select * from Module_Master)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(Module_ID)+1),6,'0') from Module_master
		Else
			Set @ID='000001'
	End
	Else if (@Option ='4')--------Id For Task_master
	Begin
		if Exists (Select * from Task_master)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(Task_ID)+1),8,'0') from Task_master
		Else
			Set @ID='00000001'
	End
	Else if (@Option ='5')--------Id For Issue_Master
	Begin
		if Exists (Select * from Issue_Master)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(Issue_ID)+1),6,'0') from Issue_Master
		Else
			Set @ID='100001'
	End

	Else if(@Option ='6')---Token Number for Testing Request
	Begin
		If exists (Select top 1 * from tbl_Testing_Requests)
		Begin
			If((Select ISNULL(MAX (Token_Number),0) from tbl_Testing_Requests where dbo.LPAD(Convert(Char,left(Token_Number,6)),6,'')=@Request_ID) < 1)

			Begin
				Set @ID=(rtrim(Convert(Char,@Request_ID))+ rtrim(Convert(Char,'1001')))
			End
			Else
			Begin
				Select @ID=MAX(Token_Number) from tbl_Testing_Requests where dbo.LPAD(Convert(Char,left(Token_Number,6)),6,'')=@Request_ID
				Set @ID= dbo.Lpad(convert(NVARCHAR,max(@ID)+1),10,'0')
			End
		end
		else 
		Begin
			Set @ID=(rtrim(Convert(Char,@Request_ID))+ rtrim(Convert(Char,'1001')))
		End					
	End
	Else if (@Option ='7')--------Id For Login_Check
	Begin
		if Exists (Select top 1 ID from Login_Check)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(ID)+1),10,'0') from Login_Check
		Else
			Set @ID='0000000001'
	End
	Else if (@Option ='8')--------Id For Login_Check
	Begin
		if Exists (Select top 1 ID from Login_Check_New)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(ID)+1),10,'0') from Login_Check_New
		Else
			Set @ID='0000000001'
	End
	Else if (@Option ='9')--------Id For Module_master
	Begin
		if Exists (Select * from tbl_ProjectDefectMAster)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(Defect_Code)+1),4,'0') from tbl_ProjectDefectMAster
		Else
			Set @ID='1000'
	End	
		Else if (@Option ='10')--------Id For Project_master_Details
	Begin
		if Exists (Select * from Project_master_Details)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(PID)+1),8,'0') from Project_master_Details
		Else
			Set @ID='00000001'
	End
	
	Else if (@Option ='11')--------Id For Project Defect Details
	Begin
		if Exists (Select * from tbl_ProjectDefect)
			Select @ID = dbo.Lpad(convert(NVARCHAR,max(ID)+1),5,'0') from tbl_ProjectDefect
		Else
			Set @ID='00001'
	End
	Else if (@Option ='12')--------Id For Testing Request Details
	Begin
		if Exists (Select * from tbl_Testing_RequestsDetails)
			Select @ID = dbo.Lpad(convert(NVARCHAR,max(Token_Detail_ID)+1),4,'0') from  tbl_Testing_RequestsDetails
		Else
			Set @ID='0001'
	End
	Else if (@Option ='13')--------Id For Project_master
	Begin
		if Exists (Select top 1 * from Tbl_Feedback)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(FB_ID)+1),6,'0') from Tbl_Feedback
		Else
			Set @ID='000001'
	End
	Else if (@Option ='15')--------Id For tbl_DBA_request
	Begin
		if Exists (Select * from dbo.Tbl_DBA_Request)
			Select @ID=dbo.Lpad(convert(NVARCHAR,max(DBA_ID)+1),9,'0') from dbo.Tbl_DBA_Request
		Else
			Set @ID='000000001'
	End

	Return @ID 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetDays
-- --------------------------------------------------

Create FUNCTION [dbo].[GetDays]
(@Start datetime, 
@Stop datetime)  

RETURNS TABLE AS RETURN  
WITH Numbers (N) AS 
(  
SELECT 1 UNION ALL  
SELECT 1 + N FROM Numbers  
WHERE N < DATEDIFF(day,@Start,@Stop)+1  
)  
SELECT DATEADD(day,N-1,@Start) Date FROM Numbers

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetHarmonyDays
-- --------------------------------------------------



Create FUNCTION [dbo].[GetHarmonyDays]  
(  
	@Emp Char(10),
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
	 
    RETURN  
    ( 
        Select Count(TDate) AS HCount From [196.1.115.239].Harmony.DBO.tbl_Attendance
		Where Emp_No=@Emp And PresAbs='P'
		And (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
				Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
				And
				CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate)+1,113)))
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetHarmonyHours
-- --------------------------------------------------



CREATE FUNCTION [dbo].[GetHarmonyHours]  
(  
	@Emp Char(10),
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
	Declare @Temp1 As Int
	Declare @Temp2 As Int

	
    RETURN  
    ( 
		Select ((SUM(T1) * 8) + (SUM(T2) * 5)) As THours
		From
		(
			Select (Case When UPPER(Datename(WEEKDAY,TDate))<>UPPER('Saturday') Then Count(Tdate) End) As T1,
				(Case When UPPER(Datename(WEEKDAY,TDate))=UPPER('Saturday') Then Count(Tdate) End) As T2
			From [196.1.115.239].Harmony.DBO.tbl_Attendance with (nolock)
			Where Emp_No=@Emp And PresAbs='P'
					And (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
							Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
							And
							CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate)+1,113)))
			group By TDATE
		)T
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetHarmonyWorkingDays
-- --------------------------------------------------


	

CREATE FUNCTION [dbo].[GetHarmonyWorkingDays]  
(  
	@Emp Char(10),
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
	 
    RETURN  
    ( 
		Select Count(HCOUNT) From
		(
			Select distinct TDATE AS HCount From [196.1.115.239].Harmony.DBO.tbl_Attendance
			Where (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
							Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
							And
							CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate)+1,113)))
				And presabs <>'' And (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113)) not in (
			 Select distinct TDATE From [196.1.115.239].Harmony.DBO.tbl_Attendance
                  Where (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
                              Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
                              And CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate),113)))
					And (presabs in ('HL')
					or (presabs in ('WO')
					and datename(weekday,TDate)='Sunday'))))
		) T
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetHarmonyWorkingHours
-- --------------------------------------------------






CREATE FUNCTION [dbo].[GetHarmonyWorkingHours]  
(  
	@Emp Char(10),
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
	Declare @Temp1 As Int
	Declare @Temp2 As Int

	
    RETURN  
    ( 
		Select ((SUM(T1) * 8) + (SUM(T2) * 5)) As THours
		From
		(
			Select (Case When UPPER(Datename(WEEKDAY,TDate))<>UPPER('Saturday') Then Count(Tdate) Else '0' End) As T1,
				(Case When UPPER(Datename(WEEKDAY,TDate))=UPPER('Saturday') Then Count(Tdate) Else '0' End) As T2
			From
			(
				Select distinct TDATE  From [196.1.115.239].Harmony.DBO.tbl_Attendance
				Where (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
								Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
								And
								CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate)+1,113)))
					And presabs <>'' And (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113)) not in (
				 Select distinct TDATE From [196.1.115.239].Harmony.DBO.tbl_Attendance
					  Where (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
								  Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
								  And CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate),113)))
						And (presabs in ('HL')
						or (presabs in ('WO')
						and datename(weekday,TDate)='Sunday'))))
				
			) T
			Group By Tdate
		)T
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetSaturdayDays
-- --------------------------------------------------
CREATE FUNCTION [dbo].[GetSaturdayDays]  
(  
    @StartDate Datetime,  
    @EndDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
  
--    RETURN  
--    ( 
--        Select DateDIff(DAY,Cast('10/1/2010 12:00:00 AM' As Datetime),Cast('10/31/2010 12:00:00 AM' As Datetime)+1)
--    ); 

    RETURN  
    ( 
		SELECT  COUNT(*) AS 'NumberOfSundays' 
		FROM    
		( 			
			SELECT TOP ( DATEDIFF(DAY,@StartDate,@EndDate) + 1 )                    
				[Date] = DATEADD ( DAY,ROW_NUMBER() OVER(ORDER BY VAL.name) ,DATEADD( DD,-1,@StartDate )) 			
			FROM [master].[dbo].[spt_values] VAL 		 
		)  A 
		WHERE  DATEPART(dw,[Date]) = 7
	);
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetTeamHarmonyHours
-- --------------------------------------------------




CREATE FUNCTION [dbo].[GetTeamHarmonyHours]
(  
	@Emp Char(10),
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
	Declare @Temp1 As Int
	Declare @Temp2 As Int

	
    RETURN  
    ( 
		Select ((SUM(T1) * 8) + (SUM(T2) * 5)) As THours
		From
		(
			Select (Case When UPPER(Datename(WEEKDAY,TDate))<>UPPER('Saturday') Then Count(Tdate) End) As T1,
				(Case When UPPER(Datename(WEEKDAY,TDate))=UPPER('Saturday') Then Count(Tdate) End) As T2
			From [196.1.115.239].Harmony.DBO.tbl_Attendance with (nolock)
			Where PresAbs='P'
					And (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
							Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
							And
							CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate)+1,113)))

			And Emp_No in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp And Active_Status=1)
			group By TDATE
		)T
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetTotalWorkingDays
-- --------------------------------------------------



CREATE FUNCTION [dbo].[GetTotalWorkingDays]  
(  
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
	 
    RETURN  
    ( 
        Select Count(Distinct TDate) As TW From [196.1.115.239].Harmony.DBO.tbl_Attendance
		Where PresAbs='P' And PresAbs not in ('HL','WO')
		And (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
				Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
				And
				CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate)+1,113)))
			And UPPER(Datename(WEEKDAY,TDate))<>'SUNDAY'
       
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetTotalWorkingHours
-- --------------------------------------------------




Create FUNCTION [dbo].[GetTotalWorkingHours]  
(  
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
	 
    RETURN  
    ( 
		Select ((T1 * 8 ) + (T2 * 5)) As [TWH] 
		From
		(
			Select (Case When UPPER(Datename(WEEKDAY,TDate))<>UPPER('Saturday') Then Count(Tdate) Else '0' End) As T1,
				(Case When UPPER(Datename(WEEKDAY,TDate))=UPPER('Saturday') Then Count(Tdate) Else '0' End) As T2
			From
			(
				Select distinct TDATE From [196.1.115.239].Harmony.DBO.tbl_Attendance
				Where (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
								Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
								And
								CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate)+1,113)))
					And presabs <>'' And 
				(CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113)) not in (
					Select distinct TDATE From [196.1.115.239].Harmony.DBO.tbl_Attendance
					Where (CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,TDate),113))
							  Between CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@startDate),113))
							  And CONVERT(Datetime,CONVERT(Varchar(12),CONVERT(Datetime,@endDate),113)))
						And (presabs in ('HL')
						or (presabs in ('WO')
					and datename(weekday,TDate)='Sunday'))))
			) T
			Group BY Tdate
		) T 
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GetWorkingDays
-- --------------------------------------------------


CREATE FUNCTION [dbo].[GetWorkingDays]  
(  
    @startDate Datetime,  
    @endDate Datetime  
) 
RETURNS INT  
AS  
BEGIN 
    DECLARE @range INT; 
 
    SET @range = DATEDIFF(DAY, @startDate, @endDate)+1; 
 
    RETURN  
    ( 
        SELECT  
            @range / 7 * 5 + @range % 7 -  
            ( 
                SELECT COUNT(*)  
            FROM 
                ( 
                    SELECT 1 AS d 
                    UNION ALL SELECT 2  
                    UNION ALL SELECT 3  
                    UNION ALL SELECT 4  
                    UNION ALL SELECT 5  
                    UNION ALL SELECT 6  
                    UNION ALL SELECT 7 
                ) weekdays 
                WHERE d <= @range % 7  
                AND DATENAME(WEEKDAY, @endDate - d + 1)  
                IN 
                ( 
					'Saturday', 
                    'Sunday' 
                ) 
            ) 
    ); 
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.LPAD
-- --------------------------------------------------

CREATE Function [dbo].[LPAD] 
	(@SourceString CHAR(20), @FinalLength INT, @PadChar CHAR(1)) 

RETURNS CHAR(20) 

AS 

BEGIN 

	RETURN (SELECT Replicate(@PadChar,@FinalLength - Len(@SourceString)) + @SourceString) 

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.UFUNC_Project_Status
-- --------------------------------------------------



Create Function [dbo].[UFUNC_Project_Status]

(@PID As Char(20))
Returns Char(20)

As 
Begin
	
	Declare @Status As INT

	Select @Status=Sum(Status)
		From
		(
			Select PhaseID,PhaseName,SUM([Status %]) As Status
			From
			(
				Select Phase_Master.Phase_ID As PhaseID,Phase_master.Phase_Name As PhaseName,Module_name,	
						[Status %] = ISNULL(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @PID)),2),0)) End, 0)
				from Module_Master
						inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
						inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
 						inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
						inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
						join Phase_master on Project_Details.Phase_ID=Phase_Master.Phase_ID
 				Where Project_Details.Project_ID = @PID  
					Group by Phase_Master.Phase_ID,Phase_master.Phase_Name,Module_Name,Task_Master.Status_ID
			) T 
			Group By PhaseID, PhaseName

			Union

			Select P.Phase_ID As PhaseID, P.Phase_Name As PhaseName,'0' As Status
			From Phase_Master P
			Where P.Phase_ID not in 
			(
				Select PhaseID
				From
				(
					Select Phase_Master.Phase_ID As PhaseID,Phase_master.Phase_Name As PhaseName,Module_name,	
							[Status %] = ISNULL(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @PID)),2),0)) End, 0)
					from Module_Master
							inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
							inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
 							inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
							inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
							join Phase_master on Project_Details.Phase_ID=Phase_Master.Phase_ID
 					Where Project_Details.Project_ID = @PID     
						Group by Phase_Master.Phase_ID,Phase_master.Phase_Name,Module_Name,Task_Master.Status_ID
				) T 
				Group by PhaseID,PhaseName
			)	
		) Temp 

	Return @Status

End

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Request_Status_ID] ON [dbo].[Change_Request_Master] ([Request_Status_ID]) INCLUDE ([Change_ID], [Request_ID], [Project_ID], [Phase_ID], [Module_ID], [Changed_BY], [Changed_Date], [Change_Type], [Reason], [Other_Reason], [Priority_ID], [Expected_EDate], [Description], [Attachment], [HOD_Approve], [HOD_Approve_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Admin_Approve] ON [dbo].[Change_Request_Master] ([Admin_Approve])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Changed_BY] ON [dbo].[Change_Request_Master] ([Changed_BY])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Expected_EDate] ON [dbo].[Change_Request_Master] ([Expected_EDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_HOD_Approve] ON [dbo].[Change_Request_Master] ([HOD_Approve])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Module_ID] ON [dbo].[Change_Request_Master] ([Module_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Phase_ID] ON [dbo].[Change_Request_Master] ([Phase_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_PM_EDate] ON [dbo].[Change_Request_Master] ([PM_EDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_PM_SDate] ON [dbo].[Change_Request_Master] ([PM_SDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Project_ID] ON [dbo].[Change_Request_Master] ([Project_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Request_ID] ON [dbo].[Change_Request_Master] ([Request_ID]) INCLUDE ([Request_Status_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Change_Request_Master_Request_Status_ID] ON [dbo].[Change_Request_Master] ([Request_Status_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Change_Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Changed_BY] ON [dbo].[Change_Request_Master] ([Changed_BY]) INCLUDE ([Request_Status_ID], [Project_ID], [PM_EDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Client_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Department] ON [dbo].[Client_Master] ([Department])

GO

-- --------------------------------------------------
-- INDEX dbo.Client_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_EMP_ID] ON [dbo].[Client_Master] ([Emp_ID]) INCLUDE ([Role_ID], [EMP_NAME], [Department])

GO

-- --------------------------------------------------
-- INDEX dbo.Client_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_HOD] ON [dbo].[Client_Master] ([HOD]) INCLUDE ([Emp_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Client_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_ROLE_ID] ON [dbo].[Client_Master] ([Role_ID]) INCLUDE ([EMP_NAME], [Emp_ID], [Department])

GO

-- --------------------------------------------------
-- INDEX dbo.Coordinator_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Employee_ID] ON [dbo].[Coordinator_Master] ([Employee_ID], [Request_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Coordinator_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Coordinator_Master_Employee_ID_Project_ID_Role_ID] ON [dbo].[Coordinator_Master] ([Employee_ID], [Project_ID], [Role_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Delegation_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_RequestID] ON [dbo].[Delegation_Master] ([RequestID], [DelegateBy])

GO

-- --------------------------------------------------
-- INDEX dbo.Login_Check
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_ID] ON [dbo].[Login_Check] ([ID], [Emp_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Login_Check_New
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_ID] ON [dbo].[Login_Check_New] ([ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Module_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Module_ID] ON [dbo].[Module_Master] ([Module_ID]) INCLUDE ([Module_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.Phase_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Phase_ID] ON [dbo].[Phase_Master] ([Phase_ID], [Phase_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Details
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Phase_ID] ON [dbo].[Project_Details] ([Project_ID], [Phase_ID], [Module_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Project_Master_AS_EDate] ON [dbo].[Project_Master] ([AS_EDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Project_Master_AS_SDate] ON [dbo].[Project_Master] ([AS_SDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Project_Master_Project_Leader] ON [dbo].[Project_Master] ([Project_Leader])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Project_Master_Project_Manager] ON [dbo].[Project_Master] ([Project_Manager]) INCLUDE ([Project_ID], [Project_Name], [AS_EDate], [Reschedule])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Project_Master_Request_ID] ON [dbo].[Project_Master] ([Request_ID]) INCLUDE ([Project_Name], [Project_Leader], [AS_EDate], [Project_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Project_Master_Status] ON [dbo].[Project_Master] ([Status])

GO

-- --------------------------------------------------
-- INDEX dbo.Project_Status_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Request_ID] ON [dbo].[Project_Status_Master] ([Request_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Request_Master_Admin_Approve] ON [dbo].[Request_Master] ([Admin_Approve])

GO

-- --------------------------------------------------
-- INDEX dbo.Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Request_Master_Expected_EDate] ON [dbo].[Request_Master] ([Expected_EDate])

GO

-- --------------------------------------------------
-- INDEX dbo.Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Request_Master_HOD_Approve] ON [dbo].[Request_Master] ([HOD_Approve])

GO

-- --------------------------------------------------
-- INDEX dbo.Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Request_Master_Request_Date] ON [dbo].[Request_Master] ([Request_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Request_Master_Request_Status_ID] ON [dbo].[Request_Master] ([Request_Status_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Request_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Request_Master_Requested_BY] ON [dbo].[Request_Master] ([Requested_BY])

GO

-- --------------------------------------------------
-- INDEX dbo.Request_Status_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Request_Status_ID] ON [dbo].[Request_Status_Master] ([Request_Status_ID], [Request_Status_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Task_Master_AC_EDT] ON [dbo].[Task_Master] ([AC_EDT])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Task_Master_AC_SDT] ON [dbo].[Task_Master] ([AC_SDT])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Task_Master_AS_EDT] ON [dbo].[Task_Master] ([AS_EDT])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Task_Master_AS_SDT] ON [dbo].[Task_Master] ([AS_SDT])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Task_Master_Assigned_By] ON [dbo].[Task_Master] ([Assigned_By]) INCLUDE ([Change_ID], [Status_ID], [Assigned_To], [Task_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Task_Master_Assigned_TO] ON [dbo].[Task_Master] ([Assigned_To]) INCLUDE ([Task_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NCLIX_Task_Master_Status_ID] ON [dbo].[Task_Master] ([Status_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Task_Status_Master
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Phase_ID] ON [dbo].[Task_Status_Master] ([Task_Status_ID]) INCLUDE ([Task_Status_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_DBA_Request
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_DBA_ID] ON [dbo].[Tbl_DBA_Request] ([DBA_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_DBA_Request
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Project_ID] ON [dbo].[Tbl_DBA_Request] ([Project_ID], [Phase_ID], [Module_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_Feedback
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_FB_ID] ON [dbo].[Tbl_Feedback] ([FB_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_Project_Phase_Status
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Project_ID] ON [dbo].[Tbl_Project_Phase_Status] ([Project_ID]) INCLUDE ([Request_ID], [Phase_ID], [SDate], [EDate], [Last_Updated_By], [Last_Updated_On], [Status])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Testing_Requests
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Phase_ID] ON [dbo].[tbl_Testing_Requests] ([Project_Id], [Token_Number], [Status])

GO

-- --------------------------------------------------
-- INDEX dbo.tbl_Testing_Requests
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_Token_Number] ON [dbo].[tbl_Testing_Requests] ([Token_Number])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Change_Request_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Change_Request_Details] ADD CONSTRAINT [PK_Change_Request_Details] PRIMARY KEY ([CRD_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Change_Request_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Change_Request_Master] ADD CONSTRAINT [PK_Change_Request_Master_1] PRIMARY KEY ([Change_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Change_Request_Master_Old
-- --------------------------------------------------
ALTER TABLE [dbo].[Change_Request_Master_Old] ADD CONSTRAINT [PK_Change_Request_Master] PRIMARY KEY ([Change_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Delegation_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Delegation_Master] ADD CONSTRAINT [PK_Delegation_Master] PRIMARY KEY ([DelegateID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Issue_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Issue_Details] ADD CONSTRAINT [PK_Issue_Details] PRIMARY KEY ([Issue_Detail_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Issue_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Issue_Master] ADD CONSTRAINT [PK_Issues_Master] PRIMARY KEY ([Issue_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Module_Master_OLD
-- --------------------------------------------------
ALTER TABLE [dbo].[Module_Master_OLD] ADD CONSTRAINT [PK_Module_Master] PRIMARY KEY ([Module_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.PRMS_UserMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[PRMS_UserMaster] ADD CONSTRAINT [PK_PRMS_UserMaster] PRIMARY KEY ([Emp_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Project_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Project_Master] ADD CONSTRAINT [PK_Project_Master] PRIMARY KEY ([Project_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Project_Master_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Project_Master_Details] ADD CONSTRAINT [PK_Project_Master_Details] PRIMARY KEY ([PID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Request_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Request_Details] ADD CONSTRAINT [PK_Request_Details] PRIMARY KEY ([RD_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Request_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Request_Master] ADD CONSTRAINT [PK_Request_Master] PRIMARY KEY ([Request_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Request_Priority_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Request_Priority_Master] ADD CONSTRAINT [PK_Request_Priority_Master] PRIMARY KEY ([Priority_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Resource_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Resource_Master] ADD CONSTRAINT [PK_Resource_Master] PRIMARY KEY ([Emp_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Role_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Role_Master] ADD CONSTRAINT [PK_Role_Master] PRIMARY KEY ([Role_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RoleMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[RoleMaster] ADD CONSTRAINT [PK_RoleMaster] PRIMARY KEY ([Role_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Solution_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Solution_Master] ADD CONSTRAINT [PK_Solution_Master] PRIMARY KEY ([Solution_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__21B6055D] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Task_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[Task_Master] ADD CONSTRAINT [PK_Task_Master] PRIMARY KEY ([Task_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Category_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Category_Master] ADD CONSTRAINT [PK_tbl_Category_Master] PRIMARY KEY ([Category_Id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_CheckList
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_CheckList] ADD CONSTRAINT [PK_Tbl_CheckList] PRIMARY KEY ([Check_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_Checklist_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_Checklist_Details] ADD CONSTRAINT [PK_Tbl_Checklist_Details] PRIMARY KEY ([CID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_Project_Phase_Status
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_Project_Phase_Status] ADD CONSTRAINT [PK_Tbl_Project_Phase_Status] PRIMARY KEY ([PP_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_Project_Phase_Status_Details
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_Project_Phase_Status_Details] ADD CONSTRAINT [PK_Tbl_Project_Phase_Status_2] PRIMARY KEY ([PP_Details_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_ProjectDefect
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_ProjectDefect] ADD CONSTRAINT [PK__tbl_ProjectDefec__6EE2037B] PRIMARY KEY ([ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_ProjectDefectMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_ProjectDefectMaster] ADD CONSTRAINT [PK__tbl_ProjectDefec__0353107C] PRIMARY KEY ([Defect_Code])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Tbl_Summary_LogMail
-- --------------------------------------------------
ALTER TABLE [dbo].[Tbl_Summary_LogMail] ADD CONSTRAINT [PK_Tbl_Summary_LogMail] PRIMARY KEY ([log_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_Testing_RequestsDetails
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_Testing_RequestsDetails] ADD CONSTRAINT [PK__tbl_Testing_Requ__73A6B898] PRIMARY KEY ([Token_Detail_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.tbl_User_RoleMaster
-- --------------------------------------------------
ALTER TABLE [dbo].[tbl_User_RoleMaster] ADD CONSTRAINT [PK__tbl_User_RoleMas__286F8692] PRIMARY KEY ([Emp_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.User_Shift_Master
-- --------------------------------------------------
ALTER TABLE [dbo].[User_Shift_Master] ADD CONSTRAINT [PK_User_Shift_Master] PRIMARY KEY ([Shift_ID])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_ConvertQueryInHTMP_Page
-- --------------------------------------------------



--declare @HTMLBODY1 nvarchar(max)   
--exec DBA_admin.dbo.[DBA_ConvertQueryInHTMP_Page] 'select top 100 percent * from inhouse.dbo.tbl_log order by 1 desc ', @HTMLBODY1 output  
--select @HTMLBODY1  
  
  
CREATE    proc [dbo].[DBA_ConvertQueryInHTMP_Page] (@objectname1 varchar(max),@HTMLBODY varchar(max) OUTPUT)                          
as                           
--Declare   @objectname1 varchar(max)  
--declare @HTMLBODY nvarchar(max)  
--set @objectname1 ='Select * from sysobjects'  
               
  
                  
  
 set nocount on                      
  
  IF EXISTS(SELECT 1 FROM sys.objects                           
  
  WHERE OBJECT_ID = OBJECT_ID('DBA_TempHTML') AND type = ('U'))                             
  
  DROP TABLE DBA_TempHTML                          
  
                    
  
  DECLARE @createtable nvarchar(max)                          
  
  set @createtable ='select * into DBA_TempHTML  from  ( '+''+ @objectname1+')A order by 1 desc'                    
  
  EXECUTE sp_executesql @createtable        
                 
  
             
  
                   
  
  DECLARE @xmlquery2 nvarchar (max)                          
  
  DECLARE @name varchar(max)                    
  
                          
  
  DECLARE c1 CURSOR READ_ONLY                          
  
  FOR  select  'Column_name'   = name  from sys.all_columns where object_id = ( select object_id  from sys.all_objects                           
  
  where object_id = object_id('DBA_TempHTML') )                           
  
  OPEN c1                          
  
        DECLARE  @tempvar nvarchar(max)                          
  
        DECLARE @NEWCOLUMN nvarchar(max)                        
  
  SET @NEWCOLUMN=''                      
  
  set @tempvar=''                           
  
                          
  
   FETCH NEXT FROM c1                          
  
   INTO @name                          
  
                          
  
   WHILE @@FETCH_STATUS = 0                          
  
    BEGIN                        
  
     SET @NEWCOLUMN =@NEWCOLUMN+'<th >'+@name +'</th>'                    
  
     set @tempvar = @tempvar+ 'cast('+@name +' as varchar(MAX) )'+'+' + '''</td><td>''' +'+'                    
  
        FETCH NEXT FROM c1                          
  
     INTO @name                          
  
    END                          
  
  CLOSE c1                          
  
  DEALLOCATE c1                      
  
  SET @tempvar=  LEFT (@tempvar, LEN(@tempvar)-13)                    
  
                        
  
  declare @BODY nvarchar(max)                    
  
  SET @BODY=' select cast( (select td = '+@tempvar+ ' from (  SELECT top 100 percent* FROM DBA_TempHTML order by 1 desc) as d '+' for xml path( ''tr'' ), type ) as varchar(max) )'                    
  
             
  
  print  @BODY                 
  
          
  
                   
  
  create table #temp                    
  
  (returnstr nvarchar (max))                    
  
  insert into #temp  exec sp_executesql  @body                    
  
  declare @returnstr2 nvarchar(max)                    
  
  select @returnstr2=LTRIM(RTRIM(returnstr)) from #temp                    
  
                  
  
  set @HTMLBODY ='<table class=''MyTable'' cellpadding="0" cellspacing="0" >'                     
  
                + '<tr>'+''+@NEWCOLUMN+ ''+'</tr>'                    
  
             + replace( replace( @returnstr2, '&lt;', '<' ), '&gt;', '>'  )                 
  
                + '</table>'                    
  
                    
  
select  @HTMLBODY                    
  
drop table #temp                    
  
drop table DBA_TempHTML

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_ConvertQueryInHTMP_PageComman
-- --------------------------------------------------






--declare @HTMLBODY1 nvarchar(max)             
--exec DBA_admin.dbo.[DBA_ConvertQueryInHTMP_Page] 'select top 100 percent * from inhouse.dbo.tbl_log order by 1 desc ', @HTMLBODY1 output            
--select @HTMLBODY1            
            
            
CREATE    proc [dbo].[DBA_ConvertQueryInHTMP_PageComman] (@objectname1 varchar(max),@HTMLBODY varchar(max) OUTPUT)                                    
as                                     
--Declare   @objectname1 varchar(max)            
--declare @HTMLBODY nvarchar(max)            
--set @objectname1 ='Select * from sysobjects'            
            
 set nocount on                                
       
  IF EXISTS(SELECT 1 FROM sys.objects                                     
            
  WHERE OBJECT_ID = OBJECT_ID('DBA_TempHTML') AND type = ('U'))                                       
            
  DROP TABLE DBA_TempHTML                                    
       
  DECLARE @createtable nvarchar(max)                                    
            
  set @createtable ='select * into DBA_TempHTML  from  ( '+''+ @objectname1+')A '                              
            
  EXECUTE sp_executesql @createtable                  
      
  DECLARE @xmlquery2 nvarchar (max)                                    
            
  DECLARE @name varchar(max)                              
            
  DECLARE c1 CURSOR READ_ONLY                                    
            
  FOR  select  'Column_name'   = name  from sys.all_columns where object_id = ( select object_id  from sys.all_objects                                     
            
  where object_id = object_id('DBA_TempHTML') )                                     
            
  OPEN c1                                    
            
        DECLARE  @tempvar nvarchar(max)                                    
            
        DECLARE @NEWCOLUMN nvarchar(max)                                  
            
  SET @NEWCOLUMN=''                                
            
  set @tempvar=''                                     
            
                                    
            
   FETCH NEXT FROM c1                                    
            
   INTO @name                                    
            
                                    
            
   WHILE @@FETCH_STATUS = 0                                    
            
    BEGIN                                  
            
     SET @NEWCOLUMN =@NEWCOLUMN+'<th >'+@name +'</th>'                              
            
     set @tempvar = @tempvar+ 'cast('+@name +' as varchar(MAX) )'+'+' + '''</td><td>''' +'+'                              
            
        FETCH NEXT FROM c1                                    
            
     INTO @name                                    
            
    END                                    
            
  CLOSE c1                                    
            
  DEALLOCATE c1                                
            
  SET @tempvar=  LEFT (@tempvar, LEN(@tempvar)-13)                              
            
                                  
            
  declare @BODY nvarchar(max)                              
            
  SET @BODY=' select cast( (select td = '+@tempvar+ ' from (  SELECT top 100 percent * FROM DBA_TempHTML Order BY 1) as d '+' for xml path( ''tr'' ), type ) as varchar(max) )'                              
    
  print  @BODY                           
    
  create table #temp                              
            
  (returnstr nvarchar (max))                              
            
  insert into #temp  exec sp_executesql  @body                              
            
  declare @returnstr2 nvarchar(max)                              
            
  select @returnstr2=LTRIM(RTRIM(returnstr)) from #temp                              
      
  set @HTMLBODY = '<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >'                              
            
                + '<tr>'+''+@NEWCOLUMN+ ''+'</tr>'                  
            
             + replace( replace( @returnstr2, '&lt;', '<' ), '&gt;', '>'  )                           
            
                + '</table>'                              
            
                              
            
select  @HTMLBODY         
            
drop table #temp                              
            
drop table DBA_TempHTML

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Mail_Summary_Report
-- --------------------------------------------------




--Mail_Summary_Report 'P00227','AA','1'
--Mail_Summary_Report 'E23266','SYA','1'
--Mail_Summary_Report 'E05868','PO','2'
--Mail_Summary_Report 'E05205','PM','3'
--Mail_Summary_Report 'E15318','PL','4'
--Mail_Summary_Report 'E15318','PL','5'


CREATE Proc [dbo].[Mail_Summary_Report] --'E05868','PO','2'

@Emp_ID As Char(10),
@Role As Char(10),
@Option As Int

As
Begin
	If(@Option=1) -- Administrator/System Anyalyst (AA/SYA)
	Begin
		--====================== Pending New Request till today ======================--
		Select RM.Request_ID As [Request ID], RM.Project_Name AS [Project], RM.Brief_Requirement As [Brief Requirement], 
			RM.Request_Date As [Request Date],CM.Emp_Name As [Requested BY], CM2.Emp_Name As [Owner], 
			CM.Department As [Department], RSM.Request_Status_Name As [Status]
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('PBA')

		--====================== Project Pending For Assign till today ======================--
		Select RM.Request_ID As [Request ID], RM.Project_Name AS [Project], RM.Brief_Requirement As [Brief Requirement], 
			RM.Request_Date As [Request Date],CM.Emp_Name As [Requested BY], CM2.Emp_Name As [Owner], 
			CM.Department As [Department], RSM.Request_Status_Name As [Status]
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('ABA')

		--====================== Pending Change Request till today ======================--
		Select Distinct CRM.Change_ID As [Change ID], CRM.Request_ID As [Request ID], PM.Project_Name As [Project],
			MM.Module_Name As [Module], CRM.Description As [Description], CRM.Changed_Date As [Changed Date], 
			CM.Emp_Name As [Requested BY], CM2.Emp_Name As [Owner], CM.Department As [Department], 
			RSM.Request_Status_Name As [Status]
		From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
			Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
			CRM.Changed_BY=CM.Emp_ID And
			CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID
			And CRM.Request_Status_ID in ('PBA')

		--====================== Time Sheet Updation till today ======================--
		Select Resource, Manager, Last_Update As [Last Update], Status_ID As [Status]
		From 
		(
			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, TM.Last_Update As Last_Update, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
				And (TM.Last_Update Between getdate()-7 And getdate())
				And TM.Status_ID in ('C','W')

			Union 

			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, TM.Last_Update As Last_Update, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
				And TM.Last_Update = '1900-01-01 00:00:00.000'
				And TM.Status_ID in ('P')
				And TM.Assigned_To not in 
				(
					Select Distinct RES.Emp_ID
					From Task_Master TM, Resource_Master RES,Resource_Master RES2
					Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
						And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
						And (TM.Last_Update Between getdate()-7 And getdate())
						And TM.Status_ID in ('C','W')
				)
		) Temp 
		Order By Last_Update DESC
	End
	Else If(@Option=2) -- Project Owner (PO)
	Begin

		--====================== Pending New Request till today ======================--
		Select RM.Request_ID As [Request ID], RM.Project_Name AS [Project], RM.Brief_Requirement As [Brief Requirement], 
			RM.Request_Date As [Request Date],CM.Emp_Name As [Requested BY], CM2.Emp_Name As [Owner], 
			CM.Department As [Department], RSM.Request_Status_Name As [Status]
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('PBA')
			And (RM.Requested_By In (Select Emp_ID From Client_Master Where HOD=@Emp_ID Union Select @Emp_ID) Or
			RM.Requested_By In (Select Distinct Employee_ID From Coordinator_Master 
				Where Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)))
			And @Role in (Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)
	
		--====================== Project Pending For Assign till today ======================--
		Select RM.Request_ID As [Request ID], RM.Project_Name AS [Project], RM.Brief_Requirement As [Brief Requirement], 
			RM.Request_Date As [Request Date],CM.Emp_Name As [Requested BY], CM2.Emp_Name As [Owner], 
			CM.Department As [Department], RSM.Request_Status_Name As [Status]
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('ABA')
			And (RM.Requested_By In (Select Emp_ID From Client_Master Where HOD=@Emp_ID Union Select @Emp_ID) Or
			RM.Requested_By In (Select Distinct Employee_ID From Coordinator_Master 
				Where Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)))
			And @Role in (Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)

		--====================== Pending Change Request till today ======================--
		Select Distinct CRM.Change_ID As [Change ID], CRM.Request_ID As [Request ID], PM.Project_Name As [Project],
			MM.Module_Name As [Module], CRM.Description As [Description], CRM.Changed_Date As [Changed Date], 
			CM.Emp_Name As [Requested BY], CM2.Emp_Name As [Owner], CM.Department As [Department], 
			RSM.Request_Status_Name As [Status]
		From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
			Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
			CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID And
			CRM.Request_Status_ID in ('PBA') and CRM.Changed_BY=CM.Emp_ID 
			And (CRM.Changed_BY In (Select Emp_ID From Client_Master Where HOD=@Emp_ID Union Select @Emp_ID) Or
			CRM.Changed_BY In (Select Distinct Employee_ID From Coordinator_Master 
				Where Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)))
			And @Role in (Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)
	End
	Else If(@Option=3) -- Project Manager (PM)
	Begin

		--====================== Pending Change Request till today ======================--
		Select Distinct CRM.Change_ID As [Change ID], CRM.Request_ID As [Request ID], PM.Project_Name As [Project],
			MM.Module_Name As [Module], CRM.Description As [Description], CRM.Changed_Date As [Changed Date], 
			CM.Emp_Name As [Requested BY], CM2.Emp_Name As [Owner], CM.Department As [Department], 
			RSM.Request_Status_Name As [Status]
		From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
			Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
			CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID And
			CRM.Request_Status_ID in ('PBA') and CRM.Changed_BY=CM.Emp_ID 
			And CRM.Project_ID in (Select Distinct Project_ID From Project_Master Where Project_Manager=@Emp_ID)
			And @Role in (Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)
		
		--====================== Project Pending For Accept till today ======================--
		Select RM.Request_ID, PM.Project_Name, RM.Brief_Requirement, RM.Request_Date, CM.Emp_Name,
			CM2.Emp_Name As Owner,
			CM.Department, PM.AS_SDate As [Delegation Date],PM.AS_SDate As [Admin Start Date],
			PM.AS_EDate As [Admin End Date],ISNULL(PM.Remark,'') As [Admin Remark]
		From Request_Master RM, Project_Master PM, Client_Master CM, Client_Master CM2
		Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=CM.Emp_ID
			and RM.HOD_Approve=CM2.Emp_ID And PM.Project_Manager=@Emp_ID
			and RM.Request_Status_ID in ('PMA')

		--====================== Time Sheet Updation till today ======================--
		Select Resource, Manager, Last_Update As [Last Update], Status_ID As [Status]
		From 
		(
			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, TM.Last_Update As Last_Update, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp_ID Union Select @Emp_ID)
				And (TM.Last_Update Between getdate()-7 And getdate())
				And TM.Status_ID in ('C','W')

			Union 

			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, TM.Last_Update As Last_Update, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp_ID Union Select @Emp_ID)
				And TM.Last_Update = '1900-01-01 00:00:00.000'
				And TM.Status_ID in ('P')
				And TM.Assigned_To not in 
				(
					Select Distinct RES.Emp_ID
					From Task_Master TM, Resource_Master RES,Resource_Master RES2
					Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
						And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
						And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp_ID Union Select @Emp_ID)
						And (TM.Last_Update Between getdate()-7 And getdate())
						And TM.Status_ID in ('C','W')
				)
		) Temp 
		Order By Last_Update DESC 

		--====================== Task Summary (todays, pending and in progress task )======================--
		Select [Task ID], [Project], [Module], [Start Date], [End Date],[Resource], [Resource Remark],
		[Status], [Last Updated Date] 
		From 
		(
		Select TM.Task_ID As [Task ID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
				TM.AS_SDT As [Start Date], TM.AS_EDT As [End Date], RES.Emp_Name As [Resource], TM.Remark As [Resource Remark],
				TM.Status_ID As [Status], TM.Last_Update AS [Last Updated Date]
		From Task_Master TM, Project_Master PM, Module_Master MM, Resource_Master RES
		Where TM.Project_ID=PM.Project_ID And TM.Module_ID=MM.Module_ID And TM.Assigned_To=RES.Emp_ID 
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp_ID Union Select @Emp_ID)
				And Convert(Varchar(10),TM.Last_Update,103)=Convert(Varchar(10),getdate(),103)
				
		UNION		

		Select TM.Task_ID As [Task ID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
				TM.AS_SDT As [Start Date], TM.AS_EDT As [End Date], RES.Emp_Name As [Resource], TM.Remark As [Resource Remark],
				TM.Status_ID As [Status], TM.Last_Update AS [Last Updated Date]
		From Task_Master TM, Project_Master PM, Module_Master MM, Resource_Master RES
		Where TM.Project_ID=PM.Project_ID And TM.Module_ID=MM.Module_ID And TM.Assigned_To=RES.Emp_ID 
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp_ID Union Select @Emp_ID)
				And TM.Status_ID in ('P','W')
		) Temp 
		Order By [Last Updated Date] DESC

		
	End
	Else If(@Option=4) -- Project Leader (PL)
	Begin
		--====================== Time Sheet Updation till today ======================--
		Select Resource, Leader, Last_Update As [Last Update], Status_ID As [Status]
		From 
		(
			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Leader, TM.Last_Update As Last_Update, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Leader=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Leader From Resource_Master)
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=@Emp_ID Union Select @Emp_ID)
				And (TM.Last_Update Between getdate()-7 And getdate())
				And TM.Status_ID in ('C','W')

			Union 

			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Leader, TM.Last_Update As Last_Update, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Leader=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Leader From Resource_Master)
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=@Emp_ID Union Select @Emp_ID)
				And TM.Last_Update = '1900-01-01 00:00:00.000'
				And TM.Status_ID in ('P')
				And TM.Assigned_To not in 
				(
					Select Distinct RES.Emp_ID
					From Task_Master TM, Resource_Master RES,Resource_Master RES2
					Where TM.Assigned_To=RES.Emp_ID And RES.Project_Leader=RES2.Emp_ID 
						And RES2.Emp_ID in (Select Project_Leader From Resource_Master)
						And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=@Emp_ID Union Select @Emp_ID)
						And (TM.Last_Update Between getdate()-7 And getdate())
						And TM.Status_ID in ('C','W')
				)
		) Temp 
		Order By Last_Update DESC 
		
		--====================== Task Summary (todays, pending and in progress task )======================--
		Select [Task ID], [Project], [Module], [Start Date], [End Date],[Resource], [Resource Remark],
		[Status], [Last Updated Date] 
		From 
		(
		Select TM.Task_ID As [Task ID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
				TM.AS_SDT As [Start Date], TM.AS_EDT As [End Date], RES.Emp_Name As [Resource], TM.Remark As [Resource Remark],
				TM.Status_ID As [Status], TM.Last_Update AS [Last Updated Date]
		From Task_Master TM, Project_Master PM, Module_Master MM, Resource_Master RES
		Where TM.Project_ID=PM.Project_ID And TM.Module_ID=MM.Module_ID And TM.Assigned_To=RES.Emp_ID 
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=@Emp_ID Union Select @Emp_ID)
				And Convert(Varchar(10),TM.Last_Update,103)=Convert(Varchar(10),getdate(),103)
				
		UNION		

		Select TM.Task_ID As [Task ID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
				TM.AS_SDT As [Start Date], TM.AS_EDT As [End Date], RES.Emp_Name As [Resource], TM.Remark As [Resource Remark],
				TM.Status_ID As [Status], TM.Last_Update AS [Last Updated Date]
		From Task_Master TM, Project_Master PM, Module_Master MM, Resource_Master RES
		Where TM.Project_ID=PM.Project_ID And TM.Module_ID=MM.Module_ID And TM.Assigned_To=RES.Emp_ID 
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=@Emp_ID Union Select @Emp_ID)
				And TM.Status_ID in ('P','W')
		) Temp 
		Order By [Last Updated Date] DESC

	End
	Else If(@Option=5) -- Developer (DVL)
	Begin
		--====================== Task Summary (todays, pending and in progress task )======================--
		Select [Task ID], [Project], [Module], [Start Date], [End Date],[Resource], [Resource Remark],
		[Status], [Last Updated Date] 
		From 
		(
		Select TM.Task_ID As [Task ID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
				TM.AS_SDT As [Start Date], TM.AS_EDT As [End Date], RES.Emp_Name As [Resource], TM.Remark As [Resource Remark],
				TM.Status_ID As [Status], TM.Last_Update AS [Last Updated Date]
		From Task_Master TM, Project_Master PM, Module_Master MM, Resource_Master RES
		Where TM.Project_ID=PM.Project_ID And TM.Module_ID=MM.Module_ID And TM.Assigned_To=RES.Emp_ID 
				And TM.Assigned_To=@Emp_ID
				And Convert(Varchar(10),TM.Last_Update,103)=Convert(Varchar(10),getdate(),103)
				
		UNION		

		Select TM.Task_ID As [Task ID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
				TM.AS_SDT As [Start Date], TM.AS_EDT As [End Date], RES.Emp_Name As [Resource], TM.Remark As [Resource Remark],
				TM.Status_ID As [Status], TM.Last_Update AS [Last Updated Date]
		From Task_Master TM, Project_Master PM, Module_Master MM, Resource_Master RES
		Where TM.Project_ID=PM.Project_ID And TM.Module_ID=MM.Module_ID And TM.Assigned_To=RES.Emp_ID 
				And TM.Assigned_To =@Emp_ID
				And TM.Status_ID in ('P','W')
		) Temp 
		Order By [Last Updated Date] DESC
	End


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
    
CREATE procedure [dbo].[rebuild_index]      
@database varchar(100)      
as      
begin      
      
declare @db_id int      
Select @db_id = db_id(@database)       
      
if @db_id is Null      
return      
      
SET NOCOUNT ON;      
DECLARE @objectid int;      
DECLARE @indexid int;      
DECLARE @partitioncount bigint;      
DECLARE @schemaname nvarchar(130);       
DECLARE @objectname nvarchar(130);       
DECLARE @indexname nvarchar(130);       
DECLARE @partitionnum bigint;      
DECLARE @partitions bigint;      
DECLARE @frag float;      
DECLARE @command nvarchar(4000);       
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function       
-- and convert object and index IDs to names.      
      
SELECT      
    object_id AS objectid,      
    index_id AS indexid,      
    partition_number AS partitionnum,      
    avg_fragmentation_in_percent AS frag      
INTO #work_to_do      
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')      
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;      
      
-- Declare the cursor for the list of partitions to be processed.      
DECLARE partitions CURSOR FOR SELECT * FROM #work_to_do;      
      
-- Open the cursor.      
OPEN partitions;      
      
-- Loop through the partitions.      
WHILE (1=1)      
    BEGIN;      
        FETCH NEXT      
           FROM partitions      
           INTO @objectid, @indexid, @partitionnum, @frag;      
        IF @@FETCH_STATUS < 0 BREAK;      
        SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)      
        FROM sys.objects AS o      
        JOIN sys.schemas as s ON s.schema_id = o.schema_id      
        WHERE o.object_id = @objectid;      
        SELECT @indexname = QUOTENAME(name)      
        FROM sys.indexes      
        WHERE  object_id = @objectid AND index_id = @indexid;      
        SELECT @partitioncount = count (*)      
        FROM sys.partitions      
        WHERE object_id = @objectid AND index_id = @indexid;      
      
-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.      
        IF @frag < 30.0      
            SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';      
        IF @frag >= 30.0      
            SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD WITH (SORT_IN_TEMPDB = ON)';      
        IF @partitioncount > 1      
            SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));      
        EXEC (@command);      
        PRINT N'Executed: ' + @command;      
    END;      
      
-- Close and deallocate the cursor.      
CLOSE partitions;      
DEALLOCATE partitions;      
      
-- Drop the temporary table.      
DROP TABLE #work_to_do;      
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SendMail_Admin_OLD
-- --------------------------------------------------


CREATE Proc [dbo].[SendMail_Admin]

as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max)     
	declare @HTMLBODY4 nvarchar(max)  

	---- ///////////////////////////////  Administrator Mail /////////////////////////////// ----

	--====================== Pending New Request till today ======================--
	Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], RM.Brief_Requirement As [BriefRequirement], 
		RM.Request_Date As [RequestDate],CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], 
		CM.Department As [Department], RSM.Request_Status_Name As [Status]
		Into ADM_Temp_Mail1
	From Request_Master RM, Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
		And RM.Request_Status_ID in ('PBA')

	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From ADM_Temp_Mail1 ', @HTMLBODY1 output  

	Drop Table ADM_Temp_Mail1    

	--====================== Project Pending For Assign till today ======================--
	Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], RM.Brief_Requirement As [BriefRequirement], 
		RM.Request_Date As [RequestDate],CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], 
		CM.Department As [Department], RSM.Request_Status_Name As [Status]
		Into ADM_Temp_Mail2
	From Request_Master RM, Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
		And RM.Request_Status_ID in ('ABA')                
      
	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail2 order by 1', @HTMLBODY2 output         
     
	Drop Table ADM_Temp_Mail2 

	--====================== Pending Change Request till today ======================--
	Select Distinct CRM.Change_ID As [ChangeID], CRM.Request_ID As [RequestID], PM.Project_Name As [Project],
		MM.Module_Name As [Module], CRM.Description As [Description], CRM.Changed_Date As [ChangedDate], 
		CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], CM.Department As [Department], 
		RSM.Request_Status_Name As [Status]
		Into ADM_Temp_Mail3 
	From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
		Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
		CRM.Changed_BY=CM.Emp_ID And
		CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID
		And CRM.Request_Status_ID in ('PBA')
	
	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail3 order by 1',@HTMLBODY3 output                     
  
	Drop Table ADM_Temp_Mail3 


	--/////////////////////////////////////////////////////////////////////////////////////--
 
	if(@HTMLBODY1 IS NOT NULL)
	Begin
		set @HTMLBODY4 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>New Request Summary Report</caption>')
	End

	If(@HTMLBODY2 IS NOT NULL)
	Begin
		If(@HTMLBODY1 IS NOT NULL)
		Begin
			Set @HTMLBODY4 = @HTMLBODY4 + '<br><br> '+ Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
														'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>Project Summary Report</caption>')
		End
		Else if(@HTMLBODY1 IS NULL)
		Begin
			Set @HTMLBODY4 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
														'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>Project Summary Report</caption>')
		End
	End
    
	If(@HTMLBODY3 IS NOT NULL)
	Begin
		If(@HTMLBODY1 IS NULL and @HTMLBODY1 IS NULL)
		Begin
			Set @HTMLBODY4 = Replace(@HTMLBODY3,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
														'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>Change Request Summary Report</caption>')
		End
		Else
		Begin
			Set @HTMLBODY4 = @HTMLBODY4 + '<br><br>' + Replace(@HTMLBODY3,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
														'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>Change Request Summary Report</caption>')
		End
	End

	If(@HTMLBODY4 IS NOT NULL)
	Begin
	
		Set @HTMLBODY4 = '<HTML><HEAD><TITLE>Summary Report</TITLE><STYLE TYPE=''text/css''>' +
                     '.MyTable{width: auto; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
                     '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;}' +
                     '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
                     '</STYLE></HEAD><Body><br><center><Div><center>' +
						@HTMLBODY4
					+ '</center></Div></center></Body></HTML>'
	End

	select @HTMLBODY4                         
                        
	If(@HTMLBODY4 IS NOT NULL)
	Begin
		EXEC msdb.dbo.sp_send_dbmail                         
			@profile_name = 'Prms_alert',                        
			--@recipients='jayk.khare@angeltrade.com',                        
			@recipients='Sanjay.Patel@angeltrade.com;MahendraD.Bonde@angeltrade.com',                        
			@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
			@subject = 'Summary Report',                        
			@body = @HTMLBODY4,                        
			@body_format = 'HTML'         
    End        
            
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SendMailScrip_master_logInfo
-- --------------------------------------------------


CREATE Proc [dbo].[SendMailScrip_master_logInfo]                        
as                        
Begin
                        
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max)     
	declare @HTMLBODY4 nvarchar(max)  

	---- ///////////////////////////////  Administrator Mail /////////////////////////////// ----

	--====================== Pending New Request till today ======================--
	Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], RM.Brief_Requirement As [BriefRequirement], 
		RM.Request_Date As [RequestDate],CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], 
		CM.Department As [Department], RSM.Request_Status_Name As [Status]
		Into ADM_Temp_Mail1
	From Request_Master RM, Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
		And RM.Request_Status_ID in ('PBA')
   

    
	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From ADM_Temp_Mail1 ', @HTMLBODY1 output  

	Drop Table ADM_Temp_Mail1    

 

	--====================== Project Pending For Assign till today ======================--
--	Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], RM.Brief_Requirement As [BriefRequirement], 
--		RM.Request_Date As [RequestDate],CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], 
--		CM.Department As [Department], RSM.Request_Status_Name As [Status]
--		Into ADM_Temp_Mail2
--	From Request_Master RM, Client_Master CM, 
--		Client_Master CM2, Request_Status_Master RSM	
--	Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
--		And RM.Request_Status_ID in ('ABA')                
--      
--	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail2 order by 1', @HTMLBODY2 output         
--     
--	Drop Table ADM_Temp_Mail2 
	--====================== Pending Change Request till today ======================--
	Select Distinct CRM.Change_ID As [ChangeID], CRM.Request_ID As [RequestID], PM.Project_Name As [Project],
		MM.Module_Name As [Module], CRM.Description As [Description], CRM.Changed_Date As [ChangedDate], 
		CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], CM.Department As [Department], 
		RSM.Request_Status_Name As [Status]
		Into ADM_Temp_Mail3 
	From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
		Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
		CRM.Changed_BY=CM.Emp_ID And
		CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID
		And CRM.Request_Status_ID in ('PBA')
	
	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail3 order by 1',@HTMLBODY3 output                     
  
	Drop Table ADM_Temp_Mail3 


	--/////////////////////////////////////////////////////////////////////////////////////--
 
	set @HTMLBODY4 =@HTMLBODY1+@HTMLBODY3    
    
	select @HTMLBODY4                         
                         
	EXEC msdb.dbo.sp_send_dbmail                         
			@profile_name = 'Prms_alert',                        
			--@recipients='jayk.khare@angeltrade.com',                        
			@recipients='MahendraD.Bonde@angeltrade.com',                        
			@copy_recipients ='MahendraD.Bonde@angeltrade.com',                        
			@subject = 'Scrip_master_log Table Information',                        
			@body = @HTMLBODY4,                        
			@body_format = 'HTML'         
            
            
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ups_component_report
-- --------------------------------------------------





CREATE proc [dbo].[ups_component_report] --'Window','C#','Label','',''          
(            
@cmt_type as varchar(10),            
@dvp_plt as varchar(15),            
@cmt_name as varchar(100),            
@cmt_category as varchar(70),            
@publisher as varchar(10)            
)            
as           
Begin            
	Declare @str as Varchar(MAX)   
	Declare @str1 as Varchar(MAX)   
	Declare @str2 as Varchar(MAX)   
            
	set @str1='Select TCM.[Object_name],TCM.object_type,TCM.Object_platform,TCM.Object_list,	
			CM.Emp_Name as Uploaded_by, TCM.Uploaded_by as PublisherID, 
			convert(varchar(11),TCM.uploaded_on,103) as uploaded_on,
			TRM.Rating
		From tbl_component_master TCM
		Join Client_Master CM on CM.Emp_ID=TCM.uploaded_by 
		join tbl_rating_master TRM on TCM.[Object_ID]=TRM.[Object_ID] and TCM.CMT_ID=TRM.CMT_ID
		Where TCM.[object_Type]= ''' + @cmt_type + ''' '

	set @str2='Select Distinct TCM.[Object_name],TCM.object_type,TCM.Object_platform,TCM.Object_list,	
			CM.Emp_Name as Uploaded_by, TCM.Uploaded_by as PublisherID, 
			convert(varchar(11),TCM.uploaded_on,103) as uploaded_on,
			''0'' As Rating			
			From tbl_component_master TCM, Client_Master CM 
			Where CM.Emp_ID=TCM.uploaded_by	and TCM.[CMT_ID] not in (Select distinct CMT_ID From tbl_rating_master)
			and TCM.[object_Type]= ''' + @cmt_type + ''' '
      
	If(@cmt_name<>'')
	Begin
		Set @str2 =  @str2 + ' and TCM.[object_name] = ''' + @cmt_name + ''''
		Set @str1 =  @str1 + ' and TCM.[object_name] = ''' + @cmt_name + ''''
	End

	If(@cmt_category<>'')
	Begin
		Set @str2 =  @str2 + ' and TCM.[object_list] = ''' + @cmt_category + ''''
		Set @str1 =  @str1 + ' and TCM.[object_list] = ''' + @cmt_category + ''''
	End 

	If(@publisher<>'')
	Begin
		Set @str2 =  @str2 + ' and TCM.uploaded_by = ''' + @publisher + ''''
		Set @str1 =  @str1 + ' and TCM.uploaded_by = ''' + @publisher + ''''
	End 
         
	If(@dvp_plt<>'')
	Begin
		Set @str2 =  @str2 + ' and TCM.object_platform = ''' + @dvp_plt + ''''
		Set @str1 =  @str1 + ' and TCM.object_platform = ''' + @dvp_plt + ''''
	End


	Set @Str = 'Select [Object_name],[Object_type],[Object_platform],[Object_list],Uploaded_by,PublisherID, 
			Uploaded_on,Rating From (' + @Str1 +	' Union ' + @Str2 + ') Temp	order by Uploaded_on desc'

--	Set @str =  @str + 'order by TCM.uploaded_on desc'
	
	print @str            
	exec (@str)   


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Admin_Report
-- --------------------------------------------------










  
CREATE Proc [dbo].[USP_Admin_Report]  
  
--Created By : Mahendra Bonde  
--Created Date : 03-04-2010  
  
@Request_ID Char(20),  
@Project_Code Char(20),  
@Request_Status_ID Char(20),  
@Dept Char(20),
@PM As Char(20), 
@EMP AS Char(20), 
@Role As Char(20),
@SDate Varchar(25),  
@EDate Varchar(25),
@Option Char(5)  
  
As  
Begin  
 Declare @Query Varchar(MAX)  
  
 If(@Option='1')  
 Begin  
  
  Set @Query='Select distinct RM.Request_ID As [RequestID] , RM.Project_Name As [Project], Audience, CM.EMP_Name As [RequestBy], 
				 RPM.Priority_Name As [Priority] , Convert(varchar(12),RM.Request_Date) As [RequestDate], 
				 Convert(varchar(12),RM.Expected_EDate) As [EndDate],RM.HOD_Remark As [HODRemark],
				RM.Admin_Remark As [Admin_Remark], 
				(Case When PM.Project_Manager<>'''' Then (Select Emp_Name From Resource_Master Where Emp_ID=PM.Project_Manager)
					Else '''' End) AS [Project Manager], 
				(Case When PM.Project_Leader<>'''' Then (Select Emp_Name From Resource_Master Where Emp_ID=PM.Project_Leader)
					Else '''' End) AS [Project Leader], 
				RSM.Request_Status_Name As Status
		    From (Select Emp_ID, Emp_Name, Department From Client_Master with (nolock) Where Role_ID in (''C'',''PC'',''PO'',''AA'',''SYA''))  CM, 
				Project_Master PM with (nolock),Resource_Master RSM1 with (nolock), 
				Resource_Master RSM2 with (nolock), Request_Status_Master RSM with (nolock), 
				Request_Priority_Master RPM with (nolock), Request_Master RM with (nolock) 
				left join Client_Master HOD with (nolock) on HOD.emp_ID = RM.HOD_Approve 
				left join Client_Master ADM with (nolock) on ADM.emp_ID = RM.Admin_Approve 
			 Where RM.Request_ID=PM.Request_ID  
			  And RM.Requested_BY=CM.emp_ID  
			  And RM.Request_Status_ID=RSM.Request_Status_ID  
			  And RM.Priority_ID=RPM.Priority_ID '  
  
	If(@Request_ID<>'')  
	Begin  
		Set @Query = @Query + ' And RM.Request_ID=''' + rtrim(@Request_ID) + ''''  
	End  

	If(@Role='PM')
	Begin
		Set @Query = @Query + ' And PM.Project_Manager=''' + rtrim(@PM) + ''''
	End   

	If(@Role='PL')
	Begin
		Set @Query = @Query + ' And PM.Project_Leader=''' + rtrim(@PM) + ''''
	End 

	If(@Emp<>'' and (@Role='AA' or @Role='SYA'))
	Begin
		Set @Query = @Query + ' And PM.Project_Manager=''' + rtrim(@Emp) + ''''
	End   
	else If(@Emp<>'' and (@Role='PM' or @Role='PL'))
	Begin
		Set @Query = @Query + ' And PM.Project_Leader=''' + rtrim(@Emp) + ''''
	End 

	If(@Project_Code<>'')  
	Begin  
		Set @Query = @Query + ' And PM.Project_id=''' + rtrim(@Project_Code) + ''''  
	End  
    
	If(@Request_Status_ID <>'')  
	Begin  
		Set @Query = @Query + ' And RM.Request_Status_ID=''' + rtrim(@Request_Status_ID) + ''''  
	End  
    
	If(@Dept<>'')  
	Begin  
		Set @Query = @Query + ' And CM.Department=''' + rtrim(@Dept) + ''''  
	End  
  
	If(@SDate<>'' And @EDate<>'')  
	Begin  
		set @Query = @Query + ' And RM.Request_Date between convert(datetime,ltrim(rtrim('''+ @SDate + ''')),101) and DATEADD(dd,1,convert(datetime,ltrim(rtrim(''' + @EDate + ''')),101))'   
	End  
  
	Set @Query = @Query + 'Order By Convert(varchar(12),RM.Request_Date) '
  
	Print @Query  
	Exec (@Query)  
 End  
  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Change_Request_Operation
-- --------------------------------------------------
















    
CREATE Proc [dbo].[USP_Change_Request_Operation] 
    
@Change_ID Char(10),    
@Request_ID Char(10),    
@Project_ID Varchar(50),    
@Phase_ID Char(10),
@Module_ID Char(10),
@Changed_BY Char(10),    
@Changed_Date Datetime,    
@Change_Type Varchar(50),    
@Reason Varchar(100),    
@Other_Reason Varchar(100),    
@Priority_ID Char(20),  
@Expected_EDate Datetime,    
@Description Varchar(500),    
@Attachment Varchar(400),    
@HOD_Approve Char(10),    
@HOD_Approve_Date Datetime,    
@HOD_Remark Varchar(50),    
@Admin_Approve Char(10),    
@Admin_Approve_Date Datetime,    
@Admin_Remark Varchar(50),    
@Request_Status_ID Char(10),    
@Role_ID Char(10),    
@Category_ID Char(10),    
@Option As Char(5)    
    
AS    
    
Begin    
	If(@Option='1') -- Insert into Change_Request_Master    
	Begin    
     
		Set @Project_ID=@Request_ID    
		Set @Request_ID=''    
	        
		If(@Role_ID='PO')
			Set @Request_Status_ID='PBA'

		Select @Request_ID=Request_ID From Project_Master Where Project_ID=@Project_ID    
	      
		Select @Change_ID=dbo.GenerateID('1',rtrim(@Request_ID))    
	        
		If(@Change_type='NR')    
		Begin    
			Insert Into Module_Master Values('',@Module_ID)    
			
			Set @Module_ID=(Select top 1 Module_ID From Module_Master Order By Module_ID DESC)

			Insert Into Project_Details Values (@Project_ID, @Phase_ID, @Module_ID)
		End    

		Insert Into Change_Request_Master    
		Values (@Change_ID, @Request_ID, @Project_ID,@Phase_ID,@Module_ID,@Changed_BY, @Changed_Date, @Change_Type,@Reason,     
			@Other_Reason, @Priority_ID, @Expected_EDate, @Description, @Attachment, @HOD_Approve, @HOD_Approve_Date,    
			@HOD_Remark, @Admin_Approve, @Admin_Approve_Date, @Admin_Remark, '' ,'', @Request_Status_ID)    
	      
		Select @Change_ID    
	      
		Insert Into Change_Request_Details    
		Values ('',@Change_ID, @Request_ID, @Project_ID,@Phase_ID,@Module_ID, @Changed_BY, @Changed_Date, @Change_Type,@Reason,     
			@Other_Reason, @Priority_ID, @Expected_EDate, @Description, @Attachment, @HOD_Approve, @HOD_Approve_Date,    
			@HOD_Remark, @Admin_Approve, @Admin_Approve_Date, @Admin_Remark,'','', @Request_Status_ID)    
		

		--- EMail ---
		If(@Role_ID<>'PO' and @Role_ID<>'PC')
		Begin
			If((Select Role_ID from project_master,Client_Master where project_ID=@Project_ID and Emp_ID=Project_Manager) ='PM')
			Begin
				Select CM.Emp_ID, CM.Emp_Name, CM.EmailAdd, CM.Role_ID  
				From client_Master CM, Project_Master PM
				where PM.Project_ID=@Project_ID and CM.Emp_ID=PM.Project_Manager
			End
			Else If((Select Role_ID from project_master,Client_Master where project_ID=@Project_ID and Emp_ID=Project_Manager) ='PL')
			Begin
				Declare @HOD Char(10)
				
				Select @HOD=CM.HOD From client_Master CM, Project_Master PM
				where PM.Project_ID=@Project_ID and CM.Emp_ID=PM.Project_Manager
			
				Select CM.Emp_ID, CM.Emp_Name, CM.EmailAdd, CM.Role_ID  
				From client_Master CM, Project_Master PM
				where PM.Project_ID=@Project_ID and CM.Emp_ID=PM.Project_Manager		
				
				UNION
				
				Select CM.Emp_ID, CM.Emp_Name, CM.EmailAdd, CM.Role_ID  
				From client_Master CM
				where CM.Emp_ID=@HOD
			End
		End
		Else If(@Role_ID='PO')
		Begin
			Select Cm.Emp_ID, CM.Emp_Name, CM.EmailAdd, CM.Role_ID
			From Client_Master CM
			Where CM.Emp_ID=@Changed_BY
		End
        Else If(@Role_ID='PC')
		Begin
			Select Cm.Emp_ID, CM.Emp_Name, CM.EmailAdd, CM.Role_ID
			From Client_Master CM
			Where CM.Emp_ID=@Changed_BY
					
			Select Cm.Emp_ID, CM.Emp_Name, CM.EmailAdd, CM.Role_ID
			From Client_Master CM
			Where CM.Emp_ID in (Select Employee_ID From Coordinator_Master Where Project_ID=@Project_ID)
				and CM.Emp_ID<>@Changed_BY 
		End
        
        
  End    
 
	Else If(@Option='2') -- Approve BY HOD    
	Begin    
		Update Change_Request_Master    
		Set Request_Status_ID=@Request_Status_ID, HOD_Approve=@HOD_Approve, HOD_Approve_Date=@HOD_Approve_Date,    
			HOD_Remark=@HOD_Remark    
		Where Change_ID=@Change_ID    
      
		Select @Request_ID=Request_ID, @Project_ID=Project_ID,@Phase_ID=Phase_ID, @Module_ID=@Module_ID, @Changed_BY=Changed_BY, @Changed_Date=Changed_Date,    
			@Change_Type=Change_Type, @Reason=Reason, @Other_Reason=Other_Reason,    
			@Priority_ID=Priority_ID, @Expected_EDate=Expected_EDate, @Description=Description, @Attachment=Attachment,     
			@Admin_Approve=Admin_Approve, @Admin_Approve_Date=Admin_Approve_Date, @Admin_Remark=Admin_Remark		
		From Change_Request_Master    
		Where Change_ID=@Change_ID    
      
		Insert Into Change_Request_Details    
		Values ('',@Change_ID, @Request_ID, @Project_ID,@Phase_ID,@Module_ID,@Changed_BY, @Changed_Date, @Change_Type, @Reason,     
			@Other_Reason, @Priority_ID, @Expected_EDate, @Description, @Attachment, @HOD_Approve, @HOD_Approve_Date,    
			@HOD_Remark, @Admin_Approve, @Admin_Approve_Date, @Admin_Remark, '','', @Request_Status_ID)    
       
		Select @Change_ID  

		Select Distinct(Client_Master.EmailADD) as [Requested by Email], Client_Master.Emp_Name
		From Client_Master 
			inner join Change_Request_Master on Change_Request_Master.Changed_BY = Client_Master.Emp_ID
		Where change_ID=@Change_ID

		If(@Request_Status_ID='PBA')
		Begin
			Select CM.EmailAdd As [Manager_Mail]
			From Change_Request_Master CRM, Project_Master PM, Client_Master CM
			Where CRM.Project_ID=PM.Project_ID And PM.Project_Manager=CM.Emp_ID And CRM.Change_ID=@Change_ID
		End
 
	End    
	Else If(@Option='3') -- Approve BY Admin    
	Begin    
		Declare @PM Char(10) 
		Declare @PL Char(10) 
		Declare @Remark Varchar(50)
		Declare @PM_SDate AS Datetime
		Declare @PM_EDate AS Datetime

		Set @PM = @HOD_Approve
		Set @PL= @Changed_BY
		Set @Remark=@HOD_Remark
		
		Set @PM_SDate=null
		Set @PM_EDate=null

		If(@Role_ID = 'AA' or @Role_ID = 'SYA')
		Begin
			Update Change_Request_Master    
			Set Request_Status_ID=@Request_Status_ID, Admin_Approve=@Admin_Approve, Admin_Approve_Date=@Admin_Approve_Date,    
				Admin_Remark=@Admin_Remark    
			Where Change_ID=@Change_ID    
		End
		Else If (@Role_ID='PM')
		Begin
			Set @PM_SDate=@Changed_Date
			Set @PM_EDate=@Expected_EDate

			Update Change_Request_Master    
			Set Request_Status_ID=@Request_Status_ID, Admin_Approve=@HOD_Approve, Admin_Approve_Date=@HOD_Approve_Date,    
				Admin_Remark=@HOD_Remark,PM_SDate=@PM_SDate, PM_EDate=@PM_EDate
			Where Change_ID=@Change_ID  
		End
	
		Select @Request_ID=Request_ID, @Project_ID=Project_ID, @Phase_ID=Phase_ID, @Module_ID=Module_ID,
			@Changed_BY=Changed_BY, @Changed_Date=Changed_Date, @Change_Type=Change_Type, @Reason=Reason, @Other_Reason=Other_Reason,    
			@Priority_ID=Priority_ID, @Expected_EDate=Expected_EDate, @Description=Description, @Attachment=Attachment,     
			@HOD_Approve=HOD_Approve, @HOD_Approve_Date=HOD_Approve_Date, @HOD_Remark=HOD_Remark    
		From Change_Request_Master    
		Where Change_ID=@Change_ID    
      
		Insert Into Change_Request_Details    
		Values ('',@Change_ID, @Request_ID, @Project_ID,@Phase_ID, @Module_ID, @Changed_BY, @Changed_Date, @Change_Type, @Reason,     
			@Other_Reason, @Priority_ID, @Expected_EDate, @Description, @Attachment, @HOD_Approve, @HOD_Approve_Date,    
			@HOD_Remark, @Admin_Approve, @Admin_Approve_Date, @Admin_Remark,@PM_SDate,@PM_EDate, @Request_Status_ID)    
      
		Select @Change_ID   
		
		if(@Request_Status_ID = 'DLG')
		Begin
			Insert Into Delegation_Master (RequestID, ProjectID, DelegateBy, DelegateTo, DelegateDate, Remark, ReqFlag)
			Values(@Change_ID, @Project_ID, @PM, @PL, getdate(), @Remark, 0)   

			Select top 1 DelegateID From Delegation_Master Order By DelegateID DESC
		End 

				

		Select Distinct(Client_Master.EmailADD) as [Requested by Email], Client_Master.Emp_Name
		From Client_Master 
			inner join Change_Request_Master on Change_Request_Master.Changed_BY = Client_Master.Emp_ID
		Where change_ID=@Change_ID

		UNION 

		Select Distinct(Client_Master.EmailADD) as [Requested by Email], Client_Master.Emp_Name
		From Client_Master 
			inner join Change_Request_Master on Change_Request_Master.HOD_Approve = Client_Master.Emp_ID
		Where change_ID=@Change_ID
	End    

  --============================================= Select =============================================    
	  Else If(@Option='21') --Show Change request On Home For PC    
	  Begin    
		Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name, CM.Emp_Name as [Changed_BY] ,Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
			[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
			When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
			CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
			CRM.Description, CRM.Attachment, CRM.HOD_Approve,  Convert(varchar(12),CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
			CRM.Admin_Approve, Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
			ISNULL(CASE When RSM.Request_Status_ID in ('PBH','NCFH','PBA','NCFA','ABA','OHD') Then RSM.Request_Status_Name When RSM.Request_Status_ID in ('PMA') Then 'Request Delegate' End,0) As [Request_Status_Name],
			ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
		From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, 
			Request_Priority_Master RPM, Project_Details PD, Project_Master PRJM,
			Phase_Master PHM, Module_Master MM, Coordinator_Master COM
		Where CRM.Changed_BY=CM.EMP_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID
			and CRM.Priority_ID=RPM.Priority_ID  
			and CRM.Project_ID in (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Changed_BY)
			and CRM.Request_Status_ID not in ('RBH','RBA','C','ACP','DLG','RBP')
	--		and CM.Role_ID='PC'    
	  End    
	  Else If(@Option='22') --Show Change request On Home For PO    
	  Begin 
		Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name, CM.Emp_Name as [Changed_BY] ,Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
			[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
			When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
			CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
			CRM.Description, CRM.Attachment, CRM.HOD_Approve,  Convert(varchar(12),CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
			CRM.Admin_Approve, Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
			ISNULL(CASE When RSM.Request_Status_ID in ('PBH','NCFH','PBA','NCFA','ABA','OHD') Then RSM.Request_Status_Name When RSM.Request_Status_ID in ('PMA') Then 'Request Delegate' End,0) As [Request_Status_Name],
			ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
		From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, 
			Request_Priority_Master RPM, Project_Details PD, Project_Master PRJM,
			Phase_Master PHM, Module_Master MM, Coordinator_Master COM
		Where CRM.Changed_BY=CM.EMP_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID
			and CRM.Priority_ID=RPM.Priority_ID  
			and CRM.Project_ID in (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Changed_BY)
			and CRM.Request_Status_ID not in ('RBH','RBA','C','ACP','DLG','RBP')
--   
--		Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name, CM.Emp_Name as [Changed_BY] ,Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
--		 [Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
--		  When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
--		 CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
--		 CRM.Description, CRM.Attachment, CRM.HOD_Approve,  Convert(varchar(12),CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
--		 CRM.Admin_Approve, Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
--			ISNULL(CASE When RSM.Request_Status_ID in ('PBH','NCFH','PBA','NCFA','ABA','OHD') Then RSM.Request_Status_Name When RSM.Request_Status_ID in ('PMA') Then 'Request Delegate' End,0) As [Request_Status_Name],
--			ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
--		From Change_Request_Master CRM with (nolock), Client_Master CM with (nolock), Request_Status_Master RSM with (nolock), 
--			Request_Priority_Master RPM with (nolock),
--			Project_Master PRJM with (nolock), Phase_Master PHM with (nolock), Module_Master MM with (nolock)
--		Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
--			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID
--			and CRM.Priority_ID=RPM.Priority_ID
--			and (CRM.Changed_BY in (Select Emp_ID From Client_Master Where HOD=@Changed_BY Union Select @Changed_BY)    
--				or CRM.Changed_BY in (Select distinct Employee_ID From Coordinator_Master Where Project_ID in (Select Project_ID From Coordinator_Master Where Employee_ID=@Changed_BY)))   
--			and CRM.Request_Status_ID not in ('RBH','RBA','C','ACP','DLG','RBP')	
				--or (COM.Employee_ID in (Select EMP_ID From Client_Master Where HOD=@Changed_BY union select @Changed_BY) and CRM.Project_ID=COM.Project_ID))
	  End 
	  Else If(@Option='23') --Show Change request On Home For PO (BUT HOD FOR Approval)    
	  Begin    
		Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name, CM.Emp_Name as [Changed_BY] ,Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
		 [Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
		  When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
		 CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
		 CRM.Description, CRM.Attachment, CRM.HOD_Approve, Convert(varchar(12),CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
		 CRM.Admin_Approve,Convert(varchar(12),CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    
		From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
			Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM   
		Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID
			and CRM.Priority_ID=RPM.Priority_ID and 
			(CRM.Changed_BY in (Select Emp_ID From Client_Master Where HOD=@Changed_BY)    
				or CRM.Changed_BY in (Select distinct Employee_ID From Coordinator_Master Where Project_ID in (Select Project_ID From Coordinator_Master Where Employee_ID=@Changed_BY)))
			and CRM.Request_Status_ID in ('PBH','NCFH')    
	  End    
	  Else If(@Option='24') --Show Change request On Home For Admin (BUT Admin FOR Approval)    
	  Begin    
		Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name, CM.Emp_Name as [Changed_BY] ,Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
		 [Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
		  When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
		 CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
		 CRM.Description, CRM.Attachment, CRM.HOD_Approve,Convert(varchar(12),CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
		 CRM.Admin_Approve, Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    
		From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
			Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM   
		Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID 
			and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
			and CRM.Request_Status_ID='PBA'    
	  End    
	  Else If(@Option='25') --Show All Change request On Home For Admin     
	  Begin    
		Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
		 CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
		 [Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
		  When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
		 CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
		 CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
		 Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    
		From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
			Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
		Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
			and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
	  End    
	  Else If(@Option='26')    
	  Begin    
	  Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
			CM.Emp_Name as [Changed_BY] , Convert(varchar(10),Convert(datetime,CRM.Changed_Date),113) as Changed_Date,     
			[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
				When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
		   CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], convert(varchar(10),CONVERT(datetime,CRM.Expected_EDate),113) as Expected_EDate,     
		   CRM.Description, CRM.Attachment, CRM.HOD_Approve, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
		   CRM.Admin_Approve, Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    
	  From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM ,
  			Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM      
	  Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
			and CRM.Priority_ID=RPM.Priority_ID and CRM.Change_ID=@Change_ID    
	  End   
	 Else If(@Option='27')    -- Show change request for project manager
	 Begin   
		If (@Role_ID='PM')
		Begin
			Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
				T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
				Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
				(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
				SSDate, SEDate
			From 
			(
				Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
					(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID)) Then 'TRUE'
					Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
					Request_Priority_Master RPM , Project_Master PM, Module_Master MM
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
					and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
					and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Admin_Approve  and CRM.Module_ID=MM.Module_ID 
					and CRM.Request_Status_ID not in ('PBH','RBH','NCFH')
			) T, Task_Master TSM
			Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID)

			Union

			Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
				T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
				Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
				(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
				SSDate, SEDate
			From 
			(
				Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
					(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID)) Then 'TRUE'
					Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
					Request_Priority_Master RPM , Project_Master PM, Module_Master MM
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
					and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
					and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Admin_Approve  and CRM.Module_ID=MM.Module_ID 
					and CRM.Request_Status_ID not in ('PBH','RBH','NCFH')
			) T, Task_Master TSM
			Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID))


		End
		Else If(@Role_ID='SYA')
		Begin
			Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
				T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
				Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
				(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
				SSDate, SEDate
			From 
			(

			Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
				[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
				When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
				MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
				CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
				Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
				(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
				Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
			From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
				Request_Priority_Master RPM , Project_Master PM, Module_Master MM
			Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
				and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
				and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
				and CRM.Request_Status_ID in ('PBA','NCFA','ABA','ACP','DLG','OHD')
			) T, Task_Master TSM
			Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

			Union

			Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
				T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
				Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
				(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
				SSDate, SEDate
			From 
			(

			Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
				[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
				When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
				MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
				CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
				Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
				(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
				Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
			From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
				Request_Priority_Master RPM , Project_Master PM, Module_Master MM
			Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
				and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
				and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
				and CRM.Request_Status_ID in ('PBA','NCFA','ABA','ACP','DLG','OHD')
			) T, Task_Master TSM
			Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
		End
	End  
	Else If(@Option='28') --Show Change request On Home For Project Manager (BUT Admin FOR Approval)    
	Begin    
		Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
			CM.Emp_Name as [Changed_BY] , CONVERT(varchar(12), CRM.Changed_Date) as Changed_Date,     
			 [Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
			  When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
			 CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], CONVERT(VARCHAR(12),CRM.Expected_EDate) as Expected_EDate,     
			 CRM.Description, CRM.Attachment, CRM.HOD_Approve, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
			 CRM.Admin_Approve, Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    
		From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
		Request_Priority_Master RPM , Project_Master PRJM, Phase_Master PHM, Module_Master MM       
		Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
			and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID
			and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master Where Role_ID in ('PC','PO','AA','SYA'))    
			and CRM.Request_Status_ID in ('PBA','OHD') and PRJM.Request_ID=CRM.Request_ID and PRJM.Project_manager=@Changed_BY   
	End  

	Else If(@Option='29') --Show Change request On Home For Project Leader
	Begin   
	  Select Distinct Project_manager, CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
		 [Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
		  When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
		 MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
		 CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
		 Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated By]     
	  From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,Module_Master MM ,      
		   Request_Priority_Master RPM , Project_Master PRJM, Client_Master DCM, Delegation_Master DM
	  Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
		and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
		and CRM.Project_ID=PRJM.Project_ID and CRM.Module_ID=MM.Module_ID 
		and CRM.Change_ID = DM.RequestID
		and DCM.Emp_ID = DM.DelegateBy and DM.DelegateTO = @Admin_Approve
	--and PRJM.Project_Leader= @Admin_Approve
	End
	Else If(@Option='30') --Show Change request On Home For Project Leader
	Begin   
		
		Select Distinct Project_manager, T.Change_ID, T.Request_ID, Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type], Module_Name, Reason, Other_Reason, [Priority], Expected_EDate,     
				Description, Attachment,HOD_Approve_Date, HOD_Remark, Admin_Approve_Date, 
				Admin_Remark, Request_Status_Name, [Delegated By], [View] ,
				(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
				SSDate, SEDate
		From 
		(
				Select Distinct Project_manager, CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, 
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),
					 MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
					 CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					 Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name, 
					DCM.Emp_Name as [Delegated By],
					(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY =@Admin_Approve) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,Module_Master MM ,      
				   Request_Priority_Master RPM , Project_Master PRJM, Client_Master DCM, Delegation_Master DM
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
					and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
					and CRM.Project_ID=PRJM.Project_ID and CRM.Module_ID=MM.Module_ID 
					and CRM.Change_ID = DM.RequestID
					and DCM.Emp_ID = DM.DelegateBy and DM.DelegateTO =@Admin_Approve
		) T, Task_Master TSM
		Where T.Change_ID=TSM.Change_ID And Assigned_BY =@Admin_Approve

		Union 

		Select Distinct Project_manager, T.Change_ID, T.Request_ID, Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type], Module_Name, Reason, Other_Reason, [Priority], Expected_EDate,     
					 Description, Attachment,HOD_Approve_Date, HOD_Remark, Admin_Approve_Date, 
					Admin_Remark, Request_Status_Name, [Delegated By], [View] ,
					'' AS Deletegated_To, SSDate, SEDate
		From 
		(
				Select Distinct Project_manager, CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, 
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),
					 MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
					 CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					 Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name, 
					DCM.Emp_Name as [Delegated By],
					(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY =@Admin_Approve) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,Module_Master MM ,      
				   Request_Priority_Master RPM , Project_Master PRJM, Client_Master DCM, Delegation_Master DM
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
					and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
					and CRM.Project_ID=PRJM.Project_ID and CRM.Module_ID=MM.Module_ID 
					and CRM.Change_ID = DM.RequestID
					and DCM.Emp_ID = DM.DelegateBy and DM.DelegateTO =@Admin_Approve
		) T, Task_Master TSM
		Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY =@Admin_Approve)
	End
	Else If(@Option='31')
	Begin
		Select RSM.Emp_Name, RSM.Emp_ID
		From Change_Request_Master CRM, Project_Master PM, Resource_Master RSM
		Where CRM.Request_ID=PM.Request_ID And PM.Project_Leader=RSM.Emp_ID
			And CRM.Change_ID=@Change_ID
	End
	Else If(@Option='32')
	Begin
		If(@Role_ID='PM')
		Begin
			Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
				T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
				Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
				(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
				SSDate, SEDate
			From 
			(
				Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
					(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID)) Then 'TRUE'
					Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
					Request_Priority_Master RPM , Project_Master PM, Module_Master MM
				Where CRM.Change_ID=@Change_ID And CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
					and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
					and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Admin_Approve  and CRM.Module_ID=MM.Module_ID 
					and CRM.Request_Status_ID not in ('PBH','RBH','NCFH')
			) T, Task_Master TSM
			Where T.Change_ID=TSM.Change_ID And 
				  Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID)
					
			Union

			Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
				T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
				Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
				(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
				SSDate, SEDate
			From 
			(
				Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
					(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID)) Then 'TRUE'
					Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
					Request_Priority_Master RPM , Project_Master PM, Module_Master MM
				Where CRM.Change_ID=@Change_ID And CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
					and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
					and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Admin_Approve  and CRM.Module_ID=MM.Module_ID 
					and CRM.Request_Status_ID not in ('PBH','RBH','NCFH')
			) T, Task_Master TSM
			Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Admin_Approve Union Select @Admin_Approve As Emp_ID))
		End
		Else If(@Role_ID='SYA')
		Begin
			Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
				[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
				T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
				Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],Delegate_To,
				SSDate, SEDate
			From
			(
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Change_ID=@Change_ID And CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
						and CRM.Request_Status_ID in ('PBA','NCFA','ABA','ACP','DLG','OHD')
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From  Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Change_ID=@Change_ID And CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
						and CRM.Request_Status_ID in ('PBA','NCFA','ABA','ACP','DLG','OHD')
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
			) T
			Where Delegate_To Is NOT NULL
		End
		Else If(@Role_ID='PL')
		Begin
						Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						Delegate_To, Delegated_By, SSDate, SEDate			
			From 
			(
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
							[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
							T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
							Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
							(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
							(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_By From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegated_By,
							SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Admin_Approve Union Select @Admin_Approve As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Change_ID=@Change_ID And CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
						and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Admin_Approve and CRM.Module_ID=MM.Module_ID 
						and CRM.Request_Status_ID not in ('PBH','RBH','NCFH')
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And 
					  Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Admin_Approve Union Select @Admin_Approve As Emp_ID)
						
				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegate_To,
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_By From Task_Master Where Change_ID=T.Change_ID)) End) AS Delegated_By,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, RSM.Request_Status_Name    ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Admin_Approve Union Select @Admin_Approve As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Change_ID=@Change_ID And CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
						and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Admin_Approve and CRM.Module_ID=MM.Module_ID 
						and CRM.Request_Status_ID not in ('PBH','RBH','NCFH')
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Admin_Approve Union Select @Admin_Approve As Emp_ID))
			)T
			Where Delegated_By IS NOT NULL
		End
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Change_Request_Operation_Details
-- --------------------------------------------------






CREATE Proc [dbo].[USP_Change_Request_Operation_Details] 

@Type As Varchar(10),
@Filter As Varchar(100),
@StartDate As Datetime,
@EndDate AS Datetime,
@Emp_ID As Char(20),
@Role As Char(20),
@Option As Int

As
Begin
	Declare @FDate As Datetime
	Declare @EDate As Datetime
	Declare @FirstDate As Datetime
	Declare @LastDate As Datetime
	
	Set @FirstDate = Convert(Varchar(11),Cast('1900-01-01 00:00:00' As Datetime),110)
	Set @LastDate = Convert(Varchar(11),Cast('2999-01-01 00:00:00' As Datetime),110)
	Set @FDate = CONVERT(VARCHAR(11),getdate(),110)

	If(@Role='AA')
	Begin
		If(@Option=1) 
		Begin
			Select Department As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Department, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Department, 
							(Case When (Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID  
					Group BY Department, Request_Status_ID

					Union 

					SELECT Distinct Department,
						'0' As [New Request],
						Count(Change_ID) As [Work In Progress],
						'0' As [Completed],
						'0' As [Burn Down]	
					FROM
					(					
						Select distinct Department, RM.Change_ID,
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(RM.Change_ID) else 0  End) As [WIP]
						From Change_Request_Master RM, Client_Master CM
						Where RM.Changed_BY=CM.Emp_ID  
							And Convert(Varchar(11),RM.PM_EDate,110) >  Convert(Varchar(11),GETDATE(),110)
						Group BY Department, Request_Status_ID,RM.Change_ID
					) T
					WHERE T.WIP>0
					Group BY Department

					Union 

					Select distinct Department, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID  And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
					Group BY Department, Request_Status_ID

--					Union
--
--					Select Distinct Department As Project,'0' As [New Request], '0' As [Work In Progress], '0' As [Completed],
--							'0' As [Burn Down]
--					From Client_Master 

				) Temp
				Group BY Department
			) Test
			Group BY Department
			Order by Total Desc
		End
		Else If(@Option=2)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Project_Name As Project, 
							(Case When (Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Project_Master PM
					Where RM.Project_ID=PM.Project_ID
					Group BY Project_Name, Request_Status_ID

					Union 

					Select Project,NR AS [New Request],Sum(WIP) As [Work In Progress],C As [Completed],BD As [Burn Down]
					From 
					(
						Select distinct Project_Name AS Project, 
								'0' As [NR],
								(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [WIP],
								'0' As [C], 
								'0' As [BD],Request_Status_ID
						From Change_Request_Master RM, Project_Master PM
						Where RM.Project_ID=PM.Project_ID  And Convert(Varchar(11),RM.PM_EDate,110) > @FDate 
						Group BY Project_Name, Request_Status_ID
					) A
					Group BY Project,NR,WIP,C,BD

					Union 

					Select distinct Project_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Project_Master PM
					Where RM.Project_ID=PM.Project_ID  And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
					Group BY Project_Name, Request_Status_ID

					Union

					Select Distinct Project_Name As Project,'0' As [New Request], '0' As [Work In Progress], '0' As [Completed],
							'0' As [Burn Down]
					From Project_Master 
					Where Project_Manager<>'' And Project_Manager Is Not NULL

				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		End
		Else If(@Option=3)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Emp_Name As Project, 
							(Case When (Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Project_ID=PM.Project_ID And PM.Project_Manager=CM.Emp_ID
					Group BY Emp_Name, Request_Status_ID

					Union 

					Select Project,NR AS [New Request],Sum(WIP) As [Work In Progress],C As [Completed],BD As [Burn Down]
					From 
					(
						Select distinct Emp_Name AS Project, 
								'0' As [NR],
								(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [WIP],
								'0' As [C], '0' As [BD],Request_Status_ID
						From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
						Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) > @FDate 
								And PM.Project_Manager=CM.Emp_ID
						Group BY Emp_Name, Request_Status_ID
					) A
					Group BY Project,NR,WIP,C,BD

					Union 

					Select distinct Emp_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
						And PM.Project_Manager=CM.Emp_ID
					Group BY Emp_Name, Request_Status_ID

					Union 
			
					Select Distinct Emp_Name ,'0' As [New Request], '0' As [Work In Progress], '0' As [Completed],
							'0' As [Burn Down]
					From Client_Master
					Where Role_ID in ('PM','SYA')
				
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		End
		Else If(@Option=4) -- Department wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark,
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFH','ABA')
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And CRM.Request_Status_ID in ('C')
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))   
			End
		End	
		Else If(@Option=5) -- Project wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFH','ABA')
					And Upper(PRJM.Project_Name)=Upper(rtrim(@Filter))
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				 Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
					And Upper(PRJM.Project_Name)=Upper(rtrim(@Filter))

			End
			Else If(rtrim(@Type)='C')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('C')
					And Upper(PRJM.Project_Name)=Upper(rtrim(@Filter))
			End
			Else If(rtrim(@Type)='BD')
			Begin
				 Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
					And Upper(PRJM.Project_Name)=Upper(rtrim(@Filter))
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Name)=Upper(rtrim(@Filter))  
			End
		End
		Else If(@Option=6) -- Project Manager wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFH','ABA')
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				 Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 

			End
			Else If(rtrim(@Type)='C')
			Begin
				 Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('C')
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
			End
			Else If(rtrim(@Type)='BD')
			Begin
				 Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
			End
			Else If(rtrim(@Type)='Total')
			Begin
				 Select Distinct CRM.Change_ID, CRM.Request_ID, PRJM.Project_Name, PHM.Phase_Name, MM.Module_Name,
					CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
					[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
					When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
					CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12),CRM.Expected_EDate,113) as Expected_EDate,     
					CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
					Convert(varchar(12), CRM.Admin_Approve_Date,113) as Admin_Approve_Date, CRM.Admin_Remark, 
					ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate,
					RSM.Request_Status_Name
				From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Details PD, Project_Master PRJM, Phase_Master PHM, Module_Master MM       
				Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
					and CRM.Project_ID=PRJM.Project_ID and CRM.Phase_ID=PHM.Phase_ID and CRM.Module_ID=MM.Module_ID   
					and CRM.Priority_ID=RPM.Priority_ID 
					and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter)))  
			End
		End
	End
	--/////////////////////////////////////////////////////////////////////////////////////////////////////////--
	--///////////////////////////////////////////// SYA WIse ///////////////////////////////////////////////////--
	--/////////////////////////////////////////////////////////////////////////////////////////////////////////--
	Else If(@Role='SYA')
	Begin
		If(@Option=7) 
		Begin
			Select Department As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Department, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Department, 
							(Case When (Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID  
					Group BY Department, Request_Status_ID

					Union 

					SELECT Distinct Department,
						'0' As [New Request],
						Count(Change_ID) As [Work In Progress],
						'0' As [Completed],
						'0' As [Burn Down]	
					FROM
					(					
						Select distinct Department, RM.Change_ID,
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(RM.Change_ID) else 0  End) As [WIP]
						From Change_Request_Master RM, Client_Master CM
						Where RM.Changed_BY=CM.Emp_ID  
							And Convert(Varchar(11),RM.PM_EDate,110) >  Convert(Varchar(11),GETDATE(),110)
						Group BY Department, Request_Status_ID,RM.Change_ID
					) T
					WHERE T.WIP>0
					Group BY Department

					Union 

					Select distinct Department, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
					Group BY Department, Request_Status_ID
--
--					Union
--
--					Select Distinct Department As Project,'0' As [New Request], '0' As [Work In Progress], '0' As [Completed],
--							'0' As [Burn Down]
--					From Client_Master 

				) Temp
				Group BY Department
			) Test
			Group BY Department
			Order by Total Desc
		End
		Else If(@Option=8)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Project_Name As Project, 
							(Case When (Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Project_Master PM
					Where RM.Project_ID=PM.Project_ID
					Group BY Project_Name, Request_Status_ID

					Union 

					Select Project,NR AS [New Request],Sum(WIP) As [Work In Progress],C As [Completed],BD As [Burn Down]
					From 
					(
						Select distinct Project_Name AS Project, 
								'0' As [NR],
								(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [WIP],
								'0' As [C], 
								'0' As [BD],Request_Status_ID
						From Change_Request_Master RM, Project_Master PM
						Where RM.Project_ID=PM.Project_ID  And Convert(Varchar(11),RM.PM_EDate,110) > @FDate 
						Group BY Project_Name, Request_Status_ID
					) A
					Group BY Project,NR,WIP,C,BD

					Union 

					Select distinct Project_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Project_Master PM
					Where RM.Project_ID=PM.Project_ID  And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
					Group BY Project_Name, Request_Status_ID

					Union

					Select Distinct Project_Name As Project,'0' As [New Request], '0' As [Work In Progress], '0' As [Completed],
							'0' As [Burn Down]
					From Project_Master 
					Where Project_Manager<>'' And Project_Manager Is Not NULL

				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		End
		Else If(@Option=9)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Emp_Name As Project, 
							(Case When (Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Project_ID=PM.Project_ID And PM.Project_Manager=CM.Emp_ID
					Group BY Emp_Name, Request_Status_ID

					Union 

					Select Project,NR AS [New Request],Sum(WIP) As [Work In Progress],C As [Completed],BD As [Burn Down]
					From 
					(
						Select distinct Emp_Name AS Project, 
								'0' As [NR],
								(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [WIP],
								'0' As [C], '0' As [BD],Request_Status_ID
						From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
						Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) > @FDate 
								And PM.Project_Manager=CM.Emp_ID
						Group BY Emp_Name, Request_Status_ID
					) A
					Group BY Project,NR,WIP,C,BD

					Union 

					Select distinct Emp_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
						And PM.Project_Manager=CM.Emp_ID
					Group BY Emp_Name, Request_Status_ID

					Union 
			
					Select Distinct Emp_Name ,'0' As [New Request], '0' As [Work In Progress], '0' As [Completed],
							'0' As [Burn Down]
					From Client_Master
					Where Role_ID in ('PM','SYA')
				
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		End
		Else If(@Option=10) -- Department wise
		Begin
						If(rtrim(@Type)='NR')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFH','ABA')
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA')
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('C')
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('C')
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),PM.AS_EDate,110) <= @FDate 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID not in ('RBH','RBA','RBP')
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID not in ('RBH','RBA','RBP')
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))  
				) T
				Where Delegate_To Is Not NULL
			End
		End	
		Else If(@Option=11) -- Project wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFH','ABA') And Upper(pm.Project_Name)=Upper(rtrim(@Filter))
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA')
							And Upper(pm.Project_Name)=Upper(rtrim(@Filter))
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL	
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					 Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
							And Upper(pm.Project_Name)=Upper(rtrim(@Filter))  
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID 
							And Upper(PM.Project_Name)=Upper(rtrim(@Filter))   
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL	

			End
			Else If(rtrim(@Type)='C')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
							And Upper(PM.Project_Name)=Upper(rtrim(@Filter))  
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('C')
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID   
							And Upper(PM.Project_Name)=Upper(rtrim(@Filter)) 
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('C')
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL						
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							And Upper(PM.Project_Name)=Upper(rtrim(@Filter))
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							And Upper(PM.Project_Name)=Upper(rtrim(@Filter))
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL						
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							And Upper(PM.Project_Name)=Upper(rtrim(@Filter)) 
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID not in ('RBH','RBA','RBP')
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID 
							And Upper(PM.Project_Name)=Upper(rtrim(@Filter))    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID not in ('RBH','RBA','RBP')
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA')) 
				) T
				Where Delegate_To Is Not NULL	
			End
		End
		Else If(@Option=12) -- Project Manager wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFH','ABA') 
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA')
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL						
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					 Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID 
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL	
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID  
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('C')
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID   
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('C')
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL						
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))
				) T
				Where Delegate_To Is Not NULL						
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') )    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID not in ('RBH','RBA','RBP')
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name    ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA'))) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID 
							and CRM.Priority_ID=RPM.Priority_ID and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))    
							and PM.Request_ID=CRM.Request_ID and PM.Project_manager in (Select  Emp_ID From Resource_Master Where Role_ID in ('PM','SYA'))  and CRM.Module_ID=MM.Module_ID 
							and CRM.Request_Status_ID not in ('RBH','RBA','RBP')
							And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Emp_ID From Resource_Master Where Role_ID in ('PL','PM','SYA','AA')) 
				) T
				Where Delegate_To Is Not NULL				
			End
		End
	End
	--/////////////////////////////////////////////////////////////////////////////////////////////////////////--
	--///////////////////////////////////////////// PM WIse ///////////////////////////////////////////////////--
	--/////////////////////////////////////////////////////////////////////////////////////////////////////////--
	Else If(@Role='PM')
	Begin
		If(@Option=13) 
		Begin
			Select Department As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Department, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Department, 
							(Case When (Request_Status_ID IN ('PBA','NCFA','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID  
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID)
					Group BY Department, Request_Status_ID

					Union 

					SELECT Distinct Department,
						'0' As [New Request],
						Count(Change_ID) As [Work In Progress],
						'0' As [Completed],
						'0' As [Burn Down]	
					FROM
					(					
						Select distinct Department, RM.Change_ID,
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(RM.Change_ID) else 0  End) As [WIP]
						From Change_Request_Master RM, Client_Master CM
						Where RM.Changed_BY=CM.Emp_ID  
							And Convert(Varchar(11),RM.PM_EDate,110) >  Convert(Varchar(11),GETDATE(),110)
							And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID)
						Group BY Department, Request_Status_ID,RM.Change_ID
					) T
					WHERE T.WIP>0
					Group BY Department

					Union 

					Select distinct Department, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID  And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID)
					Group BY Department, Request_Status_ID

				) Temp
				Group BY Department
			) Test
			Group BY Department
			Order by Total Desc
		End
		Else If(@Option=15)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Emp_Name As Project, 
							(Case When (Request_Status_ID IN ('PBA','NCFA','ABA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Project_ID=PM.Project_ID And PM.Project_Manager=CM.Emp_ID
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID)
					Group BY Emp_Name, Request_Status_ID

					Union 

					Select Project,NR AS [New Request],Sum(WIP) As [Work In Progress],C As [Completed],BD As [Burn Down]
					From 
					(
						Select distinct Emp_Name AS Project, 
								'0' As [NR],
								(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [WIP],
								'0' As [C], '0' As [BD],Request_Status_ID
						From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
						Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) > @FDate 
								And PM.Project_Manager=CM.Emp_ID
								And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID)
						Group BY Emp_Name, Request_Status_ID
					) A
					Group BY Project,NR,WIP,C,BD

					Union 

					Select distinct Emp_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('PMA','ACP','DLG','OHD') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
						And PM.Project_Manager=CM.Emp_ID
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID)
					Group BY Emp_Name, Request_Status_ID

					Union 
			
					Select Distinct Emp_Name ,'0' As [New Request], '0' As [Work In Progress], '0' As [Completed],
							'0' As [Burn Down]
					From Client_Master
					Where Role_ID in ('PM','SYA') And Emp_ID=@Emp_ID
				
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		End
		Else If(@Option=16) -- Department wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('PBA','NCFA','ABA')
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('PBA','NCFA','ABA')
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('C') 
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('C') 
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						--And CRM.Request_Status_ID not in ('PBH','NCFH','RBH','RBA') 
						And CRM.Request_Status_ID in ('PBA','NCFA','ABA','PMA','ACP','DLG','OHD','C')
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
						--And CRM.Request_Status_ID in ('PBH','NCFH','RBH','RBA') 
						And CRM.Request_Status_ID in ('PBA','NCFA','ABA','PMA','ACP','DLG','OHD','C')
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
 
			End
		End	
		Else If(@Option=18) -- Project Manager wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('PBA','NCFA','ABA')
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('PBA','NCFA','ABA')
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('C') 
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('C') 
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('PMA','ACP','DLG','OHD') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID     
						and PM.Request_ID=CRM.Request_ID and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID not in ('PBH','NCFH','RBH','RBA') 
				) T, Task_Master TSM
				Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)

				Union

				Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
					SSDate, SEDate
				From 
				(
					Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
						[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
						When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
						MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
						CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
						(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
						(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
						Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
					From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
						Request_Priority_Master RPM , Project_Master PM, Module_Master MM
					Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
						and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
						and PM.Project_manager=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
						and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
						And Upper(PM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
						And CRM.Request_Status_ID in ('PBH','NCFH','RBH','RBA') 
				) T, Task_Master TSM
				Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Manager=@Emp_ID Union Select @Emp_ID As Emp_ID))
			End
		End
	End
	--/////////////////////////////////////////////////////////////////////////////////////////////////////////--
	--///////////////////////////////////////////// PL WIse ///////////////////////////////////////////////////--
	--/////////////////////////////////////////////////////////////////////////////////////////////////////////--
	Else If(@Role='PL')
	Begin
		If(@Option=19) 
		Begin
			Select Department As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Department, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(
					Select distinct Department, 
							'0' As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID  
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
					Group BY Department, Request_Status_ID

					Union

					Select distinct Department,
							(Case When (Request_Status_ID IN ('DLG')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID And RM.Request_Status_ID IN ('DLG') 
						And Convert(Varchar(11),RM.PM_EDate,110) >  Convert(Varchar(11),GETDATE(),110)
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
						And RM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					Group BY Department, Request_Status_ID

					Union 

					SELECT Distinct Department,
						'0' As [New Request],
						Count(Change_ID) As [Work In Progress],
						'0' As [Completed],
						'0' As [Burn Down]	
					FROM
					(					
						Select distinct Department, RM.Change_ID,
							(Case When Request_Status_ID IN ('DLG') Then Count(RM.Change_ID) else '0'  End) As [WIP]
						From Change_Request_Master RM, Client_Master CM
						Where RM.Changed_BY=CM.Emp_ID And Request_Status_ID IN ('DLG') 
							And Convert(Varchar(11),RM.PM_EDate,110) >  Convert(Varchar(11),GETDATE(),110)
							And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
							And RM.Change_ID in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
						Group BY Department, Request_Status_ID,RM.Change_ID
					) T
					WHERE T.WIP>0
					Group BY Department

					Union 

					Select distinct Department, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('DLG') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Client_Master CM
					Where RM.Changed_BY=CM.Emp_ID  And Request_Status_ID IN ('DLG')
						And Convert(Varchar(11),RM.PM_EDate,110) <= Convert(Varchar(11),getdate(),110) 
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
						
					Group BY Department, Request_Status_ID

				) Temp
				Group BY Department
			) Test
			Group BY Department
			Order by Total Desc
		End
		Else If(@Option=20)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(
					Select distinct Emp_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
					Where RM.Project_ID=PM.Project_ID And PM.Project_Leader=CM.Emp_ID
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
					Group BY Emp_Name, Request_Status_ID

					Union 

					Select distinct Emp_Name As Project, 
							(Case When (Request_Status_ID IN ('DLG')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							'0' As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
					Where RM.Project_ID=PM.Project_ID And PM.Project_Leader=CM.Emp_ID And RM.Request_Status_ID IN ('DLG')
						And Convert(Varchar(11),RM.PM_EDate,110) > @FDate 
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
						And RM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					Group BY Emp_Name, Request_Status_ID

					Union 

					Select Project,NR AS [New Request],Sum(WIP) As [Work In Progress],C As [Completed],BD As [Burn Down]
					From 
					(
						Select distinct Emp_Name AS Project, 
								'0' As [NR],
								(Case When Request_Status_ID IN ('DLG') Then Count(Request_Status_ID) else 0  End) As [WIP],
								'0' As [C], '0' As [BD],Request_Status_ID
						From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
						Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) > @FDate 
								And PM.Project_Leader=CM.Emp_ID And RM.Request_Status_ID IN ('DLG')
								And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
								And RM.Change_ID in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
						Group BY Emp_Name, Request_Status_ID
					) A
					Group BY Project,NR,WIP,C,BD

					Union 

					Select distinct Emp_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('DLG') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Change_Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
					Where RM.Project_ID=PM.Project_ID And Convert(Varchar(11),RM.PM_EDate,110) <= @FDate 
						And PM.Project_Leader=CM.Emp_ID And RM.Request_Status_ID IN ('DLG')
						And RM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID)
					Group BY Emp_Name, Request_Status_ID

			
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		End
		Else If(@Option=21) -- Department wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('DLG')
							And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL				
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And CRM.Change_ID in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And CRM.Change_ID in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL	
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('C') 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('C') 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T 
				Where Delegate_To Is NOT NULL
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) <= @FDate 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
					And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From 
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID not in ('DLG','C') 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
							And CRM.Request_Status_ID in ('DLG','C') 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
					And TSM.Assigned_BY=@Emp_ID
				) T 
				Where Delegate_To IS NOT NULL
 			End
		End	
		Else If(@Option=22) -- Project Manager wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate    
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('DLG')  
							And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('DLG')
							And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) > @FDate
							And CRM.Change_ID in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					) T, Task_Master TSM
					Where T.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL And Delegate_To<>''
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('C') 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('C') 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) <= COnvert(Varchar(11),getdate(),110) 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('DLG') And Convert(Varchar(11),CRM.PM_EDate,110) <= COnvert(Varchar(11),getdate(),110) 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
					[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
					T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
					Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
					Delegate_To, SSDate, SEDate
				From
				(
					Select T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View],ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID     
							and PM.Request_ID=CRM.Request_ID and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID not in ('DLG','C') 
					) T, Task_Master TSM
					Where T.Change_ID=TSM.Change_ID And Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)

					Union

					Select distinct T.Change_ID, T.Request_ID, T.Project_Name, [Changed_BY] , Changed_Date,     
						[Change_Type],T.Module_Name, T.Reason, T.Other_Reason, [Priority], Expected_EDate,     
						T.Description, T.Attachment, HOD_Approve_Date, T.HOD_Remark,     
						Admin_Approve_Date, T.Admin_Remark, T.Request_Status_Name , [View],
						(Case When T.Change_ID=TSM.Change_ID Then (Select Emp_Name From Resource_Master Where Emp_ID in (Select top 1 Assigned_To From Task_Master Where Change_ID=T.Change_ID)) Else '' End) AS Delegate_To,
						SSDate, SEDate
					From 
					(
						Select CRM.Change_ID, CRM.Request_ID, PM.Project_Name, CM.Emp_Name as [Changed_BY] , Convert(varchar(12),CRM.Changed_Date,113) as Changed_Date,     
							[Change_Type]=(Case When CRM.Change_Type='NR' Then 'New Requirement'    
							When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),     
							MM.Module_Name, CRM.Reason, CRM.Other_Reason, RPM.Priority_Name As [Priority], Convert(varchar(12), CRM.Expected_EDate,113) as Expected_EDate,     
							CRM.Description, CRM.Attachment, Convert(varchar(12), CRM.HOD_Approve_Date,113) as HOD_Approve_Date, CRM.HOD_Remark,     
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '1900-01-01 00:00:00.000' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then Convert(varchar(12), CRM.Admin_Approve_Date,113) End) as Admin_Approve_Date,
							(Case When (Admin_Approve='' Or Admin_Approve IS NULL) Then '' When (Admin_Approve<>'' And Admin_Approve IS NOT NULL) Then CRM.Admin_Remark	End) as Admin_Remark, RSM.Request_Status_Name ,
							(Case When CRM.Change_ID in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID)) Then 'TRUE'
							Else 'FALSE' End) As [View], ISNULL(Convert(varchar(12),CRM.PM_SDate,113),'') as  SSDate, ISNULL(Convert(Varchar(12),CRM.PM_EDate,113),'') As SEDate
						From Change_Request_Master CRM, Client_Master CM, Request_Status_Master RSM,   
							Request_Priority_Master RPM , Project_Master PM, Module_Master MM
						Where CRM.Changed_BY=CM.Emp_ID and CRM.Request_Status_ID=RSM.Request_Status_ID    
							and CRM.Priority_ID=RPM.Priority_ID and PM.Request_ID=CRM.Request_ID 
							and PM.Project_Leader=@Emp_ID  and CRM.Module_ID=MM.Module_ID 
							and CRM.Changed_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
							And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
							And CRM.Request_Status_ID in ('DLG','C') 
					) T, Task_Master TSM
					Where T.Change_ID not in (Select Change_ID From Task_Master Where Assigned_BY in (Select Emp_ID From Resource_Master Where Role_ID='PL' and Project_Leader=@Emp_ID Union Select @Emp_ID As Emp_ID))
						And TSM.Assigned_BY=@Emp_ID
				) T
				Where Delegate_To IS NOT NULL
			End
		End
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Change_request_Report
-- --------------------------------------------------










CREATE Procedure [dbo].[usp_Change_request_Report] 
(
@Change_ID Char(20),  
@Request_ID Char(20),  
@Phase_ID Char(10),
@Module_ID Char(10),
@Project_ID Char(20),  
@Request_Status_ID Char(20),  
@Dept Char(20),  
@SDate varchar(25),  
@EDate varchar(25), 
@PL Varchar(20), 
@EMPID char(20),
@Role char(20),
@Option Char(5) 
)
as

Begin  
 Declare @Query varchar(max)  
   

 if(@Option = '1')  
 Begin  
  set @Query = 'Select CRM.Change_ID as [ChangeID], PRJM.Project_Name as [Project],
					TYPE=ISNULL(Case When CRM.Change_Type=''NR'' Then ''New Requirement'' When CRM.Change_Type=''CER'' Then ''Change In Existing Requirement'' END , 0),
					PHM.Phase_Name As [Phase],MM.Module_Name As [Module],  
					Reason=Isnull(CASE When CRM.Reason=''BS'' Then ''Business'' When CRM.Reason=''PT'' Then ''Performance Tuning'' When CRM.Reason=''DF'' Then ''Defect'' End, 0),
					RPM.Priority_Name as [Priority], CM.emp_Name as [RequestBy],
					Convert(varchar(12),CRM.Changed_Date) As [RequestOn],  
					Convert(varchar(12),CRM.Expected_EDate) As [EndDate],
					CRM.HOD_Remark As [HODRemark], CRM.Admin_Remark AS [AdminRemark], 
					(Case When PRJM.Project_Manager<>'''' Then (Select Emp_Name From Resource_Master Where Emp_ID=PRJM.Project_Manager)
						Else '''' End) AS [Project Manager], 
					(Case When PRJM.Project_Leader<>'''' Then (Select Emp_Name From Resource_Master Where Emp_ID=PRJM.Project_Leader)
					Else '''' End) AS [Project Leader], 
					RSM.Request_Status_Name as Status
				From Change_Request_Master CRM with (nolock)
					Join Client_Master CM with (nolock) on CRM.Changed_By=CM.Emp_ID
					Join Project_Master PRJM with (nolock) on CRM.Request_ID=PRJM.Request_ID
					Join Request_Status_Master RSM with (nolock) on CRM.Request_Status_ID=RSM.Request_Status_ID
					Join Request_Priority_Master RPM with (nolock) on CRM.Priority_ID=RPM.Priority_ID
					Join Phase_Master PHM with (nolock) On CRM.Phase_ID=PHM.Phase_ID
					join Module_Master MM with (nolock) On CRM.Module_ID=MM.Module_ID
				Where CRM.Changed_By=CM.Emp_ID '

 If(@Change_ID <> '')  
  Begin  
   set @Query = @Query + 'And CRM.Change_ID = ''' + ltrim(rtrim(@Change_ID)) + ''''  
  End 

 If(@Request_ID <> '')  
  Begin  
   set @Query = @Query + 'And CRM.Request_ID = ''' + ltrim(rtrim(@Request_ID)) + ''''  
  End  
   
  If(@Request_Status_ID <> '')  
  Begin  
   set @Query = @Query + 'And CRM.Request_Status_ID = ''' + ltrim(rtrim(@Request_Status_ID)) + ''''  
  End  

 If(@Project_ID <> '')  
  Begin  
   set @Query = @Query + 'And PRJM.Project_ID = ''' + ltrim(rtrim(@Project_ID)) + ''''  
  End  

	If(@SDate <> '')  
	Begin  
		set @Query = @Query + 'And CRM.Changed_Date between convert(datetime,ltrim(rtrim('''+ @SDate + ''')),101) and DATEADD(dd,1,convert(datetime,ltrim(rtrim(''' + @EDate + ''')),101))'   
	End 

	If(@PL<>'')
	Begin
		If (@Role='AA' or @Role ='SYA')
		Begin
			Set @Query = @Query + ' And PRJM.Project_Manager= '''+ rtrim(@PL) +''''  
		END
		ELSE If (@Role='PM' or @Role='PL')
		Begin
			Set @Query = @Query + ' And PRJM.Project_Leader= '''+ rtrim(@PL) +''''  
		End
	End

	if(@Dept <> '')
	Begin
		if(@Role = 'AA' OR @Role = 'SYA')
		Begin 
			Set @Query = @Query + 'And CM.Department = ''' + ltrim(rtrim(@Dept)) + ''''  
		End
		Else If (@Role='PM')
		Begin
			Set @Query = @Query + 'And CM.Department = ''' + ltrim(rtrim(@Dept)) + ''' And PRJM.Project_Manager= '''+ rtrim(@EMPID) +''''  
		END
		Else If (@Role='PL')
		Begin
			Set @Query = @Query + 'And CM.Department = ''' + ltrim(rtrim(@Dept)) + ''' And PRJM.Project_Leader= '''+ rtrim(@EMPID) +''''  
		End
		If(@Role='PO')
		Begin
			Set @Query = @Query + 'And (CRM.Changed_By = ''' + ltrim(rtrim(@Dept)) + '''or CRM.Changed_By in (	Select Employee_ID From Coordinator_Master where Request_ID = '''+ rtrim(@Request_ID) +'''))' 
		End
		If(@Role='C')
		Begin
			Set @Query = @Query + 'And CRM.Changed_By = ''' + rtrim(@Dept) + ''''
		End
		If(@Role='PC')
		Begin
			Set @Query = @Query + 'And CRM.Changed_By in (Select distinct Employee_ID From Coordinator_Master Where Project_ID in 
				( Select Project_ID From Coordinator_Master Where Employee_ID=''' + rtrim(@Dept) + ''')) 
				And CRM.Project_ID in (Select Project_ID From Coordinator_Master Where Employee_ID=''' + rtrim(@Dept) +  ''')'
		End
	End
	Else if(@Dept='')
	Begin
		If (@Role='PM')
		Begin
			Set @Query = @Query + ' And PRJM.Project_Manager= '''+ rtrim(@EMPID) +''''  
		END
		ELSE If (@Role='PL')
		Begin
			Set @Query = @Query + ' And PRJM.Project_Leader= '''+ rtrim(@EMPID) +''''  
		End
		If(@Role='PO')
		Begin
			if(@Request_ID <> '')
				Set @Query = @Query + 'And (CRM.Changed_By = ''' + ltrim(rtrim(@EMPID)) + ''' or CRM.Changed_By in (Select Employee_ID From Coordinator_Master where Request_ID = '''+ rtrim(@Request_ID) +'''))' 
			else If(@Project_ID <> '')
				Set @Query = @Query + 'And (CRM.Changed_By = ''' + ltrim(rtrim(@EMPID)) + ''' or CRM.Changed_By in (Select Employee_ID From Coordinator_Master where Project_ID = '''+ rtrim(@Project_ID) +'''))' 
			else 
				Set @Query = @Query + 'And (CRM.Changed_By = ''' + ltrim(rtrim(@EMPID)) + ''' or CRM.Changed_By in (Select Employee_ID From Coordinator_Master where Project_ID = '''+ rtrim(@Project_ID) +'''))' 
		End
		If(@Role='PC' Or @Role='C')
		Begin
			Set @Query = @Query + 'And CRM.Changed_By = ''' + rtrim(@EMPID) + ''''
		End
	End
	
	Set @Query = @Query + 'Order by Changed_Date,[ChangeID], [Project], TYPE, [Phase], [Module], Reason, [Priority], [RequestBy], [RequestOn], [EndDate],Status   '
  Print @Query  
  Exec (@Query)   
 End  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Change_Request_Report_Mahen
-- --------------------------------------------------


CREATE Proc [dbo].[USP_Change_Request_Report_Mahen]

@Change_ID Char(20),
@Request_ID Char(20),  
@Project_Code Char(20),  
@Request_Status_ID Char(20),  
@Resource Char(20),  
@SDate Datetime,  
@EDate Datetime,  
@EMPID char(20),
@Role char(20),
@Option Char(5)  

As
Begin
	Declare @Query Varchar(MAX)
--	If(@Role='PC' or @Role='PO')
--	Begin
	If(@Option='1')
	Begin
		Set @Query='Select CRM.Change_ID as [Change ID], CRM.Request_ID as [Request ID], PM.Project_Name as [Project Name], CM.Employee_Name as [Changed By],
				Convert(varchar(12),CRM.Changed_Date) As [Changed On], Convert(varchar(12),CRM.Expected_EDate) As [Expected End Date], CRM.Module_Name as [Module Name],
				RPM.Priority_Name as [Priority Name], CRM.Description, isnull(HOD.Employee_Name, '''') as [HOD Approve], Convert(varchar(12),CRM.HOD_Approve_Date) As [HOD Approve Date],
				CRM.HOD_Remark as [HOD Remark], isnull(ADM.Employee_Name, '''') as [ADM Approve], Convert(varchar(12), CRM.Admin_Approve_Date) As [Admin Approve Date],
				CRM.Admin_Remark as [Admin Remark], RSM.Request_Status_Name   
			From Change_Request_Master CRM
				inner join Project_Master PM on CRM.Request_ID = PM.Request_ID  
				inner join Client_Master HOD on HOD.Employee_ID = CRM.HOD_Approve 
				inner join Client_Master ADM on ADM.Employee_ID = CRM.Admin_Approve 
				Join Request_Priority_Master RPM On CRM.Priority_ID = RPM.Priority_ID
				Join Request_Status_Master RSM On CRM.Request_Status_ID = RSM.Request_Status_ID  
				Join Client_Master CM On CRM.Changed_BY = CM.Employee_ID
			Where '
			

		If(@Change_ID <> '')  
		Begin  
			Set @Query = @Query + 'And CRM.Change_ID = ''' + ltrim(rtrim(@Change_ID)) + ''''  
		End 

		If(@Request_ID <> '')  
		Begin  
			Set @Query = @Query + 'And CRM.Request_ID = ''' + ltrim(rtrim(@Request_ID)) + ''''  
		End  
	   
		If(@Request_Status_ID <> '')  
		Begin  
			Set @Query = @Query + 'And CRM.Request_Status_ID = ''' + ltrim(rtrim(@Request_Status_ID)) + ''''  
		End  

		If(@Project_Code <> '')  
		Begin  
			Set @Query = @Query + 'And PM.Project_Code = ''' + ltrim(rtrim(@Project_Code)) + ''''  
		End  

		If(@SDate <> '')  
		Begin  
			Set @Query=@Query + ' and LEFT(CRM.Changed_Date,11) between LEFT(Convert(Datetime, ''' + @SDate + '''),11) and LEFT(Convert(Datetime, ''' + @EDate + '''),11)'  
		End 

		If(@Role <> '')
		Begin
			If(@Role = 'PC')
			Begin 
				Set @Query = @Query + 'And CRM.Changed_By = ''' + ltrim(rtrim(@Resource)) + ''''  
			End
			Else If(@Role = 'PO')
			Begin
				Set @Query = @Query + 'And CRM.Changed_By in (Select Employee_ID From Client_Master Where HOD= '''+ @EMPID +''')'
			End
		End
	End

	Print @Query  
	Exec (@Query) 

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Change_Role
-- --------------------------------------------------






CREATE Proc [dbo].[USP_Change_Role]

@RID Char(20),
@Option Char(5)

As 
Begin
	If(@Option=1)
	Begin
		Declare @Role Char(10)
		Declare @EMPID Char(10)
		Declare @HOD Char(10)

		Select @Role=Role_ID From Client_Master Where Emp_ID in (Select Requested_BY From Request_Master Where Request_ID=@RID)
		Select @EMPID=Requested_BY From Request_Master Where Request_ID=@RID
		Select @HOD=HOD From Client_Master Where Emp_ID=@EMPID

		If(@Role='C')
		Begin
			Update Client_Master
			Set Role_ID='PC'
			Where Emp_ID=@EMPID

			Update Client_Master
			Set Role_ID='PO'
			Where Emp_ID=@HOD

--			Update Client_Master
--			Set Role_ID='PC'
--			Where Emp_ID=(Select Requested_BY From Request_Master Where Request_ID=@RID)
--
--			Update Client_Master
--			Set Role_ID='PO'
--			Where Emp_ID=(Select HOD_Approve From Request_Master Where Request_ID=@RID)
		End
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ChangeRequest_TotalReport_Admin
-- --------------------------------------------------







CREATE PROC [dbo].[USP_ChangeRequest_TotalReport_Admin]

@Range As Char(10),
@Department As Varchar(100),
@Owner As Varchar(20),
@PM As Varchar(20),
@Option As Int

As 

Begin

	Declare @FromDate As Datetime
	Declare @EndDate As Datetime
	
	If(@Range='Current')
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End
	Else IF(@Range='Last')
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())),getdate()),110)
		Set @Fromdate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(@FromDate)-1),@FromDate),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())),getdate()),110)
	End
	Else IF(@Range='ALL')
	Begin
		Set @FromDate = Convert(Varchar(12),Cast('01/01/2010 00:00:00' As Datetime),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End

	Print @FromDate
	Print @EndDate	

	If((Select Table_Name From Information_Schema.Tables Where Table_Name='AdminCReport_Temp')='AdminCReport_Temp')
	Begin
		Drop Table AdminCReport_Temp
	End

	If(@Option = 1) --  Only Date Wise 
	Begin
		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminCReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					When Request_Status_ID IS Not NULL And Request_Status_ID<>'' Then Count(Request_Status_ID)
					 End ), '') As 'Total'
			From Change_Request_Master RM
			Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Change_Request_Master RM
					Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=2) -- Date wise, Department Wise
	Begin
		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminCReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Change_Request_Master RM
			Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
				And RM.Changed_By in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('PC','PO'))
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Change_Request_Master RM
					Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
						And RM.Changed_By in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('PC','PO'))
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp
	End
------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=3) -- Date wise, Owner Approved wise
	Begin
		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminCReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Change_Request_Master RM
			Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
				And RM.HOD_Approve=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Change_Request_Master RM
					Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
						And RM.HOD_Approve=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp
	End
	------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=4) -- Date wise, Department Wise, Owner Approved wise
	Begin
		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminCReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Change_Request_Master RM
			Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
				And RM.Changed_By in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('PO'))
				And RM.HOD_Approve=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Change_Request_Master RM
					Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
						And RM.Changed_By in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('PO'))
						And RM.HOD_Approve=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=5) -- Date wise, Requester Wise
	Begin
		Select Temp.Request_Status_ID  As [Status], Temp.Total
		Into AdminCReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Change_Request_Master RM
			Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
				And RM.Changed_By=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Change_Request_Master RM
					Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
						And RM.Changed_By=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
	------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=6) -- Date wise, Department Wise, Owner and its Coordinator wise
	Begin
		Select Temp.Request_Status_ID  As [Status], Temp.Total
		Into AdminCReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Change_Request_Master RM
			Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
				And RM.Changed_By=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Change_Request_Master RM
					Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
						And RM.Changed_By=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
---------///////////////////////////////////////////////////////////////////////////////////////////------------
	Else If(@Option=7)
	Begin
		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminCReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					When Request_Status_ID IS Not NULL And Request_Status_ID<>'' Then Count(Request_Status_ID)
					 End ), '') As 'Total'
			From Change_Request_Master RM
			Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
				And Request_ID in (Select Request_ID From Project_Master Where Project_Manager in 
									(Select Emp_ID From Client_Master Where Role_ID in ('PM','SYA') and Emp_ID=@PM ))
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Change_Request_Master RM
					Where Convert(Varchar(12),Changed_Date,110) Between Convert(Varchar(12),@FromDate,110) And Convert(Varchar(12),@EndDate,110)
						And Request_ID in (Select Request_ID From Project_Master Where Project_Manager in 
									(Select Emp_ID From Client_Master Where Role_ID in ('PM','SYA') and Emp_ID=@PM ))
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End

	If((Select Table_Name From Information_Schema.Tables Where Table_Name='AdminCReport_Temp')='AdminCReport_Temp')
	Begin
		Select distinct Status, Temp, Total
		From 
		(
		Select (Case When Status='PBH' Then 'Pending By Owner'
				  When Status='NCFH' Then 'Need Clarification For Owner'
				  When Status='PBA' Then 'Pending By Admin'
				  When Status='NCFA' Then 'Need Clarification For Admin'
				  When Status='ABA' Then 'Project Pending For Assign'
				  When Status ='PMA' Then 'Assign To Project Manager'
				  When Status in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When Status='C' Then 'Complete'
				End
			) As [Status], 
			(Case When Status='PBH' Then 'A'
				  When Status='NCFH' Then 'B'
				  When Status='PBA' Then 'C'
				  When Status='NCFA' Then 'D'
				  When Status='ABA' Then 'E'
				  When Status ='PMA' Then 'F'
				  When Status in ('ACP','DLG') Then 'G'
				  When Status='C' Then 'H'
				End
			) As [Temp]
			, (Case When Status='PBH' Then (Select Total From AdminCReport_Temp Where Status='PBH')
				  When Status='NCFH'  Then (Select Total From AdminCReport_Temp Where Status='NCFH')
				  When Status='PBA'  Then (Select Total From AdminCReport_Temp Where Status='PBA')
				  When Status='NCFA'  Then (Select Total From AdminCReport_Temp Where Status='NCFA')
				  When Status='ABA'  Then (Select Total From AdminCReport_Temp Where Status='ABA')
				  When Status ='PMA'  Then (Select Total From AdminCReport_Temp Where Status='PMA')
				  When Status in ('ACP','DLG') Then (Select Total From AdminCReport_Temp Where Status='ACP') + (Select Total From AdminCReport_Temp Where Status='DLG')
				  When Status='C' Then (Select Total From AdminCReport_Temp Where Status='C')
				End
			) As Total
		From AdminCReport_Temp

		Union

		Select 'TOTAL' As Status, 'I' AS Temp, Sum(Total) From AdminCReport_Temp

		) Test
		Order By Temp
	End 

	Drop Table AdminCReport_Temp
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_ChangeRequest_TotalReport_Admin_Details
-- --------------------------------------------------





CREATE proc [dbo].[USP_ChangeRequest_TotalReport_Admin_Details]


@Range As Char(10),
@Department As Varchar(100),
@Owner As Varchar(20),
@PM As Varchar(20),
@Status As Varchar(50),
@Option As Int

As
Begin
	
	Declare @FromDate As Datetime
	Declare @EndDate As Datetime
	
	If(@Range='Current')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End
	Else IF(@Range='Last')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),110)
		Set @Fromdate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(@FromDate)-1),@FromDate),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),110)
	End
	Else IF(@Range='ALL')
	Begin
		Set @FromDate = Convert(Varchar(11),Cast('1900-01-01 00:00:00' As Datetime),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End

	Print @FromDate
	Print @EndDate	

	If(@Option=1) -- Period - NO Other Condition 
	Begin
			
		Select RM.Change_ID As CID, RM.Request_ID AS RID, PM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Changed_By,
			RM.Changed_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Change_Request_Master RM, Request_Priority_Master PRM, Project_Master PM,
			(Select Emp_ID, Emp_Name From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Changed_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Changed_By=CM.Emp_ID 
			And RM.Project_ID=PM.Project_ID
			And RM.Request_Status_ID in (@Status)
	End
	Else If(@Option=2) -- Period , Department - NO Other Condition 
	Begin
		Select RM.Change_ID As CID, RM.Request_ID AS RID, PM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Changed_By,
			RM.Changed_Date As Req_SDate, Expected_EDate As Req_EDate,  
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Change_Request_Master RM, Request_Priority_Master PRM,
			Project_Master PM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Changed_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Changed_By=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.Project_ID=PM.Project_ID
			And CM.Department=@Department
	End
	Else If(@Option=3) -- Period , Owner - NO Other Condition 
	Begin
		Select RM.Change_ID As CID, RM.Request_ID AS RID, PM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Changed_By,
			RM.Changed_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Change_Request_Master RM, Request_Priority_Master PRM,
			 Project_Master PM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Changed_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Changed_By=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.Project_ID=PM.Project_ID
			And RM.HOD_Approve=@Owner
	End
	Else If(@Option=4) -- Period , Department,  Owner  - NO Other Condition 
	Begin
		Select RM.Change_ID As CID, RM.Request_ID AS RID, PM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Changed_By,
			RM.Changed_Date As Req_SDate, Expected_EDate As Req_EDate,  
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Change_Request_Master RM, Request_Priority_Master PRM
			, Project_Master PM , (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Changed_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Changed_By=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.HOD_Approve=@Owner
			And RM.Project_ID=PM.Project_ID
			And CM.Department=@Department
	End
	Else If(@Option=5) -- Period , Requester - NO Other Condition 
	Begin
		Select RM.Change_ID As CID, RM.Request_ID AS RID, PM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Changed_By,
			RM.Changed_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Change_Request_Master RM, Request_Priority_Master PRM
			, Project_Master PM , (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Changed_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Changed_By=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.Project_ID=PM.Project_ID
			And RM.Changed_By=@Owner
	End
	Else If(@Option=6) -- Period , Department,  Requester  - NO Other Condition 
	Begin
		Select RM.Change_ID As CID, RM.Request_ID AS RID, PM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Changed_By,
			RM.Changed_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Change_Request_Master RM, Request_Priority_Master PRM
				, Project_Master PM , (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Changed_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Changed_By=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.Changed_By=@Owner
			And RM.Project_ID=PM.Project_ID
			And CM.Department=@Department
	End
	Else If(@Option=7) -- Period , Manager  - NO Other Condition 
	Begin
		Select RM.Change_ID As CID, RM.Request_ID AS RID, PM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Changed_By,
			RM.Changed_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Change_Request_Master RM, Request_Priority_Master PRM
				, Project_Master PM , (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Changed_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Changed_By=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.Project_ID=PM.Project_ID
			And RM.Request_ID in (Select Request_ID From Project_Master Where Project_Manager in 
					(Select Emp_ID From Client_Master Where Role_ID in ('PM','SYA') and Emp_ID=@PM ))
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_checkEmp
-- --------------------------------------------------








    
CREATE proc [dbo].[Usp_checkEmp]    
 @ASDV varchar(50),    
 @AEDV varchar(50),  
 @Emp_ID varchar(50),
 @Developer char(5),
 @PL char(5),
 @PM char(5),
 @ProjectName varchar(50)    
    
As     
Begin    
	 Declare @AED DateTime    
	 Declare @ASD DateTime    
	 Set @ASD= Cast(@ASDV As Datetime)     
	 Set @AED= Cast(@AEDV As Datetime)     

	 if(@ProjectName <> '') 
		  Select @Emp_ID = Project_Manager From Project_Master where Project_ID = @ProjectName

	if(@Developer = '' AND @PL = '' AND @PM = '')
	Begin   
		If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'AA')
		Begin
			 Select Emp_ID As [EmpID],    
				 Emp_Name As [Name] From Resource_Master--Client_Master    
			 Where Role_ID In ('DVL','PL','PM') And Active_status='1'
				 and Emp_ID Not In (    
				Select Assigned_To from Task_master     
				Where (@ASD Between AS_SDT And AS_EDT Or    
					@AED Between AS_SDT And AS_EDT Or    
					AS_SDT Between @ASD And @AED Or    
					AS_EDT Between @ASD And @AED) Or     
					@ASD=AS_SDT Or    
					@AED=AS_EDT)  
			Order By [Name]	
		End 
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'SYA')
		Begin
			 Select Emp_ID As [EmpID],    
				 Emp_Name As [Name] From Resource_Master--Client_Master    
			 Where Role_ID In ('DVL','PL','PM') And Active_status='1'
				 and Emp_ID Not In (    
				Select Assigned_To from Task_master     
				Where (@ASD Between AS_SDT And AS_EDT Or    
					@AED Between AS_SDT And AS_EDT Or    
					AS_SDT Between @ASD And @AED Or    
					AS_EDT Between @ASD And @AED) Or     
					@ASD=AS_SDT Or    
					@AED=AS_EDT)  
			Order By [Name]
		End 
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'PM')
		Begin
			 Select Emp_ID As [EmpID],    
				 Emp_Name As [Name] From Resource_Master--Client_Master    
			 Where ((Role_ID In ('DVL','PL') And Project_Manager = @Emp_ID) 
				   OR Emp_ID=@Emp_ID) And Active_status='1'
				  and Emp_ID Not In (    
				Select Assigned_To from Task_master     
				Where (@ASD Between AS_SDT And AS_EDT Or    
					@AED Between AS_SDT And AS_EDT Or    
					AS_SDT Between @ASD And @AED Or    
					AS_EDT Between @ASD And @AED) Or     
					@ASD=AS_SDT Or    
					@AED=AS_EDT)  
			 Order By [Name]
		End 
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID)='PL')
		Begin
			 Select Emp_ID As [EmpID],    
				 Emp_Name As [Name] From Resource_Master--Client_Master    
			 Where ((Role_ID In ('DVL') And (Project_Leader= @Emp_ID or Project_Leader2=@Emp_ID)) 
				   OR Emp_ID=@Emp_ID)  And Active_status='1'
				 And Emp_ID Not In (    
						Select Assigned_To from Task_master     
						Where (@ASD Between AS_SDT And AS_EDT Or    
							@AED Between AS_SDT And AS_EDT Or    
							AS_SDT Between @ASD And @AED Or    
							AS_EDT Between @ASD And @AED) Or     
							@ASD=AS_SDT Or    
							@AED=AS_EDT) 
			 Order By [Name]
		End
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'DBAPM')
		Begin
			 Select Emp_ID As [EmpID],    
				 Emp_Name As [Name] From Resource_Master--Client_Master    
			 Where ((Role_ID In ('DVL','DBAPL') And Project_Manager = @Emp_ID) 
				   OR Emp_ID=@Emp_ID) And Active_status='1'
				  and Emp_ID Not In (    
				Select Assigned_To from Task_master     
				Where (@ASD Between AS_SDT And AS_EDT Or    
					@AED Between AS_SDT And AS_EDT Or    
					AS_SDT Between @ASD And @AED Or    
					AS_EDT Between @ASD And @AED) Or     
					@ASD=AS_SDT Or    
					@AED=AS_EDT)  
			 Order By [Name]
		End 
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID)='DBAPL')
		Begin
			 Select Emp_ID As [EmpID],    
				 Emp_Name As [Name] From Resource_Master--Client_Master    
			 Where ((Role_ID In ('DVL') And (Project_Leader= @Emp_ID or Project_Leader2=@Emp_ID)) 
				   OR Emp_ID=@Emp_ID)  And Active_status='1'
				 And Emp_ID Not In (    
						Select Assigned_To from Task_master     
						Where (@ASD Between AS_SDT And AS_EDT Or    
							@AED Between AS_SDT And AS_EDT Or    
							AS_SDT Between @ASD And @AED Or    
							AS_EDT Between @ASD And @AED) Or     
							@ASD=AS_SDT Or    
							@AED=AS_EDT) 
			 Order By [Name]
		End
	End
	Else
	If(@Developer <> '' OR @PL <> '' OR @PM <> '' )
	Begin
		Select Emp_ID As [EmpID],    
		 Emp_Name As [Name] From Resource_Master--Client_Master 
		 Where Active_status='1'
			And Role_ID In (@Developer, @PL, @PM) and Emp_ID Not In (    
		 Select Assigned_To from Task_master     
		 Where (@ASD Between AS_SDT And AS_EDT Or    
		 @AED Between AS_SDT And AS_EDT Or    
		 AS_SDT Between @ASD And @AED Or    
		 AS_EDT Between @ASD And @AED) Or     
		 @ASD=AS_SDT Or    
		 @AED=AS_EDT)    
	End    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_CreateProject
-- --------------------------------------------------





--usp_CreateProject '000004','Beta Testing','User Testing','','','','','','','','','','','','','','','','','','','','Medium','4/26/2010 12:00:00 AM','5/1/2010 12:00:00 AM','1'


CREATE Procedure [dbo].[usp_CreateProject]
(
 @ProjectName varchar(150),
 @PhaseID varchar(50),
 @M1 varchar(150),
 @M2 varchar(150),
 @M3 varchar(150),
 @M4 varchar(150),
 @M5 varchar(150),
 @M6 varchar(150),
 @M7 varchar(150),
 @M8 varchar(150),
 @M9 varchar(150),
 @M10 varchar(150),
 @M11 varchar(150),
 @M12 varchar(150),
 @M13 varchar(150),
 @M14 varchar(150),
 @M15 varchar(150),
 @M16 varchar(150),
 @M17 varchar(150),
 @M18 varchar(150),
 @M19 varchar(150),
 @M20 varchar(150),
 @Priority varchar(20),
 @AssignSDate datetime,
 @AssignEDate datetime,
 @Option char(5)
 )
as
Begin
	Declare @PID As Varchar(50)
	Declare @MT1 varchar(150)
	Declare @MT2 varchar(150)
	Declare @MT3 varchar(150)
	Declare @MT4 varchar(150)
	Declare @MT5 varchar(150)
	Declare @MT6 varchar(150)
	Declare @MT7 varchar(150)
	Declare @MT8 varchar(150)
	Declare @MT9 varchar(150)
	Declare @MT10 varchar(150)
	Declare @MT11 varchar(150)
	Declare @MT12 varchar(150)
	Declare @MT13 varchar(150)
	Declare @MT14 varchar(150)
	Declare @MT15 varchar(150)
	Declare @MT16 varchar(150)
	Declare @MT17 varchar(150)
	Declare @MT18 varchar(150)
	Declare @MT19 varchar(150)
	Declare @MT20 varchar(150)
	
	Set @PID = ''

	IF((Select Phase_ID From Phase_Master Where Phase_Name like 'Development')=@PhaseID)
	Begin
		Set @PID = (Select Phase_ID From Phase_Master Where Phase_Name like 'Testing')
		
		Set @MT1 = @M1
		Set @MT2 = @M2
		Set @MT3 = @M3
		Set @MT4 = @M4
		Set @MT5 = @M5
		Set @MT6 = @M6
		Set @MT7 = @M7
		Set @MT8 = @M8
		Set @MT9 = @M9
		Set @MT10 = @M10
		Set @MT11 = @M11
		Set @MT12 = @M12
		Set @MT13 = @M13
		Set @MT14 = @M14
		Set @MT15 = @M15
		Set @MT16 = @M16
		Set @MT17 = @M17
		Set @MT18 = @M18
		Set @MT19 = @M19
		Set @MT20 = @M20

	End

	Select * From Phase_Master

	If(@Option = '1')
	Begin
		Insert into Phase_Master (Phase_ID, Phase_Name) values ('', @PhaseID)
		Select top 1 @PhaseID = Phase_ID from Phase_Master Order by Phase_ID desc 
	End	
	-----------------------------------------------------------------------------------------------------------------



	If(@M1<>'')
	Begin
		Insert into Module_Master Values('',@M1)
		Select top 1 @M1=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M2<>'')
	Begin
		Insert into Module_Master Values('',@M2)
		Select top 1 @M2=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M3<>'')
	Begin
		Insert into Module_Master Values('',@M3)
		Select top 1 @M3=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M4<>'')
	Begin
		Insert into Module_Master Values('',@M4)
		Select top 1 @M4=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M5<>'')
	Begin
		Insert into Module_Master Values('',@M5)
		Select top 1 @M5=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M6<>'')
	Begin
		Insert into Module_Master Values('',@M6)
		Select top 1 @M6=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M7<>'')
	Begin
		Insert into Module_Master Values('',@M7)
		Select top 1 @M7=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M8<>'')
	Begin
		Insert into Module_Master Values('',@M8)
		Select top 1 @M8=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M9<>'')
	Begin
		Insert into Module_Master Values('',@M9)
		Select top 1 @M9=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M10<>'')
	Begin
		Insert into Module_Master Values('',@M10)
		Select top 1 @M10=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M11<>'')
	Begin
		Insert into Module_Master Values('',@M11)
		Select top 1 @M11=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M12<>'')
	Begin
		Insert into Module_Master Values('',@M12)
		Select top 1 @M12=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M13<>'')
	Begin
		Insert into Module_Master Values('',@M13)
		Select top 1 @M13=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M14<>'')
	Begin
		Insert into Module_Master Values('',@M14)
		Select top 1 @M14=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M15<>'')
	Begin
		Insert into Module_Master Values('',@M15)
		Select top 1 @M15=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M16<>'')
	Begin
		Insert into Module_Master Values('',@M16)
		Select top 1 @M16=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M17<>'')
	Begin
		Insert into Module_Master Values('',@M17)
		Select top 1 @M17=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M18<>'')
	Begin
		Insert into Module_Master Values('',@M18)
		Select top 1 @M18=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M19<>'')
	Begin
		Insert into Module_Master Values('',@M19)
		Select top 1 @M19=Module_ID From Module_Master Order By Module_ID Desc
	End
	If(@M20<>'')
	Begin
		Insert into Module_Master Values('',@M20)
		Select top 1 @M20=Module_ID From Module_Master Order By Module_ID Desc
	End

	-----------------------------------------------------------------------------------------------------------------

	Insert Into Project_Details(Project_ID, Phase_ID, Module_ID)
	Select @ProjectName, @PhaseID, @M1 where @M1 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M2 where @M2 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M3 where @M3 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M4 where @M4 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M5 where @M5 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M6 where @M6 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M7 where @M7 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M8 where @M8 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M9 where @M9 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M10 where @M10 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M11 where @M11 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M12 where @M12 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M13 where @M13 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M14 where @M14 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M15 where @M15 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M16 where @M16 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M17 where @M17 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M18 where @M18 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M19 where @M19 <> ''
	UNION ALL
	Select @ProjectName, @PhaseID, @M20 where @M20 <> ''

	-----------------------------------------------------------------------------------------------------------------

	If(@PID<>'')
	Begin
		If(@MT1<>'')
		Begin
			Insert into Module_Master Values('',@MT1)
			Select top 1 @MT1=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT2<>'')
		Begin
			Insert into Module_Master Values('',@MT2)
			Select top 1 @MT2=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT3<>'')
		Begin
			Insert into Module_Master Values('',@MT3)
			Select top 1 @MT3=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT4<>'')
		Begin
			Insert into Module_Master Values('',@MT4)
			Select top 1 @MT4=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT5<>'')
		Begin
			Insert into Module_Master Values('',@MT5)
			Select top 1 @MT5=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT6<>'')
		Begin
			Insert into Module_Master Values('',@MT6)
			Select top 1 @MT6=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT7<>'')
		Begin
			Insert into Module_Master Values('',@MT7)
			Select top 1 @MT7=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT8<>'')
		Begin
			Insert into Module_Master Values('',@MT8)
			Select top 1 @MT8=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT9<>'')
		Begin
			Insert into Module_Master Values('',@MT9)
			Select top 1 @MT9=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT10<>'')
		Begin
			Insert into Module_Master Values('',@MT10)
			Select top 1 @MT10=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT11<>'')
		Begin
			Insert into Module_Master Values('',@MT11)
			Select top 1 @MT11=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT12<>'')
		Begin
			Insert into Module_Master Values('',@MT12)
			Select top 1 @MT12=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT13<>'')
		Begin
			Insert into Module_Master Values('',@MT13)
			Select top 1 @MT13=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT14<>'')
		Begin
			Insert into Module_Master Values('',@MT14)
			Select top 1 @MT14=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT15<>'')
		Begin
			Insert into Module_Master Values('',@MT15)
			Select top 1 @MT15=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT16<>'')
		Begin
			Insert into Module_Master Values('',@MT16)
			Select top 1 @MT16=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT17<>'')
		Begin
			Insert into Module_Master Values('',@MT17)
			Select top 1 @MT17=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT18<>'')
		Begin
			Insert into Module_Master Values('',@MT18)
			Select top 1 @MT18=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT19<>'')
		Begin
			Insert into Module_Master Values('',@MT19)
			Select top 1 @MT19=Module_ID From Module_Master Order By Module_ID Desc
		End
		If(@MT20<>'')
		Begin
			Insert into Module_Master Values('',@MT20)
			Select top 1 @MT20=Module_ID From Module_Master Order By Module_ID Desc
		End

		-----------------------------------------------------------------------------------------------------------------

		Insert Into Project_Details(Project_ID, Phase_ID, Module_ID)
		Select @ProjectName, @PID, @MT1 where @MT1 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT2 where @MT2 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT3 where @MT3 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT4 where @MT4 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT5 where @MT5 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT6 where @MT6 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT7 where @MT7 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT8 where @MT8 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT9 where @MT9 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT10 where @MT10 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT11 where @MT11 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT12 where @MT12 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT13 where @MT13 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT14 where @MT14 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT15 where @MT15 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT16 where @MT16 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT17 where @MT17 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT18 where @MT18 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT19 where @MT19 <> ''
		UNION ALL
		Select @ProjectName, @PID, @MT20 where @MT20 <> ''
	End


	Update Project_Master 
	Set Priority = @Priority
	Where Project_ID = @ProjectName


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_DBAOperations
-- --------------------------------------------------










Create proc [dbo].[usp_DBAOperations]
@DBA_Id  as char(20),
@Project_Id as char(20),
@Phase_Id as char(10),
@Module_Id  as char(20),
@Req_Desc as varchar(2000),
@Expected_EDate as datetime,
@File as varchar(400),
@Requested_By as varchar(10),
@Requested_On as datetime,
@Resolved_By as varchar(10),
@Resolved_ON as datetime,
@Status as char(10),
@Option as int
as

Begin
	If(@Option = 1)
	Begin
		Set @DBA_Id = DBO.GenerateID('15', '')
		

		Insert into dbo.Tbl_DBA_Request
		values(@DBA_Id, @Project_Id,'103',@Module_Id,@Req_Desc,@Expected_EDate,'',@Requested_By,getdate(),'','','','','','P' )
	   
--		  Insert into dbo.Tbl_DBA_Request_Details
--		  values(@DBA_Id, @Project_Id,'103',@Module_Id,@Req_Desc,@Expected_EDate,'',@Requested_By,getdate(),'','','P' )

		insert into Tbl_DBA_Request_Details
		Select * from Tbl_DBA_Request where DBA_ID = @DBA_Id
		
		Select @DBA_Id
	End

	Else If(@Option = 2)
	Begin
		Select @DBA_Id = DBO.GenerateID('15', '')
		select @DBA_Id
	End

	Else If(@Option = 3)
	Begin
		Select DB.DBA_ID,PM.Project_Name as [Project],MM.Module_Name as [Module],
				Convert(varchar(12),DB.Requested_On,113) AS [Requested_Date],
				Convert(varchar(12),DB.Expected_EDate,113) as [Expected End Date],
				Convert(varchar(12),DB.Actual_Start_Date,113) as [Startdate] , 
				Convert(varchar(12),DB.Actual_End_Date,113) as [EndDate] , RSM.Emp_NAme as [Requested_By], DB.Status
		from Tbl_DBA_Request DB, Project_Master PM , Module_Master MM , Resource_Master RSM
	    where DB.project_ID = PM.Project_ID 
				and DB.Requested_By = RSM.Emp_ID
				and MM.Module_ID = DB.Module_ID
				and DB.Status in ('P','NCFD')
		Order By DB.Expected_EDate
	End

	Else If(@Option = 4)
	Begin

		Print @Requested_On
		Print @Resolved_On

		Update Tbl_DBA_Request
		Set [Status] = @Status , Actual_Start_Date = @Requested_On , Actual_End_Date = @Resolved_On,
			Accepted_By = @Requested_By
		where DBA_ID = @DBA_Id

		insert into Tbl_DBA_Request_Details
		Select * from Tbl_DBA_Request where DBA_ID = @DBA_Id
		
		Select 'Updated'		
		
	End
	
	Else If(@Option=5)
	Begin
		Select SUM(NR) AS NR, SUM(PR) AS PR, SUM(RTBC) As RTBC, SUM(C) AS C, SUM(BP) AS BP, SUM(PR+RTBC+C+BP) AS Total
		From
		(
			Select DB.DBA_ID,(Case When DB.Status in ('P','NCFD') Then Count(DB.DBA_ID) Else '0' End ) As NR,
					'0' As PR, '0' As RTBC, '0' As C, '0' As BP
			From tbl_DBA_Request DB
			Where Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime,@Requested_On),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime,@Resolved_On),113)) 
			Group By DB.Status, DB.DBA_ID
		
			UNION

			Select DB.DBA_ID,'0' As NR,
					(Case When (DB.Status in ('ACP','W','A') And CONVERT(Datetime,CONVERT(Varchar(11),DB.Actual_End_Date,113)) > CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113)) ) 
						Then Count(DB.DBA_ID) Else '0' End ) As PR,
					'0' As RTBC,
					(Case When DB.Status='C' Then Count(DB.DBA_ID) Else '0' End ) As C, '0' As BP
			From tbl_DBA_Request DB
			Where Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) 
			Group By DB.Status, DB.DBA_ID,DB.Actual_End_Date

			Union

			Select  DB.DBA_ID,'0' AS NR, '0' As PR,  
				(Case When DB.Status in ('ACP','W','A') Then Count(DB.DBA_ID) Else '0' End ) As RTBC, '0' AS C, '0' As BP
			From tbl_DBA_Request DB
			Where (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
				And CONVERT(Datetime,CONVERT(Varchar(11),DB.Actual_End_Date,113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
			Group By DB.Status, DB.DBA_ID


			Union

			Select DB.DBA_ID,'0' AS NR, '0' As PR, '0' As RTBC, '0' AS C,
				(Case When DB.Status in ('ACP','W','A') Then Count(DB.DBA_ID) Else '0' End ) As BP
			From tbl_DBA_Request DB
			Where CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) < CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,getdate()),113)) 
			Group By DB.Status, DB.DBA_ID
		) T

--		Select SUM(NR) AS NR, SUM(PR) AS PR, SUM(RTBC) As RTBC, SUM(C) AS C, SUM(BP) AS BP, SUM(PR+RTBC+C+BP) AS Total
--		From
--		(
--			Select DB.DBA_ID,(Case When DB.Status in ('P','NCFD') Then Count(DB.DBA_ID) Else '0' End ) As NR,
--					'0' As PR, '0' As RTBC, '0' As C, '0' As BP
--			From tbl_DBA_Request DB
--			Where Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
--					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime,@Requested_On),113)) 
--					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime,@Resolved_On),113)) 
--			Group By DB.Status, DB.DBA_ID
--		
--			UNION
--
--			Select DB.DBA_ID,'0' As NR,
--					(Case When DB.Status in ('ACP','W') Then Count(DB.DBA_ID) Else '0' End ) As PR,'0' As RTBC,
--					(Case When DB.Status='C' Then Count(DB.DBA_ID) Else '0' End ) As C, '0' As BP
--			From tbl_DBA_Request DB
--			Where Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
--					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
--					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) 
--			Group By DB.Status, DB.DBA_ID
--
--			Union
--
--			Select  DB.DBA_ID,'0' AS NR, '0' As PR,  
--				(Case When DB.Status in ('ACP','W') Then Count(DB.DBA_ID) Else '0' End ) As RTBC, '0' AS C, '0' As BP
--			From tbl_DBA_Request DB
--			Where (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
--					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
--					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
--				And CONVERT(Datetime,CONVERT(Varchar(11),DB.Actual_End_Date,113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
--			Group By DB.Status, DB.DBA_ID
--
--
--			Union
--
--			Select DB.DBA_ID,'0' AS NR, '0' As PR, '0' As RTBC, '0' AS C,
--				(Case When DB.Status in ('ACP','W') Then Count(DB.DBA_ID) Else '0' End ) As BP
--			From tbl_DBA_Request DB
--			Where CONVERT(Datetime,CONVERT(Varchar(11),DB.Actual_End_Date,113)) < CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,@Requested_On),113)) 
--			Group By DB.Status, DB.DBA_ID
--		) T
	End

	Else If(@Option=6)
	Begin
		If(rtrim(@Status) = 'NR')
		Begin
			Select Distinct DB.DBA_ID, PM.Project_Name, 
				MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB,  Testing_Status_Master TSM ,Project_Master PM,Module_MAster MM
			Where  DB.Status = TSM.Testing_Status_ID 
					And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
					And DB.Project_ID = PM.Project_ID
					And DB.Module_ID = MM.Module_ID	
			And DB.Status in ('P','NCFD')
		End 
		Else IF(@Status= 'RTBC')
		Begin
		

			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status in ('ACP','W','A')
					And DB.Status = TSM.Testing_Status_ID
					And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
					And CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
					And DB.Project_ID = PM.Project_ID
					And DB.Module_ID = MM.Module_ID
				
		End
		Else If(@Status='C')
		Begin
			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Resource_Master RSM , Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status  in ('C') 
				And DB.Status = TSM.Testing_Status_ID 					
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID	
		End
		Else If(@Status='PR')
		Begin

			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Resource_Master RSM , Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status  in ('A','W')  
				And DB.Status = TSM.Testing_Status_ID
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)))
				And	CONVERT(Datetime,CONVERT(Varchar(11),DB.Actual_End_Date,113)) > CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID
	
			Union

			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status = 'ACP' 
				And DB.Status = TSM.Testing_Status_ID 
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
				And	CONVERT(Datetime,CONVERT(Varchar(11),DB.Actual_End_Date,113)) > CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID
	
		End
		Else If(@Status='BP')
		Begin
			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status in ('ACP','W','A') 
				And DB.Status = TSM.Testing_Status_ID And
				CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) < CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,getdate()),113)) 
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID
		
		End
		Else If(@Status='T')
		Begin

--			--NR
--			Select Distinct DB.DBA_ID, PM.Project_Name, 
--				 MM.Module_Name As [Module], 
--				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
--				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
--						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
--				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
--				TSM.Testing_Status_Name As [Status]
--			From tbl_DBA_Request DB,  Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
--			Where DB.Status in ('P','NCFD')
--				And DB.Project_ID = PM.Project_ID
--				And DB.Module_ID = MM.Module_ID
--
--			Union 

			--RTBC
			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status in ('ACP','W','A')
					And DB.Status = TSM.Testing_Status_ID 
					And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
					And CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
					And DB.Project_ID = PM.Project_ID
					And DB.Module_ID = MM.Module_ID	
		
			Union

			--C
			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status in ('C')
				And DB.Status = TSM.Testing_Status_ID 
				And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID

			Union

			--PR
			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				 Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status in ('W','A')
				And DB.Status = TSM.Testing_Status_ID 
				And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
				And CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) > CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,getdate()),113)) 
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID

			Union

				Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status = 'ACP' 
				And DB.Status = TSM.Testing_Status_ID
				And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
				And CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) > CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,getdate()),113)) 
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID		

			Union

			--BP
			Select Distinct DB.DBA_ID, PM.Project_Name, 
				 MM.Module_Name As [Module], 
				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
			Where DB.Status in ('ACP','W','A') 
				And DB.Status = TSM.Testing_Status_ID
				And CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) < CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,getdate()),113)) 
				And DB.Project_ID = PM.Project_ID
				And DB.Module_ID = MM.Module_ID


----------------------------------------------------------------
--			--RTBC
--			Select Distinct DB.DBA_ID, PM.Project_Name, 
--				 MM.Module_Name As [Module], 
--				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
--				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
--						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
--				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
--				TSM.Testing_Status_Name As [Status]
--			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
--			Where DB.Status in ('ACP','W')
--					And DB.Status = TSM.Testing_Status_ID 
--					And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
--					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
--					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
--					And CONVERT(Datetime,CONVERT(Varchar(11),DB.Actual_End_Date,113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
--					And DB.Project_ID = PM.Project_ID
--					And DB.Module_ID = MM.Module_ID	
--		
--			Union
--
--			--C
--			Select Distinct DB.DBA_ID, PM.Project_Name, 
--				 MM.Module_Name As [Module], 
--				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
--				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
--						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
--				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
--				TSM.Testing_Status_Name As [Status]
--			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
--			Where DB.Status in ('C')
--				And DB.Status = TSM.Testing_Status_ID 
--				And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
--				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
--				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
--				And DB.Project_ID = PM.Project_ID
--				And DB.Module_ID = MM.Module_ID
--
--			Union
--
--			--PR
--			Select Distinct DB.DBA_ID, PM.Project_Name, 
--				 MM.Module_Name As [Module], 
--				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
--				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
--						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
--				 Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
--				TSM.Testing_Status_Name As [Status]
--			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
--			Where DB.Status = 'W'
--				And DB.Status = TSM.Testing_Status_ID 
--				And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
--				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
--				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
--				And DB.Project_ID = PM.Project_ID
--				And DB.Module_ID = MM.Module_ID
--
--			Union
--
--				Select Distinct DB.DBA_ID, PM.Project_Name, 
--				 MM.Module_Name As [Module], 
--				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
--				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
--						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
--				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
--				TSM.Testing_Status_Name As [Status]
--			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
--			Where DB.Status = 'ACP' 
--				And DB.Status = TSM.Testing_Status_ID
--				And (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, DB.Requested_On),113))
--				Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Requested_On),113)) 
--				And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @Resolved_On),113)) )
--				And DB.Project_ID = PM.Project_ID
--				And DB.Module_ID = MM.Module_ID		
--
--			Union
--
--			--BP
--			Select Distinct DB.DBA_ID, PM.Project_Name, 
--				 MM.Module_Name As [Module], 
--				CONVERT(Varchar(11), DB.Requested_On, 113) As Request_Date, CONVERT(Varchar(11),DB.Expected_EDate, 113) As REnd_Date, 
--				(Case When DB.Resolved_by in (Select Emp_ID From Resource_master Where active_status=1) 
--						Then (Select Emp_Name From Resource_master Where Emp_ID=DB.Resolved_by) Else '' End) As [Resolved_By],
--				Convert(varchar(11),DB.Actual_Start_Date,113) AS [TSDate], Convert(varchar(11),DB.Actual_End_Date,113) As [TEDate],
--				TSM.Testing_Status_Name As [Status]
--			From tbl_DBA_Request DB, Testing_Status_Master TSM,Project_Master PM,Module_MAster MM
--			Where DB.Status in ('ACP','W') 
--				And DB.Status = TSM.Testing_Status_ID
--				And CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,DB.Actual_End_Date),113)) < CONVERT(Datetime,CONVERT(Varchar(11),Convert(Datetime,getdate()),113)) 
--				And DB.Project_ID = PM.Project_ID
--				And DB.Module_ID = MM.Module_ID
--
		End
	End
	Else If(@Option = 7)
	Begin
		if(@Status<>'P')
		Begin
			Select TM.Task_ID,
				TM.Change_ID As Token,PM.Project_Name , MM.Module_Name ,TM.Task_Name, RPM.Priority_Name As Priority,
				Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
				Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate,Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
			From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM
			Where TM.Project_ID = PM.Project_ID
				And TM.Priority_ID=RPM.Priority_ID
				And TM.Module_ID = MM.Module_ID
				And TM.Status_ID = @Status
				And TM.Assigned_To = @Resolved_By  and TM.Assigned_BY != @Resolved_By
			
			Union

			Select TM.Task_ID,
					TM.Change_ID As [Token],
					PM.Project_Name ,MM.Module_Name ,TM.Task_Name, 
					RPM.Priority_Name As Priority, Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
					Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,
					Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
					CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
			From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM 
			Where TM.Project_ID = PM.Project_ID
				And TM.Priority_ID=RPM.Priority_ID    
				And TM.Module_ID = MM.Module_ID And TM.Status_ID = @Status
				and TM.Assigned_To = @Resolved_By and TM.Assigned_BY = @Resolved_By
		End
		Else If(@Status='P')
		Begin
			Select TM.Task_ID,
				TM.Change_ID As Token,PM.Project_Name , MM.Module_Name ,TM.Task_Name, RPM.Priority_Name As Priority,
				Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
				Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate,Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
			From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM
			Where TM.Project_ID = PM.Project_ID
				And TM.Priority_ID=RPM.Priority_ID
				And TM.Module_ID = MM.Module_ID
				And TM.Status_ID in ('P','R')
				And TM.Assigned_To = @Resolved_By  and TM.Assigned_BY != @Resolved_By
			
			Union

			Select TM.Task_ID,
					TM.Change_ID As [Token],
					PM.Project_Name ,MM.Module_Name ,TM.Task_Name, 
					RPM.Priority_Name As Priority, Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
					Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,
					Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
					CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
			From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM 
			Where TM.Project_ID = PM.Project_ID
				And TM.Priority_ID=RPM.Priority_ID    
				And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','R')
				and TM.Assigned_To = @Resolved_By and TM.Assigned_BY = @Resolved_By
		End
	End
	Else If(@Option = 8)
	Begin
		Select Distinct TM.Task_ID As [TaskID],
				TM.Change_ID As [Token],
				PM.Project_Name As [Project], MM.Module_Name As [Module], TM.Task_Name,
				TM.Priority_ID As [Priority], Convert(varchar(12),TM.AS_SDT,113) As [AS_SDT],Convert(varchar(12),TM.AS_EDT,113) As [AS_EDT],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
				Convert(Varchar,(TM.AS_Time/60)) + ':' + Convert(Varchar,(TM.AS_Time%60)) As [Assigned Time]
			From Task_Master TM, Project_Master PM, Module_Master MM, Project_Details PD, Client_Master CM
			Where TM.Project_ID=PM.Project_ID and TM.Module_ID=MM.Module_ID and TM.Request_ID=PM.Request_ID
				and TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and TM.Assigned_To= @Resolved_By and TM.Assigned_By! = @Resolved_By
				and TM.Status_ID in ('P','W')

			Union

			Select Distinct TM.Task_ID As [TaskID],
				TM.Change_ID As Token,
				TM.Project_ID As [Project], TM.Module_ID As [Module], TM.Task_Name,
				TM.Priority_ID As [Priority], Convert(varchar(12),TM.AS_DT,113) As [AS_SDT],Convert(varchar(12),TM.AS_EDT,113) As [AS_EDT],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
				Convert(Varchar,(TM.AS_Time/60)) + ':' + Convert(Varchar,(TM.AS_Time%60)) As [Assigned Time]
			From Task_Master TM, Client_Master CM
			Where TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and TM.Assigned_To = @Resolved_By and TM.Assigned_by = @Resolved_By
					and TM.Status_ID in ('P','W')
	End
	Else if(@Option = 9)
	Begin
		if((Select Role_ID From Client_master Where Emp_ID = @Resolved_By) in ( 'DBA'))
		Begin
			Select Task_ID,Task_ID
			From Task_Master 
			Where Assigned_To = @Resolved_By				
				 and Status_ID in ('P','W')
				
			UNION
			
			Select Task_ID,Task_ID
			From Task_Master 
			Where Assigned_To = @Resolved_By and Assigned_By = @Resolved_By		
					and	Status_ID in ('P','W')
		End
	End
	Else if(@Option = 10)
	Begin
		Select DBA_ID from tbl_DBA_Request where DBA_ID = @DBA_Id 
	End
	Else if(@Option = 11)
	Begin
		Select DB.DBA_ID,DB.Project_ID,MM.Module_Name,DB.Req_Desc,DB.Expected_Edate,DB.[File],DB.Requested_By,DB.[Status] from tbl_DBA_Request DB,Module_MAster MM 
		where DB.DBA_ID = @DBA_Id and MM.Module_ID = DB.Module_ID 
	End
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_DEPLOY_INSERT
-- --------------------------------------------------
CREATE procedure [dbo].[USP_DEPLOY_INSERT]   --Usp_Deploy_Insert '1','','','','','','','','','','','','','','','','','','','','','','','','','',''
 (  
    @option NVARCHAR(5),  
    @Req_Type VARCHAR(100),  
    @Pro_Name VARCHAR(250),  
    @Req_Id CHAR(20),  
    @Module_Id CHAR(20),  
    @Req_By CHAR(20),  
    @Req_Date datetime,  
    @Exp_Enddate datetime,  
    @Req_Remark VARCHAR(200),  
    @Deployment_Date datetime,  
    @Deployment_By CHAR(20),  
    @Deployer_Remark VARCHAR(200),  
    @Status_Code CHAR(20),  
---- For the tbl_DeployServerMaster  
    @ser_158 VARCHAR(200),  
    @ser_75 VARCHAR(200),  
    @ser_173 VARCHAR(200),  
    @ser_136 VARCHAR(200),  
---- For the tbl_DeployPagesdetails  
    @page1 VARCHAR(150),  
    @page2 VARCHAR(150),  
    @page3 VARCHAR(150),  
    @page4 VARCHAR(150),  
    @page5 VARCHAR(150),  
    @page6 VARCHAR(150),  
    @page7 VARCHAR(150),  
    @page8 VARCHAR(150),  
    @page9 VARCHAR(150),  
    @page10 VARCHAR(150)  
      
 )  
AS  
  
Begin  
  If(@option=1)  
    Begin  
    Declare @TknNo AS VARCHAR(150)  
        Set @TknNo =(Select DBO.generateID(14,''))   
     INSERT INTO tbl_Deploymentrequestmaster   
     VALUES(@TknNo,@Req_Type,@Pro_Name,@Req_Id,@Module_Id,@Req_By,getdate(),  
     Convert(datetime,@Exp_Enddate),@Req_Remark,Null,'','',@Status_Code )  
  
    Insert into tbl_Deploymentrequestmaster_Detail  
    Select '',* from  tbl_Deploymentrequestmaster   
       Where Token_No=@TknNo 
--		declare @TknNo as int  
--	Select @TknNo=@@identity  
    End  
  
   if (@ser_158 <>'')      
      Begin  
    INSERT INTO tbl_DeployServerMaster   
    VALUES(@ser_158,@TknNo,@Status_Code )  
      End  
  
     if(@ser_75 <> '')  
        Begin  
            INSERT INTO tbl_DeployServerMaster   
    VALUES(@ser_75,@TknNo,@Status_Code )  
      End  
  
       if(@ser_173 <> '')  
        Begin  
            INSERT INTO tbl_DeployServerMaster   
   VALUES(@ser_173,@TknNo,@Status_Code )  
      End  
        
       if(@ser_136 <> '')  
        Begin  
            INSERT INTO tbl_DeployServerMaster   
   VALUES(@ser_136,@TknNo,@Status_Code )  
     End  
  
      if(@page1 <> '')  
         Begin  
    INSERT INTO tbl_DeployPagesdetails   
    VALUES(@TknNo,@page1,NULL)  
      End        
  
    if(@page2 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page2,NULL)  
       End  
  
 if(@page3 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page3,NULL)  
       End   
    
 if(@page4 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page4,NULL)  
       End   
    
 if(@page5 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page5,NULL)  
       End  
    
    
 if(@page6 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page6,NULL)  
       End  
  
    
 if(@page7 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page7,NULL)  
       End  
  
    
 if(@page8 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page8,NULL)  
       End  
  
    
 if(@page9 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page9,NULL)  
       End  
  
    
 if(@page10 <> '')  
         Begin  
   INSERT INTO tbl_DeployPagesdetails   
   VALUES(@TknNo,@page10,NULL)  
       End  
  
  Declare @EMAIL_BCC varchar(max)  
  Declare @MESS varchar(max)   
   
  SET @EMAIL_BCC= (Select emailadd from Client_Master where EMP_ID=@Req_By)  
  
  -- MESSAGE TO BE SENT  
--  SET @MESS = (SELECT 'Dear Anil,<BR><BR><BR>Find Below Details of New Deployment Request.<BR>Regards,  
--                      <BR><BR>Test Mail<BR><BR>'+@Req_Type+'<BR>'+@Pro_Name+'<BR>'+@Req_Id+'<BR>'+@Module_Id+'<BR>'+Convert(varchar,@Exp_Enddate)+'<BR>  
--                      '+@Req_Remark+'<BR>'+@ser_158+'<BR>'+@ser_75+'<BR>'+@ser_173+'<BR>'+@ser_136+'<BR>'+@page1+'  
--                       <BR>'+@page2+'<BR>'+@page3+'<BR>'+@page4+'<BR>'+@page5+'<BR>'+@page6+'<BR>'+@page7+'<BR>'+@page8+'<BR>'+@page9+'<BR>'+@page10+' ')  
  
       SET @MESS = (SELECT '<html><HEAD><TITLE>New Deployment Request </TITLE><STYLE TYPE=''text/css''>' +  
							'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1pxsolid; border-top: black 1px solid; } ' +
							'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
							'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
							'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
							'</STYLE></HEAD><body>  '+
							'Dear Angel,<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '+
							'Kindly,&nbsp;Find Below Details of New Deployment Request .&nbsp; <BR><BR><BR>  '+
							'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''border="1" >  '+
							'<tr>  '+
                            '   <th> Request Type</th>  '+
                            '   <th>Project Name</th>   '+
							'	<th>Change Request Id</th>'+  
                            '   <th>Module Name</th>  '+
                            '   <th>Expected Date</th>  '+ 
                            '   <th>Remark</th>   '+
                            '   <th>Server Name</th>'+  
                            '   <th>Pages Name</th>  '+
							'</tr>  '+
							'<tr>  '+
                            '   <td>'+@Req_Type+'</td>  '+
                            '   <td>'+@Pro_Name+'</td>   '+
                            '   <td>'+@Req_Id+'</td>  '+
                            '   <td>'+@Module_Id+'</td> '+ 
                            '   <td>'+Convert(varchar,@Exp_Enddate)+'</td>  '+
							'	<td>'+@Req_Remark+'</td>  '+
							'	<td>'+@ser_158+' '+@ser_75+' '+@ser_173+' '+@ser_136+'</td>  '+
							'	<td>'+@page1+' '+@page2+' '+@page3+' '+@page4+' '+@page5+' '+@page6+' '+@page7+' '+@page8+' '+@page9+' '+@page10+'</td>  '+
							'</tr>  '+
							'</table>'+  
							'<BR><BR> * This is a system-generated e-mail, please do not reply to this email. '+
                            '<BR><BR><BR>Regards,<BR>Software Team<BR> '+
							' </body></html>')  
  
  
     select @MESS  
   
  EXEC msdb.dbo.sp_send_dbmail                                                                                              
  @RECIPIENTS  = 'Anil.Namdeo@angelbroking.com',  
  @COPY_RECIPIENTS = @EMAIL_BCC,                                                                                          
                           
  @PROFILE_NAME = 'Prms_alert',                                  
  @BODY_FORMAT ='HTML',                                                                                                      
  @SUBJECT = 'New Deployment Request',                                                                                                                                                                         
  @BODY =@MESS  
  
      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_emp_img_info
-- --------------------------------------------------




CREATE proc [dbo].[usp_emp_img_info]      

@CMT As varchar(50)

as       
Begin
--select a.imgid,a.imgname,a.imgfile,rating_by,remark,rating  into tbl_TempRate_img from tbl_image a       
--inner join      
--(select * from tbl_rating_master) b      
--on a.imgname =b.rating_by 

	select IMG.imgid, IMG.imgname, IMG.imgfile, TRM.rating_by, TRM.remark, TRM.rating  into tbl_TempRate_img
	From tbl_image IMG       
	inner join  tbl_rating_master TRM on IMG.imgname =TRM.rating_by       
	join tbl_Component_Master TCM on TCM.[Object_Name]=@CMT
	Where TRM.[CMT_ID]=TCM.[CMT_ID]     
	      

	Insert Into tbl_TempRate_img
		Select '' As imgid, '' As imgname, '' As imgfile, TRM.rating_by, TRM.remark, TRM.rating  
		From tbl_rating_master TRM         
		join tbl_Component_Master TCM on TCM.[Object_Name]=@CMT
		Where TRM.[CMT_ID]=TCM.[CMT_ID]  


	IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME='tbl_TempRate_img') 
	Begin
		select imgid,imgname,imgfile,b.Emp_Name as rating_by,remark,rating  from tbl_TempRate_img a      
			inner join      
			Client_Master b      
			on a.rating_by =b.Emp_ID   

	End
	Drop table tbl_TempRate_img

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_EmpSchedule
-- --------------------------------------------------


CREATE proc [dbo].[usp_EmpSchedule]
@Option varchar(25),
@FromDate varchar(20),
@ToDate varchar(20),
@EmpID varchar(10),
@RoleID varchar(15)
as
	Declare @Day varchar(20)
	Declare @DaysCount int
	Declare @Count int

	set @DaysCount = (SELECT DATEDIFF(day, convert(datetime,@FromDate,103), convert(datetime,@ToDate,103))) + 1
BEGIN
   IF(@Option = 'REPORT')
	BEGIN
		if @DaysCount > 0
		BEGIN
			set @Count = 1

--				IF OBJECT_ID('tempdb..#Schedule1') IS NOT NULL
				IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE' AND TABLE_NAME='TempTbl_Schedule1') 
				Drop table TempTbl_Schedule1
				IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE' AND TABLE_NAME='TempTbl_Schedule2') 
				Drop table TempTbl_Schedule2
				IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE' AND TABLE_NAME='TempTbl_Schedule3') 
				Drop table TempTbl_Schedule3;

--				IF OBJECT_ID('tempdb..#Schedule2') IS NOT NULL
--				Drop table #Schedule2
--				IF OBJECT_ID('tempdb..#Schedule3') IS NOT NULL
--				Drop table #Schedule3

				IF(@RoleID = 'AA')
				BEGIN
					WITH empData
					AS
					(
						SELECT EMP_ID, SUBSTRING(EMP_NAME,1,12) AS EMP_NAME, ROW_NUMBER() OVER(PARTITION BY EMP_ID, EMP_NAME ORDER BY EMP_NAME) AS NUMBER FROM client_master where role_id in ('DVL','PL','PM')
					)
					SELECT EMP_ID, EMP_NAME into TempTbl_Schedule1 FROM empData WHERE NUMBER = 1
				END

				ELSE IF(@RoleID = 'PM')
				BEGIN
					WITH empData
					AS
					(
						SELECT CM.EMP_ID, SUBSTRING(CM.EMP_NAME,1,12) AS EMP_NAME, ROW_NUMBER() OVER(PARTITION BY CM.EMP_ID, CM.EMP_NAME ORDER BY CM.EMP_NAME) AS NUMBER
						 FROM client_master CM INNER JOIN RESOURCE_MASTER RM ON CM.EMP_ID = RM.EMP_ID where RM.PROJECT_MANAGER = @EmpID	
					)
					SELECT EMP_ID, EMP_NAME into TempTbl_Schedule1 FROM empData WHERE NUMBER = 1
				END				
			
				ELSE IF(@RoleID = 'PL')
				BEGIN
					WITH empData
					AS
					(
						SELECT CM.EMP_ID, SUBSTRING(CM.EMP_NAME,1,12) AS EMP_NAME, ROW_NUMBER() OVER(PARTITION BY CM.EMP_ID, CM.EMP_NAME ORDER BY CM.EMP_NAME) AS NUMBER
						 FROM client_master CM INNER JOIN RESOURCE_MASTER RM ON CM.EMP_ID = RM.EMP_ID where RM.PROJECT_LEADER = @EmpID	
					)
					SELECT EMP_ID, EMP_NAME into TempTbl_Schedule1 FROM empData WHERE NUMBER = 1
				END	

				ELSE IF(@RoleID = 'DVL')
				BEGIN
					WITH empData
					AS
					(
						SELECT CM.EMP_ID, SUBSTRING(CM.EMP_NAME,1,12) AS EMP_NAME, ROW_NUMBER() OVER(PARTITION BY CM.EMP_ID, CM.EMP_NAME ORDER BY CM.EMP_NAME) AS NUMBER
						 FROM client_master CM INNER JOIN RESOURCE_MASTER RM ON CM.EMP_ID = RM.EMP_ID where RM.EMP_ID = @EmpID	
					)
					SELECT EMP_ID, EMP_NAME into TempTbl_Schedule1 FROM empData WHERE NUMBER = 1
				END	

--				select Distinct Emp_ID into TempTbl_Schedule1 from client_master where role_id in ('DVL','PL','PM');
--				select Emp_ID into TempTbl_Schedule2 from TempTbl_Schedule1;
				select Emp_ID, EMP_NAME into TempTbl_Schedule3 from TempTbl_Schedule1;

			While(@Count <= @DaysCount)
			BEGIN
			set @Day = (select convert(varchar(11),convert(datetime, @FromDate,103),106));

				With myData
				as
				(
					select X.Emp_ID, isnull(X.Ass_Date, Y.Ass_Date) as AS_DT
					from
					(select S.Emp_ID,null as Ass_Date 
					from TempTbl_Schedule1 S left outer join (select distinct Assigned_To, max(AS_DT)as AS_DT from task_master group by Assigned_To) TM 
					on S.Emp_ID = TM.Assigned_To) as X 
					left outer join 
					(select Emp_ID , (select dbo.CurrSchedule (Emp_ID, @FromDate)) as Ass_Date from TempTbl_Schedule1) as Y
					on X.Emp_ID = Y.Emp_ID			
				) 
			select * INTO mySchedule from myData

			select TTS.*, MS.AS_DT into TempTbl_Schedule2 
			from TempTbl_Schedule3 TTS inner join mySchedule MS on TTS.Emp_ID = MS.Emp_ID

				Drop table TempTbl_Schedule3
				Drop table mySchedule
				select * into TempTbl_Schedule3 from TempTbl_Schedule2
				Drop table TempTbl_Schedule2
--				EXEC sp_rename [#Schedule2.AS_DT], @Day, 'column'

--				Delete from #Schedule1
--				Insert into #Schedule1 select * from #Schedule2

				If exists (select column_name from INFORMATION_SCHEMA.columns where table_name = 'TempTbl_Schedule3' and column_name = 'AS_DT') 
				EXEC sp_rename [TempTbl_Schedule3.AS_DT], @Day, 'column'
				set @Count = @Count + 1
				SET @FromDate = CONVERT(varchar(10),DATEADD(d,1,CONVERT(DATETIME,@FromDate,103)),103)

			END
			Select * from TempTbl_Schedule3
		END	
	END

 ELSE IF(@Option = 'DDLSELECT')
	BEGIN
		WITH INDIVIDUAL
		AS
		(
			SELECT CM.EMP_ID, SUBSTRING(CM.EMP_NAME,1,12) AS EMP_NAME, ROW_NUMBER() OVER(PARTITION BY CM.EMP_ID, CM.EMP_NAME ORDER BY CM.EMP_NAME) AS NUMBER
			FROM client_master CM INNER JOIN RESOURCE_MASTER RM ON CM.EMP_ID = RM.EMP_ID where 
			CASE WHEN @RoleID = 'PM' THEN RM.PROJECT_MANAGER WHEN @RoleID = 'PL' THEN RM.PROJECT_LEADER 
					WHEN @RoleID = 'DVL' THEN RM.Emp_ID WHEN @RoleID = 'AA' THEN @EmpID END = @EmpID
		)
		SELECT EMP_NAME,EMP_ID FROM INDIVIDUAL
	END

 ELSE IF(@Option = 'DETAILS')
	BEGIN
		WITH DETAILS
		AS
		(
			SELECT * FROM TASK_MASTER WHERE ASSIGNED_TO = @EmpID AND 
			AS_DT < DATEADD(d,1,CONVERT(DATETIME,@FromDate ,103)) and AS_EDT > CONVERT(DATETIME, @ToDate,103)
		)
		SELECT * FROM DETAILS
	END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Export_Excel
-- --------------------------------------------------



    
CREATE proc [dbo].[USP_Export_Excel]
@TaskID varchar(20),    
@ProjectCode varchar(20),    
@StatusID varchar(25),    
@FromDate varchar(20),    
@ToDate varchar(20),    
@EmpID varchar(20),  
@RoleID varchar(20),  
@Option varchar(20)    
    
as    
Begin    
 Declare @Query varchar(max)    
     
 if(@Option = '1')    
 Begin    
  set @Query = 'Select TM.Task_ID,PM.Project_Name as [Project Name], MM.Module_Name [Module Name], RM.Emp_Name as [Resource], Convert(varchar(12), TM.AS_SDT) as [Assigned Start Date],
    Convert(varchar(5), TM.AS_SDT, 114) as [Start Time],  Convert(varchar(12), TM.AS_EDT) as [Assigned End Date], Convert(varchar(5), TM.AS_EDT, 114) as [End Time],
    cast((TM.AS_Time/(1440)) as varchar(2)) + '':'' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + '':'' + RIGHT(''0'' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assigned Time (Days:hrs:Min)],
    TM.Task_Detail as Description, RPM.Priority_Name as [Priority], TSM.Task_Status_Name as Status      
      From  task_master TM    
       inner join Project_Master PM on TM.Request_ID = PM.Request_ID    
       inner join Module_Master MM on TM.Module_ID = MM.Module_ID    
       inner join Request_Priority_Master RPM on TM.Priority_ID = RPM.Priority_ID    
       inner join Task_Status_Master TSM on TM.Status_ID = TSM.Task_Status_ID    
	   inner join Client_Master HOD on HOD.Emp_ID = TM.Assigned_To  
       inner join Client_Master ADM on ADM.Emp_ID = TM.Assigned_BY
	   inner join Resource_Master RM on RM.Emp_ID = TM.Assigned_To   
      Where 1=1 '    
  If(@TaskID <> '')    
  Begin    
   set @Query = @Query + 'And TM.Task_ID = ''' + ltrim(rtrim(@TaskID)) + ''''    
  End    
    
  If(@ProjectCode <> '')    
  Begin    
   set @Query = @Query + 'And PM.Project_ID = ''' + ltrim(rtrim(@ProjectCode)) + ''''    
  End    
    
  If(@StatusID <> '')    
  Begin    
   set @Query = @Query + 'And TM.Status_ID = ''' + ltrim(rtrim(@StatusID)) + ''''    
  End    
    
  If(@FromDate <> '')    
  Begin    
   set @Query = @Query + 'And TM.AS_SDT between convert(datetime,ltrim(rtrim('''+ @FromDate + ''')),101) and DATEADD(dd,1,convert(datetime,ltrim(rtrim(''' + @ToDate + ''')),101))'     
  End   
    
if(@RoleID <> '')  
Begin  
  if(@RoleID = 'PM')  
  Begin   
 Set @Query = @Query + 'And HOD.HOD = ''' + ltrim(rtrim(@EmpID)) + ''''    
  End  
  
  Else if(@RoleID = 'AA' OR @RoleID = 'SYA')  
  Begin   
 Set @Query = @Query + 'And ADM.Emp_ID = ''' + ltrim(rtrim(@EmpID)) + ''''    
  End  
  
   Else If(@EmpID <> '')    
  Begin    
   set @Query = @Query + 'And HOD.Emp_ID = ''' + ltrim(rtrim(@EmpID)) + ''''    
  End    
End  
    
    
   
    
  Print @Query    
  Exec (@Query)     
    
 End    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Export_Excel_New
-- --------------------------------------------------






    
CREATE proc [dbo].[USP_Export_Excel_New]

@TaskID varchar(20),    
@ProjectCode varchar(20),    
@StatusID varchar(25),  
@Resource varchar(20),  
@FromDate varchar(20),    
@ToDate varchar(20),    
@EmpID varchar(20),  
@RoleID varchar(20),  
@Option varchar(20)    
    
as    
Begin    
 Declare @Query varchar(max)    
 Declare @Query2 varchar(max)   
     
 if(@Option = '1')    
 Begin    
   
	set @Query = 'Select Distinct  TM.Task_ID,
		
		PM.Project_Name as [Project Name], MM.Module_Name [Module Name], RM.Emp_Name as [Resource], Convert(varchar(12), TM.AS_SDT) as [Assigned Start Date],
		Convert(varchar(5), TM.AS_SDT, 114) as [Start Time],  Convert(varchar(12), TM.AS_EDT) as [Assigned End Date], Convert(varchar(5), TM.AS_EDT, 114) as [End Time],
		cast((TM.AS_Time/(1440)) as varchar(2)) + '':'' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + '':'' + RIGHT(''0'' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assigned Time (Days:hrs:Min)],
		TM.Task_Detail as Description, RPM.Priority_Name as [Priority], TSM.Task_Status_Name as Status     
      From  task_master TM    
       inner join Project_Master PM on TM.Request_ID = PM.Request_ID    
       inner join Module_Master MM on TM.Module_ID = MM.Module_ID    
       inner join Request_Priority_Master RPM on TM.Priority_ID = RPM.Priority_ID    
       inner join Task_Status_Master TSM on TM.Status_ID = TSM.Task_Status_ID    
	   inner join Resource_Master RM on RM.Emp_ID = TM.Assigned_To
      Where 1=1'    


	If(@TaskID <> '')    
	Begin    
		set @Query = @Query + 'And TM.Task_ID = ''' + ltrim(rtrim(@TaskID)) + ''''  
	End    
    
	If(@ProjectCode <> '')    
	Begin    
		set @Query = @Query + 'And PM.Project_ID = ''' + ltrim(rtrim(@ProjectCode)) + ''''    
	End    
    
	  If(@StatusID <> '')    
	  Begin    
	   set @Query = @Query + 'And TM.Status_ID = ''' + ltrim(rtrim(@StatusID)) + ''''    
	  End    
    
	  If(@FromDate <> '')    
	  Begin    
	   set @Query = @Query + 'And TM.AS_SDT between convert(datetime,ltrim(rtrim('''+ @FromDate + ''')),101) and DATEADD(dd,1,convert(datetime,ltrim(rtrim(''' + @ToDate + ''')),101))'     
	  End   
    
		If(@RoleID <> '')  
		Begin  
			If(@RoleID = 'PM')  
			Begin   
				If(@Resource<>'---SELECT---')
				Begin
					Set @Query = @Query + 'And (TM.Assigned_To  = ''' + ltrim(rtrim(@Resource)) + '''  and (TM.Assigned_by  = ''' + ltrim(rtrim(@EmpID)) + ''' or TM.Assigned_by='''+ ltrim(rtrim(@Resource)) + '''))' 
				End
				Else If (@Resource='---SELECT---')
				Begin
					Set @Query = @Query + 'And TM.Assigned_By  = ''' + ltrim(rtrim(@EmpID)) + '''' 
				End
			End  
			Else If(@RoleID = 'PL')  
			Begin   
				If(@Resource<>'---SELECT---')
				Begin
					Set @Query = @Query + 'And (TM.Assigned_To  = ''' + ltrim(rtrim(@Resource)) + '''  and TM.Assigned_by  = ''' + ltrim(rtrim(@EmpID)) + ''')' 
				End
				Else If (@Resource='---SELECT---')
				Begin
					Set @Query = @Query + 'And TM.Assigned_By  = ''' + ltrim(rtrim(@EmpID)) + '''' 
				End
			End 
			Else If(@RoleID = 'DVL')  
			Begin   
				If(@Resource<>'---SELECT---')
				Begin
					Set @Query = @Query + 'And (TM.Assigned_To  = ''' + ltrim(rtrim(@Resource)) + ''')' 
				End
				Else If (@Resource='---SELECT---')
				Begin
					Set @Query = @Query + 'And TM.Assigned_To  = ''' + ltrim(rtrim(@EmpID)) + '''' 
				End
			End 
			Else If(@RoleID = 'AA' or @RoleID = 'YSA')  
			Begin   
				If(@Resource<>'---SELECT---')
				Begin
					Set @Query = @Query + 'And (TM.Assigned_To  = ''' + ltrim(rtrim(@Resource)) + ''')' 
				End
--				Else If (@Resource='---SELECT---')
--				Begin
--					Set @Query = @Query + 'And TM.Assigned_To  = ''' + ltrim(rtrim(@EmpID)) + '''' 
--				End
			End 
		End



	
  Print @Query    
  Exec (@Query)     
    
 End    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Feedback_Operation
-- --------------------------------------------------
CREATE Proc [dbo].[USP_Feedback_Operation]

--------------------------------------------------------------------------------------------------
--Created By	: Mahendra Bonde 
--Created On	: 15 Oct 2010
--Modified By   :
--Modified On   :
--Decsription	: Store information of feedbcak given by client for application.
--------------------------------------------------------------------------------------------------
@FB_ID As Char(10),
@Request_ID As Char(10),
@Project_ID As Char(10),
@Project_Manager  As Char(10),
@Completion_Date As Datetime,
@TDP AS Int,
@EN AS Int,
@AOS AS Int,
@AI AS Int,
@AEU AS Int,
@COC AS Int,
@LNF AS Int,
@YSFA AS Int,
@Comments As Varchar(MAX),
@FB_BY AS Char(10),
@FB_On AS Datetime,
@USER As Char(10),
@Role AS Char(10),
@Option AS Int

As
Begin
	
	If(@Option=1)
	Begin
		Declare @ID char(10) 
		Set @ID = DBO.GenerateID('13', '')

		Insert Into Tbl_Feedback 
			(FB_ID,Request_ID,Project_ID,Project_Manager,Completion_Date,TDP,EN,AOS,AI,AEU,COC,LNF,YSFA,Comments,FB_BY,FB_On)
			Values(@ID,@Request_ID,@Project_ID,@Project_Manager,@Completion_Date,@TDP,@EN,@AOS,@AI,@AEU,@COC,@LNF,@YSFA,@Comments,@FB_BY,@FB_On)

		Update Request_Master
		Set Request_Status_ID='CP'
		Where Request_ID=@Request_ID

		Update Project_Master 
		Set Status='CP'
		Where Project_ID=@Project_ID

		Select @ID

		Select CM1.Emp_Name As R, CM1.Emailadd As REmail, CM2.Emp_Name As PO, CM2.Emailadd AS POEmail
		From Request_Master RM, Project_Master PM, Coordinator_Master COM1, Client_Master CM1, 
				Client_Master CM2
		Where RM.Request_ID=@Request_ID And RM.Request_ID=PM.Request_ID  And
			RM.Request_ID=COM1.Request_ID And COM1.Role_ID='PO' And
			RM.Requested_BY=CM1.Emp_ID And COM1.Employee_ID=CM2.Emp_ID

		Select CM1.Emp_Name As PM, CM1.Emailadd As PMEmail, CM2.Emp_Name As PMHOD, CM2.EmailAdd As PMHODEmail
		From Request_Master RM, Project_Master PM, Client_Master CM1, Client_Master CM2
		Where RM.Request_ID=@Request_ID And RM.Request_ID=PM.Request_ID  And
			 PM.Project_Manager=CM1.Emp_ID And CM1.HOD=CM2.Emp_ID

		Select CM.Emp_Name As Adm, CM.Emailadd As AdmEmail
		From Client_Master CM
		Where CM.Role_ID='AA' 
		

	End	
	Else If(@Option=2)
	Begin
		Select FB.FB_ID, FB.Request_ID, PM.Project_Name, RSM.Emp_Name, Convert(Varchar(11),FB.Completion_Date,113),
				Fb.TDP, Fb.EN, Fb.AOS, Fb.AI, Fb.AEU, Fb.COC, Fb.LNF, Fb.YSFA, Fb.Comments, Fb.FB_BY, Fb.FB_On
		From Tbl_Feedback FB, Project_Master PM, Resource_Master RSM
		Where FB.Request_ID=@Request_ID And PM.Request_ID=@Request_ID And PM.Project_manager=RSM.Emp_ID
	End
	Else If(@Option=3)
	Begin
		Select Distinct Project_Name, Project_ID 
		From Project_Master
		Where Project_ID in (Select Project_ID From Coordinator_Master Where Employee_ID=@User) And Status='FP'
	End
	Else If(@Option=4)
	Begin
		Select Distinct PM.Request_ID, RSM.Emp_Name, PM.AS_EDate
		From Project_Master PM, Resource_Master RSM
		Where Project_ID=@Project_ID And Status='FP' And
			PM.Project_Manager=RSM.Emp_ID
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Fetchdata
-- --------------------------------------------------




  
CREATE PROC [dbo].[usp_Fetchdata]  ------usp_Fetchdata '','','ALL','','2'
  
    @User as varchar(20),
	@Role as char(10),
	@EmpID as varchar(20),
	@Param1 as Varchar(20),
	@Option as int

AS
BEGIN
	
	If(@Option ='1')-----fill PM
	   Begin
			If((Select Role_ID from Resource_Master where Emp_ID = @User) in ('AA','SYA'))
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where Role_ID IN ('PM','SYA') and Active_Status='1'
				Order By Emp_Name
			End
			If((Select Role_ID from Resource_Master where Emp_ID = @User) in ('PM'))
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where Role_ID = 'PM' and Emp_ID = @User and Active_Status='1'
				Order By Emp_Name
			End	
			If((Select Role_ID from Resource_Master where Emp_ID = @User) in ('PL'))
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where Role_ID = 'PM' and Emp_ID = (Select Project_Manager From Resource_Master Where Emp_ID= @User )
						and Active_Status='1'
				Order By Emp_Name
			End	
		End

	Else If(@Option ='2')-----Fill Resources
	Begin
		If(@EmpID = 'ALL')
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('SYA','PM','PL','DVL') and Active_Status='1' 
			Order By Emp_Name
			End
		Else
		Begin
			If((Select Role_ID from Resource_Master where Emp_ID = @EmpID) = 'PM')
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where ((Role_ID in ('PM','PL','DVL') and Project_MAnager = @User) or Emp_ID=@User)
					and Active_Status='1'
				Order By Emp_Name
			End
			If((Select Role_ID from Resource_Master where Emp_ID = @EmpID) in ('PL'))
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where (Role_ID in ('PL','DVL') and Project_Leader = @EmpID) or Emp_ID=@EmpID
					and Active_Status='1'
				Order By Emp_Name
			End
		End
	End

	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_fetchTimesheet
-- --------------------------------------------------




-- =============================================
-- Author:		<Rihab Rebello>
-- Create date: <27/9/2010>
-- Description:	<fetch for Time sheet Report>
-- =============================================
CREATE PROCEDURE [dbo].[usp_fetchTimesheet]

	@User as varchar(20),
	@Role as char(10),
	@EmpID as varchar(20),
	@Param1 as Varchar(20),
	@Option as int

AS
BEGIN
	
	If(@Option ='1')--fill 'PM'
	   Begin
			If((Select Role_ID from Resource_Master where Emp_ID = @User) in ('AA','SYA'))
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where Role_ID in ('PM','DBAPM') and Active_Status='1' 
				order by Emp_Name
			End
			If((Select Role_ID from Resource_Master where Emp_ID = @User) in ('PM','DBAPM'))
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where Active_Status='1' And (Role_ID in ('PL','DBAPL') and Project_MAnager = @User)
				order by Emp_Name
			End	
			
		End

	Else If(@Option ='2')--fill 'Resources'
	Begin
		If(@EmpID = 'ALL')
			Begin
				Select Emp_Name,Emp_ID from Resource_Master
				where Role_ID in ('PM','PL','DVL','DBAPM','DBAPL') and Active_Status='1' 
				order by Emp_Name
			End
		Else
			Begin
				If((Select Role_ID from Resource_Master where Emp_ID = @EmpID) in ('PM','DBAPM'))
				Begin
					Select Emp_Name,Emp_ID from Resource_Master
					where Active_Status='1' And ((Role_ID in ('PL','DVL','DBAPL') and Project_MAnager = @EmpID) OR Emp_ID = @EmpID)
					order by Emp_Name					
				End
				If((Select Role_ID from Resource_Master where Emp_ID = @EmpID) in ('PL','DBAPL'))
				Begin
					Select Emp_Name,Emp_ID from Resource_Master
					where Active_Status='1' And ((Role_ID in ('PL','DBAPL') and Emp_ID = @EmpID )or(Role_ID = 'DVL' and Project_Leader = @EmpID))
					order by Emp_Name
				End
			End
	End
	Else If(@Option ='3')--fill Status
	Begin
		Select Task_Status_Name,Task_Status_ID 
		From Task_Status_Master 
		Where Task_Status_ID not in('TIP','UIP','PFU')
	End
	Else If(@Option='4') -- Fill projects
	Begin
		If((Select Role_ID from Resource_Master where Emp_ID = @User) in ('PM','DBAPM'))
		Begin
			Select Project_Name, Project_ID From Project_Master
			Where Status<>'' And Status not in ('RBA')
					And Project_Manager=@User
			Order by Project_Name					
		End
		Else If((Select Role_ID from Resource_Master where Emp_ID = @User) in ('PL','DBAPL'))
		Begin
			Select Project_Name, Project_ID From Project_Master
			Where Status<>'' And Status not in ('RBA')
					And Project_Leader=@User
			Order by Project_Name					
		End
	End
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Fill_Resources
-- --------------------------------------------------




CREATE PROC [dbo].[USP_Fill_Resources]

---------------------------------------------------------------------------------------------------------
--Description		: Common Procedure To get ADM, SYA, PM, PL, DVL, TS on different condition 
--Created BY		: Mahendra Bonde
--Cretaed On		: 11-10-2010
--Modified BY		:
--Modified On		:
---------------------------------------------------------------------------------------------------------

@Emp_ID As Char(20),
@Role_ID AS Char(20),
@User As Char(20),
@User_Role_ID As Char(20),
@Option As Int

AS
Begin
	If(@Option=1) -- All AA
	Begin
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('AA') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=2) -- All SYA
	Begin
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('SYA') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=3) -- All PM
	Begin
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('PM') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=4) -- All PL
	Begin
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('PL') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=5) -- All DVL
	Begin
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('DVL') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=6) -- All Testers
	Begin
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('TS') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=7) -- All TSTL
	Begin				
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('TSTL') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=8) -- All Team of TSTL
	Begin
		if((Select Role_ID from Resource_MAster where Emp_ID = @Emp_ID) = 'TSTL')
		Begin
			Select Distinct Emp_ID,Emp_Name 
			From Resource_Master 
			Where Role_ID in ('TS','TSTL') And Active_Status=1
			Order By Emp_Name
		End
		Else if((Select Role_ID from Resource_MAster where Emp_ID = @Emp_ID) = 'TSTL')
		Begin
			Select Distinct Emp_ID,Emp_Name 
			From Resource_Master 
			Where Emp_ID = @Emp_ID And Active_Status=1
			Order By Emp_Name
		End
	End	
	If(@Option=9) -- All PM, SYA
	Begin
		Select Distinct Emp_Name, Emp_ID
		From Resource_Master 
		Where Role_ID in ('SYA','PM') And Active_Status=1
		Order By Emp_Name
	End
	If(@Option=10) -- Team of SYA/PM
		Begin		
			Select Distinct Emp_Name, Emp_ID From Resource_Master 
			Where Role_ID in ('PM','PL','DVL')and Active_Status=1
				 and Project_Manager = @Emp_ID
			union
			Select Emp_Name ,Emp_ID from Resource_MAster where Emp_ID = @Emp_ID
			Order By Emp_Name
		End
	Else If(@Option = 11) -- Team under PL
	Begin
		Select Distinct Emp_Name, Emp_ID From Resource_Master 
		Where Role_ID in ('DVL') and Active_Status=1
			and Project_Leader = @Emp_ID		
		union
		Select Emp_Name ,Emp_ID from Resource_MAster where Emp_ID = @Emp_ID
		Order By Emp_Name
	End	
	Else IF(@Option=12) -- Project Manager Of Particular PL
	Begin
		Select Emp_Name, Emp_ID 
		From Resource_Master
		Where Emp_ID in (Select Project_Manager From Resource_Master Where Emp_ID=@Emp_ID)
	End
	Else If(@Option=13) -- Project Leaders Of Particular Manager
	Begin
		Select Distinct Emp_Name, Emp_ID 
		From Resource_Master 
		Where Role_ID in ('PL') And Active_Status=1 And Project_Manager=@Emp_ID
		Order By Emp_Name
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetCoordinatorDetails
-- --------------------------------------------------




--select * from Request_Master
--Select Distinct(Project_Name) from Request_Master

CREATE Procedure [dbo].[usp_GetCoordinatorDetails] --'E12024'  
(  
@EmpID nvarchar(255),
@PrjID nvarchar(255),
@Role nvarchar(255),
@Status bit,
@option char(5)  
)  
as  
	Declare @ReqID char(10)
  
if(@option = '1')
Begin
	Select Role_ID
	From Client_Master
	Where Client_Master.Emp_ID = @EmpID
End

Else if(@option = '2') -- Insert
Begin
	Select @ReqID=Request_ID From Project_Master Where Project_ID=@PrjID

	Insert into Coordinator_Master Values (@EmpID,@ReqID,@PrjID,@Role,@Status)
	Update Client_Master Set Role_ID = @Role where Emp_ID = @EmpID
	Select @PrjID

End
Else if (@Option='3') -- Update
Begin
	Update Coordinator_Master
	Set Role_ID=@Role, Activation_Status=@Status
	Where Employee_ID=@EmpID and Project_ID=@PrjID

	Update Client_Master Set Role_ID = @Role where Emp_ID = @EmpID
	
	Select @PrjID
End
Else if(@Option='4') -- Select
Begin
	Select PM.Project_Name,CM.Project_ID
	From Coordinator_Master CM, Project_Master PM
	Where CM.Employee_ID=@EMPID And CM.Project_ID=PM.Project_ID

End
Else if(@Option='5') -- Select
Begin
	Select CM.Role_ID, CM.Activation_Status
	From Coordinator_Master CM
	Where CM.Employee_ID=@EMPID And CM.Project_ID=@PrjID

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetData
-- --------------------------------------------------




CREATE Proc [dbo].[USP_GetData] 

	@Emp_ID Char(20),   
	@Role Char(10),
	@Param1 varchar(50),
	@Param2 Varchar(50),
	@Option Int 

AS
Begin
	
	If(@Option=1)
	Begin
		If(@Role='AA' or @Role='SYA')
		Begin
			Select Project_Name , Project_ID 
			From Project_Master
			Order by Project_Name
		End
		If(@Role='PM')
		Begin
			Select Project_Name , Project_ID 
			From Project_Master
			Where Project_Manager=@Emp_ID
 			Order by Project_Name
		End
		Else If(@Role='PL')
		Begin
			Select Project_Name , Project_ID 
			From Project_Master
			Where Project_Leader=@Emp_ID
			Order by Project_Name
		End
		Else If(@Role='DVL')
		Begin
			Select Project_Name , Project_ID 
			From Project_Master
			Where Project_Manager=(Select Project_manager From Resource_Master Where Emp_ID=@Emp_ID)
 			Order by Project_Name
		End
	End
	Else If(@Option=2)
	Begin
		Select Phase_Name, Phase_ID
		From Phase_Master
	End
	Else If(@Option=3)
	Begin
		Select MM.Module_Name, MM.Module_ID
		From Project_details PD, Module_Master MM
		Where PD.Project_ID=@Param1 And PD.Phase_ID=@Param2 
			And PD.Module_ID=MM.Module_ID
	End
	Else If(@Option=4)
	Begin
		If(@Role='AA' Or @Role='SYA')
		Begin
			Select Emp_Name, Emp_ID
			From Resource_Master
			Where Role_ID in ('PM','PL','DVL') And Active_Status=1
			Order By Emp_Name
		End
		Else IF(@Role='PM')
		Begin
			Select Emp_Name, Emp_ID
			From
			(
				Select Emp_Name, Emp_ID
				From Resource_Master
				Where Role_ID in ('PL','DVL') And Project_Manager=@Emp_ID And Active_Status=1
		
				union

				Select Emp_Name, Emp_ID
				From Resource_Master
				Where Emp_ID = @Emp_ID And Active_Status=1
			) T
			Order By Emp_Name
		End
		Else IF(@Role='PL')
		Begin
			Select Emp_Name, Emp_ID
			From
			(
				Select Emp_Name, Emp_ID
				From Resource_Master
				Where Role_ID in ('DVL') And Project_Leader=@Emp_ID And Active_Status=1
		
				union

				Select Emp_Name, Emp_ID
				From Resource_Master
				Where Emp_ID = @Emp_ID And Active_Status=1
			) T
			Order By Emp_Name

		End
	End
	Else If(@Option=5)
	Begin
		Select RM.Request_ID As RID,Convert(Varchar(11),RM.Request_Date,113) AS ReqSDate, 
			Convert(Varchar(11),RM.Expected_EDate,113) As ReqEDate,
			Convert(Varchar(11),PM.AS_SDate,113) As SysSDate, Convert(Varchar(11),PM.AS_EDate,113) AS SysEDate
		From Request_Master RM, Project_master PM
		Where RM.Request_ID=PM.Request_ID And PM.Project_ID=@Param1
	End
	Else If(@Option=6)
	Begin
		If(@Role!='PL')
		Begin
			Select Distinct CRM.Change_ID, CRM.Change_ID
			From Change_Request_Master CRM
					inner join Project_Master PRJM on PRJM.Request_ID = CRM.Request_ID
			Where PRJM.Project_ID=@Param1 and 
					CRM.Change_ID Not In (Select Change_ID From Task_Master Where Project_ID=@Param1)
				and CRM.Request_Status_ID in ('ACP','DLG')
		End 
		Else If(@Role='PL')
		Begin
			Select Distinct CRM.Change_ID, CRM.Change_ID
			From Change_Request_Master CRM
					inner join Project_Master PRJM on PRJM.Request_ID = CRM.Request_ID
			Where PRJM.Project_ID=@Param1 and 
					CRM.Change_ID Not In (Select Change_ID From Task_Master Where Project_ID=@Param1)
				and CRM.Request_Status_ID in ('DLG')
		End 
	End
	Else If(@Option=7)
	Begin
		Select RM.Request_ID As RID,Convert(Varchar(11),CRM.Changed_Date,113) AS ReqSDate, 
			Convert(Varchar(11),CRM.Expected_EDate,113) As ReqEDate,
			Convert(Varchar(11),CRM.PM_SDate,113) As SysSDate, Convert(Varchar(11),CRM.PM_EDate,113) AS SysEDate,
			CRM.Change_ID As CRID
		From Request_Master AS RM, Change_Request_Master CRM, Project_master PM
		Where RM.Request_ID=PM.Request_ID And PM.Project_ID=@Param1
			And CRM.Project_ID=@Param1 And Change_ID=@Param2
	End
	Else If (@Option=8)
	Begin
		Select MM.Module_Name, MM.Module_ID
		From Change_Request_Master CRM, Module_Master MM
		Where CRM.Project_ID=@Param1 And CRM.Change_ID=@Param2 
			And CRM.Module_ID=MM.Module_ID
	End
	Else If (@Option=9)
	Begin
		Select Task_Status_Name, Task_Status_ID
		From Task_Status_Master 
		Order By Task_Status_Name
	End
	Else If (@Option=10)
	Begin
		Select Task_Status_Name, Task_Status_ID
		From Task_Status_Master 
		Where Task_Status_ID not in ('P')
		Order By Task_Status_Name
	End
	Else If(@Option=11)
	Begin
		Select Emp_ID As [EmpID], Emp_Name As [Name] From Resource_Master Where Role_id in ('DVL','PL','PM') And Active_Status='1'
	End
	Else If(@Option=12) -- for Testing_Request PN
	Begin
		Select distinct Project_Name,Project_ID from tbl_Testing_Requests where Status in ('A','W','ACP')
	End
	Else If(@Option=13) -- for Testing_Request Tokens of project
	Begin
		Select Token_Number from tbl_Testing_Requests where Project_ID = @Param2 and Status in ('A','W','ACP')
	End
	Else If(@Option=14) -- for Testing_Request Token Details of project
	Begin
		Select Brief_User_Requirement , Brief_Requirement_Attachement from tbl_Testing_Requests where Token_Number = @Param1
	End
	Else If(@Option=15)
	Begin
		Select Project_Name, Project_ID From Project_Master
		Where Project_Manager in (Select Emp_ID From Resource_Master Where Role_ID='DBAPM')
	End
	Else If(@Option=16)
	Begin
		Select MM.Module_Name, MM.Module_ID
		From Project_details PD, Module_Master MM
		Where PD.Project_ID=@Param1 And PD.Phase_ID in (Select Phase_ID From Phase_Master Where UPPER(Phase_Name) like UPPER('Development'))
			And PD.Module_ID=MM.Module_ID
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_GetInfo
-- --------------------------------------------------






CREATE proc [dbo].[usp_GetInfo] --'E12024','8'             
 @Emp_ID Char(20),              
 @Option char(5)              
              
As               
Begin              
	If (@Option='1')              
	Begin               
		Select Task_Status_ID As [SID], Task_Status_Name As [Status]               
		From Task_Status_Master Order By Task_Status_Name              
	End              
	Else If (@Option='2')              
	Begin              
		select Emp_ID From Client_Master Where HOD=@Emp_ID                  
	End              
	Else If (@option='3') --Project Name Comobo BOX - ON Change Request Form               
	Begin              
		Select MM.Module_Name, MM.Module_ID               
		From Module_Master MM
		inner join Project_Details on Project_Details.Module_ID = MM.Module_ID      
		join Phase_Master PHM on Project_Details.Phase_ID=PHM.Phase_ID        
		Where Project_Details.Project_ID = @Emp_ID and PHM.Phase_Name in ('Development','DEVELOPMENT','development')             
	End              
	Else If (@option='4') --Project Name Comobo BOX - ON Change Request Form               
	Begin              
		If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Project_Name As [Project], Project_ID As [PID] From Project_Master 
			Where Project_Manager in (Select Emp_ID From Client_Master Where HOD=@Emp_ID and Role_ID='PL' Union Select @Emp_ID )           
			Order BY Project_Name
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='PL')
		Begin
			Select Project_Name As [Project], Project_ID As [PID] 
			From Project_Master 
			Where Project_Leader = @Emp_ID 
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='DBAPM')
		Begin
			Select Project_Name As [Project], Project_ID As [PID] From Project_Master 
			Where Project_Manager in (Select Emp_ID From Client_Master Where HOD=@Emp_ID and Role_ID='DBAPL' Union Select @Emp_ID )           
			Order BY Project_Name
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='DBAPL')
		Begin
			Select Project_Name As [Project], Project_ID As [PID] 
			From Project_Master 
			Where Project_Leader = @Emp_ID 
		End
	End              
	Else If (@option='5') --Project Name Comobo BOX - ON Change Request Form               
	Begin              
		Select Module_Master.Module_ID As [MID], Module_Name As [Module] 
		From Module_Master              
		Inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID              
		Where Project_Details.Project_ID = @Emp_ID               
	End              
	Else If(@option ='6')              
	Begin              
		Declare @i varchar(15)              
		Select @i = HOD from Client_Master where Emp_ID = @Emp_ID and Role_ID in ('PC','PO')              
		Select Project_Name               
		from Request_Master               
		where Request_Status_ID in ('ABA','H')              
		and Requested_By in (Select Emp_ID From Client_Master where HOD = @i)              
	End              
	Else If(@Option = '7')              
	Begin              
		Select Project_Name, Project_ID 
		From Project_Master 
		Where Request_ID = @Emp_ID              
	End              
	Else If(@option ='8')              
	Begin          
		If((Select Role_ID From Client_Master (nolock) Where Emp_ID=@EMP_ID) = 'C'  )    
		Begin
			Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code              
			From Request_Master RM              
				join Project_Master PM on RM.Request_ID=PM.Request_ID              
			where RM.Requested_By = @Emp_ID AND RM.Request_Status_ID NOT IN ('RBH','RBA','NCFH','NCFA')
			Order By RM.Project_Name
--				and RM.Request_Status_ID In ('C')   
		End
		Else If((Select Role_ID From Client_Master (nolock) Where Emp_ID=@EMP_ID) = 'PC'  )    
		Begin
			Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code              
			From Request_Master RM              
				join Project_Master PM on RM.Request_ID=PM.Request_ID
			where (PM.Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)) 
			AND RM.Request_Status_ID NOT IN ('RBH','RBA','NCFH','NCFA')  
			Order by RM.Project_Name 
--			Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code              
--			From Request_Master RM              
--				join Project_Master PM on RM.Request_ID=PM.Request_ID
--				inner join Coordinator_Master COM on COM.Request_ID = RM.Request_ID              
--			where (RM.Requested_By = @Emp_ID or COM.Employee_id=@Emp_ID)  AND RM.Request_Status_ID NOT IN ('RBH','RBA','NCFH','NCFA')  
--			Order BY RM.Project_Name
--				and RM.Request_Status_ID In ('ABA', 'PMA', 'APM', 'DLG','C')   or CM.Employee_ID = @Emp_ID)
		End
		Else If((Select Role_ID From Client_Master (nolock) Where Emp_ID=@EMP_ID) ='PO')  
		Begin
			Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code              
			From Request_Master RM              
				join Project_Master PM on RM.Request_ID=PM.Request_ID
			where (PM.Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)) 
			AND RM.Request_Status_ID NOT IN ('RBH','RBA','NCFH','NCFA')  
			Order by RM.Project_Name 
--				and RM.Request_Status_ID In ('ABA', 'PMA', 'APM', 'DLG','C') or CM.Employee_ID = @Emp_ID)  
		End
        Else If(((Select Role_ID From Client_Master (nolock) Where Emp_ID=@EMP_ID) ='AA') or ((Select Role_ID From Client_Master (nolock) Where Emp_ID=@EMP_ID) ='SYA'))
		Begin
			Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code              
			From Request_Master RM              
				join Project_Master PM on RM.Request_ID=PM.Request_ID              
			where RM.Requested_By In (Select Emp_ID From Client_Master Where Role_ID in ('PC','PO','AA','SYA'))    
				and RM.Request_Status_ID In ('PBA','ABA', 'PMA', 'APM', 'DLG')   
			Order By RM.Project_Name
		End
		Else If((Select Role_ID From Client_Master (nolock) Where Emp_ID=@EMP_ID) ='PL')    
		Begin
			Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code              
			From Request_Master RM              
				join Project_Master PM on RM.Request_ID=PM.Request_ID              
			where PM.Project_Leader = @Emp_ID 
				and RM.Request_Status_ID In ('DLG')   
		End
		Else If((Select Role_ID From Client_Master (nolock) Where Emp_ID=@EMP_ID) ='PM')    
		Begin
			Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code              
			From Request_Master RM              
				join Project_Master PM on RM.Request_ID=PM.Request_ID              
			where PM.Project_Manager in (Select Emp_ID From Client_master Where HOD=@Emp_ID Union Select @Emp_ID)   
				and RM.Request_Status_ID In ('APM','DLG')   
		End
	End              
	Else If(@option = '9')              
	Begin              
		Select Request_Status_Name, Request_Status_ID                
		From Request_Status_Master              
		Order By request_Status_name
	End              
	Else If(@option = '10')              
		Begin              
--		Declare @HOD varchar(15)              
--		Select @HOD = HOD from Client_Master where Emp_ID = @Emp_ID              
--		Select Emp_Name, Emp_ID              
--		From Client_Master              
--		where HOD = @HOD     
		Select Emp_Name, Emp_ID
		From
		(
			Select Emp_Name, Emp_ID
			From Client_Master 
			Where HOD=@Emp_ID --and Role_ID='PC'

			Union

			Select Emp_Name, Emp_ID
			From Client_Master
			Where Emp_ID=@Emp_ID
			
		)T Order By Emp_Name

	End              
	Else If(@option = '11')              
	Begin              
		Select Project_Master.Project_Name,Project_ID               
		from Request_Master inner join Project_Master on Request_Master.Request_ID = Project_Master.Request_ID              
		Where (Requested_By in (Select Emp_ID From Client_Master where HOD = @Emp_ID) or
				Requested_By=@Emp_ID)             
	End              
	Else If(@option = '12')              
	Begin              
	   Select Emp_ID As [EmpID], Emp_Name As [Name] from Client_Master          
	   Where Role_ID In ('STU') and HOD = @Emp_ID             
	End              
	Else If (@option='13') --Project Name Comobo BOX - ON Change Request Form               
	Begin              
		Select Priority_ID As [PID], Priority_Name As [Priority] From Request_Priority_master              
	End              
	Else IF (@option='14') -- This is being used for getting the Porject Names              
	Begin  
		Select Project_Name, Project_ID From project_master Order By Project_Name              
	End              
	Else IF (@option='15')  -- This is being used for getting the ADM Resources              
	Begin              
		select Emp_Name, Emp_ID from Client_Master where Role_ID in ('PC','PO') order by Emp_Name              
	End              
	Else IF (@option='16')  -- This is being used for getting the ADM Resources              
	Begin              
--		Select Task_Master.Project_ID As [ProjectID], PM.Project_Name As [ProjectName],Change_ID As [ChangeID],
--			PHM.Phase_ID As [PhaseID],PHM.Phase_Name As [Phase],
--			MM.Module_ID As [ModuleCode], MM.Module_Name As [ModuleName],  Left(AS_SDT,20) As [AssignSD], Left(AS_EDT,20) As [AssignED],					
--			Task_Detail As [Details], Priority_ID As [Priority], Client_Master.Emp_Name As [Resource],              
--			(AS_Time/60) As [Hrs], (AS_Time%60) As [Mins], Left(AC_SDT,20) As [ActualSD], Left(AC_EDT,20) As [ActualED],
--			(AC_Time/60) As [ACHrs], (AC_Time%60) As [ACMins], Task_Master.Remark, Status_ID as Status 
--		From Task_Master          
--			Inner Join Client_Master On Client_Master.Emp_ID = Assigned_to           
--			Join Project_master PM On PM.Project_ID = Task_Master.Project_ID   
--			Join Phase_Master PHM On Task_Master.Phase_ID=PHM.Phase_ID      
--			Join Module_Master MM On Task_Master.Module_ID = MM.Module_ID          
--		Where Task_Id = @Emp_ID      

		If((Select Count(task_ID) from task_master where Task_ID=@Emp_ID and Assigned_To=Assigned_By) < 1)
		Begin
			Select Task_Master.Project_ID As [ProjectID], PM.Project_Name As [ProjectName],Change_ID As [ChangeID],
				PHM.Phase_ID As [PhaseID],PHM.Phase_Name As [Phase],
				MM.Module_ID As [ModuleCode], MM.Module_Name As [ModuleName],  Left(AS_SDT,20) As [AssignSD], Left(AS_EDT,20) As [AssignED],					
				Task_Detail As [Details], Priority_ID As [Priority], Client_Master.Emp_Name As [Resource],              
				(AS_Time/60) As [Hrs], (AS_Time%60) As [Mins], Left(AC_SDT,20) As [ActualSD], Left(AC_EDT,20) As [ActualED],
				(AC_Time/60) As [ACHrs], (AC_Time%60) As [ACMins], Task_Master.Remark, Status_ID as Status, 
				Task_Master.Task_Name As [Task_Name], Task_Master.T_Attachment As [Attachment]
			From Task_Master          
				Inner Join Client_Master On Client_Master.Emp_ID = Assigned_to           
				Join Project_master PM On PM.Project_ID = Task_Master.Project_ID   
				Join Phase_Master PHM On Task_Master.Phase_ID=PHM.Phase_ID      
				Join Module_Master MM On Task_Master.Module_ID = MM.Module_ID         
			Where Task_Id = @Emp_ID  
		
			Select Request_ID From Task_Master where Task_Id =@Emp_ID
		End
		Else if((Select Count(task_ID) from task_master where Task_ID=@Emp_ID and Assigned_To=Assigned_By) > 0)
		Begin	
			Select TM.Project_ID As [ProjectID], PM.Project_Name As [ProjectName],Change_ID As [ChangeID],
				PHM.Phase_ID As [PhaseID],PHM.Phase_Name As [Phase],
				TM.Module_ID As [ModuleCode], TM.Module_ID As [ModuleName],  Left(AS_SDT,20) As [AssignSD], Left(AS_EDT,20) As [AssignED],					
				Task_Detail As [Details], Priority_ID As [Priority], Client_Master.Emp_Name As [Resource],              
				(AS_Time/60) As [Hrs], (AS_Time%60) As [Mins], Left(AC_SDT,20) As [ActualSD], Left(AC_EDT,20) As [ActualED],
				(AC_Time/60) As [ACHrs], (AC_Time%60) As [ACMins], TM.Remark, Status_ID as Status,
				TM.Task_Name As [Task_Name], TM.T_Attachment As [Attachment] 
			From Task_Master  TM
				join Phase_Master PHM on TM.Phase_ID=PHM.Phase_ID      
				Join Project_master PM On PM.Project_ID = TM.Project_ID
				Inner Join Client_Master On Client_Master.Emp_ID = TM.Assigned_to 
			Where TM.Task_ID=@Emp_ID and TM.Assigned_To=TM.Assigned_By

			Select Request_ID From Task_Master where Task_Id =@Emp_ID
		End        
	End              
	Else If(@option = '17')              
	Begin              
		Select Task_Status_Name, Task_Status_ID                
		From Task_Status_Master              
	End              
	Else If(@option = '18')              
	Begin              
		Select Emp_Name, Emp_ID From Client_Master Where Role_ID in ('PM','SYA','DBAPM')           
	End              
	Else If(@Option='19') -- Project Combobox for Project Owner        
	Begin        
		Select Distinct RM.Project_Name,ISNULL(PM.Project_ID,0) As Project_Code          
		From Request_master RM, Project_Master PM        
		Where RM.Requested_by in (select Emp_ID from client_master where hod=@Emp_ID)         
			and RM.Request_ID=PM.Request_ID and RM.Request_status_id in ('ABA','PMA')        
	End        
	Else If(@option = '20')   -- Task Details for S/w Team User      
	Begin              
		Select Task_ID, Task_ID       
		From Task_Master      
		Where AS_EDT >= getdate()      
			and Status_ID in ('P','W') and Assigned_To = @Emp_ID         
	End            
  
	Else If(@option = '21')   -- Team of Project Manager
	Begin              
		Select Emp_Name, Emp_ID
		from Client_Master             
		Where Emp_ID in (Select Emp_ID From Client_Master where HOD = @Emp_ID) Order By Emp_Name  
	End           

	Else If(@option = '22')   -- Issue Status      
	Begin              
		Select IssueStatusName, IssueStatus_ID
		from Issue_Status_Master
	End   
    Else If(@Option='23')
	Begin
		Select Phase_Name, Phase_ID From Phase_Master
	End
	Else If(@Option='24')
	Begin
		If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='AA')
		Begin
			Select Emp_NAME, Emp_ID From Resource_Master
			Where Role_ID = 'PM' And Active_Status=1
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='SYA')
		Begin
			Select Emp_NAME, Emp_ID From Resource_Master
			Where Role_ID = 'PM' And Active_Status=1
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Emp_NAME, Emp_ID From Resource_Master
			Where Project_Manager=@Emp_ID and Role_ID='PL' And Active_Status=1
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='PL')
		Begin
			Select Emp_NAME, Emp_ID From Resource_Master
			Where Emp_ID=@Emp_ID and Role_ID='PL' And Active_Status=1
		End
	End
	Else if(@option='25')
	Begin
		If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Distinct PM.Project_Name As [Project], PM.Project_ID As [PID] 
			From Project_Master PM, Change_Request_Master CRM
			Where PM.Project_Manager in (Select Emp_ID From Client_Master Where HOD=@Emp_ID and Role_ID='PL' Union Select @Emp_ID )           
				and PM.Request_ID=CRM.Request_ID
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='PL')
		Begin
			Select Distinct PM.Project_Name As [Project], PM.Project_ID As [PID] 
			From Project_Master PM , Change_Request_Master CRM
			Where PM.Project_Leader = @Emp_ID  and PM.Request_ID=CRM.Request_ID
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='DBAPM')
		Begin
			Select Distinct PM.Project_Name As [Project], PM.Project_ID As [PID] 
			From Project_Master PM, tbl_DBA_Request CRM
			Where PM.Project_Manager=@Emp_ID           
				and PM.Project_ID=CRM.Project_ID
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='DBAPL')
		Begin
			Select Distinct PM.Project_Name As [Project], PM.Project_ID As [PID] 
			From Project_Master PM , tbl_DBA_Request CRM
			Where PM.Project_Leader = @Emp_ID  and PM.Project_ID=CRM.Project_ID
		End
	End
	Else IF (@option='26') -- This is being used for getting the Porject Names              
	Begin  
		Select Distinct(PM.Project_Name) As [Project], PM.Project_ID As [PID] 
		From Project_Master PM , Change_Request_Master CRM
		Where PM.Request_ID=CRM.Request_ID          
	End 
	Else If (@option='27')
	Begin
		Select AS_SDate From Project_Master
		Where Project_ID=@Emp_ID
	End
	Else If (@option='28')
	Begin
		If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'PM')
		Begin
			Select Distinct(Change_ID)
			from Change_Request_Master CRM
			inner join Project_Master PRJM on PRJM.Request_ID = CRM.Request_ID
			Where (PRJM.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Emp_ID) OR
								PRJM.Project_Manager=@Emp_ID)
			--Select distinct Change_ID From Change_Request_Master Where Project_ID=@Emp_ID
		End
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'PL')
		Begin
			Select Distinct(Change_ID)
			from Change_Request_Master CRM
				inner join Project_Master PRJM on PRJM.Request_ID = CRM.Request_ID
				join Delegation_Master DM on CRM.Change_ID=DM.RequestID
			Where PRJM.Project_Leader=@Emp_ID 

			--Select distinct Change_ID From Change_Request_Master Where Project_ID=@Emp_ID
		End

		
	End
	Else If (@option='29')
	Begin
		Select Distinct(PRJM.Project_Name) As [Project], PRJM.Project_ID As [PID] 
		from Change_Request_Master CRM
		inner join Project_Master PRJM on PRJM.Request_ID = CRM.Request_ID
		Where CRM.Change_ID = @Emp_ID
	End

	Else If (@option='30')
	Begin
		Select Distinct(MM.Module_Name) As [Module], MM.Module_ID As [MID] 
		from Change_Request_Master CRM
		inner join Module_Master MM on MM.Module_ID = CRM.Module_ID
		Where CRM.Change_ID = @Emp_ID
	End

	Else If (@option='31')
	Begin
--		Select  Emp_ID,Emp_Name
--		from Client_Master             
--		Where (Emp_ID in (Select Emp_ID From Client_Master where HOD = @Emp_ID) or Emp_ID = @Emp_ID)

		If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'PM')
		Begin
			Select RM.Emp_ID, RM.Emp_name
			From Resource_Master RM, Client_Master CM
			Where RM.Project_Manager=@Emp_ID and CM.Emp_ID=RM.Emp_ID and CM.Role_ID in ('DVL','PL') 

			Union

			Select Emp_ID, Emp_Name
			From Client_Master where Emp_ID=@Emp_ID
		End
		If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'DBAPM')
		Begin
			Select RM.Emp_ID, RM.Emp_name
			From Resource_Master RM, Client_Master CM
			Where RM.Project_Manager=@Emp_ID and CM.Emp_ID=RM.Emp_ID and CM.Role_ID in ('DVL','DBAPL') 

			Union

			Select Emp_ID, Emp_Name
			From Client_Master where Emp_ID=@Emp_ID
		End	
	End

	Else If (@option='32')
	Begin
--		Select  Emp_ID,Emp_Name
--		from Client_Master             
--		Where HOD in (Select HOD From Client_Master where Emp_ID = @Emp_ID)  
--		and Role_ID in ('DVL')
		If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'PL')
		Begin
			Select RM.Emp_ID, RM.Emp_name
			From Resource_Master RM, Client_Master CM
			Where (RM.Project_Leader=@Emp_ID or RM.Project_Leader2=@Emp_ID) and CM.Emp_ID=RM.Emp_ID and RM.Role_ID in ('DVL') 
		
			Union

			Select Emp_ID, Emp_Name
			From Client_Master where Emp_ID=@Emp_ID
		End
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID) = 'DBAPL')
		Begin
			Select RM.Emp_ID, RM.Emp_name
			From Resource_Master RM, Client_Master CM
			Where (RM.Project_Leader=@Emp_ID or RM.Project_Leader2=@Emp_ID) and CM.Emp_ID=RM.Emp_ID and RM.Role_ID in ('DVL') 
		
			Union

			Select Emp_ID, Emp_Name
			From Client_Master where Emp_ID=@Emp_ID
		End

	End

	Else If (@option='33')  ----Request ID for Request Report (Project Owner)
	Begin
		Select Distinct(Request_ID)
		from Coordinator_Master             
		Where Employee_ID = @Emp_ID
		  and Role_ID in ('PO','PC')
	End

	Else If (@option='34')  ----Request ID for Request Report (Project Owner & Coordinators)
	Begin
		Select Emp_Name, Employee_ID 
		From Coordinator_Master 
		inner join Client_Master on Client_Master.Emp_ID = Coordinator_Master.Employee_ID
		Where Request_ID = @Emp_ID
		Order by Emp_Name
	End

	Else If (@option='35')  ----Request ID for Request Report (Project Name)
	Begin
		Select Distinct Project_Name, Project_Master.Project_ID 
		From Project_Master 
		inner join Coordinator_Master on Project_Master.Request_ID = Coordinator_Master.Request_ID
		Where Employee_ID = @Emp_ID
		Order By Project_Name
	End

	Else If (@option='36')  ----Change ID for Request Report (Change ID's)
	Begin
		Select Change_ID
		From Change_Request_Master 
		Where Request_ID = @Emp_ID
		Order by Change_ID
	End

	Else If (@option='37')  ----Change ID for Request Report (Change ID's)
	Begin
		Select Emp_Name, Emp_ID
		From Client_Master
		Where Role_ID = 'TS' Order by Emp_Name
	End

	Else If (@option='38')  ----Testers for Report PAge
	Begin
--		Select Distinct(Emp_ID), Emp_Name
--		From tbl_Testing_Requests
--		inner join Client_Master on Client_Master.Emp_ID = tbl_Testing_Requests.Tester 
--		Where Assigned_By = @Emp_ID
		
		Select Distinct(Emp_ID), Emp_Name
		From Resource_Master 
		Where Role_ID in ('TS','TSTL') Order by Emp_Name

	End
	Else If (@option='39')
	Begin
		Select Distinct(PHM.Phase_Name) As [Phase], PHM.Phase_ID  As [PhaseID] 
		from Change_Request_Master CRM
			inner join Phase_Master PHM on PHM.Phase_ID = CRM.Phase_ID
		Where CRM.Change_ID = @Emp_ID 
	End
	Else If (@option='40') -- Task ID of New Request 
	Begin
		if((Select Role_ID From Client_master Where Emp_ID=@Emp_ID) = 'PM')
		Begin
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where TM.Assigned_To=@Emp_ID
				and TM.Status_ID in ('P','W','R')
				and (TM.Change_ID='' or TM.Change_ID is NULL)
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and (TM.Change_ID='' or TM.Change_ID is NULL)
				and TM.Status_ID in ('P','W','R')
		
			UNION

			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where TM.Assigned_To=@Emp_ID and TM.Project_ID=PM.Project_ID
				and (TM.Change_ID<>'' and TM.Change_ID is NOT NULL)
				and TM.Status_ID in ('P','W','R')
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and TM.Status_ID in ('P','W','R')
		End
		Else if((Select Role_ID From Client_master Where Emp_ID=@Emp_ID) = 'PL')
		Begin
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where Assigned_To=@Emp_ID
				and (TM.Change_ID='' or TM.Change_ID is NULL)
				and TM.Status_ID in ('P','W','R')
				
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and (TM.Change_ID='' or TM.Change_ID is NULL)
				and TM.Status_ID in ('P','W','R')

			UNION

			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where TM.Assigned_To=@Emp_ID 
				and TM.Change_ID<>'' and TM.Change_ID is NOT NULL
				and TM.Status_ID in ('P','W','R')
				
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and (TM.Change_ID<>'' and TM.Change_ID is NOT NULL)
				and TM.Status_ID in ('P','W','R')
		End
		Else if((Select Role_ID From Client_master Where Emp_ID=@Emp_ID) = 'DVL')
		Begin
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and (TM.Change_ID='' or TM.Change_ID is NULL)
					and TM.Status_ID in ('P','W','R')

			UNION

			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and (TM.Change_ID<>'' and TM.Change_ID is NOT NULL)
			and TM.Status_ID in ('P','W','R')
		End
	End
	Else If (@option='41') -- Task ID of Change Request 
	Begin
		if((Select Role_ID From Client_master Where Emp_ID=@Emp_ID) = 'PM')
		Begin
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where TM.Assigned_To=@Emp_ID
				and TM.Status_ID in ('P','W','R')
				and (TM.Change_ID='' or TM.Change_ID is NULL)
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and (TM.Change_ID='' or TM.Change_ID is NULL)
				and TM.Status_ID in ('P','W','R')
		
			UNION

			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where TM.Assigned_To=@Emp_ID and TM.Project_ID=PM.Project_ID
				and (TM.Change_ID<>'' and TM.Change_ID is NOT NULL)
				and TM.Status_ID in ('P','W','R')
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and TM.Status_ID in ('P','W','R')
		End
		Else if((Select Role_ID From Client_master Where Emp_ID=@Emp_ID) = 'PL')
		Begin
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where Assigned_To=@Emp_ID
				and (TM.Change_ID='' or TM.Change_ID is NULL)
				and TM.Status_ID in ('P','W','R')
				
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and (TM.Change_ID='' or TM.Change_ID is NULL)
				and TM.Status_ID in ('P','W','R')

			UNION

			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM, Project_Master PM
			Where TM.Assigned_To=@Emp_ID 
				and TM.Change_ID<>'' and TM.Change_ID is NOT NULL
				and TM.Status_ID in ('P','W','R')
				
			UNION
			
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and Assigned_By=@Emp_ID
				and (TM.Change_ID<>'' and TM.Change_ID is NOT NULL)
				and TM.Status_ID in ('P','W','R')
		End
		Else if((Select Role_ID From Client_master Where Emp_ID=@Emp_ID) = 'DVL')
		Begin
			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and (TM.Change_ID='' or TM.Change_ID is NULL)
					and TM.Status_ID in ('P','W','R')

			UNION

			Select TM.Task_ID,TM.Task_ID
			From Task_Master TM
			Where Assigned_To=@Emp_ID and (TM.Change_ID<>'' and TM.Change_ID is NOT NULL)
			and TM.Status_ID in ('P','W','R')
		End
	End
	Else IF(@Option='42')
	Begin
		If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Project_Name,Project_ID From Project_Master 
			Where Project_Manager=@Emp_ID
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PL')
		Begin
			Select Project_Name,Project_ID From Project_Master 
			Where Project_Leader=@Emp_ID
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='AA' or (Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='SYA')
		Begin
			Select Distinct Project_Name,Project_ID From Project_Master 
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='DVL')
		Begin
			Select Project_Name,Project_ID From Project_Master 
			Where Project_Manager in (Select distinct Project_Manager From Resource_Master Where Emp_ID=@Emp_ID)
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='TSTL')
		Begin
			Select Distinct Project_Name,Project_ID From Project_Master 
		End
	End

	Else IF(@Option='43')
	Begin
		If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Emp_Name,Emp_ID From Resource_Master
			Where Project_Manager=@Emp_ID

			Union 
			
			Select Emp_Name,Emp_ID From Resource_Master
			Where Emp_ID=@Emp_ID

		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PL')
		Begin
			Select Emp_Name,Emp_ID From Resource_Master
			Where Project_Leader=@Emp_ID or Project_Leader2=@Emp_ID

			Union 
			
			Select Emp_Name,Emp_ID From Resource_Master
			Where Emp_ID=@Emp_ID 
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='AA' or (Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='SYA')
		Begin
			Select Emp_Name,Emp_ID From Resource_Master
			Where Role_ID in ('PM','PL','DVL')
		End
	End
	Else IF(@Option='44')
	Begin
		If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Project_Name,Project_ID From Project_Master
			Where Project_Manager=@Emp_ID

			Union 
			
			Select Project_Name,Project_ID From Project_Master
			Where Project_Name='Software Team Activity'

		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PL')
		Begin
			Select Project_Name,Project_ID From Project_Master
			Where Project_Leader=@Emp_ID 

			Union 
			
			Select Project_Name,Project_ID From Project_Master
			Where Project_Name='Software Team Activity' 
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='AA' or (Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='SYA')
		Begin
			Select Project_Name,Project_ID From Project_Master
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='DVL')
		Begin
			Select Project_Name,Project_ID From Project_Master
			Where Project_Manager=(Select HOD From Resource_Master Where Emp_ID=@Emp_ID )

			Union 
			
			Select Project_Name,Project_ID From Project_Master
			Where Project_Name='Software Team Activity' 
		End
	End
	Else If(@Option='45')
	Begin
		Select RM.Request_ID, PM.Project_ID, RM.Brief_Requirement, RM.BR_Attachment 
		From Request_Master RM, Project_master PM
		Where RM.Request_ID=PM.Request_ID And Project_ID=@Emp_ID
	End
	Else If(@Option='46')
	Begin
		Select CRM.Change_ID, CRM.Request_ID, CRM.Project_ID, CRM.Description, CRM.Attachment
		From Change_Request_Master CRM
		Where CRM.Change_ID=@Emp_ID
	End
	Else If(@Option='47')
	Begin
		Select Emp_ID As [EmpID], Emp_Name As [Name] From Resource_Master Where Role_id=@Emp_ID
	End
	Else If(@Option='48')
	Begin
		Select Distinct(CRM.Change_ID)
		From Change_Request_Master CRM
				inner join Project_Master PRJM on PRJM.Request_ID = CRM.Request_ID
		Where PRJM.Project_ID=@Emp_ID and 
				CRM.Change_ID Not In (Select Change_ID From Task_Master Where Project_ID=@Emp_ID)
			and CRM.Request_Status_ID in ('ACP','DLG')
	End
	Else IF(@Option='49') -- for testing project names
	Begin
		If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Project_Name,Project_ID From Project_Master 
			Where Project_Manager = @Emp_ID Order by Project_Name
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID) = 'PL')
		Begin
			Select Project_Name,Project_ID From Project_Master 
			Where Project_Leader = @Emp_ID Order by Project_Name
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID) = 'DVL')
		Begin
			Select Project_Name,Project_ID From Project_Master 
			Where Project_Manager in (Select distinct Project_Manager From Resource_Master Where Emp_ID=@Emp_ID) Order by Project_Name
		End
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='AA' or (Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='SYA')
		Begin
			Select Distinct Project_Name,Project_ID From Project_Master Order by Project_Name
		End
		
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='TSTL')
		Begin
			Select Distinct Project_Name,Project_ID From Project_Master Order by Project_Name
		End
	End
	Else IF(@Option = '50')
	Begin
		Select Emp_Name,Emp_Id from Resource_Master
		where Role_ID in ('TS','TSTL')
	End
	Else IF(@Option = '51')
	Begin
		Select Distinct Department From Client_Master Where Role_ID in ('C','PC','PO','AA','SYA','PM') Order BY Department
	End
	Else If(@Option = '52')
	Begin
		Select Emp_ID,Emp_Name from Resource_Master
		Where Emp_ID = @Emp_ID or 
		Emp_ID in (Select Emp_ID from Client_Master Where Role_ID in ('PM','PL','DVL')) 
	End
	Else If(@Option = '53') -- Project Closure Page -- Project Manager Combo
	Begin
		If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID ) in ('AA','SYA')) 
		Begin
			Select Emp_ID,Emp_Name from Resource_Master
			Where Emp_ID in (Select Emp_ID from Client_Master Where Role_ID in ('SYA','PM')) 
			Order BY Emp_Name
		End
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Emp_ID ) in ('PM'))
		Begin
			Select Emp_ID,Emp_Name from Resource_Master
			Where Emp_ID=@Emp_ID
		End
	End
	Else If(@Option = '54') -- Project Closure Page -- Project Combo
	Begin
		Select Project_ID,Project_Name from Project_Master
		Where Project_Manager=@Emp_ID
		Order BY Project_Name
	End
	Else If(@Option='55') --Project List on Project reference
	Begin
		If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)= 'AA')
		Begin
			Select PM.Project_ID, PM.Project_Name 
			From Project_Master PM
			Order by Project_Name
		End
	End
	Else If(@Option = '56') -- Task History 
	Begin
	
		Select Task_ID As [Task ID], Task_Name As [Task Name], 
				Request_ID=(Case When TM.Change_ID='' Then TM.Request_ID When TM.Change_ID IS NULL Then  TM.Request_ID When TM.Change_ID<>'' Then TM.Change_ID End),
				PM.Project_Name As [Project], TM.AS_DT AS [Assigned Date], AS_SDT As [Assigned Start Date], 
				AS_EDT As [Assigned End Date],RSM.Emp_Name As [Resource], TSM.Task_Status_Name As [Status]
		From Task_Master TM, Project_Master PM, Task_Status_Master TSM, Resource_Master RSM
		Where Change_ID=@Emp_ID And TM.Project_ID=PM.Project_ID
			And TM.Status_ID=TSM.Task_Status_ID And TM.Assigned_To=RSM.Emp_ID
	End
	Else If(@Option = '57') -- Project Owner list
	Begin
		Select distinct Emp_ID, Emp_Name 
		From Client_Master 
		Where Role_ID in ('PO')	
		Order By Emp_Name
	End
	Else If(@Option = '58') -- Project Owner, Coordinator list
	Begin
		Select distinct Emp_ID, Emp_Name 
		From Client_Master 
		Where Role_ID in ('PO','PC')
		Order By Emp_Name	
	End
	Else If(@Option = '59') -- Project Owner, Coordinator list
	Begin
		Select distinct Emp_ID, Emp_Name 
		From Client_Master 
		Where Role_ID in ('PM','SYA')
		Order By Emp_Name	
	End
	Else If(@Option = '60') -- Change Request ID On Task Assign Page
	Begin
		Select Distinct(CRM.Change_ID)
		From Change_Request_Master CRM
				inner join Project_Master PRJM on PRJM.Request_ID = CRM.Request_ID
		Where PRJM.Project_ID=@Emp_ID and 
				CRM.Change_ID Not In (Select Change_ID From Task_Master Where Project_ID=@Emp_ID)
			and CRM.Request_Status_ID in ('DLG')
	End
	Else If(@Option='61')
	Begin
		If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='SYA')
		Begin
			Select Emp_NAME, Emp_ID From Resource_Master
			Where Role_ID = 'PM' And Active_status='1'
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Emp_NAME, Emp_ID From Resource_Master
			Where Project_Manager=@Emp_ID and Role_ID='PL' And Active_status='1'
		End
	End
	Else If (@option='62')
	Begin
		Select RM.Emp_ID, RM.Emp_name
		From Resource_Master RM, Client_Master CM
		Where RM.Project_Manager=@Emp_ID and CM.Emp_ID=RM.Emp_ID and CM.Role_ID in ('DVL','PL') 
			And RM.Active_Status='1'
		Union

		Select Emp_ID, Emp_Name
		From Client_Master where Emp_ID=@Emp_ID
	End

	Else If (@option='63')
	Begin

		Select RM.Emp_ID, RM.Emp_name
		From Resource_Master RM, Client_Master CM
		Where (RM.Project_Leader=@Emp_ID or RM.Project_Leader2=@Emp_ID) and CM.Emp_ID=RM.Emp_ID and RM.Role_ID in ('DVL') 
			And RM.Active_Status='1'

		Union

		Select Emp_ID, Emp_Name
		From Client_Master where Emp_ID=@Emp_ID

	End
	Else If(@Option='64')
	Begin
		Select Emp_ID As [EmpID], Emp_Name As [Name] From Resource_Master Where Role_id=@Emp_ID And Active_Status='1'
	End
	Else If(@Option='65')
	Begin
		If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='PM')
		Begin
			Select Emp_Name,Emp_ID From Resource_Master
			Where Project_Manager = @Emp_ID and Role_Id = 'PL'
		End		
		Else If((Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='AA' or (Select Role_ID from Client_Master Where Emp_ID=@Emp_ID)='SYA')
		Begin
			Select Emp_Name,Emp_ID From Resource_Master
			Where Role_ID = 'PM'
		End
	End
	Else If(@Option='66')
	Begin
		Select Distinct(CRM.DBA_ID)
		From tbl_DBA_Request CRM
				inner join Project_Master PRJM on PRJM.Project_ID = CRM.Project_ID
		Where PRJM.Project_ID=@Emp_ID and 
				CRM.DBA_ID Not In (Select Change_ID From Task_Master Where Project_ID=@Emp_ID)
			and CRM.Status in ('ACP')
	End
	Else If(@Option='67')
	Begin
		Select Distinct(PHM.Phase_Name) As [Phase], PHM.Phase_ID  As [PhaseID] 
		from tbl_DBA_Request CRM
			inner join Phase_Master PHM on PHM.Phase_ID = CRM.Phase_ID
		Where CRM.DBA_ID = @Emp_ID 
	End
	Else If(@Option='68')
	Begin
		Select Distinct(MM.Module_Name) As [Module], MM.Module_ID As [MID] 
		from tbl_DBA_Request CRM
		inner join Module_Master MM on MM.Module_ID = CRM.Module_ID
		Where CRM.DBA_ID = @Emp_ID
	End
	Else If(@Option='69')
	Begin
		Select DBA_ID, Req_Desc
		from tbl_DBA_Request 
		Where DBA_ID = @Emp_ID
	End
End


--Select * From Resource_Master

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GetProjectName
-- --------------------------------------------------
Create Proc USP_GetProjectName


@ProjectName varchar(100),  
@Project_Manager Char(20),  
@Option Char(20) 

As

Begin
	If(@Option = '1')  
	Begin  
		If((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'PM')
		Begin
			Select PM.Project_Name, PM.Project_ID, PM.Priority, PM.AS_SDate, PM.AS_EDate 
			From Project_Master PM, Request_Master RM
			Where (PM.Project_Manager=@Project_manager or PM.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager))
				and PM.Request_ID=RM.Request_ID and RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@ProjectName)
				and RM.Request_Status_ID not in ('RBH','NCFH','RBA','PBA','NCFA','PBH','RBA')
		End 
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'PL')
		Begin
			Select PM.Project_Name, PM.Project_ID, PM.Priority, PM.AS_SDate, PM.AS_EDate 
			From Project_Master PM, Request_Master RM 
			Where PM.Project_Leader=@Project_manager  
				and PM.Request_ID=RM.Request_ID and RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@ProjectName)
				and RM.Request_Status_ID not in ('RBH','NCFH','RBA','PBA','NCFA','PBH','RBA')
		End 
		Else If(((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'AA') or ((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'SYA'))
		Begin
			Select PM.Project_Name, PM.Project_ID, PM.Priority, PM.AS_SDate, PM.AS_EDate,RM.Request_Status_ID 
			From Project_Master PM, Request_Master RM 
			Where PM.Request_ID=RM.Request_ID and RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@ProjectName)
				and RM.Request_Status_ID not in ('RBH','NCFH','RBA','PBA','NCFA','PBH','RBA')
		End
	End 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Issue_Opertion
-- --------------------------------------------------

  
CREATE Procedure [dbo].[usp_Issue_Opertion] --'000001','73','Fuel','Fuel Efficiency','E23109','E23232', ' New Version','','P','1'  
(  
@Project_Name varchar(20),  
@Module_Name int,  
@Issue varchar(50),  
@Description varchar(150),  
@Reported_By varchar(20),  
@Escalated_To varchar(20),  
@Solution varchar(200),  
@Recommended_Solution varchar(200),  
@Issue_Status_ID varchar(200),  
@Issue_Type varchar(20),  
@Issue_Category varchar(50),  
@IssueID varchar(20), 
@Option varchar(20)  
)  
as  
Begin  
if(@Option = '1')  
 Begin  
 Declare @Issue_ID varchar(20)  
 Set @Issue_ID = dbo.GenerateID(5,'')  
  
 Insert Into Issue_Master Values (@Issue_ID, @Project_Name, @Module_Name, @Issue,      
    @Description, @Reported_By, @Escalated_To, @Solution, @Recommended_Solution, @Issue_Status_ID, @Issue_Type,@Issue_Category )      
      
 Insert Into Issue_Details (Issue_ID,Project_Name,Module_Name,Issue,Description,Reported_By,Escalated_To,Solution,Recommended_Solution,Issue_Status_ID, Issue_Type, Issue_Category)  
    Values (@Issue_ID, @Project_Name, @Module_Name, @Issue,      
    @Description, @Reported_By, @Escalated_To, @Solution, @Recommended_Solution, @Issue_Status_ID, @Issue_Type, @Issue_Category)      
       
 Select @Issue_ID      
 End  
  
Else If(@Option = '2')  
 Begin  
 Select Distinct(Issue_Master.Issue) --, Issue_Master.Issue_ID  
 From Issue_Master  
 Where Issue_Master.Project_ID = @Project_Name  
   and Issue_Master.Module_ID = @Module_Name  
 End      
  
Else If(@Option = '3')  
 Begin  
 Select Solution_Master.Solution, Solution_Master.Solution_ID, Problem as [Problem]
 From Solution_Master  
 inner join Project_Master on Project_Master.Project_ID = Solution_Master.Project_ID 
 inner join Module_Master on Module_Master.Module_ID = Solution_Master.Module_ID 
 Where Solution_Master.Project_ID = @Project_Name  
   and Solution_Master.Module_ID = @Module_Name
 End      
  
Else If(@Option = '4')   --- Get Issue Details for Pending page Link @ProjectName  = Issue ID
 Begin  
 Select Project_Master.Project_Name, Issue_Master.Project_ID, Module_Master.Module_Name, Issue_Master.Module_ID, Issue_Master.Issue, Issue_Master.Description,
 Issue_Master.Reported_By, Issue_Master.Escalated_To, Issue_Master.Solution,
 Issue_Master.Recommended_Solution, Issue_Master.Issue_Status_ID, Issue_Master.Issue_Type, Issue_Master.Issue_Category
 From Issue_Master
 inner join Project_Master on Project_Master.Project_ID = Issue_Master.Project_ID
 inner join Module_Master on Module_Master.Module_ID = Issue_Master.Module_ID
 Where Issue_Master.Issue_ID = @IssueID
 and Issue_Status_ID in ('P','E')
 End      

Else If(@Option = '5')   --- Get Issue Details for Pending page @ProjectName  = EmpID
 Begin  
	 Select Issue_Master.Issue_ID as [Issue ID], Project_Master.Project_Name as [Project Name],  Module_Master.Module_Name as [Module Name], Issue_Master.Issue, Issue_Master.Issue_Type as [Issue Type],
	 Issue_Master.Issue_Category  as [Issue Category], Client_Master.Emp_Name as [Reported By], CM.Emp_Name as [Escalated To], Issue_Status_Master.IssueStatusName as Status 
	 From Issue_Master
	 inner join Client_Master on Client_Master.Emp_ID = Issue_Master.Reported_By
	 inner join Client_Master CM on CM.Emp_ID = Issue_Master.Escalated_To
	 inner join Project_Master on Project_Master.Project_ID = Issue_Master.Project_ID
	 inner join Module_Master on Module_Master.Module_ID = Issue_Master.Module_ID
	 inner join Issue_Status_Master on Issue_Status_Master.IssueStatus_ID = Issue_Master.Issue_Status_ID
	 Where Issue_Master.Reported_By = @Project_Name or Issue_Master.Escalated_To = @Project_Name
 End 

     

Else If(@Option = '6')   --- Update Details of Issues
 Begin  

 Update Issue_Master Set Issue = @Issue, Description = @Description, Reported_By = @Reported_By, Escalated_To = @Escalated_To, Solution = @Solution,
 Recommended_Solution = @Recommended_Solution, Issue_Status_ID = @Issue_Status_ID, Issue_Type = @Issue_Type, Issue_Category = @Issue_Category
 Where Issue_ID = @IssueID
      
 Insert Into Issue_Details (Issue_ID,Project_Name,Module_Name,Issue,Description,Reported_By,Escalated_To,Solution,Recommended_Solution,Issue_Status_ID, Issue_Type, Issue_Category)  
    Values (@IssueID, @Project_Name, @Module_Name, @Issue,      
    @Description, @Reported_By, @Escalated_To, @Solution, @Recommended_Solution, @Issue_Status_ID, @Issue_Type, @Issue_Category)      
       
 Select @IssueID

 End 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Login_Success_Check
-- --------------------------------------------------


CREATE Proc [dbo].[USP_Login_Success_Check]

@ID As Varchar(50),
@Emp_ID As Varchar(50),
--@Harmony As Varchar(50),
@Option As Int

As 
Begin

	If(@option=1)
	Begin
		Select @ID = dbo.GenerateID ('7','')

		Insert Into Login_Check
		Values (@ID, @Emp_ID, getdate(),'','')

		Select @ID 
	End
	Else If(@option=2)
	Begin
		Update Login_Check
		Set Emp_ID_Success=@Emp_ID, Login_Success_Date=getdate()
		Where ID=@ID

		Select @ID 
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Login_Success_Check_New
-- --------------------------------------------------



CREATE Proc [dbo].[USP_Login_Success_Check_New]

@ID As Varchar(50),
@Emp_ID As Varchar(50),
@Harmony As Varchar(50),
@Option As Int

As 
Begin

	If(@option=1)
	Begin
		Select @ID = dbo.GenerateID ('8','')

		Insert Into Login_Check_New
		Values (@ID, @Emp_ID, getdate(),'','',@Harmony)

		Select @ID 
	End
	Else If(@option=2)
	Begin
		Update Login_Check_New
		Set Emp_ID_Success=@Emp_ID, Login_Success_Date=getdate()
		Where ID=@ID

		Select @ID 
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_LoginUser
-- --------------------------------------------------



CREATE proc [dbo].[usp_LoginUser] 
	@Emp_Id nvarchar(10),
	--@PWD nvarchar(15)
	@Option nvarchar(15)
as 
BEGIN
	
	IF @option=''
	Begin
		Select Emp_ID,Emp_Name,Designation,Department,Sub_Department,HOD,HOD_Name,Join_Date,
			Birthdate,CostCode,Company,Phone,EmailAdd,RoleMaster.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master Join RoleMaster
		on RoleMaster.Role_ID=Client_Master.Role_ID
		Where EMP_ID=@Emp_Id

	END
	ELSE IF @Option='CHECK'
	Begin
		Select lcm.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master 
			Join RoleMaster on RoleMaster.Role_ID=Client_Master.Role_ID
			JOIN Login_Category_Master lcm ON lcm.Category_ID = Client_Master.Category_ID
		Where EMP_ID=@Emp_Id
	END
	ELSE IF @Option='VD'
	BEGIN	
	    Select Emp_ID,Emp_Name,Designation,Department,Sub_Department,HOD,HOD_Name,Join_Date,
			Birthdate,CostCode,Company,Phone,EmailAdd,lcm.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master 
			Join RoleMaster on RoleMaster.Role_ID=Client_Master.Role_ID
			JOIN Login_Category_Master lcm ON lcm.Category_ID = Client_Master.Category_ID
		Where EMP_ID=@Emp_Id 
	END
	
END	
	

--SELECT * FROM Login_Category_Master lcm

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_LoginUser_NEW
-- --------------------------------------------------





CREATE proc [dbo].[usp_LoginUser_NEW]
	@Emp_Id nvarchar(10),
	@PWD nvarchar(15),
	@Option nvarchar(15)
as 
BEGIN
	
	IF @option='ANGEL'
	Begin
		Select Emp_ID,Emp_Name,Designation,Department,Sub_Department,HOD,HOD_Name,Join_Date,
			Birthdate,CostCode,Company,Phone,EmailAdd,RoleMaster.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master Join RoleMaster
		on RoleMaster.Role_ID=Client_Master.Role_ID
		Where Upper(EMP_ID)=upper(@Emp_Id)

	END
	IF @option='ADM'
	Begin
		Select Emp_ID,Emp_Name,Designation,Department,Sub_Department,HOD,HOD_Name,Join_Date,
			Birthdate,CostCode,Company,Phone,EmailAdd,RoleMaster.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master Join RoleMaster
		on RoleMaster.Role_ID=Client_Master.Role_ID
		Where upper(EMP_ID)=upper(@Emp_Id) And UPPER(Password)=Upper(@PWD)

	END
	ELSE IF @Option='CHECK'
	Begin
		Select lcm.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master 
			Join RoleMaster on RoleMaster.Role_ID=Client_Master.Role_ID
			JOIN Login_Category_Master lcm ON lcm.Category_ID = Client_Master.Category_ID
		Where upper(EMP_ID)=upper(@Emp_Id)
	END
	ELSE IF @Option='VD'
	BEGIN	
	    Select Emp_ID,Emp_Name,Designation,Department,Sub_Department,HOD,HOD_Name,Join_Date,
			Birthdate,CostCode,Company,Phone,EmailAdd,lcm.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master 
			Join RoleMaster on RoleMaster.Role_ID=Client_Master.Role_ID
			JOIN Login_Category_Master lcm ON lcm.Category_ID = Client_Master.Category_ID
		Where upper(EMP_ID)=upper(@Emp_Id) and upper(Password)=upper(@PWD)
	END
	Else If @option='Session'
	Begin
		Select Emp_ID,Emp_Name,Designation,Department,Sub_Department,HOD,HOD_Name,Join_Date,
			Birthdate,CostCode,Company,Phone,EmailAdd,RoleMaster.Category_ID,RoleMaster.Role_ID,Rolemaster.Role_name
		From Client_Master Join RoleMaster
		on RoleMaster.Role_ID=Client_Master.Role_ID
		Where upper(EMP_ID)=upper(@Emp_Id)

	END
	Else If @option='SessionHOD'
	Begin
		Select Emp_ID,Emp_Name,Designation,Department,Sub_Department,HOD,HOD_Name,Join_Date,
			Birthdate,CostCode,Company,Phone,EmailAdd,'' As Category_ID,
			'' As Role_ID ,
			'' As Role_name
		From Client_Master
		Where upper(EMP_ID)=upper(@Emp_Id)
	END
END	
	

--SELECT * FROM Login_Category_Master lcm

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Manage_Burndown
-- --------------------------------------------------



Create procedure [dbo].[USP_Manage_Burndown]  

  @param1 varchar(20), -- PM
  @param2 varchar(20), -- RID
  @paramDate1 Datetime,
  @option int  

As
Begin
  
	If(@Option=1)
	Begin
		Select Emp_Name, Emp_ID From Resource_master
		Where Role_ID in ('PM','SYA') And Active_Status='1'
		Order By Emp_Name
	End
	Else If(@option=2)
    Begin 
    	Select RM.Request_Id,RM.Project_Name,  
			RPM.Priority_Name [Priority],CM.EMP_NAME AS [Approved By],  
			Convert(varchar(11),RM.HOD_Approve_Date,113) AS [Approved On],  
			Convert(varchar(11),RM.Admin_Approve_Date,113) AS [Admin Approved Date],  
			PM.Priority as [System Priority],RSM.Emp_Name AS [Project Manager],  
			Request_Status_Master.Request_Status_Name AS [Current Status],  
			Convert(varchar(11),PM.AS_EDate,113) AS [REDate]
		  
		From Request_Master RM inner join Request_Priority_Master RPM  on RM.Priority_ID=RPM.Priority_ID  
			inner join Client_Master CM ON RM.HOD_Approve=CM.Emp_Id  
			inner join Project_Master PM on RM.Request_Id=PM.Request_Id  
			join Resource_Master RSM on PM.Project_Manager=RSM.Emp_Id  
			join Request_Status_Master on RM.Request_Status_ID=Request_Status_Master.Request_Status_ID  
		Where PM.Project_Manager=@param1 And RM.Request_Status_ID in ('ACP','DLG') 
        And PM.Reschedule <>'1'
		and Convert(varchar(12),PM.AS_EDate,110) < Convert(varchar(12),getdate(),110)

    End
    Else If(@Option= 3)
	Begin
		Update Project_Master
		Set AS_EDate=@paramDate1, Reschedule=1    
		Where Request_Id=@param2 
		
		Declare @ProjID as varchar(10)
		Declare @PID as char(10)
		
		set @PID = DBO.GenerateID('10','')
		
		Set @ProjID = (Select Project_ID From Project_Master Where Request_ID = @param2)  
		
		Insert Into Project_Master_Details 
		Select @PID,* from Project_Master where Project_NAme = @ProjID
		
		Select @param2
		
	End
	

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Manage_Burndown_UPDATE
-- --------------------------------------------------


Create procedure [dbo].[USP_Manage_Burndown_UPDATE]
(
    --@param varchar(50),  
    @param1 Datetime,
    --@Reshedule int,
	@Request_Id char(20)

)
as
begin

	update Project_Master
	set AS_EDate=@param1, Reschedule=1    
	where Request_Id=@Request_Id 

	Select @Request_ID
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Manage_Project
-- --------------------------------------------------





CREATE Proc [dbo].[USP_Manage_Project]

@Emp_ID As Char(20),
@Role_ID As Char(20),
@Request_ID As Char(20),
@Project_ID As Char(20),
@RA_Status AS bit,
@RA_Status_On As Varchar(25),
@RA_Status_By As Char(10),
@AD_Status AS bit,
@AD_Status_On As Varchar(25),
@AD_Status_By As Char(10),
@Testing_Status AS bit,
@Testing_Status_On As Varchar(25),
@Testing_Status_By As Char(10),
@UAT_Status AS bit,
@UAT_Status_On As Varchar(25),
@UAT_Status_By As Char(10),
@Close_Status AS bit,
@Close_Status_On As varchar(25),
@Close_Status_By As Char(10),
@Option As Int

As
Begin
	Declare @ProjID as varchar(10)
	Declare @PID as char(10)

	IF(@Option=1)
	Begin
		If Exists(Select Project_ID From Project_Status_Master Where Project_ID=@Project_ID)
		Begin
			Select Phase, Status, Flag
			From
			(
				Select 'Requirement Analysis' As Phase, Isnull(RA_Status,0) As Status, '1' As Flag
				From Project_Status_Master
				Where Project_ID=@Project_ID
		
				UNION

				Select 'Application Development' As Phase, Isnull(AD_Status,0) As Status, '2' As Flag
				From Project_Status_Master
				Where Project_ID=@Project_ID

				UNION

				Select 'Testing' As Phase, ISNULL(Testing_Status,0) As Status, '3' As Flag
				From Project_Status_Master
				Where Project_ID=@Project_ID

				UNION

				Select 'UAT' As Phase, ISNULL(UAT_Status,0) As Status, '4' As Flag
				From Project_Status_Master
				Where Project_ID=@Project_ID

				UNION

				Select 'Project Complete' As Phase, ISNULL(Close_Status,0) As Status, '5' As Flag
				From Project_Status_Master
				Where Project_ID=@Project_ID
			) T
			Order by Flag
		End
		Else 
		Begin
			Select Phase, Status, Flag
			From
			(
				Select 'Requirement Analysis' As Phase , 'False' As Status,'1' As Flag
				UNION
				Select 'Application Development' As Phase , 'False' As Status,'2' As Flag
				UNION
				Select 'Testing' As Phase, 'False' As Status,'3' As Flag
				UNION
				Select 'UAT' As Phase, 'False' As Status,'4' As Flag
				UNION
				Select 'Project Complete' As Phase, 'False' As Status,'5' As Flag
			) T
			Order by Flag
	
		End
	End
	Else IF(@Option=2)
	Begin
		Select 'Requirement Analysis' As Phase, AD_Status As Status
		From Project_Status_Master
		Where Project_ID=@Project_ID

		UNION


		Select 'Application Development' As Phase, AD_Status As Status
		From Project_Status_Master
		Where Project_ID=@Project_ID

		UNION

		Select 'Testing' As Phase, Testing_Status As Status
		From Project_Status_Master
		Where Project_ID=@Project_ID

		UNION

		Select 'UAT' As Phase, UAT_Status As Status
		From Project_Status_Master
		Where Project_ID=@Project_ID

		UNION

		Select 'Project Complete' As Phase, Close_Status As Status
		From Project_Status_Master
		Where Project_ID=@Project_ID

	End
	Else If(@option=3) -- Requirement Analysis
	Begin
		Set @Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Project_ID)

		If Exists(Select Project_ID From Project_Status_Master Where Project_ID=@Project_ID)
		Begin
			Update Project_Status_Master
			Set RA_Status=@RA_Status, RA_Status_ON=getdate(), RA_Status_BY=@RA_Status_By
			Where Project_ID=@Project_ID
		End
		Else 
		Begin
			Insert Into Project_Status_Master
			(Request_ID, Project_ID, RA_Status,RA_Status_ON,RA_Status_BY)
			Values (@Request_ID, @Project_ID, @RA_Status, getdate(), @RA_Status_BY)
		End 	
	
		Update Request_Master
		Set Request_Status_ID='PFD'
		Where Request_ID=@Request_ID

		Insert Into Request_Details
		Select top 1 '' As RD_ID,* From Request_Master
		Where Request_ID=@Request_ID

		Update Project_Master
		Set Status='PFD'
		Where Request_ID=@Request_ID

		Select @Project_ID	
		
		set @PID = DBO.GenerateID('10','')
		
		Set @ProjID = (Select Project_ID From Project_Master Where Request_ID = @Request_ID)  
		
		Insert Into Project_Master_Details 
		Select @PID,* from Project_Master where Project_ID = @ProjID

	End

	Else If(@option=4) -- Application Development
	Begin
		Set @Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Project_ID)

		If Exists(Select Project_ID From Project_Status_Master Where Project_ID=@Project_ID)
		Begin
			Update Project_Status_Master
			Set AD_Status=@AD_Status, AD_Status_ON=getdate(), AD_Status_BY=@AD_Status_By
			Where Project_ID=@Project_ID
		End
		Else 
		Begin
			Insert Into Project_Status_Master
			(Request_ID, Project_ID, RA_Status,RA_Status_ON,RA_Status_BY, AD_Status,AD_Status_ON,AD_Status_BY)
			Values (@Request_ID, @Project_ID, @AD_Status, getdate(), @AD_Status_BY, @AD_Status, getdate(), @AD_Status_BY)
		End 	
	
		Update Request_Master
		Set Request_Status_ID='PFT'
		Where Request_ID=@Request_ID

		Insert Into Request_Details
		Select top 1 '' As RD_ID,* From Request_Master
		Where Request_ID=@Request_ID

		Update Project_Master
		Set Status='PFT'
		Where Request_ID=@Request_ID

		Select @Project_ID	
		
		set @PID = DBO.GenerateID('10','')
		
		Set @ProjID = (Select Project_ID From Project_Master Where Request_ID = @Request_ID)  
		
		Insert Into Project_Master_Details 
		Select @PID,* from Project_Master where Project_ID = @ProjID

	End
	Else If(@option=5) -- Testing
	Begin
		Set @Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Project_ID)

		If Exists(Select Project_ID From Project_Status_Master Where Project_ID=@Project_ID)
		Begin
			If((Select AD_Status From Project_Status_Master Where Project_ID=@Project_ID)=0 OR (Select AD_Status From Project_Status_Master Where Project_ID=@Project_ID) IS Null)
			Begin
				Update Project_Status_Master
				Set AD_Status=@AD_Status, AD_Status_ON=getdate(), AD_Status_BY=@AD_Status_By,
					Testing_Status=@Testing_Status, Testing_Status_ON=getdate(), Testing_Status_BY=@Testing_Status_By
				Where Project_ID=@Project_ID
			End
			Else 
			Begin
				Update Project_Status_Master
				Set Testing_Status=@Testing_Status, Testing_Status_ON=getdate(), Testing_Status_BY=@Testing_Status_By
				Where Project_ID=@Project_ID
			End
		End
		Else 
		Begin
			Insert Into Project_Status_Master
			(Request_ID, Project_ID,RA_Status,RA_Status_ON,RA_Status_BY,AD_Status,AD_Status_ON,AD_Status_BY, Testing_Status,Testing_Status_ON,Testing_Status_BY)
			Values (@Request_ID, @Project_ID, @Testing_Status, getdate(), @Testing_Status_BY, @Testing_Status, getdate(), @Testing_Status_BY,  @Testing_Status, getdate(), @Testing_Status_BY)
		End 	

		Update Request_Master
		Set Request_Status_ID='PFU'
		Where Request_ID=@Request_ID

		Insert Into Request_Details
		Select top 1 '' As RD_ID,* From Request_Master
		Where Request_ID=@Request_ID

		Update Project_Master
		Set Status='PFU'
		Where Request_ID=@Request_ID

		Select @Project_ID	
	
		
		set @PID = DBO.GenerateID('10','')
		
		Set @ProjID = (Select Project_ID From Project_Master Where Request_ID = @Request_ID)  
		
		Insert Into Project_Master_Details 
		Select @PID,* from Project_Master where Project_ID = @ProjID

	End
	Else If(@option=6) -- UAT
	Begin
		Set @Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Project_ID)

		If Exists(Select Project_ID From Project_Status_Master Where Project_ID=@Project_ID)
		Begin
			If((Select Testing_Status From Project_Status_Master Where Project_ID=@Project_ID)=0 OR (Select Testing_Status From Project_Status_Master Where Project_ID=@Project_ID) IS Null)
			Begin 
				If((Select AD_Status From Project_Status_Master Where Project_ID=@Project_ID)=0 OR (Select AD_Status From Project_Status_Master Where Project_ID=@Project_ID) IS Null)
				Begin
					Update Project_Status_Master
					Set AD_Status=@UAT_Status, AD_Status_ON=getdate(), AD_Status_BY=@UAT_Status_By,
						Testing_Status=@UAT_Status, Testing_Status_ON=getdate(), Testing_Status_BY=@UAT_Status_By,
						UAT_Status=@UAT_Status, UAT_Status_ON=getdate(), UAT_Status_BY=@UAT_Status_By
					Where Project_ID=@Project_ID
				End
				Else 
				Begin
					Update Project_Status_Master
					Set Testing_Status=@UAT_Status, Testing_Status_ON=getdate(), Testing_Status_BY=@UAT_Status_By,
						UAT_Status=@UAT_Status, UAT_Status_ON=getdate(), UAT_Status_BY=@UAT_Status_By
					Where Project_ID=@Project_ID
				End
			End
			Else 
			Begin
				Update Project_Status_Master
				Set UAT_Status=@UAT_Status, UAT_Status_ON=getdate(), UAT_Status_BY=@UAT_Status_By
				Where Project_ID=@Project_ID
			End
		End
		Else 
		Begin
			Insert Into Project_Status_Master
			(Request_ID, Project_ID,RA_Status,RA_Status_ON,RA_Status_BY,AD_Status,AD_Status_ON,AD_Status_BY, Testing_Status,Testing_Status_ON,Testing_Status_BY, UAT_Status,UAT_Status_ON,UAT_Status_BY)
			Values (@Request_ID, @Project_ID,@UAT_Status, getdate(), @UAT_Status_BY,@UAT_Status, getdate(), @UAT_Status_BY,@UAT_Status, getdate(), @UAT_Status_BY, @UAT_Status, getdate(), @UAT_Status_BY)
		End 		
		
		Update Request_Master
		Set Request_Status_ID='UC'
		Where Request_ID=@Request_ID

		Insert Into Request_Details
		Select top 1 '' As RD_ID,* From Request_Master
		Where Request_ID=@Request_ID

		Update Project_Master
		Set Status='UC'
		Where Request_ID=@Request_ID

		Select @Project_ID
		
		set @PID = DBO.GenerateID('10','')
		
		Set @ProjID = (Select Project_ID From Project_Master Where Request_ID = @Request_ID)  
		
		Insert Into Project_Master_Details 
		Select @PID,* from Project_Master where Project_ID = @ProjID
	End
	Else If(@option=7) -- Complete
	Begin
		Set @Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Project_ID)

		If Exists(Select Project_ID From Project_Status_Master Where Project_ID=@Project_ID)
		Begin
			If((Select UAT_Status From Project_Status_Master Where Project_ID=@Project_ID)=0 OR (Select UAT_Status From Project_Status_Master Where Project_ID=@Project_ID) IS Null)
			Begin
				If((Select Testing_Status From Project_Status_Master Where Project_ID=@Project_ID)=0 OR (Select Testing_Status From Project_Status_Master Where Project_ID=@Project_ID) IS Null)
				Begin
					If((Select AD_Status From Project_Status_Master Where Project_ID=@Project_ID)=0 OR (Select AD_Status From Project_Status_Master Where Project_ID=@Project_ID) IS Null)
					Begin						
						Update Project_Status_Master
						Set AD_Status=@Close_Status, AD_Status_ON=getdate(), AD_Status_BY=@Close_Status_By,
							Testing_Status=@Close_Status, Testing_Status_ON=getdate(), Testing_Status_BY=@Close_Status_By,
							UAT_Status=@Close_Status, UAT_Status_ON=getdate(), UAT_Status_BY=@Close_Status_By,
							Close_Status=@Close_Status, Close_Status_ON=getdate(), Close_Status_BY=@Close_Status_By
						Where Project_ID=@Project_ID					
					End
					Else 
					Begin
						Update Project_Status_Master
						Set Testing_Status=@Close_Status, Testing_Status_ON=getdate(), Testing_Status_BY=@Close_Status_By,
							UAT_Status=@Close_Status, UAT_Status_ON=getdate(), UAT_Status_BY=@Close_Status_By,
							Close_Status=@Close_Status, Close_Status_ON=getdate(), Close_Status_BY=@Close_Status_By
						Where Project_ID=@Project_ID					
					End
				End
				Else
				Begin
					Update Project_Status_Master
					Set UAT_Status=@Close_Status, UAT_Status_ON=getdate(), UAT_Status_BY=@Close_Status_By,
						Close_Status=@Close_Status, Close_Status_ON=getdate(), Close_Status_BY=@Close_Status_By
					Where Project_ID=@Project_ID
				End
			End
			Else
			Begin
				Update Project_Status_Master
				Set Close_Status=@Close_Status, Close_Status_ON=getdate(), Close_Status_BY=@Close_Status_By
				Where Project_ID=@Project_ID
			End
		End
		Else 
		Begin
			Insert Into Project_Status_Master
			(Request_ID, Project_ID,RA_Status,RA_Status_ON,RA_Status_BY,AD_Status,AD_Status_ON,AD_Status_BY, Testing_Status,Testing_Status_ON,Testing_Status_BY, UAT_Status,UAT_Status_ON,UAT_Status_BY,Close_Status,Close_Status_ON,Close_Status_BY)
			Values (@Request_ID, @Project_ID,@Close_Status, getdate(), @Close_Status_BY,@Close_Status, getdate(), @Close_Status_BY,@Close_Status, getdate(), @Close_Status_BY,@Close_Status, getdate(), @Close_Status_BY ,@Close_Status, getdate(), @Close_Status_BY)
		End 		
	
		Update Request_Master
		Set Request_Status_ID='C'
		Where Request_ID=@Request_ID

		Insert Into Request_Details
		Select top 1 '' As RD_ID,* From Request_Master
		Where Request_ID=@Request_ID

		Update Project_Master
		Set Status='C'
		Where Request_ID=@Request_ID

		Select @Project_ID
		
		set @PID = DBO.GenerateID('10','')
		
		Set @ProjID = (Select Project_ID From Project_Master Where Request_ID = @Request_ID)  
		
		Insert Into Project_Master_Details 
		Select @PID,* from Project_Master where Project_ID = @ProjID
	End

	If(@option = 8) -- fill all project phases state
	Begin
		if(@Project_ID = '' or @Project_ID is null)
		Begin
			Select Project_Name,Project_ID,
					(Case when RA = 1 Then 'Complete' when RA IS NULL Then 'Pending' End) as [RA],
					(Case when AD = 1 Then 'Complete' when AD IS NULL Then 'Pending' End) as [AD],
					(Case when Testing = 1 Then 'Complete' when Testing IS NULL Then 'Pending' End) as [Testing],
					(Case when UAT = 1 Then 'Complete' when UAT  IS NULL Then 'Pending' End) as [UAT],
					(Case when Complete = 1 Then 'Complete' when Complete  IS NULL Then 'Pending' End) as [Complete] 
			From
			(
			Select distinct PM.Project_Name AS [Project_Name],PSM.Project_Id as [Project_Id],PSM.RA_Status as [RA],PSM.AD_Status as [AD],PSM.Testing_Status as [Testing],PSM.UAT_Status as [UAt],PSM.Close_Status as [Complete]
			from Project_Status_Master PSM,Project_MAster PM
			where PSM.Close_Status_On is Null and
				(PM.Project_Id = PSM.Project_Id) and 
				PM.Project_Manager = @Emp_ID
				
			
			UNION	
		
			Select Project_Name , Project_ID , null as [RA],null as [AD],null as [Testing],null as [UAT],null as [Complete]
			from project_Master where Project_Manager = @Emp_ID and Project_ID not in (Select Project_ID from Project_Status_Master) and Status not in ('C')
			)T
			Order By Project_ID
		End
		Else if(@Project_ID <> '' or @Project_ID is not null)
		Begin
			Select Project_Name,Project_ID,
					(Case when RA = 1 Then 'Complete' when RA IS NULL Then 'Pending' End) as [RA],
					(Case when AD = 1 Then 'Complete' when AD IS NULL Then 'Pending' End) as [AD],
					(Case when Testing = 1 Then 'Complete' when Testing IS NULL Then 'Pending' End) as [Testing],
					(Case when UAT = 1 Then 'Complete' when UAT  IS NULL Then 'Pending' End) as [UAT],
					(Case when Complete = 1 Then 'Complete' when Complete  IS NULL Then 'Pending' End) as [Complete] 
			From
			(
			Select distinct PM.Project_Name AS [Project_Name],PSM.Project_Id as [Project_Id],PSM.RA_Status as [RA],PSM.AD_Status as [AD],PSM.Testing_Status as [Testing],PSM.UAT_Status as [UAt],PSM.Close_Status as [Complete]
			from Project_Status_Master PSM,Project_MAster PM
			where PSM.Close_Status_On is Null and
				(PM.Project_Id = PSM.Project_Id) and 
				PM.Project_Manager = @Emp_ID and
				PSM.Project_ID = @Project_ID
				
			
			UNION	
		
			Select Project_Name , Project_ID , null as [RA],null as [AD],null as [Testing],null as [UAT],null as [Complete]
			from project_Master where Project_Manager = @Emp_ID and Project_ID not in (Select Project_ID from Project_Status_Master)
			 and Status not in ('C') and Project_Id = @Project_ID
			)T
			Order By Project_ID
		End
 	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_ManageSoftwareUser
-- --------------------------------------------------




-- =============================================
-- Author:		<Rihab Rebello>
-- Create date: <25/8/2010>
-- Description:	<Manage SoftwareUser>
-- =============================================
CREATE PROC [dbo].[usp_ManageSoftwareUser]

@EID as varchar(10),
@EName as varchar(50),
@HOD as varchar(10),
@HODNAme as varchar(100),
@Role_ID as varchar(10),
@PM as varchar(10),
@PL as varchar(10),
@AddedBy as varchar(20),
@Param1 as varchar(20),
@Param2 as varchar(20),
@Option as int

AS
BEGIN	
	If(@Option ='1')
	Begin		
	If Not Exists(Select Emp_ID from Resource_Master where Emp_Id = @EID)
		Begin
			set @HOD = (Select HOD from Client_Master where Emp_ID = @EID)
			insert into Resource_Master values(@EID,@EName,@HOD,@Role_ID,@PM,@PL,'','1')

			Update Client_Master
			set Role_ID = @Role_ID,Category_ID = 'ST',[Status] = 'A' 
			where Emp_ID = @EID
			
			Select 'Added'
		End
	Else If Exists(Select Emp_ID from Resource_Master where Emp_Id = @EID)
		Begin
			Select 'Exists'
		End
	End

	If(@Option = '2') -- to fill roles
	Begin
		If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) = 'AA')
		Begin
			Select Role_ID ,Role_Name from RoleMaster where Role_ID in ('SYA','DBAPM','PM','PL','DBAPL','DVL')
		End
	
		Else If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) = 'SYA')
		Begin
			Select Role_ID ,Role_Name from RoleMaster where Role_ID in ('PM','DBAPM','PL','DBAPL','DVL')
		End

		Else If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) = 'PM')
		Begin
			Select Role_ID ,Role_Name from RoleMaster where Role_ID in ('PL','DVL')
		End		

		Else If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) = 'DBAPM')
		Begin
			Select Role_ID ,Role_Name from RoleMaster where Role_ID in ('DBAPL','DVL')
		End	
		
		Else If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) in ('PL','DBAPL'))
		Begin
			Select Role_ID ,Role_Name from RoleMaster where Role_ID in ('DVL')
		End
	End 

	If(@Option = '3')  -- to fill PM
	Begin
		If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) = 'AA')
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('PM','DBAPM')
		End
		If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) in ('SYA','PM','DBAPM'))
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('PM','DBAPM')
		End
		If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) in ('PL','DBAPL'))
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('PM','DBAPM') and Emp_ID = (Select Project_Manager from Resource_MAster where Emp_ID = @AddedBy )
		End 
		
	End

	If(@Option = '4')  -- to fill PL
	Begin
		If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) = 'AA')
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('PL','DBAPL')
		End
		Else If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) = 'SYA')
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('PL','DBAPL')
		End		
		Else If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) in ('PM','DBAPM'))
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('PL','DBAPL')
		End		
		Else If((Select Role_ID from Resource_Master where Emp_ID = @AddedBy) in ('PL','DBAPL'))
		Begin
			Select Emp_Name,Emp_ID from Resource_Master
			where Role_ID in ('PL','DBAPL') And Emp_ID =@AddedBy
		End			
	End

	
If(@Option = '5') -- to fill details
	Begin
		if Exists(Select Emp_ID from Client_Master where Emp_ID = @EID)
		Begin
			If Exists(Select Emp_ID from Resource_Master where Emp_ID = @EID)
			Begin
				Select CM.Emp_ID ,CM.Emp_Name ,CM.Role_ID ,RM.Project_Manager,RM.Project_Leader,'Exists' as [Exist]   from Client_Master CM,Resource_Master RM
				where CM.Emp_ID = @EID and CM.Emp_ID = RM.Emp_ID					
			End	
			Else 	
			Begin
				Select Emp_ID,Emp_Name ,Role_ID ,'' as [Project_Manager] ,'' as [Project_Leader],'' as [Exist] from Client_Master where Emp_ID = @EID
			End
		End
		Else 
		Begin
			Select 'not Exists'
		End		
	End
	
If(@Option = '6')
	Begin				
		Update Resource_Master
		Set Role_ID = @Role_ID,Project_MAnager = @PM,Project_Leader = @PL ,Project_Leader2 = ''
		where Emp_ID = @EID
		
		Update Client_Master
		set Role_ID = @Role_ID
		where Emp_ID = @EID
		
		Select 'updated'
	End
If(@Option = '7')
	Begin
		If((@PM <> '') and (@PL <> ''))
		Begin
		select distinct RM.EMP_ID,RM.EMP_NAME,ROM.Role_Name As [Role_Name],
			Project_Leader=(Case When (RM.Project_Leader <> '' and RM.Project_Leader is not null) Then RM2.Emp_Name When (RM.Project_Leader='' or RM.Project_Leader is null) Then '' End), 
			Project_Manager=(Case When (RM.Project_Manager<>'' and RM.Project_Manager is not null) Then RM1.Emp_Name When (RM.Project_Manager='' or RM.Project_Manager is null)Then '' End) 
		from Resource_Master RM1,Resource_Master RM,Resource_Master RM2,RoleMaster ROM
		where RM.Role_ID = ROM.Role_ID and RM.Emp_ID = @EID
			and RM1.Emp_ID = @PM and RM2.Emp_ID = @PL	
			and RM1.Role_ID in ('PM','DBAPM') and RM2.Role_ID in ('PL','DBAPL')	
			--and RM.Project_Manager = @PM and RM.Project_Leader = @PL

		End
		
		Else If(@PM <> '' and @PL = '')
		Begin
		select distinct RM.EMP_ID,RM.EMP_NAME,ROM.Role_Name As [Role_Name],
			Project_Leader=(Case When (RM.Project_Leader <> '' and RM.Project_Leader is not null) Then RM2.Emp_Name When (RM.Project_Leader='' or RM.Project_Leader is null) Then '' End), 
			Project_Manager=(Case When (RM.Project_Manager<>'' and RM.Project_Manager is not null) Then RM1.Emp_Name When (RM.Project_Manager='' or RM.Project_Manager is null)Then '' End) 
		from Resource_Master RM1,Resource_Master RM,Resource_Master RM2,RoleMaster ROM
		where RM.Role_ID = ROM.Role_ID and RM.Emp_ID = @EID
			and RM1.Emp_ID = @PM 
			and RM1.Role_ID in ('PM','DBAPM')
			and RM.Project_Manager = @PM and RM.Project_Leader = @PL

		End
		Else If(@PM = '' and @PL <> '')
		Begin
		select distinct RM.EMP_ID,RM.EMP_NAME,ROM.Role_Name As [Role_Name],
			Project_Leader=(Case When (RM.Project_Leader <> '' and RM.Project_Leader is not null) Then RM2.Emp_Name When (RM.Project_Leader='' or RM.Project_Leader is null) Then '' End), 
			Project_Manager=(Case When (RM.Project_Manager<>'' and RM.Project_Manager is not null) Then RM1.Emp_Name When (RM.Project_Manager='' or RM.Project_Manager is null)Then '' End) 
		from Resource_Master RM1,Resource_Master RM,Resource_Master RM2,RoleMaster ROM
		where RM.Role_ID = ROM.Role_ID and RM.Emp_ID = @EID
			 and RM2.Emp_ID = @PL	
			 and RM2.Role_ID in ('PL','DBAPL')
			and RM.Project_Manager = @PM and RM.Project_Leader = @PL

		End
		
		Else If(@PM = '' and @PL = '')
		Begin
		select distinct RM.EMP_ID,RM.EMP_NAME,ROM.Role_Name As [Role_Name],
			Project_Leader=(Case When (RM.Project_Leader <> '' and RM.Project_Leader is not null) Then RM2.Emp_Name When (RM.Project_Leader='' or RM.Project_Leader is null) Then '' End), 
			Project_Manager=(Case When (RM.Project_Manager<>'' and RM.Project_Manager is not null) Then RM1.Emp_Name When (RM.Project_Manager='' or RM.Project_Manager is null)Then '' End) 
		from Resource_Master RM1,Resource_Master RM,Resource_Master RM2,RoleMaster ROM
		where RM.Role_ID = ROM.Role_ID and RM.Emp_ID =@EID			
			and RM.Project_Manager = @PM and RM.Project_Leader = @PL

		End
	End	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_nashTEST
-- --------------------------------------------------


         
--usp_nashTEST '05/12/2010','05/18/2010'

Create proc [dbo].[usp_nashTEST]              
 @FDtxt varchar(50),              
 @TDtxt varchar(50)              
              
As               

declare @FD datetime,@TD datetime,@RS Nvarchar(255),@QRY varchar(150),@SUBQ varchar (200),@UQRY varchar(100)

Set @FD=convert (datetime,@FDtxt)
Set @TD=convert (datetime,@TDtxt)
--Set @cnt=0

create table #TEMP 
(
	DT datetime
)

if(convert(varchar,@FD,103)=convert(varchar,@TD,103))
insert into #TEMP values (@FD)
Else
begin
	while (convert(varchar,@FD,103)!=convert(varchar,@TD,103))
	Begin
		insert into #TEMP values (@FD)
		set @FD=DATEADD(day,1,@FD)
	End
End

DECLARE @RSList CURSOR
SET @RSList = CURSOR FOR
Select Emp_ID From Client_Master    
Where Role_ID In ('DVL')  Order By Emp_ID
OPEN @RSList
FETCH NEXT
FROM @RSList INTO @RS
WHILE @@FETCH_STATUS = 0
BEGIN	
	Set @QRY=''
	Set @QRY='ALTER TABLE #TEMP	ADD '+ @RS+' bit'
	exec(@QRY)
	Set @UQRY=''
	Set @UQRY='update #TEMP set '+@RS+'=dbo.checkEmp('''+@RS+''',#TEMP.DT)'
	exec(@UQRY)
	FETCH NEXT
	FROM @RSList INTO @RS
END
CLOSE @RSList
DEALLOCATE @RSList

Select * from #TEMP

drop table #TEMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_PcInfo
-- --------------------------------------------------
CREATE Proc Usp_PcInfo
as

Select b.Project_Name,PO=c.Emp_Name,PC1=Space(50),PC2=Space(50),a.Project_Id into #S1 from coordinator_master a With(Nolock) inner join 
project_master b With(Nolock) on a.Project_Id=b.Project_Id inner join client_master c With(Nolock)
on a.Employee_Id=c.Emp_Id where a.Role_id='PO'


Update #S1 set PC1=b.Employee_Id from coordinator_master b where #S1.project_id=b.project_id and Role_Id='PC'
Update #S1 set PC2=b.Employee_Id from coordinator_master b where #S1.project_id=b.project_id and Role_Id='PC' and #S1.PC1<>b.Employee_Id




SELECT Project_Name,PO,PC1=b.Emp_Name,PC2=C.EMP_name from #S1 a left outer join client_master b With(Nolock)
on a.PC1=b.Emp_Id left outer join client_master C With(Nolock) on a.PC2=C.Emp_Id order by Project_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Phase_Operation
-- --------------------------------------------------





CREATE Proc [dbo].[USP_Phase_Operation]

@Phase_ID char(10),
@Request_ID Char(20),  
@Project_Manager Char(20), 
@option Char(20)  

As

Begin

	If(@option = '1')  
	Begin  
		if(@Project_Manager<>'' and @Request_ID<>'')
		Begin
			Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
			From Project_Master 
			--Where (Project_Manager=@Project_manager or Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager)) and Project_ID=@Request_ID
			Where Project_ID=@Request_ID

			Select Phase_Name, Phase_ID
			From Phase_Master

	--		Select Phase_Master.Phase_Name, Phase_Master.Phase_ID 
	--		From Phase_Master, Project_Details, Project_Master
	--		Where Phase_Master.Phase_ID=Project_Details.Phase_ID 
	--			and Project_Details.Project_ID=Project_Master.Project_ID
	--			and (Project_Master.Project_Manager=@Project_manager or Project_Master.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager))			
	--			and Project_Details.Project_ID = @Request_ID

			If((Select Role_ID From Resource_Master Where Emp_ID=@Project_manager)='PM')
			Begin
				Select Module_Master.Module_ID, Module_Master.Module_Name 
				From Module_Master, Project_Details, Project_Master
				Where Project_Details.Module_ID = Module_Master.Module_ID
					and Project_Details.Project_ID=Project_Master.Project_ID
					and (Project_Master.Project_Manager=@Project_manager or Project_Master.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager))			
					and Project_Details.Project_ID = @Request_ID and Project_Details.Phase_ID=@Phase_ID
			End
			Else If((Select Role_ID From Resource_Master Where Emp_ID=@Project_manager)='AA' or (Select Role_ID From Resource_Master Where Emp_ID=@Project_manager)='SYA')
			Begin
				Select Module_Master.Module_ID, Module_Master.Module_Name 
				From Module_Master, Project_Details, Project_Master
				Where Project_Details.Module_ID = Module_Master.Module_ID
					and Project_Details.Project_ID=Project_Master.Project_ID
					and (Project_Master.Project_Manager in (Select EMP_ID From Client_Master Where Role_ID='PM'))			
					and Project_Details.Project_ID = @Request_ID and Project_Details.Phase_ID=@Phase_ID
			End
		End
		Else
		Begin
			Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
			from Project_Master 
			Where (Project_Master.Project_Manager=@Project_manager or Project_Master.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager))
		End
	End 
	Else If(@option = '2')  
	Begin  
		If(@Request_ID<>'')
		Begin
			Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
			From Project_Master 
			Where Project_ID = @Request_ID

			Select Phase_Name, Phase_ID
			From Phase_Master

	--		Select Phase_Master.Phase_Name, Phase_Master.Phase_ID 
	--		From Phase_Master, Project_Details, Project_Master
	--		Where Phase_Master.Phase_ID=Project_Details.Phase_ID 
	--			and Project_Details.Project_ID=Project_Master.Project_ID
	--			and Project_Details.Project_ID = @Request_ID

			Select Module_Master.Module_ID, Module_Master.Module_Name 
			From Module_Master, Project_Details, Project_Master
			Where Project_Details.Module_ID = Module_Master.Module_ID
				and Project_Details.Project_ID=Project_Master.Project_ID
				and Project_Details.Project_ID = @Request_ID and Project_Details.Phase_ID=@Phase_ID
		End
		Else
		Begin
			Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate
			From Project_Master
		End
	End  

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_PRMS_Reports
-- --------------------------------------------------



CREATE Proc [dbo].[USP_PRMS_Reports]

@SDate As Datetime,
@Edate As Datetime,
@Emp_ID As Char(10),
@Option As Int

As
Begin

	If(@Option=1)
	Begin
		Select Distinct Request_ID, Change_ID, Change_Type, Project_Name, Module_Name,Description,
			Request_By, Changed_Date, Approve_BY, Priority_ID,Expected_EDate, [DelegateBy], [DelegateTo], 
			DelegateDate, Task_ID, [Assign_By], AS_SDT, AS_EDT, [Assign_To], AC_SDT, AC_EDT, 
			Change_Status, Task_Status
		From
		(
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID And CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
			
			Union
		
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 	
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where len(RequestID)>4)
				
			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, '' AS [Task_ID], 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As [AC_SDT], '' As [AC_EDT], 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				request_Status_master RSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID  
				And CRM.Changed_By=CM1.Emp_ID 	
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select distinct Project_ID From Project_Master) And Change_ID is not NULL And Change_ID<>'')
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where len(RequestID)>4)

			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], 
				RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, '' AS Task_ID, 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As AC_SDT, '' As AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), 
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID 
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select distinct Project_ID From Project_Master) And Change_ID is not NULL And Change_ID<>'')
		) T
		Where Approve_BY IS Not NULL
	End
	Else If(@Option=2)
	Begin
		Select Distinct Request_ID, Change_ID, Change_Type, Project_Name, Module_Name,Description,
			Request_By, Changed_Date, Approve_BY, Priority_ID,Expected_EDate, [DelegateBy], [DelegateTo], 
			DelegateDate, Task_ID, [Assign_By], AS_SDT, AS_EDT, [Assign_To], AC_SDT, AC_EDT, 
			Change_Status, Task_Status
		From
		(
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID And CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)

			Union
		
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 	
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where len(RequestID)>4)
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)

			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, '' AS [Task_ID], 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As [AC_SDT], '' As [AC_EDT], 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				request_Status_master RSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID  
				And CRM.Changed_By=CM1.Emp_ID 	
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select distinct Project_ID From Project_Master) And Change_ID is not NULL And Change_ID<>'')
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where len(RequestID)>4)
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)

			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], 
				RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, '' AS Task_ID, 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As AC_SDT, '' As AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), 
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID 
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select distinct Project_ID From Project_Master) And Change_ID is not NULL And Change_ID<>'')
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)
		) T
		Where Approve_BY IS Not NULL
	End
	Else If(@Option=3)
	Begin
				Select Distinct Request_ID, Change_ID, Change_Type, Project_Name, Module_Name,Description,
			Request_By, Changed_Date, Approve_BY, Priority_ID,Expected_EDate, [DelegateBy], [DelegateTo], 
			DelegateDate, Task_ID, [Assign_By], AS_SDT, AS_EDT, [Assign_To], AC_SDT, AC_EDT, 
			Change_Status, Task_Status
		From
		(
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID And CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
				And PM.Project_manager=@Emp_ID
			
			Union
		
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 	
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
				And PM.Project_manager=@Emp_ID
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where DelegateBy=@Emp_ID And len(RequestID)>4)
				
			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, '' AS [Task_ID], 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As [AC_SDT], '' As [AC_EDT], 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				request_Status_master RSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID  
				And CRM.Changed_By=CM1.Emp_ID 	
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And PM.Project_manager=@Emp_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID) And Change_ID is not NULL And Change_ID<>'')
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where DelegateBy=@Emp_ID And len(RequestID)>4)

			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], 
				RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, '' AS Task_ID, 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As AC_SDT, '' As AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), 
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID 
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And PM.Project_manager=@Emp_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID) And Change_ID is not NULL And Change_ID<>'')
		) T
		Where Approve_BY IS Not NULL

	End
	Else If(@Option=4)
	Begin
				Select Distinct Request_ID, Change_ID, Change_Type, Project_Name, Module_Name,Description,
			Request_By, Changed_Date, Approve_BY, Priority_ID,Expected_EDate, [DelegateBy], [DelegateTo], 
			DelegateDate, Task_ID, [Assign_By], AS_SDT, AS_EDT, [Assign_To], AC_SDT, AC_EDT, 
			Change_Status, Task_Status
		From
		(
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID And CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
				And PM.Project_manager=@Emp_ID
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)

			Union
		
			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, TM.Task_ID, 
				RSM3.Emp_Name [Assign_By], TM.AS_SDT, TM.AS_EDT, 
				RSM4.Emp_Name As [Assign_To], TM.AC_SDT, TM.AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				TSTM.Task_Status_Name As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 Task_Master TM with (nolock),
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM3,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM4,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=TM.Change_ID
				And CRM.Changed_By=CM1.Emp_ID 	
				And TM.Assigned_By=RSM3.Emp_ID And TM.Assigned_To=RSM4.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And TM.Status_ID=TSTM.Task_Status_ID
				And PM.Project_manager=@Emp_ID
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where DelegateBy=@Emp_ID And len(RequestID)>4)
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)

			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' or CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				'' As  [DelegateBy], '' As [DelegateTo], 
				'' As DelegateDate, '' AS [Task_ID], 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As [AC_SDT], '' As [AC_EDT], 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				 (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				request_Status_master RSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID  
				And CRM.Changed_By=CM1.Emp_ID 	
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And PM.Project_manager=@Emp_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID) And Change_ID is not NULL And Change_ID<>'')
				And CRM.Change_ID not in (Select RequestID From Delegation_Master Where DelegateBy=@Emp_ID And len(RequestID)>4)
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)

			Union

			Select	Distinct CRM.Request_ID, CRM.Change_ID, CRM.Change_Type, PM.Project_Name, MM.Module_Name,CRM.Description,
				CM1.Emp_Name As Request_By,
				CRM.Changed_Date, 
				(Case When (CRM.HOD_Approve='' And CRM.HOD_Approve is NULL) Then '' When (CRM.HOD_Approve<>'' And CRM.HOD_Approve is NOT NULL And CRM.HOD_Approve=CM2.Emp_ID) Then CM2.Emp_Name End) AS Approve_BY,
				CRM.Priority_ID,CRM.Expected_EDate,
				RSM1.Emp_Name As [DelegateBy], 
				RSM2.Emp_Name As [DelegateTo], DM.DelegateDate, '' AS Task_ID, 
				'' As [Assign_By], '' As [AS_SDT], '' As [AS_EDT], 
				'' As [Assign_To], '' As AC_SDT, '' As AC_EDT, 
				RSTM.Request_Status_Name As Change_Status, 
				'' As Task_Status
			From Change_Request_Master CRM with (nolock), Project_Master PM with (nolock), Module_Master MM with (nolock),
				Delegation_Master DM with (nolock), 
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM1,
				(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO')) CM2,
				(Select Emp_ID, Emp_Name From Resource_Master) RSM1	,	
				(Select Emp_ID, Emp_Name From Resource_Master) RSM2,
				request_Status_master RSTM with (nolock),
				Task_Status_master TSTM with (nolock)
			Where CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And 
				CRM.Change_ID=DM.RequestID 
				And CRM.Changed_By=CM1.Emp_ID 
				And DM.DelegateBy=RSM1.Emp_ID And DM.DelegateTo=RSM2.Emp_ID 
				And CRM.Request_Status_ID=RSTM.Request_Status_ID
				And PM.Project_manager=@Emp_ID
				And CRM.Change_ID not in (Select Change_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Manager=@Emp_ID) And Change_ID is not NULL And Change_ID<>'')
				And Convert(Varchar(11),CRM.Changed_Date,110) Between Convert(Varchar(11),@SDate,110) And  Convert(Varchar(11),@EDate,110)
		) T
		Where Approve_BY IS Not NULL
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Project_Assign
-- --------------------------------------------------




CREATE Procedure [dbo].[usp_Project_Assign]
(
@Request_ID Char(20),    
@Project_Manager Char(20),    
@Priority Varchar(20),    
@AssignSDate datetime,
@AssignEDate datetime,
@option Char(20)    
)
as 
Begin

	Update Project_Master    
	Set Project_Manager = @Project_Manager, Priority = @Priority, AS_SDate = @AssignSDate, 
		AS_EDate = @AssignEDate, [Status] = 'PMA'      
	Where Request_ID = @Request_ID    
    
    Update Request_Master    
	Set Request_Status_ID = 'PMA'    
	Where Request_ID = @Request_ID     
    
	Insert Into Request_Details    
	Select '',Request_ID, Project_Name, Requested_By, Request_Date, Expected_EDate, Priority_ID, Brief_Requirement,    
		BR_Attachment, Business_Needs, BN_Attachment, Current_Process, CP_Attachment, HOD_Approve,     
		HOD_Approve_Date, HOD_Remark,Admin_Approve, Admin_Approve_Date, Admin_Remark, Audience, Request_Status_ID    
	From Request_Master    
	Where Request_ID = @Request_ID    
    
	Select @Request_ID  
	  
	Select Emp_Name, EmailAdd, Project_ID, Admin_Remark  
	From Client_Master 
		inner join Project_Master on Project_Master.Project_Manager = Client_Master.Emp_ID  
		inner join Request_Master on Request_Master.Request_ID = Project_Master.Request_ID 
	Where Project_Master.Request_ID = @Request_ID
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Project_Data
-- --------------------------------------------------


CREATE Proc [dbo].[USP_Project_Data]

@Prj_ID As Char(10),
@Phase_ID As Char(10),
@Module_ID As Char(10),
@Emp_ID As Char(10),
@Role_ID As Char(10),
@Option As Char(5)

As 

Begin
	
	If(@Option = '1')
	Begin
		Select Distinct PHM.Phase_ID , PHM.Phase_Name 
		From Phase_Master PHM, Project_Details PD
		Where PHM.Phase_ID=PD.Phase_ID and PD.Project_ID = @Prj_ID
	End
	Else If(@Option = '2')
	Begin
		Select Distinct MM.Module_ID , MM.Module_Name 
		From Module_Master MM,Phase_Master PHM, Project_Details PD
		Where PHM.Phase_ID=PD.Phase_ID and MM.Module_ID=PD.Module_ID
			and PD.Project_ID = @Prj_ID and PD.Phase_ID=@Phase_ID
	End	
	Else If(@Option = '3') -- For Tester Task
	Begin
		Select Distinct Phase_ID , Phase_Name 
		From Phase_Master
		Where Phase_ID in ('104')

	End
	Else If(@Option = '4') -- Modules For Tester
	Begin
		Declare @PID as varchar(10)
		set @PID = (Select Project_ID from tbl_Testing_Requests where Token_Number = @Prj_ID)

		If((Select Module from tbl_Testing_Requests where Token_Number = @Prj_ID) = 'ALL')
		Begin
			Select distinct MM.Module_Name , PD.Module_ID from Project_Details PD,Module_Master MM
			where PD.Project_ID = @PID
			and	PD.Module_ID = MM.Module_Id 
			And PD.Phase_ID in (Select Phase_ID From Phase_Master Where UPPER(Phase_Name) like UPPER('Testing'))
 		End 
		Else 
		Begin
			Select MM.Module_Name,TR.Module 
			from tbl_Testing_Requests TR , Module_Master MM
			where MM.Module_ID = TR.Module
				and Project_ID = @PID
				and Token_Number = @PRj_ID
		End
	End
	Else If(@Option = '5')
	Begin
		Select MM.Module_Name, MM.Module_ID               
		From Module_Master MM
		inner join Project_Details on Project_Details.Module_ID = MM.Module_ID      
		join Phase_Master PHM on Project_Details.Phase_ID=PHM.Phase_ID       
		Where Project_Details.Project_ID = @Prj_Id and Upper(PHM.Phase_Name) in ('TESTING')             
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Project_MIS_Report
-- --------------------------------------------------
CREATE PROC USP_Project_MIS_Report

@PM As char(20),
@PL As Char(20),
@RID As Char(20),
@AdmSDate AS Datetime,
@AdmEDate As Datetime,
@DVLDate As Datetime,
@Res AS Varchar(100),
@Emp_ID As Char(20),
@Role As Char(20),
@Option AS Int


--	Created BY	: Mahendra Bonde
--	Created On	: 24 Nov 2010
--	Description	: Project Status Report.
As
Begin
	If(@Option=1)
	Begin
		Declare @Query As Varchar(MAX)
		Declare @Query1 As Varchar(MAX)
		Declare @Query2 As Varchar(MAX)

		Set @Query = '
					Select T.Request_ID As RID,T.Project_Name AS Project, T.Project_Manager AS PM, T.Project_Leader AS PL,
						Convert(Varchar(12),T.AS_SDate,113) As [AS_SDate],Convert(Varchar(12),T.AS_EDate,113) As [AS_EDate], 
						Convert(Varchar(12),T.AD_Status_On,113) As [AD_Status_On],[Assign Working Days] As AWD, 
						[Total Elasped Days] As TED, [Project Status] AS Status,
						(Select Count(distinct TM.Assigned_To) From Task_Master TM
						 Where  TM.Request_ID=T.Request_ID
							And	Convert(Datetime,Convert(Varchar(12),TM.AS_SDT,113))>=T.AS_SDate And 
							Convert(Datetime,Convert(Varchar(12),TM.AS_EDT,113))<=T.AD_Status_On 
							) As Resource
					From
					('
		Set @Query1 = 'Select PM.Request_Id, PM.Project_Name, 
							(Case When (PM.Project_Manager='''' OR PM.Project_Manager IS NULL) Then ''''
								When (PM.Project_Manager<>'''' And PM.Project_Manager IS NOT NULL)
								Then (Select RM.Emp_Name From Resource_Master RM Where RM.Emp_ID=PM.Project_Manager) End) AS Project_Manager, 
							(Case When (PM.Project_Leader='''' OR PM.Project_Leader IS NULL) Then ''''
								When (PM.Project_Leader<>'''' And PM.Project_Leader IS NOT NULL)
								Then (Select RM.Emp_Name From Resource_Master RM Where RM.Emp_ID=PM.Project_Leader) End) AS Project_Leader, 
							Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,113)) As [AS_SDate],
							Convert(Datetime,Convert(Varchar(12),PM.AS_EDate,113)) As [AS_EDate], 
							Convert(Datetime,Convert(Varchar(12),PSM.AD_Status_On,113)) As [AD_Status_On],
							DATEDIFF(DAY,PM.AS_SDate,PM.AS_EDate) As [Assign Working Days],
							DATEDIFF(DAY,PM.AS_SDate, (Select top 1 Convert(Datetime,Convert(Varchar(12),PSM.AD_Status_ON,113)) From Project_Status_Master PSM Where PSM.Request_ID=PM.Request_ID))
								  AS [Total Elasped Days],
							RSM.Request_Status_Name AS [Project Status]
						From Project_Master PM, Project_Status_Master PSM, Request_Status_Master RSM
						Where  PM.Request_ID=PSM.Request_ID And PM.Status not in (''RBP'',''RBA'','''')
						And PM.Status=RSM.Request_Status_ID
					'
				
		Set @Query2 =' 
					Union

					Select PM.Request_Id, PM.Project_Name, 
						(Case When (PM.Project_Manager='''' OR PM.Project_Manager IS NULL) Then ''''
								When (PM.Project_Manager<>'''' And PM.Project_Manager IS NOT NULL)
								Then (Select RM.Emp_Name From Resource_Master RM Where RM.Emp_ID=PM.Project_Manager) End) AS Project_Manager, 
							(Case When (PM.Project_Leader='''' OR PM.Project_Leader IS NULL) Then ''''
								When (PM.Project_Leader<>'''' And PM.Project_Leader IS NOT NULL)
								Then (Select RM.Emp_Name From Resource_Master RM Where RM.Emp_ID=PM.Project_Leader) End) AS Project_Leader,
						Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,113)) As [AS_SDate],
						Convert(Datetime,Convert(Varchar(12),PM.AS_EDate,113)) As [AS_EDate], 
						Convert(Datetime,Convert(Varchar(12),getdate(),113)) As [AD_Status_On],
						DATEDIFF(DAY,PM.AS_SDate,PM.AS_EDate) As [Assign Working Days],
						DATEDIFF(DAY,PM.AS_SDate, getdate()) AS [Total Elasped Days],
						RSM.Request_Status_Name AS [Project Status]
					From Project_Master PM, Request_Status_Master RSM
					Where  PM.Request_ID not in (Select Distinct Request_ID From Project_Status_Master) 
							And PM.Status not in (''RBP'',''RBA'','''') And PM.Status=RSM.Request_Status_ID '
					
		If(@PM<>'')
		Begin
			Set @Query1 = @Query1 + ' And PM.Project_Manager=''' + rtrim(@PM) + ''''
			Set @Query2 = @Query2 + ' And PM.Project_Manager=''' + rtrim(@PM) + ''''
		End

		If(@PL<>'')
		Begin
			Set @Query1 = @Query1 + ' And PM.Project_Leader=''' + rtrim(@PL) + ''''
			Set @Query2 = @Query2 + ' And PM.Project_Leader=''' + rtrim(@PL) + ''''
		End	

		If(@RID<>'')
		Begin
			Set @Query1 = @Query1 + ' And PM.Request_ID=''' + rtrim(@RID) + ''''
			Set @Query2 = @Query2 + ' And PM.Request_ID=''' + rtrim(@RID) + ''''
		End		

		Set @Query = @Query + @Query1 + @Query2 + '
					) T
					Group by  T.Request_ID,T.Project_Name, T.Project_Manager, T.Project_Leader,
							T.AS_SDate,T.AS_EDate,T.AD_Status_On,[Assign Working Days], [Total Elasped Days], [Project Status]
					'

		Print (@Query)
		EXEC (@Query)
	End
	Else If(@Option=2)
	Begin
		Select ROW_NUMBER() OVER (ORDER BY Emp_Name) as [No], Emp_Name As Resource, TUD
		From
		(
			Select Distinct RM.Emp_Name, ((SUM(TM.AC_Time)/60)/8)  As TUD
			From REsource_Master RM, Task_Master TM
			Where RM.Emp_ID=TM.Assigned_To 
				And	Convert(Datetime,Convert(Varchar(12),TM.AS_EDT,113)) Between 
					Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@AdmSDate),113)) And
					Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@DVLDate),113)) 
			And TM.Request_ID=@RID
			Group By RM.Emp_Name
		) T
	End
	Else If(@Option=3)
	Begin		
		Select Distinct ROW_NUMBER() OVER (ORDER BY Convert(varchar(12),TM.AS_SDT,113)) As [SrNo], TM.Task_ID,
	 			PM.Project_Name as [Project Name], MM.Module_Name [Module Name], RM.Emp_Name as [Resource],
				RM1.Emp_NAme as [Assigned_By], RPM.Priority_Name as [Priority],
				Convert(varchar(12),TM.AS_SDT,113) as [Assigned Start Date],TM.AS_SDT,
				Convert(varchar(12),TM.AS_EDT,113) as [Assigned End Date],
				(cast((AS_Time/60) as varchar(3))+ ':' + cast((AS_Time%60) as varchar(3)))  as [Assigned Time],
				Convert(varchar(12),TM.AC_SDT,113) as [AC_ST],Convert(varchar(12),TM.AC_EDT,113) as [AC_ET],
				Cast((AC_Time/60) as varchar(3))+ ':' + cast((AC_Time%60) as varchar(3)) as [Actual Time],
				Convert(varchar(12),TM.Last_Update,113) as [Last Update],
				Cast((AC_Time/60) as varchar(3)) as [Elapsed],
				[Productive]=(Case when ((Convert(varchar(12),TM.AS_EDT,113) >= Convert(varchar(12),TM.AC_EDT,113)) and [AS_Time] >= [AC_Time] ) then 'Y'
				Else 'N' End  ),
				TM.Remark as [Remark],
				TSM.Task_Status_Name as Status
		From  Task_Master TM
			inner join Project_Master PM on TM.Request_ID = PM.Request_ID
			inner join Module_Master MM on TM.Module_ID = MM.Module_ID
			inner join Request_Priority_Master RPM on TM.Priority_ID = RPM.Priority_ID
			inner join Task_Status_Master TSM on TM.Status_ID = TSM.Task_Status_ID
			inner join Resource_Master RM on (RM.Emp_ID = TM.Assigned_To and RM.Active_Status =1)
			inner join Resource_MAster RM1 on (RM1.Emp_Id = TM.Assigned_By and RM.Active_Status =1)
		Where Convert(Datetime,Convert(Varchar(12),TM.AS_EDT,113)) Between 
					Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@AdmSDate),113)) And
					Convert(Datetime,Convert(Varchar(12),Convert(Datetime,@DVLDate),113)) 
			And TM.Request_ID=@RID
			And TM.Assigned_To=(Select Emp_ID From Resource_Master Where UPPER(Emp_Name) like UPPER(@Res))

	End
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Project_Operation
-- --------------------------------------------------








  
CREATE Proc [dbo].[USP_Project_Operation]  

@Request_ID Char(20),  
@Project_Manager Char(20),
@Option Char(20)
  
As  

Begin  
	If(@Option='1') --Add New Project   
	Begin  
		Declare @Project_name Varchar(150)  
		Declare @Project_ID Char(20)  
		Declare @PC As Char(10)
		Declare @PO As Char(10)
  
		Set @Project_Name = (Select Project_Name From Request_Master Where Request_ID = @Request_ID)  
  
		Select @Project_ID = DBO.GenerateID('2', '')
  
		Insert Into Project_Master Values (@Project_ID, @Project_Name, @Request_ID, @Project_Manager,'', '', '', '','','','')  
		
		If((Select Role_ID From Client_Master CM, Request_Master RM Where RM.Requested_BY=CM.Emp_ID and RM.Request_ID=@Request_ID)='PC')
		Begin
			Set @PC = (Select Requested_By From Request_Master Where Request_ID=@Request_ID)
			Set @PO = (Select HOD_Approve From Request_Master Where Request_ID=@Request_ID)
			Insert Into Coordinator_Master
			Values (@PC, @Request_ID, @Project_ID, 'PC','1')
			Insert Into Coordinator_Master
			Values (@PO, @Request_ID, @Project_ID, 'PO','1')
		End
		Else If((Select Role_ID From Client_Master CM, Request_Master RM Where RM.Requested_BY=CM.Emp_ID and RM.Request_ID=@Request_ID)='PO')
		Begin
			Set @PO = (Select Requested_By From Request_Master Where Request_ID=@Request_ID)
			Insert Into Coordinator_Master
			Values (@PO, @Request_ID, @Project_ID, 'PO','1')
		End

		--insert into Project_Master_Details
		Declare @PID as char(10)

		set @PID = DBO.GenerateID('10','')
		
		Insert Into Project_Master_Details 
		Select @PID,* from Project_Master where Project_ID = @Project_ID
		
	End  
	Else If(@Option='2')   
	Begin  
  
		Update Project_Master  
		Set Project_Manager = @Project_Manager
		Where Request_ID = @Request_ID  
  
		Update Request_Master  
		Set Request_Status_ID = 'PMA'  
		Where Request_ID = @Request_ID   
  
		Insert Into Request_Details  
			Select '',Request_ID, Project_Name, Requested_By, Request_Date, Expected_EDate, Priority_ID, Brief_Requirement,  
			BR_Attachment, Business_Needs, BN_Attachment, Current_Process, CP_Attachment, HOD_Approve,   
			HOD_Approve_Date, HOD_Remark,Admin_Approve, Admin_Approve_Date, Admin_Remark, Audience, Request_Status_ID  
			From Request_Master  
			Where Request_ID = @Request_ID
		
		Declare @ProjID as varchar(10)
		Declare @PID1 as char(10)
		
		set @PID1 = DBO.GenerateID('10','')
		
		Set @ProjID = (Select Project_ID From Project_Master Where Request_ID = @Request_ID)  
		
		Insert Into Project_Master_Details 
		Select @PID1,* from Project_Master where Project_ID = @ProjID
		
		Select @Request_ID  
   
	End  
	Else If(@Option = '3')  
	Begin  
		Select Project_Name,Project_ID 
		From Project_Master
	End  
	Else IF(@Option='4')  
	Begin  
		Select PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(Varchar(12),RM.Request_Date,113) as Request_Date,RM.Expected_EDate, RPM.Priority_Name As Priority,  
			RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
			RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
			RM.Audience, RSM.Request_Status_Name  
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM  
		Where RM.Requested_By = CM.Emp_ID 
			and RM.Requested_By in (Select Distinct Emp_ID From Client_Master)
			and RM.Request_Status_ID = RSM.Request_Status_ID  
			and RM.Priority_ID = RPM.Priority_ID  
			and PM.Request_ID = RM.Request_ID
			and RM.Request_Status_ID in ('PMA','APM','DLG')  
		Order By PM.Project_ID
	End  
	Else IF(@Option='5')  
	Begin  
		Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
			(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
			(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
			RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
			RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
			RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
		From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
			 Client_Master DCM
		Where RM.Requested_By = CM.Emp_ID 
			and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
			and RM.Request_Status_ID = RSM.Request_Status_ID  
			and RM.Priority_ID = RPM.Priority_ID 
			and PM.Request_ID=RM.Request_ID
			and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
			and PM.Project_Leader =@Project_Manager
			and RM.Request_Status_ID in ('DLG','PFT','PFU','UC','C')  
		Order By PM.Project_ID
	End  
	Else If(@Option = '6')  
	Begin  
		If((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'PM')
		Begin
			If(@Project_Manager<>'' and @Request_ID<>'')
			Begin
				Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
				From Project_Master 
				Where (Project_Manager=@Project_manager or Project_Manager in (Select EMP_ID From Resource_Master Where HOD=@Project_Manager)) 
					and Project_ID=@Request_ID
					--and Status not in ('C')

				Select Phase_Name, Phase_ID
				From Phase_Master

				Select Module_Master.Module_ID, Module_Master.Module_Name 
				From Module_Master, Project_Details, Project_Master
				Where Project_Details.Module_ID = Module_Master.Module_ID
					and Project_Details.Project_ID=Project_Master.Project_ID
					and (Project_Master.Project_Manager=@Project_manager or Project_Master.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager))			
					and Project_Details.Project_ID = @Request_ID
			End
			Else
			Begin
				Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
				From Project_Master 
				Where (Project_Master.Project_Manager=@Project_manager or Project_Master.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager))
				--land Status not in ('C')
			End
		End 
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'PL')
		Begin
			If(@Project_Manager<>'' and @Request_ID<>'')
			Begin
				Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
				From Project_Master 
				Where (Project_Leader=@Project_Manager) and Project_ID=@Request_ID

				Select Phase_Name, Phase_ID
				From Phase_Master

				Select Module_Master.Module_ID, Module_Master.Module_Name 
				From Module_Master, Project_Details, Project_Master
				Where Project_Details.Module_ID = Module_Master.Module_ID
					and Project_Details.Project_ID=Project_Master.Project_ID
					and (Project_Master.Project_Leader=@Project_manager )			
					and Project_Details.Project_ID = @Request_ID
			End
			Else
			Begin
				Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
				From Project_Master 
				Where (Project_Master.Project_Leader=@Project_manager )
				--and Status not in ('C')
			End
		End 
	End 
	Else If(@Option = '7')  
	Begin  
		If(@Request_ID<>'')
		Begin
			Select Project_Name, Project_ID, Priority, AS_SDate, AS_EDate 
			From Project_Master 
			Where Project_ID = @Request_ID

			Select Phase_Name, Phase_ID
			From Phase_Master

			Select Module_Master.Module_ID, Module_Master.Module_Name 
			From Module_Master, Project_Details, Project_Master
			Where Project_Details.Module_ID = Module_Master.Module_ID
				and Project_Details.Project_ID=Project_Master.Project_ID
				and Project_Details.Project_ID = @Request_ID
		End
		Else
		Begin
			Select Project_Master.Project_Name, Project_ID, Priority, AS_SDate, AS_EDate
			From Project_Master, Request_Master
			Where Request_Status_ID not in ('PBH', 'PBA', 'RBH', 'RBA', 'NCFH', 'NCFA')
				and Project_Master.Request_ID=Request_Master.Request_ID
		End
	End  
	Else IF(@Option='8')
	Begin
		If(@Request_ID='AA' or @Request_ID='SYA')
		Begin
			Select Pm.Project_ID As [ProjectID],PM.Project_Name As [Project], CM.Emp_Name As [Manager], PM.Priority As [Priority],
				Convert(Varchar(11),PM.AS_SDate, 113) As [StartDate], Convert(Varchar(12),PM.AS_EDate,113) As [EndDate], 
				CAST(((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
			    (Case When PM.Status='ABA' Then 'Approved by Administrator' When PM.Status in ('ACP','DLG') Then 'Work In Progress' End) As [Status]
			From Project_Master PM, Client_Master CM
			Where PM.Project_Manager=CM.Emp_ID and PM.AS_Edate < GEtdate() and PM.Status<>'' and PM.Status not in ('C','PMA','PFU','PFT','UC')
		End
		Else If(@Request_ID='PM')
		Begin
			Select Pm.Project_ID As [ProjectID],PM.Project_Name As [Project], CM.Emp_Name As [Manager], PM.Priority As [Priority],
				Convert(Varchar(11),PM.AS_SDate, 113) As [StartDate], Convert(Varchar(12),PM.AS_EDate,113) As [EndDate], 
				CAST(((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
			From Project_Master PM, Client_Master CM
			Where PM.Project_Manager=CM.Emp_ID and PM.AS_Edate < GEtdate() and PM.Status<>'' and  PM.Status not in ('C','PMA','PFU','PFT','UC')
				and PM.Project_Manager in (Select Emp_ID From Client_Master Where HOD=@Project_Manager and Role_ID in ('PM','PL') Union Select @Project_Manager)
		End
 		Else If(@Request_ID='PL')
		Begin
			Select Pm.Project_ID As [ProjectID],PM.Project_Name As [Project], CM.Emp_Name As [Manager], PM.Priority As [Priority],
				Convert(Varchar(12),PM.AS_SDate,113) As [StartDate], Convert(Varchar(12),PM.AS_EDate,113) As [EndDate], 
				CAST(((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
			From Project_Master PM, Client_Master CM
			Where PM.Project_Manager=CM.Emp_ID and PM.AS_Edate < GEtdate() and PM.Status<>'' and  PM.Status not in ('C','PMA','PFU','PFT','UC')
				and PM.Project_Leader=@Project_Manager
		End
	End
	Else If(@Option='9')		
	Begin
		If(@Project_Manager='AA' or @Project_Manager='SYA')
		Begin
--			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, PM.AS_SDate As StartDate,
--				 PM.AS_EDate As EndDate, CM.Emp_Name As Manager 
--			From Request_Master RM, Project_Master PM, Client_Master CM
--			Where RM.Request_ID=PM.Request_ID And CM.Emp_ID=PM.Project_Manager
--			Order By RM.Request_ID

			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, CONVERT(Varchar(11),PM.AS_SDate,113) As StartDate,
				 CONVERT(Varchar(11),PM.AS_EDate,113) As EndDate, CM.Emp_Name As Manager,
				 Leader=Isnull(Case When PM.Project_Leader<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=PM.Project_Leader) End, ''),
				Owner=Isnull(Case When Com.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM.Employee_ID) End, ''),
				Coordinator1=Isnull(Case When COM1.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM1.Employee_ID) End, ''),
				'' As Coordinator2
				--Coordinator2=COM2.Employee_ID
			From Request_Master RM 
				inner join Project_Master PM on RM.Request_ID=PM.Request_ID  
				inner  Join Client_Master CM on CM.Emp_ID=PM.Project_Manager
				inner Join Coordinator_Master COM on PM.Project_ID= COM.Project_ID 
					And COM.Role_ID in ('PO','AA','SYA')
				inner Join Coordinator_Master COM1 on PM.Project_ID= COM1.Project_ID 
					And COM1.Role_ID in ('PC','AA','SYA') And RM.Requested_BY=COM1.Employee_ID
				--inner Join Coordinator_Master COM2 on PM.Project_ID= COM2.Project_ID And COM2.Role_ID='PC' 
			Order By RM.Request_ID

			
		End
		Else If(@Project_Manager='PM')
		Begin
			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, CONVERT(Varchar(11),PM.AS_SDate,113) As StartDate,
				 CONVERT(Varchar(11), PM.AS_EDate, 113) As EndDate, CM.Emp_Name As Manager,
				 Leader=Isnull(Case When PM.Project_Leader<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=PM.Project_Leader) End, ''),
				Owner=Isnull(Case When Com.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM.Employee_ID) End, ''),
				Coordinator1=Isnull(Case When COM1.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM1.Employee_ID) End, ''),
				'' As Coordinator2
				--Coordinator2=COM2.Employee_ID
			From Request_Master RM 
				inner join Project_Master PM on RM.Request_ID=PM.Request_ID  
				inner  Join Client_Master CM on CM.Emp_ID=PM.Project_Manager
				inner Join Coordinator_Master COM on PM.Project_ID= COM.Project_ID 
					And COM.Role_ID='PO'
				inner Join Coordinator_Master COM1 on PM.Project_ID= COM1.Project_ID 
					And COM1.Role_ID='PC' And RM.Requested_BY=COM1.Employee_ID
				Where PM.Project_Manager=@Request_ID
				--inner Join Coordinator_Master COM2 on PM.Project_ID= COM2.Project_ID And COM2.Role_ID='PC' 
			Order By RM.Request_ID
		
		End
		Else If(@Project_Manager='PC')
		Begin
--			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, PM.AS_SDate As StartDate,
--				 PM.AS_EDate As EndDate, CM.Emp_Name As Manager  
--			From Request_Master RM, Project_Master PM, Coordinator_Master COM, Client_Master CM
--			Where RM.Request_ID=PM.Request_ID And CM.Emp_ID=PM.Project_Manager
--				And ((RM.Requested_By=@Request_ID) or (COM.Employee_ID=@Request_ID and COM.Request_ID = RM.Request_ID))
--			Order By RM.Request_ID
			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, Convert(Varchar(12),PM.AS_SDate,113) As StartDate,
				Convert(Varchar(12),PM.AS_EDate,113) As EndDate,CM3.Emp_Name As Coordinator, CM2.Emp_Name As Owner, CM.Emp_Name As Manager  
			From Request_Master RM, Project_Master PM, Coordinator_Master COM, 
				Client_Master CM,Coordinator_Master COM2, Client_Master CM2, Client_Master CM3
			Where RM.Request_ID=PM.Request_ID And CM.Emp_ID=PM.Project_Manager
				And ((RM.Requested_By=@Request_ID) or (COM.Employee_ID=@Request_ID and COM.Request_ID = RM.Request_ID))
				And (PM.Project_ID=COM2.Project_ID and COM2.Role_ID='PO' and COM2.Employee_ID=CM2.Emp_ID)
				And RM.Requested_BY=CM3.Emp_ID
			Order By RM.Request_ID
		End	
		Else If(@Project_Manager='PO')
		Begin
			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, Convert(Varchar(12),PM.AS_SDate,113) As StartDate,
				Convert(Varchar(12),PM.AS_EDate,113) As EndDate,CM3.Emp_Name As Coordinator, CM2.Emp_Name As Owner, CM.Emp_Name As Manager  
			From Request_Master RM, Project_Master PM, Coordinator_Master COM, 
				Client_Master CM,Coordinator_Master COM2, Client_Master CM2, Client_Master CM3
			Where RM.Request_ID=PM.Request_ID And CM.Emp_ID=PM.Project_Manager
				And ((RM.Requested_By=@Request_ID) or (RM.HOD_Approve=@Request_ID) or
				(COM.Employee_ID=@Request_ID and COM.Request_ID = RM.Request_ID ))
				And (PM.Project_ID=COM2.Project_ID and COM2.Role_ID='PO' and COM2.Employee_ID=CM2.Emp_ID)
				And RM.Requested_BY=CM3.Emp_ID
			Order By RM.Request_ID
		End
	End
	Else If(@Option = '10')  
	Begin  
		If((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'PM')
		Begin
			Select PM.Project_Name, PM.Project_ID, PM.Priority, PM.AS_SDate, PM.AS_EDate 
			From Project_Master PM, Request_Master RM
			Where (PM.Project_Manager=@Project_manager or PM.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Project_Manager))
				and PM.Request_ID=RM.Request_ID and RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@Request_ID)
				and RM.Request_Status_ID not in ('RBH','NCFH','RBA','PBA','NCFA','PBH','RBA')
		End 
		Else If((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'PL')
		Begin
			Select PM.Project_Name, PM.Project_ID, PM.Priority, PM.AS_SDate, PM.AS_EDate 
			From Project_Master PM, Request_Master RM 
			Where PM.Project_Leader=@Project_manager  
				and PM.Request_ID=RM.Request_ID and RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@Request_ID)
				and RM.Request_Status_ID not in ('RBH','NCFH','RBA','PBA','NCFA','PBH','RBA')
		End 
		Else If(((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'AA') or ((Select Role_ID From Resource_Master Where Emp_ID=@Project_Manager) = 'SYA'))
		Begin
			Select PM.Project_Name, PM.Project_ID, PM.Priority, PM.AS_SDate, PM.AS_EDate,RM.Request_Status_ID 
			From Project_Master PM, Request_Master RM 
			Where PM.Request_ID=RM.Request_ID and RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@Request_ID)
				and RM.Request_Status_ID not in ('RBH','NCFH','RBA','PBA','NCFA','PBH','RBA')
		End
	End 
	Else IF(@Option='11')  
	Begin  
		Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
			(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
			(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
			RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
			RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
			RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
		From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
			 Client_Master DCM
		Where RM.Request_ID=@Request_ID And RM.Requested_By = CM.Emp_ID 
			and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
			and RM.Request_Status_ID = RSM.Request_Status_ID  
			and RM.Priority_ID = RPM.Priority_ID 
			and PM.Request_ID=RM.Request_ID
			and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
			and PM.Project_Leader =@Project_Manager
			and RM.Request_Status_ID in ('DLG','PFT','PFU','UC','C')  
		Order By PM.Project_ID
	End 
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Project_Operation_Details
-- --------------------------------------------------




  
CREATE Proc [dbo].[USP_Project_Operation_Details]  

@Dept Char(20),  
@PM Char(20),  
@Emp_ID As Char(20),
@Role As Char(20),
@Option Char(10)  
  
As  

Begin  
	IF(@Option='1')
	Begin
		If(@Dept<>'')
		Begin

			If(@Role='AA' or @Role='SYA')
			Begin
				If(@DEPT='ALL')
				Begin
					Select Pm.Project_ID As [ProjectID],PM.Project_Name As [Project], CM.Emp_Name As [Manager], PM.Priority As [Priority],
						Convert(Varchar(11),PM.AS_SDate, 113) As [StartDate], Convert(Varchar(12),PM.AS_EDate,113) As [EndDate], 
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440)) as varchar(2)),'*',0)  + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/60)  - ((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0)  + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))%60 as varchar(2)), 2),'*',0)  As [Elapsed],
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440)) as varchar(2)),'*',0) + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0) + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))%60 as varchar(2)), 2),'*',0) As [Delayed],
						(Case When PM.Status='ABA' Then 'Approved by Administrator' When PM.Status in ('PMA','ACP','DLG') Then 'Work In Progress' 
							When PM.Status='PFT' Then 'Pening For UAT' When PM.Status='PFU' Then 'Pening For UAT'
							When PM.Status='UC' Then 'UAT Complete' End) As [Status]
					From Project_Master PM, Client_Master CM
					Where PM.Project_Manager=CM.Emp_ID and PM.AS_Edate < GEtdate() and PM.Status<>'' and PM.Status<>'C'
				End
				Else If(@DEPT<>'ALL')
				Begin
					Select Pm.Project_ID As [ProjectID],PM.Project_Name As [Project], CM.Emp_Name As [Manager], PM.Priority As [Priority],
						Convert(Varchar(11),PM.AS_SDate, 113) As [StartDate], Convert(Varchar(12),PM.AS_EDate,113) As [EndDate], 
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440)) as varchar(2)),'*',0)  + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/60)  - ((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0)  + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))%60 as varchar(2)), 2),'*',0)  As [Elapsed],
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440)) as varchar(2)),'*',0) + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0) + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))%60 as varchar(2)), 2),'*',0) As [Delayed],
						(Case When PM.Status='ABA' Then 'Approved by Administrator' When PM.Status in ('PMA','ACP','DLG') Then 'Work In Progress' 
							When PM.Status='PFT' Then 'Pening For UAT' When PM.Status='PFU' Then 'Pening For UAT'
							When PM.Status='UC' Then 'UAT Complete' End) As [Status]
					From Project_Master PM, Client_Master CM
					Where PM.Project_Manager=CM.Emp_ID and PM.AS_Edate < GEtdate() and PM.Status<>'' and PM.Status<>'C'
						And PM.Request_ID in (Select Request_ID From Request_Master Where Requested_By in (Select Emp_ID From Client_Master Where Department=@DEPT))
				End
			End
			
		End
		Else IF(@PM<>'')
		Begin
			If(@Role='AA' or @Role='SYA')
			Begin
				If(@PM='ALL')
				Begin
					Select Pm.Project_ID As [ProjectID],PM.Project_Name As [Project], CM.Emp_Name As [Manager], PM.Priority As [Priority],
						Convert(Varchar(11),PM.AS_SDate, 113) As [StartDate], Convert(Varchar(12),PM.AS_EDate,113) As [EndDate], 
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440)) as varchar(2)),'*',0)  + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/60)  - ((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0)  + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))%60 as varchar(2)), 2),'*',0)  As [Elapsed],
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440)) as varchar(2)),'*',0) + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0) + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))%60 as varchar(2)), 2),'*',0) As [Delayed],
						(Case When PM.Status='ABA' Then 'Approved by Administrator' When PM.Status in ('PMA','ACP','DLG') Then 'Work In Progress' 
							When PM.Status='PFT' Then 'Pening For UAT' When PM.Status='PFU' Then 'Pening For UAT'
							When PM.Status='UC' Then 'UAT Complete' End) As [Status]
					From Project_Master PM, Client_Master CM
					Where PM.Project_Manager=CM.Emp_ID and PM.AS_Edate < GEtdate() and PM.Status<>'' and PM.Status<>'C'
				End
				Else If(@PM<>'ALL')
				Begin
					Select Pm.Project_ID As [ProjectID],PM.Project_Name As [Project], CM.Emp_Name As [Manager], PM.Priority As [Priority],
						Convert(Varchar(11),PM.AS_SDate, 113) As [StartDate], Convert(Varchar(12),PM.AS_EDate,113) As [EndDate], 
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440)) as varchar(2)),'*',0)  + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/60)  - ((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0)  + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_SDate,GETDATE()))%60 as varchar(2)), 2),'*',0)  As [Elapsed],
						Replace(CAST(((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440)) as varchar(2)),'*',0) + ':' +  Replace(cast((((((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))/(1440))*24))%60) as varchar(2)),'*',0) + ':' + Replace(RIGHT('0' + cast((DATEDIFF(MINUTE,PM.AS_EDate,GETDATE()))%60 as varchar(2)), 2),'*',0) As [Delayed],
						(Case When PM.Status='ABA' Then 'Approved by Administrator' When PM.Status in ('PMA','ACP','DLG') Then 'Work In Progress' 
							When PM.Status='PFT' Then 'Pening For UAT' When PM.Status='PFU' Then 'Pening For UAT'
							When PM.Status='UC' Then 'UAT Complete' End) As [Status]
					From Project_Master PM, Client_Master CM
					Where PM.Project_Manager=CM.Emp_ID and PM.AS_Edate < GEtdate() and PM.Status<>'' and PM.Status<>'C'
						And PM.Project_Manager=@PM
				End
			End
		
		End
	End
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Project_Phase_Status_Operation
-- --------------------------------------------------




CREATE Proc [dbo].[USP_Project_Phase_Status_Operation]

@PPID As Char(10),
@Request_ID As Char(10),
@Project_ID As Char(10),
-- RA --

@Phase_ID1 As Char(10),
@Phase_Name As Varchar(50),
@SDate1 As Datetime,
@EDate1 As Datetime,
@LUpdated_By1 As Char(10),
@LUpdated_On1 AS Datetime,
@Status1 As Varchar(50),
@Option As int


As

Begin
	Declare @PPDetailsID As char(10)

	If(@Option=1)
	Begin

		If((Select count(PP_ID) From Tbl_Project_Phase_Status Where Project_ID=@Project_ID) > 0)
		Begin
			Select PPS.Request_ID, PPS.Project_ID, PPS.Phase_ID, PHM.Phase_Name, Convert(Varchar,PPS.SDate,101), Convert(Varchar,PPS.EDate,101), RSM.Emp_Name,
					PPS.Last_Updated_By, Convert(Varchar,PPS.Last_Updated_On,103), (Case When PPS.Status='PStatus' Then 'Pending' When PPS.Status='IPStatus' Then 'In Progress' When PPS.Status='CStatus' Then 'Complete' End) As Status
			From Tbl_Project_Phase_Status PPS, Resource_Master RSM, Phase_Master PHM
			Where Project_ID=@Project_ID and PPS.Last_Updated_By=RSM.Emp_ID and PPS.Phase_ID=PHM.Phase_ID and Upper(PHM.Phase_Name) like Upper('Requirement Analysis')

			Select PPS.Request_ID, PPS.Project_ID, PPS.Phase_ID, PHM.Phase_Name, Convert(Varchar,PPS.SDate,101), Convert(Varchar,PPS.EDate,101), RSM.Emp_Name,
					PPS.Last_Updated_By, Convert(Varchar,PPS.Last_Updated_On,103), (Case When PPS.Status='PStatus' Then 'Pending' When PPS.Status='IPStatus' Then 'In Progress' When PPS.Status='CStatus' Then 'Complete' End) As Status
			From Tbl_Project_Phase_Status PPS, Resource_Master RSM, Phase_Master PHM
			Where Project_ID=@Project_ID and PPS.Last_Updated_By=RSM.Emp_ID and PPS.Phase_ID=PHM.Phase_ID and Upper(PHM.Phase_Name) like Upper('Development')

			Select PPS.Request_ID, PPS.Project_ID, PPS.Phase_ID, PHM.Phase_Name, Convert(Varchar,PPS.SDate,101), Convert(Varchar,PPS.EDate,101), RSM.Emp_Name,
					PPS.Last_Updated_By, Convert(Varchar,PPS.Last_Updated_On,103), (Case When PPS.Status='PStatus' Then 'Pending' When PPS.Status='IPStatus' Then 'In Progress' When PPS.Status='CStatus' Then 'Complete' End) As Status
			From Tbl_Project_Phase_Status PPS, Resource_Master RSM, Phase_Master PHM
			Where Project_ID=@Project_ID and PPS.Last_Updated_By=RSM.Emp_ID and PPS.Phase_ID=PHM.Phase_ID and Upper(PHM.Phase_Name) like Upper('Testing')

			Select PPS.Request_ID, PPS.Project_ID, PPS.Phase_ID, PHM.Phase_Name, Convert(Varchar,PPS.SDate,101), Convert(Varchar,PPS.EDate,101), RSM.Emp_Name,
					PPS.Last_Updated_By, Convert(Varchar,PPS.Last_Updated_On,103), (Case When PPS.Status='PStatus' Then 'Pending' When PPS.Status='IPStatus' Then 'In Progress' When PPS.Status='CStatus' Then 'Complete' End) As Status
			From Tbl_Project_Phase_Status PPS, Resource_Master RSM, Phase_Master PHM
			Where Project_ID=@Project_ID and PPS.Last_Updated_By=RSM.Emp_ID and PPS.Phase_ID=PHM.Phase_ID and Upper(PHM.Phase_Name) like Upper('User Documents')

			Select PPS.Request_ID, PPS.Project_ID, PPS.Phase_ID, PHM.Phase_Name, Convert(Varchar,PPS.SDate,101), Convert(Varchar,PPS.EDate,101), RSM.Emp_Name,
					PPS.Last_Updated_By, Convert(Varchar,PPS.Last_Updated_On,103), (Case When PPS.Status='PStatus' Then 'Pending' When PPS.Status='IPStatus' Then 'In Progress' When PPS.Status='CStatus' Then 'Complete' End) As Status
			From Tbl_Project_Phase_Status PPS, Resource_Master RSM, Phase_Master PHM
			Where Project_ID=@Project_ID and PPS.Last_Updated_By=RSM.Emp_ID and PPS.Phase_ID=PHM.Phase_ID and Upper(PHM.Phase_Name) like Upper('UAT')

			Select PPS.Request_ID, PPS.Project_ID, PPS.Phase_ID, PHM.Phase_Name, Convert(Varchar,PPS.SDate,101), Convert(Varchar,PPS.EDate,101), RSM.Emp_Name,
					PPS.Last_Updated_By, Convert(Varchar,PPS.Last_Updated_On,103), (Case When PPS.Status='PStatus' Then 'Pending' When PPS.Status='IPStatus' Then 'In Progress' When PPS.Status='CStatus' Then 'Complete' End) As Status
			From Tbl_Project_Phase_Status PPS, Resource_Master RSM, Phase_Master PHM
			Where Project_ID=@Project_ID and PPS.Last_Updated_By=RSM.Emp_ID and PPS.Phase_ID=PHM.Phase_ID and Upper(PHM.Phase_Name) like Upper('Deployment')

			Select PPS.Request_ID, PPS.Project_ID, PPS.Phase_ID, PHM.Phase_Name, Convert(Varchar,PPS.SDate,101), Convert(Varchar,PPS.EDate,101), RSM.Emp_Name,
					PPS.Last_Updated_By, Convert(Varchar,PPS.Last_Updated_On,103), (Case When PPS.Status='PStatus' Then 'Pending' When PPS.Status='IPStatus' Then 'In Progress' When PPS.Status='CStatus' Then 'Complete' End) As Status
			From Tbl_Project_Phase_Status PPS, Resource_Master RSM, Phase_Master PHM
			Where Project_ID=@Project_ID and PPS.Last_Updated_By=RSM.Emp_ID and PPS.Phase_ID=PHM.Phase_ID  and Upper(PHM.Phase_Name) like Upper('Feedback')

		End	
			Select Project_ID, AS_SDate, AS_EDate From Project_Master Where Project_ID=@Project_ID
	End
	Else If(@Option=2)
	Begin
		Set @Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Project_ID)

		If((Select Count(PP_ID) From Tbl_Project_Phase_Status Where Project_ID=@Project_ID) = 0)
		Begin
			Set @PPID = rtrim(@Project_ID) + '1001'
		End			
		Else If((Select Count(PP_ID) From Tbl_Project_Phase_Status Where Project_ID=@Project_ID) > 0)
		Begin
			Declare @MAX As Int
			
			Set @MAX = (Select MAX(PP_ID) From Tbl_Project_Phase_Status Where Project_ID=@Project_ID)
			
			Set @PPID = rtrim(@Project_ID) + Convert(Char,((@MAX % 10000) + 1))
		End
		
		Set @Phase_ID1=(Select Phase_ID From Phase_Master Where Upper(Phase_Name) like Upper(@Phase_Name))

		Insert Into Tbl_Project_Phase_Status
			(PP_ID,Request_ID, Project_ID, Phase_ID, SDate, EDate, Last_Updated_By, Last_Updated_On, Status)
		Values (@PPID, @Request_ID, @Project_ID, @Phase_ID1, @SDate1, @EDate1, @LUpdated_By1, @LUpdated_On1, @Status1)
		--Where Project_ID=@Project_ID

		If NOT EXISTS (Select top 1 PP_Details_ID From Tbl_Project_Phase_Status_details) 
		Begin
			Set @PPDetailsID = '1001'
		End		
		Else 
		Begin
			Set @PPDetailsID = Convert(char(10) ,(Convert(int, (Select Max(PP_Details_ID) From Tbl_Project_Phase_Status_details)) + 1) ) 
		End

		Insert Into Tbl_Project_Phase_Status_details
			Select @PPDetailsID,* From Tbl_Project_Phase_Status Where PP_ID=@PPID

		Select @Project_ID
	End
	Else If(@Option=3)
	Begin

		Set @Phase_ID1=(Select Phase_ID From Phase_Master Where Upper(Phase_Name) like Upper(@Phase_Name))

		Update Tbl_Project_Phase_Status
		Set SDate=@SDate1, EDate=@EDate1, Last_updated_By=@LUpdated_By1, Last_Updated_On=@LUpdated_On1, Status=@Status1
		Where Project_ID=@Project_ID and Phase_ID=@Phase_ID1

		If NOT EXISTS(Select top 1 PP_Details_ID From Tbl_Project_Phase_Status_details) 
		Begin
			Set @PPDetailsID = '1001'
		End		
		Else 
		Begin
			Set @PPDetailsID = Convert(char(10) ,(Convert(int, (Select Max(PP_Details_ID) From Tbl_Project_Phase_Status_details)) + 1) ) 
		End
	
		Select @PPDetailsID

		Insert Into Tbl_Project_Phase_Status_details
			Select @PPDetailsID,PP_ID,Request_ID, Project_ID, Phase_ID, SDate, EDate, Last_Updated_By, Last_Updated_On, Status From Tbl_Project_Phase_Status Where Project_ID=@Project_ID and Phase_ID=@Phase_ID1

		Select @Phase_Name

	End

----Select * From Tbl_Project_Phase_Status

	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Project_Reference
-- --------------------------------------------------
Create Proc USP_Project_Reference

@Request_ID As Char(10),
@Ref_Request_ID AS Char(10),
@Ref_Project_ID AS Char(10),
@Option As Int

As 
Begin
	If(@Option=1)
	Begin
		Set @Ref_Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Ref_Project_ID)

		Insert Into Tbl_Project_Reference
		Values(@Request_ID,@Ref_Request_ID)
		
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Project_Status_Report
-- --------------------------------------------------


CREATE Procedure [dbo].[usp_Project_Status_Report]
@ProjectCode varchar(20)
as

Begin

	Select Module_Name as [Module Name], [Assigned Start Time] as [Assigned Start Date], [Assigned End Time] as [Assigned End Date], [Assigned Time] as [Total Assigned Time], [Actual Start Time] as [Actual Start Date], [Actual End Time] as [Actual End Date],[Actual Time] as [Actual Total Time], [Resource], [Status Name], [Status %]
	From 
	(
	Select Module_Name, Convert(varchar(12), AS_SDT) as [Assigned Start Time], Convert(varchar(12), AS_EDT) as [Assigned End Time], 
	cast(AS_Time/60 as varchar(5)) + ':' + RIGHT('0' + cast(AS_Time%60 as varchar(2)), 2) as [Assigned Time], Convert(varchar(12), AC_SDT) as [Actual Start Time], 
	Convert(varchar(12), AC_EDT) as [Actual End Time], cast(AC_Time/60 as varchar(5)) + ':' + RIGHT('0' + cast(AC_Time%60 as varchar(2)), 2) as [Actual Time], Client_Master.Emp_Name as [Resource], Task_Status_Master.Task_Status_Name as [Status Name],
	[Status %] = isnull(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @ProjectCode )),2),0)) End, 0)
	from Module_Master
	inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
	inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
	inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
   inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
	Where Project_Details.Project_ID = @ProjectCode
	--and Task_Master.Task_Status_ID = 'C'
	Group by Module_Name, AS_SDT, AS_EDT, AS_Time, AC_SDT, AC_EDT, AC_Time, Client_Master.Emp_Name, Task_Status_Master.Task_Status_Name, Task_Master.Status_ID

	union 

	Select 'Total' as Module_Name, '' as [Assigned Start Time], '' as [Assigned End Time], cast((AS_Time)/60 as varchar(5)) + ':' + RIGHT('0' + cast((AS_Time)%60 as varchar(2)), 2) as [Assigned Time] , '' as [Actual Start Time], '' as [Actual End Time], cast(AC_Time/60 as varchar(5)) + ':' + RIGHT('0' + cast(AC_Time%60 as varchar(2)), 2)  as [Actual Time]  , '' as [Resource], '' as [Status Name], [Status %] = Sum([Status %])
	From
	(
	Select 'Total' as Module_Name, '' as [Assigned Start Time], '' as [Assigned End Time], Sum(AS_Time) as AS_Time, '' as [Actual Start Time], '' as [Actual End Time], Sum(AC_Time)as AC_Time  , '' as [Resource], '' as [Status Name], [Status %] = Sum([Status %])
	From 
	(
	Select Module_Name, AS_SDT [Assigned Start Time], AS_EDT [Assigned End Time], 
	AS_Time,
	AC_SDT [Actual Start Time], AC_EDT as [Actual End Time],
	AC_Time, Client_Master.Emp_Name as [Resource],Task_Status_Master.Task_Status_Name as [Status Name],
	[Status %] = isnull(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @ProjectCode )),2),0)) End, 0)
	from Module_Master
	inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
	inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
 	inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
    inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
 	Where Project_Details.Project_ID = @ProjectCode
	Group by Module_Name, AS_SDT, AS_EDT, AS_Time, AC_SDT, AC_EDT, AC_Time, Client_Master.Emp_Name, Task_Status_Name, Task_Master.Status_ID
	)Su
	) T
	Group By Module_Name, [Assigned Start Time], [Assigned End Time], AS_Time, [Actual Start Time], [Actual End Time],AC_Time, [Resource], [Status Name], [Status %]
	) S
	Group By Module_Name, [Assigned Start Time], [Assigned End Time], [Assigned Time], [Actual Start Time], [Actual End Time],[Actual Time], [Resource], [Status Name], [Status %]
	Order by [Status %]

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Project_Status_Report_New
-- --------------------------------------------------










CREATE Procedure [dbo].[usp_Project_Status_Report_New]

@ProjectID varchar(20),
@PhaseName Varchar(50),
@EmpID Char(10),
@Role Char(10),
@Option Char(5)

As

Begin
	Declare @PhaseID char(20)

	If(@Option='1')
	Begin

--		Select Distinct PHM.Phase_ID As PhaseID, Phase_Name As PhaseName, '' AS Status
--		From Phase_Master PHM, Project_Details PD
--		Where PHM.Phase_ID=PD.Phase_ID
--			And PD.Project_ID=@ProjectID
--
--		Select PhaseID,PhaseName,SUM([Status %]) As Status
--		From
--		(
--			Select Phase_Master.Phase_ID As PhaseID,Phase_master.Phase_Name As PhaseName,Module_name,	
--					[Status %] = ISNULL(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID =  @ProjectID)),2),0)) End, 0)
--			from Module_Master
--					inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
--					inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
-- 					inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
--					inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
--					join Phase_master on Project_Details.Phase_ID=Phase_Master.Phase_ID
-- 			Where Project_Details.Project_ID = @ProjectID     
--				Group by Phase_Master.Phase_ID,Phase_master.Phase_Name,Module_Name,Task_Master.Status_ID
--		) T 
--		Group by PhaseID,PhaseName

		Select PhaseID, PhaseName, Status
		From
		(
			Select PhaseID,PhaseName,SUM([Status %]) As Status
			From
			(
				Select Phase_Master.Phase_ID As PhaseID,Phase_master.Phase_Name As PhaseName,Module_name,	
						[Status %] = ISNULL(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @ProjectID )),2),0)) End, 0)
				from Module_Master
						inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
						inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
 						inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
						inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
						join Phase_master on Project_Details.Phase_ID=Phase_Master.Phase_ID
 				Where Project_Details.Project_ID = @ProjectID
					Group by Phase_Master.Phase_ID,Phase_master.Phase_Name,Module_Name,Task_Master.Status_ID
			) T 
			Group By PhaseID, PhaseName

			Union

			Select P.Phase_ID As PhaseID, P.Phase_Name As PhaseName,'0' As Status
			From Phase_Master P
			Where P.Phase_ID not in 
			(
				Select PhaseID
				From
				(
					Select Phase_Master.Phase_ID As PhaseID,Phase_master.Phase_Name As PhaseName,Module_name,	
							[Status %] = ISNULL(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @ProjectID )),2),0)) End, 0)
					from Module_Master
							inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
							inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
 							inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
							inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
							join Phase_master on Project_Details.Phase_ID=Phase_Master.Phase_ID
 					Where Project_Details.Project_ID = @ProjectID     
						Group by Phase_Master.Phase_ID,Phase_master.Phase_Name,Module_Name,Task_Master.Status_ID
				) T 
				Group by PhaseID,PhaseName
			)	
		) Temp Order By Status Desc

	End
	Else If(@Option = '2')
	Begin
		Select @PhaseID=Phase_ID From Phase_Master Where Phase_Name=@PhaseName

		Select Module_Name as [Module Name], [Assigned Start Time] as [Assigned Start Date], [Assigned End Time] as [Assigned End Date], [Assigned Time] as [Total Assigned Time], [Actual Start Time] as [Actual Start Date], [Actual End Time] as [Actual End Date],[Actual Time] as [Actual Total Time], [Resource], [Status Name], [Status %] As [Status (%)]
		From 
		(
		Select Module_Name, Convert(varchar(12), AS_SDT) as [Assigned Start Time], Convert(varchar(12), AS_EDT) as [Assigned End Time], 
		IsNull(cast(AS_Time/60 as varchar(5)) + ':' + RIGHT('0' + cast(AS_Time%60 as varchar(2)), 2),0) as [Assigned Time], Convert(varchar(12), AC_SDT) as [Actual Start Time], 
		Convert(varchar(12), AC_EDT) as [Actual End Time], cast(AC_Time/60 as varchar(5)) + ':' + RIGHT('0' + cast(AC_Time%60 as varchar(2)), 2) as [Actual Time], Client_Master.Emp_Name as [Resource], Task_Status_Master.Task_Status_Name as [Status Name],
		[Status %] = isnull(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @ProjectID )),2),0)) End, 0)
		from Module_Master
		inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
		inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
		inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
		inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
		join Phase_master on Project_Details.Phase_ID=Phase_Master.Phase_ID
		Where Project_Details.Project_ID = @ProjectID
			And Phase_Master.Phase_ID=@PhaseID
		--and Task_Master.Task_Status_ID = 'C'
		Group by Module_Name, AS_SDT, AS_EDT, AS_Time, AC_SDT, AC_EDT, AC_Time, Client_Master.Emp_Name, 
			Task_Status_Master.Task_Status_Name, Task_Master.Status_ID

		union 

		Select 'Total' as Module_Name, '' as [Assigned Start Time], '' as [Assigned End Time], cast((AS_Time)/60 as varchar(5)) + ':' + RIGHT('0' + cast((AS_Time)%60 as varchar(2)), 2) as [Assigned Time] , '' as [Actual Start Time], '' as [Actual End Time], cast(AC_Time/60 as varchar(5)) + ':' + RIGHT('0' + cast(AC_Time%60 as varchar(2)), 2)  as [Actual Time]  , '' as [Resource], '' as [Status Name], [Status %] = Sum([Status %]) 
		From
		(
			Select 'Total' as Module_Name, '' as [Assigned Start Time], '' as [Assigned End Time], Sum(AS_Time) as AS_Time, '' as [Actual Start Time], '' as [Actual End Time], Sum(AC_Time)as AC_Time  , '' as [Resource], '' as [Status Name], [Status %] = Sum([Status %])
			From 
			(
				Select Module_Name, AS_SDT [Assigned Start Time], AS_EDT [Assigned End Time], 
				AS_Time,
				AC_SDT [Actual Start Time], AC_EDT as [Actual End Time],
				AC_Time, Client_Master.Emp_Name as [Resource],Task_Status_Master.Task_Status_Name as [Status Name],
				[Status %] = isnull(Case When Task_Master.Status_ID = 'C' Then (round(convert(VARCHAR,convert(varchar,100.0 * SUM(AS_Time) / (SELECT SUM(AS_Time) FROM Task_Master where Task_Master.Project_ID = @ProjectID )),2),0)) End, 0)
				from Module_Master
					inner join Task_Master on Task_Master.Module_ID = Module_Master.Module_ID
					inner join Client_Master on Client_Master.Emp_ID = Task_Master.Assigned_To
 					inner join Task_Status_Master on Task_Status_Master.Task_Status_ID = Task_Master.Status_ID
					inner join Project_Details on Project_Details.Module_ID = Module_Master.Module_ID
					join Phase_master on Project_Details.Phase_ID=Phase_Master.Phase_ID
 				Where Project_Details.Project_ID = @ProjectID And Phase_Master.Phase_ID=@PhaseID

			Group by Module_Name, AS_SDT, AS_EDT, AS_Time, AC_SDT, AC_EDT, AC_Time, Client_Master.Emp_Name, Task_Status_Name, Task_Master.Status_ID
			)Su
		) T
		Group By Module_Name, [Assigned Start Time], [Assigned End Time], AS_Time, [Actual Start Time], [Actual End Time],AC_Time, [Resource], [Status Name], [Status %]
		) S
		Group By Module_Name, [Assigned Start Time], [Assigned End Time], [Assigned Time], [Actual Start Time], [Actual End Time],[Actual Time], [Resource], [Status Name], [Status %]
		Order by [Assigned Start Time] desc, [Assigned End Time]desc, [Status %] 
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Project_Summary_Status_Report
-- --------------------------------------------------





--USP_Project_Summary_Status_Report '1005','Sanjay Patel','1/1/1900 12:00:00 AM','1/1/1900 12:00:00 AM','','','','6'

--USP_Project_Summary_Status_Report 'E03446','','3/31/2010 12:00:00 AM','10/31/2010 12:00:00 AM','','P00227','AA','4'

CREATE Proc [dbo].[USP_Project_Summary_Status_Report]

@PM As Varchar(20),
@Prj_Manager as varchar(150),
@FDate As Datetime,
@EDate As Datetime, 
@Type As Char(5),
@Emp_ID As Varchar(20),
@Role As Varchar(20),
@Option As Int

As 
Begin
	Declare @Request_ID Varchar(20)
	Declare @TW As INT
	Declare @TWH AS Int


	If(@FDate='1/1/1900 12:00:00 AM' AND @EDate='1/1/1900 12:00:00 AM')
	Begin
		Set @FDate = Convert(Datetime,CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110))
		Set @EDate = Convert(Datetime,CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110))
	End

--	Set @TWD = ((Select dbo.getWorkingDays(@FDate,@EDate)) + (Select dbo.GetSaturdayDays(@FDate,@EDate)))
--	Set @TWH = (((Select dbo.getWorkingDays(@FDate,@EDate)) * 8) + ((Select dbo.GetSaturdayDays(@FDate,@EDate)) * 6 )) 

		Set @TW = (Select dbo.GetTotalWorkingDays(@FDate,@EDate)) 


	If(@Prj_Manager <> '' )
	Begin 
		Set @Request_ID = (Select @PM)
		Set @PM = ''	
		set @PM = (select Emp_ID from Resource_Master where Upper(Emp_Name) = Upper(@Prj_Manager))
	End

	If(@Option=1)
	Begin
		Select Distinct Emp_Name , Emp_ID From Resource_Master 
		Where Role_ID In ('SYA','PM') And Active_Status=1 
		Order By Emp_Name
	End
	Else If(@Option=2)
	Begin
		If(@PM='')
		Begin
			If(Convert(DateTime, @FDate)='1/1/1900 12:00:00 AM' AND Convert(DateTime, @EDate)='1/1/1900 12:00:00 AM')
			Begin
				Select  PM, SUM(NP) As NP, SUM(PTBC) As PTBC, SUM(BP) As BP, SUM(C) As C,SUM(RP) As RP, SUM(PTBC+BP+C+RP) As T
				From
				(
					Select distinct PM,'0' As NP,'0' As PTBC,SUM(C) AS C,'0' As BP,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,
							(CASE When RM.Request_Status_ID in ('C')  Then Count(RM.Request_ID) Else '0' End ) As C
						From Request_Master RM, Project_Master PM, Resource_Master RSM ,Project_Status_Master PSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager = RSM.Emp_ID 
							And PSM.Request_ID = RM.Request_ID
							and (PSM.Close_Status_On is not NULL or PSM.Close_Status_On <> '')
						Group By  RSM.Emp_Name,RM.Request_Status_ID
					) T  Group By  PM

					UNION

					Select PM,'0' AS NP, '0' AS PTBC,'0' As C, '0' As BP, Sum(RP) As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,PM.Request_ID,
							(CASE When RM.Request_Status_ID in ('PMA','ACP','DLG') Then Count(RM.Request_ID)Else '0' End ) As RP
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID
							And PM.Reschedule = 1
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,PM.Request_ID
					) T Group By  PM
					
					UNION
				
					Select PM,SUM(NP) AS NP, SUM(PTBC) AS PTBC,'0' As C, '0' As BP ,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('PMA') Then Count(RM.Request_ID)Else '0' End ) As NP,
							(CASE When RM.Request_Status_ID in ('ACP','DLG') Then Count(RM.Request_ID) Else '0' End ) As PTBC
							
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM

					UNION

					Select distinct PM,'0' As NP,'0' As PTBC,'0' As C,SUM(BP) AS BP, '0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('ACP','PMA','DLG') Then Count(RM.Request_ID)Else '0' End ) As BP
						From Request_Master RM, Project_Master PM, Resource_Master RSM 
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM

				) T
				Group By  PM
			End
			Else 
			Begin
				Select  PM, SUM(NP) As NP, SUM(PTBC) As PTBC, SUM(BP) As BP, SUM(C) As C, SUM(RP) As RP, SUM(PTBC+BP+C+RP) As T
				From
				(
					Select distinct PM,'0' As NP,'0' As PTBC,SUM(C) AS C,'0' As BP ,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('C') Then Count(RM.Request_ID) Else '0' End ) As C
						From Request_Master RM, Project_Master PM, Resource_Master RSM,Project_Status_Master PSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID 
							And PSM.Request_ID = RM.Request_ID
							and (PSM.Close_Status_On is not NULL or PSM.Close_Status_On <> '')
							And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T  Group By  PM

					UNION

					Select PM,SUM(NP) AS NP, SUM(PTBC) AS PTBC,'0' As C, '0' As BP ,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('PMA') Then Count(RM.Request_ID)Else '0' End ) As NP,
							(CASE When RM.Request_Status_ID in ('ACP','DLG') Then Count(RM.Request_ID) Else '0' End ) As PTBC
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM

					UNION
					
					Select PM,'0' AS NP, '0' AS PTBC,'0' As C, '0' As BP ,SUM(RP) As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM, PM.Request_ID,					
							(CASE When RM.Request_Status_ID in ('PMA','ACP','DLG') Then Count(RM.Request_ID) Else '0' End ) As RP
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID
							And PM.Reschedule = 1
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,PM.Request_ID
					) T Group By  PM

					
					UNION

					Select distinct PM,'0' As NP,'0' As PTBC,'0' As C,SUM(BP) AS BP ,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM, RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('ACP','PMA','DLG') Then Count(RM.Request_ID)Else '0' End ) As BP
						From Request_Master RM, Project_Master PM, Resource_Master RSM 
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM

				) T
				Group By  PM
			End	
		End
		Else If(@PM<>'')
		Begin
			If(Convert(DateTime, @FDate)='1/1/1900 12:00:00 AM' AND Convert(DateTime, @EDate)='1/1/1900 12:00:00 AM')
			Begin
				Select  PM, SUM(NP) As NP, SUM(PTBC) As PTBC, SUM(BP) As BP, SUM(C) As C, SUM(RP) As RP, SUM(PTBC+BP+C+RP) As T
				From
				(
					Select distinct PM,'0' As NP,'0' As PTBC,SUM(C) AS C,'0' As BP,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,
							(CASE When RM.Request_Status_ID in ('C') Then Count(RM.Request_ID) Else '0' End ) As C
						From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
							And PSM.Request_ID = RM.Request_ID
							and PM.Project_ID=PSM.Project_ID
							and (PSM.Close_Status_On is not NULL or PSM.Close_Status_On <> '')
						Group By  RSM.Emp_Name,RM.Request_Status_ID
					) T  Group By  PM

					UNION

					Select PM,SUM(NP) AS NP, SUM(PTBC) AS PTBC,'0' As C, '0' As BP,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('PMA') Then Count(RM.Request_ID)Else '0' End ) As NP,
							(CASE When RM.Request_Status_ID in ('ACP','DLG') Then Count(RM.Request_ID) Else '0' End ) As PTBC							
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM

					
					UNION

					Select PM,'0' AS NP,'0' AS PTBC,'0' As C, '0' As BP,Sum(RP) As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,PM.Request_ID,
							(CASE When RM.Request_Status_ID in ('PMA','ACP','DLG') Then Count(RM.Request_ID)Else '0' End ) As RP
						
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
							And PM.Reschedule = 1
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,PM.Request_ID
					) T Group By  PM
					
					UNION

					Select distinct PM,'0' As NP,'0' As PTBC,'0' As C,SUM(BP) AS BP ,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM, RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('ACP','PMA','DLG') Then Count(RM.Request_ID)Else '0' End ) As BP
						From Request_Master RM, Project_Master PM, Resource_Master RSM 
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM

				) T
				Group By  PM
			End
			Else 
			Begin
				Select  PM, SUM(NP) As NP, SUM(PTBC) As PTBC, SUM(BP) As BP, SUM(C) As C,SUM(RP) As RP, SUM(PTBC+BP+C+RP) As T
				From
				(
					Select distinct PM,'0' As NP,'0' As PTBC,SUM(C) AS C,'0' As BP ,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,
							(CASE When RM.Request_Status_ID in ('C') Then Count(RM.Request_ID) Else '0' End ) As C
						From Request_Master RM, Project_Master PM, Resource_Master RSM ,Project_Status_MAster PSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID  And PM.Project_manager=@PM
							And PSM.Request_ID = RM.Request_ID
							and PM.Project_ID=PSM.Project_ID
							and (PSM.Close_Status_On is not NULL or PSM.Close_Status_On <> '')
							And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID
					) T  Group By  PM

					UNION

					Select PM,SUM(NP) AS NP, SUM(PTBC) AS PTBC,'0' As C, '0' As BP,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('PMA') Then Count(RM.Request_ID)Else '0' End ) As NP,
							(CASE When RM.Request_Status_ID in ('ACP','DLG') Then Count(RM.Request_ID) Else '0' End ) As PTBC
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM
					
					UNION

					Select PM,'0' AS NP,'0' AS PTBC,'0' As C, '0' As BP,Sum(RP) As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM,PM.Request_ID,
							(CASE When RM.Request_Status_ID in ('PMA','ACP','DLG') Then Count(RM.Request_ID)Else '0' End ) As RP
							
						From Request_Master RM, Project_Master PM, Resource_Master RSM
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
							And PM.Reschedule = 1
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,PM.Request_ID
					) T Group By  PM

					UNION

					Select distinct PM,'0' As NP,'0' As PTBC,'0' As C,SUM(BP) AS BP,'0' As RP
					From 
					(
						Select distinct RSM.Emp_Name As PM, RM.Request_ID,
							(CASE When RM.Request_Status_ID in ('ACP','PMA','DLG') Then Count(RM.Request_ID)Else '0' End ) As BP
						From Request_Master RM, Project_Master PM, Resource_Master RSM 
						Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
							And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
						Group By  RSM.Emp_Name,RM.Request_Status_ID,RM.Request_ID
					) T Group By  PM

				) T
				Group By  PM
			End	
		End	
	End
	Else If(@Option=3)
	Begin
		If(@PM <> '')
		Begin
			If(Convert(DateTime, @FDate)='1/1/1900 12:00:00 AM' AND Convert(DateTime, @EDate)='1/1/1900 12:00:00 AM')
			Begin
				If(@Type = 'T')
				Begin				
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],'' as [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('PMA') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
					
					UNION
			
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],'' as [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						And RM.Request_Status_ID in ('ACP','DLG') and PM.Project_Manager = @PM And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
					
					UNION
			
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],'' as [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						And RM.Request_Status_ID in ('PMA','ACP','DLG') and PM.Project_Manager = @PM
						And PM.Reschedule = 1
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
	
					

					UNION
			
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],
						--((CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3))+ ':' + cast((((((DATEDIFF(MINUTE,AS_EDate,getdate()))/60) - ((DATEDIFF(MINUTE,AS_EDate,getdate()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,AS_EDate,getdate()))%60 as varchar(3)), 3)))
						(CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)))	 As [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2						
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('ACP','PMA','DLG') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))

					UNION
		
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],convert(varchar(11),PSM.Close_Status_On,113) as [Project_CDate],'' as [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and RM.Request_ID = PSM.Request_ID
						and PM.Project_Manager = @PM
						and PM.Project_ID=PSM.Project_ID
						And RM.Request_Status_ID in ('C')
--						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
				End

				Else If(@Type='NP')
				Begin
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('PMA') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
				End
				
				Else If(@Type='PTBC')
				Begin
					
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID  And PM.Reschedule = 0
						And RM.Request_Status_ID in ('ACP','DLG') and PM.Project_Manager = @PM
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
				End
				
				Else If(@Type='RP')
				Begin
					
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						And RM.Request_Status_ID in ('PMA','ACP','DLG') and PM.Project_Manager = @PM
						And PM.Reschedule = 1
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
				End
				
				Else If(@Type='BP')
				Begin
					
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],
						--((CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)) + ':' + cast((((((DATEDIFF(MINUTE,AS_EDate,getdate()))/60) - ((DATEDIFF(MINUTE,AS_EDate,getdate()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,AS_EDate,getdate()))%60 as varchar(3)), 3))) As [Elapsed]
						(CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)))	 As [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2						
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('ACP','PMA','DLG') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))
				End
				Else If(@Type='C')
				Begin
					
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],convert(varchar(11),PSM.Close_Status_On,113) as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and RM.Request_ID = PSM.Request_ID
						and PM.Project_Manager = @PM
						and PM.Project_ID=PSM.Project_ID
						And RM.Request_Status_ID in ('C')
--						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
				End
			End	
		Else 
			Begin
			If(@Type='T')
				Begin
					
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],'' as [Elapsed]
						From Request_Master RM, Project_Master PM, Resource_Master RSM, 
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
						Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
							And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
							and PM.Project_Manager = @PM
							And RM.Request_Status_ID in ('ACP','DLG')  And PM.Reschedule = 0
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) >  Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
					
					UNION

					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],'' as [Elapsed]
						From Request_Master RM, Project_Master PM, Resource_Master RSM, 
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
						Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
							And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
							and PM.Project_Manager = @PM
							And PM.Reschedule = 1
							And RM.Request_Status_ID in ('PMA','ACP','DLG')
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
					
					UNION
					
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Prj_Cdate],
							--((CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)) + ':' + cast((((((DATEDIFF(MINUTE,AS_EDate,getdate()))/60) - ((DATEDIFF(MINUTE,AS_EDate,getdate()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,AS_EDate,getdate()))%60 as varchar(3)), 3))) As [Elapsed]
							(CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)))	 As [Elapsed]
						From Request_Master RM, Project_Master PM, Resource_Master RSM, 
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
						Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
							And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
							and PM.Project_Manager = @PM
							And RM.Request_Status_ID in ('ACP','PMA','DLG') And PM.Reschedule = 0
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				
					UNION
						
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],convert(varchar(11),PSM.Close_Status_On,113) as [Project_CDate],'' as [Elapsed]
						From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
						Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
							And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
							and RM.Request_ID = PSM.Request_ID
							and PM.Project_Manager = @PM
							and PM.Project_ID=PSM.Project_ID
							And RM.Request_Status_ID in ('C')
							And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End					

				Else If(@Type='NP')
				Begin
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('PMA') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End
				
				Else If(@Type='PTBC')
				Begin
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('ACP','DLG') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End

					Else If(@Type='RP')
				Begin
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And PM.Reschedule = 1
						And RM.Request_Status_ID in ('PMA','ACP','DLG')
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End

				Else If(@Type='BP')
				Begin
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],
						--((CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)) + ':' + cast((((((DATEDIFF(MINUTE,AS_EDate,getdate()))/60) - ((DATEDIFF(MINUTE,AS_EDate,getdate()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,AS_EDate,getdate()))%60 as varchar(3)), 3))) As [Elapsed]
						(CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)))	 As [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('ACP','PMA','DLG') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End

				Else If(@Type='C')
				Begin 
					Select RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],convert(varchar(11),PSM.Close_Status_On,113) as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and RM.Request_ID = PSM.Request_ID
						and PM.Project_Manager = @PM
						and PM.Project_ID=PSM.Project_ID
						And RM.Request_Status_ID in ('C')
						And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End
			End	
		End
	End
	Else If(@Option=4) -- Performance report
	Begin
		If(@PM='')
		Begin
			Select PM, Emp_ID, SUM(NP) As NP, SUM(PTBC) As PTBC,  SUM(C) As C, 
					SUM(FP) AS FP, SUM(CP) AS CP,Sum(BP) As BP,SUM(RP) As RP, SUM(T) As T,
				(Case When T.Emp_ID<>'' Then (Select Count(Emp_ID) From Resource_Master Where Project_Manager=T.Emp_ID And Active_Status=1 And Role_ID in ('DVL','PL')) End) AS TR					
			From
			(
				Select PM, Emp_ID, NP, PTBC, BP, C, FP, CP, RP, T
				From
				(
					Select  PM,Emp_ID, SUM(NP) As NP, SUM(PTBC) As PTBC, SUM(C) As C,SUM(FP) As FP,SUM(CP) As CP,SUM(BP) As BP,SUM(RP) As RP, SUM(PTBC+BP+C+RP+FP+CP) As T
					From
					(
						Select distinct PM,Emp_ID,'0' As NP,'0' As PTBC,SUM(C) AS C,'0' As FP,'0' As CP,'0' As BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('C') Then Count(RM.Request_ID) Else '0' End ) As C
							From Request_Master RM, Project_Master PM, Resource_Master RSM,Project_Status_Master PSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID 
								And PSM.Request_ID = RM.Request_ID
								and (PSM.Close_Status_On is not NULL or PSM.Close_Status_On <> '')
								And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
								
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T  Group By  PM,Emp_ID

						UNION

						Select distinct PM,Emp_ID,'0' As NP,'0' As PTBC,'0' AS C,SUM(FP) AS FP, SUM(CP) As CP ,'0' As BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('FP') Then Count(RM.Request_ID) Else '0' End ) As FP,
								(CASE When RM.Request_Status_ID in ('CP') Then Count(RM.Request_ID) Else '0' End ) As CP
							From Request_Master RM, Project_Master PM, Resource_Master RSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID 
								And ((Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110)))
									OR (Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) = Convert(Varchar(12),Convert(Datetime,'1900-01-01 00:00:00.000'),110))
									)
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T  Group By  PM,Emp_ID

						UNION

						Select PM,Emp_ID,SUM(NP) AS NP, SUM(PTBC) AS PTBC,'0' As C,'0' As FP,'0' As CP, '0' As BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('PMA') Then Count(RM.Request_ID)Else '0' End ) As NP,
								(CASE When RM.Request_Status_ID in ('ACP','DLG') Then Count(RM.Request_ID) Else '0' End ) As PTBC
							From Request_Master RM, Project_Master PM, Resource_Master RSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID And PM.Reschedule = 0
								And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
								And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T Group By  PM,Emp_ID

						UNION

						Select PM,Emp_ID,'0' AS NP,'0' AS PTBC,'0' As C,'0' As FP,'0' As CP, '0' As BP,SUM(RP) As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('PMA','ACP','DLG') Then Count(RM.Request_ID)Else '0' End ) As RP
								
							From Request_Master RM, Project_Master PM, Resource_Master RSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID
								And PM.Reschedule = 1
								And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
								And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T Group By  PM,Emp_ID

						UNION

						Select distinct PM,Emp_ID,'0' As NP,'0' As PTBC,'0' As C,'0' As FP,'0' As CP,SUM(BP) AS BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM, Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('ACP','PMA','DLG') Then Count(RM.Request_ID)Else '0' End ) As BP
							From Request_Master RM, Project_Master PM, Resource_Master RSM 
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID And PM.Reschedule = 0
								And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), @FDate, 110))
								--And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T Group By  PM,Emp_ID
					) T
					Group By  PM,Emp_ID
				) T

				Union

				Select Emp_Name As PM, Emp_ID, '0' As NP, '0' As PTBC, '0' As C,'0' As FP,'0' As CP,'0' AS BP,'0' As RP, '0' As T
				From Resource_Master
				Where Active_Status=1 And Role_ID in ('SYA','PM')
			) T
			Group By  PM,Emp_ID

		End
		Else If(@PM<>'')
		Begin
			Select PM, Emp_ID, SUM(NP) As NP, SUM(PTBC) As PTBC,  SUM(C) As C, 
					SUM(FP) AS FP, SUM(CP) AS CP,Sum(BP) As BP,SUM(RP) As RP, SUM(T) As T,
				(Case When T.Emp_ID<>'' Then (Select Count(Emp_ID) From Resource_Master Where Project_Manager=T.Emp_ID And Active_Status=1 And Role_ID in ('DVL','PL')) End) AS TR					
			From
			(
				Select PM, Emp_ID, NP, PTBC, BP, C, FP, CP, RP, T
				From
				(
					Select  PM,Emp_ID, SUM(NP) As NP, SUM(PTBC) As PTBC, SUM(C) As C,SUM(FP) As FP,SUM(CP) As CP,SUM(BP) As BP,SUM(RP) As RP, SUM(PTBC+BP+C+RP+FP+CP) As T
					From
					(
						Select distinct PM,Emp_ID,'0' As NP,'0' As PTBC,SUM(C) AS C,'0' As FP,'0' As CP,'0' As BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('C') Then Count(RM.Request_ID) Else '0' End ) As C
							From Request_Master RM, Project_Master PM, Resource_Master RSM ,Project_Status_MAster PSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID  And PM.Project_manager=@PM
								And PSM.Request_ID = RM.Request_ID
								And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Varchar(12),Convert(Datetime,@FDate),110) 
									And Convert(Varchar(12),Convert(Datetime,@EDate),110)
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T  Group By  PM,Emp_ID

						UNION

						Select distinct PM,Emp_ID,'0' As NP,'0' As PTBC,'0' AS C,SUM(FP) AS FP, SUM(CP) As CP ,'0' As BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('FP') Then Count(RM.Request_ID) Else '0' End ) As FP,
								(CASE When RM.Request_Status_ID in ('CP') Then Count(RM.Request_ID) Else '0' End ) As CP
							From Request_Master RM, Project_Master PM, Resource_Master RSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
								And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T  Group By  PM,Emp_ID

						UNION

						Select PM,Emp_ID,SUM(NP) AS NP, SUM(PTBC) AS PTBC,'0' As C,'0' As FP,'0' As CP, '0' As BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('PMA') Then Count(RM.Request_ID)Else '0' End ) As NP,
								(CASE When RM.Request_Status_ID in ('ACP','DLG') Then Count(RM.Request_ID) Else '0' End ) As PTBC
							From Request_Master RM, Project_Master PM, Resource_Master RSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM And PM.Reschedule = 0
								And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
								And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T Group By  PM,Emp_ID
						
						UNION

						Select PM,Emp_ID,'0' AS NP, '0' AS PTBC,'0' As C,'0' As FP,'0' As CP, '0' As BP,SUM(RP) As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID,RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('PMA','ACP','DLG') Then Count(RM.Request_ID)Else '0' End ) As RP
								
							From Request_Master RM, Project_Master PM, Resource_Master RSM
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM
								And PM.Reschedule = 1
								And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) > Convert(Datetime,Convert(Varchar(12), getdate(), 110))
								And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T Group By  PM,Emp_ID
					
						UNION

						Select distinct PM,Emp_ID,'0' As NP,'0' As PTBC,'0' As C,'0' As FP,'0' As CP,SUM(BP) AS BP,'0' As RP
						From 
						(
							Select distinct RSM.Emp_Name As PM,Emp_ID, RM.Request_ID,
								(CASE When RM.Request_Status_ID in ('ACP','PMA','DLG') Then Count(RM.Request_ID)Else '0' End ) As BP
							From Request_Master RM, Project_Master PM, Resource_Master RSM 
							Where RM.Request_ID=PM.Request_ID And PM.Project_manager<>'' And PM.Project_Manager IS NOT NULL
								And PM.Project_manager=RSM.Emp_ID And PM.Project_manager=@PM And PM.Reschedule = 0
								And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), @FDate, 110))
								--And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
							Group By  RSM.Emp_Name,Emp_ID,RM.Request_Status_ID,RM.Request_ID
						) T 
						Group By  PM,Emp_ID
					) T
					Group By  PM, Emp_ID
				) T

				Union

				Select Emp_Name As PM, Emp_ID, '0' As NP, '0' As PTBC, '0' As C,'0' As FP,'0' As CP,'0' AS BP,'0' As RP, '0' As T
				From Resource_Master
				Where Active_Status=1 And Emp_ID=@PM And Role_ID in ('SYA','PM')
			) T
			Group By  PM,Emp_ID
		End	

	End
	Else If(@Option=5)
	Begin
		If(@PM <> '')
		Begin
				If(@Type='T')
				Begin
				
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],'' as [Elapsed],
						'False' As Feedback 
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
							And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
							and PM.Project_Manager = @PM
							And RM.Request_Status_ID in ('ACP','DLG') And PM.Reschedule = 0
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) >= Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
					
					UNION
			
						Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
							CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
							RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate],'' as [Elapsed],
							'False' As Feedback 
						From Request_Master RM, Project_Master PM, Resource_Master RSM, 
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
						Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
							And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
							and PM.Project_Manager = @PM
							And PM.Reschedule = 1
							And RM.Request_Status_ID in ('PMA','ACP','DLG')
							And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) >= Convert(Datetime,Convert(Varchar(12), getdate(), 110))
							And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
					
					UNION
					
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Prj_Cdate],
							--((CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)) + ':' + cast((((((DATEDIFF(MINUTE,AS_EDate,getdate()))/60) - ((DATEDIFF(MINUTE,AS_EDate,getdate()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,AS_EDate,getdate()))%60 as varchar(3)), 3))) As [Elapsed]
							(CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)))	 As [Elapsed], 
							'False' As Feedback 
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('ACP','PMA','DLG') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), @FDate, 110))
						--And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				
					UNION
						
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],convert(varchar(11),PSM.Close_Status_On,113) as [Project_CDate],'' as [Elapsed],
						'False' As Feedback 
					From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and RM.Request_ID = PSM.Request_ID
						and PM.Project_Manager = @PM
						and PM.Project_ID=PSM.Project_ID
						And RM.Request_Status_ID in ('C')
						And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
					
					Union

					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], 
						Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],ISNULL(convert(varchar(11),PSM.Close_Status_On,113),'') as [Project_CDate],'' as [Elapsed],
						'False' As Feedback 
					From Request_Master RM, Project_Master PM, Resource_Master RSM,Project_Status_Master PSM,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM and RM.Request_ID = PSM.Request_ID
						And RM.Request_Status_ID in ('FP')
						And ((Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110)))
							OR (Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) = Convert(Varchar(12),Convert(Datetime,'1900-01-01 00:00:00.000'),110))
							)

					Union

						Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
							CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
							RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], 
							Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],ISNULL(convert(varchar(11),PSM.Close_Status_On,113),'') as [Project_CDate],'' as [Elapsed], 
							'True' As Feedback 
						From Request_Master RM, Project_Master PM, Resource_Master RSM,Project_Status_Master PSM,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
						Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
							And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
							and PM.Project_Manager = @PM and RM.Request_ID = PSM.Request_ID
							And RM.Request_Status_ID in ('CP')
							And ((Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110)))
							OR (Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) = Convert(Varchar(12),Convert(Datetime,'1900-01-01 00:00:00.000'),110))
							)
				
				End					
				Else If(@Type='NP')
				Begin
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('PMA') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) >= Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End
				Else If(@Type='PTBC')
				Begin
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('ACP','DLG') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) >= Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						and Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End
				Else If(@Type='RP')
				Begin
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],'' as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And PM.Reschedule = 1
						And RM.Request_Status_ID in ('PMA','ACP','DLG')
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) >= Convert(Datetime,Convert(Varchar(12), getdate(), 110))
						and Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End
				Else If(@Type='BP')
				Begin
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],
						--((CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)) + ':' + cast((((((DATEDIFF(MINUTE,AS_EDate,getdate()))/60) - ((DATEDIFF(MINUTE,AS_EDate,getdate()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,AS_EDate,getdate()))%60 as varchar(3)), 3))) As [Elapsed]
						(CAST((DATEDIFF(MINUTE,AS_EDate,getdate())/(1440)) as varchar(3)))	 As [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, 
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM
						And RM.Request_Status_ID in ('ACP','PMA','DLG') And PM.Reschedule = 0
						And  Convert(Datetime,Convert(Varchar(12), PM.AS_EDate, 110)) < Convert(Datetime,Convert(Varchar(12), @FDate, 110))
						--And Convert(Varchar(12),PM.AS_EDate,110) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End
				Else If(@Type='C')
				Begin 
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],
						convert(varchar(11),PSM.Close_Status_On,113) as [Project_CDate]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
						(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and RM.Request_ID = PSM.Request_ID
						and PM.Project_Manager = @PM
						and PM.Project_ID=PSM.Project_ID
						And RM.Request_Status_ID in ('C')
						And Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110))
				End
				Else If(@Type='FP')
				Begin
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], 
						Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],
						ISNULL(convert(varchar(11),PSM.Close_Status_On,113),'') as [Project_CDate],'' as [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM and RM.Request_ID = PSM.Request_ID
						And RM.Request_Status_ID in ('FP')
						And ((Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110)))
							OR (Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) = Convert(Varchar(12),Convert(Datetime,'1900-01-01 00:00:00.000'),110))
							)
				End		
				Else If(@Type='CP')
				Begin
					Select Distinct RM.Request_Id, PM.Project_Name, Convert(varchar(12),RM.Request_Date,113) As [Request_Date],Convert(varchar(12),RM.Expected_EDate,113) as [Expected_EDate] , CM1.Emp_Name As [Requested_BY], Convert(varchar(12),RM.HOD_Approve_Date,113) as [HOD_Approve_Date], 
						CM2.Emp_Name As [HOD], Convert(varchar(12),RM.Admin_Approve_Date,113) as [Adm_App_Date],
						RSM.Emp_Name As [Project_Manager],  Convert(varchar(12),PM.AS_SDate ,113) as [StartDate], Convert(varchar(12),PM.AS_EDate ,113) as [Enddate],
						ISNULL(convert(varchar(11),PSM.Close_Status_On,113),'') as [Project_CDate],'' as [Elapsed]
					From Request_Master RM, Project_Master PM, Resource_Master RSM, Project_Status_Master PSM,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM1,
							(Select Emp_ID, Emp_Name From Client_Master Where Role_ID in ('PC','PO','AA','SYA','PM')) As CM2
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=RSM.Emp_ID
						And RM.Requested_By=CM1.Emp_ID And RM.Hod_Approve=CM2.Emp_ID 
						and PM.Project_Manager = @PM and RM.Request_ID = PSM.Request_ID
						And RM.Request_Status_ID in ('CP') and RM.Request_ID = PSM.Request_ID
						And ((Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) Between Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @FDate),110)) And Convert(Datetime,Convert(Varchar(12),Convert(DateTime, @EDate),110)))
							OR (Convert(Datetime,Convert(Varchar(12),PM.AS_SDate,110)) = Convert(Varchar(12),Convert(Datetime,'1900-01-01 00:00:00.000'),110))
							)
				End				
		End
	End
	Else IF(@Option=6)
	Begin
		Select Res, Emp_ID, TAT, TUT, Productivity, Flag 
		From
		(
			Select RES, EMP_ID, TAT, TUT, Productivity, 'A' AS Flag 
			From 
			(	
				Select Emp_Name As RES, Emp_ID, 
						(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
						(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
						(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
						When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
						Else 0 End) AS [Productivity]
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, 
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where TM.Assigned_To=	RSM.Emp_ID And TM.Request_ID=@Request_ID
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where TM.Assigned_To = RSM.Emp_ID And TM.Request_ID=@Request_ID
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PL','DVL') And RSM.Project_Manager=@PM  
						And Active_Status=1 
					Group By RSM.Emp_Name, RSM.Emp_ID

				) T
				Where TAT<>0
			) T

			Union 

			Select 'Total' AS Res, '' AS Emp_ID, 
				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
				(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
					When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
					Else 0 End) AS [Productivity],
				 'B' AS Flag 
			From
			(
				Select TAT, TUT, Productivity
				From 
				(
					Select SUM(TAT) AS TAT, SUM(TUT) AS TUT, 
							SUM(Productivity) AS Productivity
					From		
					(
						Select TAT, TUT,
							(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
								When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
								Else 0 End) AS [Productivity]
						From
						(
							Select  
								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
											Where TM.Assigned_To=	RSM.Emp_ID And TM.Request_ID=@Request_ID
									  ),0) As TAT,
								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
											Where TM.Assigned_To = RSM.Emp_ID And TM.Request_ID=@Request_ID
									  ),0) As TUT
							From Resource_Master RSM
							Where Role_ID in ('PL','DVL')  And RSM.Project_Manager=@PM
								And Active_Status=1 
							Group By Emp_ID
						) T
					) T	
				)T 
			)T
		) T
		Order By Flag
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_QUESTION_Operation
-- --------------------------------------------------








Create Proc [dbo].[USP_QUESTION_Operation]

@Request_ID as Char(20),
@Project_ID AS Char(20),
@Phase As Varchar(200),
@Param1 As Varchar(100),
@Param2 As Varchar(100),
@Param3 As Varchar(100),
@Param4 As Varchar(100),
@Param5 As Varchar(100),
@Param6 As Varchar(100),
@Param7 As Varchar(100),
@Param8 As Varchar(100),
@Param9 As Varchar(100),
@Param10 As Varchar(100),
@Param11 As Varchar(100),
@Param12 As Varchar(100),
@Param13 As Varchar(100),
@Param14 As Varchar(100),
@Param15 As Varchar(100),
@Date As Datetime, 
@File AS Varchar(300),
@Emp_ID As char(20),
@Role As Char(20),
@Option AS int

As
Begin

	If(@Option=1)
	Begin
		Select ROW_NUMBER() OVER (ORDER BY Qid) as [No], Qid,Question AS qust From Tbl_Question_Master
		Where UPPER(Phase) = UPPER(@Phase) 
	End
	Else If(@Option=2)
	Begin
		Set @Request_ID = (Select Request_ID From Project_Master Where Project_ID=@Project_ID)

		Insert Into Tbl_Checklist
		(Request_ID,Project_ID,Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8,Q9,Q10,Q11,Q12,Q13,Q14,Q15,Change_Date,Change_By)
		Values 
		(@Request_ID,@Project_ID,@Param1,@Param2,@Param3,@Param4,@Param5,@Param6,@Param7,@Param8,@Param9,@Param10,@Param11,@Param12,@Param13,@Param14,@Param15,getdate(),@Emp_ID)

		Declare @ID AS Int 
		Set @ID =( Select MAX(Check_ID) From Tbl_Checklist)

		Insert Into Tbl_Checklist_Details
		Select * From Tbl_Checklist Where Check_ID=@ID

		Select @ID
	End
	Else If(@Option=3)
	Begin

		Update Tbl_Checklist
		Set Q5=@Param5 , Q6=@Param6 , Q7=@Param7 
		Where Project_ID=@Project_ID
		
		Insert Into Tbl_Checklist_Details
		Select * From Tbl_Checklist Where Project_ID=@Project_ID

		Select @Project_ID

	End
	Else If(@Option=4)
	Begin

		Update Tbl_Checklist
		Set Q8=@Param8 , Q9=@Param9 , Q10=@Param10 , Q11=@Param11, Q12=@Param12 
		Where Project_ID=@Project_ID
		
		Insert Into Tbl_Checklist_Details
		Select * From Tbl_Checklist Where Project_ID=@Project_ID

		Select @Project_ID

	End
	Else If(@Option=5)
	Begin

		Update Tbl_Checklist
		Set Q13=@Param13 , Q14=@Param14 , Q15=@Param15 
		Where Project_ID=@Project_ID
		
		Insert Into Tbl_Checklist_Details
		Select * From Tbl_Checklist Where Project_ID=@Project_ID

		Select @Project_ID
	End
	Else If(@Option=6)
	Begin
		Select ROW_NUMBER() OVER (ORDER BY Qid) as [No], Qid,Question AS qust From Tbl_Question_Master
				
		Select Project_ID, Q1, Q2, Q3, Q4, Q5, Q6, Q7, Q8, Q9, Q10, Q11, Q12, Q13, Q14, Q15
		From Tbl_Checklist 
		Where Project_ID=@Project_ID

		Select TCL.Project_ID, TCLM.[File], '1' AS QID
		From Tbl_CheckList TCL, Tbl_ChekList_Upload_Master TCLM
		Where TCL.Project_ID=TCLM.Project_ID And TCLM.QID='1'
			And TCL.Q1='YES' And TCL.Project_ID=@Project_ID

		UNION

		Select TCL.Project_ID, TCLM.[File], '4' AS QID
		From Tbl_CheckList TCL, Tbl_ChekList_Upload_Master TCLM
		Where TCL.Project_ID=TCLM.Project_ID And TCLM.QID='4'
			And TCL.Q4='YES' And TCL.Project_ID=@Project_ID

		UNION

		Select TCL.Project_ID, TCLM.[File], '12' AS QID
		From Tbl_CheckList TCL, Tbl_ChekList_Upload_Master TCLM
		Where TCL.Project_ID=TCLM.Project_ID And TCLM.QID='12'
			And TCL.Q12='YES' And TCL.Project_ID=@Project_ID

		UNION

		Select TCL.Project_ID, TCLM.[File], '13' AS QID
		From Tbl_CheckList TCL, Tbl_ChekList_Upload_Master TCLM
		Where TCL.Project_ID=TCLM.Project_ID And TCLM.QID='14'
		And TCL.Q13='YES' And TCL.Project_ID=@Project_ID
	
	End
	Else If(@Option=7)
	Begin

		Update Tbl_Checklist
		Set Q1=@Param1 , Q2=@Param2 , Q3=@Param3 ,Q4=@Param4 , Q5=@Param5, Q6=@Param6,
			Q7=@Param7 , Q8=@Param8 , Q9=@Param9 ,Q10=@Param10 , Q11=@Param11,
			Q12=@Param12 , Q13=@Param13 , Q14=@Param14 , Q15 = @Param15
		Where Project_ID=@Project_ID
		
		Insert Into Tbl_Checklist_Details
		Select * From Tbl_Checklist Where Project_ID=@Project_ID

		Select @Project_ID
	End
	Else If(@Option=8)
	Begin
		Select ROW_NUMBER() OVER (ORDER BY Qid) as [No], Qid,Question AS qust From Tbl_Question_Master
	End
	Else If(@Option=9)
	Begin
		Set @Request_ID = (Select QID From Tbl_Question_Master Where Convert(INT,srno) = Convert(INT,@Request_ID) And rtrim(phase)=rtrim(@Phase))

		Insert Into Tbl_ChekList_Upload_Master
		Values (@Project_ID, rtrim(@Phase), @Request_ID, rtrim(@File))


	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Reports
-- --------------------------------------------------





-- =============================================      
-- Author:  Kapil Desai      
-- Create date: 02-Apr-2010      
-- Description: TMS Reports      
-- =============================================      
CREATE PROCEDURE [dbo].[usp_Reports] 
(      
 @Option char(5),      
 @RequestID varchar(25),      
 @ProjectName varchar(25),      
 @RequestedBy varchar(25),      
 @Status varchar(25),      
 @FromDate varchar(25),      
 @ToDate varchar(25),
 @EmpID Char(10)
     
)      
AS      
BEGIN      
 declare @Query varchar(max)        
 If(@Option='C')        
 Begin      
  set @Query =' Select [RequestID],[Project Name],[Audience],Emp_Name As [Request_By], [Requested Date],[Expected End Date], [Priority], [Status]      
    From      
    (      
    Select Distinct T.Request_ID As [RequestID], T.Project_Name As [Project Name], T.Emp_ID As [Request_By],T.Emp_Name,      
      T.Request_Date As [Requested Date], T.Expected_EDate As [Expected End Date],T.Priority_Name As Priority,      
      T.Brief_Requirement As [Brief Req], T.HOD_Name As [HOD],T.HOD_Remark As [HOD Remark],T.Audience As [Audience],      
      RSM.Request_Status_Name As [Status]   
    From      
    (      
     Select Request_Master.Request_ID , Request_Master.Project_Name, Client_Master.Emp_ID,Client_Master.Emp_Name,      
        LEFT(Request_Master.Request_Date,11) As Request_Date, LEFT(Request_Master.Expected_EDate,11) As Expected_EDate,      
        Request_Priority_Master.Priority_Name, Request_Master.Brief_Requirement, isnull(CM1.Emp_Name, '''') as HOD_Name ,      
        Request_Master.HOD_Remark, Request_Master.Audience ,  Request_Status_Master.Request_Status_ID      
      From Request_Master      
      Join Client_Master On Request_Master.Requested_By = Client_Master.Emp_ID       
      Join Request_Priority_Master On Request_Master.Priority_ID = Request_Priority_Master.Priority_ID      
      Join Request_Status_Master On Request_Master.Request_Status_ID = Request_Status_Master.Request_Status_ID      
      Left Join Project_Master On rtrim(Request_Master.Project_Name)=rtrim(Project_Master.Project_Name)       
   left join Client_Master CM1 on CM1.Emp_ID = Request_Master.HOD_Approve  
    ) T , Request_Master RM , Client_Master CM, Request_Status_Master RSM      
    Where CM.Emp_ID=RM.Requested_BY and T.Emp_ID=CM.Emp_ID and T.Request_Status_ID=RSM.Request_Status_ID'      
  End      
      
 If(@Option='PO')        
 Begin      
  set @Query =' Select [RequestID],[Project Name],[Audience],Emp_Name As [Request_By], [Requested Date],[Expected End Date], [Priority], [Status]      
    From      
    (      
    Select Distinct T.Request_ID As [RequestID], T.Project_Name As [Project Name], T.Emp_ID As [Request_By],T.Emp_Name,      
      T.Request_Date As [Requested Date], T.Expected_EDate As [Expected End Date],T.Priority_Name As Priority,      
      T.Brief_Requirement As [Brief Req], T.HOD_Name As [HOD],T.HOD_Remark As [HOD Remark],T.Audience As [Audience],      
      RSM.Request_Status_Name As [Status]      
    From      
    (      
     Select Request_Master.Request_ID , Request_Master.Project_Name, Client_Master.Emp_ID,Client_Master.Emp_Name,      
        LEFT(Request_Master.Request_Date,11) As Request_Date, LEFT(Request_Master.Expected_EDate,11) As Expected_EDate,      
        Request_Priority_Master.Priority_Name, Request_Master.Brief_Requirement, isnull(CM1.Emp_Name, '''') as HOD_Name ,      
        Request_Master.HOD_Remark, Request_Master.Audience ,  Request_Status_Master.Request_Status_ID      
      From Request_Master with (nolock)   
      Join Client_Master with (nolock) On Request_Master.Requested_By = Client_Master.Emp_ID       
      Join Request_Priority_Master with (nolock) On Request_Master.Priority_ID = Request_Priority_Master.Priority_ID      
      Join Request_Status_Master with (nolock) On Request_Master.Request_Status_ID = Request_Status_Master.Request_Status_ID      
      Left Join Project_Master with (nolock) On rtrim(Request_Master.Project_Name)=rtrim(Project_Master.Project_Name)       
      left join Client_Master CM1 with (nolock) on CM1.Emp_ID = Request_Master.HOD_Approve  
    ) T , Request_Master RM , Client_Master CM, Request_Status_Master RSM      
    Where CM.Emp_ID=RM.Requested_BY and T.Emp_ID=CM.Emp_ID and T.Request_Status_ID=RSM.Request_Status_ID'      
  End      
      
  if(@Status <> '' AND @Status<>'---SELECT---')        
  Begin        
   Set @Query=@Query + ' and T.Request_Status_ID ='''+ @Status + ''''         
  End      
        
  If(@FromDate <> '' and @ToDate <> '')      
  Begin        
   --Set @Query=@Query + ' and LEFT(RM.Request_Date,11) between LEFT(Convert(Datetime, ''' + @FromDate + ''') ) and cast(''' + @ToDate +''' )'        
      
  Set @Query=@Query + ' and LEFT(T.Request_Date,11) between Convert(Datetime, ''' + @FromDate + ''',101) and Convert(Datetime, ''' + @ToDate + ''',101)'      
  End         
      
  If (@ProjectName <> '' AND @ProjectName<>'---SELECT---')      
  Begin        
   set @Query=@Query + ' and T.Project_Name =''' + @ProjectName + ''''        
  End         
      
 
      
 If (@RequestID <> '' AND @RequestID<>'---SELECT---' )      
  Begin        
   set @Query=@Query + ' and T.Request_ID =''' + @RequestID + ''''        
  End       
If (@RequestedBy <> '' AND @RequestedBy<>'---SELECT---')      
  Begin        
	If(@Option='C')      
	Begin
		Set @Query=@Query + ' and T.Emp_ID =''' + @EmpID + ''''        
	End
	Else If(@Option='PO')      
		if(@EmpID<>''AND @EmpID<>'---SELECT---' and (@FromDate <> '' and @ToDate <> ''))
		Begin	
			Set	@Query = @Query + ' or T.Emp_ID=''' + @EmpID + ''''
		End
		else If(@EmpID<>''AND @EmpID<>'---SELECT---' and (@FromDate = '' and @ToDate = ''))
		Begin
			If(@RequestedBy <>'---SELECT---' and @RequestedBy <>'')
			Begin
				Set	@Query = @Query + ' and T.Emp_ID=''' + @EmpID + ''''
			End
			Else If(@RequestedBy ='---SELECT---')
			Begin
				Set	@Query = @Query + ' and T.Emp_ID in (Select Emp_ID From Client_Master Where HOD=''' + @EmpID + ''' Union Select ''' + @EmpID+ ''')'
			End
		End
--		Else If (@EMPID='')
--		Begin
--			Set @Query=@Query + ' and T.Emp_ID in ((Select Emp_ID From Client_Master Where HOD=''' + @RequestedBy + ''') Union Select '''+ @RequestedBy + ''')'       
--		End
	End       
       
 SET @Query = @Query + ') T order by [RequestID],[Project Name],[Audience], [Request_By], [Requested Date],[Expected End Date], [Priority], [Status]'        
END      
 print @Query        
 exec (@Query)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Reports_new
-- --------------------------------------------------








-- =============================================      
-- Author:  Kapil Desai      
-- Create date: 02-Apr-2010      
-- Description: TMS Reports      
-- =============================================      
CREATE PROCEDURE [dbo].[usp_Reports_new] 
(      
 @Option char(5),      
 @RequestID varchar(25),      
 @ProjectName varchar(25),      
 @RequestedBy varchar(25),      
 @Status varchar(25),      
 @FromDate varchar(25),      
 @ToDate varchar(25),
 @EmpID Char(10)
     
)      
AS      
BEGIN      
 declare @Query varchar(max)        
 If(@Option='C')        
 Begin      
  set @Query =' Select [RequestID],[Project Name],[Audience],Emp_Name As [Request_By], [Requested Date],
			[Expected End Date],[HOD Remark],[Admin Remark],[Priority], [Status]      
    From      
    (      
    Select Distinct T.Request_ID As [RequestID], T.Project_Name As [Project Name], T.Emp_ID As [Request_By],T.Emp_Name,      
      T.Request_Date As [Requested Date], T.Expected_EDate As [Expected End Date],T.Priority_Name As Priority,      
      T.Brief_Requirement As [Brief Req], T.HOD_Name As [HOD],T.HOD_Remark As [HOD Remark],
		T.Admin_Remark As [Admin Remark],T.Audience As [Audience],RSM.Request_Status_Name As [Status]   
    From      
    (      
     Select Request_Master.Request_ID , Request_Master.Project_Name, Client_Master.Emp_ID,Client_Master.Emp_Name,      
        LEFT(Request_Master.Request_Date,11) As Request_Date, LEFT(Request_Master.Expected_EDate,11) As Expected_EDate,      
        Request_Priority_Master.Priority_Name, Request_Master.Brief_Requirement, isnull(CM1.Emp_Name, '''') as HOD_Name ,      
        Request_Master.HOD_Remark,Request_Master.Admin_Remark, Request_Master.Audience ,  Request_Status_Master.Request_Status_ID      
      From Request_Master      
      Join Client_Master On Request_Master.Requested_By = Client_Master.Emp_ID       
      Join Request_Priority_Master On Request_Master.Priority_ID = Request_Priority_Master.Priority_ID      
      Join Request_Status_Master On Request_Master.Request_Status_ID = Request_Status_Master.Request_Status_ID      
      Left Join Project_Master On rtrim(Request_Master.Project_Name)=rtrim(Project_Master.Project_Name)       
   left join Client_Master CM1 on CM1.Emp_ID = Request_Master.HOD_Approve  
    ) T , Request_Master RM , Client_Master CM, Request_Status_Master RSM      
    Where CM.Emp_ID=RM.Requested_BY and T.Emp_ID=CM.Emp_ID and T.Request_Status_ID=RSM.Request_Status_ID'      
  End      
      
 If(@Option='PO')        
 Begin      
  set @Query =' Select [RequestID],[Project Name],[Audience],Emp_Name As [Request_By], [Requested Date],
		[Expected End Date],[HOD Remark],[Admin Remark], [Priority], [Status]      
    From      
    (      
    Select Distinct T.Request_ID As [RequestID], T.Project_Name As [Project Name], T.Emp_ID As [Request_By],T.Emp_Name,      
      T.Request_Date As [Requested Date], T.Expected_EDate As [Expected End Date],T.Priority_Name As Priority,      
      T.Brief_Requirement As [Brief Req], T.HOD_Name As [HOD],T.HOD_Remark As [HOD Remark],
		T.Admin_Remark As [Admin Remark], T.Audience As [Audience],
      RSM.Request_Status_Name As [Status]      
    From      
    (      
     Select Request_Master.Request_ID , Request_Master.Project_Name, Client_Master.Emp_ID,Client_Master.Emp_Name,      
        LEFT(Request_Master.Request_Date,11) As Request_Date, LEFT(Request_Master.Expected_EDate,11) As Expected_EDate,      
        Request_Priority_Master.Priority_Name, Request_Master.Brief_Requirement, isnull(CM1.Emp_Name, '''') as HOD_Name ,      
        Request_Master.HOD_Remark,Request_Master.Admin_Remark, Request_Master.Audience ,  Request_Status_Master.Request_Status_ID      
      From Request_Master      
      Join Client_Master On Request_Master.Requested_By = Client_Master.Emp_ID       
      Join Request_Priority_Master On Request_Master.Priority_ID = Request_Priority_Master.Priority_ID      
      Join Request_Status_Master On Request_Master.Request_Status_ID = Request_Status_Master.Request_Status_ID      
      Left Join Project_Master On rtrim(Request_Master.Project_Name)=rtrim(Project_Master.Project_Name)       
      left join Client_Master CM1 on CM1.Emp_ID = Request_Master.HOD_Approve  
    ) T , Request_Master RM , Client_Master CM, Request_Status_Master RSM      
    Where CM.Emp_ID=RM.Requested_BY and T.Emp_ID=CM.Emp_ID and T.Request_Status_ID=RSM.Request_Status_ID'      
  End      
      
  if(@Status <> '' AND @Status<>'---SELECT---')        
  Begin        
   Set @Query=@Query + ' and T.Request_Status_ID ='''+ @Status + ''''         
  End      
        
  If(@FromDate <> '' and @ToDate <> '')      
  Begin        
   --Set @Query=@Query + ' and LEFT(RM.Request_Date,11) between LEFT(Convert(Datetime, ''' + @FromDate + ''') ) and cast(''' + @ToDate +''' )'        
      
  Set @Query=@Query + ' and LEFT(T.Request_Date,11) between Convert(Datetime, ''' + @FromDate + ''',101) and Convert(Datetime, ''' + @ToDate + ''',101)'      
  End         
      
  If (@ProjectName <> '' AND @ProjectName<>'---SELECT---')      
  Begin        
   set @Query=@Query + ' and T.Project_Name =''' + @ProjectName + ''''        
  End         
      
 
      
 If (@RequestID <> '' AND @RequestID<>'---SELECT---' )      
  Begin        
   set @Query=@Query + ' and T.Request_ID =''' + @RequestID + ''''        
  End       
If (@RequestedBy <> '' AND @RequestedBy<>'---SELECT---')      
  Begin        
	If(@Option='C')      
	Begin
		Set @Query=@Query + ' and T.Emp_ID =''' + @EmpID + ''''        
	End
	Else If(@Option='PO')      
		if(@EmpID<>''AND @EmpID<>'---SELECT---' and (@FromDate <> '' and @ToDate <> ''))
		Begin	
			Set	@Query = @Query + ' or T.Emp_ID=''' + @EmpID + ''''
		End
		else If(@EmpID<>''AND @EmpID<>'---SELECT---' and (@FromDate = '' and @ToDate = ''))
		Begin
			Set	@Query = @Query + ' and T.Emp_ID in (Select Emp_ID From Client_Master Where HOD=''' + @EmpID + ''' Union Select ''' + @EmpID+ ''')'
		End
--		Else If (@EMPID='')
--		Begin
--			Set @Query=@Query + ' and T.Emp_ID in ((Select Emp_ID From Client_Master Where HOD=''' + @RequestedBy + ''') Union Select '''+ @RequestedBy + ''')'       
--		End
	End       
       
 SET @Query = @Query + ') T order by [RequestID],[Project Name],[Audience], [Request_By], [Requested Date],[Expected End Date], [Priority], [Status]'        
END      
 print @Query        
 exec (@Query)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Request_Details
-- --------------------------------------------------




CREATE Procedure [dbo].[usp_Request_Details] -- '1001'

@ID varchar(20),
@Option Char(5)

As
Begin

	If(@Option='1')
	Begin
		Select Request_ID,Project_Name As [Project name] , Actor,[Role], Request_Date, Remark, Status, Time_Taken
		From 
		(
			Select Request_ID,Project_Name, Client_Master.Emp_Name as Actor, Role_Master.Role_Name as [Role],
				Request_Date,'' as Remark,Request_Status_Master.Request_Status_Name as Status,
				convert(varchar,isnull(datediff(minute,Request_Date ,Request_Date),0)/60/24) +' Days ' + convert(varchar,isnull(datediff(minute,Request_Date ,Request_Date),0)/60 - (isnull(datediff(minute,Request_Date ,Request_Date),0)/60/24)*24) + ' Hrs' As Time_Taken
			From Request_Details
				inner join Client_Master on Client_Master.Emp_ID = Request_Details.Requested_By
				inner join Role_Master on Role_Master.Role_ID = Client_Master.Role_ID
				inner join Request_Status_Master on Request_Status_Master.Request_Status_ID = Request_Details.Request_Status_ID
			Where Request_Details.Request_Status_ID = 'PBH'
				and Request_ID = @ID
			
			Union 

			Select Request_ID,Project_Name, Client_Master.Emp_Name as Actor, Role_Master.Role_Name as [Role], 
				HOD_Approve_Date as Request_Date, HOD_Remark as Remark, 
				Request_Status_Master.Request_Status_Name as Status,
				convert(varchar,isnull(datediff(minute,Request_Date ,HOD_Approve_Date),0)/60/24) +' Days ' + convert(varchar,isnull(datediff(minute,Request_Date ,HOD_Approve_Date),0)/60 - (isnull(datediff(minute,Request_Date ,HOD_Approve_Date),0)/60/24)*24) + ' Hrs' As Time_Taken
			From Request_Details
				inner join Client_Master on Client_Master.Emp_ID = Request_Details.HOD_Approve
				inner join Role_Master on Role_Master.Role_ID = Client_Master.Role_ID
				inner join Request_Status_Master on Request_Status_Master.Request_Status_ID = Request_Details.Request_Status_ID
			Where Request_Details.Request_Status_ID in ('PBA','RBH','NCFH')
				and Request_ID = @ID

			Union

			Select Request_ID,Project_Name, Client_Master.Emp_Name as Actor, Role_Master.Role_Name as [Role],
				 Admin_Approve_Date as Request_Date, Admin_Remark as Remark, 
				Request_Status_Master.Request_Status_Name as Status,
				convert(varchar,isnull(datediff(minute,HOD_Approve_Date ,Admin_Approve_Date),0)/60/24) +' Days ' + convert(varchar,isnull(datediff(minute,HOD_Approve_Date ,Admin_Approve_Date),0)/60 - (isnull(datediff(minute,HOD_Approve_Date ,Admin_Approve_Date),0)/60/24)*24) + ' Hrs' As Time_Taken

			From Request_Details
				inner join Client_Master on Client_Master.Emp_ID = Request_Details.Admin_Approve
				inner join Role_Master on Role_Master.Role_ID = Client_Master.Role_ID
				inner join Request_Status_Master on Request_Status_Master.Request_Status_ID = Request_Details.Request_Status_ID
			Where Request_Details.Request_Status_ID in ('ABA','RBA','NCFA')
				and Request_ID = @ID
		)T Order by Request_Date
	End
	
	Else If(@Option='2')
	Begin
		Select Change_ID, Project_Name As [Project name] , Actor,[Role], Changed_Date, Remark, Status,Time_Taken
		From 
		(
			Select Change_ID,Project_Name,Client_Master.Emp_Name as Actor, Role_Master.Role_Name as [Role],Changed_Date,'' as Remark, Request_Status_Master.Request_Status_Name as Status,
			convert(varchar,isnull(datediff(minute,Changed_Date ,Changed_Date),0)/60/24) +' Days ' + convert(varchar,isnull(datediff(minute,Changed_Date ,Changed_Date),0)/60 - (isnull(datediff(minute,Changed_Date ,Changed_Date),0)/60/24)*24) + ' Hrs' As Time_Taken

			From Change_Request_Details
				inner join Client_Master on Change_Request_Details.Changed_By = Client_Master.Emp_ID
				inner join Role_Master on Role_Master.Role_ID = Client_Master.Role_ID
				inner join Request_Status_Master on Request_Status_Master.Request_Status_ID = Change_Request_Details.Request_Status_ID		
				join project_master on Change_Request_Details.request_ID=project_master.Request_ID
			Where Change_Request_Details.Request_Status_ID = 'PBH'
				and Change_ID = @ID
			
			Union 

			Select Change_ID,Project_Name, Client_Master.Emp_Name as Actor, Role_Master.Role_Name as [Role], HOD_Approve_Date as Changed_Date, HOD_Remark as Remark, Request_Status_Master.Request_Status_Name as Status,
				convert(varchar,isnull(datediff(minute,Changed_Date ,HOD_Approve_Date),0)/60/24) +' Days ' + convert(varchar,isnull(datediff(minute,Changed_Date ,HOD_Approve_Date),0)/60 - (isnull(datediff(minute,Changed_Date ,HOD_Approve_Date),0)/60/24)*24) + ' Hrs' As Time_Taken

			From Change_Request_Details
				inner join Client_Master on Client_Master.Emp_ID = Change_Request_Details.HOD_Approve
				inner join Role_Master on Role_Master.Role_ID = Client_Master.Role_ID
				inner join Request_Status_Master on Request_Status_Master.Request_Status_ID = Change_Request_Details.Request_Status_ID
				join project_master on Change_Request_Details.request_ID=project_master.Request_ID
			Where Change_Request_Details.Request_Status_ID in ('PBA','RBH','NCFH')
				and Change_ID = @ID

			Union

			Select Change_ID,Project_Name, Client_Master.Emp_Name as Actor, Role_Master.Role_Name as [Role], Admin_Approve_Date as Changed_Date, Admin_Remark as Remark, Request_Status_Master.Request_Status_Name as Status,
			convert(varchar,isnull(datediff(minute,HOD_Approve_Date ,Admin_Approve_Date),0)/60/24) +' Days ' + convert(varchar,isnull(datediff(minute,HOD_Approve_Date ,Admin_Approve_Date),0)/60 - (isnull(datediff(minute,HOD_Approve_Date ,Admin_Approve_Date),0)/60/24)*24) + ' Hrs' As Time_Taken

			From Change_Request_Details
				inner join Client_Master on Client_Master.Emp_ID = Change_Request_Details.Admin_Approve
				inner join Role_Master on Role_Master.Role_ID = Client_Master.Role_ID
				inner join Request_Status_Master on Request_Status_Master.Request_Status_ID = Change_Request_Details.Request_Status_ID
				join project_master on Change_Request_Details.request_ID=project_master.Request_ID
			Where Change_Request_Details.Request_Status_ID in ('ABA','RBA','NCFA')
				and Change_ID = @ID

		)T Order by Changed_Date
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Request_Opeartion_New
-- --------------------------------------------------


CREATE PROC USP_Request_Opeartion_New

@Type As Varchar(100),
@Status As Varchar(20),
@Emp_ID As Varchar(20),
@Role As Varchar(20),
@Option As int

As 
Begin
	If(@Option=1) -- Software Home - all Project - Department wise - New Request Count
	Begin
		if(@Status='NR1')
		Begin
			Select Distinct RM.Request_ID, RM.Project_Name As Project,
				RM.Priority_ID ,CM.Emp_Name As Requested_BY,
				CONVERT(Varchar(11),RM.Request_Date,103) As RSDate,
				CONVERT(Varchar(11),RM.Expected_EDate,103) As REDate, 
				Approved_BY=(case When RM.HOD_Approve<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve) Else '' End),
				Convert(Varchar,RM.HOD_Approve_Date,103) AS Approved_Date,
				RSM.Request_Status_Name As Status
			From Request_Master RM 
				inner  Join Client_Master CM on CM.Emp_ID=RM.Requested_By
				inner join Request_Status_Master RSM on RM.Request_Status_ID=RSM.Request_Status_ID
			Where
				RM.Request_Status_ID in ('PBH','PBA','NCFH','NCFH','ABA') And
				RM.Requested_BY in (Select Emp_ID From Client_Master Where Upper(Department)=Upper(rtrim(@Type)))
			Order By RM.Request_ID
		End
		Else If(@Status='WIP1')
		Begin
			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, CONVERT(Varchar(11),PM.AS_SDate,103) As StartDate,
				 CONVERT(Varchar(11),PM.AS_EDate,103) As EndDate, CM.Emp_Name As Manager,
				 Leader=Isnull(Case When PM.Project_Leader<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=PM.Project_Leader) End, ''),
				Owner=Isnull(Case When Com.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM.Employee_ID) End, ''),
				Coordinator1=Isnull(Case When COM1.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM1.Employee_ID) End, ''),
				'' As Coordinator2
				--Coordinator2=COM2.Employee_ID
			From Request_Master RM 
				inner join Project_Master PM on RM.Request_ID=PM.Request_ID  
				inner  Join Client_Master CM on CM.Emp_ID=PM.Project_Manager
				inner Join Coordinator_Master COM on PM.Project_ID= COM.Project_ID 
					And COM.Role_ID in ('PO','AA','SYA')
				inner Join Coordinator_Master COM1 on PM.Project_ID= COM1.Project_ID 
					And COM1.Role_ID in ('PC','AA','SYA') And RM.Requested_BY=COM1.Employee_ID
			Where
				RM.Request_Status_ID in ('PMA','DLG') And
				RM.Requested_BY in (Select Emp_ID From Client_Master Where Upper(Department)=Upper(rtrim(@Type)))
			Order By RM.Request_ID
		End
		Else If(@Status='C1')
		Begin
			Select Distinct RM.Request_ID, PM.Project_Name As Project,PM.Priority, CONVERT(Varchar(11),PM.AS_SDate,103) As StartDate,
				 CONVERT(Varchar(11),PM.AS_EDate,103) As EndDate, CM.Emp_Name As Manager,
				 Leader=Isnull(Case When PM.Project_Leader<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=PM.Project_Leader) End, ''),
				Owner=Isnull(Case When Com.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM.Employee_ID) End, ''),
				Coordinator1=Isnull(Case When COM1.Employee_ID<>'' Then (Select Emp_Name From Client_Master Where Emp_ID=COM1.Employee_ID) End, ''),
				'' As Coordinator2
				--Coordinator2=COM2.Employee_ID
			From Request_Master RM 
				inner join Project_Master PM on RM.Request_ID=PM.Request_ID  
				inner  Join Client_Master CM on CM.Emp_ID=PM.Project_Manager
				inner Join Coordinator_Master COM on PM.Project_ID= COM.Project_ID 
					And COM.Role_ID in ('PO','AA','SYA')
				inner Join Coordinator_Master COM1 on PM.Project_ID= COM1.Project_ID 
					And COM1.Role_ID in ('PC','AA','SYA') And RM.Requested_BY=COM1.Employee_ID
			Where
				RM.Request_Status_ID in ('C') And
				RM.Requested_BY in (Select Emp_ID From Client_Master Where Upper(Department)=Upper(rtrim(@Type)))
			Order By RM.Request_ID
		End
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Request_Operation
-- --------------------------------------------------














CREATE Proc [dbo].[USP_Request_Operation]    
    
@Request_ID Char(20),    
@Project_Name Varchar(100),    
@Requested_By Char(20),    
@Requested_Date Datetime,    
@Expected_EDate Datetime,    
@Priority_ID Char(20),    
@Brief_Requirement Varchar(1000),    
@BR_Attachment Varchar(200),    
@Business_Needs Varchar(1000),    
@BN_Attachment Varchar(200),    
@Current_Process Varchar(1000),    
@CP_Attachment Varchar(200),    
@HOD_Approve Char(20),    
@HOD_Approve_Date Datetime,    
@HOD_Remark Varchar(200),    
@Admin_Approve Char(20),    
@Admin_Approve_Date Datetime,    
@Admin_Remark Varchar(200),    
@Audience Varchar(100),    
@Request_Status_ID Char(20),    
@Role_ID Char(20),    
@Option Char(5)    
    
As    
    
Begin    
    
	If(@Option='1')    
	Begin    
    
		If(@Role_ID='PC')    
		Begin    
			Select Distinct RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
				RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
				RM.HOD_Approve,  Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
				RM.Audience, 
				ISNULL(CASE When RSM.Request_Status_ID in ('PBH','NCFH','PBA','NCFA','ABA','PFT','PFU','UC') Then RSM.Request_Status_Name When RSM.Request_Status_ID in ('PMA') Then 'Request Delegate' When RSM.Request_Status_ID in ('ACP','DLG') Then 'Work In Progress' End,0) As [Request_Status_Name]
			From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM,Coordinator_Master COM 
			Where RM.Requested_By=CM.Emp_ID 
				and RM.Request_Status_ID=RSM.Request_Status_ID    
				and RM.Priority_ID=RPM.Priority_ID 
				and (RM.Requested_By=@Requested_By or (COM.Employee_ID = @Requested_By and RM.Request_ID = COM.Request_ID))
				and RM.Request_Status_ID not in ('RBH','RBA','C') 
			Order By Request_Date DESC
				   
		End    
		Else     
		Begin    
			Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
				RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
				RM.HOD_Approve, Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
				RM.Audience, 
				ISNULL(CASE When RSM.Request_Status_ID in ('PBH','NCFH','PBA','NCFA','ABA','PFT','PFU','UC') Then RSM.Request_Status_Name When RSM.Request_Status_ID in ('PMA') Then 'Request Delegate' When RSM.Request_Status_ID in ('ACP','DLG') Then 'Work In Progress' End,0) As [Request_Status_Name]
			From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM
			Where RM.Requested_By=CM.Emp_ID 
				and RM.Request_Status_ID=RSM.Request_Status_ID    
				and RM.Priority_ID=RPM.Priority_ID    
				And 
				--RM.Requested_By in (Select Emp_ID From Client_Master Where HOD=@Requested_By Union Select @Requested_BY)
				(RM.Requested_By in (Select Emp_ID From Client_Master Where HOD=@Requested_BY Union Select @Requested_BY)
				or RM.Requested_By in (Select distinct Employee_ID From Coordinator_master where Project_ID in (Select Project_ID From Coordinator_master where Employee_ID=@Requested_BY)) )
				and RM.Request_Status_ID not in ('RBH','RBA','C') 
			Order By Request_Date DESC
		End    
	End    
	Else If(@Option='2') -- pending By HOD    
	Begin    
		Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
		    RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
			RM.HOD_Approve, Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
		    RM.Audience, RSM.Request_Status_Name    
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM
		Where RM.Requested_By=CM.Emp_ID 
		    and RM.Requested_By in (Select Emp_ID From Client_Master Where HOD=@HOD_Approve)
			and RM.Request_Status_ID=RSM.Request_Status_ID    
			and RM.Priority_ID=RPM.Priority_ID    
			and RM.Request_Status_ID in ('PBH','NCFH')
		Order By Request_Date DESC
	End    
	Else If(@Option='3') --pending by admin    
	Begin    
		If(@Role_ID='PM')
		Begin
			Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
				RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
				--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
				Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
				RM.Audience, RSM.Request_Status_Name    
			From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
			Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master)    
				and RM.Request_Status_ID=RSM.Request_Status_ID    
				and RM.Priority_ID=RPM.Priority_ID    
				and RM.Request_Status_ID in ('PBA','NCFA')
			Order By Request_Date 
		End
		Else If(@Role_ID='SYA')		
		Begin
			Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
				RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
				--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
				Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
				RM.Audience, RSM.Request_Status_Name    
			From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
			Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('PC','PO','AA','SYA'))    
				and RM.Request_Status_ID=RSM.Request_Status_ID    
				and RM.Priority_ID=RPM.Priority_ID 
				and RM.Request_Status_ID in ('PBA','NCFA','ABA','PMA','ACP','DLG','OHD','RBP') 
			Order By Request_Date 
		End
		Else If(@Role_ID='AA')		
		Begin
			Select Request_ID, Project_Name, [Requested_By], Request_Date, Expected_EDate,Priority,
				Brief_Requirement, BR_Attachment, Business_Needs, BN_Attachment, Current_Process,
				CP_Attachment, HOD, [HOD_Approve_Date], [HOD_Remark], Admin_Approve, Admin_Approve_Date, 
				Admin_Remark, Audience, Request_Status_Name
			From
			(
				Select distinct RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], 
					Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
					RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,  
					(Case When (RM.HOD_Approve=CM1.Emp_Id And RM.HOD_Approve IS NOT NULL) Then CM1.Emp_Name When RM.HOD_Approve='' Then '' End) As HOD,
					(Case When (RM.HOD_Approve_Date <> '' And RM.HOD_Approve_Date <> '1900-01-01 00:00:00')  Then Convert(varchar(12), RM.HOD_Approve_Date,113) 
						When (RM.HOD_Approve_Date='' or  RM.HOD_Approve_Date <> '1900-01-01 00:00:00') Then '' End) as [HOD_Approve_Date], 
					(Case When RM.HOD_Remark<> '' Then RM.HOD_Remark When RM.HOD_Remark='' Then '' End) As [HOD_Remark],
					RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
					RM.Audience, RSM.Request_Status_Name    
				From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM  , Client_Master CM1  
				Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA'))    
					and RM.Request_Status_ID=RSM.Request_Status_ID    
					and RM.Priority_ID=RPM.Priority_ID 
					and RM.Request_Status_ID=@Request_Status_ID
				
				Union

				Select distinct RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], 
					Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
					RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,  
					(Case When (RM.HOD_Approve=CM1.Emp_Id And RM.HOD_Approve IS NOT NULL) Then CM1.Emp_Name When RM.HOD_Approve='' Then '' End) As HOD,
					(Case When (RM.HOD_Approve_Date <> '' And RM.HOD_Approve_Date <> '1900-01-01 00:00:00')  Then Convert(varchar(12), RM.HOD_Approve_Date,113) 
						When (RM.HOD_Approve_Date='' or  RM.HOD_Approve_Date <> '1900-01-01 00:00:00') Then '' End) as [HOD_Approve_Date], 
					(Case When RM.HOD_Remark<> '' Then RM.HOD_Remark When RM.HOD_Remark='' Then '' End) As [HOD_Remark],
					RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
					RM.Audience, RSM.Request_Status_Name    
				From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM  , Client_Master CM1  
				Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA'))    
					and RM.Request_Status_ID=RSM.Request_Status_ID    
					and RM.Priority_ID=RPM.Priority_ID 
					and RM.Request_Status_ID=@Request_Status_ID
		
			) T
			Where HOD IS not NULL
			Order By Request_Status_Name,Request_Date
 
		End
	End 
	Else If(@Option='4') --pending by admin    
	Begin    
		Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
			RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
			--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
			Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
			RM.Audience, RSM.Request_Status_Name    
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM
		Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master)
			and RM.Request_Status_ID=RSM.Request_Status_ID    
			and RM.Priority_ID=RPM.Priority_ID    
		Order By Request_Date DESC
	End    
	Else If(@Option='5') --pending for Assign by admin    
	Begin    
		Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
			RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
			--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
			Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
			RM.Audience, RSM.Request_Status_Name    
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
		Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('PC','PO','AA','SYA'))    
			and RM.Request_Status_ID=RSM.Request_Status_ID    
			and RM.Priority_ID=RPM.Priority_ID    
			and RM.Request_Status_ID in ('ABA') 
		Order By Request_Date   
	End    
	Else If(@Option='8')    
	Begin    
		Select RM.Request_ID, RM.Requested_By As [Emp_ID], CM.Emp_Name As [Emp_Name], CM.Department,Cm.Designation, 
			CM.HOD_Name, RM.Project_Name, RM.Audience,Convert(varchar(12),RM.Request_Date,113) As Request_Date, Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate ,  
			RPM.Priority_ID As Priority, RM.Brief_Requirement, RM.Business_Needs, RM.Current_Process,    
			RSM.Request_Status_Name, BR_Attachment, BN_Attachment, CP_Attachment, CM.EmailAdd As [emailadd]     
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
		Where RM.Requested_By=CM.Emp_ID And RM.Request_ID=@Request_ID    
		   and RM.Request_Status_ID=RSM.Request_Status_ID    
		   and RM.Priority_ID=RPM.Priority_ID    
		Order By Request_Date DESC

		Select Request_Status_ID From Request_Master
		Where Request_ID=@Request_ID
	End    
	Else If(@Option='9')    -- Accept by PROJECT Manager / Delegate 
	Begin    
		Select Distinct RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], 
			Convert(varchar(12),PRJM.AS_SDate,113) As Request_Date,
			Convert(varchar(12),PRJM.AS_EDate,113) As Expected_EDate, 
			RPM.Priority_Name As Priority,    
			RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
			--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
			Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
			RM.Audience, RSM.Request_Status_Name    
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
				, Project_Master PRJM
		Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('PC','PO','AA','SYA'))    
			and RM.Request_Status_ID=RSM.Request_Status_ID    
			and RM.Priority_ID=RPM.Priority_ID  and RM.Request_ID=PRJM.Request_ID
			and RM.Request_Status_ID in ('PMA') 
			and PRJM.Project_Manager=@Requested_BY
		Order By Request_Date DESC
	End   
	Else If(@Option='10')    -- Accept by PROJECT Manager / Delegate 
	Begin    --(All new request and PM's new request)
		If(@Role_ID = 'PM') 
		Begin	
			If(@Request_Status_ID='NPR')
			Begin
				Select distinct Request_ID, Project_Name,[Requested_By], Request_Date, Expected_EDate, Priority,    
					Brief_Requirement, BR_Attachment, Business_Needs, BN_Attachment, Current_Process,CP_Attachment,     
					HOD_Approve_Date, HOD_Remark, Admin_Approve, Admin_Approve_Date,Admin_Remark,    
					Audience, Request_Status_Name
				From 
				(
					Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
						RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
						--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
						Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
						RM.Audience, RSM.Request_Status_Name 
					From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
					Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('PC','PO','AA','SYA'))    
						and RM.Request_Status_ID=RSM.Request_Status_ID    
						and RM.Priority_ID=RPM.Priority_ID    
						and RM.Request_Status_ID in ('PBA','NCFA','ABA')
				) T Order By HOD_Approve_Date DESC
			End
			Else If(@Request_Status_ID='MP')
			Begin
				Select distinct Request_ID, Project_Name,[Requested_By], Request_Date, Expected_EDate, Priority,    
					Brief_Requirement, BR_Attachment, Business_Needs, BN_Attachment, Current_Process,CP_Attachment,     
					HOD_Approve_Date, HOD_Remark, Admin_Approve, Admin_Approve_Date,Admin_Remark,    
					Audience, Request_Status_Name 
				From
				(
					Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,
						Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
						RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
						--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
						Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, 
						Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
						RM.Audience, RSM.Request_Status_Name  
					From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
							, Project_Master PRJM
					Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('PC','PO','AA','SYA'))    
						and RM.Request_Status_ID=RSM.Request_Status_ID    
						and RM.Priority_ID=RPM.Priority_ID  and RM.Request_ID=PRJM.Request_ID
						and RM.Request_Status_ID in ('PMA','ACP','OHD','DLG','PFT','PFU','UC') 
						and ( PRJM.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Requested_BY) OR PRJM.Project_Manager=@Requested_BY)
				) T Order By Admin_Approve_Date DESC
			End
		End
		Else If(@Role_ID = 'SYA')
		Begin
			If(@Request_Status_ID='NPR')
			Begin
 				Select distinct Request_ID, Project_Name,[Requested_By], Request_Date, Expected_EDate, Priority,    
					Brief_Requirement, BR_Attachment, Business_Needs, BN_Attachment, Current_Process,CP_Attachment,     
					HOD_Approve_Date, HOD_Remark, Admin_Approve, Admin_Approve_Date,Admin_Remark,    
					Audience, Request_Status_Name 
				From 
				(
					Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
						RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
						--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
						Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
						RM.Audience, RSM.Request_Status_Name 
					From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
					Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('PC','PO','AA','SYA'))    
						and RM.Request_Status_ID=RSM.Request_Status_ID    
						and RM.Priority_ID=RPM.Priority_ID    
						and RM.Request_Status_ID in ('PBA','NCFA','ABA')
				) T Order By HOD_Approve_Date DESC
			End
			Else If(@Request_Status_ID='MP') 
			Begin
				Select distinct Request_ID, Project_Name,[Requested_By], Request_Date, Expected_EDate, Priority,    
					Brief_Requirement, BR_Attachment, Business_Needs, BN_Attachment, Current_Process,CP_Attachment,     
					HOD_Approve_Date, HOD_Remark, Admin_Approve, Admin_Approve_Date,Admin_Remark,    
					Audience, Request_Status_Name
				From 
				(
					Select RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, RPM.Priority_Name As Priority,    
						RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,     
						--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
						Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark,
						RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
						RM.Audience, RSM.Request_Status_Name  
					From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
							, Project_Master PRJM
					Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master  Where Role_ID in ('PC','PO','AA','SYA'))    
						and RM.Request_Status_ID=RSM.Request_Status_ID    
						and RM.Priority_ID=RPM.Priority_ID  and RM.Request_ID=PRJM.Request_ID
						and RM.Request_Status_ID in ('PMA','ACP','OHD','DLG','PFT','PFU','UC') 
						and ( PRJM.Project_Manager in (Select EMP_ID From Client_Master Where HOD=@Requested_BY) OR
								PRJM.Project_Manager=@Requested_BY)
				) T Order By Admin_Approve_Date DESC
			End
		End
	End  

	Else If(@Option='11')    -- Delegated to PROJECT Leader
	Begin    
		Select distinct RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, 
				RPM.Priority_Name As Priority,RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process,
				 RM.CP_Attachment,     
			--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
			Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
			RM.Audience, RSM.Request_Status_Name , DCM.Emp_Name as [Delegated_By]   
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
				, Project_Master PRJM, Delegation_Master DM,Client_Master DCM
		Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master Where Role_ID in ('PC','PO','AA','SYA'))    
			and RM.Request_Status_ID=RSM.Request_Status_ID    
			and RM.Priority_ID=RPM.Priority_ID  and RM.Request_ID=PRJM.Request_ID
			and RM.Request_ID = DM.RequestID
			and DCM.Emp_ID = DM.DelegateBy
			and PRJM.Project_Leader=@Requested_BY

	End  
	Else If(@Option='12')    -- New Project Request PROJECT Leader 
	Begin    
		Select distinct RM.Request_ID, RM.Project_Name, CM.Emp_Name As [Requested_By], Convert(varchar(12),RM.Request_Date,113) As Request_Date,Convert(varchar(12),RM.Expected_EDate,113) As Expected_EDate, 
				RPM.Priority_Name As Priority,RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process,
				 RM.CP_Attachment,     
			--HOD=(Select Emp_Name From Client_Master Where Emp_ID in (Select HOD From Client_Master,Request_Master Where Emp_ID=Requested_BY)),    
			Convert(varchar(12), RM.HOD_Approve_Date,113)  as HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, Convert(varchar(12), RM.Admin_Approve_Date,113)  as Admin_Approve_Date, RM.Admin_Remark,    
			RM.Audience, RSM.Request_Status_Name , DCM.Emp_Name as [Delegated_By]   
		From Request_Master RM, Client_Master CM,Request_Status_Master RSM, Request_Priority_Master RPM    
				, Project_Master PRJM, Delegation_Master DM,Client_Master DCM
		Where RM.Requested_By=CM.Emp_ID And RM.Requested_By in (Select Distinct Emp_ID From Client_Master Where Role_ID in ('PC','PO','AA','SYA'))    
			and RM.Request_Status_ID=RSM.Request_Status_ID    
			and RM.Priority_ID=RPM.Priority_ID  and RM.Request_ID=PRJM.Request_ID
			and RM.Request_ID = DM.RequestID
			and DCM.Emp_ID = DM.DelegateBy
			and PRJM.Project_Leader=@Requested_BY

	End   
--===============================================INSERT/UPDATE/DELETE===========================================--    
	Else IF(@Option='21') --Insert New Request    
	Begin    
		If(@Role_ID = 'PO')
		Begin
			Set @Request_Status_ID='PBA'
			Set @HOD_Approve=@Requested_By
			Set @HOD_Approve_Date=@Requested_Date
		End
		Else If(@Role_ID = 'AA' or @Role_ID = 'SYA')
		Begin
			Set @Request_Status_ID='PBA'
			Set @HOD_Approve=@Requested_By
			Set @HOD_Approve_Date=@Requested_Date
		End



		If((Upper(@Project_Name) in (Select Distinct Upper(Project_Name) from Project_Master)) and (Upper(@Project_Name) not in (Select Distinct Upper(Project_Name) from Request_Master)))
        Begin
			Select 'PRESENT'
	   	End    
        Else
		Begin
			Insert Into Request_Master Values (@Request_ID, @Project_Name, @Requested_By, @Requested_Date,    
				@Expected_EDate, @Priority_ID, @Brief_Requirement, @BR_Attachment, @Business_Needs, @BN_Attachment,    
				@Current_Process, @CP_Attachment, @HOD_Approve, @HOD_Approve_Date, @HOD_Remark, @Admin_Approve,     
				@Admin_Approve_Date, @Admin_Remark, @Audience, @Request_Status_ID)    
	    
				Select @Request_ID=MAX(CONVERT(Int,Request_ID)) From Request_Master    
	    
			Insert Into Request_Details Values ('',@Request_ID, @Project_Name, @Requested_By, @Requested_Date,    
				@Expected_EDate, @Priority_ID, @Brief_Requirement, @BR_Attachment, @Business_Needs, @BN_Attachment,    
				@Current_Process, @CP_Attachment, @HOD_Approve, @HOD_Approve_Date, @HOD_Remark, @Admin_Approve,     
				@Admin_Approve_Date, @Admin_Remark, @Audience, @Request_Status_ID)    
	     
			Select @Request_ID  

			Select Emp_ID, Emp_Name, EmailAdd, Role_ID  from client_Master 
			Where Role_ID in ('AA','SYA')
			
		End
   End
	Else If(@Option='22') -- Update By HOD (Approve)    
	Begin    
		Update Request_Master     
		Set Request_Status_ID=@Request_Status_ID,HOD_Approve=@HOD_Approve,HOD_Remark=@HOD_Remark,    
		HOD_Approve_Date=@HOD_Approve_Date    
		Where Request_ID=@Request_ID    
     
		Select @Project_Name=Project_Name, @Requested_By=Requested_By, @Requested_Date=Request_Date,    
			@Expected_EDate=Expected_EDate, @Priority_ID=Priority_ID, @Brief_Requirement=Brief_Requirement,    
			@BR_Attachment=BR_Attachment, @Business_Needs=Business_Needs, @BN_Attachment=BN_Attachment,    
			@Current_Process=Current_Process, @CP_Attachment=CP_Attachment, @Admin_Approve=Admin_Approve,     
			@Admin_Approve_Date=Admin_Approve_Date, @Admin_Remark=Admin_Remark, @Audience=Audience    
		From Request_Master    
		Where Request_ID=@Request_ID    
    
		Insert Into Request_Details Values ('',@Request_ID, @Project_Name, @Requested_By, @Requested_Date,    
			@Expected_EDate, @Priority_ID, @Brief_Requirement, @BR_Attachment, @Business_Needs, @BN_Attachment,    
			@Current_Process, @CP_Attachment, @HOD_Approve, @HOD_Approve_Date, @HOD_Remark, @Admin_Approve,     
			@Admin_Approve_Date, @Admin_Remark, @Audience, @Request_Status_ID)    
      
		Select @Request_ID    

		Select Distinct(Client_Master.EmailAdd) as [Requested by Email], Client_Master.Emp_Name  
		From Client_Master 
			inner join Request_Master on Request_Master.Requested_By = Client_Master.Emp_ID
		Where Request_ID=@Request_ID
	End    
	Else If(@Option='23') -- Update By Admin (Approve)    
	Begin    
		Update Request_Master     
		Set Request_Status_ID=@Request_Status_ID,Admin_Approve=@Admin_Approve,Admin_Remark=@Admin_Remark,    
			Admin_Approve_Date=@Admin_Approve_Date    
		Where Request_ID=@Request_ID    
     
		Select @Project_Name=Project_Name, @Requested_By=Requested_By, @Requested_Date=Request_Date,    
		   @Expected_EDate=Expected_EDate, @Priority_ID=Priority_ID, @Brief_Requirement=Brief_Requirement,    
		   @BR_Attachment=BR_Attachment, @Business_Needs=Business_Needs, @BN_Attachment=BN_Attachment,    
		   @Current_Process=Current_Process, @CP_Attachment=CP_Attachment, @HOD_Approve=HOD_Approve,     
		   @HOD_Approve_Date=HOD_Approve_Date, @HOD_Remark=HOD_Remark, @Audience=Audience    
		From Request_Master    
		Where Request_ID=@Request_ID    
    
		Insert Into Request_Details Values ('',@Request_ID, @Project_Name, @Requested_By, @Requested_Date,    
		   @Expected_EDate, @Priority_ID, @Brief_Requirement, @BR_Attachment, @Business_Needs, @BN_Attachment,    
		   @Current_Process, @CP_Attachment, @HOD_Approve, @HOD_Approve_Date, @HOD_Remark, @Admin_Approve,     
		   @Admin_Approve_Date, @Admin_Remark, @Audience, @Request_Status_ID)    
    
		Select @Request_ID   

	    Select Distinct(Client_Master.emailadd) as [Requested by Email], Client_Master.Emp_Name
		From Client_Master
			inner join Request_Master on Request_Master.Requested_By = Client_Master.Emp_ID
		Where Request_ID = @Request_ID 

		UNION

		Select Distinct(Client_Master.emailadd) as [Requested by Email], Client_Master.Emp_Name
		From Request_Master 
			inner join Client_Master on Request_Master.HOD_Approve = Client_master.Emp_ID
		Where Request_ID = @Request_ID 

	End    
	Else If(@Option='24') -- Update By PC, PO, Admin (From New Request Page)    
	Begin    
      
		Update Request_Master     
		Set Expected_EDate=@Expected_EDate, Priority_ID=@Priority_ID, Brief_Requirement=@Brief_Requirement,    
			BR_Attachment=@BR_Attachment, Business_Needs=@Business_Needs, BN_Attachment=@BN_Attachment,    
			Current_Process=@Current_Process, CP_Attachment=@CP_Attachment,  Audience=@Audience    
		Where Request_ID=@Request_ID    
    
		Select @Project_Name=Project_Name, @Requested_By=Requested_By, @Requested_Date=Request_Date,    
		   @Expected_EDate=Expected_EDate, @Priority_ID=Priority_ID, @Brief_Requirement=Brief_Requirement,    
		   @BR_Attachment=BR_Attachment, @Business_Needs=Business_Needs, @BN_Attachment=BN_Attachment,    
		   @Current_Process=Current_Process, @CP_Attachment=CP_Attachment, @HOD_Approve=HOD_Approve,     
		   @HOD_Approve_Date=HOD_Approve_Date, @HOD_Remark=HOD_Remark, @Audience=Audience    
		From Request_Master    
		Where Request_ID=@Request_ID    
    
		Insert Into Request_Details Values ('',@Request_ID, @Project_Name, @Requested_By, @Requested_Date,    
			@Expected_EDate, @Priority_ID, @Brief_Requirement, @BR_Attachment, @Business_Needs, @BN_Attachment,    
			@Current_Process, @CP_Attachment, @HOD_Approve, @HOD_Approve_Date, @HOD_Remark, @Admin_Approve,     
			@Admin_Approve_Date, @Admin_Remark, @Audience, @Request_Status_ID)    
    
		Select @Request_ID    
	End  
	Else If(@Option='25') -- Accpet / ON HOLD / DELEGATE By Project Manager
	Begin 
		Update Request_Master
		Set Request_STatus_ID=@Request_Status_ID
		Where Request_ID=@Request_ID

		If(@Request_Status_ID='DLG')
		Begin
			Update Project_Master
			Set Project_Leader=@Requested_By, Remark=@HOD_Remark, Status=@Request_Status_ID
			Where Request_ID=@Request_ID
			
			Select @Project_Name = Project_ID from Project_Master Where Request_ID=@Request_ID

			Insert Into Delegation_Master (RequestID, ProjectID, DelegateBy, DelegateTo, DelegateDate, Remark, ReqFlag)
			values(@Request_ID, @Project_Name, @HOD_Approve, @Requested_By, getdate(), @HOD_Remark, 0)   
		End
		Else 
		Begin
			Update Project_Master 
			Set Remark=@HOD_Remark, Status=@Request_Status_ID
			Where Request_ID=@Request_ID
		End			

		Select @Project_Name=Project_Name, @Requested_By=Requested_By, @Requested_Date=Request_Date,    
		   @Expected_EDate=Expected_EDate, @Priority_ID=Priority_ID, @Brief_Requirement=Brief_Requirement,    
		   @BR_Attachment=BR_Attachment, @Business_Needs=Business_Needs, @BN_Attachment=BN_Attachment,    
		   @Current_Process=Current_Process, @CP_Attachment=CP_Attachment, @HOD_Approve=HOD_Approve,     
		   @HOD_Approve_Date=HOD_Approve_Date, @HOD_Remark=HOD_Remark, @Audience=Audience    
		From Request_Master    
		Where Request_ID=@Request_ID  

		Select @Request_ID
	End
	
	Else If(@Option='26') -- Admin homepage - first tab fill grid as per department wise
	Begin
		Select Department As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, sum(NR+WIP+C) As Total
		From 
		(
			Select Department, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) As C
			From
			(

				Select distinct Department, 
						(Case When Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA') Then Count(Request_ID) else 0 End ) As [New Request],
						(Case When Request_Status_ID IN ('PMA','DLG') Then Count(Request_ID) else 0  End) As [Work In Progress],
						(Case When Request_Status_ID IN ('C') Then Count(Request_ID)  else 0  End) As [Completed]
				From Request_Master RM, Client_Master CM
				Where RM.Requested_BY=CM.Emp_ID  
				Group BY Department, Request_Status_ID

			) Temp
			Group BY Department
		) Test
		Group BY Department
		Order by Department
	End
	Else If(@Option='27') -- Admin homepage - first tab fill grid as per Project Manager wise
	Begin
		Select RM.Emp_Name As [Type], sum(NR) As NR, sum(WIP) As WIP, Sum(C) AS C, sum(NR+WIP+C) As Total
		From 
		(
			Select Project_Manager, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP, Sum([Completed]) As C
			From
			(

				Select distinct Project_Manager, 
						(Case When Request_Status_ID IN ('PBH','PBA','NCFH','NCFH','ABA') Then Count(RM.Request_ID) else 0 End ) As [New Request],
						(Case When Request_Status_ID IN ('PMA','DLG') Then Count(RM.Request_ID) else 0  End) As [Work In Progress],
						(Case When Request_Status_ID IN ('C') Then Count(RM.Request_ID)  else 0  End) As [Completed]
				From Request_Master RM, Project_Master PM
				Where RM.Request_ID=PM.Request_ID And PM.Project_Manager != '' And PM.Project_Manager IS not NULL
				Group BY Project_Manager, Request_Status_ID

			) Temp
			Group BY Project_Manager
		) Test, Resource_Master RM
		Where Test.Project_Manager=RM.Emp_ID
		Group BY RM.Emp_Name
		Order by RM.Emp_Name
	End
	Else If(@Option='28') -- Project Manager Serach request
	Begin
		Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
			Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
			RPM.Priority_Name As [Priority], 
			Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
			Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
			Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
			Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
			Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
			RSM.Request_Status_Name
		From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
			Project_Master PRJM  
		Where RM.Request_ID=@Request_ID And RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
			and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
			and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
			And RM.Request_Status_ID in ('PMA','ACP','DLG','PFT','PFU','UC','C') 
			And PRJM.Project_Manager=@Admin_Approve
	End
	Else If(@Option='29')
	Begin
		If((Upper(@Project_Name) in (Select Distinct Upper(Project_Name) from Project_Master)))
        Begin
			Select 'PRESENT'
	   	End 
		Else
			Select 'NP'
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Request_Operation_Details
-- --------------------------------------------------









CREATE Proc [dbo].[USP_Request_Operation_Details] 

@Type As Varchar(10),
@Filter As Varchar(100),
@StartDate As Datetime,
@EndDate AS Datetime,
@Emp_ID As Char(20),
@Role As Char(20),
@Option As Int

---------------------------------------------------------------------------
-- 1 USP_Request_Operation_Details '','','','','P00227','AA','1'
-- 3 USP_Request_Operation_Details '','','','','P00227','AA','3'
-- 4 USP_Request_Operation_Details 'NR','HR','','','P00227','AA','4'
--
--
---------------------------------------------------------------------------

As
Begin
	Declare @FDate As Datetime
	Declare @EDate As Datetime
	Declare @FirstDate As Datetime
	Declare @LastDate As Datetime
	
	Set @Filter=(SELECT REPLACE(@Filter,'&amp;','&'))

	Set @FirstDate = Convert(Varchar(11),Cast('1900-01-01 00:00:00' As Datetime),110)
	Set @LastDate = Convert(Varchar(11),Cast('2999-01-01 00:00:00' As Datetime),110)
	Set @FDate = CONVERT(VARCHAR(11),getdate(),110)

	If(@Role='AA')
	Begin
		If(@Option=1) 
		Begin
			Select Distinct CM.Department As [Type], ISNULL(NR,0) As NR, ISNULL(WIP,0) As WIP, ISNULL(TS,0) AS TS,
				 ISNULL(UAT,0) AS UAT, ISNULL(C,0) AS C, ISNULL(BD,0) As BD, ISNULL(Total,0) As Total
			From 
			(
				Select Distinct Department, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP,SUM([Testing]) AS TS, SUM([UAT]) AS UAT, Sum([Completed]) AS C, SUM([Burn Down]) As BD,
						ISNULL(sum([New Request]+[Work In Progress]+[Testing]+[UAT]+[Completed]+[Burn Down]),0) As Total
				From
				(

					Select distinct Department, RM.Request_ID,
						(Case When (Request_Status_ID IN ('PMA')) Then Count(RM.Request_ID) else 0 End ) As [New Request],
						(Case When (Request_Status_ID IN ('ACP','DLG') And Convert(Varchar(11),PM.AS_EDate,110) >  Convert(Varchar(11),GETDATE(),110)) Then Count(RM.Request_ID) else 0 End) As [Work In Progress],
						(Case When (Request_Status_ID IN ('PFT') And Convert(Varchar(11),PM.AS_EDate,110) >  Convert(Varchar(11),GETDATE(),110)) Then Count(RM.Request_ID) else 0  End) As [Testing],
						(Case When (Request_Status_ID IN ('PFU','UC') And Convert(Varchar(11),PM.AS_EDate,110) >  Convert(Varchar(11),GETDATE(),110)) Then Count(RM.Request_ID) else 0  End) AS [UAT],
 						(Case When (Request_Status_ID IN ('C')) Then Count(RM.Request_ID)  else 0  End) As [Completed],
						(Case When (Request_Status_ID IN ('ACP','DLG','PFT','PFU','UC') And Convert(Varchar(11),PM.AS_EDate,110) <= @FDate)  Then Count(RM.Request_ID)  else 0  End) As [Burn Down]
					From Request_Master RM, Client_Master CM, Project_Master PM
					Where RM.Requested_BY=CM.Emp_ID  And RM.Request_ID=PM.Request_ID 
					Group BY Department, Request_Status_ID,PM.AS_EDate, RM.Request_ID

				) Temp 
				Group BY Department
			) Test
				Right Outer join Client_Master CM
				On Test.Department=CM.Department
			Where CM.Department IS NOT NULL
			Order by Total Desc
		END
		Else If(@Option=3)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP,SUM(TS) AS TS, SUM(UAT) AS UAT, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+TS+UAT+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP,SUM([Testing]) AS TS, SUM([UAT]) AS UAT, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Emp_Name As Project,
						(Case When (Request_Status_ID IN ('PMA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
						'0' As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
 						(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
						'0' As [Burn Down]
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=CM.Emp_ID
					Group BY Emp_Name, Request_Status_ID
					
					Union 

					Select Project,
						'0' As [New Request],
						Count(Request_ID) As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
						'0' As [Completed],
						'0' As [Burn Down]	
					From 
					(
						Select distinct Emp_Name AS Project, RM.Request_ID,
								(Case When Request_Status_ID IN ('ACP','DLG') Then Count(RM.Request_ID) else 0  End) As [WIP]
						From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
						Where RM.Request_ID=PM.Request_ID And Convert(Varchar(11),PM.AS_EDate,110) > @FDate 
								And PM.Project_Manager=CM.Emp_ID
						Group BY Emp_Name, Request_Status_ID,RM.Request_ID
					) T
					WHERE T.WIP>0
					Group BY Project

					Union 
					
					Select distinct Emp_Name AS Project, '0' As [New Request], '0' As [Work In Progress],
						(Case When Request_Status_ID IN ('PFT') Then Count(RM.Request_ID) else 0  End) As [Testing],
						(Case When Request_Status_ID IN ('PFU','UC') Then Count(RM.Request_ID) else 0  End) AS [UAT],
						'0' As [Completed],
						'0' As [Burn Down]	
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Request_ID=PM.Request_ID And Convert(Varchar(11),PM.AS_EDate,110) > @FDate 
							And PM.Project_Manager=CM.Emp_ID
					Group BY Emp_Name, Request_Status_ID,RM.Request_ID
					
					Union

					Select distinct Emp_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' AS [Testing],
							'0' AS [UAT],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('ACP','DLG','PFT','PFU','UC') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
					Where RM.Request_ID=PM.Request_ID And Convert(Varchar(11),PM.AS_EDate,110) <= @FDate 
						And PM.Project_Manager=CM.Emp_ID
					Group BY Emp_Name, Request_Status_ID

					Union 
			
					Select Distinct Emp_Name AS Project ,'0' As [New Request], '0' As [Work In Progress],'0' AS [Testing],'0' AS [UAT], '0' As [Completed],'0' As [Burn Down]
					From Client_Master
					Where Role_ID in ('PM','SYA')
				
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		END
		Else If(@Option=4) -- Department wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate],	RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And RM.Request_Status_ID in ('PMA')
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate],
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
			END
			Else If(rtrim(@Type)='TS')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate],
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And RM.Request_Status_ID in ('PFT') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
			END
			Else If(rtrim(@Type)='UAT')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate],
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And RM.Request_Status_ID in ('PFU','UC') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And RM.Request_Status_ID in ('C')
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) <= @FDate
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA') and Department=rtrim(@Filter))
					And RM.Request_Status_ID in ('PMA','ACP','DLG','PFT','PFU','UC','C')
			End
		END
		Else If(@Option=6) -- Project Manager wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PMA')
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
			END
			Else If(rtrim(@Type)='TS')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PFT') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
			END
			Else If(rtrim(@Type)='UAT')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PFU','UC') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate],
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('C')
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) <= @FDate
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PMA','ACP','DLG','PFT','PFU','UC','C')
			End
		End
	End
	--////////////////////////////////////////////////////////////////////////////////////////////////////////////
	--////////////////////////////////////////////// PM Wise   ///////////////////////////////////////////////////
	--////////////////////////////////////////////////////////////////////////////////////////////////////////////
	Else If(@Role='PM')
	Begin
		If(@Option=7) -- For Project Manager
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP,SUM(TS) AS TS, SUM(UAT) AS UAT, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+TS+UAT+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP,SUM([Testing]) AS TS, SUM([UAT]) AS UAT, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(
					Select distinct Emp_Name As Project,PM.Request_ID,
						(Case When (Status IN ('PMA')) Then Count(PM.Request_ID) else 0 End ) As [New Request],
						(Case When (Status IN ('ACP','DLG') And Convert(Datetime,Convert(Varchar(11),PM.AS_EDate,110)) > Convert(Datetime,@FDate) ) Then Count(RM.Request_ID) else 0 End ) As [Work In Progress],
						(Case When (Status IN ('PFT') And Convert(Datetime,Convert(Varchar(11),PM.AS_EDate,110)) > Convert(Datetime,@FDate)  ) Then Count(RM.Request_ID) else 0  End) As [Testing],
						(Case When (Status IN ('PFU','UC') And Convert(Datetime,Convert(Varchar(11),PM.AS_EDate,110)) > Convert(Datetime,@FDate) ) Then Count(RM.Request_ID) else 0  End) AS [UAT],
 						(Case When (Status IN ('C')) Then Count(RM.Request_ID)  else 0  End) As [Completed],
						(Case When (Status IN ('ACP','DLG') And Convert(Datetime,Convert(Varchar(11),Convert(Datetime,PM.AS_EDate),110)) <= Convert(Datetime,@FDate) ) Then Count(RM.Request_ID) else 0  End) As [Burn Down]
					From Request_Master RM with (nolock), Project_Master PM with (nolock), 
							(Select Emp_ID, Emp_Name From Client_Master with (nolock) Where Role_ID in('PM','SYA','DBAPM')) CM
					Where RM.Request_ID=PM.Request_ID 
							And rtrim(PM.Project_Manager)=rtrim(CM.Emp_ID)
							And rtrim(PM.Project_Manager)=@Emp_ID
					Group BY Emp_Name, Status,PM.Request_ID,PM.AS_EDate
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc

		END
		Else If(@Option=8) -- Project Manager wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PMA') And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
					And PRJM.Project_Manager=@Emp_ID
			END
			Else If(rtrim(@Type)='TS')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PFT') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
					And PRJM.Project_Manager=@Emp_ID
			END
			Else If(rtrim(@Type)='UAT')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PFU','UC') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
					And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate],
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('C') And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) <= @FDate
					And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PMA','ACP','DLG','PFT','PFU','UC','C') 
					And PRJM.Project_Manager=@Emp_ID
			End
		End
	END
	--////////////////////////////////////////////////////////////////////////////////////////////////////////////
	--////////////////////////////////////////////// SYA Wise   ///////////////////////////////////////////////////
	--////////////////////////////////////////////////////////////////////////////////////////////////////////////
	Else If(@Role='SYA')
	Begin
		If(@Option=11) -- For Project Manager
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP,SUM(TS) AS TS, SUM(UAT) AS UAT, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+TS+UAT+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP,SUM([Testing]) AS TS, SUM([UAT]) AS UAT, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(

					Select distinct Emp_Name As Project,
						(Case When (Request_Status_ID IN ('PMA')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
						'0' As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
 						(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
						'0' As [Burn Down]
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('SYA')) CM
					Where RM.Request_ID=PM.Request_ID And PM.Project_Manager=CM.Emp_ID And PM.Project_Manager=@Emp_ID
					Group BY Emp_Name, Request_Status_ID
					
					Union 

					Select Project,
						'0' As [New Request],
						Count(Request_ID) As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
						'0' As [Completed],
						'0' As [Burn Down]	
					From 
					(
						Select distinct Emp_Name AS Project, RM.Request_ID,
								(Case When Request_Status_ID IN ('ACP','DLG') Then Count(RM.Request_ID) else 0  End) As [WIP]
						From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('SYA')) CM
						Where RM.Request_ID=PM.Request_ID And Convert(Varchar(11),PM.AS_EDate,110) > @FDate 
								And PM.Project_Manager=CM.Emp_ID And PM.Project_Manager=@Emp_ID
						Group BY Emp_Name, Request_Status_ID,RM.Request_ID
					) T
					WHERE T.WIP>0
					Group BY Project

					Union 
					
					Select distinct Emp_Name AS Project, '0' As [New Request], '0' As [Work In Progress],
						(Case When Request_Status_ID IN ('PFT') Then Count(RM.Request_ID) else 0  End) As [Testing],
						(Case When Request_Status_ID IN ('PFU','UC') Then Count(RM.Request_ID) else 0  End) AS [UAT],
						'0' As [Completed],
						'0' As [Burn Down]	
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('SYA')) CM
					Where RM.Request_ID=PM.Request_ID And Convert(Varchar(11),PM.AS_EDate,110) > @FDate 
							And PM.Project_Manager=CM.Emp_ID And PM.Project_Manager=@Emp_ID
					Group BY Emp_Name, Request_Status_ID,RM.Request_ID
					
					Union

					Select Project,
						'0' As [New Request],
						'0' As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
						'0' As [Completed],
						Count(Request_ID) As [Burn Down]	
					From 
					(
						Select distinct Emp_Name As Project, RM.Request_ID,
								(Case When Request_Status_ID IN ('ACP','DLG') Then Count(RM.Request_ID) else 0  End) As [BD]
						From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PM','SYA')) CM
						Where RM.Request_ID=PM.Request_ID And 
							Convert(Varchar(11),Convert(Datetime,PM.AS_EDate),110) <= @FDate 
							And PM.Project_Manager=CM.Emp_ID And PM.Project_Manager=@Emp_ID
						Group BY Emp_Name, Request_Status_ID, RM.Request_ID
					) T
					WHERE T.[BD]>0
					Group By Project
			
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		END
		Else If(@Option=12) -- Project Manager wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PMA') And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
					And PRJM.Project_Manager=@Emp_ID
			END
			Else If(rtrim(@Type)='TS')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PFT') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
					And PRJM.Project_Manager=@Emp_ID
			END
			Else If(rtrim(@Type)='UAT')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PFU','UC') And Convert(Varchar(11),PRJM.AS_EDate,110) > @FDate
					And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate],
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('C') And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('ACP','DLG') And Convert(Varchar(11),PRJM.AS_EDate,110) <= @FDate
					And PRJM.Project_Manager=@Emp_ID
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select Distinct RM.Request_ID, PRJM.Project_Name, CM.Emp_Name as [Request_BY] , 
					Convert(varchar(12),RM.Request_Date,113) as Request_Date,     
					RPM.Priority_Name As [Priority], 
					Convert(varchar(12),RM.Expected_EDate,113) as Expected_EDate, RM.Brief_Requirement, 
					Convert(varchar(12), RM.HOD_Approve_Date,113) as HDate, RM.HOD_Remark As HRemark, 
					Convert(varchar(12), RM.Admin_Approve_Date,113) as ADate, RM.Admin_Remark As ARemark,
					Convert(Varchar(12),PRJM.AS_SDate,113) As [SDate], 
					Convert(Varchar(12),PRJM.AS_EDate,113) As [EDate], 
					RSM.Request_Status_Name
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM,
					Project_Master PRJM  
				Where RM.Requested_BY=CM.Emp_ID and RM.Request_Status_ID=RSM.Request_Status_ID  
					and RM.Request_ID=PRJM.Request_ID and RM.Priority_ID=RPM.Priority_ID 
					and RM.Requested_BY in (Select Emp_ID From Client_Master where Role_ID in ('PC','PO','AA','SYA'))
					And Upper(PRJM.Project_Manager)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_Status_ID in ('PMA','ACP','DLG','PFT','PFU','UC','C') 
					And PRJM.Project_Manager=@Emp_ID
			End
		End
	END
	--////////////////////////////////////////////////////////////////////////////////////////////////////////////
	--////////////////////////////////////////////// PL Wise   ///////////////////////////////////////////////////
	--////////////////////////////////////////////////////////////////////////////////////////////////////////////
	Else If(@Role='PL')
	Begin
		If(@Option=13)
		Begin
			Select Project As [Type], sum(NR) As NR, sum(WIP) As WIP,SUM(TS) AS TS, SUM(UAT) AS UAT, Sum(C) AS C, Sum(BD) As BD, sum(NR+WIP+TS+UAT+C+BD) As Total
			From 
			(
				Select Project, Sum([New Request]) As NR, Sum([Work In Progress]) AS WIP,SUM([Testing]) AS TS, SUM([UAT]) AS UAT, Sum([Completed]) AS C, SUM([Burn Down]) As BD
				From
				(
					Select distinct Emp_Name As Project,
						'0' As [New Request],
						'0' As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
 						(Case When (Request_Status_ID IN ('C')) Then Count(Request_Status_ID)  else 0  End) As [Completed],
						'0' As [Burn Down]
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
					Where RM.Request_ID=PM.Request_ID And PM.Project_Leader=CM.Emp_ID And PM.Project_Leader=@Emp_ID
					Group BY Emp_Name, Request_Status_ID

					UNION

					Select distinct Emp_Name As Project,
						(Case When (Request_Status_ID IN ('DLG')) Then Count(Request_Status_ID) else 0 End ) As [New Request],
						'0' As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
 						'0' As [Completed],
						'0' As [Burn Down]
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
					Where RM.Request_ID=PM.Request_ID And PM.Project_Leader=CM.Emp_ID And PM.Project_Leader=@Emp_ID
						And Convert(Varchar(11),PM.AS_EDate,110) > Convert(Varchar(11),getdate(),110) 
						And RM.Request_ID NOT IN (Select Request_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					Group BY Emp_Name, Request_Status_ID
					
					Union 

					Select Project,
						'0' As [New Request],
						Count(Request_ID) As [Work In Progress],
						'0' AS [Testing],
						'0' AS [UAT],
						'0' As [Completed],
						'0' As [Burn Down]	
					From 
					(
						Select distinct Emp_Name AS Project, RM.Request_ID,
								(Case When Request_Status_ID IN ('DLG') Then Count(RM.Request_ID) else 0  End) As [WIP]
						From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
						Where RM.Request_ID=PM.Request_ID And PM.Project_Leader=CM.Emp_ID And PM.Project_Leader=@Emp_ID
							And Convert(Varchar(11),PM.AS_EDate,110) > Convert(Varchar(11),getdate(),110) 
							And RM.Request_ID IN (Select Request_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
						Group BY Emp_Name, Request_Status_ID,RM.Request_ID
					) T
					WHERE T.WIP>0
					Group BY Project

					Union 
					
					Select distinct Emp_Name AS Project, '0' As [New Request], '0' As [Work In Progress],
						(Case When Request_Status_ID IN ('PFT') Then Count(RM.Request_ID) else 0  End) As [Testing],
						(Case When Request_Status_ID IN ('PFU','UC') Then Count(RM.Request_ID) else 0  End) AS [UAT],
						'0' As [Completed],
						'0' As [Burn Down]	
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
					Where RM.Request_ID=PM.Request_ID And Convert(Varchar(11),PM.AS_EDate,110) > Convert(Varchar(11),getdate(),110) 
							And PM.Project_Leader=CM.Emp_ID And PM.Project_Leader=@Emp_ID
					Group BY Emp_Name, Request_Status_ID,RM.Request_ID
					
					Union

					Select distinct Emp_Name As Project, 
							'0' As [New Request],
							'0' As [Work In Progress],
							'0' AS [Testing],
							'0' AS [UAT],
							'0' As [Completed],
							(Case When Request_Status_ID IN ('DLG','PFT','PFU','UC') Then Count(Request_Status_ID) else 0  End) As [Burn Down]
					From Request_Master RM, Project_Master PM, (Select Emp_ID, Emp_Name From Client_Master Where Role_ID in('PL')) CM
					Where RM.Request_ID=PM.Request_ID And Convert(Varchar(11),PM.AS_EDate,110) <= Convert(Varchar(11),getdate(),110) 
						And PM.Project_Leader=CM.Emp_ID And PM.Project_Leader=@Emp_ID
					Group BY Emp_Name, Request_Status_ID

			
				) Temp
				Group BY Project
			) Test
			Group BY Project
			Order by Total Desc
		End
		Else If(@Option=14) -- Project Leader wise
		Begin
			If(rtrim(@Type)='NR')
			Begin
				Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
					(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
					(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
					RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
					RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
					RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
					 Client_Master DCM
				Where RM.Requested_By = CM.Emp_ID 
					and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
					and RM.Request_Status_ID = RSM.Request_Status_ID  
					and RM.Priority_ID = RPM.Priority_ID and PM.Request_ID=RM.Request_ID
					and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
					and PM.Project_Leader =@Emp_ID 	and RM.Request_Status_ID in ('DLG')  
					And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And RM.Request_ID NOT IN (Select Request_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
					And Convert(Varchar(11),PM.AS_EDate,110) > Convert(Varchar(11),getdate(),110) 
				Order By PM.Project_ID
			End
			Else If(rtrim(@Type)='WIP')
			Begin
				Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
					(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
					(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
					RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
					RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
					RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
					 Client_Master DCM
				Where RM.Requested_By = CM.Emp_ID 
					and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
					and RM.Request_Status_ID = RSM.Request_Status_ID  
					and RM.Priority_ID = RPM.Priority_ID and PM.Request_ID=RM.Request_ID
					and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
					and PM.Project_Leader =@Emp_ID 	and RM.Request_Status_ID in ('DLG')  
					And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And Convert(Varchar(11),PM.AS_EDate,110) > Convert(Varchar(11),getdate(),110) 
					And RM.Request_ID IN (Select Request_ID From Task_Master Where Project_ID in (Select Project_ID From Project_Master Where Project_Leader=@Emp_ID))
			END
			Else If(rtrim(@Type)='TS')
			Begin
				Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
					(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
					(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
					RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
					RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
					RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
					 Client_Master DCM
				Where RM.Requested_By = CM.Emp_ID 
					and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
					and RM.Request_Status_ID = RSM.Request_Status_ID  
					and RM.Priority_ID = RPM.Priority_ID and PM.Request_ID=RM.Request_ID
					and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
					and PM.Project_Leader =@Emp_ID 	and RM.Request_Status_ID in ('PFT')  
					And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And Convert(Varchar(11),PM.AS_EDate,110) > Convert(Varchar(11),getdate(),110) 
			END
			Else If(rtrim(@Type)='UAT')
			Begin
				Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
					(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
					(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
					RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
					RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
					RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
					 Client_Master DCM
				Where RM.Requested_By = CM.Emp_ID 
					and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
					and RM.Request_Status_ID = RSM.Request_Status_ID  
					and RM.Priority_ID = RPM.Priority_ID and PM.Request_ID=RM.Request_ID
					and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
					and PM.Project_Leader =@Emp_ID 	and RM.Request_Status_ID in ('PFU','UC')  
					And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And Convert(Varchar(11),PM.AS_EDate,110) > Convert(Varchar(11),getdate(),110) 
			End
			Else If(rtrim(@Type)='C')
			Begin
				Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
					(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
					(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
					RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
					RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
					RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
					 Client_Master DCM
				Where RM.Requested_By = CM.Emp_ID 
					and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
					and RM.Request_Status_ID = RSM.Request_Status_ID  
					and RM.Priority_ID = RPM.Priority_ID and PM.Request_ID=RM.Request_ID
					and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
					and PM.Project_Leader =@Emp_ID 	and RM.Request_Status_ID in ('C')  
					And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
			End
			Else If(rtrim(@Type)='BD')
			Begin
				Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
					(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
					(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
					RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
					RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
					RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
					 Client_Master DCM
				Where RM.Requested_By = CM.Emp_ID 
					and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
					and RM.Request_Status_ID = RSM.Request_Status_ID  
					and RM.Priority_ID = RPM.Priority_ID and PM.Request_ID=RM.Request_ID
					and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
					and PM.Project_Leader =@Emp_ID 	and RM.Request_Status_ID in ('DLG')  
					And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
					And Convert(Varchar(11),PM.AS_EDate,110) <= Convert(Varchar(11),getdate(),110) 
			End
			Else If(rtrim(@Type)='Total')
			Begin
				Select Distinct(PM.Request_ID),PM.Project_ID, RM.Project_Name, CM.Emp_Name As [Requested_By],CM.Department AS Department,
					(Convert(Varchar(12),RM.Request_Date,113) + ' ' + Convert(Varchar(8),RM.Request_Date,114)) As Request_Date,
					(Convert(Varchar(12),RM.Expected_EDate,113) + ' ' + Convert(Varchar(8),RM.Expected_EDate,114)) As Expected_EDate,
					RPM.Priority_Name As Priority, RM.Brief_Requirement, RM.BR_Attachment, RM.Business_Needs, RM.BN_Attachment, RM.Current_Process, RM.CP_Attachment,   
					RM.HOD_Approve_Date, RM.HOD_Remark, RM.Admin_Approve, RM.Admin_Approve_Date, RM.Admin_Remark,  
					RM.Audience, RSM.Request_Status_Name, DCM.Emp_Name as [Delegated_By]
				From Request_Master RM, Client_Master CM, Request_Status_Master RSM, Request_Priority_Master RPM, Project_Master PM , Delegation_Master DM,
					 Client_Master DCM
				Where RM.Requested_By = CM.Emp_ID 
					and RM.Requested_By in (Select Distinct Emp_ID From Client_Master )  
					and RM.Request_Status_ID = RSM.Request_Status_ID  
					and RM.Priority_ID = RPM.Priority_ID and PM.Request_ID=RM.Request_ID
					and DCM.Emp_ID = DM.DelegateBy and RM.Request_ID = DM.RequestID 
					and PM.Project_Leader =@Emp_ID 	and RM.Request_Status_ID in ('DLG','PFT','PFU','UC','C')  
					And Upper(PM.Project_Leader)=(Select Upper(Emp_ID) From Resource_Master Where Upper(Emp_Name)=Upper(rtrim(@Filter))) 
			End
		End
	End
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Request_TotalReport_Admin
-- --------------------------------------------------




CREATE PROC [dbo].[USP_Request_TotalReport_Admin]

@Range As Char(10),
@Department As Varchar(100),
@Owner As Varchar(20),
@PM As Varchar(20),
@Option As Int

As 

Begin

	Declare @FromDate As Datetime
	Declare @EndDate As Datetime
	
	If(@Range='Current')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End
	Else IF(@Range='Last')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),110)
		Set @Fromdate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(@FromDate)-1),@FromDate),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),110)
	End
	Else IF(@Range='ALL')
	Begin
		Set @FromDate = Convert(Varchar(11),Cast('1900-01-01 00:00:00' As Datetime),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End

	Print @FromDate
	Print @EndDate	

	If((Select Table_Name From Information_Schema.Tables Where Table_Name='AdminReport_Temp')='AdminReport_Temp')
	Begin
		Drop Table AdminReport_Temp
	End

	If(@Option = 1) --  Only Date Wise 
	Begin

		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					When Request_Status_ID IS Not NULL And Request_Status_ID<>'' Then Count(Request_Status_ID)
					 End ), '') As 'Total'
			From Request_Master RM
			Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Request_Master RM
					Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=2) -- Date wise, Department Wise
	Begin

		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Request_Master RM
			Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
				And RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('C','PC','PO'))
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Request_Master RM
					Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
						And RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('C','PC','PO'))
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=3) -- Date wise, Owner Approved wise
	Begin

		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Request_Master RM
			Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
				And RM.HOD_Approve=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Request_Master RM
					Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
						And RM.HOD_Approve=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
	------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=4) -- Date wise, Department Wise, Owner Approved wise
	Begin

		Select Temp.Request_Status_ID  As [Status], Temp.Total
		Into AdminReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Request_Master RM
			Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
				And RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('PO'))
				And RM.HOD_Approve=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Request_Master RM
					Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
						And RM.Requested_BY in (Select Emp_ID From Client_Master Where Department=@Department And ROle_ID in ('PO'))
						And RM.HOD_Approve=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=5) -- Date wise, Requester Wise
	Begin

		Select Temp.Request_Status_ID  As [Status], Temp.Total
		Into AdminReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Request_Master RM
			Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
				And RM.Requested_BY=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Request_Master RM
					Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
						And RM.Requested_BY=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
	------///////////////////////////////////////////////////////////////////////////////////////////////////////------
	Else If(@Option=6) -- Date wise, Department Wise, Owner and its Coordinator wise
	Begin
		Drop Table AdminReport_Temp

		Select Temp.Request_Status_ID  As [Status], Temp.Total
		Into AdminReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					 End ), '') As 'Total'
			From Request_Master RM
			Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
				And RM.Requested_BY=@Owner
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Request_Master RM
					Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
						And RM.Requested_BY=@Owner
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End
---------///////////////////////////////////////////////////////////////////////////////////////////------------
	Else If(@Option=7)
	Begin

		Select Temp.Request_Status_ID As [Status], Temp.Total
		Into AdminReport_Temp
		From
		(
			Select Request_Status_ID, ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
					When Request_status_id='PBA' Then Count(Request_status_id)
					When Request_status_id='NCFH' Then Count(Request_status_id)
					When Request_status_id='NCFA' Then Count(Request_status_id)
					When Request_status_id='ABA' Then Count(Request_status_id)
					When Request_status_id='PMA' Then Count(Request_status_id)
					When Request_status_id='DLG' Then Count(Request_status_id)
					When Request_status_id='C' Then Count(Request_status_id)
					When Request_status_id='ACP' Then Count(Request_status_id)
					When Request_Status_ID IS Not NULL And Request_Status_ID<>'' Then Count(Request_Status_ID)
					 End ), '') As 'Total'
			From Request_Master RM
			Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
				And Request_ID in (Select Request_ID From Project_Master Where Project_Manager in 
									(Select Emp_ID From Client_Master Where Role_ID in ('PM','SYA') and Emp_ID=@PM ))
			Group By Request_Status_ID
			Having Request_Status_ID in ('PBA','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
			
			Union 

			Select Request_Status_ID, '0' As Total
			From  Request_Status_Master
			Where Request_Status_ID NOT IN
			(
				Select Request_Status_ID From 
				(
					Select Request_Status_ID,
						ISNULL((Case When Request_status_id='PBH' Then Count(Request_status_id)
							When Request_status_id='PBA' Then Count(Request_status_id)
							When Request_status_id='NCFH' Then Count(Request_status_id)
							When Request_status_id='NCFA' Then Count(Request_status_id)
							When Request_status_id='ABA' Then Count(Request_status_id)
							When Request_status_id='PMA' Then Count(Request_status_id)
							When Request_status_id='DLG' Then Count(Request_status_id)
							When Request_status_id='ACP' Then Count(Request_status_id)
							When Request_status_id='C' Then Count(Request_status_id) End ),
						 '') As 'Total'
					From Request_Master RM
					Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
						And Request_ID in (Select Request_ID From Project_Master Where Project_Manager in 
									(Select Emp_ID From Client_Master Where Role_ID in ('PM','SYA') and Emp_ID=@PM ))
					Group By Request_Status_ID
					Having Request_Status_ID in ('PBH','PBA','NCFH','NCFA','ABA','DLG','C','PMA','ACP','PBH')
				) Temp1
			)
			and Request_Status_ID not in ('RBH','RBA','OHD')

		) Temp 
	End


	If((Select Table_Name From Information_Schema.Tables Where Table_Name='AdminReport_Temp')='AdminReport_Temp')
	Begin
		Select distinct Status, Temp, Total
		From 
		(
		Select (Case When Status='PBH' Then 'Pending By Owner'
				  When Status='NCFH' Then 'Need Clarification For Owner'
				  When Status='PBA' Then 'Pending By Admin'
				  When Status='NCFA' Then 'Need Clarification For Admin'
				  When Status='ABA' Then 'Project Pending For Assign'
				  When Status ='PMA' Then 'Assign To Project Manager'
				  When Status in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When Status='C' Then 'Complete'
				End
			) As [Status], 
			(Case When Status='PBH' Then 'A'
				  When Status='NCFH' Then 'B'
				  When Status='PBA' Then 'C'
				  When Status='NCFA' Then 'D'
				  When Status='ABA' Then 'E'
				  When Status ='PMA' Then 'F'
				  When Status in ('ACP','DLG') Then 'G'
				  When Status='C' Then 'H'
				End
			) As [Temp]
			, (Case When Status='PBH' Then (Select Total From AdminReport_Temp Where Status='PBH')
				  When Status='NCFH'  Then (Select Total From AdminReport_Temp Where Status='NCFH')
				  When Status='PBA'  Then (Select Total From AdminReport_Temp Where Status='PBA')
				  When Status='NCFA'  Then (Select Total From AdminReport_Temp Where Status='NCFA')
				  When Status='ABA'  Then (Select Total From AdminReport_Temp Where Status='ABA')
				  When Status ='PMA'  Then (Select Total From AdminReport_Temp Where Status='PMA')
				  When Status in ('ACP','DLG') Then (Select Total From AdminReport_Temp Where Status='ACP') + (Select Total From AdminReport_Temp Where Status='DLG')
				  When Status='C' Then (Select Total From AdminReport_Temp Where Status='C')
				End
			) As Total
		From AdminReport_Temp
		
		Union

		Select 'TOTAL' As Status, 'I' AS Temp, Sum(Total) From AdminReport_Temp

		) Test
		Order By Temp
	End 

	Drop Table AdminReport_Temp
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Request_TotalReport_Admin_Details
-- --------------------------------------------------





CREATE proc [dbo].[USP_Request_TotalReport_Admin_Details]


@Range As Char(10),
@Department As Varchar(100),
@Owner As Varchar(20),
@PM As Varchar(20),
@Status As Varchar(50),
@Option As Int

As
Begin
	
	Declare @FromDate As Datetime
	Declare @EndDate As Datetime
	
	If(@Range='Current')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End
	Else IF(@Range='Last')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),110)
		Set @Fromdate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(@FromDate)-1),@FromDate),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),110)
	End
	Else IF(@Range='ALL')
	Begin
		Set @FromDate = Convert(Varchar(11),Cast('1900-01-01 00:00:00' As Datetime),110)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End

	Print @FromDate
	Print @EndDate	

	If(@Option=1) -- Period - NO Other Condition 
	Begin
			
		Select RM.Request_ID AS RID, RM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Requested_BY,
			RM.Request_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Request_Master RM, Request_Priority_Master PRM, 
			(Select Emp_ID, Emp_Name From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Requested_BY=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
	End
	Else If(@Option=2) -- Period , Department - NO Other Condition 
	Begin
		Select RM.Request_ID AS RID, RM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Requested_BY,
			RM.Request_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Request_Master RM, Request_Priority_Master PRM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Requested_BY=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And CM.Department=@Department
	End
	Else If(@Option=3) -- Period , Owner - NO Other Condition 
	Begin
		Select RM.Request_ID AS RID, RM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Requested_BY,
			RM.Request_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Request_Master RM, Request_Priority_Master PRM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Requested_BY=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.HOD_Approve=@Owner
	End
	Else If(@Option=4) -- Period , Department,  Owner  - NO Other Condition 
	Begin
		Select RM.Request_ID AS RID, RM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Requested_BY,
			RM.Request_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Request_Master RM, Request_Priority_Master PRM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Requested_BY=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.HOD_Approve=@Owner
			And CM.Department=@Department
	End
	Else If(@Option=5) -- Period , Requester - NO Other Condition 
	Begin
		Select RM.Request_ID AS RID, RM.Project_Name As Project, PRM.Priority_Name As Priority, CM.Emp_Name As Requested_BY,
			RM.Request_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Request_Master RM, Request_Priority_Master PRM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Requested_BY=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.Requested_BY=@Owner
	End
	Else If(@Option=6) -- Period , Department,  Requester  - NO Other Condition 
	Begin
		Select RM.Request_ID AS RID, RM.Project_Name As Project, PRM.Priority_Name As Priority, 
			CM.Emp_Name As Requested_BY, RM.Request_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Request_Master RM, Request_Priority_Master PRM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Requested_BY=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And RM.Requested_BY=@Owner
			And CM.Department=@Department
	End
	Else If(@Option=7) -- Period , Manager  - NO Other Condition 
	Begin
		Select RM.Request_ID AS RID, RM.Project_Name As Project, PRM.Priority_Name As Priority, 
			CM.Emp_Name As Requested_BY, RM.Request_Date As Req_SDate, Expected_EDate As Req_EDate, 
			(Case When (RM.HOD_Approve<>'' AND RM.HOD_Approve IS NOT NULL) Then (Select Emp_Name From Client_Master Where Emp_ID=RM.HOD_Approve)
				When (RM.HOD_Approve='' or RM.HOD_Approve IS NULL) Then '' End) As Approved_By,
			RM.HOD_Approve_Date AS Approved_Date,
			(Case When RM.Request_Status_ID='PBH' Then 'Pending By Owner'
				  When RM.Request_Status_ID='NCFH' Then 'Need Clarification For Owner'
				  When RM.Request_Status_ID='PBA' Then 'Pending By Admin'
				  When RM.Request_Status_ID='NCFA' Then 'Need Clarification For Admin'
				  When RM.Request_Status_ID='ABA' Then 'Project Pending For Assign'
				  When RM.Request_Status_ID ='PMA' Then 'Assign To Project Manager'
				  When RM.Request_Status_ID in ('ACP','DLG') Then 'Accpeted By Project Manager'
				  When RM.Request_Status_ID='C' Then 'Complete'
				End
			) AS Status
		From Request_Master RM, Request_Priority_Master PRM, (Select Emp_ID, Emp_Name, Department, Role_ID From Client_Master  Where Role_ID in ('C','PC','PO','AA','SYA') ) CM
		Where Convert(Varchar(11),Request_Date,110) Between Convert(Varchar(11),@FromDate,110) And Convert(Varchar(11),@EndDate,110)
			And RM.Priority_ID=PRM.Priority_ID And RM.Requested_BY=CM.Emp_ID
			And RM.Request_Status_ID in (@Status)
			And Request_ID in (Select Request_ID From Project_Master Where Project_Manager in 
									(Select Emp_ID From Client_Master Where Role_ID in ('PM','SYA') and Emp_ID=@PM ))
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Request_TotalReport_Admin_Old
-- --------------------------------------------------
Create PROC USP_Request_TotalReport_Admin_Old

@Range As Char(10)

As 

Begin

	Declare @FromDate As Datetime
	Declare @EndDate As Datetime
	
	If(@Range='Current')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),113)
	End
	Else IF(@Range='Last')
	Begin
		Set @FromDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),113)
		Set @Fromdate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(@FromDate)-1),@FromDate),113)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),113)
	End
	Else IF(@Range='ALL')
	Begin
		Set @FromDate = Convert(Varchar(11),Cast('1900-01-01 00:00:00' As Datetime),113)
		Set @EndDate = CONVERT(VARCHAR(11),DATEADD(dd,-(DAY(getdate())),getdate()),113)
	End
	
	Declare @Query1 As NVarchar(MAX)
	Declare @Query2 As Varchar(MAX)
	Declare @Query3 As Varchar(MAX)
	Declare @Query4 As Varchar(MAX)
	Declare @Query5 As Varchar(MAX)
	
	Set @Query1 = 

	'Select Temp.Request_Status_ID,RSM.Request_Status_Name, Temp.Total
	From ( Select Request_Status_ID, (Case When Request_status_id=''PBH'' Then Count(Request_status_id)
				When Request_status_id=''PBA'' Then Count(Request_status_id)
				When Request_status_id=''NCFH'' Then Count(Request_status_id)
				When Request_status_id=''NCFA'' Then Count(Request_status_id)
				When Request_status_id=''ABA'' Then Count(Request_status_id)
				When Request_status_id=''PMA'' Then Count(Request_status_id)
				When Request_status_id=''DLG'' Then Count(Request_status_id)
				When Request_status_id=''C'' Then Count(Request_status_id)
				When Request_status_id=''ACP'' Then Count(Request_status_id)
				 End ) As ''Total''
		From Request_Master RM '

	Print @Query1	

	Set @Query2 = ' Group By Request_Status_ID
		Having Request_Status_ID in (''PBH'',''PBA'',''NCFH'',''NCFA'',''ABA'',''DLG'',''C'',''PMA'',''ACP'')
		
		Union 
		'

	Print @Query2

	Set @Query3 = 
		' Select Request_Status_ID, ''0'' As Total
		From  Request_Status_Master
		Where Request_Status_ID NOT IN
		(
			Select Request_Status_ID From 
			(
				Select Request_Status_ID,
					(Case When Request_status_id=''PBH'' Then Count(Request_status_id)
						When Request_status_id=''PBA'' Then Count(Request_status_id)
						When Request_status_id=''NCFH'' Then Count(Request_status_id)
						When Request_status_id=''NCFA'' Then Count(Request_status_id)
						When Request_status_id=''ABA'' Then Count(Request_status_id)
						When Request_status_id=''PMA'' Then Count(Request_status_id)
						When Request_status_id=''DLG'' Then Count(Request_status_id)
						When Request_status_id=''ACP'' Then Count(Request_status_id)
						When Request_status_id=''C'' Then Count(Request_status_id) End )
				 As ''Total''
				From Request_Master RM '
		
		
	Print @Query3

	Set @Query4 = ' Group By Request_Status_ID
				Having Request_Status_ID in (''PBH'',''PBA'',''NCFH'',''NCFA'',''ABA'',''DLG'',''C'',''PMA'',''ACP'')
			) Temp1
		)
		and Request_Status_ID not in (''RBH'',''RBA'',''OHD'')

	) Temp , Request_Status_Master RSM
	Where Temp.Request_Status_ID=RSM.Request_Status_ID '

	Print @Query4

	Set @Query5 = @Query1 + @Query2 + @Query3 + @Query4
	
	Exec @Query5
	Print @Query5

End



-- USP_Request_TotalReport_Admin 'Current'

-- USP_Request_TotalReport_Admin 'Last',''

-- USP_Request_TotalReport_Admin 'ALL',''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SaveMailLog
-- --------------------------------------------------
CREATE Proc USP_SaveMailLog

@Request_ID As Char(10),
@Change_ID As Char(10),
@Project As Varchar(200),
@Subject As Varchar(500),
@Body As NVarchar(MAX),
@EmailFrom As Varchar(250),
@EmailTo As Varchar(250),
@EmailCC As Varchar(250),
@Department As Varchar(100),
@EmailDate As Datetime,
@SMTPIP As Varchar(50),
@Status As Varchar(50),
@Option As Int

---------------------------------------------------------------------------------------
-- Created By	: Mahendra Bonde
-- Created On	: 25/06/2010
-- Modified By	:
-- Modified On	:
---------------------------------------------------------------------------------------


As 
Begin

	If(@Option=1)
	Begin
		Insert Into Tbl_MailLog 
		Values (@Request_ID,@Change_ID,@Project,@Subject,@Body,@EmailFrom,@EmailTo,@EmailCC,@Department,(Convert(Varchar,@EmailDate,103) + ' ' + Convert(Varchar(8),@EmailDate,14)),@SMTPIP,@Status)
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Admin
-- --------------------------------------------------













CREATE Proc [dbo].[USP_SendMail_Admin]
--Created By: Mahendra Bonde
as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max)
	declare @HTMLBODY5 nvarchar(max)  
	declare @HTMLBODY6 nvarchar(max) 
	Declare @EmpID AS Char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @Email varchar(100)

	Select RSM.Emp_ID, RSM.Emp_Name, CM.EmailAdd As [EmailAdd]
	Into #ResourceMail
	From Resource_Master RSM, Client_Master CM
	Where RSM.Emp_ID=CM.Emp_ID and RSM.Role_ID in ('AA','SYA') And Active_Status=1

	Set @Count = 0
	Set @Total = (Select Count(Emp_ID) From #ResourceMail)

--	Update #ResourceMail
--	Set EmailAdd='MahendraD.Bonde@angeltrade.com'

	Select * From #ResourceMail
	
	While @Count < @Total
	Begin	
		Set @HTMLBODY1=''
		Set @HTMLBODY2=''
		Set @HTMLBODY3=''
		Set @HTMLBODY4=''
		Set @HTMLBODY5=''
		Set @HTMLBODY6=''

		Set @Email = (Select top 1 EmailAdd From #ResourceMail)
		Set @EmpID = (Select top 1 Emp_id From #ResourceMail)

--		Set @Email = 'MahendraD.Bonde@angeltrade.com'
		
		Select top 1 EmailAdd From #ResourceMail
--		SELECT @Email


		Delete #ResourceMail Where Emp_ID=(Select top 1 Emp_id From #ResourceMail)

		---- ///////////////////////////////  Administrator Mail /////////////////////////////// ----

		--====================== Pending New Request till today ======================--
		Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], 
			Convert(Varchar(10),RM.Request_Date,103) As [RequestDate],
			Convert(Varchar(10),RM.Expected_EDate,103) AS [EndDate],
			CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], CM.Department As [Department]
		Into #ADM_Temp_Mail1
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('PBA') 

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #ADM_Temp_Mail1 ', @HTMLBODY1 output  
		 
		Drop Table #ADM_Temp_Mail1

		if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
		Begin
			set @HTMLBODY6 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Pending New Project Requests</caption>')
		End

		--Mail Code
		
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
		
			Set @HTMLBODY6 = '<HTML><HEAD><TITLE>Pending New Project Requests</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Find below the list of new project requests pending for your approval<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY6 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY6                         
	                        
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                        
				@recipients=@Email,
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Pending New Project Requests',                        
				@body = @HTMLBODY6,                        
				@body_format = 'HTML'         
		End        
		

		--====================== Project Pending For Assign till today ======================--

		Set @HTMLBODY6=''

		Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], 
			Convert(Varchar(10),RM.Request_Date,103) As [RequestDate],
			Convert(Varchar(10),RM.Expected_EDate,103) AS [EndDate],
			CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], CM.Department As [Department]
		Into #ADM_Temp_Mail2
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('ABA')                 
	      
		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From #ADM_Temp_Mail2 order by 1', @HTMLBODY2 output         

		If(@HTMLBODY2 IS NOT NULL And @HTMLBODY2<>'')
		Begin
			set @HTMLBODY6 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Project Pending For Project Manager Delegation</caption>')
		End

		Drop Table #ADM_Temp_Mail2

		--Mail Code
		
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
		
			Set @HTMLBODY6 = '<HTML><HEAD><TITLE>Project Pending For Project Manager Delegation</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Find below the list of projects pending for project manager delegation<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY6+
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY6                         
	                        
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                   
				@recipients=@Email,
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Project Pending For Project Manager Delegation',                        
				@body = @HTMLBODY6,                        
				@body_format = 'HTML'         
		End      


		--====================== Pending Change Request till today ======================--
		Set @HTMLBODY6=''

		Select Distinct CRM.Change_ID As [ChangeID], PM.Project_Name As [Project],
			MM.Module_Name As [Module], 
			ChangeType=(Case When CRM.Change_Type='NR' Then 'New Requirement' When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),
			CM.Emp_Name As [RequestedBY],
			Convert(Varchar(10),CRM.Changed_Date,103) As [RequestDate], 
			Convert(Varchar(10),CRM.Expected_EDate,103) As [EndDate]
		Into #ADM_Temp_Mail3  
		From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
			Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
			CRM.Changed_BY=CM.Emp_ID And
			CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID
			And CRM.Request_Status_ID in ('PBA')
		
		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From #ADM_Temp_Mail3 order by 1',@HTMLBODY3 output                     
	  
		If(@HTMLBODY3 IS NOT NULL And @HTMLBODY3<>'')
		Begin
			set @HTMLBODY6 = Replace(@HTMLBODY3,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Pending New Change Requests</caption>')
		End

		Drop Table #ADM_Temp_Mail3
		--Mail Code
		
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
		
			Set @HTMLBODY6 = '<HTML><HEAD><TITLE>Pending New Change Requests</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Find below the list of new change requests pending for your approvals<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY6 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY6                         
	                        
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                           
				@recipients=@Email,                       
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Pending New Change Requests',                        
				@body = @HTMLBODY6,                        
				@body_format = 'HTML'         
		End      
	     
		--====================== Time Sheet Updation till today ======================--
		Set @HTMLBODY6=''

		Select Resource, Manager, 
		(Case When LastUpdate = '1900-01-01 00:00:00.000' Then '' When LastUpdate<>'1900-01-01 00:00:00.000' Then Convert(Varchar(10),LastUpdate,103) End ) As [LastUpdate], 
		[Status]=(Case When Status_ID='C' Then 'Completed' When Status_ID='P' Then 'Not Started' When Status_ID='W' Then 'In Progress' End)
		Into #ADM_Temp_Mail4
		From 
		(
			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, TM.Last_Update As LastUpdate, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master Where Active_Status=1)
				And (TM.Last_Update Between getdate()-7 And getdate())
				And TM.Status_ID in ('C','W') And RES.Active_Status=1

				Union 

			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, (Case When TM.Last_Update = '1900-01-01 00:00:00.000' Then '' End ) As LastUpdate, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master Where Active_Status=1)
				And TM.Last_Update = '1900-01-01 00:00:00.000' 
				And TM.Status_ID in ('P') And RES.Active_Status=1
				And TM.Assigned_To not in 
				(
					Select Distinct RES.Emp_ID
					From Task_Master TM, Resource_Master RES,Resource_Master RES2
					Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
						And RES2.Emp_ID in (Select Project_Manager From Resource_Master Where Active_Status=1)
						And (TM.Last_Update Between getdate()-7 And getdate())
						And TM.Status_ID in ('C','W')
				)
		) Temp 
		Order By LastUpdate DESC	
		
		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From #ADM_Temp_Mail4 order by 1',@HTMLBODY4 output                     

		If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
		Begin
			set @HTMLBODY6 = Replace(@HTMLBODY4,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Time Sheet Update</caption>')
		End

		Drop Table #ADM_Temp_Mail4
		--Mail Code
		
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
		
			Set @HTMLBODY6 = '<HTML><HEAD><TITLE>Time Sheet</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Please find below the details of timesheet updation of your team members<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY6 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY6                         
	                        
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                            
				@recipients=@Email,                        
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Time Sheet Update',                        
				@body = @HTMLBODY6,                        
				@body_format = 'HTML'         
		End 

		--====================== Time Sheet Details  ======================--
		Set @HTMLBODY6=''

		Select TaskID, Project, Task, [AssignBY], 
			Convert(Varchar(11),ISNULL([AssignedStartDate],''),110) As [AssignedStartDate], 
			Convert(Varchar(11),ISNULL([AssignedEndDate],''),110) As [AssignedEndDate], [Resource], 
			Convert(Varchar(11),ISNULL([ActualStartDate],''),110) As [ActualStartDate], 
			Convert(Varchar(11),Isnull([ActualEndDate],''),110) As [ActualEndDate], 
			Convert(Varchar(11),ISNULL([LastUpdatedOn],''),110) As [LastUpdatedOn], 
			(Case When [ResourceRemark]<>'' Then [ResourceRemark] Else 'No Remark' End) AS [ResourceRemark], Status
		Into #ADM_Temp_Mail5
		From 
		(
			Select TM.Task_ID As TaskID, PM.Project_Name As Project, TM.Task_Name As Task, 
				RSM1.Emp_Name As [AssignBY],  TM.AS_SDT As [AssignedStartDate], TM.AS_EDT As [AssignedEndDate],  
				RSM2.Emp_Name As [Resource] , TM.AC_SDT As [ActualStartDate], TM.AC_EDT As [ActualEndDate],
				TM.Last_Update As [LastUpdatedOn], TM.Remark As [ResourceRemark], 
			(Case When TM.Status_ID in ('P') Then 'Pending'
				When TM.Status_ID in ('W') Then 'Work In Progress' End) AS Status
			From Task_Master TM, Project_Master PM, Resource_Master RSM1, Resource_Master RSM2
			Where TM.Project_ID=PM.Project_ID And TM.Status_ID<>'C' 
				And TM.Assigned_To=RSM2.Emp_ID And TM.Assigned_BY=RSM1.Emp_ID
				And TM.Assigned_BY=@EmpID And RSM1.Active_Status=1 And RSM2.Active_Status=1
		
			UNION
	
			Select TM.Task_ID As TaskID, PM.Project_Name As Project, TM.Task_Name As Task, 
				RSM1.Emp_Name As [AssignBY],  TM.AS_SDT As [AssignedStartDate], TM.AS_EDT As [AssignedEndDate],  
				RSM2.Emp_Name As [Resource] , TM.AC_SDT As [ActualStartDate], TM.AC_EDT As [ActualEndDate],
				TM.Last_Update As [LastUpdatedOn], TM.Remark As [ResourceRemark], 
			(Case When TM.Status_ID in ('C')  Then 'Complete' End) AS Status
			From Task_Master TM, Project_Master PM, Resource_Master RSM1, Resource_Master RSM2
			Where TM.Project_ID=PM.Project_ID And RSM1.Active_Status=1 And RSM2.Active_Status=1
				And TM.Assigned_To=RSM2.Emp_ID And TM.Assigned_BY=RSM1.Emp_ID
				And Convert(Varchar(11),Last_Update,110)=Convert(Varchar(11),getdate(),110)And TM.Assigned_BY=@EmpID
		) Temp2 
		Order By Status Desc

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From #ADM_Temp_Mail5 ',@HTMLBODY5 output                     

		Drop Table #ADM_Temp_Mail5

		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			set @HTMLBODY6 = Replace(@HTMLBODY5,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Today''s Worksheet</caption>')
		End

		--Mail Code
		
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
		
			Set @HTMLBODY6 = '<HTML><HEAD><TITLE>Time Sheet</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Please find below the details of timesheet updation of your team members<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY6 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'

			set @HTMLBODY6 = Replace(@HTMLBODY6,'01-01-1900','Not Started')
		End

		select @HTMLBODY6                         
	                        
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                            
				@recipients=@Email,                        
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Today''s Worksheet',                        
				@body = @HTMLBODY6,                        
				@body_format = 'HTML'         
		End  
     

		Set @Count = @Count + 1
	End

	Drop Table #ResourceMail
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Admin_Test
-- --------------------------------------------------





Create Proc [dbo].[USP_SendMail_Admin_Test]
--Created By: Mahendra Bonde
as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max) 
	declare @HTMLBODY5 nvarchar(max) 
	Declare @Count int 
	Declare @Total int 
	Declare @Email varchar(100)

	Select RSM.Emp_ID, RSM.Emp_Name, CM.EmailAdd
	Into ResourceMail
	From Resource_Master RSM, Client_Master CM
	Where RSM.Emp_ID=CM.Emp_ID and RSM.Role_ID in ('AA','SYA')

	Set @Count = 0
	Set @Total = (Select Count(Emp_ID) From ResourceMail)

		Update ResourceMail
		Set EmailAdd='MahendraD.Bonde@angeltrade.com'
	
	While @Count < @Total
	Begin	
		Set @HTMLBODY1=''
		Set @HTMLBODY2=''
		Set @HTMLBODY3=''
		Set @HTMLBODY4=''
		Set @HTMLBODY5=''

		--Set @Email = (Select top 1 EmailAdd From ResourceMail)
		Set @Email = 'MahendraD.Bonde@angeltrade.com'
		Select top 1 EmailAdd From ResourceMail
		Delete ResourceMail Where Emp_ID=(Select top 1 Emp_id From ResourceMail)

		---- ///////////////////////////////  Administrator Mail /////////////////////////////// ----

		--====================== Pending New Request till today ======================--
		Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], 
			Convert(Varchar(10),RM.Request_Date,103) As [RequestDate],
			Convert(Varchar(10),RM.Expected_EDate,103) AS [EndDate],
			CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], CM.Department As [Department]
		Into ADM_Temp_Mail1
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('PBA')

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From ADM_Temp_Mail1 ', @HTMLBODY1 output  

		Drop Table ADM_Temp_Mail1    

		 
		if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Pending New Project Requests</caption>')
		End

		--Mail Code
		
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Pending New Project Requests</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Find below the list of new project requests pending for your approval<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY5 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				@recipients='MahendraD.Bonde@angeltrade.com',                        
				--@recipients=@Email,
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Pending New Project Requests',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'         
		End        
		

		--====================== Project Pending For Assign till today ======================--

		Set @HTMLBODY5=''

		Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], 
			Convert(Varchar(10),RM.Request_Date,103) As [RequestDate],
			Convert(Varchar(10),RM.Expected_EDate,103) AS [EndDate],
			CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], CM.Department As [Department]
		Into ADM_Temp_Mail2
		From Request_Master RM, Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
			And RM.Request_Status_ID in ('ABA')                 
	      
		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail2 order by 1', @HTMLBODY2 output         
	     
		Drop Table ADM_Temp_Mail2 

		If(@HTMLBODY2 IS NOT NULL And @HTMLBODY2<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Project Pending For Project Manager Delegation</caption>')
		End

		--Mail Code
		
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Project Pending For Project Manager Delegation</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Find below the list of projects pending for project manager delegation<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY5+
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				@recipients='MahendraD.Bonde@angeltrade.com',                   
				--@recipients=@Email,
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Project Pending For Project Manager Delegation',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'         
		End      


		--====================== Pending Change Request till today ======================--
		Set @HTMLBODY5=''

		Select Distinct CRM.Change_ID As [ChangeID], PM.Project_Name As [Project],
			MM.Module_Name As [Module], 
			ChangeType=(Case When CRM.Change_Type='NR' Then 'New Requirement' When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),
			CM.Emp_Name As [RequestedBY],
			Convert(Varchar(10),CRM.Changed_Date,103) As [RequestDate], 
			Convert(Varchar(10),CRM.Expected_EDate,103) As [EndDate]
		Into ADM_Temp_Mail3  
		From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
			Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
			CRM.Changed_BY=CM.Emp_ID And
			CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID
			And CRM.Request_Status_ID in ('PBA')
		
		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail3 order by 1',@HTMLBODY3 output                     
	  
		Drop Table ADM_Temp_Mail3 

		If(@HTMLBODY3 IS NOT NULL And @HTMLBODY3<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY3,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Pending New Change Requests</caption>')
		End

		--Mail Code
		
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Pending New Change Requests</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Find below the list of new change requests pending for your approvals<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY5 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				@recipients='MahendraD.Bonde@angeltrade.com',                           
				--@recipients=@Email,                       
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Pending New Change Requests',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'         
		End      
	     
		--====================== Time Sheet Updation till today ======================--
		Set @HTMLBODY5=''

		Select Resource, Manager, 
		(Case When LastUpdate = '1900-01-01 00:00:00.000' Then '' When LastUpdate<>'1900-01-01 00:00:00.000' Then Convert(Varchar(10),LastUpdate,103) End ) As [LastUpdate], 
		[Status]=(Case When Status_ID='C' Then 'Completed' When Status_ID='P' Then 'Not Started' When Status_ID='W' Then 'In Progress' End)
		Into ADM_Temp_Mail4
		From 
		(
			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, TM.Last_Update As LastUpdate, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
				And (TM.Last_Update Between getdate()-7 And getdate())
				And TM.Status_ID in ('C','W')

				Union 

			Select Distinct RES.Emp_Name As Resource, RES2.Emp_Name As Manager, (Case When TM.Last_Update = '1900-01-01 00:00:00.000' Then '' End ) As LastUpdate, TM.Status_ID
			From Task_Master TM, Resource_Master RES,Resource_Master RES2
			Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
				And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
				And TM.Last_Update = '1900-01-01 00:00:00.000' 
				And TM.Status_ID in ('P')
				And TM.Assigned_To not in 
				(
					Select Distinct RES.Emp_ID
					From Task_Master TM, Resource_Master RES,Resource_Master RES2
					Where TM.Assigned_To=RES.Emp_ID And RES.Project_Manager=RES2.Emp_ID 
						And RES2.Emp_ID in (Select Project_Manager From Resource_Master)
						And (TM.Last_Update Between getdate()-7 And getdate())
						And TM.Status_ID in ('C','W')
				)
		) Temp 
		Order By LastUpdate DESC	
		
		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail4 order by 1',@HTMLBODY4 output                     

		Drop Table ADM_Temp_Mail4 

		If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY4,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Time Sheet Update</caption>')
		End

		--Mail Code
		
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Time Sheet</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Please find below the details of timesheet updation of your team members<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY5 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				@recipients='MahendraD.Bonde@angeltrade.com',                            
				--@recipients=@Email,                        
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Time Sheet Update',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'         
		End      

		Set @Count = @Count + 1
	End

	Drop table ResourceMail
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Developer
-- --------------------------------------------------



CREATE PROC [dbo].[USP_SendMail_Developer]

AS
BEGIN
	
	SELECT CM.Emp_ID, CM.EMP_NAME, cm.emailadd
	INTO #DVL_INFO 
	FROM Client_Master cm 
	WHERE cm.Role_ID IN ('SYA','PM','PL','DVL','DBAPM','DBAPL')
		AND cm.Emp_ID IN (SELECT tm.Assigned_To FROM Task_Master tm
								WHERE (Convert(VARCHAR(11),tm.AS_EDT,110)=Convert(Varchar(11),GETDATE(),110)
								OR Convert(VARCHAR(11),tm.AS_EDT,110)=Convert(Varchar(11),GETDATE()+1,110))
								)
	ORDER BY cm.EMP_NAME
		
	DECLARE @EMP_ID AS CHAR(10)
	DECLARE @EMP_Name AS VARCHAR(100)
	DECLARE @Total AS INT
	DECLARE @Count AS INT
	DECLARE @EMail AS VARCHAR(100)
	DECLARE @HTMLBODY1 VARCHAR(max)         
 	DECLARE @HTMLBODY5 VARCHAR(max)
	
	SET @Total = (SELECT COUNT(EMP_ID) FROM #DVL_INFO)
	
	SET @Count = 0
	--SET @EMail='MahendraD.Bonde@angeltrade.com'
	SET @EMail=''
	SET	@EMP_ID = ''
	SET @EMP_Name = ''
	SET @HTMLBODY1 = ''
	SET @HTMLBODY5 = ''

	WHILE (@Count < @Total)
	BEGIN
		SET @HTMLBODY1 = ''
		SET @HTMLBODY5 = ''
		
		SET @EMP_ID = (SELECT TOP 1 EMP_ID FROM #DVL_INFO)
		SET	@EMP_Name = (SELECT TOP 1 EMP_NAME FROM #DVL_INFO)	
		SET @EMail = (SELECT TOP 1 EMAILADD FROM #DVL_INFO)

		SELECT @EMP_Name
		SELECT @EMail

		SELECT  tm.Task_ID AS [Task_ID], pm.Project_Name AS [Project], mm.Module_Name AS [Module], 
			tm.Task_Name AS [Task], tm.Task_Detail AS [Description], rm.Emp_Name AS [Assigned_BY], 
			Convert(Varchar(11),tm.AS_SDT,113) AS [Assign_Start_Date], 
			Convert(Varchar(11),tm.AS_EDT,113) AS [Assign_End_Date], tsm.Task_Status_Name AS [Status]
		INTO #DVL_DATA
		FROM Task_Master tm, Project_Master pm, Module_Master mm, Task_Status_Master tsm, Resource_Master rm
		WHERE tm.Project_ID=pm.Project_ID AND tm.Module_ID=mm.Module_ID AND tm.Status_ID=tsm.Task_Status_ID
			AND tm.Assigned_By=rm.Emp_ID AND tm.Status_ID IN ('P','W') AND 
			(Convert(VARCHAR(11),tm.AS_EDT,110)=Convert(Varchar(11),GETDATE(),110)
				OR Convert(VARCHAR(11),tm.AS_EDT,110)=Convert(Varchar(11),GETDATE()+1,110))
			AND tm.Assigned_To=@EMP_ID And rm.Active_Status=1
		Order By STATUS ASC
		
		---SELECT * FROM #DVL_DATA
		
		IF EXISTS(SELECT TOP 1 TASK_ID FROM #DVL_DATA)
		BEGIN
			exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From #DVL_DATA ',@HTMLBODY1 output                     
		END
		
		DROP TABLE #DVL_DATA
		
		SELECT @HTMLBODY1

		If(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''1050px''><caption>PRMS - Pending Task Alerts</caption>')
			set @HTMLBODY5 = Replace(@HTMLBODY5,'<th >Task_ID</th>','<th width="75px">Task_ID</th>')
			set @HTMLBODY5 = Replace(@HTMLBODY5,'<th >Project</th>','<th width="150px">Project</th>')
			set @HTMLBODY5 = Replace(@HTMLBODY5,'<th >Description</th>','<th width="30%">Description</th>')
			set @HTMLBODY5 = Replace(@HTMLBODY5,'<th >Assign_Start_Date</th>','<th width="100px">Assign Start Date</th>')
			set @HTMLBODY5 = Replace(@HTMLBODY5,'<th >Assign_End_Date</th>','<th width="100px">Assign End Date</th>')
			
		End

		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Time Sheet</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 1050px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear ' + @EMP_Name + ',<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;Following are the task pending for complete by today or tomorrow end of day.<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY5 +
					'</center></Div></center><BR><BR>*This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                            
				@recipients=@Email,                        
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Pending Task Alerts',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'         
		End

		DELETE #DVL_INFO
		WHERE EMP_ID=@EMP_ID

		SET @Count = @Count + 1
	END
	
	DROP TABLE #DVL_INFO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Usp_SendMAil_FeedbackPending
-- --------------------------------------------------




-- =============================================
-- Author:		<Rihab Rebello>
-- Create date: <15/10/2010>
-- Description:	<Feedback Mail>
-- =============================================
CREATE PROCEDURE [dbo].[Usp_SendMAil_FeedbackPending]

AS
BEGIN
	
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max) 
	declare @HTMLBODY5 nvarchar(max) 
	Declare @Count int 
	Declare @Total int 
	Declare @Email varchar(100)
	Declare @RID as char(10)
	Declare @POEmail as varchar(50)
	Declare @PCEmail as varchar(50)
	Declare @PMEmail as varchar(50)
	Declare @HODEmail as varchar(50)
	Declare @ADMEmail as varchar(50)

	Set @Count = 0
	

	Select Request_ID As [Request_ID] into #ReqIDtemp 
	From Project_Master 
	where Status = 'C' And Convert(varchar(11),AS_EDate,113) = Convert(Varchar(11),(getdate() - 7) ,113)

	Set @Total = (Select Count(Request_ID) From #ReqIDtemp)
		
	While (@Count < @Total)
	Begin	
		
		set @RID = (Select top 1 Request_ID from #ReqIDtemp) 

		Select  @PCEmail = CM1.Emailadd, @POEmail = CM2.Emailadd 
		From Request_Master RM, Coordinator_Master COM1, Client_Master CM1, 
				Client_Master CM2
		Where RM.Request_ID=@RID  And
			RM.Request_ID=COM1.Request_ID And COM1.Role_ID='PO' And
			RM.Requested_BY=CM1.Emp_ID And COM1.Employee_ID=CM2.Emp_ID

		Select @PMEmail = CM1.Emailadd , @HODEmail = CM2.EmailAdd 
		From Request_Master RM, Project_Master PM, Client_Master CM1, Client_Master CM2
		Where RM.Request_ID=@RID And RM.Request_ID=PM.Request_ID  And
			 PM.Project_Manager=CM1.Emp_ID And CM1.HOD=CM2.Emp_ID

		Select @AdmEmail = CM.Emailadd From Client_Master CM
		Where CM.Role_ID='AA'

		Declare @PName as varchar(50)
		Declare @RBy as varchar(25)
		Declare @Desc as varchar(500)
		Declare @PM as varchar(25)
		Declare @RDate as varchar(12)
		Declare @Comp as varchar(12)

		Select @RID = RM.Request_ID  ,@PName = PM.Project_Name ,@RBy = CM.Emp_Name ,
			@RDate = Convert(varchar(12), RM.Request_Date,113) ,
			@Desc = RM.Brief_Requirement,
			@PM = RSM.Emp_Name ,
			@Comp = Convert(Varchar(12),PM.AS_EDate,113) 			
		From Project_Master PM,Request_Master RM,Resource_MAster RSM1,Resource_MAster RSM,Client_MAster CM,Client_MAster CM1
		Where  RM.Request_ID=PM.Request_ID and RM.Request_Status_ID = PM.Status			
			and RM.HOD_Approve = CM1.Emp_Id	and PM.Project_MAnager = RSM.Emp_ID
			and RM.Admin_Approve = RSM1.Emp_ID and RM.Requested_By = CM.Emp_ID
			and Convert(varchar(11),PM.As_EDate,113) = Convert(Varchar(11),(getdate() - 7) ,113)
			and PM.Status = 'C' and RM.Request_ID =@RID
			
		

				
			set @HTMLBODY1 = '<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''>'+
							'<caption> Feedback Pending </caption>'+ 
							'<tr><td width = 10px> Request_ID </td><td>' + @RID + '</td>'+
							'<td width = 10px> Project_Name </td><td>'+ @PName +'</td>'+
							'</tr>'+
							'<tr><td width = 10px>Requested_By</td><td >'+ @RBy +'</td>'+
							'<td width = 10px>Request_Date</td><td>'+ @RDate +'</td>'+
							'</tr>'+
							'<tr><td width = 10px>Project_Manager</td><td>'+ @PM +'</td>'+
							'<td width = 10px> Project_Completion_Date </td><td>'+ @Comp +'</td>'+
							'</tr>'+
							'<tr><td width = 10px> Requirement Description </td><td colspan = 3>'+ @Desc +'</td></tr>'+
							'</table>' 		
				
		--Mail Code

		If(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE> Feedback Pending For Project '+ @PName +' </TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR> &nbsp&nbsp&nbsp&nbsp Your request for Project <b>" '+ @PName +' "</b> ( Request ID : '+ @RID +' ) is successfully completed. '+
					'<BR><BR> Angel Broking BIA department is committed to providing the best possible service, quality, and application to meet our Angel CSO team needs and requirements.'+
					'In order to achieve this, we invite you to kindly complete the feedback of delivered project.'+
					'The information will be provided to Our Business Manager, Head of the Departments and to the Projects Leaders. <BR><BR>' +
					'<center><Div><center>' + @HTMLBODY1 + 
					'</center></Div></center> <BR><BR> &nbsp&nbsp&nbsp&nbsp&nbsp Kindly login into PRMS System and provide your valuable feedback. '+
					'<BR><BR> This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR> Software Team <BR></Body></HTML>'
		End

		Declare @Sub Varchar(500)
		Set @Sub = (Select 'PRMS - Feedback Pending ' + @PName + '( Request ID : ' + @RID + ')')

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail               
				@profile_name = 'Prms_alert',               
				--@recipients='MahendraD.Bonde@angeltrade.com',                        
				@recipients=@PCEmail,
				@recipients = @POEmail,
				@copy_recipients =@PMEmail,                      
				@copy_recipients =@HODEmail,                       
				@copy_recipients =@ADMEmail,
				@subject = @Sub,
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'

			Update Request_Master
			Set Request_Status_ID='FP'
			Where Request_ID=@RID

			Update Project_Master
			Set Status='FP'
			Where Request_ID=@RID

		End        

		delete from #ReqIDtemp where Request_ID = @RID
		Set @Count = @Count + 1

	End

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Leader
-- --------------------------------------------------






CREATE Proc [dbo].[USP_SendMail_Leader]
--Created By: Mahendra Bonde
as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max) 
	declare @HTMLBODY5 nvarchar(max) 
	declare @Role char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @Email varchar(100)
	Declare @Emp char(10)


	Select RSM.Emp_ID, RSM.Emp_Name, CM.EmailAdd As [EmailAdd]
	Into #ResourceMail_Manager
	From Resource_Master RSM, Client_Master CM
	Where RSM.Emp_ID=CM.Emp_ID and RSM.Role_ID in ('PL') And Active_Status=1


--		Select * From #ResourceMail_Manager

	Set @Count = 0
	Set @Total = (Select Count(Emp_ID) From #ResourceMail_Manager)
	Set @Total = 3
--	Update #ResourceMail_Manager
--	Set EmailAdd='MahendraD.Bonde@angeltrade.com'
	
	While @Count < @Total
	Begin	

		Set @HTMLBODY1=''
		Set @HTMLBODY5=''
		Set @HTMLBODY2=''
		Set @Role = ''

		Set @Email = (Select top 1 EmailAdd From #ResourceMail_Manager Order By Emp_ID)

--		Set @Email = 'MahendraD.Bonde@angeltrade.com'
		Set @Emp = (Select top 1 Emp_ID From #ResourceMail_Manager Order By Emp_ID)

		Set @Role = (Select Role_ID From client_Master Where Emp_ID in (Select top 1 Emp_ID From #ResourceMail_Manager))
		--Set @Email = 'MahendraD.Bonde@angeltrade.com'

		Select top 1 EmailAdd From #ResourceMail_Manager


		Delete #ResourceMail_Manager Where Emp_ID=(Select top 1 Emp_id From #ResourceMail_Manager Order By Emp_ID)

		---- ///////////////////////////////  Leader Mail /////////////////////////////// ----
		
		--================================== Time Sheet Details  ==================================--
		Set @HTMLBODY5=''

		Select TaskID, Project, Task, [AssignBY], 
			Convert(Varchar(11),ISNULL([AssignedStartDate],''),110) As [AssignedStartDate], 
			Convert(Varchar(11),ISNULL([AssignedEndDate],''),110) As [AssignedEndDate], [Resource], 
			Convert(Varchar(11),ISNULL([ActualStartDate],''),110) As [ActualStartDate], 
			Convert(Varchar(11),Isnull([ActualEndDate],''),110) As [ActualEndDate], 
			Convert(Varchar(11),ISNULL([LastUpdatedOn],''),110) As [LastUpdatedOn], 
			(Case When [ResourceRemark]<>'' Then [ResourceRemark] Else 'No Remark' End) AS [ResourceRemark], Status
		Into #MGR_Temp_Mail2
		From 
		(
			Select TM.Task_ID As TaskID, PM.Project_Name As Project, TM.Task_Name As Task, 
				RSM1.Emp_Name As [AssignBY],  TM.AS_SDT As [AssignedStartDate], TM.AS_EDT As [AssignedEndDate],  
				RSM2.Emp_Name As [Resource] , TM.AC_SDT As [ActualStartDate], TM.AC_EDT As [ActualEndDate],
				TM.Last_Update As [LastUpdatedOn], TM.Remark As [ResourceRemark],
			(Case When TM.Status_ID in ('P') Then 'Pending'
				When TM.Status_ID in ('W') Then 'Work In Progress' End) AS Status
			From Task_Master TM, Project_Master PM, Resource_Master RSM1, Resource_Master RSM2
			Where TM.Project_ID=PM.Project_ID And TM.Status_ID<>'C' 
				And TM.Assigned_To=RSM2.Emp_ID And TM.Assigned_BY=RSM1.Emp_ID
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=@Emp )			
		
			UNION
	
			Select TM.Task_ID As TaskID, PM.Project_Name As Project, TM.Task_Name As Task, 
				RSM1.Emp_Name As [AssignBY],  TM.AS_SDT As [AssignedStartDate], TM.AS_EDT As [AssignedEndDate],  
				RSM2.Emp_Name As [Resource] , TM.AC_SDT As [ActualStartDate], TM.AC_EDT As [ActualEndDate],
				TM.Last_Update As [LastUpdatedOn], TM.Remark As [ResourceRemark], 
			(Case When TM.Status_ID in ('C')  Then 'Complete' End) AS Status
			From Task_Master TM, Project_Master PM, Resource_Master RSM1, Resource_Master RSM2
			Where TM.Project_ID=PM.Project_ID 
				And TM.Assigned_To=RSM2.Emp_ID And TM.Assigned_BY=RSM1.Emp_ID
				And Convert(Varchar(11),Last_Update,110)=Convert(Varchar(11),getdate(),110)
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=@Emp)
		) Temp2 
		Order By Status Desc

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From #MGR_Temp_Mail2 ',@HTMLBODY2 output                     

		If(@HTMLBODY2 IS NOT NULL And @HTMLBODY2<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Today''s Worksheet</caption>')
			set @HTMLBODY5 = Replace(@HTMLBODY5,'01-01-1900','Not Started')
		End

		Drop Table #MGR_Temp_Mail2
		--Mail Code
		
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Time Sheet</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Please find below the details of timesheet of your team members<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY5 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                            
				@recipients=@Email,                        
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Today''s Worksheet',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'         
		End

		Set @Count = @Count + 1
	End

	Drop Table #ResourceMail_Manager
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Manager
-- --------------------------------------------------






CREATE Proc [dbo].[USP_SendMail_Manager]
--Created By: Mahendra Bonde
as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max) 
	declare @HTMLBODY5 nvarchar(max) 
	declare @Role char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @Email varchar(100)
	Declare @Emp char(10)


	Select RSM.Emp_ID, RSM.Emp_Name, CM.EmailAdd As [EmailAdd]
	Into #ResourceMail_Manager
	From Resource_Master RSM, Client_Master CM
	Where RSM.Emp_ID=CM.Emp_ID and RSM.Role_ID in ('PM','DBAPM') And Active_Status=1

	Set @Count = 0
	Set @Total = (Select Count(Emp_ID) From #ResourceMail_Manager)

--	Update #ResourceMail_Manager
--	Set EmailAdd='MahendraD.Bonde@angeltrade.com'
	
	While @Count < @Total
	Begin	

		Set @HTMLBODY1=''
		Set @HTMLBODY5=''
		Set @HTMLBODY2=''
		Set @Role = ''

		Set @Email = (Select top 1 EmailAdd From #ResourceMail_Manager Order By Emp_ID)
		Set @Emp = (Select top 1 Emp_ID From #ResourceMail_Manager Order By Emp_ID)

		Set @Role = (Select Role_ID From client_Master Where Emp_ID in (Select top 1 Emp_ID From #ResourceMail_Manager))
		--Set @Email = 'MahendraD.Bonde@angeltrade.com'

		Select top 1 EmailAdd From #ResourceMail_Manager

		Delete #ResourceMail_Manager Where Emp_ID=(Select top 1 Emp_id From #ResourceMail_Manager Order By Emp_ID)

		---- ///////////////////////////////  Manager Mail /////////////////////////////// ----

		--====================== Pending Change Request till today ======================--
		Select Distinct CRM.Change_ID As [ChangeID], PM.Project_Name As [Project],
			MM.Module_Name As [Module], 
			ChangeType=(Case When CRM.Change_Type='NR' Then 'New Requirement' When CRM.Change_Type='CER' Then 'Change In Existing Requirement' End),
			CM.Emp_Name As [RequestedBY],
			Convert(Varchar(10),CRM.Changed_Date,103) As [RequestDate], 
			Convert(Varchar(10),CRM.Expected_EDate,103) As [EndDate]
		Into #MGR_Temp_Mail1
		From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
			Client_Master CM, 
			Client_Master CM2, Request_Status_Master RSM	
		Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
			CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID And
			CRM.Request_Status_ID in ('PBA') and CRM.Changed_BY=CM.Emp_ID 
			And CRM.Project_ID in (Select Distinct Project_ID From Project_Master Where Project_Manager=@Emp)
			And 'PM' in (Select Role_ID From Resource_Master Where Emp_ID=@Emp And Active_Status=1)

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #MGR_Temp_Mail1 ', @HTMLBODY1 output  

		Drop Table #MGR_Temp_Mail1 

		if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Pending New Change Requests</caption>')
		End

		--Mail Code
		
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Pending New Change Requests</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Find below the list of new change requests pending for your approvals<BR><BR>' + 
					'<center><Div><center>' + @HTMLBODY5 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='jayk.khare@angeltrade.com',                        
				@recipients=@Email,
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Pending New Change Requests',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'     

			Insert Into Tbl_Summary_LogMail
			Values ('Prms_alert',@Role,@Email,'PRMS - Pending New Change Requests',@HTMLBODY5,getdate())    
		End        
				
		--================================== Time Sheet Details  ==================================--
		Set @HTMLBODY5=''

		Select TaskID, Project, Task, [AssignBY], 
			Convert(Varchar(11),ISNULL([AssignedStartDate],''),110) As [AssignedStartDate], 
			Convert(Varchar(11),ISNULL([AssignedEndDate],''),110) As [AssignedEndDate], [Resource], 
			Convert(Varchar(11),ISNULL([ActualStartDate],''),110) As [ActualStartDate], 
			Convert(Varchar(11),Isnull([ActualEndDate],''),110) As [ActualEndDate], 
			Convert(Varchar(11),ISNULL([LastUpdatedOn],''),110) As [LastUpdatedOn], 
			(Case When [ResourceRemark]<>'' Then [ResourceRemark] Else 'No Remark' End) AS [ResourceRemark], Status
		Into #MGR_Temp_Mail2
		From 
		(
			Select TM.Task_ID As TaskID, PM.Project_Name As Project, TM.Task_Name As Task, 
				RSM1.Emp_Name As [AssignBY],  TM.AS_SDT As [AssignedStartDate], TM.AS_EDT As [AssignedEndDate],  
				RSM2.Emp_Name As [Resource] , TM.AC_SDT As [ActualStartDate], TM.AC_EDT As [ActualEndDate],
				TM.Last_Update As [LastUpdatedOn], TM.Remark As [ResourceRemark],
			(Case When TM.Status_ID in ('P') Then 'Pending'
				When TM.Status_ID in ('W') Then 'Work In Progress' End) AS Status
			From Task_Master TM, Project_Master PM, Resource_Master RSM1, Resource_Master RSM2
			Where TM.Project_ID=PM.Project_ID And TM.Status_ID<>'C' 
				And TM.Assigned_To=RSM2.Emp_ID And TM.Assigned_BY=RSM1.Emp_ID
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp And Active_Status=1)			
				And RSM1.Active_Status=1 And RSM2.Active_Status=1
			UNION
	
			Select TM.Task_ID As TaskID, PM.Project_Name As Project, TM.Task_Name As Task, 
				RSM1.Emp_Name As [AssignBY],  TM.AS_SDT As [AssignedStartDate], TM.AS_EDT As [AssignedEndDate],  
				RSM2.Emp_Name As [Resource] , TM.AC_SDT As [ActualStartDate], TM.AC_EDT As [ActualEndDate],
				TM.Last_Update As [LastUpdatedOn], TM.Remark As [ResourceRemark], 
			(Case When TM.Status_ID in ('C')  Then 'Complete' End) AS Status
			From Task_Master TM, Project_Master PM, Resource_Master RSM1, Resource_Master RSM2
			Where TM.Project_ID=PM.Project_ID 
				And TM.Assigned_To=RSM2.Emp_ID And TM.Assigned_BY=RSM1.Emp_ID
				And Convert(Varchar(11),Last_Update,110)=Convert(Varchar(11),getdate(),110)
				And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=@Emp And Active_Status=1)
				And RSM1.Active_Status=1 And RSM2.Active_Status=1
		) Temp2 
		Order By Status Desc

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From #MGR_Temp_Mail2 ',@HTMLBODY2 output                     

		If(@HTMLBODY2 IS NOT NULL And @HTMLBODY2<>'')
		Begin
			set @HTMLBODY5 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Today''s Worksheet</caption>')
		End

		Drop Table #MGR_Temp_Mail2
		--Mail Code
		
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
		
			Set @HTMLBODY5 = '<HTML><HEAD><TITLE>Time Sheet</TITLE><STYLE TYPE=''text/css''>' +
					'.MyTable{width: 850px; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
					'.MyTable td{width: auto; border-right: black 1px solid; border-top: black 1px solid; font-size: 0.8em; vertical-align: middle; border-left: black 1px solid; color: black; border-bottom: black 1px solid; font-family: Verdana; background-color: White; text-align: left; height: 18px;}' +
					'.MyTable caption{font-size: 0.9em; color: White; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
					'.MyTable th{background-color: #95B3D7;border-style : solid;border-color : Black; border-width:1px;}' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Please find below the details of timesheet updation of your team members<BR><BR>' +
					'<center><Div><center>' + @HTMLBODY5 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'

			set @HTMLBODY5 = Replace(@HTMLBODY5,'01-01-1900','Not Started')
		End

		select @HTMLBODY5                         
	                        
		If(@HTMLBODY5 IS NOT NULL And @HTMLBODY5<>'')
		Begin
			EXEC msdb.dbo.sp_send_dbmail                         
				@profile_name = 'Prms_alert',                        
				--@recipients='MahendraD.Bonde@angeltrade.com',                            
				@recipients=@Email,                        
				--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
				@subject = 'PRMS - Today''s Worksheet',                        
				@body = @HTMLBODY5,                        
				@body_format = 'HTML'         
		End

		Set @Count = @Count + 1
	End

	Drop Table #ResourceMail_Manager
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Productivity
-- --------------------------------------------------


CREATE Proc [dbo].[USP_SendMail_Productivity]
-------------------------------------------------------------------------------------------------------
--Created By	: Mahendra Bonde
--Created On	: 20/10/2010
--Modified by	:
--Modified On	:
--Description	: Last Week Team Productivity Report Of Mail for Admin On Each Monday At 8:00 AM.
--				  And Last week Team(Resource) Productivity Mail For Project Manager On Each monday At 8:00AM
--				  And Last week Team(Resource) Productivity Mail For Software Analyst (Report of respective Project Manager) On Each monday At 8:00AM
-------------------------------------------------------------------------------------------------------

as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max)
	declare @HTMLBODY5 nvarchar(max)  
	declare @HTMLBODY6 nvarchar(max) 
	Declare @EmpID AS Char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @AdmEmail varchar(100)
	Declare @Email varchar(100)
	Declare @Month Varchar(20)
	Declare @CC Varchar(100)
	set @HTMLBODY6 = ''

	Set @AdmEmail = (Select EmailAdd From Client_Master Where Role_ID='AA')
	
	Declare @FromDate AS Datetime
	Declare @EndDate AS Datetime
	Declare @TW As INT

	set @Month = (Select DATENAME(month,getdate()))

	Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
	--Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)	

	Set @EndDate = CONVERT(Varchar(12), Getdate(), 110)
	
	Set @TW = (Select dbo.GetTotalWorkingDays(@FromDate,@EndDate)) 


	Select PM As PM_T, TW As TW_T, TWD As TWD_T, Resources AS Res_T, TWH As TWH_T, TAT As TAT_T, 
			TUT As TUT_T, PER_PM As PRM_T, TP As TP_T
	Into #Productivity_ADM
	From
	(
		Select PM, Emp_ID, TW, TWD, Resources, TWH, TAT, TUT, PER_PM, TP, 'A' Flag
		From
		(
			Select Emp_Name AS PM, Emp_ID, TW, TWD, Resources, TWH, 
					(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
					(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT] , 
					(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
					(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
					--When (TUT > TAT And TAT<>0) Then CAST(((TAT-TUT)/ 100) AS DECIMAL(10,2)) 
						When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
						Else 0 End) AS [TP] 
			From
			(
				Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TW],
					  (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
					(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
					(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
						Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
					)AS [TWH], 
					ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								 Union Select RSM.Emp_ID)
						  ),0) As TAT,
					ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								 Union Select RSM.Emp_ID)
						  ),0) As TUT
				From Resource_Master RSM
				Where Role_ID in ('PM') And Active_Status=1
				Group By RSM.Emp_Name, RSM.Emp_ID
			) T
		)T

		UNION

		Select  'Total' AS PM,'' AS Emp_ID, TW, '' As TWD, Resources, TWH,
			(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT] ,
			(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT],
			(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
			(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
				When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
				Else 0 End) AS [TP], 
			'B' As Flag
		From
		(
			Select SUM(Resources) AS Resources, TW As [TW], SUM(TWD) As TWD ,SUM(TWH) AS TWH,
				SUM(TAT) AS TAT,SUM(TUT) AS TUT, SUM(PER_PM) AS PER_PM, SUM(TP) AS TP, 'B' Flag
			From 
			(
				Select TWD, Resources, [TW], TWH, TAT, TUT, 
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
						When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
							Else 0 End) AS [TP] 
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW AS [TW],
						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
						(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
						(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
							Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
						)AS [TWH], 
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
									 Union Select RSM.Emp_ID)
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
									 Union Select RSM.Emp_ID)
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PM') And Active_Status=1
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T 
			) T group By TW
		)T
	) T
	Order By Flag, PM
	
	

--	Select * From #Productivity_ADM

	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #Productivity_ADM ', @HTMLBODY1 output  
		 
	

	if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
	Begin
		set @HTMLBODY6 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''pretty-table'' cellpadding=''0'' cellspacing=''0'' width=''800px''><caption>Team Productivity</caption>')
	End

	Select @AdmEmail

	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
	Begin

		Set @HTMLBODY6 =  '<HTML><HEAD><TITLE>Team Productivity Report of the month ' 
						+ (Select DATENAME(Month,getdate()) + ',' + DATENAME(Year,getdate()))  + 
						', (From '  + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
						'to' + (Select CONVERT(Varchar(12),getdate()-1,113)) + ')' +
						'</TITLE><STYLE TYPE=''text/css''>' +
						'.pretty-table { padding: 0;  margin: 0;  border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  font-family: Arial; font-size: 0.8em; background: #bcd0e4 top left repeat-x; } ' +
						'.pretty-table caption {  caption-side: top;  font-weight:bold; font-size: 1.3em; text-align: Center;  padding: 0.5em 0; Color:White;} ' +
						'.pretty-table td {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  color: #632a39;} ' +
						'.pretty-table th {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  Color:White}' +
						'.pretty-table tr:hover th[scope=row], ' +
						'.pretty-table tr:hover td {  background-color: #632a2a;  color: #fff;} ' +
						'.pretty-table th{ background-color: #997700 } ' +
				'</STYLE></HEAD><Body> <br>' +
				'Dear Sir/Madam,<BR><BR>Kindly find below the Team Productivity Report of the month ' + (Select DATENAME(Month,getdate()) + ',' + DATENAME(Year,getdate()))  + 
				', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
				'to' + (Select CONVERT(Varchar(12),getdate()-1,113)) + ').<BR><BR>' +
				'<center><div width=''980px''><center>' + @HTMLBODY6 +
				'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
				'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'

		set @HTMLBODY6 = Replace(@HTMLBODY6,'PM_T','Project Manager')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TW_T','Total Working Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWD_T','Total Harmony Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'Res_T','Resource')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWH_T','Total Working Hours (In Hrs:Min)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TAT_T','Total Assign Time')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TUT_T','Total Utilization Time ')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'PRM_T','Performance (In %)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TP_T','Team Productivity (In %)')

	End

	select @HTMLBODY6                         
	                        
	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
	Begin
		EXEC msdb.dbo.sp_send_dbmail                         
			@profile_name = 'Prms_alert',                        
			@recipients='MahendraD.Bonde@angeltrade.com',                        
			--@recipients=@AdmEmail,
--			@recipients='Anand.Diwan@angeltrade.com',
--			@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
			@subject = 'PRMS - Team Productivity Report',                        
			@body = @HTMLBODY6,                        
			@body_format = 'HTML'         
	End   


---------------------------------------------- PM Mail --------------------------------------------------
	Declare @PM As Varchar(20)

	Select RSM.Emp_ID, RSM.Emp_Name, CM.EmailAdd, CM.Role_ID
	Into #ManagerMail
	From Resource_Master RSM, Client_Master CM
	Where RSM.Emp_ID=CM.Emp_ID and RSM.Role_ID in ('PM') And Active_Status=1

	Set @Count = 0
	Set @Total = (Select Count(Emp_ID) From #ManagerMail)

	
	While(@Count < @Total) 
	Begin
		Set @CC = ''
		Set @HTMLBODY6 = ''
		Set @HTMLBODY1 = ''

		Set @PM = (Select top 1 Emp_ID From #ManagerMail)

		If((Select top 1 Emp_ID From #ManagerMail) = 'E03446' or (Select top 1 Emp_ID From #ManagerMail) = 'E31226' or (Select top 1 Emp_ID From #ManagerMail) = 'E21209')
		Begin	
			Set @CC = 'Anand.Diwan@angeltrade.com'
		End
		Else If((Select top 1 Emp_ID From #ManagerMail) = 'E05205' )
		Begin	
			Set @CC = 'manesh@angeltrade.com'
		End
		Else If((Select top 1 Emp_ID From #ManagerMail) = 'E02031' )
		Begin	
			Set @CC = 'MilanD.Shah@angeltrade.com'
		End	
		Else If((Select top 1 Emp_ID From #ManagerMail) = 'E08708' )
		Begin	
			Set @CC = 'bghanekar@angeltrade.com'
		End	

		--Set @CC = 'MahendraD.Bonde@angeltrade.com' 

		Select Res AS PM_T, TW AS TW_T, TWD AS TWD_T, TWH As TWH_T, TAT AS TAT_T, TUT As TUT_T, 
				PER_PM AS PRM_T, Productivity As TP_T 
		Into #Productivity_Manager
		From
		(
			Select RES, EMP_ID, TW, TWD, TWH, TAT, TUT, PER_PM, Productivity, 'A' AS Flag 
			From 
			(	
				Select Emp_Name As RES, Emp_ID, TW, TWD, TWH, 
						(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
						(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
						When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
						Else 0 End) AS [Productivity]
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As TW,
						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],  
						(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To=	RSM.Emp_ID
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To = RSM.Emp_ID
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PL','DVL') And RSM.Project_Manager=@PM   
						And Active_Status=1 
					Group By RSM.Emp_Name, RSM.Emp_ID

				) T
			) T

			Union 

			Select 'Total' AS Res, '' AS Emp_ID, TW, '' As TWD, TWH, 
				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
				(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
					When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
					Else 0 End) AS [Productivity],
				 'B' AS Flag 
			From
			(
				Select TW, TWD, TWH, TAT, TUT, PER_PM, Productivity
				From 
				(
					Select TW, SUM(TWD) AS TWD, SUM(TWH) AS TWH, SUM(TAT) AS TAT, SUM(TUT) AS TUT, 
							SUM(PER_PM) AS PER_PM, SUM(Productivity) AS Productivity
					From		
					(
						Select TW, TWD, TWH, TAT, TUT,
							(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
							(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
								When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
								Else 0 End) AS [Productivity]
						From
						(
							Select @TW AS [TW], (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
								 (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To=	RSM.Emp_ID
									  ),0) As TAT,
								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To = RSM.Emp_ID
									  ),0) As TUT
							From Resource_Master RSM
							Where Role_ID in ('PL','DVL') And RSM.Project_Manager=@PM  
								And Active_Status=1 
							Group By Emp_ID
						) T
					) T	Group By TW
				)T 
			)T
		) T
		Order By Flag

		Select top 1 * From #ManagerMail

--		Select * From #Productivity_Manager

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #Productivity_Manager ', @HTMLBODY1 output  
 	
	
		if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
		Begin
			set @HTMLBODY6 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''pretty-table'' cellpadding=''0'' cellspacing=''0'' width=''700px''><caption>Team Productivity</caption>')
		End
			
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
	
			Set @HTMLBODY6 = '<HTML><HEAD><TITLE>Team Productivity Report of the month ' 
						+ (Select DATENAME(Month,getdate()) + ',' + DATENAME(Year,getdate()))  + 
						', (From '  + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
						'to' + (Select CONVERT(Varchar(12),getdate()-1,113)) + ')' +
						'</TITLE><STYLE TYPE=''text/css''>' +
						'.pretty-table { padding: 0;  margin: 0;  border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  font-family: Arial; font-size: 0.8em; background: #bcd0e4 top left repeat-x; } ' +
						'.pretty-table caption {  caption-side: top;  font-weight:bold; font-size: 1.3em; text-align: Center;  padding: 0.5em 0; Color:White;} ' +
						'.pretty-table td {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  color: #632a39;} ' +
						'.pretty-table th {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  Color:White}' +
						'.pretty-table tr:hover th[scope=row], ' +
						'.pretty-table tr:hover td {  background-color: #632a2a;  color: #fff;} ' +
						'.pretty-table th{ background-color: #997700 } ' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Kindly find below the Team Productivity Report of the month ' + (Select DATENAME(Month,getdate()) + ',' + DATENAME(Year,getdate()))  + 
					', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
					'to' + (Select CONVERT(Varchar(12),getdate()-1,113)) + ').<BR><BR>' +
					'<center><div width=''980px''>' + @HTMLBODY6 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
	
			set @HTMLBODY6 = Replace(@HTMLBODY6,'PM_T','Project Manager')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'TW_T','Total Working Days')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'TWD_T','Total Harmony Days')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'Res_T','Resource')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'TWH_T','Total Working Hours (In Hrs:Min)')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'TAT_T','Total Assign Time')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'TUT_T','Total Utilization Time ')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'PRM_T','Performance (In %)')
			set @HTMLBODY6 = Replace(@HTMLBODY6,'TP_T','Team Productivity (In %)')
	
		End
	
		select @HTMLBODY6                         
            
		If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
		Begin
			IF(@CC <> '')
			Begin
				EXEC msdb.dbo.sp_send_dbmail                         
					@profile_name = 'Prms_alert',                        
					@recipients='MahendraD.Bonde@angeltrade.com',                        
					--@recipients=@Email,
					--@copy_recipients =@CC,                        
					@subject = 'PRMS - Team Productivity Report',                        
					@body = @HTMLBODY6,                        
					@body_format = 'HTML'
			End
			Else IF(@CC = '')
			Begin
				EXEC msdb.dbo.sp_send_dbmail                         
					@profile_name = 'Prms_alert',                        
					@recipients='MahendraD.Bonde@angeltrade.com',                        
					--@recipients=@Email,
					@subject = 'PRMS - Team Productivity Report',                        
					@body = @HTMLBODY6,                        
					@body_format = 'HTML'
			End                  
		End   

		Set @Count = @Count + 1

		Delete #ManagerMail
		Where Emp_ID=@PM

		Drop Table #Productivity_Manager
	End
	
     
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Productivity_Admin
-- --------------------------------------------------










CREATE Proc [dbo].[USP_SendMail_Productivity_Admin]
-------------------------------------------------------------------------------------------------------
--Created By	: Mahendra Bonde
--Created On	: 20/10/2010
--Modified by	:
--Modified On	:
--Description	: Last Week Team Productivity Report Of Mail for Admin On Each Monday At 8:00 AM.
--				  And Last week Team(Resource) Productivity Mail For Project Manager On Each monday At 8:00AM
--				  And Last week Team(Resource) Productivity Mail For Software Analyst (Report of respective Project Manager) On Each monday At 8:00AM
-------------------------------------------------------------------------------------------------------

as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max)
	declare @HTMLBODY5 nvarchar(max)  
	declare @HTMLBODY6 nvarchar(max) 
	Declare @EmpID AS Char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @AdmEmail varchar(100)
	Declare @Email varchar(100)
	Declare @Month Varchar(20)
	Declare @CC Varchar(100)
	Declare @PMEmail AS Varchar(Max)
	Declare @TWHD As Int
	Declare @TWHHrs As Int
	set @HTMLBODY6 = ''

-------------------------------------

	Select Emp_ID, EmailAdd Into #Email
	From Client_Master 
	Where Role_ID in ('SYA','PM','DBAPM') And Status='A'

--	update #Email
--	Set EmailAdd='MahendraD.Bonde@Angeltrade.com'

	Set @Count = 0
	Set @Total = 0
	Set @Total = (Select Count(EmailAdd) From #Email)
	Declare @E AS Varchar(100)

	Set @PMEmail = ''
	While (@Count < @Total)
	Begin
		
		Set @E = (Select top 1 EmailAdd From #Email)

		if(@Count = 0)
			Set @PMEmail = '' + rtrim(@E) + ''
		else if(@Count<>0 and @Count<>(@Total-1))
			Set @PMEmail = '' + @PMEmail + ';' + rtrim(@E) + ''
		else 
			Set @PMEmail = '' + @PMEmail + ';' + rtrim(@E) + ''
		

		Set @Count = @Count + 1

		Delete #Email Where Emp_ID=(Select top 1 Emp_ID From #Email)
	End


	Drop Table #Email
-------------------------------------

	Set @AdmEmail = (Select EmailAdd From Client_Master Where Role_ID='AA')

--	Set @AdmEmail = 'MahendraD.Bonde@Angeltrade.com'

	Select @PMEmail	

	Declare @FromDate AS Datetime
	Declare @EndDate AS Datetime
	Declare @TW As INT
	Declare @TWH As Int

	set @Month = (Select DATENAME(month,getdate()))

	if((Select DATENAME(DAY,getdate())) = 1)
	Begin 
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate()-1)),getdate()),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,-1,getdate()))),DATEADD(mm,0,getdate())),110)

		set @Month = (Select DATENAME(month,@FromDate))
	End
	Else 
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		--Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)	
		Set @EndDate = CONVERT(Varchar(12), Getdate()-1, 110)
	End
	
	Set @TW = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))
	Set @TWH = (Select DBO.[GetHarmonyWorkingHours] ('',@FromDate, @EndDate)) 
--
--	set @TWHD = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))
--	set @TWHHrs = (Select DBO.[GetHarmonyWorkingHours]('',@FromDate, @EndDate))

--(Select DBO.[GetHarmonyDays] ('',@FromDate, @EndDate))
--(Select DBO.[GetHarmonyHours] ('',@FromDate, @EndDate))

	Print @FromDate
	Print @EndDate
	print @TWHD
	Print @TWHHrs

	Select PM As PM_T, ISNULL(TWD,'0') As TWD_T, ISNULL(TWHD,'0') As TWHD_T, ISNULL(Resources,'0') AS Res_T, 
			ISNULL(TWHr, '0') As TWHr_T, ISNULL(TWHHr, '0') As TWHHr_T, ISNULL(TWSHr, '0') As TWSHr_T, 
			ISNULL(TWRHHr,'0') AS [TWRHHr_T], ISNULL(TAT,'0') As TAT_T, ISNULL(TUT,'0') As [TUT_T],
			ISNULL(UT,'0') As UT_T, ISNULL(IUT, '0') As IUT_T
	Into #Productivity_ADM
	From
	(
		Select PM, Emp_ID, TWD, TWHD, Resources, TWHr, TWHHr, [TWSHr],TWRHHr, TAT, TUT, UT, IUT, 'A' Flag
		From
		(
			Select Emp_Name AS PM, Emp_ID, TWD, TWHD, Resources, TWHr, TWHHr, 
					(Resources * TWHr) As [TWSHr],TWRHHr, 
					Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) As Decimal(10)) AS [TAT] ,
					Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char)) As Decimal(10)) AS [TUT],
					(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWRHHr As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS UT,				
					(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast((Resources * TWHr) As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS IUT				
			From
			(
				Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TWD],
						(Select DBO.[GetHarmonyDays] (RSM.Emp_ID,@FromDate, @EndDate)) AS [TWHD],
						(Select Count(R.Emp_ID) From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
							As Resources, 
						@TWH As [TWHr],
						(Select DBO.[GetHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWHHr],
						(Select DBO.[GetTeamHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWRHHr],
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								((Select R.Emp_ID From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						  ),0) As TAT, 
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						  ),0) As TUT
				From Resource_Master RSM With (nolock)
				Where Role_ID in ('PM','DBAPM','SYA') And Active_Status=1 And Emp_ID Not in ('P00045')
				Group By RSM.Emp_Name, RSM.Emp_ID
			) T
		)T

		UNION

		Select  'Total' AS PM,'' AS Emp_ID, TWD, '' As TWHD, Resources, TWHr,TWHHr, TWSHr,TWRHHr,
			Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) AS Decimal(10)) AS [TAT] ,
			Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char))As Decimal(10)) AS [TUT] ,
			(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWRHHr As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS UT,				
			(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSHr As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS IUT,	 
			'B' As Flag
		From
		(
			Select TWD, SUM(Resources) AS Resources, SUM(TWHr) AS TWHr, SUM(TWHHr) AS TWHHr, sum(TWRHHr) As TWRHHr,
				Sum(TWSHr) As TWSHr, Sum(TAT) As TAT, SUM(TUT) As TUT
			From
			(
				Select Emp_Name AS PM, Emp_ID, TWD, TWHD, Resources, TWHr, TWHHr, 
						(Resources * TWHr) As [TWSHr],TWRHHr, [TAT], [TUT]
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TWD],
							(Select DBO.[GetHarmonyDays] (RSM.Emp_ID,@FromDate, @EndDate)) AS [TWHD],
							(Select Count(R.Emp_ID) From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								As Resources, 
							@TWH As [TWHr],
							(Select DBO.[GetHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWHHr],
							(Select DBO.[GetTeamHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWRHHr],
							ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TAT,
							ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TUT
					From Resource_Master RSM with (nolock)
					Where Role_ID in ('PM','DBAPM','SYA') And Active_Status=1 And Emp_ID Not in ('P00045')
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T
			)T Group By TWD
		)T
	) T
	Order By Flag, PM
--	
--	
--
-- 	Select * From #Productivity_ADM

	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #Productivity_ADM ', @HTMLBODY1 output  
		 
	

	if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
	Begin
		set @HTMLBODY6 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''''pretty-table'''' cellpadding=''''0'''' cellspacing=''''0'''' width=''''850px''''><caption>Team Productivity</caption>')
	End

--	Select @AdmEmail

	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
	Begin

		Set @HTMLBODY6 =  '<HTML><HEAD><TITLE>Team Productivity Report of the month ' 
						+ (@Month + ',' + DATENAME(Year,@EndDate))  + 
						--', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
						' till ' + (Select CONVERT(Varchar(12),@EndDate,113)) +
						'</TITLE><STYLE TYPE=''''text/css''''>' +
						'.pretty-table { padding: 0;  margin: 0;  border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  font-family: Arial; font-size: 0.8em; background: #bcd0e4 top left repeat-x; } ' +
						'.pretty-table caption {  caption-side: top;  font-weight:bold; font-size: 1.3em; text-align: Center;  padding: 0.5em 0; Color:White;} ' +
						'.pretty-table td {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  color: #632a39;} ' +
						'.pretty-table th {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  Color:White}' +
						'.pretty-table tr:hover th[scope=row], ' +
						'.pretty-table tr:hover td {  background-color: #632a2a;  color: #fff;} ' +
						'.pretty-table th{ background-color: #997700 } ' +
				'</STYLE></HEAD><Body> <br>' +
				'Dear Team,<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + 
				'Below is the Team Productivity Report for the month of ' + 
				(@Month + ',' + DATENAME(Year,@EndDate))  + 
				--', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
				' till ' + (Select CONVERT(Varchar(12),@EndDate,113)) + '.<BR><BR>' +
				'<center><div width=''''980px''''><center>' + @HTMLBODY6 +
				'</center></Div></center><BR><BR>' +
				'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The detailed team-wise reports will sent separately to all Project Managers.' +
				'<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is a system-generated e-mail, please do not reply to this email.' + 
				'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'

		set @HTMLBODY6 = Replace(@HTMLBODY6,'PM_T','Project Manager')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWD_T','Total Working Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWHD_T','Total Harmony Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'Res_T','Staff Count')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWHr_T','Total Standard Working Hours')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWHHr_T','Total Available Hours ')	
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWSHr_T','Total Standard Staff Hours')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWRHHr_T','Total Harmony Staff Hours')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TAT_T','Total Hours Assigned  ')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TUT_T','Total Hours Utilized ')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'UT_T','Utilization (In %)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'IUT_T','Ideal  Utilization (In %)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'</th></tr>','</th></tr><tr><td></td><td>(A)</td><td>(B)</td>
												<td>(C)</td><td>(D =A * 8 hrs & 5 hrs for Sat)</td>
												<td>(E = B * 8 hrs & 5 hrs for Sat)</td>
												<td>(F = A * C * 8 hrs & 5 hrs for Sat)</td>
												<td>(G = Staff HDays * 8 hrs & 5 hrs for Sat)</td>
												<td>(H = PM allocated time to staff)</td>
												<td>(I = Timesheet Filled by Staff)</td>
												<td>(J=(I/G) * 100)</td><td>(K=(I/F) * 100)</td></tr>')




	End

	select @HTMLBODY6                         
	                        

	Declare @Query AS Varchar(MAX)
	
	Select @PMEmail
	Select @AdmEmail
--
--	Set @PMEmail = 'MahendraD.Bonde@angeltrade.com'
--	Set @AdmEmail = 'MahendraD.Bonde@angeltrade.com'
--
--	Select @PMEmail
--	Select @AdmEmail

	Select @HTMLBODY6

	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>''And @HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
	Begin
		Set @Query = 'msdb.dbo.sp_send_dbmail                         
			@profile_name = ''Prms_alert'',                        
			@recipients = ''' + @PMEmail + ''', 
			@copy_recipients= ''' + @AdmEmail + ''',
			@subject = ''PRMS - Team Productivity Report'',                        
			@body = ''' + @HTMLBODY6 + ''',                        
			@body_format = ''HTML'''   

		print @Query

		EXEC (@Query)

--		EXEC msdb.dbo.sp_send_dbmail                         
--			@profile_name = 'Prms_alert',                        
--			@recipients='MahendraD.Bonde@angeltrade.com',                        
--			@subject = 'PRMS - Team Productivity Report',                        
--			@body = @HTMLBODY6,                        
--			@body_format = 'HTML'
--		
			     
	End   
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Productivity_Admin_21NOV2010
-- --------------------------------------------------











Create Proc [dbo].[USP_SendMail_Productivity_Admin_21NOV2010]
-------------------------------------------------------------------------------------------------------
--Created By	: Mahendra Bonde
--Created On	: 20/10/2010
--Modified by	:
--Modified On	:
--Description	: Last Week Team Productivity Report Of Mail for Admin On Each Monday At 8:00 AM.
--				  And Last week Team(Resource) Productivity Mail For Project Manager On Each monday At 8:00AM
--				  And Last week Team(Resource) Productivity Mail For Software Analyst (Report of respective Project Manager) On Each monday At 8:00AM
-------------------------------------------------------------------------------------------------------

as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max)
	declare @HTMLBODY5 nvarchar(max)  
	declare @HTMLBODY6 nvarchar(max) 
	Declare @EmpID AS Char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @AdmEmail varchar(100)
	Declare @Email varchar(100)
	Declare @Month Varchar(20)
	Declare @CC Varchar(100)
	Declare @PMEmail AS Varchar(Max)
	Declare @TWHD As Int
	Declare @TWHHrs As Int
	set @HTMLBODY6 = ''

-------------------------------------

	Select Emp_ID, EmailAdd Into #Email
	From Client_Master 
	Where Role_ID in ('SYA','PM','DBAPM') And Status='W'

--	update #Email
--	Set EmailAdd='MahendraD.Bonde@Angeltrade.com'

	Set @Count = 0
	Set @Total = 0
	Set @Total = (Select Count(EmailAdd) From #Email)
	Declare @E AS Varchar(100)

 
--	Select * From #Email


	Set @PMEmail = ''
	While (@Count < @Total)
	Begin
		
		Set @E = (Select top 1 EmailAdd From #Email)

		if(@Count = 0)
			Set @PMEmail = '' + rtrim(@E) + ''
		else if(@Count<>0 and @Count<>(@Total-1))
			Set @PMEmail = '' + @PMEmail + ';' + rtrim(@E) + ''
		else 
			Set @PMEmail = '' + @PMEmail + ';' + rtrim(@E) + ''
		

		Set @Count = @Count + 1

		Delete #Email Where Emp_ID=(Select top 1 Emp_ID From #Email)
	End


	Drop Table #Email
-------------------------------------

	Set @AdmEmail = (Select EmailAdd From Client_Master Where Role_ID='AA')

--	Set @AdmEmail = 'MahendraD.Bonde@Angeltrade.com'

	Select @PMEmail	

	Declare @FromDate AS Datetime
	Declare @EndDate AS Datetime
	Declare @TW As INT

	set @Month = (Select DATENAME(month,getdate()))

	if((Select DATENAME(DAY,getdate())) = 1)
	Begin 
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate()-1)),getdate()),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,-1,getdate()))),DATEADD(mm,0,getdate())),110)

		set @Month = (Select DATENAME(month,@FromDate))
	End
	Else 
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		--Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)	
		Set @EndDate = CONVERT(Varchar(12), Getdate(), 110)
	End
	
	Set @TW = (Select dbo.GetTotalWorkingDays(@FromDate,@EndDate)) 
	set @TWHD = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))
	set @TWHHrs = (Select DBO.[GetHarmonyWorkingHours]('',@FromDate, @EndDate))
--
	Print @FromDate
	Print @EndDate
	print @TWHD
	Print @TWHHrs


	Select PM As PM_T, ISNULL(TW,'0') As TW_T, ISNULL(TWD,'0') As TWD_T, ISNULL(Resources,'0') AS Res_T, ISNULL(TWH, '0') As TWH_T, TAT As TAT_T, 
			ISNULL(TUT,'0') As TUT_T, ISNULL(PER_PM, '0') As PRM_T, ISNULL(TP,'0') As TP_T
	Into #Productivity_ADM
	From
	(
		Select PM, Emp_ID, TW, TWD, Resources, TWH, TAT, TUT, PER_PM, TP, 'A' Flag
		From
		(
			Select Emp_Name AS PM, Emp_ID, TW, TWD, Resources, TWH, 
					(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
					(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT] , 
					(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
					(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
					--When (TUT > TAT And TAT<>0) Then CAST(((TAT-TUT)/ 100) AS DECIMAL(10,2)) 
						When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
						Else 0 End) AS [TP] 
			From
			(
				Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TW],@TWHD  AS [TWD],
					(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
						As Resources, 
					(@TWHHrs * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						AS [TWH], 
					ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						  ),0) As TAT,
					ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						  ),0) As TUT
				From Resource_Master RSM
				Where Role_ID in ('PM','DBAPM') And Active_Status=1
				Group By RSM.Emp_Name, RSM.Emp_ID
			) T
		)T

		UNION

		Select  'Total' AS PM,'' AS Emp_ID, TW, '' As TWD, Resources, TWH,
			(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT] ,
			(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT],
			(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
			(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
				When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
				Else 0 End) AS [TP], 
			'B' As Flag
		From
		(
			Select SUM(Resources) AS Resources, TW As [TW], SUM(TWD) As TWD ,SUM(TWH) AS TWH,
				SUM(TAT) AS TAT,SUM(TUT) AS TUT, SUM(PER_PM) AS PER_PM, SUM(TP) AS TP, 'B' Flag
			From 
			(
				Select TWD, Resources, [TW], TWH, TAT, TUT, 
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
						When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
							Else 0 End) AS [TP] 
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW AS [TW],@TWHD  AS [TWD],
						(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
							As Resources, 
						(@TWHHrs * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							AS [TWH], 
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PM','DBAPM') And Active_Status=1
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T 
			) T group By TW
		)T
	) T
	Order By Flag, PM
--	
--	
--
-- 	Select * From #Productivity_ADM

	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #Productivity_ADM ', @HTMLBODY1 output  
		 
	

	if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
	Begin
		set @HTMLBODY6 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''''pretty-table'''' cellpadding=''''0'''' cellspacing=''''0'''' width=''''800px''''><caption>Team Productivity</caption>')
	End

--	Select @AdmEmail

	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
	Begin

		Set @HTMLBODY6 =  '<HTML><HEAD><TITLE>Team Productivity Report of the month ' 
						+ (@Month + ',' + DATENAME(Year,@EndDate))  + 
						--', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
						' till ' + (Select CONVERT(Varchar(12),@EndDate,113)) +
						'</TITLE><STYLE TYPE=''''text/css''''>' +
						'.pretty-table { padding: 0;  margin: 0;  border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  font-family: Arial; font-size: 0.8em; background: #bcd0e4 top left repeat-x; } ' +
						'.pretty-table caption {  caption-side: top;  font-weight:bold; font-size: 1.3em; text-align: Center;  padding: 0.5em 0; Color:White;} ' +
						'.pretty-table td {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  color: #632a39;} ' +
						'.pretty-table th {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  Color:White}' +
						'.pretty-table tr:hover th[scope=row], ' +
						'.pretty-table tr:hover td {  background-color: #632a2a;  color: #fff;} ' +
						'.pretty-table th{ background-color: #997700 } ' +
				'</STYLE></HEAD><Body> <br>' +
				'Dear Team,<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + 
				'Below is the Team Productivity Report for the month of ' + 
				(@Month + ',' + DATENAME(Year,@EndDate))  + 
				--', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
				' till ' + (Select CONVERT(Varchar(12),@EndDate,113)) + '.<BR><BR>' +
				'<center><div width=''''980px''''><center>' + @HTMLBODY6 +
				'</center></Div></center><BR><BR>' +
				'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The detailed team-wise reports will sent separately to all Project Managers.' +
				'<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is a system-generated e-mail, please do not reply to this email.' + 
				'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'

		set @HTMLBODY6 = Replace(@HTMLBODY6,'PM_T','Project Manager')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TW_T','Total Working Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWD_T','Total Harmony Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'Res_T','Resource')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWH_T','Total Working Hours (In Hrs:Min)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TAT_T','Total Assign Time (In Hrs:Min)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TUT_T','Total Utilization Time (In Hrs:Min)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'PRM_T','Performance (In %)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TP_T','Team Productivity (In %)')

	End

	select @HTMLBODY6                         
	                        

	Declare @Query AS Varchar(MAX)
	
	Select @PMEmail
	Select @AdmEmail

	Set @PMEmail = 'MahendraD.Bonde@angeltrade.com'
	Set @AdmEmail = 'MahendraD.Bonde@angeltrade.com'
--
--	Select @PMEmail
--	Select @AdmEmail

	Select @HTMLBODY6

	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>''And @HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
	Begin
--		Set @Query = 'msdb.dbo.sp_send_dbmail                         
--			@profile_name = ''Prms_alert'',                        
--			@recipients = ''' + @PMEmail + ''', 
--			@copy_recipients= ''' + @AdmEmail + ''',
--			@subject = ''PRMS - Team Productivity Report'',                        
--			@body = ''' + @HTMLBODY6 + ''',                        
--			@body_format = ''HTML'''   

		print @Query

		EXEC (@Query)

--		EXEC msdb.dbo.sp_send_dbmail                         
--			@profile_name = 'Prms_alert',                        
--			@recipients='MahendraD.Bonde@angeltrade.com',                        
--			@subject = 'PRMS - Team Productivity Report',                        
--			@body = @HTMLBODY6,                        
--			@body_format = 'HTML'
--		
			     
	End   
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Productivity_Admin_old
-- --------------------------------------------------





Create Proc [dbo].[USP_SendMail_Productivity_Admin_old]
-------------------------------------------------------------------------------------------------------
--Created By	: Mahendra Bonde
--Created On	: 20/10/2010
--Modified by	:
--Modified On	:
--Description	: Last Week Team Productivity Report Of Mail for Admin On Each Monday At 8:00 AM.
--				  And Last week Team(Resource) Productivity Mail For Project Manager On Each monday At 8:00AM
--				  And Last week Team(Resource) Productivity Mail For Software Analyst (Report of respective Project Manager) On Each monday At 8:00AM
-------------------------------------------------------------------------------------------------------

as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 
	declare @HTMLBODY4 nvarchar(max)
	declare @HTMLBODY5 nvarchar(max)  
	declare @HTMLBODY6 nvarchar(max) 
	Declare @EmpID AS Char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @AdmEmail varchar(100)
	Declare @Email varchar(100)
	Declare @Month Varchar(20)
	Declare @CC Varchar(100)
	Declare @PMEmail AS Varchar(Max)
	Declare @TWHD As Int
	Declare @TWHHrs As Int
	set @HTMLBODY6 = ''

-------------------------------------

	Select Emp_ID, EmailAdd Into #Email
	From Client_Master 
	Where Role_ID in ('SYA','PM') And Status='A'

	update #Email
	Set EmailAdd='MahendraD.Bonde@Angeltrade.com'

	Set @Count = 0
	Set @Total = 0
	Set @Total = (Select Count(EmailAdd) From #Email)
	Declare @E AS Varchar(100)

 
--	Select * From #Email


	Set @PMEmail = ''
	While (@Count < @Total)
	Begin
		
		Set @E = (Select top 1 EmailAdd From #Email)

		if(@Count = 0)
			Set @PMEmail = '' + rtrim(@E) + ''
		else if(@Count<>0 and @Count<>(@Total-1))
			Set @PMEmail = '' + @PMEmail + ';' + rtrim(@E) + ''
		else 
			Set @PMEmail = '' + @PMEmail + ';' + rtrim(@E) + ''
		

		Set @Count = @Count + 1

		Delete #Email Where Emp_ID=(Select top 1 Emp_ID From #Email)
	End


	Drop Table #Email
-------------------------------------

	Set @AdmEmail = (Select EmailAdd From Client_Master Where Role_ID='AA')

	Set @AdmEmail = 'MahendraD.Bonde@Angeltrade.com'

	Select @PMEmail	

	Declare @FromDate AS Datetime
	Declare @EndDate AS Datetime
	Declare @TW As INT

	set @Month = (Select DATENAME(month,getdate()))

	if((Select DATENAME(DAY,getdate())) = 1)
	Begin 
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate()-1)),getdate()),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,-1,getdate()))),DATEADD(mm,0,getdate())),110)

		set @Month = (Select DATENAME(month,@FromDate))
	End
	Else 
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		--Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)	
		Set @EndDate = CONVERT(Varchar(12), Getdate(), 110)
	End
	
	Set @TW = (Select dbo.GetTotalWorkingDays(@FromDate,@EndDate)) 
	set @TWHD = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))

	Select PM As PM_T, ISNULL(TW,'0') As TW_T, ISNULL(TWD,'0') As TWD_T, ISNULL(Resources,'0') AS Res_T, ISNULL(TWH, '0') As TWH_T, TAT As TAT_T, 
			ISNULL(TUT,'0') As TUT_T, ISNULL(PER_PM, '0') As PRM_T, ISNULL(TP,'0') As TP_T
	Into #Productivity_ADM
	From
	(
		Select PM, Emp_ID, TW, TWD, Resources, TWH, TAT, TUT, PER_PM, TP, 'A' Flag
		From
		(
			Select Emp_Name AS PM, Emp_ID, TW, TWD, Resources, TWH, 
					(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
					(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT] , 
					(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
					(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
					--When (TUT > TAT And TAT<>0) Then CAST(((TAT-TUT)/ 100) AS DECIMAL(10,2)) 
						When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
						Else 0 End) AS [TP] 
			From
			(
				Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TW],
					  (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
					(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
					(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
						Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
					)AS [TWH], 
					ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								 Union Select RSM.Emp_ID)
						  ),0) As TAT,
					ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
								Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
								And TM.Assigned_To in 
								(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								 Union Select RSM.Emp_ID)
						  ),0) As TUT
				From Resource_Master RSM
				Where Role_ID in ('PM') And Active_Status=1
				Group By RSM.Emp_Name, RSM.Emp_ID
			) T
		)T

		UNION

		Select  'Total' AS PM,'' AS Emp_ID, TW, '' As TWD, Resources, TWH,
			(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT] ,
			(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT],
			(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
			(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
				When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
				Else 0 End) AS [TP], 
			'B' As Flag
		From
		(
			Select SUM(Resources) AS Resources, TW As [TW], SUM(TWD) As TWD ,SUM(TWH) AS TWH,
				SUM(TAT) AS TAT,SUM(TUT) AS TUT, SUM(PER_PM) AS PER_PM, SUM(TP) AS TP, 'B' Flag
			From 
			(
				Select TWD, Resources, [TW], TWH, TAT, TUT, 
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
						When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
							Else 0 End) AS [TP] 
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW AS [TW],
						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
						(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
						(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
							Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
						)AS [TWH], 
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
									 Union Select RSM.Emp_ID)
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
									 Union Select RSM.Emp_ID)
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PM') And Active_Status=1
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T 
			) T group By TW
		)T
	) T
	Order By Flag, PM
	
	

	Select * From #Productivity_ADM

	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #Productivity_ADM ', @HTMLBODY1 output  
		 
	

	if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
	Begin
		set @HTMLBODY6 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''''pretty-table'''' cellpadding=''''0'''' cellspacing=''''0'''' width=''''800px''''><caption>Team Productivity</caption>')
	End

	Select @AdmEmail

	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
	Begin

		Set @HTMLBODY6 =  '<HTML><HEAD><TITLE>Team Productivity Report of the month ' 
						+ (@Month + ',' + DATENAME(Year,@EndDate))  + 
						--', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
						' till ' + (Select CONVERT(Varchar(12),@EndDate,113)) +
						'</TITLE><STYLE TYPE=''''text/css''''>' +
						'.pretty-table { padding: 0;  margin: 0;  border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  font-family: Arial; font-size: 0.8em; background: #bcd0e4 top left repeat-x; } ' +
						'.pretty-table caption {  caption-side: top;  font-weight:bold; font-size: 1.3em; text-align: Center;  padding: 0.5em 0; Color:White;} ' +
						'.pretty-table td {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  color: #632a39;} ' +
						'.pretty-table th {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  Color:White}' +
						'.pretty-table tr:hover th[scope=row], ' +
						'.pretty-table tr:hover td {  background-color: #632a2a;  color: #fff;} ' +
						'.pretty-table th{ background-color: #997700 } ' +
				'</STYLE></HEAD><Body> <br>' +
				'Dear Team,<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + 
				'Below is the Team Productivity Report for the month of ' + 
				(@Month + ',' + DATENAME(Year,@EndDate))  + 
				--', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
				' till ' + (Select CONVERT(Varchar(12),@EndDate,113)) + '.<BR><BR>' +
				'<center><div width=''''980px''''><center>' + @HTMLBODY6 +
				'</center></Div></center><BR><BR>' +
				'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The detailed team-wise reports will sent separately to all Project Managers.' +
				'<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is a system-generated e-mail, please do not reply to this email.' + 
				'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'

		set @HTMLBODY6 = Replace(@HTMLBODY6,'PM_T','Project Manager')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TW_T','Total Working Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWD_T','Total Harmony Days')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'Res_T','Resource')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TWH_T','Total Working Hours (In Hrs:Min)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TAT_T','Total Assign Time')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TUT_T','Total Utilization Time ')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'PRM_T','Performance (In %)')
		set @HTMLBODY6 = Replace(@HTMLBODY6,'TP_T','Team Productivity (In %)')

	End

	select @HTMLBODY6                         
	                        

	Declare @Query AS Varchar(MAX)
	
	Select @PMEmail
	Select @AdmEmail
--
	Set @PMEmail = 'MahendraD.Bonde@angeltrade.com'
	Set @AdmEmail = 'MahendraD.Bonde@angeltrade.com'

	Select @PMEmail
	Select @AdmEmail

	If(@HTMLBODY6 IS NOT NULL And @HTMLBODY6<>'')
	Begin
--		Set @Query = 'msdb.dbo.sp_send_dbmail                         
--			@profile_name = ''Prms_alert'',                        
--			@recipients = ''' + @PMEmail + ''', 
--			@copy_recipients= ''' + @AdmEmail + ''',
--			@subject = ''PRMS - Team Productivity Report'',                        
--			@body = ''' + @HTMLBODY6 + ''',                        
--			@body_format = ''HTML'''   

		print @Query

--		EXEC (@Query)
--
--		EXEC msdb.dbo.sp_send_dbmail                         
--			@profile_name = 'Prms_alert',                        
--			@recipients='MahendraD.Bonde@angeltrade.com',                        
--			@subject = 'PRMS - Team Productivity Report',                        
--			@body = @HTMLBODY6,                        
--			@body_format = 'HTML'
		
			     
	End   
    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_Productivity_PM
-- --------------------------------------------------









CREATE Proc [dbo].[USP_SendMail_Productivity_PM]
-------------------------------------------------------------------------------------------------------
--Created By	: Mahendra Bonde
--Created On	: 20/10/2010
--Modified by	:
--Modified On	:
--Description	: Last Week Team Productivity Report Of Mail for Admin On Each Monday At 8:00 AM.
--				  And Last week Team(Resource) Productivity Mail For Project Manager On Each monday At 8:00AM
--				  And Last week Team(Resource) Productivity Mail For Software Analyst (Report of respective Project Manager) On Each monday At 8:00AM
-------------------------------------------------------------------------------------------------------

as

Begin
                
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max) 

	Declare @EmpID AS Char(10)
	Declare @Count int 
	Declare @Total int 
	Declare @AdmEmail varchar(100)
	Declare @Email varchar(100)
	Declare @Month Varchar(20)
	Declare @CC Varchar(100)
	set @HTMLBODY3 = ''
	
	Declare @FromDate AS Datetime
	Declare @EndDate AS Datetime
	Declare @TW As INT
	Declare @TWSH As Int

	set @Month = (Select DATENAME(month,getdate()))

	if((Select DATENAME(DAY,getdate())) = 1)
	Begin 
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate()-1)),getdate()),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,-1,getdate()))),DATEADD(mm,0,getdate())),110)

		set @Month = (Select DATENAME(month,@FromDate))
	End
	Else 
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		--Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)	
		Set @EndDate = CONVERT(Varchar(12), Getdate()-1, 110)
	End
	
	Set @TW = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))
	Set @TWSH = (Select DBO.[GetHarmonyWorkingHours] ('',@FromDate, @EndDate)) 
	
Print @FromDate
Print @EndDate
---------------------------------------------- PM Mail --------------------------------------------------
	Declare @PM As Varchar(20)

	Select RSM.Emp_ID, RSM.Emp_Name, CM.EmailAdd, CM.Role_ID
	Into #ManagerMail
	From Resource_Master RSM, Client_Master CM
	Where RSM.Emp_ID=CM.Emp_ID and RSM.Role_ID in ('PM','DBAPM') And Active_Status=1
		And RSM.Emp_ID='E03446'

	Set @Count = 0
	Set @Total = (Select Count(Emp_ID) From #ManagerMail)

	
	While(@Count < @Total) 
	Begin
		Set @CC = ''
		Set @HTMLBODY3 = ''
		Set @HTMLBODY2 = ''
		Set @HTMLBODY1 = ''

		Set @PM = (Select top 1 Emp_ID From #ManagerMail)

		Set @Email = (Select top 1 EmailAdd From #ManagerMail)

		If((Select top 1 Emp_ID From #ManagerMail) = 'E03446' or (Select top 1 Emp_ID From #ManagerMail) = 'E31226' or (Select top 1 Emp_ID From #ManagerMail) = 'E21209')
		Begin	
			Set @CC = 'Anand.Diwan@angeltrade.com'
		End
		Else If((Select top 1 Emp_ID From #ManagerMail) = 'E05205' )
		Begin	
			Set @CC = 'manesh@angeltrade.com'
		End
		Else If((Select top 1 Emp_ID From #ManagerMail) = 'E02031' )
		Begin	
			Set @CC = 'MilanD.Shah@angeltrade.com'
		End	
		Else If((Select top 1 Emp_ID From #ManagerMail) = 'E08708' )
		Begin	
			Set @CC = 'bghanekar@angeltrade.com'
		End	

		--Set @CC = 'MahendraD.Bonde@angeltrade.com' 

		Select Res AS PM_T, TW AS TW_T, ISNULL(TWD,'0') AS TWD_T, TWSH As TWSH_T, ISNULL(TWH,'0') As TWH_T, 
				TAT AS TAT_T, TUT As TUT_T, 
				UT AS UT_T, IUT As IUT_T 
		Into #Productivity_Manager
		From
		(
			Select RES, EMP_ID, TW, TWSH, TWD, TWH, TAT, TUT, UT, IUT, 'A' AS Flag 
			From 
			(	
				Select Emp_Name As RES, Emp_ID, TW, TWSH, TWD, TWH, 
					Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) As Decimal(10)) AS [TAT] ,
					Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char)) As Decimal(10)) AS [TUT],
					ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS UT,				
					ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS IUT
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As TW, @TWSH As TWSH,
						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],  
						(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To=	RSM.Emp_ID
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To = RSM.Emp_ID
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM   
						And Active_Status=1 
					Group By RSM.Emp_Name, RSM.Emp_ID

				) T
			) T

			Union 

			Select 'Total' AS Res, '' AS Emp_ID, TW, TWSH, '' As TWD, TWH, 
				Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) As Decimal(10)) AS [TAT] ,
				Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char)) As Decimal(10)) AS [TUT],
				ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS UT,				
				ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS IUT,
				 'B' AS Flag 
			From
			(
				Select TW, TWSH, TWD, TWH, TAT, TUT, UT, IUT
				From 
				(
					Select TW, SUM(TWSH) As TWSH, SUM(TWD) AS TWD, SUM(TWH) AS TWH, SUM(TAT) AS TAT, SUM(TUT) AS TUT, 
							SUM(UT) AS UT, SUM(IUT) AS IUT
					From		
					(
						Select TW, TWSH, ISNULL(TWD,'0') As TWD, ISNULL(TWH, '0') AS TWH, TAT, TUT,
							ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS UT,				
							ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS IUT
						From
						(
							Select @TW AS [TW], @TWSH As TWSH,
								(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
								(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate)) AS TWH,
								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To=	RSM.Emp_ID
									  ),0) As TAT,
								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To = RSM.Emp_ID
									  ),0) As TUT
							From Resource_Master RSM
							Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM  
								And Active_Status=1 
							Group By Emp_ID
						) T
					) T	Group By TW
				)T 
			)T
		) T
		Order By Flag

--		Select top 1 * From #ManagerMail

--		Select * From #Productivity_Manager

		exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From #Productivity_Manager ', @HTMLBODY1 output  
 	
	
		if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
		Begin
			set @HTMLBODY2 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
												'<table class=''pretty-table'' cellpadding=''0'' cellspacing=''0'' width=''850px''><caption>Team Productivity</caption>')
		End
			
		If(@HTMLBODY2 IS NOT NULL And @HTMLBODY2<>'')
		Begin
	
			Set @HTMLBODY3 = '<HTML><HEAD><TITLE>Team Productivity Report of the month ' 
						+ (Select DATENAME(Month,getdate()) + ',' + DATENAME(Year,getdate()))  + 
						', (From '  + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
						'to' + (Select CONVERT(Varchar(12),getdate()-1,113)) + ')' +
						'</TITLE><STYLE TYPE=''text/css''>' +
						'.pretty-table { padding: 0;  margin: 0;  border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  font-family: Arial; font-size: 0.8em; background: #bcd0e4 top left repeat-x; } ' +
						'.pretty-table caption {  caption-side: top;  font-weight:bold; font-size: 1.3em; text-align: Center;  padding: 0.5em 0; Color:White;} ' +
						'.pretty-table td {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  color: #632a39;} ' +
						'.pretty-table th {  height=20px; border-right: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;  padding: 0.5em;  text-align: Left;  Color:White}' +
						'.pretty-table tr:hover th[scope=row], ' +
						'.pretty-table tr:hover td {  background-color: #632a2a;  color: #fff;} ' +
						'.pretty-table th{ background-color: #997700 } ' +
					'</STYLE></HEAD><Body><br>' +
					'Dear Sir/Madam,<BR><BR>Kindly find below the Team Productivity Report of the month ' + (Select DATENAME(Month,getdate()) + ',' + DATENAME(Year,getdate()))  + 
					', (From ' + (Select CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),113)) + 
					'to' + (Select CONVERT(Varchar(12),getdate()-1,113)) + ').<BR><BR>' +
					'<center><div width=''980px''>' + @HTMLBODY2 +
					'</center></Div></center><BR><BR>This is a system-generated e-mail, please do not reply to this email.' + 
					'<BR><BR>Thanks and Regards,<BR>Software Team<BR></Body></HTML>'
	
			set @HTMLBODY3 = Replace(@HTMLBODY3,'PM_T','Staff')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'TW_T','Total Working Days')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'TWD_T','Total Harmony Days')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'TWSH_T','Total Standard Staff Hours')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'TWH_T','Total Harmony Staff Hours')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'TAT_T','Total Assign Time')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'TUT_T','Total Utilization Time ')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'UT_T','Utilization (In %)')
			set @HTMLBODY3 = Replace(@HTMLBODY3,'IUT_T','Ideal  Utilization (In %)')

			set @HTMLBODY3 = Replace(@HTMLBODY3,'</th></tr>','</th></tr><tr><td></td><td>(A)</td><td>(B)</td>
												<td>(C = A * 8 hrs & 5 hrs for Sat)</td>
												<td>(D = B * 8 hrs & 5 hrs for Sat)</td>
												<td>(E = PM allocated time to staff)</td>
												<td>(F = Timesheet Filled by Staff)</td>
												<td>(G=(F/D) * 100)</td><td>(H=(F/C) * 100)</td></tr>')
		End
	
--		Select @HTMLBODY2
		select @HTMLBODY3        

	Set @Email ='MahendraD.Bonde@angeltrade.com'   
	Set @CC ='MahendraD.Bonde@angeltrade.com'  

		Print @Email
		Print @CC                 
            
		If(@HTMLBODY2 IS NOT NULL And @HTMLBODY2<>'')
		Begin
			IF(@CC <> '')
			Begin
				Print @Email
				Print @CC

				EXEC msdb.dbo.sp_send_dbmail                         
					@profile_name = 'Prms_alert',                        
					--@recipients='MahendraD.Bonde@angeltrade.com',                        
					@recipients=@Email,
					@copy_recipients =@CC,                        
					@subject = 'PRMS - Team Productivity Report',                        
					@body = @HTMLBODY3,                        
					@body_format = 'HTML'
			End
			Else IF(@CC = '')
			Begin
				Print @Email
--				EXEC msdb.dbo.sp_send_dbmail                         
--					@profile_name = 'Prms_alert',                        
--					--@recipients='MahendraD.Bonde@angeltrade.com',                        
--					@recipients=@Email,
--					@subject = 'PRMS - Team Productivity Report',                        
--					@body = @HTMLBODY3,                        
--					@body_format = 'HTML'
			End                  
		End   

		Set @Count = @Count + 1

		Delete #ManagerMail
		Where Emp_ID=@PM

		Drop Table #Productivity_Manager
	End
	
     
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_SendMail_ProjectOwner
-- --------------------------------------------------



CREATE Proc [dbo].[USP_SendMail_ProjectOwner]

as

Begin
	declare @Emp_ID char(20)  
	declare @Role char(20)          
	declare @HTMLBODY1 nvarchar(max)         
	declare @HTMLBODY2 nvarchar(max)     
	declare @HTMLBODY3 nvarchar(max)     
	declare @HTMLBODY4 nvarchar(max)  

	Set @Emp_ID ='E19416'
	Set @Role = 'PO'

	---- ///////////////////////////////  Project Owner Mail /////////////////////////////// ----

	--====================== Pending New Request till today ======================--
	Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], RM.Brief_Requirement As [BriefRequirement], 
		RM.Request_Date As [RequestDate],CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], 
		CM.Department As [Department], RSM.Request_Status_Name As [Status] 
	Into ADM_Temp_Mail1
	From Request_Master RM, Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
		And RM.Request_Status_ID in ('PBA')
		And (RM.Requested_By In (Select Emp_ID From Client_Master Where HOD=@Emp_ID Union Select @Emp_ID) Or
		RM.Requested_By In (Select Distinct Employee_ID From Coordinator_Master 
	Where Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)))
		And @Role in (Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)

	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'Select * From ADM_Temp_Mail1 ', @HTMLBODY1 output  

	Drop Table ADM_Temp_Mail1    

	 
	if(@HTMLBODY1 IS NOT NULL And @HTMLBODY1<>'')
	Begin
		set @HTMLBODY4 = Replace(@HTMLBODY1,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>New Request Summary Report</caption>')
	End

	--Mail Code
	
	If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
	Begin
	
		Set @HTMLBODY4 = '<HTML><HEAD><TITLE>Summary Report</TITLE><STYLE TYPE=''text/css''>' +
                     '.MyTable{width: auto; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
                     '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;}' +
                     '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
                     '</STYLE></HEAD><Body><br><center><Div><center>' +
						@HTMLBODY4
					+ '</center></Div></center></Body></HTML>'
	End

	select @HTMLBODY4                         
                        
	If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
	Begin
		EXEC msdb.dbo.sp_send_dbmail                         
			@profile_name = 'Prms_alert',                        
			--@recipients='jayk.khare@angeltrade.com',                        
			@recipients='MahendraD.Bonde@angeltrade.com',                         
			--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
			@subject = 'Summary Report',                        
			@body = @HTMLBODY4,                        
			@body_format = 'HTML'         
    End        
	

	--====================== Project Pending For Assign till today ======================--
	set @HTMLBODY4 = ''

	Select RM.Request_ID As [RequestID], RM.Project_Name AS [Project], RM.Brief_Requirement As [BriefRequirement], 
		RM.Request_Date As [RequestDate],CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], 
		CM.Department As [Department], RSM.Request_Status_Name As [Status]
	Into ADM_Temp_Mail2
	From Request_Master RM, Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where RM.Requested_BY=CM.Emp_ID And RM.Hod_Approve=CM2.Emp_ID And RM.Request_Status_ID=RSM.Request_Status_ID
		And RM.Request_Status_ID in ('ABA')
		And (RM.Requested_By In (Select Emp_ID From Client_Master Where HOD=@Emp_ID Union Select @Emp_ID) Or
		RM.Requested_By In (Select Distinct Employee_ID From Coordinator_Master 
	Where Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)))
		And @Role in (Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)
             
      
	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail2 order by 1', @HTMLBODY2 output         
     
	Drop Table ADM_Temp_Mail2 

	If(@HTMLBODY2 IS NOT NULL And @HTMLBODY2<>'')
	Begin
		set @HTMLBODY4 = Replace(@HTMLBODY2,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>New Request Summary Report</caption>')
	End

	--Mail Code
	
	If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
	Begin
	
		Set @HTMLBODY4 = '<HTML><HEAD><TITLE>Summary Report</TITLE><STYLE TYPE=''text/css''>' +
                     '.MyTable{width: auto; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
                     '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;}' +
                     '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
                     '</STYLE></HEAD><Body><br><center><Div><center>' +
						@HTMLBODY4
					+ '</center></Div></center></Body></HTML>'
	End

	select @HTMLBODY4                         
                        
	If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
	Begin
		EXEC msdb.dbo.sp_send_dbmail                         
			@profile_name = 'Prms_alert',                        
			--@recipients='jayk.khare@angeltrade.com',                        
			@recipients='MahendraD.Bonde@angeltrade.com',                         
			--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
			@subject = 'Summary Report',                        
			@body = @HTMLBODY4,                        
			@body_format = 'HTML'         
    End      


	--====================== Pending Change Request till today ======================--
	Set @HTMLBODY4=''

	Select Distinct CRM.Change_ID As [ChangeID], CRM.Request_ID As [RequestID], PM.Project_Name As [Project],
		MM.Module_Name As [Module], CRM.Description As [Description], CRM.Changed_Date As [ChangedDate], 
		CM.Emp_Name As [RequestedBY], CM2.Emp_Name As [Owner], CM.Department As [Department], 
		RSM.Request_Status_Name As [Status]
	Into ADM_Temp_Mail3
	From Change_request_master CRM, Project_Master PM, Module_Master MM, Project_Details PD,
		Client_Master CM, 
		Client_Master CM2, Request_Status_Master RSM	
	Where  CRM.Project_ID=PM.Project_ID And CRM.Module_ID=MM.Module_ID And CRM.Project_ID=PD.Project_ID And
		CRM.Hod_Approve=CM2.Emp_ID And CRM.Request_Status_ID=RSM.Request_Status_ID And
		CRM.Request_Status_ID in ('PBA') and CRM.Changed_BY=CM.Emp_ID 
		And (CRM.Changed_BY In (Select Emp_ID From Client_Master Where HOD=@Emp_ID Union Select @Emp_ID) Or
		CRM.Changed_BY In (Select Distinct Employee_ID From Coordinator_Master 
			Where Project_ID In (Select Distinct Project_ID From Coordinator_Master Where Employee_ID=@Emp_ID)))
		And @Role in (Select Role_ID From Client_Master Where Emp_ID=@Emp_ID)
	
	exec TMS.dbo.DBA_ConvertQueryInHTMP_PageComman 'select top 100 percent * From ADM_Temp_Mail3 order by 1',@HTMLBODY3 output                     
  
	Drop Table ADM_Temp_Mail3 

	If(@HTMLBODY3 IS NOT NULL And @HTMLBODY3<>'')
	Begin
		set @HTMLBODY4 = Replace(@HTMLBODY3,'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0'' >',
											'<table class=''MyTable'' cellpadding=''0'' cellspacing=''0''><caption>New Request Summary Report</caption>')
	End

	--Mail Code
	
	If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
	Begin
	
		Set @HTMLBODY4 = '<HTML><HEAD><TITLE>Summary Report</TITLE><STYLE TYPE=''text/css''>' +
                     '.MyTable{width: auto; border-right: black 1px solid; border-left: black 1px solid; border-bottom: black 1px solid; border-top: black 1px solid; }' +
                     '.MyTable td{width: auto; border-right: white 1px solid; border-top: white 1px solid; font-size: 0.8em; vertical-align: middle; border-left: white 1px solid; color: #3196a4; border-bottom: white 1px solid; font-family: Verdana; background-color: #efefef; text-align: left; height: 18px;}' +
                     '.MyTable caption{font-size: 0.9em; color: white; font-style: normal; font-family: Verdana; background-color: #3c6b97; border-right: black 1px solid; border-top: black 1px solid; border-left: black 1px solid;}' +
                     '</STYLE></HEAD><Body><br><center><Div><center>' +
						@HTMLBODY4
					+ '</center></Div></center></Body></HTML>'
	End

	select @HTMLBODY4                         
                        
	If(@HTMLBODY4 IS NOT NULL And @HTMLBODY4<>'')
	Begin
		EXEC msdb.dbo.sp_send_dbmail                         
			@profile_name = 'Prms_alert',                        
			--@recipients='jayk.khare@angeltrade.com',                        
			@recipients='MahendraD.Bonde@angeltrade.com',                        
			--@copy_recipients ='Sanjay.Patel@angeltrade.com',                        
			@subject = 'Summary Report',                        
			@body = @HTMLBODY4,                        
			@body_format = 'HTML'         
    End      
            
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TASK_Operation
-- --------------------------------------------------









CREATE Proc [dbo].[USP_TASK_Operation] 

@Emp_ID As Char(10),
@Role As Char(10),
@Option As Char(5)

As 

Begin
	If(@Option='1')
	Begin 
		If(@Role='PM')
		Begin
			Select Distinct TM.Task_ID As [TaskID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
				TM.Priority_ID As [Priority],  CM.Emp_Name As [Resource],Convert(varchar(12),TM.AS_SDT,113) As [StartDate],Convert(varchar(12),TM.AS_EDT,113) As [EndDate],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
			From Task_Master TM, Project_Master PM, Module_Master MM, Project_Details PD, Client_Master CM
			Where TM.Project_ID=PM.Project_ID and TM.Module_ID=MM.Module_ID and TM.Request_ID=PM.Request_ID
				and TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and TM.Status_ID in ('P','W')
				and PM.Project_Manager in (Select Emp_ID From Client_Master Where HOD=@Emp_ID and Role_ID in ('PM','PL') Union Select @Emp_ID)
		End
			Else If(@Role='PL')
		Begin
			Select Distinct TM.Task_ID As [TaskID],
				(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
				PM.Project_Name As [Project], MM.Module_Name As [Module],TM.Task_Name, 
				TM.Priority_ID As [Priority],  CM.Emp_Name As [Resource],Convert(varchar(12),TM.AS_SDT,113) As [StartDate],Convert(varchar(12),TM.AS_EDT,113) As [EndDate],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
				Convert(Varchar,(TM.AS_Time/60)) + ':' + Convert(Varchar,(TM.AS_Time%60)) As [Assigned Time]
			From Task_Master TM, Project_Master PM, Module_Master MM, Project_Details PD, Client_Master CM
			Where TM.Project_ID=PM.Project_ID and TM.Module_ID=MM.Module_ID and TM.Request_ID=PM.Request_ID
				and TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and  PM.Project_Leader=@Emp_ID  and TM.Status_ID in ('P','W')
		End
		Else If(@Role='DVL')
		Begin
			Select Distinct TM.Task_ID As [TaskID],
				(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
				PM.Project_Name As [Project], MM.Module_Name As [Module], TM.Task_Name,
				TM.Priority_ID As [Priority],  CM.Emp_Name As [Resource],Convert(varchar(12),TM.AS_SDT,113) As [StartDate],Convert(varchar(12),TM.AS_EDT,113) As [EndDate],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
				Convert(Varchar,(TM.AS_Time/60)) + ':' + Convert(Varchar,(TM.AS_Time%60)) As [Assigned Time]
			From Task_Master TM, Project_Master PM, Module_Master MM, Project_Details PD, Client_Master CM
			Where TM.Project_ID=PM.Project_ID and TM.Module_ID=MM.Module_ID and TM.Request_ID=PM.Request_ID
				and TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and TM.Assigned_To=@Emp_ID and TM.Assigned_By!=@Emp_ID
				and TM.Status_ID in ('P','W')

			Union

			Select Distinct TM.Task_ID As [TaskID],
				(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
				TM.Project_ID As [Project], TM.Module_ID As [Module], TM.Task_Name,
				TM.Priority_ID As [Priority],  CM.Emp_Name As [Resource],Convert(varchar(12),TM.AS_SDT,113) As [StartDate],Convert(varchar(12),TM.AS_EDT,113) As [EndDate],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
				Convert(Varchar,(TM.AS_Time/60)) + ':' + Convert(Varchar,(TM.AS_Time%60)) As [Assigned Time]
			From Task_Master TM, Client_Master CM
			Where TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and TM.Assigned_To=@Emp_ID and TM.Assigned_by=@Emp_ID
					and TM.Status_ID in ('P','W')


--			Select Distinct TM.Task_ID As [TaskID], PM.Project_Name As [Project], MM.Module_Name As [Module], 
--				TM.Priority_ID As [Priority],  CM.Emp_Name As [Resource],TM.AS_DT As [StartDate], TM.AS_EDT [EndDate],
--				CAST(((DATEDIFF(MINUTE,TM.AS_DT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
--				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
--			From Task_Master TM, Project_Master PM, Module_Master MM, Project_Details PD, Client_Master CM
--			Where TM.Project_ID=PM.Project_ID and TM.Module_ID=MM.Module_ID and TM.Request_ID=PM.Request_ID
--				and TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and TM.Assigned_To=@Emp_ID and TM.Status_ID in ('P','W')
		End
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Task_Request_Operation
-- --------------------------------------------------








    
CREATE Proc [dbo].[USP_Task_Request_Operation]    
    
@TID char(20),    
@TName varchar(100),
@Request_ID Char(20),    
@Change_ID Char(20),    
@Project_Code varchar(100),    
@Phase_ID char(10),
@Module_ID char(20),    
@Priority_ID Char(20),    
@Details varchar(500),
@T_Attachment varchar(250),
@AS_SDT Datetime,    
@AS_EDT Datetime,    
@AS_TT int,    
@AC_SDT Datetime,    
@AC_EDT Datetime,    
@AC_TT int,    
@Assigned_By Char(20),    
@Assigned_To Char(20),   
@Last_Update Datetime, 
@PM_Remark Varchar(500),
@User_Remark Varchar(500),  
@TaskStatus_ID Char(20),    
@Option As Char(5)
   
AS   



    
Begin    
    Declare @CheckRole As Varchar(20)
	Declare @Testing_Detail_ID As varchar(10)

 ---------------------------------Insert, Update and Delete Operation ----------------------    
	If(@Option='1') -- Insert into Task_Request_Master    
	Begin    
		Set @TID=[dbo].GenerateID('4','')    
		Select @Request_ID=Request_ID from Project_Master Where Project_ID=@Project_Code    
    
		Insert Into Task_Master (Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_ID,Task_Detail,T_Attachment,AS_DT,AS_SDT,AS_EDT,AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID )
		values (@TID,@TName,@Request_ID,@Change_ID,Cast(@Project_Code As Char(20)),@Phase_ID,@Module_ID,@Priority_ID,@Details,@T_Attachment,GETDATE(),@AS_SDT,@AS_EDT,@AS_TT,@Assigned_By,@Assigned_To,null,null,0,@Last_Update,@PM_Remark,'',@TaskStatus_ID)      
      
		Insert Into Task_Details (TD_ID,Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_ID,Task_Detail,T_Attachment,AS_DT,AS_SDT,AS_EDT,AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID )
		values ('',@TID,@TName,@Request_ID,@Change_ID,@Project_Code,@Phase_ID,@Module_ID,@Priority_ID,@Details,@T_Attachment,GETDATE(),@AS_SDT,@AS_EDT,@AS_TT,@Assigned_By,@Assigned_To,null,null,0,@Last_Update,@PM_Remark,'',@TaskStatus_ID)      

		Select Task_ID from Task_Master Where Task_ID =@TID    
		
		If((Select Role_ID from Resource_Master where Emp_ID = @Assigned_By) in ('TSTL','TS'))
		Begin
			update tbl_Testing_Requests
			set Tester = @Assigned_To,Assign_Date = @AS_SDT,Assign_EndDate = @AS_EDT, Tester_Remark = @Details,
				Assigned_By = @Assigned_By, [Status] = 'A'
			where Token_Number = @Change_ID

			set @Testing_Detail_ID = DBO.GenerateID('12','')

			Insert into tbl_Testing_RequestsDetails
			Select @Testing_Detail_ID,*,getdate() from tbl_Testing_Requests where Token_Number = @Change_ID
		End

	End    
	--------------------------------------Update Operation --------------------------------    
	Else If(@Option='2')     
	Begin    
		Update Task_Master 
		Set AC_SDT = @AC_SDT, AC_EDT = @AC_EDT, AC_Time = @AC_TT, Remark = @User_Remark, Status_ID = @TaskStatus_ID ,
			Last_Update=@Last_Update
		Where Task_ID=@TID    
		
		Select Task_ID from Task_Master Where Task_ID = @TID  

		If(@TaskStatus_ID='C' and (Select Change_ID From Task_Master Where Task_ID=@TID)<>'')
		Begin
			Update Change_Request_Master
			Set Request_Status_ID='C'
			Where Change_ID=(Select Change_ID From Task_Master Where Task_ID=@TID)

			Insert Into Change_Request_Details 
				Select '',* From Change_Request_Master	
				Where Change_ID=(Select Change_ID From Task_Master Where Task_ID=@TID)
		End

		Insert Into Task_Details 
			Select '',Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_Id,Task_Detail,T_Attachment,AS_DT,AS_SDT,AS_EDT,
				AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID
		From Task_Master
		Where Task_ID=@TID
	End    
	-----------------------------------Insert Create TASK ---------------------------------
	If(@Option='3') -- Insert into Task_Request_Master    
	Begin    
		Set @TID=[dbo].GenerateID('4','')    
		--Select @Request_ID=Request_ID from Project_Master Where Project_ID=@Project_Code 
		Set @Phase_ID=(Select Phase_ID From Phase_Master Where Phase_Name in ('Development','DEVELOPMENT','development'))
    
--		Insert Into Task_Master (Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_ID,Task_Detail,AS_DT,AS_SDT,AS_EDT,AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID )
--		values (@TID,@TName,@Request_ID,@Change_ID,@Project_Code,@Phase_ID,@Module_ID,@Priority_ID,@Details,GETDATE(),@AS_SDT,@AS_EDT,@AS_TT,@Assigned_By,@Assigned_To,@AC_SDT,@AC_EDT,@AC_TT,@Last_Update,@PM_Remark,@User_Remark,@TaskStatus_ID)      
--      
--		Insert Into Task_Details (TD_ID,Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_ID,Task_Detail,AS_DT,AS_SDT,AS_EDT,AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID )
--		values ('',@TID,@TName,@Request_ID,@Change_ID,@Project_Code,@Phase_ID,@Module_ID,@Priority_ID,@Details,GETDATE(),@AS_SDT,@AS_EDT,@AS_TT,@Assigned_By,@Assigned_To,@AC_SDT,@AC_EDT,@AC_TT,@Last_Update,@PM_Remark,@User_Remark,@TaskStatus_ID)      

		Insert Into Task_Master (Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_ID,Task_Detail,T_Attachment,AS_DT,AS_SDT,AS_EDT,AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID )
		values (@TID,@TName,@Request_ID,@Change_ID,Cast(@Project_Code As Char(20)),@Phase_ID,@Module_ID,@Priority_ID,@Details,@T_Attachment,GETDATE(),@AS_SDT,@AS_EDT,@AS_TT,@Assigned_By,@Assigned_To,null,null,0,@Last_Update,@PM_Remark,null,@TaskStatus_ID)      
      
		Insert Into Task_Details (TD_ID,Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_ID,Task_Detail,T_Attachment,AS_DT,AS_SDT,AS_EDT,AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID )
		values ('',@TID,@TName,@Request_ID,@Change_ID,Cast(@Project_Code As Char(20)),@Phase_ID,@Module_ID,@Priority_ID,@Details,@T_Attachment,GETDATE(),@AS_SDT,@AS_EDT,@AS_TT,@Assigned_By,@Assigned_To,null,null,0,@Last_Update,@PM_Remark,null,@TaskStatus_ID)      

		Select Task_ID from Task_Master Where Task_ID =@TID    
	End   

    
 --------------------------------------Select Operation --------------------------------    
	Else If(@Option='21')     
	Begin    
		Select TM.Task_ID,
			(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
			PM.Project_Name , MM.Module_Name ,TM.Task_Name, RPM.Priority_Name As Priority,
			Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
			Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate,Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
			Convert(Varchar,(TM.AC_Time/1440)) + ':' + Convert(Varchar,(TM.AC_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AC_Time%1440)%60) As [Actual Time],
			CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
			CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
		From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM 
		Where TM.Project_ID = PM.Project_ID
			And TM.Priority_ID=RPM.Priority_ID    
			And TM.Module_ID = MM.Module_ID 
			And (TM.Status_ID = @TaskStatus_ID OR TM.Status_ID='R')
			And TM.Assigned_To = @Assigned_To  and TM.Assigned_BY!=@Assigned_To 
		
		Union

		Select TM.Task_ID,
				(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
				PM.Project_Name ,MM.Module_Name ,TM.Task_Name, 
				RPM.Priority_Name As Priority, Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
				Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,
				Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
			Convert(Varchar,(TM.AC_Time/1440)) + ':' + Convert(Varchar,(TM.AC_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AC_Time%1440)%60) As [Actual Time],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
			CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
		From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM 
		Where TM.Project_ID = PM.Project_ID
			And TM.Priority_ID=RPM.Priority_ID 
			And TM.Module_ID = MM.Module_ID And (TM.Status_ID = @TaskStatus_ID OR TM.Status_ID='R')
			and TM.Assigned_To = @Assigned_To  and TM.Assigned_BY=@Assigned_To 

--		Select TM.Task_ID, PM.Project_Name , MM.Module_Name , RPM.Priority_Name As Priority, Convert(varchar(12), TM.AS_SDT) As Task_SDate,   
--			Convert(Varchar(12), TM.AS_EDT) As Task_EDate   
--		From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM     
--		Where TM.Project_ID = PM.Project_ID
--			And TM.Priority_ID=RPM.Priority_ID    
--			And TM.Module_ID = MM.Module_ID 
--			And TM.Status_ID = @TaskStatus_ID    
--			And TM.Assigned_To = @Assigned_To    
	End    

	---------------------------------------- Edit Task Page -------------------------------------------------
	Else If(@Option='22')	
	Begin
		if((Select Role_ID From Client_Master Where Emp_ID=@Assigned_By) = 'PM')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource], 
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Manager=@Assigned_By)
				and TM.Status_ID in ('P','W')
		End
		Else If((Select Role_ID From Client_Master Where Emp_ID=@Assigned_By)='PL')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource],
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Leader=@Assigned_By)
				and TM.Assigned_By=@Assigned_By
				and TM.Status_ID in ('P','W')
		End
	End
	Else If(@Option='23')	
	Begin
		Set @CheckRole=''

		Set @CheckRole = (Select Role_ID From Client_Master Where Emp_ID=@Assigned_By)

		If(@CheckRole='PM')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource], 
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT,  
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Manager=@Assigned_By)
				and TM.Project_ID=@Project_Code
				and TM.Status_ID in ('P','W')
		End
		Else If(@CheckRole='PL')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource], 
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Leader=@Assigned_By)
				and TM.Project_ID=@Project_Code
				and TM.Status_ID in ('P','W')
		End
		Else If(@CheckRole='SYA' OR @CheckRole='AA')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource],
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID=TM.Assigned_To
				And TM.Assigned_By=@Assigned_By
				and TM.Project_ID=@Project_Code
				and TM.Status_ID in ('P','W')
		End
	End	
	Else If(@Option='24')	
	Begin
		Set @CheckRole=''

		Set @CheckRole = (Select Role_ID From Client_Master Where Emp_ID=@Assigned_By)

		If(@CheckRole='PM')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource], 
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Manager=@Assigned_By)
				and TM.Assigned_To=@Assigned_To
				and TM.Status_ID in ('P','W')
		End
		Else If(@CheckRole='PL')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource], 
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Leader=@Assigned_By)
				and TM.Assigned_To=@Assigned_To
				and TM.Status_ID in ('P','W')
		End
		Else If(@CheckRole='SYA' Or @CheckRole='AA')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource], 
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID=@Assigned_To
				And TM.Assigned_By=@Assigned_By
				and TM.Assigned_To=@Assigned_To
				and TM.Status_ID in ('P','W')
		End
	End
	Else If(@Option='25')	
	Begin
		Set @CheckRole=''

		Set @CheckRole = (Select Role_ID From Client_Master Where Emp_ID=@Assigned_By)
		
		If(@CheckRole='PM')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource],
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Manager=@Assigned_By)
				and TM.Project_ID=@Project_Code and TM.Assigned_To=@Assigned_To
				and TM.Status_ID in ('P','W')
		End
		Else If(@CheckRole='PL')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource], 
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Leader=@Assigned_By)
				and TM.Project_ID=@Project_Code and TM.Assigned_To=@Assigned_To
				and TM.Status_ID in ('P','W')
		End
		Else If(@CheckRole='SYA' OR @CheckRole='AA')
		Begin
			Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], PHM.Phase_Name As [Phase], 
					MM.Module_Name As [Module], CM.Emp_Name As [Resource],
					Convert(Varchar(11),AS_SDT,113) As [AS_SDT] , Convert(Varchar(11),AS_EDT,113) AS AS_EDT, 
					cast((TM.AS_Time/(1440)) as varchar(2)) + ':' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast(TM.AS_Time%60 as varchar(2)), 2) as [Assign_Time]
			From Task_Master TM, Client_Master CM, Project_Master PM, Phase_Master PHM, Module_Master MM
			Where TM.Assigned_To=CM.Emp_ID
				and TM.Project_ID=PM.Project_ID and TM.Phase_ID=PHM.Phase_ID and TM.Module_ID=MM.Module_ID
				and CM.Emp_ID=@Assigned_To	and TM.Assigned_BY=@Assigned_By
				and TM.Project_ID=@Project_Code and TM.Assigned_To=@Assigned_To
				and TM.Status_ID in ('P','W')
		End
	End
	---------------------------------------- Edit Task Page -------------------------------------------------
	Else If(@Option='26')
	Begin
		Update Task_Master
		Set	AS_DT=GETDATE(), AS_SDT=@AS_SDT, AS_EDT=@AS_EDT, AS_Time=@AS_TT,Assigned_To=@Assigned_To,PM_Remark=@PM_Remark,
             Status_ID=@TaskStatus_ID        
		Where Task_ID=@TID 

		Insert Into Task_Details 
			Select '',Task_ID,Task_Name,Request_ID,Change_ID,Project_ID,Phase_ID,Module_ID,Priority_Id,Task_Detail,T_Attachment,AS_DT,AS_SDT,AS_EDT,
				AS_Time,Assigned_By,Assigned_To,AC_SDT,AC_EDT,AC_Time,Last_Update,PM_Remark,Remark,Status_ID
		From Task_Master
		Where Task_ID=@TID

		Select @TID
	End
	Else If(@Option='27') --Current Task  on Project Leader page 
	Begin
		Select Distinct TM.Task_ID As [Task ID],
			(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID
			,TM.Change_ID, PM.Project_Name As [Project Name], MM.Module_Name As [Module], 
			TM.Task_Name,CM.Emp_Name As [Resource],TM.AS_SDT As [StartDate],TM.AS_EDT As [EndDate],
			TSM.Task_Status_Name As Current_Status,TM.Last_Update as LastUpdate ,
			Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
			CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
			CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
		From Task_Master TM, Project_Master PM, Module_Master MM,Client_Master CM,Task_Status_Master TSM
		Where TM.Project_ID=PM.Project_ID 
		      and TM.Status_ID = TSM.Task_Status_ID
			  and TM.Module_ID=MM.Module_ID and TM.Request_ID=PM.Request_ID
			  and TM.Assigned_To=CM.Emp_ID and  PM.Project_Leader=@Assigned_By
			  and TSM.Task_Status_ID in('P','W')
		Order BY TM.Task_ID
	End  
	Else If(@Option='28') -- Task Deliver
	Begin

		Set @CheckRole=''
		
		Set @CheckRole = (Select Role_ID From Client_Master Where Emp_ID=@Assigned_By)

		If(@CheckRole='PM')
		Begin
			Select Task_ID , RequestID ,Project_Name ,Module_Name ,Task_Name ,Assigned_By ,Assigned_To ,Task_SDate,ASTime,Task_EDate,AETime,[Assigned Time],
					Elapsed,Delayed,Last_Update,[Status],[Type]
			From
			(
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status], 'A' As 'Type' 
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY in ((Select Emp_ID from Resource_MAster where Project_MAnager = @Assigned_By and Role_ID = 'PL') union Select @Assigned_By) 
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and TM.AS_EDT < getdate() -- or ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  (CAST((DateDiff(hour,getdate(),AS_EDT)) AS VARCHAR(4)) LIKE '-%')))				
			
				UNION

				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status],'B' as 'Type'
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY in ((Select Emp_ID from Resource_MAster where Project_MAnager = @Assigned_By and Role_ID = 'PL') union Select @Assigned_By) 
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  (CAST((DateDiff(Hour,DateAdd(hh,2,getdate()),AS_EDT)) AS VARCHAR(6)) LIKE '2'))

				UNION

				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status],'C' As 'Type'
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY in ((Select Emp_ID from Resource_MAster where Project_MAnager = @Assigned_By and Role_ID = 'PL') union Select @Assigned_By) 
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and  ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  ((CAST((DateDiff(Hour,DateAdd(hh,2,getdate()),AS_EDT)) AS VARCHAR(6)) not LIKE '2') or (CAST((DateDiff(Hour,getdate(),AS_EDT)) AS VARCHAR(6)) not LIKE '-%')))

				UNION 
		
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status],'D' As 'Type'
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY in ((Select Emp_ID from Resource_MAster where Project_MAnager = @Assigned_By and Role_ID = 'PL') union Select @Assigned_By) 
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and Convert(varchar(12),TM.AS_EDT,113) = Convert(varchar(12),getdate()+1,113)
			)T Order By [Type],Task_ID
		

		End
		
		If(@CheckRole='PL')
		Begin
			Select Task_ID , RequestID,Project_Name,Module_Name,Task_Name,Assigned_By,Assigned_To,Task_SDate,ASTime,Task_EDate,AETime,[Assigned Time],
					Elapsed,Delayed,Last_Update,[Status],[Type]
			From
			(		
						
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status], 'A' As 'Type' 
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY = @Assigned_By
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and TM.AS_EDT < getdate() --or ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  (CAST((DateDiff(hour,getdate(),AS_EDT)) AS VARCHAR(4)) LIKE '-%')))

				UNION
		
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status],'B' as 'Type'
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY = @Assigned_By
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  (CAST((DateDiff(Hour,DateAdd(hh,2,getdate()),AS_EDT)) AS VARCHAR(6)) LIKE '2'))

				UNION

						
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status],'C' As 'Type'
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY = @Assigned_By
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and  ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  ((CAST((DateDiff(Hour,DateAdd(hh,2,getdate()),AS_EDT)) AS VARCHAR(6)) not LIKE '2') or (CAST((DateDiff(Hour,getdate(),AS_EDT)) AS VARCHAR(6)) not LIKE '-%')))

				UNION
		
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
						Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status], 'D'  As  'Type'
				From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
				Where TM.Project_ID = PM.Project_ID		
					And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
					and TM.Assigned_BY = @Assigned_By
					and TM.Status_ID = TSM.Task_Status_ID
					and TM.assigned_By = RSM1.Emp_ID
					and TM.Assigned_To = RSM2.Emp_ID
					and Convert(varchar(12),TM.AS_EDT,113) = Convert(varchar(12),getdate()+1,113)
			)T Order By [Type],Task_ID
		End

		If(@CheckRole='DVL')
		Begin
			Select Task_ID , RequestID,Project_Name,Module_Name,Task_Name,Assigned_By,Assigned_To,Task_SDate,ASTime,Task_EDate,AETime,[Assigned Time],
					Elapsed,Delayed,Last_Update,[Status],[Type]
			From
			(
		
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
							Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status], 'A' As 'Type'
					From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
					Where TM.Project_ID = PM.Project_ID		
						And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
						and TM.Assigned_To = @Assigned_By
						and TM.Status_ID = TSM.Task_Status_ID
						and TM.assigned_By = RSM1.Emp_ID
						and TM.Assigned_To = RSM2.Emp_ID
						and TM.AS_EDT < getdate() --or ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  (CAST((DateDiff(hour,getdate(),AS_EDT)) AS VARCHAR(4)) LIKE '-%')))

					UNION
		
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
							Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status],'B' as 'Type'
					From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
					Where TM.Project_ID = PM.Project_ID		
						And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
						and TM.Assigned_To = @Assigned_By
						and TM.Status_ID = TSM.Task_Status_ID
						and TM.assigned_By = RSM1.Emp_ID
						and TM.Assigned_To = RSM2.Emp_ID
						and ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  (CAST((DateDiff(Hour,DateAdd(hh,2,getdate()),AS_EDT)) AS VARCHAR(6)) LIKE '2'))

					UNION

		
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
							Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status], 'C' As 'Type'
					From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
					Where TM.Project_ID = PM.Project_ID		
						And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
						and TM.Assigned_To = @Assigned_By
						and TM.Status_ID = TSM.Task_Status_ID
						and TM.assigned_By = RSM1.Emp_ID
						and TM.Assigned_To = RSM2.Emp_ID
						and  ((Convert(Datetime,Convert(Varchar(12),TM.AS_EDT, 110)) = Convert(Datetime,Convert(Varchar(12),getdate(), 110))) and  ((CAST((DateDiff(Hour,DateAdd(hh,2,getdate()),AS_EDT)) AS VARCHAR(6)) not LIKE '2') or (CAST((DateDiff(Hour,getdate(),AS_EDT)) AS VARCHAR(6)) not LIKE '-%')))

					UNION
		
				Select TM.Task_ID As [Task_ID],
						(Case When TM.Change_ID='' or TM.Change_ID is null Then TM.Request_ID When TM.Change_ID<>'' and TM.Change_ID is not null Then TM.Change_ID End) As RequestID,
						PM.Project_Name as [Project_Name],MM.Module_Name As [Module_Name] ,TM.Task_Name As [Task_Name],RSM1.Emp_Name As [Assigned_By],RSM2.Emp_Name As [Assigned_To] ,
						Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,left(Convert(varchar(25),TM.AS_SDT,108),5) as [ASTime],   
						Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,left(Convert(varchar(25),TM.AS_EDT,108),5) as [AETime],
						Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
						CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
						CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
							Convert(Varchar(12),TM.Last_Update,113) as [Last_Update],TSM.Task_Status_Name As [Status],  'D' As 'Type'
					From Task_Master TM, Project_Master PM, Module_Master MM, Task_Status_Master TSM,Resource_Master RSM1,Resource_Master RSM2
					Where TM.Project_ID = PM.Project_ID		
						And TM.Module_ID = MM.Module_ID And TM.Status_ID in ('P','W')
						and TM.Assigned_To = @Assigned_By
						and TM.Status_ID = TSM.Task_Status_ID
						and TM.assigned_By = RSM1.Emp_ID
						and TM.Assigned_To = RSM2.Emp_ID
						and Convert(varchar(12),TM.AS_EDT,113) = Convert(varchar(12),getdate()+1,113)
			)T Order By [Type],Task_ID

			
		End
	End
End


--Select * from Task_Master
--Select * From Task_Details
--Select * From Task_Status_Master

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_taskFlowChart
-- --------------------------------------------------


  
CREATE proc [dbo].[usp_taskFlowChart]  
@request_id as char(20),  
@Option as char(5)
as  
if(@Option = '1')
Begin
select '1' as 'SrNo','0' as 'Time','Request_Time' as 'App_By' union  
select '2' as 'SrNo',datediff(hour,Request_date,HOD_Approve_Date) as 'Time','HOD' as 'App_By' from dbo.Request_Master where datediff(hour,Request_date,HOD_Approve_Date) >0 and Request_ID =@request_id union  
select '3' as 'SrNo',datediff(hour,HOD_Approve_Date,Admin_Approve_Date) as 'Time','Admin' as 'App_By' from dbo.Request_Master where datediff(hour,HOD_Approve_Date,Admin_Approve_Date) >'0'and Request_ID =@request_id  
order by SrNo
End

if(@Option = '2')
Begin
select '1' as 'SrNo','0' as 'Time','Request_Time' as 'App_By' union  
select '2' as 'SrNo',datediff(hour,Changed_date,HOD_Approve_Date) as 'Time','HOD' as 'App_By' from dbo.Change_Request_Master where datediff(hour,Changed_date,HOD_Approve_Date) >0 and Change_ID =@request_id union  
select '3' as 'SrNo',datediff(hour,HOD_Approve_Date,Admin_Approve_Date) as 'Time','Admin' as 'App_By' from dbo.Change_Request_Master where datediff(hour,HOD_Approve_Date,Admin_Approve_Date) >'0'and Change_ID =@request_id  
order by SrNo
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Team_Productivity_Report
-- --------------------------------------------------






CREATE PROC [dbo].[USP_Team_Productivity_Report]
------------------------------------------------------------------------------------------
--Description	: This report can be use to view the view and measure the team performance of Manager within period 
--Created On	:	
--Created By	:
--Modified On	:
--Modified By	:
-- Refer This Format to Calculation (Cast(VALUE As Decimal(10,2)))
------------------------------------------------------------------------------------------

@PM AS Char(20),
@PM_Name AS Varchar(200),
@FromDate AS Datetime,
@EndDate AS Datetime,
@User AS Char(20),
@Role AS Char(20),
@Option AS Int

AS
Begin

	Declare @TW INT
	Declare @TWH INT
	Declare @TWHD As Int
	Declare @TWHHrs As Int

	If(@PM_Name<>'')
	Begin
		Set @PM = (Select Emp_ID From Resource_Master Where UPPER(Emp_Name) like UPPER(@PM_Name))
	End
	

	If(@FromDate='1/1/1900 12:00:00 AM' AND @EndDate='1/1/1900 12:00:00 AM')
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End

	
--	Set @TW = (Select dbo.GetTotalWorkingDays(@FromDate,@EndDate)) 
--	set @TWHD = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))
--	set @TWHHrs = (Select DBO.[GetHarmonyWorkingHours]('',@FromDate, @EndDate))


	Set @TW = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))
	Set @TWH = (Select DBO.[GetHarmonyWorkingHours] ('',@FromDate, @EndDate)) 


	--Set @TW = (((Select dbo.getWorkingDays(@FromDate,@EndDate)) * 8) + ((Select dbo.GetSaturdayDays(@FromDate,@EndDate)) * 5 )) 

	If(@Option=1) -- ALL PM
	Begin	
		Select PM As PM, ISNULL(TWD,'0') As TWD, ISNULL(TWHD,'0') As TWHD, ISNULL(Resources,'0') AS Res, 
			ISNULL(TWHr, '0') As TWHr, ISNULL(TWHHr, '0') As TWHHr, ISNULL(TWSHr, '0') As TWSHr, 
			ISNULL(TWRHHr,'0') AS [TWRHHr], ISNULL(TAT,'0') As TAT, ISNULL(TUT,'0') As [TUT],
			ISNULL(UT,'0') As UT, ISNULL(IUT, '0') As IUT
		From
		(
			Select PM, Emp_ID, TWD, TWHD, Resources, TWHr, TWHHr, [TWSHr],TWRHHr, TAT, TUT, UT, IUT, 'A' Flag
			From
			(
				Select Emp_Name AS PM, Emp_ID, TWD, TWHD, Resources, TWHr, TWHHr, 
						(Resources * TWHr) As [TWSHr],TWRHHr, 
						Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) As Decimal(10)) AS [TAT] ,
						Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char)) As Decimal(10)) AS [TUT],
						(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWRHHr As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS UT,				
						(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast((Resources * TWHr) As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS IUT				
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TWD],
							(Select DBO.[GetHarmonyDays] (RSM.Emp_ID,@FromDate, @EndDate)) AS [TWHD],
							(Select Count(R.Emp_ID) From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								As Resources, 
							@TWH As [TWHr],
							(Select DBO.[GetHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWHHr],
							(Select DBO.[GetTeamHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWRHHr],
							ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TAT, 
							ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TUT
					From Resource_Master RSM With (nolock)
					Where Role_ID in ('PM','DBAPM','SYA') And Active_Status=1 And Emp_ID Not in ('P00045')
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T
			)T

			UNION

			Select  'Total' AS PM,'' AS Emp_ID, TWD, '' As TWHD, Resources, TWHr,TWHHr, TWSHr,TWRHHr,
				Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) AS Decimal(10)) AS [TAT] ,
				Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char))As Decimal(10)) AS [TUT] ,
				(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWRHHr As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS UT,				
				(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSHr As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS IUT,	 
				'B' As Flag
			From
			(
				Select TWD, SUM(Resources) AS Resources, SUM(TWHr) AS TWHr, SUM(TWHHr) AS TWHHr, sum(TWRHHr) As TWRHHr,
					Sum(TWSHr) As TWSHr, Sum(TAT) As TAT, SUM(TUT) As TUT
				From
				(
					Select Emp_Name AS PM, Emp_ID, TWD, TWHD, Resources, TWHr, TWHHr, 
							(Resources * TWHr) As [TWSHr],TWRHHr, [TAT], [TUT]
					From
					(
						Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TWD],
								(Select DBO.[GetHarmonyDays] (RSM.Emp_ID,@FromDate, @EndDate)) AS [TWHD],
								(Select Count(R.Emp_ID) From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
									As Resources, 
								@TWH As [TWHr],
								(Select DBO.[GetHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWHHr],
								(Select DBO.[GetTeamHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWRHHr],
								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
										Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
										And TM.Assigned_To in 
										((Select R.Emp_ID From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
								  ),0) As TAT,
								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
										Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
										And TM.Assigned_To in 
										(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
								  ),0) As TUT
						From Resource_Master RSM with (nolock)
						Where Role_ID in ('PM','DBAPM','SYA') And Active_Status=1 And Emp_ID Not in ('P00045')
						Group By RSM.Emp_Name, RSM.Emp_ID
					) T
				)T Group By TWD
			)T
		) T
		Order By Flag, PM

	End
	Else If(@Option=2) -- Particular PM
	Begin	
			Select PM As PM, ISNULL(TWD,'0') As TWD, ISNULL(TWHD,'0') As TWHD, ISNULL(Resources,'0') AS Res, 
				ISNULL(TWHr, '0') As TWHr, ISNULL(TWHHr, '0') As TWHHr, ISNULL(TWSHr, '0') As TWSHr, 
				ISNULL(TWRHHr,'0') AS [TWRHHr], ISNULL(TAT,'0') As TAT, ISNULL(TUT,'0') As [TUT],
				ISNULL(UT,'0') As UT, ISNULL(IUT, '0') As IUT
			From
			(
				Select Emp_Name AS PM, Emp_ID, TWD, TWHD, Resources, TWHr, TWHHr, 
						(Resources * TWHr) As [TWSHr],TWRHHr, 
						Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) As Decimal(10)) AS [TAT] ,
						Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char)) As Decimal(10)) AS [TUT],
						(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWRHHr As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS UT,				
						(Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast((Resources * TWHr) As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS IUT				
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TWD],
							(Select DBO.[GetHarmonyDays] (RSM.Emp_ID,@FromDate, @EndDate)) AS [TWHD],
							(Select Count(R.Emp_ID) From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								As Resources, 
							@TWH As [TWHr],
							(Select DBO.[GetHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWHHr],
							(Select DBO.[GetTeamHarmonyHours] (RSM.Emp_ID,@FromDate, @EndDate)) As [TWRHHr],
							ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R with (nolock) Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TAT, 
							ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TUT
					From Resource_Master RSM With (nolock)
					Where Role_ID in ('PM','DBAPM','SYA') And Active_Status=1 And RSM.Emp_ID=@PM
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T
			)T


--		Select Emp_Name AS PM, Emp_ID, TW, TWD, Resources, TWH, 
--				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
--				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  , 
--				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
--				(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
--					When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
--					Else 0 End) AS [TP]
--		From
--		(
--			Select RSM.Emp_Name, RSM.Emp_ID, @TW AS TW, @TWHD  AS [TWD],
--					(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
--						As Resources, 
--					(@TWHHrs * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
--						AS [TWH], 
----				(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
----				(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
----				(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
----					Then (  (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
----					Else  (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
----				)AS [TWH], 
--				ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
--							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--							And TM.Assigned_To in 
--							((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
--					  ),0) As TAT,
--				ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
--							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--							And TM.Assigned_To in 
--							(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
--					  ),0) As TUT
--			From Resource_Master RSM
--			Where Role_ID in ('PM','DBAPM') And RSM.Emp_ID=@PM And Active_Status=1
--			Group By RSM.Emp_Name, RSM.Emp_ID
--		) T
--		Order By TAT DESC
	End
	Else If(@Option=3)
	Begin

		Select Res , TW AS TW, ISNULL(TWD,'0') AS TWD, TWSH As TWSH,  ISNULL(TWH,'0') As TWH, 
				TAT AS TAT, TUT As TUT, UT AS UT, IUT As IUT 
		From
		(
			Select RES, EMP_ID, TW, TWSH, TWD, TWH, TAT, TUT, UT, IUT, 'A' AS Flag 
			From 
			(	
				Select Emp_Name As RES, Emp_ID, TW, TWSH, TWD, TWH, 
					Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) As Decimal(10)) AS [TAT] ,
					Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char)) As Decimal(10)) AS [TUT],
					ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS UT,				
					ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS IUT
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As TW, @TWH As TWSH,
						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],  
						(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To=	RSM.Emp_ID
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To = RSM.Emp_ID
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM   
						And Active_Status=1 
					Group By RSM.Emp_Name, RSM.Emp_ID

				) T
			) T

			Union 

			Select 'Total' AS Res, '' AS Emp_ID, TW, TWSH, '' As TWD, TWH, 
				Cast((rtrim(Cast((TAT/60) As Char))+ '.' + Cast((TAT%60) As Char)) As Decimal(10)) AS [TAT] ,
				Cast((rtrim(Cast((TUT/60) As Char))+ '.' + Cast((TUT%60) As Char)) As Decimal(10)) AS [TUT],
				ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS UT,				
				ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS IUT,
				 'B' AS Flag 
			From
			(
				Select TW, TWSH, TWD, TWH, TAT, TUT, UT, IUT
				From 
				(
					Select TW, SUM(TWSH) As TWSH, SUM(TWD) AS TWD, SUM(TWH) AS TWH, SUM(TAT) AS TAT, SUM(TUT) AS TUT, 
							SUM(UT) AS UT, SUM(IUT) AS IUT
					From		
					(
						Select TW, TWSH, ISNULL(TWD,'0') As TWD, ISNULL(TWH, '0') AS TWH, TAT, TUT,
							ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS UT,				
							ISNULL((Case When TUT<>0 And TUT IS NOT NULL Then (Cast((((((Cast(TUT As Decimal(10,2))) * 100)/ ((Cast(TWSH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End),'0') AS IUT
						From
						(
							Select @TW AS [TW], @TWH As TWSH,
								(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
								(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate)) AS TWH,
								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To=	RSM.Emp_ID
									  ),0) As TAT,
								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To = RSM.Emp_ID
									  ),0) As TUT
							From Resource_Master RSM
							Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM  
								And Active_Status=1 
							Group By Emp_ID
						) T
					) T	Group By TW
				)T 
			)T
		) T
		Order By Flag


--		Select Res, Emp_ID, TW, TWD, TWH, TAT, TUT, PER_PM, Productivity, Flag 
--		From
--		(
--			Select RES, EMP_ID, TW, TWD, TWH, TAT, TUT, PER_PM, Productivity, 'A' AS Flag 
--			From 
--			(	
--				Select Emp_Name As RES, Emp_ID, TW, TWD, TWH, 
--						(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
--						(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
--						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
--						(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
--						When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
--						Else 0 End) AS [Productivity]
--				From
--				(
--					Select RSM.Emp_Name, RSM.Emp_ID, @TW As TW,
--						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],  
--						(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
--						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
--									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--									And TM.Assigned_To=	RSM.Emp_ID
--							  ),0) As TAT,
--						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
--									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--									And TM.Assigned_To = RSM.Emp_ID
--							  ),0) As TUT
--					From Resource_Master RSM
--					Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM   
--						And Active_Status=1 
--					Group By RSM.Emp_Name, RSM.Emp_ID
--
--				) T
--			) T
--
--			Union 
--
--			Select 'Total' AS Res, '' AS Emp_ID, TW, '' As TWD, TWH, 
--				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
--				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
--				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
--				(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
--					When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
--					Else 0 End) AS [Productivity],
--				 'B' AS Flag 
--			From
--			(
--				Select TW, TWD, TWH, TAT, TUT, PER_PM, Productivity
--				From 
--				(
--					Select TW, SUM(TWD) AS TWD, SUM(TWH) AS TWH, SUM(TAT) AS TAT, SUM(TUT) AS TUT, 
--							SUM(PER_PM) AS PER_PM, SUM(Productivity) AS Productivity
--					From		
--					(
--						Select TW, TWD, TWH, TAT, TUT,
--							(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
--							(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
--								When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
--								Else 0 End) AS [Productivity]
--						From
--						(
--							Select @TW AS [TW], (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
--								 (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
--								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
--											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--											And TM.Assigned_To=	RSM.Emp_ID
--									  ),0) As TAT,
--								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
--											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--											And TM.Assigned_To = RSM.Emp_ID
--									  ),0) As TUT
--							From Resource_Master RSM
--							Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM  
--								And Active_Status=1 
--							Group By Emp_ID
--						) T
--					) T	Group By TW
--				)T 
--			)T
--		) T
--		Order By Flag


--		Select Emp_Name As RES, Emp_ID, TWD, TWH, 
--				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
--				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
--				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
--			(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
--				When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
--				Else 0 End) AS [Productivity]
--		From
--		(
--			Select RSM.Emp_Name, RSM.Emp_ID, @TWD AS [TWD], @TWH AS TWH,
--				ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
--							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--							And TM.Assigned_To=	RSM.Emp_ID
--					  ),0) As TAT,
--				ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
--							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--							And TM.Assigned_To = RSM.Emp_ID
--					  ),0) As TUT
--			From Resource_Master RSM
--			Where Role_ID in ('PL','DVL') And RSM.Project_Manager=@PM  
--				And Active_Status=1 
--			Group By RSM.Emp_Name, RSM.Emp_ID
--
--		) T
		--Order By TAT DESC
 
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Team_Productivity_Report_OLD
-- --------------------------------------------------






Create PROC [dbo].[USP_Team_Productivity_Report_OLD]
------------------------------------------------------------------------------------------
--Description	: This report can be use to view the view and measure the team performance of Manager within period 
--Created On	:	
--Created By	:
--Modified On	:
--Modified By	:
-- Refer This Format to Calculation (Cast(VALUE As Decimal(10,2)))
------------------------------------------------------------------------------------------

@PM AS Char(20),
@PM_Name AS Varchar(200),
@FromDate AS Datetime,
@EndDate AS Datetime,
@User AS Char(20),
@Role AS Char(20),
@Option AS Int

AS
Begin

	Declare @TW INT
	Declare @TWH INT
	Declare @TWHD As Int
	Declare @TWHHrs As Int

	If(@PM_Name<>'')
	Begin
		Set @PM = (Select Emp_ID From Resource_Master Where UPPER(Emp_Name) like UPPER(@PM_Name))
	End
	

	If(@FromDate='1/1/1900 12:00:00 AM' AND @EndDate='1/1/1900 12:00:00 AM')
	Begin
		Set @FromDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110)
		Set @EndDate = CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110)
	End

	
	Set @TW = (Select dbo.GetTotalWorkingDays(@FromDate,@EndDate)) 
	set @TWHD = (Select DBO.[GetHarmonyWorkingDays]('',@FromDate, @EndDate))
	set @TWHHrs = (Select DBO.[GetHarmonyWorkingHours]('',@FromDate, @EndDate))
	--Set @TW = (((Select dbo.getWorkingDays(@FromDate,@EndDate)) * 8) + ((Select dbo.GetSaturdayDays(@FromDate,@EndDate)) * 5 )) 

	If(@Option=1) -- ALL PM
	Begin	
		Select PM, Emp_ID, TW, TWD, Resources, TWH, TAT, TUT, PER_PM, TP, Flag
		From
		(
			Select PM, Emp_ID, TW, TWD, Resources, TWH, TAT, TUT, PER_PM, TP, 'A' As Flag
			From
			(
				Select Emp_Name AS PM, Emp_ID, TW, TWD, Resources, TWH, 
						(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
						(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT] , 
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
							--When (TUT > TAT And TAT<>0) Then CAST(((TAT-TUT)/ 100) AS DECIMAL(10,2)) 
							When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
							Else 0 End) AS [TP] 
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TW],@TWHD  AS [TWD],
						(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
							As Resources, 
						(@TWHHrs * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							AS [TWH], 
--						  (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
--						(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
--						(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
--							Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
--							Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
--						)AS [TWH], 
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PM') And Active_Status=1
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T
			)T

			UNION

			Select  'Total' AS PM,'' AS Emp_ID, TW, '' As TWD, Resources, TWH,
				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT] ,
				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT],
				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
				(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
					When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
					Else 0 End) AS [TP], 
				'B' As Flag
			From
			(
				Select SUM(Resources) AS Resources, TW As [TW], SUM(TWD) As TWD ,SUM(TWH) AS TWH,
					SUM(TAT) AS TAT,SUM(TUT) AS TUT, SUM(PER_PM) AS PER_PM, SUM(TP) AS TP, 'B' Flag
				From 
				(
					Select TWD, Resources, [TW], TWH, TAT, TUT, 
							(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
							(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
							When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
								Else 0 End) AS [TP] 
					From
					(
						Select RSM.Emp_Name, RSM.Emp_ID, @TW AS [TW],@TWHD  AS [TWD],
							(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
								As Resources, 
							(@TWHHrs * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
								AS [TWH], 
--							(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
--							(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
--							(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
--								Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
--								Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
--							)AS [TWH], 
							ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
										Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
										And TM.Assigned_To in 
										((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
								  ),0) As TAT,
							ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
										Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
										And TM.Assigned_To in 
										(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
								  ),0) As TUT
						From Resource_Master RSM
						Where Role_ID in ('PM','DBAPM') And Active_Status=1
						Group By RSM.Emp_Name, RSM.Emp_ID
					) T 
				) T group By TW
			)T
		) T
		Order By Flag

	End
	Else If(@Option=2) -- Particular PM
	Begin	

		Select Emp_Name AS PM, Emp_ID, TW, TWD, Resources, TWH, 
				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  , 
				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
				(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
					When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
					Else 0 End) AS [TP]
		From
		(
			Select RSM.Emp_Name, RSM.Emp_ID, @TW AS TW, @TWHD  AS [TWD],
					(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
						As Resources, 
					(@TWHHrs * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
						AS [TWH], 
--				(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
--				(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
--				(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
--					Then (  (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
--					Else  (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
--				)AS [TWH], 
				ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
							And TM.Assigned_To in 
							((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
					  ),0) As TAT,
				ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
							And TM.Assigned_To in 
							(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) )
					  ),0) As TUT
			From Resource_Master RSM
			Where Role_ID in ('PM','DBAPM') And RSM.Emp_ID=@PM And Active_Status=1
			Group By RSM.Emp_Name, RSM.Emp_ID
		) T
		Order By TAT DESC
	End
	Else If(@Option=3)
	Begin

		Select Res, Emp_ID, TW, TWD, TWH, TAT, TUT, PER_PM, Productivity, Flag 
		From
		(
			Select RES, EMP_ID, TW, TWD, TWH, TAT, TUT, PER_PM, Productivity, 'A' AS Flag 
			From 
			(	
				Select Emp_Name As RES, Emp_ID, TW, TWD, TWH, 
						(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
						(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
						When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
						Else 0 End) AS [Productivity]
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As TW,
						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],  
						(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To=	RSM.Emp_ID
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To = RSM.Emp_ID
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM   
						And Active_Status=1 
					Group By RSM.Emp_Name, RSM.Emp_ID

				) T
			) T

			Union 

			Select 'Total' AS Res, '' AS Emp_ID, TW, '' As TWD, TWH, 
				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
				(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
					When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
					Else 0 End) AS [Productivity],
				 'B' AS Flag 
			From
			(
				Select TW, TWD, TWH, TAT, TUT, PER_PM, Productivity
				From 
				(
					Select TW, SUM(TWD) AS TWD, SUM(TWH) AS TWH, SUM(TAT) AS TAT, SUM(TUT) AS TUT, 
							SUM(PER_PM) AS PER_PM, SUM(Productivity) AS Productivity
					From		
					(
						Select TW, TWD, TWH, TAT, TUT,
							(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
							(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
								When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
								Else 0 End) AS [Productivity]
						From
						(
							Select @TW AS [TW], (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
								 (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To=	RSM.Emp_ID
									  ),0) As TAT,
								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To = RSM.Emp_ID
									  ),0) As TUT
							From Resource_Master RSM
							Where Role_ID in ('PL','DVL','DBAPL') And RSM.Project_Manager=@PM  
								And Active_Status=1 
							Group By Emp_ID
						) T
					) T	Group By TW
				)T 
			)T
		) T
		Order By Flag


--		Select Emp_Name As RES, Emp_ID, TWD, TWH, 
--				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
--				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
--				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
--			(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
--				When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
--				Else 0 End) AS [Productivity]
--		From
--		(
--			Select RSM.Emp_Name, RSM.Emp_ID, @TWD AS [TWD], @TWH AS TWH,
--				ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
--							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--							And TM.Assigned_To=	RSM.Emp_ID
--					  ),0) As TAT,
--				ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
--							Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
--							And TM.Assigned_To = RSM.Emp_ID
--					  ),0) As TUT
--			From Resource_Master RSM
--			Where Role_ID in ('PL','DVL') And RSM.Project_Manager=@PM  
--				And Active_Status=1 
--			Group By RSM.Emp_Name, RSM.Emp_ID
--
--		) T
		--Order By TAT DESC
 
	End

End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Team_Productivity_Report_ResourceSSRS 
-- --------------------------------------------------

create PROC [dbo].[USP_Team_Productivity_Report_ResourceSSRS ]
------------------------------------------------------------------------------------------
--Description	: This report can be use to view the view and measure the team performance of Manager within period 
--Created On	:	
--Created By	:
--Modified On	:
--Modified By	:
-- Refer This Format to Calculation (Cast(VALUE As Decimal(10,2)))
------------------------------------------------------------------------------------------


@FromDate AS Datetime,
@EndDate AS Datetime

AS

Declare @TW INT
Declare @TWH INT
Select Res, Emp_ID, TW, TWD, TWH, TAT, TUT, PER_PM, Productivity, Flag 
		From
		(
			Select RES, EMP_ID, TW, TWD, TWH, TAT, TUT, PER_PM, Productivity, 'A' AS Flag 
			From 
			(	
				Select Emp_Name As RES, Emp_ID, TW, TWD, TWH, 
						(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
						(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
						When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
						Else 0 End) AS [Productivity]
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As TW,
						(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],  
						(DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To=	RSM.Emp_ID
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To = RSM.Emp_ID
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PL','DVL') 
						And Active_Status=1 
					Group By RSM.Emp_Name, RSM.Emp_ID

				) T
			) T

			Union 

			Select 'Total' AS Res, '' AS Emp_ID, TW, '' As TWD, TWH, 
				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT]  ,
				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
				(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
					When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
					Else 0 End) AS [Productivity],
				 'B' AS Flag 
			From
			(
				Select TW, TWD, TWH, TAT, TUT, PER_PM, Productivity
				From 
				(
					Select TW, SUM(TWD) AS TWD, SUM(TWH) AS TWH, SUM(TAT) AS TAT, SUM(TUT) AS TUT, 
							SUM(PER_PM) AS PER_PM, SUM(Productivity) AS Productivity
					From		
					(
						Select TW, TWD, TWH, TAT, TUT,
							(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
							(Case When (TUT <= TAT And TUT<>0) Then (((TUT*100/TAT) * 100)/100)
								When (TUT > TAT And TAT<>0) Then ((((TAT-TUT)*100/TAT) * 100)/100) 
								Else 0 End) AS [Productivity]
						From
						(
							Select @TW AS [TW], (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
								 (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  AS TWH,
								ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To=	RSM.Emp_ID
									  ),0) As TAT,
								ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
											Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
											And TM.Assigned_To = RSM.Emp_ID
									  ),0) As TUT
							From Resource_Master RSM
							Where Role_ID in ('PL','DVL')
								And Active_Status=1 
							Group By Emp_ID
						) T
					) T	Group By TW
				)T 
			)T
		) T
		Order By Flag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Team_Productivity_Report_SSRS
-- --------------------------------------------------




CREATE PROC [dbo].[USP_Team_Productivity_Report_SSRS]
------------------------------------------------------------------------------------------
--Description	: This report can be use to view the view and measure the team performance of Manager within period 
--Created On	:	
--Created By	:
--Modified On	:
--Modified By	:
-- Refer This Format to Calculation (Cast(VALUE As Decimal(10,2)))
------------------------------------------------------------------------------------------




AS

Declare @TW INT
Declare @TWH INT
Declare @FromDate datetime
Declare @EndDate datetime
	
Set @FromDate='11/01/2010'
Set @EndDate=getdate()

Set @TW = (Select dbo.GetTotalWorkingDays(@FromDate,@EndDate)) 
Select PM as [Project_Manager], TW as [Total_Working_Hours] , TWD as [Total_Harmony_Working_Days] , Resources, TWH as [Total_Working_Hours], TAT as [Total_Assign_Time], TUT as [Total_Utilization_Time], PER_PM as [PM], TP AS [Team_Performance]
		From
		(
			Select PM , Emp_ID, TW, TWD, Resources, TWH, TAT, TUT, PER_PM, TP, 'A' As Flag
			From
			(
				Select Emp_Name AS PM, Emp_ID, TW, TWD, Resources, TWH, 
						(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT]  ,
						(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT] , 
						(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
						(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
							--When (TUT > TAT And TAT<>0) Then CAST(((TAT-TUT)/ 100) AS DECIMAL(10,2)) 
							When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
							Else 0 End) AS [TP] 
				From
				(
					Select RSM.Emp_Name, RSM.Emp_ID, @TW As [TW],
						  (DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate))  AS [TWD],
						(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
						(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
							Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
							Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
						)AS [TWH], 
						ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
									 Union Select RSM.Emp_ID)
							  ),0) As TAT,
						ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
									Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
									And TM.Assigned_To in 
									(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
									 Union Select RSM.Emp_ID)
							  ),0) As TUT
					From Resource_Master RSM
					Where Role_ID in ('PM') And Active_Status=1
					Group By RSM.Emp_Name, RSM.Emp_ID
				) T
			)T

			UNION

			Select  'Total' AS PM,'' AS Emp_ID, TW, '' As TWD, Resources, TWH,
				(rtrim(Cast((TAT/60) As Char))+ ':' + Cast((TAT%60) As Char)) AS [TAT] ,
				(rtrim(Cast((TUT/60) As Char))+ ':' + Cast((TUT%60) As Char)) AS [TUT],
				(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
				(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
					When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
					Else 0 End) AS [TP], 
				'B' As Flag
			From
			(
				Select SUM(Resources) AS Resources, TW As [TW], SUM(TWD) As TWD ,SUM(TWH) AS TWH,
					SUM(TAT) AS TAT,SUM(TUT) AS TUT, SUM(PER_PM) AS PER_PM, SUM(TP) AS TP, 'B' Flag
				From 
				(
					Select TWD, Resources, [TW], TWH, TAT, TUT, 
							(Case When TAT<>0 And TUT<>0 Then (Cast((((((Cast(TAT As Decimal(10,2))) * 100)/ ((Cast(TWH As Decimal(10,2))) * 60)) * 100)/100) As Decimal(10))) Else 0 End) AS PER_PM,				
							(Case When (TUT <= TAT And TUT<>0) Then ((((TUT)*100/TAT) * 100)/100) 
							When (TUT > TAT And TAT<>0) Then  (((((TAT-TUT)*100)/ TAT) * 100)/100)
								Else 0 End) AS [TP] 
					From
					(
						Select RSM.Emp_Name, RSM.Emp_ID, @TW AS [TW],
							(DBO.[GetHarmonyDays](RSM.Emp_ID,@FromDate, @EndDate)) AS [TWD],
							(Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) As Resources, 
							(CASE When (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) > 1
								Then ( (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  * (Select Count(R.Emp_ID) From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1))
								Else (DBO.[GetHarmonyHours](RSM.Emp_ID,@FromDate, @EndDate))  End
							)AS [TWH], 
							ISNULL(( Select SUM(TM.AS_Time) From Task_Master TM 
										Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
										And TM.Assigned_To in 
										((Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
										 Union Select RSM.Emp_ID)
								  ),0) As TAT,
							ISNULL(( Select SUM(TM.AC_Time) From Task_Master TM 
										Where (Convert(Varchar(12),TM.AS_SDT,110) Between @FromDate And @EndDate)
										And TM.Assigned_To in 
										(( Select R.Emp_ID From Resource_Master R Where R.Project_Manager=RSM.Emp_ID And Active_Status=1) 
										 Union Select RSM.Emp_ID)
								  ),0) As TUT
						From Resource_Master RSM
						Where Role_ID in ('PM') And Active_Status=1
						Group By RSM.Emp_Name, RSM.Emp_ID
					) T 
				) T group By TW
			)T
		) T
		Order By Flag

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Testing_Operation
-- --------------------------------------------------



-- =============================================
-- Author:		Kapil Desai
-- Create date: 06-May-2010
-- Description:	Created for Testing Process
-- =============================================
CREATE PROCEDURE [dbo].[usp_Testing_Operation]
(
 @Token varchar(20),
 @TestingType char(20),
 @ProjectName varchar(50),
 @Module varchar(50),
 @RequirementType char(20),
 @UserRequirement varchar(250),
 @URAttachment varchar(250),
 @DeveloperRemark varchar(250),
 @DeveloperAttach varchar(250),
 @EndDate datetime,
 @RequestedBy char(10),
 @AssignDate datetime,
 @Tester char(10),
 @Tester_Remark varchar(500),
 @CloseDate datetime,
 @Status char(5),
 @TesterAttach as varchar(250),
 @Option char(5)
)
AS
BEGIN
	Declare @Testing_Detail_ID as varchar(10)


	Declare @FDate As Datetime
	Declare @EDate As Datetime
	
	Set @FDate = CONVERT(Datetime,CONVERT(Varchar(11),@AssignDate,113))
	Set @EDate = CONVERT(Datetime,CONVERT(Varchar(11),@CloseDate,113))


	 If(@Option = 'I') ----Insert Test Request
	  Begin 
		Declare @ID varchar (25)
		Declare @ProjectID char (20)
		
		Set @ID = DBO.GenerateID('6',@ProjectName) ----Change '0000001' to ProjectID after integration
		Set @ProjectID = @ProjectName 
		Set @ProjectName = (Select Project_Name from Project_Master where Project_ID = @ProjectID)		

		Insert into tbl_Testing_Requests (Token_Number, Request_Type, Project_ID ,Project_Name, Module, Requirement_Type, Brief_User_Requirement, Brief_Requirement_Attachement, Developer_Remark, Developer_Attachement,Tester_Attachment, Desirable_End_Date, Request_By, Request_Date,Status)
		Values(@ID, @TestingType,@ProjectID, @ProjectName, @Module, @RequirementType, @UserRequirement, @URAttachment, @DeveloperRemark, @DeveloperAttach, @TesterAttach,@EndDate, @RequestedBy, GetDate(), @Status)

		set @Testing_Detail_ID = DBO.GenerateID('12','')

		Insert into tbl_Testing_RequestsDetails
		Select @Testing_Detail_ID,*,getdate() from tbl_Testing_Requests where Token_Number = @ID
				
		Select @ID		

		Select emailadd from Client_MAster where Role_ID in ('TS','TSTL')
	End 
	
	Else If(@Option = 'MI') --To get Email ID of TestTeam
		Begin
			Select TR.Token_Number , TR.Request_By , TR.Project_Name ,CM.emailadd 
			from tbl_Testing_Requests TR,Client_MAster CM ,Resource_Master RM
			where CM.Role_ID = RM.Role_ID and RM.Role_ID in ('TS','TSTL')  and Token_Number = @Token
				and CM.Emp_ID = RM.Emp_ID
		End
	
	Else If(@Option = 'N') ----Get New Testing Request for Tester Team Leader/Tester
	Begin 
		Select distinct Token, [Request Type], [Project], [Module], [Req Type], [Expected End Date], [Requested By]
		From
		(
			Select distinct TR.Token_Number as Token, TR.Request_Type as [Request Type], TR.Project_Name as [Project], 
					(case When TR.Module=MM.Module_ID Then MM.Module_Name When TR.Module='ALL' Then 'ALL' End) As [Module],
				 TR.Requirement_Type as [Req Type], 
				Convert(varchar(12), TR.Desirable_End_Date) as [Expected End Date], RSM.Emp_Name as [Requested By]
			From tbl_Testing_Requests TR, Resource_Master RSM , Module_Master MM 
			Where TR.Status = 'P' And RSM.Emp_ID = TR.Request_By 
		) T
		Where T.Module<>'' And T.Module IS NOT NULL
		Order by T.Token
	End

	Else If(@Option = 'P') ----Get Pending Test Request for Tester Team Leader/TS
	Begin			
			Select TR.Token_Number as Token, TR.Request_Type as [Request Type], TR.Project_Name as [Project], 
				(case when TR.Module = 'ALL' Then TR.Module when TR.Module <> 'ALL' Then (Select Module_NAme from module_MAster where TR.Module = Module_ID )End)As [Module] 
				, TR.Requirement_Type as [Req Type],Convert(varchar(12),TR.Request_Date) as  [Request_Date],
				Convert(varchar(12),TR.Desirable_End_Date) as  [ExpectedDate],
				RSM.Emp_Name as [Requested By],Convert(varchar(12),TR.Assign_Date) as [StartDate],
				Convert(varchar(12),TR.Assign_EndDate) as [EndDate],RSM1.Emp_Name as [Tester],
				TSM.Testing_Status_Name as [Status]
			From tbl_Testing_Requests TR
				inner join Resource_Master RSM on RSM.Emp_ID = TR.Request_By
				inner join Testing_Status_Master TSM on TSM.Testing_Status_ID = TR.Status
				inner join Resource_Master RSM1 on RSM1.Emp_ID = TR.Tester
			Where TR.Status in ('W','A')
			Order by TR.Token_Number 			
	End 

	Else If(@Option = 'PT') ----Get Pending Task for Tester
	Begin 
		Select Token_Number as Token, Request_Type as [Request Type], Project_Name as [Project],
			 (case when TR.Module = 'ALL' Then TR.Module when TR.Module <> 'ALL' Then (Select Module_NAme from module_MAster where TR.Module = Module_ID )End)As [Module] 
			, Requirement_Type as [Req Type],
			Cast(Assign_Date as Varchar(12)) + ' ' +RIGHT(cast(Assign_STime as varchar(4)), 4) as [StartDate], 
			Cast(Assign_EndDate as Varchar(12)) + ' ' +RIGHT(cast(Assign_ETime as varchar(4)), 4) as [EndDate], 
			CM.Emp_Name as Assigned_By,RSM1.Emp_Name as [Tester],TSM.Testing_Status_Name as [Status]
		From tbl_Testing_Requests TR
			inner join Client_Master CM on CM.Emp_ID = TR.Assigned_By
			inner join Resource_Master RSM1 on RSM1.Emp_ID = TR.Tester
			inner join Testing_Status_Master TSM on TSM.Testing_Status_ID = TR.Status
		Where TR.Status in ('A','W')
		  and Tester = @RequestedBy
		Order by Token_Number
	End 	
	
	Else If(@Option = 'C') ----Get Completed Task for Tester Team Leader
	Begin 
			Select TR.Token_Number as Token, TR.Request_Type as [Request Type], TR.Project_Name as [Project], 
				(case when TR.Module = 'ALL' Then TR.Module when TR.Module <> 'ALL' Then (Select Module_NAme from module_MAster where TR.Module = Module_ID )End)As [Module] 
				, TR.Requirement_Type as [Req Type],Convert(varchar(12),TR.Request_Date) as  [Request_Date],
				Convert(varchar(12),TR.Desirable_End_Date) as  [Expected End Date],
				RSM.Emp_Name as [Requested By],Convert(varchar(12),TR.Testing_StartDate) as [Testing_StartDate],
				Convert(varchar(12),TR.Testing_EndDate) as [Testing_EndDate],RSM1.Emp_Name as [Tester],
				TSM.Testing_Status_Name as [Status]
			From tbl_Testing_Requests TR
				inner join Resource_Master RSM on RSM.Emp_ID = TR.Request_By
				inner join Testing_Status_Master TSM on TSM.Testing_Status_ID = TR.Status
				inner join Resource_Master RSM1 on RSM1.Emp_ID = TR.Tester
			Where TR.Status in ('W','A')
			Order by TR.Token_Number 		
	End

	Else If(@Option = 'CT') ----Get Completed Task for Tester
	Begin 
		Select Token_Number as Token, Request_Type as [Request Type], Project_Name as [Project], 
			(case when TR.Module = 'ALL' Then TR.Module when TR.Module <> 'ALL' Then (Select Module_NAme from module_MAster where TR.Module = Module_ID )End)As [module] ,
			 Requirement_Type as [Req Type],
			Cast(Assign_EndDate as Varchar(12)) + ' ' +RIGHT(cast(Assign_ETime as varchar(5)), 5) as [EndDate], 
			Cast(Assign_Date as Varchar(12)) + ' ' +RIGHT(cast(Assign_STime as varchar(5)), 5) as [StartDate], 
			CM.Emp_Name as Tester, CMT.Emp_Name as Assigned_By
		From tbl_Testing_Requests TR
			--inner join Module_Master MM on MM.Module_ID = TR.module
			inner join Client_Master CMT on CMT.Emp_ID = TR.Request_By
			inner join Client_Master CM on CM.Emp_ID = TR.Tester
		Where TR.Status = 'C' and Tester = @RequestedBy
		Order by Token_Number
	End 

	Else If(@Option = 'T') ----Get Token for Tester
	Begin 
		Select Token_Number From tbl_Testing_Requests
		Where Tester = @RequestedBy and [Status] in ('A','W')
		Order by Token_Number
	End 
	Else If(@Option = 'U') ----Assign Tester for New Test Request
	Begin 
		Update tbl_Testing_Requests 
			Set Tester = @Tester, Assign_Date = @AssignDate, Status = @Status,
			Assign_EndDate = @CloseDate, Assign_STime = @DeveloperRemark, Assign_ETime = @DeveloperAttach,Assigned_By = @RequestedBy
		Where Token_Number = @Token

		set @Testing_Detail_ID = DBO.GenerateID('12','')

		Insert into tbl_Testing_RequestsDetails
		Select @Testing_Detail_ID,*,getdate() from tbl_Testing_Requests where Token_Number = @Token
		
		Select @Token
	End 
	If(@Option = 'TO') ----Get Details of the Token Number
	Begin 
		Select Request_Type, Project_Name, Module, Requirement_Type, Brief_User_Requirement, Brief_Requirement_Attachement, Developer_Remark, Developer_Attachement,
  			Desirable_End_Date, Tester_Remark, Status, Functional_Defect_Major, Functional_Defect_Minor, Functional_Defect_Total, NonFunctional_Defect_Total, NonFunctional_Defect_Major,
			NonFunctional_Defect_Minor, Testing_StartDate, Testing_EndDate,Tester_Attachment,Request_By
		From tbl_Testing_Requests
		Where Token_Number = @Token

		Select Project_ID, Project_Name,Tester
		From tbl_Testing_Requests 
		Where Token_Number = @Token

		If((Select Module From tbl_Testing_Requests Where Token_Number = @Token) <> 'ALL')
			Begin
				Select MM.Module_ID, MM.Module_Name 
				From tbl_Testing_Requests TR, Module_Master MM
				Where TR.Token_Number = @Token and TR.Module=MM.Module_ID
			End
		Else If((Select Module From tbl_Testing_Requests Where Token_Number = @Token) = 'ALL')
			Begin
				Select 'ALL' As Module_ID, 'ALL'As Module_Name
			End
	End 

	Else If(@Option = 'UT') ----Updation By Tester
	Begin 
		-- @TestingType - Functional Major, @ProjectName = Functional Minor, @module = Total Functional, @RequirementType = NF Total, @UserRequirement = NF Major
		Update tbl_Testing_Requests 
		Set Tester_Remark = @Tester_Remark, Status = @Status, Functional_Defect_Major = Convert(int, @TestingType), Functional_Defect_Minor = Convert(int, @ProjectName),
			Functional_Defect_Total = Convert(int, @Module), NonFunctional_Defect_Total = Convert(int,@RequirementType), NonFunctional_Defect_Major = Convert(int,@UserRequirement), NonFunctional_Defect_Minor =Convert(int, @URAttachment),
			Testing_StartDate = @EndDate, Testing_EndDate = @CloseDate,Tester_Attachment = @TesterAttach
		Where Token_Number = @Token
			
		set @Testing_Detail_ID = DBO.GenerateID('12','')

		Insert into tbl_Testing_RequestsDetails
		Select @Testing_Detail_ID,*,getdate() from tbl_Testing_Requests where Token_Number = @Token

		Select @Token
	End

	Else If(@Option = 'AT') ----Get All Token for Testing Request For Tester TL
	Begin 
		Select Token_Number 
		From tbl_Testing_Requests
		where [Status] in ('A','W')
		Order By Token_Number  
	End 

	Else If(@Option = 'BT') ----Get Burn Down Task for Tester 
	Begin 
		Select Token_Number as Token, Project_Name,
			 (case when TR.Module = 'ALL' Then TR.Module when TR.Module <> 'ALL' Then (Select Module_NAme from module_MAster where TR.Module = Module_ID )End)As [Module] ,
			 CM.Emp_Name as Tester,
			Cast(Assign_Date as Varchar(12)) + ' ' +RIGHT(cast(Assign_STime as varchar(5)), 5) as Assign_Date, 
			Cast(Assign_EndDate as Varchar(12)) + ' ' +RIGHT(cast(Assign_ETime as varchar(5)), 5) as Desirable_End_Date,  
			CAST(((DATEDIFF(MINUTE,Assign_Date,GETDATE()))/(1440)) as varchar(3)) + ':' +  cast((((((DATEDIFF(MINUTE,Assign_Date,GETDATE()))/60) - ((DATEDIFF(MINUTE,Assign_Date,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,Assign_Date,GETDATE()))%60 as varchar(3)), 3) As [Elapsed],
			CAST(((DATEDIFF(MINUTE,Assign_EndDate,GETDATE()))/(1440)) as varchar(3)) + ':' +  cast((((((DATEDIFF(MINUTE,Assign_EndDate,GETDATE()))/60) - ((DATEDIFF(MINUTE,Assign_EndDate,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,Assign_EndDate,GETDATE()))%60 as varchar(3)), 3) As [Delayed],
			TSM.Testing_Status_Name as [Status]
		From dbo.tbl_Testing_Requests TR			
			inner join Client_Master CM on CM.Emp_ID = TR.Tester
			inner join Testing_Status_Master TSM on TSM.Testing_Status_ID = TR.Status
		Where   Assign_Date < GETDATE() and Tester = @RequestedBy
			and Assign_EndDate < getDate()
		Order By Token_Number
	End 

	Else If(@Option = 'B') ----Get Burn Down Testing Request for Tester TL 
	Begin 
		Select TR.Token_Number as Token, TR.Project_Name,
			(case when TR.Module = 'ALL' Then TR.Module when TR.Module <> 'ALL' Then (Select Module_NAme from module_MAster where TR.Module = Module_ID )End)As [Module] , RSM.Emp_Name as Tester,
			Cast(TR.Assign_Date as Varchar(12)) + ' ' +RIGHT(cast(TR.Assign_STime as varchar(5)), 5) as Assign_Date, 
			Cast(TR.Assign_EndDate as Varchar(12)) + ' ' +RIGHT(cast(TR.Assign_ETime as varchar(5)), 5) as Desirable_End_Date,  
			CAST(((DATEDIFF(MINUTE,TR.Assign_Date,GETDATE()))/(1440)) as varchar(3)) + ':' +  cast((((((DATEDIFF(MINUTE,TR.Assign_Date,GETDATE()))/60) - ((DATEDIFF(MINUTE,Assign_Date,GETDATE()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,Assign_Date,GETDATE()))%60 as varchar(3)), 2) As [Elapsed],
			CAST(((DATEDIFF(MINUTE,TR.Desirable_End_Date,GETDATE()))/(1440)) as varchar(3)) + ':' +  cast((((((DATEDIFF(MINUTE,TR.Desirable_End_Date,GETDATE()))/60) - ((DATEDIFF(MINUTE,Desirable_End_Date,GETDATE()))/(1440))*24))%60) as varchar(3)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,Desirable_End_Date,GETDATE()))%60 as varchar(3)), 2) As [Delayed],
			TSM.Testing_Status_Name as [Status]
		From tbl_Testing_Requests tr
			inner join Resource_Master RSM on RSM.Emp_ID = TR.Tester
			inner join Testing_Status_Master TSM on TSM.Testing_Status_ID = TR.Status		
		Where TR.Desirable_End_Date < GETDATE()
			and TR.Assign_Date < GETDATE()
		Order By TR.Token_Number
	End

	Else If(@Option = 'TK') ----Get All Token for PM
	Begin 
		Select Token_Number 
		From tbl_Testing_Requests
			inner join Client_Master on Client_Master.Emp_ID = tbl_Testing_Requests.Request_By
		Where (tbl_Testing_Requests.Request_By in (Select Emp_ID from Client_Master where HOD = @RequestedBy)
			or  tbl_Testing_Requests.Request_By = @RequestedBy)
		Order By Token_Number 	  
	End 

	Else If(@Option = 'TD') ----Get All Token for DVL and PL
	Begin 
		Select Token_Number 
		From tbl_Testing_Requests
		Where tbl_Testing_Requests.Request_By = @RequestedBy 
		Order By Token_Number	  
	End

	Else If(@Option = 'TTS') ----Get All Token for Tester
	Begin 
		Select Token_Number 
		From tbl_Testing_Requests
		Where tbl_Testing_Requests.Tester = @RequestedBy 
		Order By Token_Number	  
	End

	Else If(@Option = 'TTSTL') ----Get All Token for Tester TL
	Begin 
		Select Token_Number 
		From tbl_Testing_Requests
		Where tbl_Testing_Requests.Assigned_By = @RequestedBy 
		Order By Token_Number	  
	End

	Else If(@Option = 'PM') ----Get All Projects for PM
	Begin 
		Select Distinct(Project_Name)
		From tbl_Testing_Requests
			inner join Client_Master on Client_Master.Emp_ID = tbl_Testing_Requests.Request_By
		Where (tbl_Testing_Requests.Request_By in (Select Emp_ID from Client_Master where HOD = @RequestedBy)
		or  tbl_Testing_Requests.Request_By = @RequestedBy)
		Order by Project_Name
	End

	Else If(@Option = 'DV') ----Get All Projects for Devloper and PL
	Begin 
		Select Distinct(Project_Name)
		From tbl_Testing_Requests
		Where tbl_Testing_Requests.Request_By = @RequestedBy 
		Order by Project_Name
	End

	Else If(@Option = 'TS') ----Get All Projects for Tester
	Begin 
		Select Distinct(Project_Name)
		From tbl_Testing_Requests
		Where tbl_Testing_Requests.Tester = @RequestedBy 
		Order by Project_Name
	End
	Else If(@Option = 'TSTL') ----Get All Projects for Tester Team Leader
	Begin 
		Select Distinct(Project_Name)
		From tbl_Testing_Requests
		Where tbl_Testing_Requests.Assigned_By = @RequestedBy 
		Order by Project_Name
	End

	Else If(@Option = 'FT') ----Get All Tester/ Team Leader
	Begin 
		If((Select Role_ID from Resource_Master where Emp_ID = @RequestedBy)= 'TSTL')
		Begin
			Select Emp_Name,Emp_ID from Resource_Master 
			where Role_ID in ('TS','TSTL')
		End
		Else If((Select Role_ID from Resource_Master where Emp_ID = @RequestedBy)= 'TS')
		Begin
			Select Emp_Name,Emp_ID from Resource_Master where Emp_ID = @RequestedBy
		End
	End

	Else If(@Option = 'ST')
	Begin
		Select Testing_Status_ID,Testing_Status_Name from Testing_Status_Master
		where Testing_status_ID in ('W','C')
	End
	Else If(@Option = 'ALL')
	Begin
		Select Testing_Status_ID,Testing_Status_Name from Testing_Status_Master
	End
	Else If(@Option='1') -- Accept/NCFT/Reject Testing Request
	Begin
		Update tbl_Testing_Requests 
			Set Assign_Date = @AssignDate, Status = @Status,
			Assign_EndDate = @CloseDate, Assign_STime = @DeveloperRemark, Assign_ETime = @DeveloperAttach,
			Assigned_By = @RequestedBy
		Where Token_Number = @Token

		set @Testing_Detail_ID = DBO.GenerateID('12','')

		Insert into tbl_Testing_RequestsDetails
		Select @Testing_Detail_ID,*,getdate() from tbl_Testing_Requests where Token_Number = @Token
		
		Select @Token
	End
	Else IF(@Option='2')
	Begin
		Select SUM(NR) AS NR, SUM(PR) AS PR, SUM(RTBC) As RTBC, SUM(C) AS C, SUM(BP) AS BP, SUM(PR+RTBC+C+BP) AS Total
		From
		(
			Select TR.Token_Number,(Case When TR.Status in ('P','NCFT') Then Count(TR.Token_Number) Else '0' End ) As NR,
					'0' As PR,'0' As RTBC, '0' As C, '0' As BP
			From tbl_Testing_Requests TR
			Where Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) 
			Group By TR.Status, TR.Token_Number
			
			UNION

			Select TR.Token_Number,'0' As NR,
					(Case When TR.Status in ('ACP','W') Then Count(TR.Token_Number) Else '0' End ) As PR,'0' As RTBC,
					(Case When TR.Status='C' Then Count(TR.Token_Number) Else '0' End ) As C, '0' As BP
			From tbl_Testing_Requests TR
			Where Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) 
			Group By TR.Status, TR.Token_Number

			Union

			Select TR.Token_Number, '0' AS NR, '0' As PR,  
				(Case When TR.Status in ('ACP','W') Then Count(TR.Token_Number) Else '0' End ) As RTBC, '0' AS C, '0' As BP
			From tbl_Testing_Requests TR
			Where (Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )
				And CONVERT(Datetime,CONVERT(Varchar(11),Assign_EndDate,113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
			Group By TR.Status, TR.Token_Number

			Union

			Select TR.Token_Number,'0' AS NR, '0' As PR, '0' As RTBC, '0' AS C,
				(Case When TR.Status in ('ACP','W') Then Count(TR.Token_Number) Else '0' End ) As BP
			From tbl_Testing_Requests TR
			Where CONVERT(Datetime,CONVERT(Varchar(11),Assign_EndDate,113)) < @FDate 
			Group By TR.Status, TR.Token_Number
		) T
	End
	Else If(@Option='3')
	Begin
		If(rtrim(@Tester) = 'NR')
		Begin
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
						When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				'' As [Tester],
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR,  Testing_Status_Master TSM
			Where  TR.Status = TSM.Testing_Status_ID 
					And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )
			And TR.Status in ('P','NCFT')
		End 
		Else IF(@Tester = 'RTBC')
		Begin
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
						When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester],
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester=RSM.Emp_ID And TR.Status in ('ACP','W')
					And TR.Status = TSM.Testing_Status_ID 
					And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
						Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
						And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )
					And CONVERT(Datetime,CONVERT(Varchar(11),Desirable_End_Date,113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))

		End
		Else If(@Tester='C')
		Begin
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
						When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester],
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester=RSM.Emp_ID And TR.Status in ('C') 
				And TR.Status = TSM.Testing_Status_ID 					
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )
		End
		Else If(@Tester='PR')
		Begin
			Select Distinct TR.Token_Number, TR.Project_Name,
				(Case When TR.Module='ALL' Then 'ALL'
				When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester], 
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where   TR.Tester = RSM.EMP_ID and TR.Status ='W'  
				And TR.Status = TSM.Testing_Status_ID
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )
		Union

			Select Distinct TR.Token_Number, TR.Project_Name,
				(Case When TR.Module='ALL' Then 'ALL'
				When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				'' As [Tester],
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester is null and TR.Status = 'ACP' 
				And TR.Status = TSM.Testing_Status_ID 
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )
		End
		Else If(@Tester='BP')
		Begin
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
						When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester], 
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester=RSM.Emp_ID And TR.Status in ('ACP','W') 
				And TR.Status = TSM.Testing_Status_ID And
				CONVERT(Datetime,CONVERT(Varchar(11),Desirable_End_Date,113)) < @FDate 
		End
		Else If(@Tester='T')
		Begin

			--NR
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
						When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				'' As [Tester],
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Status = TSM.Testing_Status_ID
				And TR.Status in ('P','NCFT')

			Union 

			--RTBC
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
						When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester],
				Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester=RSM.Emp_ID And TR.Status in ('ACP','W')
					And TR.Status = TSM.Testing_Status_ID 
					And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
						Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
						And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )
					And CONVERT(Datetime,CONVERT(Varchar(11),Desirable_End_Date,113)) = CONVERT(Datetime, CONVERT(Varchar(11), getdate(), 113))
			Union

			--C
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
						When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester], Convert(varchar(11),TR.Testing_StartDate ,113)AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester=RSM.Emp_ID And TR.Status in ('C')
				And TR.Status = TSM.Testing_Status_ID 
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )

			Union

			--PR
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 			
				When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester], Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester=RSM.Emp_ID And TR.Status = 'W'
				And TR.Status = TSM.Testing_Status_ID 
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )

			Union

				Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
				When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				'' As [Tester],Convert(varchar(11),TR.Testing_StartDate ,113)AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM , Testing_Status_Master TSM
			Where TR.Tester is null And TR.Status = 'ACP' 
				And TR.Status = TSM.Testing_Status_ID
				And (	Convert(Datetime, Convert(Varchar(12),Convert(Datetime, TR.Request_Date),113))
					Between Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @FDate),113)) 
					And Convert(Datetime, Convert(Varchar(12),Convert(Datetime, @EDate),113)) )

			Union

			--BP
			Select Distinct TR.Token_Number, TR.Project_Name, 
				(Case When TR.Module='ALL' Then 'ALL' 
				When TR.Module<>'ALL' Then (Select MM.Module_Name From Module_Master MM Where TR.Module=MM.Module_ID) End) As [Module], 
				CONVERT(Varchar(11), TR.Request_Date, 113) As Request_Date, CONVERT(Varchar(11),TR.Desirable_End_Date, 113) As REnd_Date, 
				RSM.Emp_Name As [Tester], Convert(varchar(11),TR.Testing_StartDate,113) AS [TSDate], Convert(varchar(11),TR.Testing_EndDate,113) As [TEDate],
				TSM.Testing_Status_Name As [Status]
			From tbl_Testing_Requests  TR, Resource_Master RSM,Testing_Status_Master TSM
			Where TR.Tester=RSM.Emp_ID And TR.Status in ('ACP','W') 
				And TR.Status = TSM.Testing_Status_ID
				And CONVERT(Datetime,CONVERT(Varchar(11),Desirable_End_Date,113)) < @FDate
		End
	End
	Else If(@Option = '4')
	Begin
		Select TM.Task_ID,
			TM.Change_ID As Token,PM.Project_Name , MM.Module_Name ,TM.Task_Name, RPM.Priority_Name As Priority,
			Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
			Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate,Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
			CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
			CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
		From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM
		Where TM.Project_ID = PM.Project_ID
			And TM.Priority_ID=RPM.Priority_ID
			And TM.Module_ID = MM.Module_ID
			And TM.Status_ID = @Status
			And TM.Assigned_To = @Tester  and TM.Assigned_BY != @Tester
		
		Union

		Select TM.Task_ID,
				TM.Change_ID As [Token],
				PM.Project_Name ,MM.Module_Name ,TM.Task_Name, 
				RPM.Priority_Name As Priority, Convert(varchar(12), TM.AS_SDT,113) As Task_SDate,   
				Convert(Varchar(12), TM.AS_EDT,113) As Task_EDate ,
				Convert(Varchar,(TM.AS_Time/1440)) + ':' + Convert(Varchar,(TM.AS_Time%1440)/60)+ ':' + Convert(Varchar,(TM.AS_Time%1440)%60) As [Assigned Time],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
			CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed]
		From Task_Master TM, Project_Master PM, Module_Master MM, Request_Priority_master RPM 
		Where TM.Project_ID = PM.Project_ID
			And TM.Priority_ID=RPM.Priority_ID    
			And TM.Module_ID = MM.Module_ID And TM.Status_ID = @Status
			and TM.Assigned_To = @Tester and TM.Assigned_BY = @Tester
	End
	Else If(@Option = '5')
	Begin
		Select Distinct TM.Task_ID As [TaskID],
				TM.Change_ID As [Token],
				PM.Project_Name As [Project], MM.Module_Name As [Module], TM.Task_Name,
				TM.Priority_ID As [Priority], Convert(varchar(12),TM.AS_SDT,113) As [AS_SDT],Convert(varchar(12),TM.AS_EDT,113) As [AS_EDT],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
				Convert(Varchar,(TM.AS_Time/60)) + ':' + Convert(Varchar,(TM.AS_Time%60)) As [Assigned Time]
			From Task_Master TM, Project_Master PM, Module_Master MM, Project_Details PD, Client_Master CM
			Where TM.Project_ID=PM.Project_ID and TM.Module_ID=MM.Module_ID and TM.Request_ID=PM.Request_ID
				and TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID and TM.Assigned_To= @Tester and TM.Assigned_By! = @Tester
				and TM.Status_ID in ('P','W')

			Union

			Select Distinct TM.Task_ID As [TaskID],
				TM.Change_ID As Token,
				TM.Project_ID As [Project], MM.Module_Name As [Module], TM.Task_Name,
				TM.Priority_ID As [Priority], Convert(varchar(12),TM.AS_DT,113) As [AS_SDT],Convert(varchar(12),TM.AS_EDT,113) As [AS_EDT],
				CAST(((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_SDT,GETDATE()))%60 as varchar(2)), 2) As [Elapsed],
				CAST(((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440)) as varchar(2)) + ':' +  cast((((((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/60) - ((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))/(1440))*24))%60) as varchar(2)) + ':' + RIGHT('0' + cast((DATEDIFF(MINUTE,TM.AS_EDT,GETDATE()))%60 as varchar(2)), 2) As [Delayed],
				Convert(Varchar,(TM.AS_Time/60)) + ':' + Convert(Varchar,(TM.AS_Time%60)) As [Assigned Time]
			From Task_Master TM, Client_Master CM,Module_MAster MM
			Where TM.AS_EDT < GETDATE() and TM.Assigned_To=CM.Emp_ID 
				and TM.Assigned_To = @Tester
				and TM.Assigned_by = @Tester
				and TM.Module_ID=MM.Module_ID
				and TM.Status_ID in ('P','W')


	End
	Else if(@Option = '6')
	Begin
		if((Select Role_ID From Client_master Where Emp_ID = @Tester) in ( 'TSTL','TS'))
		Begin
			Select Task_ID,Task_ID
			From Task_Master 
			Where Assigned_To = @Tester				
				 and Status_ID in ('P','W')
				
			UNION
			
			Select Task_ID,Task_ID
			From Task_Master 
			Where Assigned_To = @Tester and Assigned_By = @Tester		
					and	Status_ID in ('P','W')
		End
	End
	Else if(@Option = '7')
	Begin
		Select Token_Number from tbl_Testing_Requests where Token_Number = @Token 
	End
	
	
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_Testing_Report
-- --------------------------------------------------





-- =============================================
-- Author:		Kapil Desai
-- Create date: 10-May-2010
-- Description:	Created for Testing Report
-- =============================================
CREATE PROCEDURE [dbo].[usp_Testing_Report]
(
 @Token char(10),
 @Project varchar(50),
 @RequestBy char(10),
 @FromDate varchar(50),
 @ToDate varchar(50),
 @Status char(2),
 @Role char(10),
 @Option char(2)
)As
Begin
 Declare @Query varchar(max)   

if(@Option = '1')
 Begin 
 Set @Query = 'Select Token_Number as Token, Request_Type as [Request Type], Project_Name as Project, 
			(case when tbl_Testing_Requests.Module = ''ALL'' Then tbl_Testing_Requests.Module when tbl_Testing_Requests.Module <> ''ALL''Then (Select Module_NAme from module_MAster where tbl_Testing_Requests.Module = Module_ID )End)As [Module] ,
	 Requirement_Type as [Requirement Type],
	 Convert(Varchar(12), Desirable_End_Date) as [Expected End Date], CM.Emp_Name as [Request By], TSM.Testing_Status_Name as Status
	 From tbl_Testing_Requests 
	 inner join Resource_Master CM on CM.Emp_ID = tbl_Testing_Requests.Request_By
	 inner join Testing_Status_Master TSM on TSM.Testing_Status_ID = tbl_Testing_Requests.Status 
	 Where 1=1 ' 

 If(@Token <> '')    
  Begin    
   Set @Query = @Query + 'And tbl_Testing_Requests.Token_Number = ''' + ltrim(rtrim(@Token)) + ''''    
  End    
    
  If(@Project <> '')    
  Begin    
   set @Query = @Query + 'And tbl_Testing_Requests.Project_Name = ''' + ltrim(rtrim(@Project)) + ''''    
  End  

  If(@FromDate <> '')    
  Begin    
   set @Query = @Query + 'And tbl_Testing_Requests.Request_Date between convert(datetime,ltrim(rtrim('''+ @FromDate + ''')),101) and DATEADD(dd,1,convert(datetime,ltrim(rtrim(''' + @ToDate + ''')),101))'     
  End   

  If(@Status <> '')    
  Begin    
   set @Query = @Query + 'And tbl_Testing_Requests.Status = ''' + ltrim(rtrim(@Status)) + ''''    
  End
  
 If(@Role <> '' And @RequestBy <> '')  
  Begin  
    If(@Role = 'PM')  
	 Begin   
	   Set @Query = @Query + 'And (tbl_Testing_Requests.Request_By in (Select Emp_ID From Client_Master Where HOD =  ''' + ltrim(rtrim(@RequestBy)) + ''') or tbl_Testing_Requests.Request_By = ''' + ltrim(rtrim(@RequestBy)) + ''')'     
	 End  
    Else if(@Role = 'DVL' OR @Role = 'PL')  
     Begin   
	   Set @Query = @Query + 'And tbl_Testing_Requests.Request_By = ''' + ltrim(rtrim(@RequestBy)) + ''''    
	 End    
  End
End

Else if(@Option = '2')
Begin
 Set @Query = 'Select Token_Number as Token, Request_Type as [Request Type], Project_Name as Project, (case when tbl_Testing_Requests.Module =''ALL'' Then tbl_Testing_Requests.Module when tbl_Testing_Requests.Module <> ''ALL'' Then (Select Module_NAme from module_MAster where tbl_Testing_Requests.Module = Module_ID )End)As [Module] ,
	 Requirement_Type as [Requirement Type],
	 CM.Emp_Name as [Tester],
	 Cast(Assign_Date as Varchar(12)) + RIGHT(cast(Assign_STime as varchar(4)), 4) as [Assigned Start Date], 
	 Cast(Assign_EndDate as Varchar(12)) + RIGHT(cast(Assign_ETime as varchar(4)), 4) as [Assigned End Date],
	 TSTL.Emp_Name as [Assigned By], TSM.Testing_Status_Name as Status
	 From tbl_Testing_Requests 
		 inner join Resource_Master CM on CM.Emp_ID = tbl_Testing_Requests.Tester
		 inner join Testing_Status_Master TSM on TSM.Testing_Status_ID = tbl_Testing_Requests.Status
		 inner join Resource_Master TSTL on TSTL.Emp_ID = tbl_Testing_Requests.Assigned_By
		 Where 1=1 '

 If(@Token <> '')    
  Begin    
   Set @Query = @Query + 'And tbl_Testing_Requests.Token_Number = ''' + ltrim(rtrim(@Token)) + ''''    
  End    
    
  If(@Project <> '')    
  Begin    
   set @Query = @Query + 'And tbl_Testing_Requests.Project_Name = ''' + ltrim(rtrim(@Project)) + ''''    
  End  

  If(@FromDate <> '')    
  Begin    
   set @Query = @Query + 'And tbl_Testing_Requests.Assign_Date between convert(datetime,ltrim(rtrim('''+ @FromDate + ''')),101) and DATEADD(dd,1,convert(datetime,ltrim(rtrim(''' + @ToDate + ''')),101))'     
  End   

  If(@Status <> '')    
  Begin    
   set @Query = @Query + 'And tbl_Testing_Requests.Status = ''' + ltrim(rtrim(@Status)) + ''''    
  End
  
 If(@Role <> '' And @RequestBy <> '')  
  Begin  
    If(@Role = 'TSTL')  
	 Begin   
	   Set @Query = @Query + 'And (tbl_Testing_Requests.Assigned_By = ''' + ltrim(rtrim(@RequestBy)) + ''' or tbl_Testing_Requests.Tester = ''' + ltrim(rtrim(@RequestBy)) + ''')'    
	 End  
    Else if(@Role = 'TS')  
     Begin   
	   Set @Query = @Query + 'And tbl_Testing_Requests.Tester = ''' + ltrim(rtrim(@RequestBy)) + ''''    
	 End    
  End
 
End
 Set @Query = @Query + 'Order By Project, Module, Token_Number, Desirable_End_Date'    	 
    
  Print @Query    
  Exec (@Query)  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_timesheet_report
-- --------------------------------------------------



CREATE proc [dbo].[usp_timesheet_report]-----usp_timesheet_report '00000057' ,'','','','','','','1'
@TaskID varchar(20),    
@PM varchar(20),    
@RM varchar(20),  
@FromDate datetime,    
@ToDate datetime,    
@EmpID varchar(20),  
@RoleID varchar(20),  
@Option varchar(20)    
 As
 Begin

Declare @Query varchar(Max)
Declare @Query2 varchar(Max)
Declare @FDate As Datetime
Declare  @EDate As Datetime
declare  @Countdays as varchar(12)


--set  @FDate=(select  AS_SDT from task_master WHERE tASK_iD=@TaskID)
--set  @EDate=(select  AS_EDT from task_master WHERE tASK_iD=@TaskID)
--set  @Countdays =(Select count(Date) from GetDays(@FDate,@EDate) where DATENAME(weekday,Date)<> 'sunday')

     
 if(@Option = '1')    
 Begin 
set @Query='Select RM.Emp_Name as [Resource Name] ,TM.Task_id, TM.Assigned_By as [Project Manager] ,'
set @Query= @Query + '(Select count(Date) from GetDays(TM.AS_SDT,TM.AS_EDT) where DATENAME(weekday,Date)<> ''sunday'')  AS [Total Working Days],
 (Convert(Varchar,(TM.AC_Time/1440)) + '':'' + Convert(Varchar,(TM.AC_Time%1440)/60)+ '':'' + Convert(Varchar,(TM.AC_Time%1440)%60)) As [Total Utilization] ,
convert(varchar(12), TM.Last_update,113) as [last Updation DateTime], Count(TD.TD_ID) as [Total Updation Days]
FROM Task_Master TM 
inner join Resource_Master RM on TM.assigned_to=RM.Emp_Id
inner join Task_details TD on TM.Task_ID=TD.Task_ID' 
set @Query= @Query + ' Group by RM.Emp_Name,TM.Task_id,TM.Assigned_To,TM.Assigned_By,TM.AS_SDT,TM.AS_EDT,TM.AC_Time,TM.Last_update'
 -- inner join task_details  on Task_Master.Task_ID=Task_Details.Task_ID
--([Total Working Days]-[Total Updation Days]) as [Not Updated],


If(@PM<>'--Select--' and @PM <> '' and @PM is not null)
		Begin
			if(@PM <> 'ALL')
			Begin
				set @Query = @Query + 'And TM.Assigned_By = ''' + @PM + ''''
			End	
		End
Else If(@RM<>'--Select--' and @RM <> '' and @RM is not null)
		Begin
			if(@RM <> 'ALL')
			Begin
				set @Query = @Query + 'And TM.Assigned_To = ''' + @PM + ''''
			End	
		End
 Else If(@ToDate <> '' and @FromDate <> '')
	  Begin		
			set @Query = @Query + 'And (Convert(varchar(12),TM.AS_SDT,101) = Convert(varchar(12),'''+ Convert(varchar(12),@ToDate,101) +''',101)) '
--			 set @Query = @Query + 'And Convert(varchar(12),TM.AS_SDT,101) = Convert(varchar(12),'''+ @FromDate + ''',101)'''
	    -- set @Query = @Query + 'And Convert(varchar(12),TM.AS_SDT,101) between convert(varchar,ltrim(rtrim('''+ @FromDate + ''')),101) and DATEADD(dd,1,convert(varchar,ltrim(rtrim(''' + @ToDate + ''')),101))'
	  End

 Print @Query    
 Exec (@Query) 

-- Select Count(TD_ID) as [Total Updation Days] from Task_Details where Task_Id = @TaskID 
End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_TimeSheet_Updation_Report
-- --------------------------------------------------





CREATE PROC [dbo].[USP_TimeSheet_Updation_Report]

@PM As Varchar(20),
@PMName As Varchar(200),
@Resource As Varchar(20),
@Name As Varchar(150),
@Type As char(10),
@SDate As Datetime,
@EDate As Datetime,
@Emp_ID As Varchar(20),
@Role As Varchar(20),
@option As Int

As
Begin

	If(@PMName <>'')
	Begin
		Set @PM = (Select Emp_ID From Resource_Master Where Upper(Emp_Name)=UPPER(@PMName))
	End

	Declare @FromDate As Varchar(12)
	Declare @EndDate As Varchar(12)

	if(@SDate=Cast('01/01/1900 00:00:00' As Datetime) And @EDate=Cast('01/01/1900 00:00:00' As Datetime))
	Begin
		Set @FromDate = CONVERT(Datetime,CONVERT(Varchar(12),DATEADD(dd,-(DAY(getdate())-1),getdate()),110))
		Set @EndDate = CONVERT(Datetime,CONVERT(Varchar(12),DATEADD(dd,-(DAY(DATEADD(mm,1,getdate()))),DATEADD(mm,1,getdate())),110))
	End
	Else
	Begin
		Set @FromDate = CONVERT(Datetime,Convert(Varchar(12),@SDate,110))
		Set @EndDate = CONVERT(Datetime,Convert(Varchar(12),@EDate,110))
	End
	
	
	Declare @Query1 Varchar(MAX)
	Declare @Query2 Varchar(MAX)
	Declare @Query3 Varchar(MAX)
	Declare @Query4 Varchar(MAX)

	Set @Query1 = ''
	Set @Query2 = ''
	Set @Query3 = ''
	Set @Query4 = ''
		

	If(@Option=1)
	Begin
		
		Set @Query1 = '
		Select Resource, AT, TWD, TUD, (TWD-TUD) AS [NUD], Convert(Varchar(12),max(Last_Update),113) As LUD
		From
		(
			Select Resource, AT, SUM(TWD) AS TWD, Sum(TUD) As TUD
			From
			(
				Select Resource, AT, TWD ,''0'' As TUD
				From 
				(	
					Select Distinct RM.Emp_Name as [Resource] ,TM.Assigned_To As AT,
							(Select count(Date) from GetDays(''' + @FromDate + ''',''' + @EndDate + ''') where DATENAME(weekday,Date)<> ''sunday'')  AS [TWD]
					FROM Task_Details TM 
						inner join Resource_Master RM on TM.assigned_to=RM.Emp_Id
					Where RM.Active_Status=1 '

		
		Set @Query2 = 'Group by RM.Emp_Name,TM.Assigned_To,TM.AS_SDT,TM.AS_EDT,TM.AC_Time,TM.Last_update
				) T

				Union 

				Select Resource, AT, ''0'' As TWD  ,SUM(TUD)
				From 
				(
					Select Distinct RM.Emp_Name as [Resource],TM.Assigned_To As AT,
							convert(varchar(12), TM.Last_update,110) As LDate,
							Count(convert(varchar(12), TM.Last_update,110)) as [TUD]
					FROM Task_Details TM 
						inner join Resource_Master RM on TM.assigned_to=RM.Emp_Id
					Where CONVERT(Datetime,convert(varchar(12), TM.Last_update,110)) Between ''' + @FromDate + ''' And ''' + @EndDate + ''''
		
		Set @Query3 = '
					Group by RM.Emp_Name,TM.Assigned_To,TM.Last_update

				) T
				group by Resource, AT,TUD
			) T
			Group By Resource, AT

		) T , Task_master TSM
		Where T.AT=TSM.Assigned_To And CONVERT(Datetime,convert(varchar(12), TSM.Last_update,110)) Between ''' + @FromDate + ''' And ''' + @EndDate + '''
			And TSM.Assigned_To in (Select Emp_ID From Resource_Master Where active_status=1)
		Group by Resource, AT, TWD, TUD
		Order By resource'


		If(@PM='ALL')
		Begin
			IF(@Resource<>'ALL')
			Begin
				Set @Query1 = @Query1 + ' And RM.Emp_ID=''' + @Resource + ''' '
				Set @Query2 = @Query2 + ' And RM.Emp_ID=''' + @Resource + ''' '
			End
		End
		Else If(@PM<>'ALL')
		Begin
			If(@Resource='ALL')
			Begin
				If((Select Role_ID from Resource_Master where Emp_ID = @PM) in ('PM'))
				Begin
					Set @Query1 = @Query1 + ' And RM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Manager=''' + @PM + ''' Union Select ''' + @PM + ''') '

					Set @Query2 = @Query2 + ' And RM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Manager=''' + @PM + ''' Union Select ''' + @PM + ''') '
				End
				Else If((Select Role_ID from Resource_Master where Emp_ID = @PM) in ('PL'))
				Begin
					Set @Query1 = @Query1 + ' And RM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Leader=''' + @PM + ''' Union Select ''' + @PM + ''') '

					Set @Query2 = @Query2 + ' And RM.Emp_ID in (Select Emp_ID From Resource_Master Where Project_Leader=''' + @PM + ''' Union Select ''' + @PM + ''') '
				End
			End
			IF(@Resource<>'ALL')
			Begin
				Set @Query1 = @Query1 + ' And RM.Emp_ID=''' + @Resource + ''' '
				Set @Query2 = @Query2 + ' And RM.Emp_ID=''' + @Resource + ''' '
			End
			
		End


		Set @Query4 = @Query1 + ' ' + @Query2 + ' ' + @Query3

		Print (@Query4)

		EXEC (@Query4)

	End
	Else If(@Option=2)
	Begin
		Set @Resource = (Select Emp_ID From Resource_Master Where UPPER(Emp_Name)=UPPER(@Name))

		Select Convert(Varchar(12),Last_Update,113) AS Date, TM.Task_ID As TaskID, PM.Project_Name As Project, MM.Module_Name As Module, 
			TM.Task_Detail As [DESC], 
			Convert(Varchar(12),TM.AS_SDT,113) AS AS_SDate, Convert(Varchar(12),TM.AS_EDT,113) As AS_EDate, 
			Task_Status_Name As Status
		FROM Task_Details TM 
				inner join Resource_Master RM on TM.assigned_to=RM.Emp_Id
				inner join Project_Master PM on TM.Project_ID=PM.Project_ID
				inner join Module_Master MM on TM.Module_ID=MM.Module_ID
				inner join Task_Status_Master TSM on TM.Status_ID=TSM.Task_Status_ID
		Where Convert(Datetime,convert(varchar(12), Last_Update,110)) >= @FromDate And CONVERT(Datetime,convert(varchar(12), Last_Update,110)) <= @EndDate
			And CONVERT(Datetime,Convert(Varchar(12),Last_Update,113))<>CONVERT(Datetime,'01 Jan 1900') And RM.Emp_ID=@Resource
		Order BY Last_Update ASC, Status DESC  
	End
	Else If(@Option=3)
	Begin

		Select Resource, AT, (TWD1+TWD2) As [TWD], SUM((TWD1 * 8) + (TWD2 * 5)) As TWH,
			UT, [NUT],
			ISNULL(TUD,0) As TUD, ISNULL(NTUD,0) As NTUD
		From
		(
			Select RSM.Emp_Name As Resource, RSM.Emp_ID AS AT, 
--				(Select count(Date) from GetDays(@FromDate,@EndDate) where DATENAME(weekday,Date) not in ('sunday','saturday'))  AS [TWD1],
--				(Select count(Date) from GetDays(@FromDate,@EndDate) where DATENAME(weekday,Date)='saturday')  AS [TWD2],
				(Select dbo.getWorkingDays(@FromDate,@EndDate)) AS [TWD1],
				(Select dbo.GetSaturdayDays(@FromDate,@EndDate))  AS [TWD2],
				ISNULL(U,0)  As UT, ISNULL((rtrim(Cast((NU/60) As Char)) + ':' + Cast(NU%60 As Char)),0) As [NUT],
				ISNULL(TUD,0) As TUD, ISNULL(NTUD,0) As NTUD
			From
			(
				Select Resource, AT, TWD, TWH, (rtrim(Cast(Hrs As Char))+ ':' + Cast(Mins As Char)) As U, 
						((TWH * 60 ) - ((Hrs * 60)+(Mins))) As NU, TUD, (TWD-TUD) As NTUD
				From
				(
					Select Resource, AT, SUM(TWD) As TWD, SUM(TWH) As TWH, 
							SUM(Hrs) As Hrs, SUM(Mins) As Mins, SUM(TUD) As TUD
					From
					(
						Select Resource, AT, (TWD1 + TWD2) As TWD, SUM((TWD1 * 8) + (TWD2 * 5)) As TWH, SUM(HRS) As Hrs, Sum(mins) As Mins, SUM(TUD) As TUD
						From  
						(	
							Select Resource, AT, TWD1 ,  TWD2, 
								SUM(HRS) As Hrs, Sum(mins) As Mins, SUM(TUD) As TUD
							From 
							(	
								Select Distinct RM.Emp_Name as [Resource] ,TM.Assigned_To As AT,
										--(Select count(Date) from GetDays(@FromDate,@EndDate) where DATENAME(weekday,Date) not in ('sunday','saturday'))  AS [TWD1],
										--(Select count(Date) from GetDays(@FromDate,@EndDate) where DATENAME(weekday,Date)='saturday')  AS [TWD2],
										(Select dbo.getWorkingDays(@FromDate,@EndDate) ) AS [TWD1],
										(Select dbo.GetSaturdayDays(@FromDate,@EndDate))  AS [TWD2],
										AS_Time , (AS_Time/60) As [Hrs], (AS_Time%60) As [Mins],
										Count(convert(varchar(12), TM.Last_update,110)) as [TUD]
								FROM Task_Details TM 
									inner join Resource_Master RM on TM.assigned_to=RM.Emp_Id
								Where RM.Active_Status=1 And RM.Emp_ID=TM.Assigned_To
									And RM.Project_Manager=@PM And Active_Status=1
									And CONVERT(Datetime,CONVERT(varchar(12), AS_SDT,110)) >= @FromDate And CONVERT(Datetime,CONVERT(varchar(12), AS_EDT,110)) <= @EndDate
								Group by RM.Emp_Name,TM.Assigned_To,TM.AS_SDT,TM.AS_EDT,TM.AC_Time,TM.Last_update,AS_Time
							) T
							Group by resource,AT, TWD1, TWD2
						) T 
						Group by Resource, AT,TWD1, TWD2
					) T
					Group By Resource, AT				
				) T
				Group By Resource, AT, TWD, TWH, Hrs, Mins, TUD
			) T Right Outer join Resource_Master RSM On T.AT=RSM.Emp_ID
			Where RSM.Project_Manager=@PM And Active_Status=1
			Group By RSM.Emp_Name, RSM.Emp_ID, U, NU, TUD, NTUD
		) T
		Group by Resource, AT, TWD1, TWD2, UT, NUT, TUD, NTUD
		Order BY UT DESC
	End
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.usp_TReport
-- --------------------------------------------------





-- =============================================
-- Author:		<Rihab Rebello>
-- Create date: <27/9/2010>
-- Description:	<TimeSheet Report>
-- =============================================

CREATE PROCEDURE [dbo].[usp_TReport]----usp_TReport '','','','','','','','','','1'

@TaskID as varchar(20),
@PM as varchar(20),
@PL as varchar(20), 
@Resource as varchar(20),
@FromDate as datetime,
@ToDate as datetime,
@StatusID char(20),  
@EmpID varchar(20),  
@RoleID varchar(20),
@Project varchar(10),
@Option as int
    
as    
Begin    
	Declare @Query varchar(max)
	Declare @Query2 varchar(max)

	if(@Option = '1')
	Begin   
		--CAST(((DATEDIFF(MINUTE,AS_EDT,getdate()))/(1440)) as varchar(3)) + '':'' +  cast((((((DATEDIFF(MINUTE,AS_EDT,getdate()))/60) - ((DATEDIFF(MINUTE,AS_EDT,getdate()))/(1440))*24))%60) as varchar(3)) + '':'' + RIGHT(''0'' + cast((DATEDIFF(MINUTE,AS_EDT,getdate()))%60 as varchar(3)), 3) As [Elapsed],
		set @Query = ' Select Distinct ROW_NUMBER() OVER (ORDER BY Convert(varchar(12),TM.AS_SDT,113)) As [SrNo], TM.Task_ID,
	 						PM.Project_Name as [Project Name], MM.Module_Name [Module Name], RM.Emp_Name as [Resource],
							RM1.Emp_NAme as [Assigned_By], RPM.Priority_Name as [Priority],
							Convert(varchar(12),TM.AS_SDT,113) as [Assigned Start Date],
							Convert(varchar(12),TM.AS_EDT,113) as [Assigned End Date],
							(cast((AS_Time/60) as varchar(3))+ '':'' + cast((AS_Time%60) as varchar(3)))  as [Assigned Time],
							Convert(varchar(12),TM.AC_SDT,113) as [AC_ST],Convert(varchar(12),TM.AC_EDT,113) as [AC_ET],
							Cast((AC_Time/60) as varchar(3))+ '':'' + cast((AC_Time%60) as varchar(3)) as [Actual Time],
							Convert(varchar(12),TM.Last_Update,113) as [Last Update],
							Cast((AC_Time/60) as varchar(3)) as [Elapsed],
							[Productive]=(Case when ((Convert(varchar(12),TM.AS_EDT,113) >= Convert(varchar(12),TM.AC_EDT,113)) and [AS_Time] >= [AC_Time] ) then ''Y''
							Else ''N'' End  ),
							TM.Remark as [Remark],
							TSM.Task_Status_Name as Status
						From  Task_Master TM
							inner join Project_Master PM on TM.Request_ID = PM.Request_ID
							inner join Module_Master MM on TM.Module_ID = MM.Module_ID
							inner join Request_Priority_Master RPM on TM.Priority_ID = RPM.Priority_ID
							inner join Task_Status_Master TSM on TM.Status_ID = TSM.Task_Status_ID
							inner join Resource_Master RM on (RM.Emp_ID = TM.Assigned_To and RM.Active_Status =1)
							inner join Resource_MAster RM1 on (RM1.Emp_Id = TM.Assigned_By and RM.Active_Status =1)
						Where 1=1 '
		
				If(@PM<>'--Select--' and @PM <> '' and @PM is not null)
				Begin		
					if(@PM <>'ALL')
					Begin
						if(@RoleID <> 'PL' or @RoleID <> 'DBAPL')
						Begin
							set @Query = @Query + 'And TM.Assigned_By = ''' + ltrim(rtrim(@PM)) + ''''	
						End
					End
				End
		    
				If(@StatusID <> '')
				Begin
					set @Query = @Query + 'And TM.Status_ID = ''' + ltrim(rtrim(@StatusID)) + ''''
				End
				
				If(@Project <> '--Select--')
				Begin
					set @Query = @Query + 'And TM.Project_ID = ''' + ltrim(rtrim(@Project)) + ''''
				End
		    
				If(@FromDate <> '' and @Todate <> '')
				Begin	
					set @Query = @Query + 'And (TM.AS_SDT between Convert(varchar(12),'''+ left(Convert(datetime,@FromDate,113),11) +''',113) and Convert(varchar(12),'''+ left((Convert(datetime,@Todate,113) + 1),11) +''',113)) '	
				End	 
		    
				If(@RoleID <> '')
				Begin  
						If(@RoleID in ('PM','DBAPM'))
						Begin
							If(@Resource <> 'ALL')
							Begin
								Set @Query = @Query + 'And (TM.Assigned_To  = ''' + ltrim(rtrim(@Resource)) + ''' ) '
							End
							If(@Resource = 'ALL')
							Begin
								Set @Query = @Query + ' and (TM.Assigned_To  in ( Select Emp_ID from Resource_Master where Project_Manager = ''' + ltrim(rtrim(@EmpID)) + ''' ) or TM.Assigned_To  = ''' + ltrim(rtrim(@EmpID)) + ''' )' 
							End
						End
		  
						Else If(@RoleID in ('PL','DBAPL'))
						Begin   
							If(@Resource <> 'ALL')
							Begin
								Set @Query = @Query + ' And (TM.Assigned_To = ''' + ltrim(rtrim(@Resource)) + ''')'
								-- and (TM.Assigned_By  = ''' + ltrim(rtrim(@EmpID)) + '''  or TM.Assigned_By = (Select Project_MAnager from Resource_Master where Emp_ID = ''' + ltrim(rtrim(@EmpID)) + ''')))' 
							End
							Else If(@Resource = 'ALL')
							Begin
								Set @Query = @Query + ' and (TM.Assigned_To =''' + ltrim(rtrim(@EmpID)) + '''  or TM.Assigned_To in (Select Emp_ID from Resource_Master where Project_Leader = ''' + ltrim(rtrim(@EmpID)) + '''))' 
							End
				
						End 

						Else If(@RoleID = 'DVL')
							Begin
								Set @Query = @Query + 'And TM.Assigned_To  = ''' + ltrim(rtrim(@EmpID)) + '''' 
							End 

						Else If(@RoleID = 'AA' or @RoleID = 'SYA')
						Begin  
							If(@Resource<>'ALL')
							Begin
								Set @Query = @Query + 'And (TM.Assigned_To  = ''' + ltrim(rtrim(@Resource)) + ''')'
							End
						End
				End
			
			Set @Query=@Query + ' Order by Convert(varchar(12),TM.AS_SDT,113) ' 
	  
			Print @Query    
			Exec (@Query)    	    
	 End    
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_Update_Client_Master
-- --------------------------------------------------
  
  
  
CREATE Proc [dbo].[USP_Update_Client_Master]  
  
AS  
Begin  
  
 Delete Client_Master_OLD  
   
 Insert Into Client_Master_OLD  
 (Emp_ID,EMP_NAME,HOD,HOD_Name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,Department,Sub_Department,Designation,  
 Location_Address,LEVEL,categorydesc,Costcode,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,STATUS,  
 Address,City,State,Account_No,pincode,Functional_Head,flgCSOBranch,tpdlgcode,LOBDESC,Category_ID,Role_ID,Password)  
 Select Emp_ID,EMP_NAME,HOD,HOD_Name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,Department,Sub_Department,Designation,  
 Location_Address,LEVEL,categorydesc,Costcode,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,STATUS,  
 Address,City,State,Account_No,pincode,Functional_Head,flgCSOBranch,tpdlgcode,LOBDESC,Category_ID,Role_ID,Password  
 From Client_Master  
 Order by Role_ID DESC  
  
 Select Count(Emp_ID) As Before_Updation From Client_Master  
  
 Select Distinct E.[Emp No] Into #New_Emp_IDS  
 From VLMSINhouse E   
 --From [196.1.115.158].[MISSC].DBO.[Emp_Master] E   
 Where [Emp No] Not In (Select distinct [Emp_ID] From Client_Master)  
  
  
 Select [Emp No],[EMP_NAME],[HOD No],[HOD Name],[Company Name],[SBU],[Lob],[Zone],[Region],[Location],[AttendanceLoc],  
 [Department],[Sub Department],[Designation],[Location Address],[LEVEL],[categorydesc],[Costcode],[Join Date],  
 [Separation Date],[emailadd],[sex],[BirthDate],[PHONE],[JOINDATE],[STATUS],[Address],[City],[State],[Account No],  
 [pincode],[Functional Head],[flgCSOBranch],[tpdlgcode],[LOBDESC],'' As [Category_ID], '' As [Role_ID],'' As Password  
 Into #New_Emp_Data  
 From VLMSINhouse  
 --From [196.1.115.158].[MISSC].DBO.[Emp_Master]   
 Where [Emp NO] in (Select [Emp NO] From #New_Emp_IDS)  
  
-- Select * Into Client_Master_Backup  
-- From Client_Master  
  
 Insert Into Client_Master  
 (Emp_ID,EMP_NAME,HOD,HOD_Name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,Department,Sub_Department,Designation,  
 Location_Address,LEVEL,categorydesc,Costcode,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,STATUS,  
 Address,City,State,Account_No,pincode,Functional_Head,flgCSOBranch,tpdlgcode,LOBDESC,Category_ID,Role_ID,Password)  
 Select [Emp No],[EMP_NAME],[HOD No],[HOD Name],[Company Name],[SBU],[Lob],[Zone],[Region],[Location],[AttendanceLoc],  
 [Department],[Sub Department],[Designation],[Location Address],[LEVEL],[categorydesc],[Costcode],[Join Date],  
 [Separation Date],[emailadd],[sex],[BirthDate],[PHONE],[JOINDATE],[STATUS],[Address],[City],[State],[Account No],  
 [pincode],[Functional Head],[flgCSOBranch],[tpdlgcode],[LOBDESC],'' As [Category_ID], '' As [Role_ID], '' As Password  
 From #New_Emp_Data  
 Order By Role_ID   
  
  
 --Select Count(Emp_ID) From Client_Master_Backup_Dummy  
  
-- Delete Client_Master  
--  
-- Insert Into Client_Master  
-- (Emp_ID,EMP_NAME,HOD,HOD_Name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,Department,Sub_Department,Designation,  
-- Location_Address,LEVEL,categorydesc,Costcode,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,STATUS,  
-- Address,City,State,Account_No,pincode,Functional_Head,flgCSOBranch,tpdlgcode,LOBDESC,Category_ID,Role_ID,Password)  
-- Select Emp_ID,EMP_NAME,HOD,HOD_Name,Company,SBU,Lob,Zone,Region,Location,AttendanceLoc,Department,Sub_Department,Designation,  
-- Location_Address,LEVEL,categorydesc,Costcode,Join_Date,Separation_Date,emailadd,sex,BirthDate,PHONE,JOINDATE,STATUS,  
-- Address,City,State,Account_No,pincode,Functional_Head,flgCSOBranch,tpdlgcode,LOBDESC,Category_ID,Role_ID,Password  
-- From Client_Master_Backup  
-- Order by Role_ID DESC  
  
 Select Count(Emp_ID) As After_Updation From Client_Master  
  
 Drop table #New_Emp_Data  
 Drop table #New_Emp_IDS  
 --Drop table Client_Master_Backup  
  
  
 Select Distinct [Emp No], Status   
 Into #EmpIDs  
 From [MIDDLEWARE].[Harmony].DBO.VLMSInhouse   
 Order By [Emp No]  
  
 Declare @Count As Int  
 Declare @Total As Int  
  
 Set @Total = (Select Count([Emp No]) From #EmpIDs)  
 Set @Count=0  
  
 While(@Count < @Total)  
 Begin  
  Update Client_Master  
  Set Status = (Select Status From #EmpIDs Where [Emp No]=(Select top 1 [Emp No] From #EmpIDs))  
  Where [Emp_ID]=(Select top 1 [Emp No] From #EmpIDs)  
  
  Delete #EmpIDs  
  Where [Emp No] = (Select top 1 [Emp No] From #EmpIDs)  
  
  Set @Count = @Count + 1   
  Print @Count   
 End  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_Client_Master_New
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[USP_UPDATE_Client_Master_New]  
  
--Created By : Mahendra Bonde   
--Created On : 25 OCT 2010   
--Modified By :  
--Modified On :  
--Description : Insert New Employee of Angel And update Active - status of Employees.  
  
AS  
  
Begin  
  
 Select [Emp No] AS Emp_ID Into #Emp_IDS  
 From [MIS].TMS.DBO.VLMSINhouse with (nolock)  
 Where [Emp No] not in (Select Emp_ID From Client_Master with (nolock))  
  
 Insert Into Client_Master  
 Select *, '' AS Category_ID, '' AS Role_ID, '' AS Password    
 From [MIS].TMS.DBO.VLMSINhouse with (nolock)  
 Where [Emp No] not in (Select Emp_ID From Client_Master with (nolock))  
  
 ------------------------------------- Update Status --------------------------------------  
  
 Select [Emp No] AS Emp_ID, [Status]  
 Into #Status  
 From [MIS].TMS.DBO.VLMSINhouse with (nolock)  
 Where [Emp No] in (Select Emp_ID From #Emp_IDS with (nolock))   
   
 Select Emp_ID Into #Emp From Client_Master with (nolock)  
  
 Declare @Count As Int   
 Declare @Total AS Int   
 Declare @Status AS Char(10)  
 Declare @Emp AS Char(20)  
  
 Set @Count = 0  
 Set @Total = (Select Count(Emp_ID) From #Emp)  
  
 While (@Count < @Total)  
 Begin  
    
  Set @Emp = (Select top 1 Emp_ID From #Emp)  
  
  Set @Status = (Select Status From #Status Where Emp_ID=@Emp)  
    
  Update Client_Master  
  Set Status=@Status  
  Where Emp_ID=@Emp  
  
    
  Set @Count = @Count + 1  
  Print @Count  
    
  Delete #Emp Where Emp_ID = @Emp  
  
 End  
  
 Drop Table #Emp  
 Drop Table #Status  
 Drop Table #Emp_IDS  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UPDATE_Rescource_Master
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[USP_UPDATE_Rescource_Master]  
  
--Created By : Mahendra Bonde   
--Created On : 27 OCT 2010   
--Modified By :  
--Modified On :  
--Description : Insert New Employee added in Software team And update Active - status of Employees.  
As  
  
Begin  
  
  
 -- update Active Status of Employee  
   
 Declare @Count AS INt  
 Declare @Total AS INt  
  
 Select Emp_ID Into #Emp From Resource_Master  
  
 Set @Count = 0  
 Set @Total = (Select Count(Emp_ID) From Resource_Master)  
  
 While (@Count < @Total)  
 Begin  
  Declare @EMP_ID AS Varchar(20)  
  
  Set @Emp_ID = (Select top 1 Emp_ID From #Emp)  
    
  Declare @Status AS char(10)  
  
  Set @Status = (Select Status From [MIS].TMS.DBO.VLMSINHOUSE Where [Emp No]=@Emp_ID)  
  
  If(@Status='A')  
  Begin  
   Update Resource_master  
   Set Active_Status='True'  
   Where Emp_ID=@Emp_ID  
  End  
  Else   
  Begin  
   Update Resource_master  
   Set Active_Status='False'  
   Where Emp_ID=@Emp_ID  
  End  
  
  Delete #Emp  
  Where Emp_ID = @Emp_ID  
  
  Print @Count  
  Set @Count = @Count + 1  
 End  
  
 Drop Table #Emp  
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_UpdateTask
-- --------------------------------------------------




CREATE PROC [dbo].[USP_UpdateTask]

	--Upddate Task_Page

@Project As Varchar(20),
@Date As Datetime,
@Status As Varchar(20),
@Resource As Varchar(20),
@Emp_ID As Varchar(20),
@Role As Varchar(20),
@Option As Int 

As

Begin

	Declare @Query As Varchar(8000)

	Set @Query = 'Select TM.Task_ID As [TaskID], PM.Project_Name As [Project], 
					MM.Module_Name As [Module], TM.Task_Name As [TaskName],
					Convert(Varchar(11),TM.AS_SDT,113) As AS_SDate, Convert(Varchar(5), TM.AS_SDT,114) AS AS_STime, 
					Convert(Varchar(11),TM.AS_EDT,113) As AS_EDate, Convert(Varchar(5), TM.AS_EDT,114) AS AS_ETime,
					cast((TM.AS_Time/(1440)) as varchar(2)) + '':'' +  cast(((((TM.AS_Time/60) - (TM.AS_Time/(1440))*24))%60) as varchar(2)) + '':'' + RIGHT(''0'' + cast(TM.AS_Time%60 as varchar(2)), 2) as [AS_TTime],
					TM.priority_id As [Priority], TM.task_Detail As [Desc], RSM1.Emp_Name As [AssignedBY], RSM2.Emp_Name As [Resource], 
					Convert(Varchar(11),TM.AC_SDT,113) As AC_SDate, Convert(Varchar(5), TM.AC_SDT,114) AS AC_STime,
					Convert(Varchar(11),TM.AC_EDT,113) As AC_EDate, Convert(Varchar(5), TM.AC_EDT,114) AS AC_ETime,
					cast((TM.AC_Time/(1440)) as varchar(2)) + '':'' +  cast(((((TM.AC_Time/60) - (TM.AC_Time/(1440))*24))%60) as varchar(2)) + '':'' + RIGHT(''0'' + cast(TM.AC_Time%60 as varchar(2)), 2) as [AC_TTime], 
					TM.Remark As Remark, TM.Status_ID As Status
				From Task_Master TM, Module_Master MM, Resource_Master RSM1, Resource_Master RSM2, Project_Master PM
				Where TM.Project_ID=PM.Project_ID And TM.Module_ID=MM.Module_ID And TM.Assigned_BY=RSM1.Emp_ID And TM.Assigned_To=RSM2.Emp_ID 
				And TM.Status_ID in (''P'',''W'',''TIP'',''PFU'',''UIP'',''R'')'

	If(@Project<>'')
	Begin
		Set @Query = @Query + ' And TM.Project_ID=''' + @Project + ''''
	End

	If(@Date<>'' And @Date<>'1/1/1900 12:00:00 AM')
	Begin
		Set @Query= @Query + ' And Convert(Varchar(11),TM.AS_SDT,113)=''' + Convert(Varchar(11),@Date,113) + ''''
	End

	If(@Status<>'')
	Begin
		Set @Query = @Query + 'And TM.Status_ID=''' + @Status + '''' 
	End
	
	If(@Resource<>'')
	Begin
		Set @Query = @Query + ' And TM.Assigned_To=''' + @Resource + ''''
	End
	
	If(@Role='DVL')
	Begin
		Set @Query = @Query + ' And TM.Assigned_To=''' + @EMP_ID + ''''
	End

	If(@Role='PM')
	Begin
		Set @Query = @Query + ' And TM.Project_ID in (Select Project_ID From Project_Master Where Project_Manager=''' + @Emp_ID + ''') 
					And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Manager=''' + @Emp_ID + ''' Union Select ''' + @Emp_ID + ''')'
	End

	If(@Role='PL')
	Begin
		Set @Query = @Query + ' And TM.Project_ID in (Select Project_ID From Project_Master Where Project_Leader=''' + @Emp_ID + ''')
								And TM.Assigned_To in (Select Emp_ID From Resource_Master Where Project_Leader=''' + @Emp_ID + ''' Union Select ''' + @Emp_ID + ''')'
	End

	Print @Query
	Exec (@Query)


End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_User_Operation
-- --------------------------------------------------


CREATE Proc [dbo].[USP_User_Operation]

@User_ID Char(20),
@Option Char(5)

As
If(@Option='ADD')
Begin
insert into user_master
Select [Emp No],Emp_Name,'STU',
department,designation,[HOD No],
'','',attendanceLoc,emailadd,
'',phone,'',[location Address],costcode
from [196.1.115.158].MISSC.dbo.Emp_Master
Where [Emp No]=@User_ID
End

GO

-- --------------------------------------------------
-- TABLE dbo.Change_Request_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Change_Request_Details]
(
    [CRD_ID] CHAR(10) NOT NULL,
    [Change_ID] CHAR(10) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] CHAR(10) NULL,
    [Changed_BY] CHAR(10) NOT NULL,
    [Changed_Date] DATETIME NOT NULL,
    [Change_Type] VARCHAR(50) NOT NULL,
    [Reason] VARCHAR(100) NULL,
    [Other_Reason] VARCHAR(100) NULL,
    [Priority_ID] CHAR(10) NOT NULL,
    [Expected_EDate] DATETIME NULL,
    [Description] VARCHAR(1000) NULL,
    [Attachment] VARCHAR(400) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(200) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(200) NULL,
    [PM_SDate] DATETIME NULL,
    [PM_EDate] DATETIME NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Change_Request_Details_OLD
-- --------------------------------------------------
CREATE TABLE [dbo].[Change_Request_Details_OLD]
(
    [CRD_ID] CHAR(10) NOT NULL,
    [Change_ID] CHAR(10) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] CHAR(10) NULL,
    [Changed_BY] CHAR(10) NOT NULL,
    [Changed_Date] DATETIME NOT NULL,
    [Change_Type] VARCHAR(50) NOT NULL,
    [Reason] VARCHAR(100) NULL,
    [Other_Reason] VARCHAR(100) NULL,
    [Priority_ID] CHAR(10) NOT NULL,
    [Expected_EDate] DATETIME NULL,
    [Description] VARCHAR(500) NULL,
    [Attachment] VARCHAR(100) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(50) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(50) NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Change_Request_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Change_Request_Master]
(
    [Change_ID] CHAR(10) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] CHAR(10) NULL,
    [Changed_BY] CHAR(20) NOT NULL,
    [Changed_Date] DATETIME NOT NULL,
    [Change_Type] VARCHAR(50) NOT NULL,
    [Reason] VARCHAR(100) NULL,
    [Other_Reason] VARCHAR(100) NULL,
    [Priority_ID] CHAR(20) NOT NULL,
    [Expected_EDate] DATETIME NULL,
    [Description] VARCHAR(1000) NULL,
    [Attachment] VARCHAR(400) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(200) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(50) NULL,
    [PM_SDate] DATETIME NULL,
    [PM_EDate] DATETIME NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Change_Request_Master_Old
-- --------------------------------------------------
CREATE TABLE [dbo].[Change_Request_Master_Old]
(
    [Change_ID] CHAR(10) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] CHAR(10) NULL,
    [Changed_BY] CHAR(20) NOT NULL,
    [Changed_Date] DATETIME NOT NULL,
    [Change_Type] VARCHAR(50) NOT NULL,
    [Reason] VARCHAR(100) NULL,
    [Other_Reason] VARCHAR(100) NULL,
    [Priority_ID] CHAR(20) NOT NULL,
    [Expected_EDate] DATETIME NULL,
    [Description] VARCHAR(500) NULL,
    [Attachment] VARCHAR(100) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(50) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(50) NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Change_Request_Testing
-- --------------------------------------------------
CREATE TABLE [dbo].[Change_Request_Testing]
(
    [Change_ID] CHAR(10) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] CHAR(10) NULL,
    [Changed_BY] CHAR(20) NOT NULL,
    [Changed_Date] DATETIME NOT NULL,
    [Change_Type] VARCHAR(50) NOT NULL,
    [Reason] VARCHAR(100) NULL,
    [Other_Reason] VARCHAR(100) NULL,
    [Priority_ID] CHAR(20) NOT NULL,
    [Expected_EDate] DATETIME NULL,
    [Description] VARCHAR(500) NULL,
    [Attachment] VARCHAR(400) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(50) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(50) NULL,
    [PM_SDate] DATETIME NULL,
    [PM_EDate] DATETIME NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Master]
(
    [Emp_ID] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [HOD] VARCHAR(6) NULL,
    [HOD_Name] VARCHAR(150) NULL,
    [Company] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [Lob] INT NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub_Department] VARCHAR(150) NULL,
    [Designation] VARCHAR(255) NULL,
    [Location_Address] VARCHAR(5000) NULL,
    [LEVEL] VARCHAR(50) NULL,
    [categorydesc] VARCHAR(50) NULL,
    [Costcode] NVARCHAR(255) NULL,
    [Join_Date] DATETIME NULL,
    [Separation_Date] DATETIME NULL,
    [emailadd] VARCHAR(100) NULL,
    [sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [PHONE] VARCHAR(50) NULL,
    [JOINDATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [Address] NVARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State] NVARCHAR(25) NULL,
    [Account_No] VARCHAR(20) NULL,
    [pincode] VARCHAR(20) NULL,
    [Functional_Head] VARCHAR(500) NULL,
    [flgCSOBranch] NCHAR(6) NULL,
    [tpdlgcode] NVARCHAR(50) NULL,
    [LOBDESC] VARCHAR(100) NULL,
    [Category_ID] CHAR(10) NULL,
    [Role_ID] CHAR(10) NULL,
    [Password] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Master_Backup_20Nov2010
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Master_Backup_20Nov2010]
(
    [Emp_ID] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [HOD] VARCHAR(6) NULL,
    [HOD_Name] VARCHAR(150) NULL,
    [Company] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [Lob] INT NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub_Department] VARCHAR(150) NULL,
    [Designation] VARCHAR(255) NULL,
    [Location_Address] VARCHAR(5000) NULL,
    [LEVEL] VARCHAR(50) NULL,
    [categorydesc] VARCHAR(50) NULL,
    [Costcode] NVARCHAR(255) NULL,
    [Join_Date] DATETIME NULL,
    [Separation_Date] DATETIME NULL,
    [emailadd] VARCHAR(100) NULL,
    [sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [PHONE] VARCHAR(50) NULL,
    [JOINDATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [Address] NVARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State] NVARCHAR(25) NULL,
    [Account_No] VARCHAR(20) NULL,
    [pincode] VARCHAR(20) NULL,
    [Functional_Head] VARCHAR(500) NULL,
    [flgCSOBranch] NCHAR(6) NULL,
    [tpdlgcode] NVARCHAR(50) NULL,
    [LOBDESC] VARCHAR(100) NULL,
    [Category_ID] CHAR(10) NULL,
    [Role_ID] CHAR(10) NULL,
    [Password] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Client_Master_OLD
-- --------------------------------------------------
CREATE TABLE [dbo].[Client_Master_OLD]
(
    [Emp_ID] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [HOD] VARCHAR(6) NULL,
    [HOD_Name] VARCHAR(150) NULL,
    [Company] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [Lob] INT NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub_Department] VARCHAR(150) NULL,
    [Designation] VARCHAR(255) NULL,
    [Location_Address] VARCHAR(5000) NULL,
    [LEVEL] VARCHAR(50) NULL,
    [categorydesc] VARCHAR(50) NULL,
    [Costcode] NVARCHAR(255) NULL,
    [Join_Date] DATETIME NULL,
    [Separation_Date] DATETIME NULL,
    [emailadd] VARCHAR(100) NULL,
    [sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [PHONE] VARCHAR(50) NULL,
    [JOINDATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [Address] NVARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State] NVARCHAR(25) NULL,
    [Account_No] VARCHAR(20) NULL,
    [pincode] VARCHAR(20) NULL,
    [Functional_Head] VARCHAR(500) NULL,
    [flgCSOBranch] NCHAR(6) NULL,
    [tpdlgcode] NVARCHAR(50) NULL,
    [LOBDESC] VARCHAR(100) NULL,
    [Category_ID] CHAR(10) NULL,
    [Role_ID] CHAR(10) NULL,
    [Password] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Coordinator_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Coordinator_Master]
(
    [Employee_ID] CHAR(20) NOT NULL,
    [Request_ID] CHAR(10) NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Role_ID] CHAR(20) NOT NULL,
    [Activation_Status] BIT NOT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.Delegation_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Delegation_Master]
(
    [DelegateID] INT IDENTITY(1,1) NOT NULL,
    [RequestID] CHAR(10) NULL,
    [ProjectID] CHAR(10) NULL,
    [DelegateBy] CHAR(10) NULL,
    [DelegateTo] CHAR(10) NULL,
    [DelegateDate] DATETIME NULL,
    [Remark] VARCHAR(150) NULL,
    [ReqFlag] BIT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.Issue_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Issue_Details]
(
    [Issue_Detail_ID] INT IDENTITY(2000,1) NOT NULL,
    [Issue_ID] VARCHAR(20) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Module_Name] VARCHAR(150) NOT NULL,
    [Issue] VARCHAR(150) NOT NULL,
    [Description] VARCHAR(500) NULL,
    [Reported_By] VARCHAR(20) NOT NULL,
    [Escalated_To] VARCHAR(20) NOT NULL,
    [Solution] VARCHAR(500) NULL,
    [Recommended_Solution] VARCHAR(500) NULL,
    [Issue_Status_ID] VARCHAR(20) NOT NULL,
    [Issue_Type] VARCHAR(20) NULL,
    [Issue_Category] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Issue_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Issue_Master]
(
    [Issue_ID] VARCHAR(20) NOT NULL,
    [Project_ID] CHAR(20) NOT NULL,
    [Module_ID] INT NOT NULL,
    [Issue] VARCHAR(150) NOT NULL,
    [Description] VARCHAR(500) NULL,
    [Reported_By] VARCHAR(20) NOT NULL,
    [Escalated_To] VARCHAR(20) NOT NULL,
    [Solution] VARCHAR(500) NULL,
    [Recommended_Solution] VARCHAR(500) NULL,
    [Issue_Status_ID] VARCHAR(20) NOT NULL,
    [Issue_Type] VARCHAR(20) NULL,
    [Issue_Category] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Issue_Status_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Issue_Status_Master]
(
    [IssueStatus_ID] VARCHAR(20) NOT NULL,
    [IssueStatusName] VARCHAR(50) NOT NULL,
    [StatusDescription] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Login_Category_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Login_Category_Master]
(
    [Category_Id] CHAR(20) NOT NULL,
    [Category_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Login_Check
-- --------------------------------------------------
CREATE TABLE [dbo].[Login_Check]
(
    [ID] VARCHAR(50) NOT NULL,
    [Emp_ID] VARCHAR(50) NULL,
    [Login_Date] DATETIME NULL,
    [Emp_ID_Success] VARCHAR(50) NULL,
    [Login_Success_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Login_Check_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Login_Check_New]
(
    [ID] VARCHAR(50) NULL,
    [Emp_ID] VARCHAR(50) NULL,
    [Login_Date] DATETIME NULL,
    [Emp_ID_Success] VARCHAR(50) NULL,
    [Login_Success_Date] DATETIME NULL,
    [Harmony] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Module_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Module_Master]
(
    [Module_ID] CHAR(10) NOT NULL,
    [Module_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Module_Master_OLD
-- --------------------------------------------------
CREATE TABLE [dbo].[Module_Master_OLD]
(
    [Module_Code] INT IDENTITY(1,1) NOT NULL,
    [Module_Name] VARCHAR(150) NOT NULL,
    [Project_Code] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Phase_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Phase_Master]
(
    [Phase_ID] CHAR(10) NULL,
    [Phase_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PRMS_UserMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[PRMS_UserMaster]
(
    [Emp_id] CHAR(20) NOT NULL,
    [Category_Id] CHAR(20) NOT NULL,
    [Role_Id] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Details]
(
    [Project_ID] CHAR(10) NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Master]
(
    [Project_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project_Leader] CHAR(10) NULL,
    [Priority] VARCHAR(20) NULL,
    [AS_SDate] DATETIME NULL,
    [AS_EDate] DATETIME NULL,
    [Remark] VARCHAR(200) NULL,
    [Status] CHAR(5) NULL,
    [Reschedule] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Master_8_OCT_2010
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Master_8_OCT_2010]
(
    [Project_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project_Leader] CHAR(10) NULL,
    [Priority] VARCHAR(20) NULL,
    [AS_SDate] DATETIME NULL,
    [AS_EDate] DATETIME NULL,
    [Remark] VARCHAR(200) NULL,
    [Status] CHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Master_Backup
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Master_Backup]
(
    [Project_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project_Leader] CHAR(10) NULL,
    [Priority] VARCHAR(20) NULL,
    [AS_SDate] DATETIME NULL,
    [AS_EDate] DATETIME NULL,
    [Remark] VARCHAR(50) NULL,
    [Status] CHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Master_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Master_Details]
(
    [PID] CHAR(10) NOT NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project_Leader] CHAR(10) NULL,
    [Priority] VARCHAR(20) NULL,
    [AS_SDate] DATETIME NULL,
    [AS_EDate] DATETIME NULL,
    [Remark] VARCHAR(50) NULL,
    [Status] CHAR(5) NULL,
    [Reschedule] BIT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Master_OLD
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Master_OLD]
(
    [Project_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project Leader] CHAR(10) NULL,
    [Priority] VARCHAR(20) NULL,
    [AS_SDate] DATETIME NULL,
    [AS_EDate] DATETIME NULL,
    [Remark] VARCHAR(50) NULL,
    [Status] CHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Master_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Master_Temp]
(
    [Project Name] NVARCHAR(255) NULL,
    [Project Owner] NVARCHAR(255) NULL,
    [Project Coordinator] NVARCHAR(255) NULL,
    [Project Manager] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Project_Status_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Project_Status_Master]
(
    [Request_ID] CHAR(20) NULL,
    [Project_ID] CHAR(20) NULL,
    [RA_Status] BIT NULL,
    [RA_Status_On] DATETIME NULL,
    [RA_Status_By] CHAR(20) NULL,
    [AD_Status] BIT NULL,
    [AD_Status_On] DATETIME NULL,
    [AD_Status_By] CHAR(20) NULL,
    [Testing_Status] BIT NULL,
    [Testing_Status_On] DATETIME NULL,
    [Testing_Status_By] CHAR(20) NULL,
    [UAT_Status] BIT NULL,
    [UAT_Status_On] DATETIME NULL,
    [UAT_Status_By] CHAR(20) NULL,
    [Close_Status] BIT NULL,
    [Close_Status_On] DATETIME NULL,
    [Close_Status_By] CHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Request_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Request_Details]
(
    [RD_ID] CHAR(20) NOT NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(100) NOT NULL,
    [Requested_BY] CHAR(20) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Expected_EDate] DATETIME NOT NULL,
    [Priority_ID] CHAR(20) NOT NULL,
    [Brief_Requirement] VARCHAR(1000) NULL,
    [BRS_Attachment] VARCHAR(200) NULL,
    [Business_Needs] VARCHAR(1000) NULL,
    [BN_Attachment] VARCHAR(200) NULL,
    [Current_Process] VARCHAR(1000) NULL,
    [CP_Attachment] VARCHAR(200) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(200) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(100) NULL,
    [Audience] VARCHAR(100) NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Request_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Request_Master]
(
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Requested_BY] CHAR(20) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Expected_EDate] DATETIME NOT NULL,
    [Priority_ID] CHAR(20) NOT NULL,
    [Brief_Requirement] VARCHAR(1000) NULL,
    [BR_Attachment] VARCHAR(200) NULL,
    [Business_Needs] VARCHAR(1000) NULL,
    [BN_Attachment] VARCHAR(200) NULL,
    [Current_Process] VARCHAR(1000) NULL,
    [CP_Attachment] VARCHAR(200) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(100) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(100) NULL,
    [Audience] VARCHAR(100) NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Request_Master_8_OCT_2010
-- --------------------------------------------------
CREATE TABLE [dbo].[Request_Master_8_OCT_2010]
(
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Requested_BY] CHAR(20) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Expected_EDate] DATETIME NOT NULL,
    [Priority_ID] CHAR(20) NOT NULL,
    [Brief_Requirement] VARCHAR(1000) NULL,
    [BR_Attachment] VARCHAR(200) NULL,
    [Business_Needs] VARCHAR(1000) NULL,
    [BN_Attachment] VARCHAR(200) NULL,
    [Current_Process] VARCHAR(1000) NULL,
    [CP_Attachment] VARCHAR(200) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(100) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(100) NULL,
    [Audience] VARCHAR(100) NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Request_Master_OLD
-- --------------------------------------------------
CREATE TABLE [dbo].[Request_Master_OLD]
(
    [Request_ID] CHAR(10) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Requested_BY] CHAR(20) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Expected_EDate] DATETIME NOT NULL,
    [Priority_ID] CHAR(20) NOT NULL,
    [Brief_Requirement] VARCHAR(500) NULL,
    [BR_Attachment] VARCHAR(200) NULL,
    [Business_Needs] VARCHAR(500) NULL,
    [BN_Attachment] VARCHAR(200) NULL,
    [Current_Process] VARCHAR(500) NULL,
    [CP_Attachment] VARCHAR(200) NULL,
    [HOD_Approve] CHAR(20) NULL,
    [HOD_Approve_Date] DATETIME NULL,
    [HOD_Remark] VARCHAR(100) NULL,
    [Admin_Approve] CHAR(20) NULL,
    [Admin_Approve_Date] DATETIME NULL,
    [Admin_Remark] VARCHAR(100) NULL,
    [Audience] VARCHAR(100) NULL,
    [Request_Status_ID] CHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Request_Priority_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Request_Priority_Master]
(
    [Priority_ID] CHAR(20) NOT NULL,
    [Priority_Name] VARCHAR(100) NULL,
    [Description] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Request_Status_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Request_Status_Master]
(
    [Request_Status_ID] CHAR(20) NOT NULL,
    [Request_Status_Name] VARCHAR(100) NOT NULL,
    [Status_Description] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Res_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Res_Master]
(
    [Emp_ID] CHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(100) NOT NULL,
    [HOD] CHAR(20) NOT NULL,
    [Role_ID] CHAR(20) NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project_Leader] CHAR(10) NULL,
    [Project_Leader2] NCHAR(10) NULL,
    [Active_Status] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Resource_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Resource_Master]
(
    [Emp_ID] CHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(100) NOT NULL,
    [HOD] CHAR(20) NOT NULL,
    [Role_ID] CHAR(20) NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project_Leader] CHAR(10) NULL,
    [Project_Leader2] NCHAR(10) NULL,
    [Active_Status] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Resource_Master_Backup
-- --------------------------------------------------
CREATE TABLE [dbo].[Resource_Master_Backup]
(
    [Emp_ID] CHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(100) NOT NULL,
    [HOD] CHAR(20) NOT NULL,
    [Role_ID] CHAR(20) NULL,
    [Project_Manager] CHAR(10) NULL,
    [Project_Leader] CHAR(10) NULL,
    [Project_Leader2] NCHAR(10) NULL,
    [Active_Status] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ResourceMail
-- --------------------------------------------------
CREATE TABLE [dbo].[ResourceMail]
(
    [Emp_ID] CHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(100) NOT NULL,
    [EmailAdd] VARCHAR(30) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ResourceMail_Manager
-- --------------------------------------------------
CREATE TABLE [dbo].[ResourceMail_Manager]
(
    [Emp_ID] CHAR(20) NOT NULL,
    [Emp_Name] VARCHAR(100) NOT NULL,
    [EmailAdd] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Role_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Role_Master]
(
    [Role_ID] CHAR(20) NOT NULL,
    [Category_Id] CHAR(20) NOT NULL,
    [Role_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RoleMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[RoleMaster]
(
    [Role_ID] CHAR(5) NOT NULL,
    [Category_ID] CHAR(5) NULL,
    [Role_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Shift_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Shift_Master]
(
    [Shift_ID] CHAR(20) NOT NULL,
    [Shift_StartTime] CHAR(10) NOT NULL,
    [Shift_EndTime] CHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Solution_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Solution_Details]
(
    [Solution_ID] VARCHAR(20) NOT NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Module_Name] VARCHAR(150) NULL,
    [Problem] VARCHAR(150) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Solution_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Solution_Master]
(
    [Solution_ID] VARCHAR(20) NOT NULL,
    [Solution] VARCHAR(150) NOT NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Module_ID] INT NOT NULL,
    [Problem] VARCHAR(150) NOT NULL,
    [Solution_Description] VARCHAR(150) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Task_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Task_Details]
(
    [TD_ID] CHAR(10) NULL,
    [Task_ID] CHAR(10) NOT NULL,
    [Task_Name] VARCHAR(100) NULL,
    [Request_ID] CHAR(10) NOT NULL,
    [Change_ID] CHAR(10) NULL,
    [Project_ID] CHAR(10) NOT NULL,
    [Phase_ID] CHAR(10) NOT NULL,
    [Module_ID] VARCHAR(150) NOT NULL,
    [Priority_Id] NCHAR(10) NULL,
    [Task_Detail] VARCHAR(500) NULL,
    [T_Attachment] VARCHAR(250) NULL,
    [AS_DT] DATETIME NULL,
    [AS_SDT] DATETIME NULL,
    [AS_EDT] DATETIME NULL,
    [AS_Time] INT NULL,
    [Assigned_By] CHAR(10) NULL,
    [Assigned_To] CHAR(10) NULL,
    [AC_SDT] DATETIME NULL,
    [AC_EDT] DATETIME NULL,
    [AC_Time] INT NULL,
    [Last_Update] DATETIME NULL,
    [PM_Remark] VARCHAR(500) NULL,
    [Remark] VARCHAR(500) NULL,
    [Status_ID] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Task_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Task_Master]
(
    [Task_ID] CHAR(10) NOT NULL,
    [Task_Name] VARCHAR(100) NULL,
    [Request_ID] CHAR(10) NULL,
    [Change_ID] CHAR(10) NULL,
    [Project_ID] CHAR(10) NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] VARCHAR(150) NULL,
    [Priority_Id] NCHAR(10) NULL,
    [Task_Detail] VARCHAR(500) NULL,
    [T_Attachment] VARCHAR(250) NULL,
    [AS_DT] DATETIME NULL,
    [AS_SDT] DATETIME NULL,
    [AS_EDT] DATETIME NULL,
    [AS_Time] INT NULL,
    [Assigned_By] CHAR(10) NULL,
    [Assigned_To] CHAR(10) NULL,
    [AC_SDT] DATETIME NULL,
    [AC_EDT] DATETIME NULL,
    [AC_Time] INT NULL,
    [Last_Update] DATETIME NULL,
    [PM_Remark] VARCHAR(500) NULL,
    [Remark] VARCHAR(500) NULL,
    [Status_ID] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Task_Status_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Task_Status_Master]
(
    [Task_Status_ID] CHAR(20) NOT NULL,
    [Task_Status_Name] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Category_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Category_Master]
(
    [Category_Id] CHAR(10) NOT NULL,
    [Category_Name] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_CheckList
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_CheckList]
(
    [Check_ID] INT IDENTITY(1,1) NOT NULL,
    [Request_ID] CHAR(20) NULL,
    [Project_ID] CHAR(20) NULL,
    [Q1] CHAR(10) NULL,
    [Q2] CHAR(10) NULL,
    [Q3] CHAR(10) NULL,
    [Q4] CHAR(10) NULL,
    [Q5] CHAR(10) NULL,
    [Q6] CHAR(10) NULL,
    [Q7] CHAR(10) NULL,
    [Q8] CHAR(10) NULL,
    [Q9] CHAR(10) NULL,
    [Q10] CHAR(10) NULL,
    [Q11] CHAR(10) NULL,
    [Q12] CHAR(10) NULL,
    [Q13] CHAR(10) NULL,
    [Q14] CHAR(10) NULL,
    [Q15] CHAR(10) NULL,
    [Change_Date] DATETIME NULL,
    [Change_By] CHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Checklist_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Checklist_Details]
(
    [CID] INT IDENTITY(1,1) NOT NULL,
    [Check_ID] INT NOT NULL,
    [Request_ID] CHAR(20) NULL,
    [Project_ID] CHAR(20) NULL,
    [Q1] CHAR(10) NULL,
    [Q2] CHAR(10) NULL,
    [Q3] CHAR(10) NULL,
    [Q4] CHAR(10) NULL,
    [Q5] CHAR(10) NULL,
    [Q6] CHAR(10) NULL,
    [Q7] CHAR(10) NULL,
    [Q8] CHAR(10) NULL,
    [Q9] CHAR(10) NULL,
    [Q10] CHAR(10) NULL,
    [Q11] CHAR(10) NULL,
    [Q12] CHAR(10) NULL,
    [Q13] CHAR(10) NULL,
    [Q14] CHAR(10) NULL,
    [Q15] CHAR(10) NULL,
    [Change_Date] DATETIME NULL,
    [Change_By] CHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_ChekList_Upload_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_ChekList_Upload_Master]
(
    [Project_ID] CHAR(20) NULL,
    [Phase_Name] VARCHAR(300) NULL,
    [QID] INT NULL,
    [File] VARCHAR(250) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_component_list
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_component_list]
(
    [cmtID] INT NULL,
    [Control] VARCHAR(200) NULL,
    [ApplicationName] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Component_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Component_Master]
(
    [CMT_ID] INT IDENTITY(1,1) NOT NULL,
    [Object_Id] INT NOT NULL,
    [Object_Type] VARCHAR(50) NULL,
    [Object_Name] VARCHAR(50) NULL,
    [Object_List] VARCHAR(50) NULL,
    [Object_Platform] VARCHAR(50) NULL,
    [Object_Description] VARCHAR(1000) NULL,
    [How_To_Use] VARCHAR(1000) NULL,
    [Remark] VARCHAR(1000) NULL,
    [Object_Addr] VARCHAR(150) NULL,
    [Reference_link] VARCHAR(100) NULL,
    [Uploaded_By] VARCHAR(50) NULL,
    [Uploaded_On] DATETIME NULL,
    [Status] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Component_Master_old
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Component_Master_old]
(
    [Object_Id] INT NOT NULL,
    [Object_Type] VARCHAR(50) NULL,
    [Object_Name] VARCHAR(50) NULL,
    [Object_List] VARCHAR(50) NULL,
    [Object_Platform] VARCHAR(50) NULL,
    [Object_Description] VARCHAR(150) NULL,
    [How_To_Use] VARCHAR(150) NULL,
    [Remark] VARCHAR(150) NULL,
    [Object_Addr] VARCHAR(150) NULL,
    [Reference_link] VARCHAR(100) NULL,
    [Uploaded_By] VARCHAR(50) NULL,
    [Uploaded_On] DATETIME NULL,
    [Status] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_CoordinatorMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_CoordinatorMaster]
(
    [Project_Id] CHAR(20) NOT NULL,
    [Request_Id] CHAR(20) NOT NULL,
    [Project_Owner] CHAR(20) NOT NULL,
    [Project_Coordinator1] CHAR(20) NULL,
    [Project_Coordinator2] CHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_DBA_Request
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_DBA_Request]
(
    [DBA_ID] CHAR(20) NOT NULL,
    [Project_ID] CHAR(20) NULL,
    [Phase_ID] CHAR(10) NULL,
    [Module_ID] CHAR(20) NULL,
    [Req_Desc] VARCHAR(2000) NULL,
    [Expected_EDate] DATETIME NULL,
    [File] VARCHAR(400) NULL,
    [Requested_By] VARCHAR(10) NULL,
    [Requested_On] DATETIME NULL,
    [Accepted_By] VARCHAR(10) NULL,
    [Actual_Start_Date] DATETIME NULL,
    [Actual_End_Date] DATETIME NULL,
    [Resolved_By] CHAR(20) NULL,
    [Resolved_On] DATETIME NULL,
    [Status] CHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_DBA_Request_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_DBA_Request_Details]
(
    [Details_ID] INT IDENTITY(1,1) NOT NULL,
    [DBA_ID] CHAR(20) NULL,
    [Project_ID] CHAR(20) NULL,
    [Phase_ID] CHAR(20) NULL,
    [Module_ID] CHAR(20) NULL,
    [Req_Desc] VARCHAR(2000) NULL,
    [Expected_EDate] DATETIME NULL,
    [File] VARCHAR(400) NULL,
    [Requested_By] CHAR(20) NULL,
    [Requested_On] DATETIME NULL,
    [Accepted_By] VARCHAR(10) NULL,
    [Actual_Start_Date] DATETIME NULL,
    [Actual_End_Date] DATETIME NULL,
    [Resolved_By] CHAR(20) NULL,
    [Resolved_On] DATETIME NULL,
    [Status] CHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Feedback
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Feedback]
(
    [FB_ID] CHAR(10) NULL,
    [Request_ID] CHAR(10) NULL,
    [Project_ID] CHAR(10) NULL,
    [Project_Manager] CHAR(10) NULL,
    [Completion_Date] DATETIME NULL,
    [TDP] INT NULL,
    [EN] INT NULL,
    [AOS] INT NULL,
    [AI] INT NULL,
    [AEU] INT NULL,
    [COC] INT NULL,
    [LNF] INT NULL,
    [YSFA] INT NULL,
    [Comments] VARCHAR(MAX) NULL,
    [FB_BY] CHAR(10) NULL,
    [FB_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_image
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_image]
(
    [ImgID] INT IDENTITY(1,1) NOT NULL,
    [imgname] VARCHAR(25) NULL,
    [imgfile] IMAGE NULL,
    [imgtype] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_MailLog
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_MailLog]
(
    [logID] INT IDENTITY(1,1) NOT NULL,
    [Request_ID] CHAR(10) NULL,
    [change_ID] CHAR(10) NULL,
    [Project_name] VARCHAR(200) NULL,
    [Subject] VARCHAR(500) NULL,
    [Body] NVARCHAR(MAX) NULL,
    [EmailFrom] VARCHAR(250) NULL,
    [EmailTo] VARCHAR(250) NULL,
    [EmailCC] VARCHAR(250) NULL,
    [Department] VARCHAR(100) NULL,
    [EmailDate] VARCHAR(20) NULL,
    [SMTPIP] VARCHAR(50) NULL,
    [Status] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Project_Phase_Status
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Project_Phase_Status]
(
    [PP_ID] CHAR(10) NOT NULL,
    [Request_ID] CHAR(10) NULL,
    [Project_ID] CHAR(10) NULL,
    [Phase_ID] CHAR(10) NULL,
    [SDate] DATETIME NULL,
    [EDate] DATETIME NULL,
    [Last_Updated_By] CHAR(10) NULL,
    [Last_Updated_On] DATETIME NULL,
    [Status] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Project_Phase_Status_Details
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Project_Phase_Status_Details]
(
    [PP_Details_ID] CHAR(10) NOT NULL,
    [PP_ID] CHAR(10) NOT NULL,
    [Requst_ID] CHAR(10) NULL,
    [Project_ID] CHAR(10) NULL,
    [Phase_ID] NCHAR(10) NULL,
    [SDate] DATETIME NULL,
    [EDate] DATETIME NULL,
    [Last_Updated_By] CHAR(10) NULL,
    [Last_Updated_On] DATETIME NULL,
    [Status] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Project_Reference
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Project_Reference]
(
    [Request_ID] CHAR(10) NULL,
    [Ref_Request_ID] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ProjectDefect
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ProjectDefect]
(
    [ID] CHAR(10) NOT NULL,
    [Defect_Code] VARCHAR(25) NOT NULL,
    [Project_Id] VARCHAR(50) NULL,
    [Token_No] VARCHAR(25) NULL,
    [Defect_Name] VARCHAR(100) NOT NULL,
    [Module_Id] VARCHAR(25) NULL,
    [Defect_Type] VARCHAR(100) NULL,
    [Defect_Description] VARCHAR(500) NULL,
    [Steps_To_Reproduce] VARCHAR(500) NULL,
    [Defect_Severity] VARCHAR(50) NULL,
    [Operating_System] VARCHAR(100) NULL,
    [Browser_ID] VARCHAR(25) NULL,
    [Screenshot_attachment] VARCHAR(200) NULL,
    [Developer_Id] CHAR(15) NULL,
    [Reporting_date] DATETIME NULL,
    [Tester_Id] CHAR(15) NULL,
    [Developer_Status] CHAR(25) NULL,
    [Developer_Comments] VARCHAR(200) NULL,
    [Developer_Resolved_Date] DATETIME NULL,
    [Tester_Status] CHAR(25) NULL,
    [Tester_Status_Date] DATETIME NULL,
    [Defect_Status] CHAR(10) NULL,
    [Updated_By] VARCHAR(50) NULL,
    [Last_Updated] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_ProjectDefectMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_ProjectDefectMaster]
(
    [Defect_Code] VARCHAR(25) NOT NULL,
    [Project_Id] VARCHAR(50) NULL,
    [Token_No] VARCHAR(25) NULL,
    [Defect_Name] VARCHAR(100) NOT NULL,
    [Module_Id] VARCHAR(25) NULL,
    [Defect_Type] VARCHAR(100) NULL,
    [Defect_Description] VARCHAR(500) NULL,
    [Steps_To_Reproduce] VARCHAR(500) NULL,
    [Defect_Severity] VARCHAR(50) NULL,
    [Operating_System] VARCHAR(100) NULL,
    [Browser_ID] VARCHAR(25) NULL,
    [Screenshot_attachment] VARCHAR(200) NULL,
    [Developer_Id] CHAR(15) NULL,
    [Reporting_date] DATETIME NULL,
    [Tester_Id] CHAR(15) NULL,
    [Developer_Status] CHAR(25) NULL,
    [Developer_Comments] VARCHAR(200) NULL,
    [Developer_Resolved_Date] DATETIME NULL,
    [Tester_Status] CHAR(25) NULL,
    [Tester_Status_Date] DATETIME NULL,
    [Defect_Status] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Question_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Question_Master]
(
    [QID] INT NULL,
    [Question] VARCHAR(2000) NULL,
    [Description] VARCHAR(MAX) NULL,
    [Phase] VARCHAR(200) NULL,
    [srno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rating_master
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rating_master]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [CMT_ID] INT NOT NULL,
    [object_id] NUMERIC(18, 0) NULL,
    [Rating] NUMERIC(18, 0) NULL,
    [Remark] VARCHAR(150) NULL,
    [Rating_by] VARCHAR(150) NULL,
    [Rating_date] DATETIME NULL,
    [Path] VARCHAR(250) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_rating_master_old
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_rating_master_old]
(
    [srno] INT IDENTITY(1,1) NOT NULL,
    [object_id] NUMERIC(18, 0) NULL,
    [Rating] NUMERIC(18, 0) NULL,
    [Remark] VARCHAR(150) NULL,
    [Rating_by] VARCHAR(150) NULL,
    [Rating_date] DATETIME NULL,
    [Path] VARCHAR(250) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_Summary_LogMail
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_Summary_LogMail]
(
    [log_ID] INT IDENTITY(1,1) NOT NULL,
    [Type] CHAR(10) NULL,
    [EmalFrom] VARCHAR(100) NULL,
    [EmailTo] VARCHAR(100) NULL,
    [Subject] VARCHAR(200) NULL,
    [Body] TEXT NULL,
    [Email_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Testing_Requests
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Testing_Requests]
(
    [Token_Number] VARCHAR(50) NOT NULL,
    [Request_Type] VARCHAR(50) NOT NULL,
    [Project_Id] CHAR(10) NULL,
    [Project_Name] VARCHAR(150) NOT NULL,
    [Module] VARCHAR(100) NULL,
    [Requirement_Type] VARCHAR(50) NULL,
    [Brief_User_Requirement] VARCHAR(250) NOT NULL,
    [Brief_Requirement_Attachement] VARCHAR(200) NULL,
    [Developer_Remark] VARCHAR(250) NULL,
    [Developer_Attachement] VARCHAR(200) NULL,
    [Tester_Attachment] VARCHAR(200) NULL,
    [Desirable_End_Date] DATETIME NOT NULL,
    [Request_By] CHAR(10) NOT NULL,
    [Request_Date] DATETIME NOT NULL,
    [Assign_Date] DATETIME NULL,
    [Tester] CHAR(10) NULL,
    [Tester_Remark] VARCHAR(500) NULL,
    [Close_Date] DATETIME NULL,
    [Status] CHAR(10) NOT NULL,
    [Functional_Defect_Major] INT NULL,
    [Functional_Defect_Minor] INT NULL,
    [Functional_Defect_Total] INT NULL,
    [NonFunctional_Defect_Total] INT NULL,
    [NonFunctional_Defect_Major] INT NULL,
    [NonFunctional_Defect_Minor] INT NULL,
    [Testing_StartDate] DATETIME NULL,
    [Testing_EndDate] DATETIME NULL,
    [Assign_EndDate] DATETIME NULL,
    [Assign_STime] VARCHAR(50) NULL,
    [Assign_ETime] VARCHAR(50) NULL,
    [Assigned_By] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_Testing_RequestsDetails
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_Testing_RequestsDetails]
(
    [Token_Detail_ID] VARCHAR(10) NOT NULL,
    [Token_Number] VARCHAR(50) NOT NULL,
    [Request_Type] VARCHAR(50) NULL,
    [Project_Id] CHAR(10) NULL,
    [Project_Name] VARCHAR(150) NULL,
    [Module] VARCHAR(100) NULL,
    [Requirement_Type] VARCHAR(50) NULL,
    [Brief_User_Requirement] VARCHAR(250) NULL,
    [Brief_Requirement_Attachement] VARCHAR(200) NULL,
    [Developer_Remark] VARCHAR(250) NULL,
    [Developer_Attachement] VARCHAR(200) NULL,
    [Tester_Attachment] VARCHAR(200) NULL,
    [Desirable_End_Date] DATETIME NULL,
    [Request_By] CHAR(10) NULL,
    [Request_Date] DATETIME NOT NULL,
    [Assign_Date] DATETIME NULL,
    [Tester] CHAR(10) NULL,
    [Tester_Remark] VARCHAR(250) NULL,
    [Close_Date] DATETIME NULL,
    [Status] CHAR(10) NOT NULL,
    [Functional_Defect_Major] INT NULL,
    [Functional_Defect_Minor] INT NULL,
    [Functional_Defect_Total] INT NULL,
    [NonFunctional_Defect_Total] INT NULL,
    [NonFunctional_Defect_Major] INT NULL,
    [NonFunctional_Defect_Minor] INT NULL,
    [Testing_StartDate] DATETIME NULL,
    [Testing_EndDate] DATETIME NULL,
    [Assign_EndDate] DATETIME NULL,
    [Assign_STime] VARCHAR(50) NULL,
    [Assign_ETime] VARCHAR(50) NULL,
    [Assigned_By] CHAR(10) NULL,
    [Updated_On] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_User_RoleMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_User_RoleMaster]
(
    [Emp_id] CHAR(25) NOT NULL,
    [Role_Id] CHAR(25) NOT NULL,
    [Category_id] CHAR(25) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp]
(
    [id] CHAR(20) NULL,
    [Text] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp2
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp2]
(
    [Code] CHAR(20) NULL,
    [Test] CHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempTbl_Schedule1
-- --------------------------------------------------
CREATE TABLE [dbo].[TempTbl_Schedule1]
(
    [EMP_ID] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TempTbl_Schedule3
-- --------------------------------------------------
CREATE TABLE [dbo].[TempTbl_Schedule3]
(
    [Emp_ID] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(12) NULL,
    [15 Sep 2010] VARCHAR(25) NULL,
    [16 Sep 2010] VARCHAR(25) NULL,
    [17 Sep 2010] VARCHAR(25) NULL,
    [18 Sep 2010] VARCHAR(25) NULL,
    [19 Sep 2010] VARCHAR(25) NULL,
    [20 Sep 2010] VARCHAR(25) NULL,
    [21 Sep 2010] VARCHAR(25) NULL,
    [22 Sep 2010] VARCHAR(25) NULL,
    [23 Sep 2010] VARCHAR(25) NULL,
    [24 Sep 2010] VARCHAR(25) NULL,
    [25 Sep 2010] VARCHAR(25) NULL,
    [26 Sep 2010] VARCHAR(25) NULL,
    [27 Sep 2010] VARCHAR(25) NULL,
    [28 Sep 2010] VARCHAR(25) NULL,
    [29 Sep 2010] VARCHAR(25) NULL,
    [30 Sep 2010] VARCHAR(25) NULL,
    [01 Oct 2010] VARCHAR(25) NULL,
    [02 Oct 2010] VARCHAR(25) NULL,
    [03 Oct 2010] VARCHAR(25) NULL,
    [04 Oct 2010] VARCHAR(25) NULL,
    [05 Oct 2010] VARCHAR(25) NULL,
    [06 Oct 2010] VARCHAR(25) NULL,
    [07 Oct 2010] VARCHAR(25) NULL,
    [08 Oct 2010] VARCHAR(25) NULL,
    [09 Oct 2010] VARCHAR(25) NULL,
    [10 Oct 2010] VARCHAR(25) NULL,
    [11 Oct 2010] VARCHAR(25) NULL,
    [12 Oct 2010] VARCHAR(25) NULL,
    [13 Oct 2010] VARCHAR(25) NULL,
    [14 Oct 2010] VARCHAR(25) NULL,
    [15 Oct 2010] VARCHAR(25) NULL,
    [16 Oct 2010] VARCHAR(25) NULL,
    [17 Oct 2010] VARCHAR(25) NULL,
    [18 Oct 2010] VARCHAR(25) NULL,
    [19 Oct 2010] VARCHAR(25) NULL,
    [20 Oct 2010] VARCHAR(25) NULL,
    [21 Oct 2010] VARCHAR(25) NULL,
    [22 Oct 2010] VARCHAR(25) NULL,
    [23 Oct 2010] VARCHAR(25) NULL,
    [24 Oct 2010] VARCHAR(25) NULL,
    [25 Oct 2010] VARCHAR(25) NULL,
    [26 Oct 2010] VARCHAR(25) NULL,
    [27 Oct 2010] VARCHAR(25) NULL,
    [28 Oct 2010] VARCHAR(25) NULL,
    [29 Oct 2010] VARCHAR(25) NULL,
    [30 Oct 2010] VARCHAR(25) NULL,
    [31 Oct 2010] VARCHAR(25) NULL,
    [01 Nov 2010] VARCHAR(25) NULL,
    [02 Nov 2010] VARCHAR(25) NULL,
    [03 Nov 2010] VARCHAR(25) NULL,
    [04 Nov 2010] VARCHAR(25) NULL,
    [05 Nov 2010] VARCHAR(25) NULL,
    [06 Nov 2010] VARCHAR(25) NULL,
    [07 Nov 2010] VARCHAR(25) NULL,
    [08 Nov 2010] VARCHAR(25) NULL,
    [09 Nov 2010] VARCHAR(25) NULL,
    [10 Nov 2010] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Testing_Status_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[Testing_Status_Master]
(
    [Testing_Status_ID] VARCHAR(20) NULL,
    [Testing_Status_Name] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.User_Shift_Master
-- --------------------------------------------------
CREATE TABLE [dbo].[User_Shift_Master]
(
    [Shift_ID] CHAR(20) NOT NULL,
    [Shift_STime] DATETIME NULL,
    [Shift_ETime] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VLMSInhouse
-- --------------------------------------------------
CREATE TABLE [dbo].[VLMSInhouse]
(
    [Emp No] VARCHAR(6) NOT NULL,
    [EMP_NAME] VARCHAR(150) NULL,
    [HOD No] VARCHAR(6) NULL,
    [HOD Name] VARCHAR(150) NULL,
    [Company Name] NVARCHAR(50) NULL,
    [SBU] VARCHAR(50) NULL,
    [Lob] INT NULL,
    [Zone] VARCHAR(50) NULL,
    [Region] VARCHAR(50) NULL,
    [Location] VARCHAR(50) NULL,
    [AttendanceLoc] VARCHAR(100) NULL,
    [Department] NVARCHAR(200) NULL,
    [Sub Department] VARCHAR(150) NULL,
    [Designation] VARCHAR(255) NULL,
    [Location Address] VARCHAR(5000) NULL,
    [LEVEL] VARCHAR(50) NULL,
    [categorydesc] VARCHAR(50) NULL,
    [Costcode] NVARCHAR(255) NULL,
    [Join Date] DATETIME NULL,
    [Separation Date] DATETIME NULL,
    [emailadd] VARCHAR(100) NULL,
    [sex] VARCHAR(1) NULL,
    [BirthDate] DATETIME NULL,
    [PHONE] VARCHAR(50) NULL,
    [JOINDATE] DATETIME NULL,
    [STATUS] CHAR(1) NULL,
    [Address] NVARCHAR(100) NULL,
    [City] VARCHAR(100) NULL,
    [State] NVARCHAR(25) NULL,
    [Account No] VARCHAR(20) NULL,
    [pincode] VARCHAR(20) NULL,
    [Functional Head] VARCHAR(500) NULL,
    [flgCSOBranch] NCHAR(6) NULL,
    [tpdlgcode] NVARCHAR(50) NULL,
    [LOBDESC] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.Tgr_Generate_Change_Request_Details_ID
-- --------------------------------------------------
Create  Trigger [Tgr_Generate_Change_Request_Details_ID] ON dbo.Change_Request_Details
For Insert
As
Begin

	Declare @ID As char(20)

	Select @ID=ISNULL(MAX(CONVERT(Int,CRD_ID)),0) From Change_Request_Details

	If (CONVERT(Int,@ID)>=CONVERT(int,'1000001') )
	Begin
		Set @ID=(CONVERT(Char(20),CONVERT(BigInt,@ID)+1))
	End
	Else
	Begin
		Set @ID='1000001'
	End

	Update Change_Request_Details Set CRD_ID=@ID Where CRD_ID like ''

End

GO

-- --------------------------------------------------
-- TRIGGER dbo.Tgr_Generate_Module_ID
-- --------------------------------------------------
CREATE  Trigger [Tgr_Generate_Module_ID] ON dbo.Module_Master
For Insert
As
Begin

	Declare @ID As char(20)

	Select @ID=ISNULL(MAX(CONVERT(Int,Module_ID)),0) From Module_Master

	If (CONVERT(Int,@ID)>=CONVERT(int,'1001') )
	Begin
		Set @ID=(CONVERT(Char(20),CONVERT(BigInt,@ID)+1))
	End
	Else
	Begin
		Set @ID='1001'
	End

	Update Module_Master Set Module_ID=@ID Where Module_ID like ''

End

GO

-- --------------------------------------------------
-- TRIGGER dbo.Tgr_Generate_Phase_ID
-- --------------------------------------------------

Create  Trigger [Tgr_Generate_Phase_ID] ON [dbo].[Phase_Master]
For Insert
As
Begin

	Declare @ID As char(20)

	Select @ID=ISNULL(MAX(CONVERT(Int,Phase_ID)),0) From Phase_Master

	If (CONVERT(Int,@ID)>=CONVERT(int,'101') )
	Begin
		Set @ID=(CONVERT(Char(20),CONVERT(BigInt,@ID)+1))
	End
	Else
	Begin
		Set @ID='101'
	End

	Update Phase_Master Set Phase_ID=@ID Where Phase_ID like ''

End

GO

-- --------------------------------------------------
-- TRIGGER dbo.Tgr_Generate_Request_Details_ID
-- --------------------------------------------------
CREATE  Trigger [Tgr_Generate_Request_Details_ID] ON dbo.Request_Details
For Insert
As
Begin

	Declare @ID As char(20)

	Select @ID=ISNULL(MAX(CONVERT(Int,RD_ID)),0) From Request_Details

	If (CONVERT(Int,@ID)>=CONVERT(int,'1000001') )
	Begin
		Set @ID=(CONVERT(Char(20),CONVERT(BigInt,@ID)+1))
	End
	Else
	Begin
		Set @ID='1000001'
	End

	Update Request_Details Set RD_ID=@ID Where RD_ID like ''

End

GO

-- --------------------------------------------------
-- TRIGGER dbo.Tgr_Generate_Request_ID
-- --------------------------------------------------
Create  Trigger [Tgr_Generate_Request_ID] ON dbo.Request_Master
For Insert
As
Begin

	Declare @ID As char(20)

	Select @ID=ISNULL(MAX(CONVERT(Int,Request_ID)),0) From Request_Master

	If (CONVERT(Int,@ID)>=CONVERT(int,'1001') )
	Begin
		Set @ID=(CONVERT(Char(20),CONVERT(BigInt,@ID)+1))
	End
	Else
	Begin
		Set @ID='1001'
	End

	Update Request_Master Set Request_ID=@ID Where Request_ID like ''

End

GO

-- --------------------------------------------------
-- TRIGGER dbo.Tgr_Generate_Task_Details_ID
-- --------------------------------------------------
Create  Trigger [Tgr_Generate_Task_Details_ID] ON dbo.Task_Details
For Insert
As
Begin

	Declare @ID As char(20)

	Select @ID=ISNULL(MAX(CONVERT(Int,TD_ID)),0) From Task_Details

	If (CONVERT(Int,@ID)>=CONVERT(int,'1000001') )
	Begin
		Set @ID=(CONVERT(Char(20),CONVERT(BigInt,@ID)+1))
	End
	Else
	Begin
		Set @ID='1000001'
	End

	Update Task_Details Set TD_ID=@ID Where TD_ID like ''

End

GO

-- --------------------------------------------------
-- TRIGGER dbo.tgr_GenerateID
-- --------------------------------------------------


CREATE  trigger [tgr_GenerateID] ON [dbo].[Temp]
FOR INSERT
AS
Declare @S As char(20)
Select @S=ISNULL(max(convert(int,ID)),0) from Temp

If (convert(int,@S)>=convert(int,'1001') )
Begin
	Set @S=(convert(CHAR(20),convert(bigint,@S)+1))
End
Else
Begin
	Set @S='1001'
End

UPDATE Temp SET ID=@S WHERE ID like ''

GO

-- --------------------------------------------------
-- TRIGGER dbo.tgr_GenerateTempID
-- --------------------------------------------------




CREATE  trigger [tgr_GenerateTempID] ON [dbo].[Temp2]
FOR INSERT
AS
Declare @S As char(20)
Select @S=ISNULL(max(convert(int,Code)),0) from Temp2

If (convert(int,@S)>=convert(int,'10011001') )
Begin
	Set @S=(convert(CHAR(20),convert(bigint,@S)+1))
End
Else
Begin
	Set @S='10011001'
End

UPDATE Temp2 SET Code=@S WHERE Code like ''

GO

